{"category": "ham", "to_address": "\"OtherRecipients of perl Ticket #41894\": ;", "from_address": "\"Nuno Carvalho via RT\" <parrotbug-followup@parrotcode.org>", "subject": "[perl #41894] segfault happens when invoking poll op ", "body": "Greetings,\n\nOn Wed Mar 21 20:49:36 2007, coke wrote:\n> The following patch avoids the segfault:\n> \n> Index: src/io/io.c\n> =========================================================\n> ==========\n> --- src/io/io.c (revision 17678)\n> +++ src/io/io.c (working copy)\n> @@ -1325,6 +1325,9 @@\n>  INTVAL\n>  PIO_poll(Interp *interp, PMC *pmc, INTVAL which, INTVAL sec, INTVAL\n> usec)\n>  {\n> +    if (pmc == PMCNULL) {\n> +     real_exception(interp, NULL, E_ValueError, \"Can't poll NULL\n> pmc\");\n> +    }\n>      ParrotIOLayer * const l = PMC_struct_val(pmc);\n>      ParrotIO * const io = PMC_data0(pmc);\n>      return PIO_poll_down(interp, l, io, which, sec, usec);\n\nApplied Coke's patch by hand, this seems a sane check to prevent the\nsegmentation fault. Also, 'make test' did not complaint:\n\nAll tests successful, 9 tests and 577 subtests skipped.\nFiles=276, Tests=6765, 1240 wallclock secs (670.61 cusr + 117.22 csys =\n787.83 CPU)\n\nI'm closing this ticket, please reopen the ticket if you find any issues\nregarding this topic. Committed in revision 18180.\n\n./smash\n> \n> On Sun Mar 18 08:24:21 2007, jmckim@gmail.com wrote:\n> > ---\n> > osname= linux\n> > osvers= 2.6.15-gentoo-alt2\n> > arch=   x86_64-linux\n> > cc=     x86_64-pc-linux-gnu-gcc\n> > ---\n> > Flags:\n> >     category=core\n> >     severity=low\n> >     ack=no\n> > ---\n> > This short test program demonstrates the problem, at least using my\n> > default-configured parrot:\n> >\n> > .sub main :main\n> >         .local pmc pfd\n> >         pfd = null\n> >         $I0 = poll pfd, 0, 0, 0\n> > .end\n> >\n> > Here's gdb's output:\n> >\n> > GNU gdb 6.4\n> > Copyright 2005 Free Software Foundation, Inc.\n> > GDB is free software, covered by the GNU General Public License, and\n> you are\n> > welcome to change it and/or distribute copies of it under certain\n> > conditions.\n> > Type \"show copying\" to see the conditions.\n> > There is absolutely no warranty for GDB.  Type \"show warranty\" for\n> details.\n> > This GDB was configured as \"x86_64-pc-linux-gnu\"...Using host\n> libthread_db\n> > library \"/lib/libthread_db.so.1\".\n> >\n> > (gdb) r poll_test.pir\n> > Starting program: /home/mckim/src/parrot-0.4.9/parrot poll_test.pir\n> > [Thread debugging using libthread_db enabled]\n> > [New Thread 46912533592688 (LWP 4202)]\n> > [New Thread 1082132816 (LWP 4205)]\n> > [New Thread 1090525520 (LWP 4206)]\n> >\n> > Program received signal SIGSEGV, Segmentation fault.\n> > [Switching to Thread 46912533592688 (LWP 4202)]\n> > 0x00002aaaaae4631b in PIO_poll_down (interp=0x50c010,\n> layer=0xdeadbeef,\n> >     io=0x0, which=0, sec=0, usec=0) at io_passdown.c:453\n> > 453             if (layer->api->Poll) {\n> > (gdb) where\n> > #0  0x00002aaaaae4631b in PIO_poll_down (interp=0x50c010,\n> layer=0xdeadbeef,\n> >     io=0x0, which=0, sec=0, usec=0) at io_passdown.c:453\n> > #1  0x00002aaaaae41e9f in PIO_poll (interp=0x50c010, pmc=0x5546c0,\n> which=0,\n> >     sec=0, usec=0) at io.c:1330\n> > #2  0x00002aaaaad2c6b0 in Parrot_poll_i_p_ic_ic_ic\n> (cur_opcode=0x835340,\n> >     interp=0x50c010) at io.ops:571\n> > #3  0x00002aaaaadf0d1f in runops_slow_core (interp=0x50c010,\n> pc=0x835340)\n> >     at runops_cores.c:184\n> > #4  0x00002aaaaadd9e81 in runops_int (interp=0x50c010, offset=0)\n> >     at interpreter.c:775\n> > #5  0x00002aaaaaddf36e in runops (interp=0x50c010, offs=0) at\n> inter_run.c:88\n> > #6  0x00002aaaaaddf5e3 in runops_args (interp=0x50c010,\n> sub=0x7f9878,\n> >     obj=0x5546c0, meth=0x0, sig=0x2aaaaaf189c2 \"vP\",\n> ap=0x7fffffb92690)\n> >     at inter_run.c:202\n> > #7  0x00002aaaaaddf7b9 in Parrot_runops_fromc_args (interp=0x50c010,\n> >     sub=0x7f9878, sig=0x2aaaaaf189c2 \"vP\") at inter_run.c:304\n> > #8  0x00002aaaaadfe701 in Parrot_runcode (interp=0x50c010, argc=1,\n> >     argv=0x7fffffb92950) at embed.c:805\n> > #9  0x0000000000403510 in main (argc=1, argv=0x7fffffb92950) at\n> main.c:732\n> > (gdb)\n> >\n> > ---\n> > Summary of my parrot 0.4.9 (r0) configuration:\n> >   configdate='Sat Mar 17 18:52:26 2007'\n> >   Platform:\n> >     osname=linux, archname=x86_64-linux\n> >     jitcapable=0, jitarchname=nojit,\n> >     jitosname=linux, jitcpuarch=x86_64\n> >     execcapable=0\n> >     perl=/usr/bin/perl5.8.8\n> >   Compiler:\n> >     cc='x86_64-pc-linux-gnu-gcc', ccflags=' -pipe\n> > -Wdeclaration-after-statement -D_LARGEFILE_SOURCE\n> -D_FILE_OFFSET_BITS=64\n> > -D_GNU_SOURCE -fPIC -I /usr/include',\n> >   Linker and Libraries:\n> >     ld='x86_64-pc-linux-gnu-gcc', ldflags=' -L/usr/local/lib64',\n> >     cc_ldflags='',\n> >     libs='-lpthread -lnsl -ldl -lm -lcrypt -lutil -lrt -lgmp\n> -lreadline\n> > -lncurses'\n> >   Dynamic Linking:\n> >     share_ext='.so', ld_share_flags='-shared -L/usr/local/lib64\n> -fPIC',\n> >     load_ext='.so', ld_load_flags='-shared -L/usr/local/lib64 -fPIC'\n> >   Types:\n> >     iv=long, intvalsize=8, intsize=4, opcode_t=long,\n> opcode_t_size=8,\n> >     ptrsize=8, ptr_alignment=1 byteorder=12345678,\n> >     nv=double, numvalsize=8, doublesize=8\n> >\n> > ---\n> > Environment:\n> >     HOME    LANG    LANGUAGE    LD_LIBRARY_PATH    LOGDIR    PATH\n> SHELL\n> \n> \n\n\n-- \n./smash\n\n"}