{"category": "ham", "to_address": "samba-cvs@samba.org", "from_address": "jerry@samba.org", "subject": "svn commit: samba r22770 - in branches/SAMBA_3_0_RELEASE/source: .\n\tlib modules nsswitch rpc_client rpc_parse rpc_server smbd", "body": "Author: jerry\nDate: 2007-05-09 16:26:43 +0000 (Wed, 09 May 2007)\nNew Revision: 22770\n\nWebSVN: http://websvn.samba.org/cgi-bin/viewcvs.cgi?view=rev&root=samba&rev=22770\n\nLog:\nsync with SAMBA_3_0_25 as of svn r22765\nModified:\n   branches/SAMBA_3_0_RELEASE/source/configure.in\n   branches/SAMBA_3_0_RELEASE/source/lib/charcnv.c\n   branches/SAMBA_3_0_RELEASE/source/modules/vfs_afsacl.c\n   branches/SAMBA_3_0_RELEASE/source/nsswitch/idmap.c\n   branches/SAMBA_3_0_RELEASE/source/nsswitch/winbindd_async.c\n   branches/SAMBA_3_0_RELEASE/source/nsswitch/winbindd_group.c\n   branches/SAMBA_3_0_RELEASE/source/rpc_client/cli_svcctl.c\n   branches/SAMBA_3_0_RELEASE/source/rpc_parse/parse_misc.c\n   branches/SAMBA_3_0_RELEASE/source/rpc_server/srv_lsa_nt.c\n   branches/SAMBA_3_0_RELEASE/source/smbd/notify.c\n   branches/SAMBA_3_0_RELEASE/source/smbd/reply.c\n\n\nChangeset:\nModified: branches/SAMBA_3_0_RELEASE/source/configure.in\n===================================================================\n--- branches/SAMBA_3_0_RELEASE/source/configure.in\t2007-05-09 11:51:39 UTC (rev 22769)\n+++ branches/SAMBA_3_0_RELEASE/source/configure.in\t2007-05-09 16:26:43 UTC (rev 22770)\n@@ -5764,10 +5764,6 @@\n AC_SUBST(WINBIND_NSS_EXTRA_LIBS)\n AC_SUBST(NSSSONAMEVERSIONSUFFIX)\n \n-if test $BLDSHARED = true -a x\"$HAVE_WINBIND\" = x\"yes\"; then\n-\tNSS_MODULES=\"${WINBIND_NSS} ${WINBIND_WINS_NSS}\"\n-fi\n-\n AC_SUBST(SMB_KRB5_LOCATOR)\n \n # Check the setting of --with-winbind\n@@ -5802,6 +5798,10 @@\n \tWINBIND_WINS_NSS=\"\"\n fi\n \n+if test $BLDSHARED = true -a x\"$HAVE_WINBIND\" = x\"yes\"; then\n+\tNSS_MODULES=\"${WINBIND_NSS} ${WINBIND_WINS_NSS}\"\n+fi\n+\n if test x\"$HAVE_WINBIND\" = x\"yes\"; then\n         AC_MSG_RESULT(yes)\n \tAC_DEFINE(WITH_WINBIND,1,[Whether to build winbind])\n\nModified: branches/SAMBA_3_0_RELEASE/source/lib/charcnv.c\n===================================================================\n--- branches/SAMBA_3_0_RELEASE/source/lib/charcnv.c\t2007-05-09 11:51:39 UTC (rev 22769)\n+++ branches/SAMBA_3_0_RELEASE/source/lib/charcnv.c\t2007-05-09 16:26:43 UTC (rev 22770)\n@@ -972,13 +972,18 @@\n \n \tret = convert_string(CH_DOS, CH_UNIX, src, src_len, dest, dest_len, True);\n \tif (ret == (size_t)-1) {\n+\t\tret = 0;\n \t\tdest_len = 0;\n \t}\n \n-\tif (dest_len)\n-\t\tdest[MIN(ret, dest_len-1)] = 0;\n-\telse \n+\tif (dest_len && ret) {\n+\t\t/* Did we already process the terminating zero ? */\n+\t\tif (dest[MIN(ret-1, dest_len-1)] != 0) {\n+\t\t\tdest[MIN(ret, dest_len-1)] = 0;\n+\t\t}\n+\t} else  {\n \t\tdest[0] = 0;\n+\t}\n \n \treturn src_len;\n }\n@@ -1219,10 +1224,14 @@\n \tif (src_len == (size_t)-1)\n \t\tsrc_len = ret*2;\n \t\t\n-\tif (dest_len)\n-\t\tdest[MIN(ret, dest_len-1)] = 0;\n-\telse \n+\tif (dest_len && ret) {\n+\t\t/* Did we already process the terminating zero ? */\n+\t\tif (dest[MIN(ret-1, dest_len-1)] != 0) {\n+\t\t\tdest[MIN(ret, dest_len-1)] = 0;\n+\t\t}\n+\t} else {\n \t\tdest[0] = 0;\n+\t}\n \n \treturn src_len;\n }\n\nModified: branches/SAMBA_3_0_RELEASE/source/modules/vfs_afsacl.c\n===================================================================\n--- branches/SAMBA_3_0_RELEASE/source/modules/vfs_afsacl.c\t2007-05-09 11:51:39 UTC (rev 22769)\n+++ branches/SAMBA_3_0_RELEASE/source/modules/vfs_afsacl.c\t2007-05-09 16:26:43 UTC (rev 22770)\n@@ -616,7 +616,7 @@\n \tuid_to_sid(&owner_sid, sbuf.st_uid);\n \tgid_to_sid(&group_sid, sbuf.st_gid);\n \n-\tif (num_aces) {\n+\tif (afs_acl->num_aces) {\n \t\tnt_ace_list = TALLOC_ARRAY(mem_ctx, SEC_ACE, afs_acl->num_aces);\n \n \t\tif (nt_ace_list == NULL)\n\nModified: branches/SAMBA_3_0_RELEASE/source/nsswitch/idmap.c\n===================================================================\n--- branches/SAMBA_3_0_RELEASE/source/nsswitch/idmap.c\t2007-05-09 11:51:39 UTC (rev 22769)\n+++ branches/SAMBA_3_0_RELEASE/source/nsswitch/idmap.c\t2007-05-09 16:26:43 UTC (rev 22770)\n@@ -1025,17 +1025,16 @@\n \tDEBUG(10, (\"Query backends to map sids->ids\\n\"));\n \n \t/* split list per domain */\n-\n-\tif (num_domains) {\n-\t\tdom_ids = TALLOC_ZERO_ARRAY(ctx, struct id_map **, num_domains);\n-\t\tIDMAP_CHECK_ALLOC(dom_ids);\n-\t\tcounters = TALLOC_ZERO_ARRAY(ctx, int, num_domains);\n-\t\tIDMAP_CHECK_ALLOC(counters);\n-\t} else {\n-\t\tdom_ids = NULL;\n-\t\tcounters = NULL;\n+\tif (num_domains == 0) {\n+\t\tDEBUG(1, (\"No domains available?\\n\"));\n+\t\treturn NT_STATUS_UNSUCCESSFUL;\n \t}\n \n+\tdom_ids = TALLOC_ZERO_ARRAY(ctx, struct id_map **, num_domains);\n+\tIDMAP_CHECK_ALLOC(dom_ids);\n+\tcounters = TALLOC_ZERO_ARRAY(ctx, int, num_domains);\n+\tIDMAP_CHECK_ALLOC(counters);\n+\n \t/* partition the requests by domain */\n \n \tfor (i = 0; ids[i]; i++) {\n\nModified: branches/SAMBA_3_0_RELEASE/source/nsswitch/winbindd_async.c\n===================================================================\n--- branches/SAMBA_3_0_RELEASE/source/nsswitch/winbindd_async.c\t2007-05-09 11:51:39 UTC (rev 22769)\n+++ branches/SAMBA_3_0_RELEASE/source/nsswitch/winbindd_async.c\t2007-05-09 16:26:43 UTC (rev 22770)\n@@ -163,6 +163,7 @@\n \tmap.sid = &sid\n \tmap.xid.id = state->request.data.dual_idmapset.id;\n \tmap.xid.type = state->request.data.dual_idmapset.type;\n+\tmap.status = ID_MAPPED;\n \n \tresult = idmap_set_mapping(&map);\n \treturn NT_STATUS_IS_OK(result) ? WINBINDD_OK : WINBINDD_ERROR;\n@@ -273,6 +274,11 @@\n \n \tDEBUG(3, (\"[%5lu]: sids to unix ids\\n\", (unsigned long)state->pid));\n \n+\tif (state->request.extra_len == 0) {\n+\t\tDEBUG(0, (\"Invalid buffer size!\\n\"));\n+\t\treturn WINBINDD_ERROR;\n+\t}\n+\n \tsids = (DOM_SID *)state->request.extra_data.data;\n \tnum = state->request.extra_len / sizeof(DOM_SID);\n \n\nModified: branches/SAMBA_3_0_RELEASE/source/nsswitch/winbindd_group.c\n===================================================================\n--- branches/SAMBA_3_0_RELEASE/source/nsswitch/winbindd_group.c\t2007-05-09 11:51:39 UTC (rev 22769)\n+++ branches/SAMBA_3_0_RELEASE/source/nsswitch/winbindd_group.c\t2007-05-09 16:26:43 UTC (rev 22770)\n@@ -479,6 +479,9 @@\n \tmemset(name_group, 0, sizeof(fstring));\n \n \ttmp = state->request.data.groupname;\n+\n+\tname_domain[0] = '\\0';\n+\tname_group[0] = '\\0';\n \t\n \tparse_domain_user(tmp, name_domain, name_group);\n \n\nModified: branches/SAMBA_3_0_RELEASE/source/rpc_client/cli_svcctl.c\n===================================================================\n--- branches/SAMBA_3_0_RELEASE/source/rpc_client/cli_svcctl.c\t2007-05-09 11:51:39 UTC (rev 22769)\n+++ branches/SAMBA_3_0_RELEASE/source/rpc_client/cli_svcctl.c\t2007-05-09 16:26:43 UTC (rev 22770)\n@@ -209,8 +209,12 @@\n \t\treturn out.status;\n \t\t\n \t/* pull out the data */\n-\tif ( !(services = TALLOC_ARRAY( mem_ctx, ENUM_SERVICES_STATUS, out.returned )) ) \n-\t\treturn WERR_NOMEM;\n+\tif (out.returned) {\n+\t\tif ( !(services = TALLOC_ARRAY( mem_ctx, ENUM_SERVICES_STATUS, out.returned )) ) \n+\t\t\treturn WERR_NOMEM;\n+\t} else {\n+\t\tservices = NULL;\n+\t}\n \t\t\n \tfor ( i=0; ibuffer = (uint8 *)TALLOC_ZERO(get_talloc_ctx(), len);\n-\tif (str->buffer == NULL)\n-\t\tsmb_panic(\"create_rpc_blob: talloc fail\\n\");\n-\treturn len;\n+\tif (len) {\n+\t\tstr->buffer = (uint8 *)TALLOC_ZERO(get_talloc_ctx(), len);\n+\t\tif (str->buffer == NULL)\n+\t\t\tsmb_panic(\"create_rpc_blob: talloc fail\\n\");\n+\t\tstr->buf_len = len;\n+\t} else {\n+\t\tstr->buffer = NULL;\n+\t\tstr->buf_len = 0;\n+\t}\n }\n \n /*******************************************************************\n@@ -547,7 +552,7 @@\n \tZERO_STRUCTP(str);\n \n \t/* set up string lengths. */\n-\tstr->buf_len = create_rpc_blob(str, sizeof(uint32));\n+\tcreate_rpc_blob(str, sizeof(uint32));\n \tSIVAL(str->buffer, 0, val);\n }\n \n@@ -560,9 +565,10 @@\n \tZERO_STRUCTP(str);\n \n \t/* set up string lengths. */\n-\tstr->buf_len = create_rpc_blob(str, len*2);\n-\trpcstr_push(str->buffer, buf, (size_t)str->buf_len, STR_TERMINATE);\n-\t\n+\tif (len) {\n+\t\tcreate_rpc_blob(str, len*2);\n+\t\trpcstr_push(str->buffer, buf, (size_t)str->buf_len, STR_TERMINATE);\n+\t}\n }\n \n /*******************************************************************\n@@ -572,8 +578,10 @@\n void init_rpc_blob_hex(RPC_DATA_BLOB *str, const char *buf)\n {\n \tZERO_STRUCTP(str);\n-\tstr->buf_len = create_rpc_blob(str, strlen(buf));\n-\tstr->buf_len = strhex_to_str((char *)str->buffer, str->buf_len, buf);\n+\tif (buf && *buf) {\n+\t\tcreate_rpc_blob(str, strlen(buf));\n+\t\tstr->buf_len = strhex_to_str((char *)str->buffer, str->buf_len, buf);\n+\t}\n }\n \n /*******************************************************************\n@@ -585,8 +593,8 @@\n \tZERO_STRUCTP(str);\n \n \t/* max buffer size (allocated size) */\n-\tif (buf != NULL) {\n-\t\tlen = create_rpc_blob(str, len);\n+\tif (buf != NULL && len) {\n+\t\tcreate_rpc_blob(str, len);\n \t\tmemcpy(str->buffer, buf, len);\n \t}\n \tstr->buf_len = len;\n\nModified: branches/SAMBA_3_0_RELEASE/source/rpc_server/srv_lsa_nt.c\n===================================================================\n--- branches/SAMBA_3_0_RELEASE/source/rpc_server/srv_lsa_nt.c\t2007-05-09 11:51:39 UTC (rev 22769)\n+++ branches/SAMBA_3_0_RELEASE/source/rpc_server/srv_lsa_nt.c\t2007-05-09 16:26:43 UTC (rev 22770)\n@@ -826,7 +826,11 @@\n \t*pp_mapped_count = 0;\n \t*pp_ref = NULL;\n \t*pp_names = NULL;\n-\t\n+\n+\tif (num_sids == 0) {\n+\t\treturn NT_STATUS_OK;\n+\t}\n+\n \tnames = TALLOC_ZERO_P(p->mem_ctx, LSA_TRANS_NAME_ENUM2);\n \tsids = TALLOC_ARRAY(p->mem_ctx, const DOM_SID *, num_sids);\n \tref = TALLOC_ZERO_P(p->mem_ctx, DOM_R_REF);\n@@ -846,12 +850,10 @@\n \t\treturn status;\n \t}\n \n-\tif (num_sids > 0) {\n-\t\tnames->name = TALLOC_ARRAY(names, LSA_TRANS_NAME2, num_sids);\n-\t\tnames->uni_name = TALLOC_ARRAY(names, UNISTR2, num_sids);\n-\t\tif ((names->name == NULL) || (names->uni_name == NULL)) {\n-\t\t\treturn NT_STATUS_NO_MEMORY;\n-\t\t}\n+\tnames->name = TALLOC_ARRAY(names, LSA_TRANS_NAME2, num_sids);\n+\tnames->uni_name = TALLOC_ARRAY(names, UNISTR2, num_sids);\n+\tif ((names->name == NULL) || (names->uni_name == NULL)) {\n+\t\treturn NT_STATUS_NO_MEMORY;\n \t}\n \n \tfor (i=0; inotify == NULL) {\n \t\t/*\n@@ -345,11 +345,7 @@\n \t\treturn;\n \t}\n \n-\tif (!(name2 = talloc_strdup(fsp->notify, name))) {\n-\t\tDEBUG(0, (\"talloc_strdup failed\\n\"));\n-\t\t\treturn;\n-\t}\n-\n+\tpstrcpy(name2, name);\n \tstring_replace(name2, '/', '\\\\');\n \n \t/*\n@@ -363,7 +359,6 @@\n \t\t * guard against a DoS here.\n \t\t */\n \t\tTALLOC_FREE(fsp->notify->changes);\n-\t\tTALLOC_FREE(name2);\n \t\tfsp->notify->num_changes = -1;\n \t\treturn;\n \t}\n@@ -376,7 +371,6 @@\n \t\t      fsp->notify, fsp->notify->changes,\n \t\t      struct notify_change, fsp->notify->num_changes+1))) {\n \t\tDEBUG(0, (\"talloc_realloc failed\\n\"));\n-\t\tTALLOC_FREE(name2);\n \t\treturn;\n \t}\n \n@@ -384,7 +378,11 @@\n \n \tchange = &(fsp->notify->changes[fsp->notify->num_changes]);\n \n-\tchange->name = talloc_move(changes, &name2);\n+\tif (!(change->name = talloc_strdup(changes, name2))) {\n+\t\tDEBUG(0, (\"talloc_strdup failed\\n\"));\n+\t\treturn;\n+\t}\n+\n \tchange->action = action;\n \tfsp->notify->num_changes += 1;\n \n@@ -400,7 +398,7 @@\n \t\t * We have to send the two rename events in one reply. So hold\n \t\t * the first part back.\n \t\t */\n-\treturn;\n+\t\treturn;\n \t}\n \n \t/*\n\nModified: branches/SAMBA_3_0_RELEASE/source/smbd/reply.c\n===================================================================\n--- branches/SAMBA_3_0_RELEASE/source/smbd/reply.c\t2007-05-09 11:51:39 UTC (rev 22769)\n+++ branches/SAMBA_3_0_RELEASE/source/smbd/reply.c\t2007-05-09 16:26:43 UTC (rev 22770)\n@@ -2237,6 +2237,7 @@\n \t\t\texit_server_cleanly(\"send_file_readbraw sendfile failed\");\n \t\t}\n \n+\t\treturn;\n \t}\n \n   normal_readbraw:\n\n"}