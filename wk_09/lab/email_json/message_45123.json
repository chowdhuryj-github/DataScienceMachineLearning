{"category": "ham", "to_address": "samba-cvs@samba.org", "from_address": "jra@samba.org", "subject": "svn commit: samba r23391 - in branches: SAMBA_3_0/source/smbd\n\tSAMBA_3_0_26/source/smbd", "body": "Author: jra\nDate: 2007-06-08 19:58:32 +0000 (Fri, 08 Jun 2007)\nNew Revision: 23391\n\nWebSVN: http://websvn.samba.org/cgi-bin/viewcvs.cgi?view=rev&root=samba&rev=23391\n\nLog:\nSecond part of the patch for Apple.\n\nChange the sequence :\n\ngain_root();\nsys_setgroups(ngroups, groups);\nbecome_id(uid, gid);\n\nto a function call :\n\nset_unix_security_ctx(uid_t uid, gid_t gid, int ngroups, gid_t *groups)\n\nJames - should be safe for you to create a Darwin-specific \nversion of this function now.\n\nJeremy.\n\n\nModified:\n   branches/SAMBA_3_0/source/smbd/sec_ctx.c\n   branches/SAMBA_3_0_26/source/smbd/sec_ctx.c\n\n\nChangeset:\nModified: branches/SAMBA_3_0/source/smbd/sec_ctx.c\n===================================================================\n--- branches/SAMBA_3_0/source/smbd/sec_ctx.c\t2007-06-08 19:52:18 UTC (rev 23390)\n+++ branches/SAMBA_3_0/source/smbd/sec_ctx.c\t2007-06-08 19:58:32 UTC (rev 23391)\n@@ -228,6 +228,21 @@\n }\n \n /****************************************************************************\n+ Change UNIX security context. Calls panic if not successful so no return value.\n+****************************************************************************/\n+\n+static void set_unix_security_ctx(uid_t uid, gid_t gid, int ngroups, gid_t *groups)\n+{\n+\t/* Start context switch */\n+\tgain_root();\n+#ifdef HAVE_SETGROUPS\n+\tsys_setgroups(ngroups, groups);\n+#endif\n+\tbecome_id(uid, gid);\n+\t/* end context switch */\n+}\n+\n+/****************************************************************************\n  Set the current security context to a given user.\n ****************************************************************************/\n \n@@ -243,13 +258,8 @@\n \tdebug_nt_user_token(DBGC_CLASS, 5, token);\n \tdebug_unix_user_token(DBGC_CLASS, 5, uid, gid, ngroups, groups);\n \n-\t/* Start context switch */\n-\tgain_root();\n-#ifdef HAVE_SETGROUPS\n-\tsys_setgroups(ngroups, groups);\n-#endif\n-\tbecome_id(uid, gid);\n-\t/* end context switch */\n+\t/* Change uid, gid and supplementary group list. */\n+\tset_unix_security_ctx(uid, gid, ngroups, groups);\n \n \tctx_p->ut.ngroups = ngroups;\n \n@@ -336,13 +346,11 @@\n \n \tprev_ctx_p = &sec_ctx_stack[sec_ctx_stack_ndx];\n \n-\t/* Start context switch */\n-\tgain_root();\n-#ifdef HAVE_SETGROUPS\n-\tsys_setgroups(prev_ctx_p->ut.ngroups, prev_ctx_p->ut.groups);\n-#endif\n-\tbecome_id(prev_ctx_p->ut.uid, prev_ctx_p->ut.gid);\n-\t/* end context switch */\n+\t/* Change uid, gid and supplementary group list. */\n+\tset_unix_security_ctx(prev_ctx_p->ut.uid,\n+\t\t\tprev_ctx_p->ut.gid,\n+\t\t\tprev_ctx_p->ut.ngroups,\n+\t\t\tprev_ctx_p->ut.groups);\n \n \t/* Update current_user stuff */\n \n\nModified: branches/SAMBA_3_0_26/source/smbd/sec_ctx.c\n===================================================================\n--- branches/SAMBA_3_0_26/source/smbd/sec_ctx.c\t2007-06-08 19:52:18 UTC (rev 23390)\n+++ branches/SAMBA_3_0_26/source/smbd/sec_ctx.c\t2007-06-08 19:58:32 UTC (rev 23391)\n@@ -228,6 +228,21 @@\n }\n \n /****************************************************************************\n+ Change UNIX security context. Calls panic if not successful so no return value.\n+****************************************************************************/\n+\n+static void set_unix_security_ctx(uid_t uid, gid_t gid, int ngroups, gid_t *groups)\n+{\n+\t/* Start context switch */\n+\tgain_root();\n+#ifdef HAVE_SETGROUPS\n+\tsys_setgroups(ngroups, groups);\n+#endif\n+\tbecome_id(uid, gid);\n+\t/* end context switch */\n+}\n+\n+/****************************************************************************\n  Set the current security context to a given user.\n ****************************************************************************/\n \n@@ -243,13 +258,8 @@\n \tdebug_nt_user_token(DBGC_CLASS, 5, token);\n \tdebug_unix_user_token(DBGC_CLASS, 5, uid, gid, ngroups, groups);\n \n-\t/* Start context switch */\n-\tgain_root();\n-#ifdef HAVE_SETGROUPS\n-\tsys_setgroups(ngroups, groups);\n-#endif\n-\tbecome_id(uid, gid);\n-\t/* end context switch */\n+\t/* Change uid, gid and supplementary group list. */\n+\tset_unix_security_ctx(uid, gid, ngroups, groups);\n \n \tctx_p->ut.ngroups = ngroups;\n \n@@ -336,13 +346,11 @@\n \n \tprev_ctx_p = &sec_ctx_stack[sec_ctx_stack_ndx];\n \n-\t/* Start context switch */\n-\tgain_root();\n-#ifdef HAVE_SETGROUPS\n-\tsys_setgroups(prev_ctx_p->ut.ngroups, prev_ctx_p->ut.groups);\n-#endif\n-\tbecome_id(prev_ctx_p->ut.uid, prev_ctx_p->ut.gid);\n-\t/* end context switch */\n+\t/* Change uid, gid and supplementary group list. */\n+\tset_unix_security_ctx(prev_ctx_p->ut.uid,\n+\t\t\tprev_ctx_p->ut.gid,\n+\t\t\tprev_ctx_p->ut.ngroups,\n+\t\t\tprev_ctx_p->ut.groups);\n \n \t/* Update current_user stuff */\n \n\n"}