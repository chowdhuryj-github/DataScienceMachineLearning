{"category": "ham", "to_address": "samba-cvs@samba.org", "from_address": "abartlet@samba.org", "subject": "svn commit: samba r22162 - in\n\tbranches/SAMBA_4_0/source/script/tests: .", "body": "Author: abartlet\nDate: 2007-04-11 05:01:02 +0000 (Wed, 11 Apr 2007)\nNew Revision: 22162\n\nWebSVN: http://websvn.samba.org/cgi-bin/viewcvs.cgi?view=rev&root=samba&rev=22162\n\nLog:\nget the TEST_LDAP mode working again\n\nAndrew Bartlett\n\nModified:\n   branches/SAMBA_4_0/source/script/tests/Samba4.pm\n   branches/SAMBA_4_0/source/script/tests/mk-openldap.sh\n\n\nChangeset:\nModified: branches/SAMBA_4_0/source/script/tests/Samba4.pm\n===================================================================\n--- branches/SAMBA_4_0/source/script/tests/Samba4.pm\t2007-04-11 03:45:39 UTC (rev 22161)\n+++ branches/SAMBA_4_0/source/script/tests/Samba4.pm\t2007-04-11 05:01:02 UTC (rev 22162)\n@@ -27,11 +27,11 @@\n \t# running slapd in the background means it stays in the same process group, so it can be\n \t# killed by timelimit\n \tif (defined($ENV{FEDORA_DS_PREFIX})) {\n-\t        system(\"$ENV{FEDORA_DS_PREFIX}/sbin/ns-slapd -D $ENV{FEDORA_DS_DIR} -d$ENV{FEDORA_DS_LOGLEVEL} -i $ENV{FEDORA_DS_PIDFILE}> $ENV{LDAPDIR}/logs 2>&1 &\");\n+\t        system(\"$env_vars->{FEDORA_DS_PREFIX}/sbin/ns-slapd -D $env_vars->{FEDORA_DS_DIR} -d$env_vars->{FEDORA_DS_LOGLEVEL} -i $env_vars->{FEDORA_DS_PIDFILE}> $env_vars->{LDAPDIR}/logs 2>&1 &\");\n \t} else {\n \t\tmy $oldpath = $ENV{PATH};\n \t\t$ENV{PATH} = \"/usr/local/sbin:/usr/sbin:/sbin:$ENV{PATH}\";\n-\t\tsystem(\"slapd -d$ENV{OPENLDAP_LOGLEVEL} -f $conf -h $uri > $ENV{LDAPDIR}/logs 2>&1 &\");\n+\t\tsystem(\"slapd -d$env_vars->{OPENLDAP_LOGLEVEL} -f $conf -h $uri > $env_vars->{LDAPDIR}/logs 2>&1 &\");\n \t\t$ENV{PATH} = $oldpath;\n \t}\n \twhile (system(\"$self->{bindir}/ldbsearch -H $uri -s base -b \\\"\\\" supportedLDAPVersion > /dev/null\") != 0) {\n@@ -51,8 +51,8 @@\n \tif (defined($envvars->{FEDORA_DS_PREFIX})) {\n \t\tsystem(\"$envvars->{LDAPDIR}/slapd-samba4/stop-slapd\");\n \t} else {\n-\t\topen(IN, \"<$envvars->{PIDDIR}/slapd.pid\") or \n-\t\t\tdie(\"unable to open slapd pid file\");\n+\t\topen(IN, \"<$envvars->{OPENLDAP_PIDFILE}\") or \n+\t\t\tdie(\"unable to open slapd pid file: $envvars->{OPENLDAP_PIDFILE}\");\n \t\tkill 9, ;\n \t\tclose(IN);\n \t}\n@@ -69,7 +69,7 @@\n \t\t\tdie(\"couldn't start slapd\");\n \n \t\tprint \"LDAP PROVISIONING...\";\n-\t\t$self->provision_ldap();\n+\t\t$self->provision_ldap($env_vars);\n \t}\n \n \tSocketWrapper::set_default_iface(1);\n@@ -152,11 +152,11 @@\n \treturn \\%ret;\n }\n \n-sub provision_ldap($)\n+sub provision_ldap($$)\n {\n-\tmy ($self) = @_;\n-    system(\"$self->{bindir}/smbscript $self->{setupdir}/provision $ENV{PROVISION_OPTIONS} \\\"$ENV{PROVISION_ACI}\\\" --ldap-backend=$ENV{LDAP_URI}\") and\n-\t\tdie(\"LDAP PROVISIONING failed: $self->{bindir}/smbscript $self->{setupdir}/provision $ENV{PROVISION_OPTIONS} \\\"$ENV{PROVISION_ACI}\\\" --ldap-backend=$ENV{LDAP_URI}\");\n+\tmy ($self, $envvars) = @_;\n+    system(\"$self->{bindir}/smbscript $self->{setupdir}/provision $envvars->{PROVISION_OPTIONS} \\\"$envvars->{PROVISION_ACI}\\\" --ldap-backend=$envvars->{LDAP_URI}\") and\n+\t\tdie(\"LDAP PROVISIONING failed: $self->{bindir}/smbscript $self->{setupdir}/provision $envvars->{PROVISION_OPTIONS} \\\"$envvars->{PROVISION_ACI}\\\" --ldap-backend=$envvars->{LDAP_URI}\");\n }\n \n sub teardown_env($$)\n\nModified: branches/SAMBA_4_0/source/script/tests/mk-openldap.sh\n===================================================================\n--- branches/SAMBA_4_0/source/script/tests/mk-openldap.sh\t2007-04-11 03:45:39 UTC (rev 22161)\n+++ branches/SAMBA_4_0/source/script/tests/mk-openldap.sh\t2007-04-11 05:01:02 UTC (rev 22162)\n@@ -2,13 +2,15 @@\n export SLAPD_CONF\n \n echo \"OPENLDAP_LOGLEVEL=0\"\n+OPENLDAP_PIDFILE=$PIDDIR/slapd.pid\n+echo \"OPENLDAP_PIDFILE=$OPENLDAP_PIDFILE\"\n \n cat >$SLAPD_CONF <<EOF\n loglevel 0\n \n include $LDAPDIR/ad.schema\n \n-pidfile\t\t$PIDDIR/slapd.pid\n+pidfile\t\t$OPENLDAP_PIDFILE\n argsfile\t$LDAPDIR/slapd.args\n sasl-realm $DNSNAME\n access to * by * write\n\n"}