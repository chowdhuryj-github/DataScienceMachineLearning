{"category": "ham", "to_address": "samba-cvs@samba.org", "from_address": "tridge@samba.org", "subject": "Rev 411: added CTDB_WAIT_DIRECTORIES support in\n\thttp://samba.org/~tridge/ctdb", "body": "------------------------------------------------------------\nrevno: 411\nrevision-id: tridge@samba.org-20070601035018-iqs91hrut48yk8jg\nparent: tridge@samba.org-20070601032911-4o9qwds8gfregd3p\ncommitter: Andrew Tridgell \nbranch nick: tridge\ntimestamp: Fri 2007-06-01 13:50:18 +1000\nmessage:\n  added CTDB_WAIT_DIRECTORIES support\nmodified:\n  packaging/RHEL/setup/ctdb.sysconfig ctdb.sysconfig-20070527204758-biuh7znabuwan3zn-7\n  tools/events                   events-20070529030121-04fjh63cxfh8v1pj-1\n=== modified file 'packaging/RHEL/setup/ctdb.sysconfig'\n--- a/packaging/RHEL/setup/ctdb.sysconfig\t2007-05-31 01:09:45 +0000\n+++ b/packaging/RHEL/setup/ctdb.sysconfig\t2007-06-01 03:50:18 +0000\n@@ -47,6 +47,11 @@\n # the default is not to wait for any local services\n # CTDB_WAIT_TCP_PORTS=\"445 139\"\n \n+# use this to specify any local directories to wait on before starting\n+# ctdb. You should list any critical Samba or NFS shared directories \n+# the default is not to wait for any local directories\n+# CTDB_WAIT_DIRECTORIES=\"/some/directory\"\n+\n # the shared directory where you want to put statd information on\n # which clients to notify on a NFS restart\n # there is no default\n\n=== modified file 'tools/events'\n--- a/tools/events\t2007-06-01 03:26:14 +0000\n+++ b/tools/events\t2007-06-01 03:50:18 +0000\n@@ -8,10 +8,10 @@\n \n case $cmd in \n      startup)\n-\t# wait for local services to come up\n+\t# wait for local services to come up.\n \t[ -z \"$CTDB_WAIT_TCP_PORTS\" ] || {\n \t  all_ok=0\n-\t  echo \"Waiting for tcp services on $CTDB_WAIT_TCP_PORTS to come up\"\n+\t  echo \"Waiting for local tcp ports $CTDB_WAIT_TCP_PORTS\"\n \t  while [ $all_ok -eq 0 ]; do\n \t  \t  all_ok=1\n \t  \t  for p in $CTDB_WAIT_TCP_PORTS; do\n@@ -23,7 +23,24 @@\n \t\t\texit 1\n \t\t  }\n           done\n-\t  echo \"Local tcp services on $CTDB_WAIT_TCP_PORTS are up\"\n+\t  echo \"Local tcp services are up\"\n+\t}\n+\t# wait for local directories to becomes available (could be slow to mount)\n+\t[ -z \"$CTDB_WAIT_DIRECTORIES\" ] || {\n+\t  all_ok=0\n+\t  echo \"Waiting for local directories $CTDB_WAIT_DIRECTORIES\"\n+\t  while [ $all_ok -eq 0 ]; do\n+\t  \t  all_ok=1\n+\t  \t  for d in $CTDB_WAIT_DIRECTORIES; do\n+\t  \t      [ -d $d ] || all_ok=0\n+\t\t  done\n+\t\t  [ $all_ok -eq 1 ] || sleep 1\n+\t\t  /usr/bin/ctdb status > /dev/null 2>&1 || {\n+\t  \t\techo \"ctdb daemon has died. Exiting event startup\"\n+\t\t\texit 1\n+\t\t  }\n+          done\n+\t  echo \"Local directories are available\"\n \t}\n \texit 0;\t\n \t;;\n\n"}