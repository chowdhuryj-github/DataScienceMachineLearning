{"category": "ham", "to_address": "samba-cvs@samba.org", "from_address": "jerry@samba.org", "subject": "svn commit: samba r22712 - in branches: SAMBA_3_0/source/include\n\tSAMBA_3_0/source/nsswitch SAMBA_3_0_26/source/include\n\tSAMBA_3_0_26/source/nsswitch", "body": "Author: jerry\nDate: 2007-05-06 20:33:33 +0000 (Sun, 06 May 2007)\nNew Revision: 22712\n\nWebSVN: http://websvn.samba.org/cgi-bin/viewcvs.cgi?view=rev&root=samba&rev=22712\n\nLog:\nInform the user when logging in via pam_winbind\nand the krb5 tkt cache could not be created due to clock skew.\n\n\nModified:\n   branches/SAMBA_3_0/source/include/rpc_netlogon.h\n   branches/SAMBA_3_0/source/nsswitch/pam_winbind.c\n   branches/SAMBA_3_0/source/nsswitch/pam_winbind.h\n   branches/SAMBA_3_0/source/nsswitch/winbindd_pam.c\n   branches/SAMBA_3_0_26/source/include/rpc_netlogon.h\n   branches/SAMBA_3_0_26/source/nsswitch/pam_winbind.c\n   branches/SAMBA_3_0_26/source/nsswitch/pam_winbind.h\n   branches/SAMBA_3_0_26/source/nsswitch/winbindd_pam.c\n\n\nChangeset:\nModified: branches/SAMBA_3_0/source/include/rpc_netlogon.h\n===================================================================\n--- branches/SAMBA_3_0/source/include/rpc_netlogon.h\t2007-05-06 20:32:36 UTC (rev 22711)\n+++ branches/SAMBA_3_0/source/include/rpc_netlogon.h\t2007-05-06 20:33:33 UTC (rev 22712)\n@@ -89,6 +89,7 @@\n #define LOGON_RESOURCE_GROUPS\t\t0x00000200\n #define LOGON_PROFILE_PATH_RETURNED\t0x00000400\n #define LOGON_GRACE_LOGON\t\t0x01000000\n+#define LOGON_KRB5_FAIL_CLOCK_SKEW\t0x02000000\n \n #define SE_GROUP_MANDATORY\t\t0x00000001\n #define SE_GROUP_ENABLED_BY_DEFAULT\t0x00000002\n\nModified: branches/SAMBA_3_0/source/nsswitch/pam_winbind.c\n===================================================================\n--- branches/SAMBA_3_0/source/nsswitch/pam_winbind.c\t2007-05-06 20:32:36 UTC (rev 22711)\n+++ branches/SAMBA_3_0/source/nsswitch/pam_winbind.c\t2007-05-06 20:33:33 UTC (rev 22712)\n@@ -928,6 +928,30 @@\n }\n \n /**\n+ * Send PAM_ERROR_MSG for krb5 errors.\n+ *\n+ * @param pamh PAM handle\n+ * @param ctrl PAM winbind options.\n+ * @param username User in PAM request.\n+ * @param info3_user_flgs Info3 flags containing logon type bits.\n+ *\n+ * @return void.\n+ */\n+\n+static void _pam_warn_krb5_failure(pam_handle_t *pamh, int ctrl, const char *username, uint32 info3_user_flgs)\n+{\n+\tif (PAM_WB_KRB5_CLOCK_SKEW(info3_user_flgs)) {\n+\t\t_make_remark(pamh, ctrl, PAM_ERROR_MSG, \n+\t\t\t     \"Failed to establish your Kerberos Ticket cache \"\n+\t\t\t     \"due time differences\\n\" \n+\t\t\t     \"with the domain controller.  \"\n+\t\t\t     \"Please verify the system time.\\n\");\t\t\n+\t\t_pam_log_debug(pamh, ctrl, LOG_DEBUG,\n+\t\t\t\"User %s: Clock skew when getting Krb5 TGT\\n\", username);\n+\t}\n+}\n+\n+/**\n  * Compose Password Restriction String for a PAM_ERROR_MSG conversation.\n  *\n  * @param response The struct winbindd_response.\n@@ -1125,6 +1149,9 @@\n \t\t/* inform about logon type */\n \t\t_pam_warn_logon_type(pamh, ctrl, user, response.data.auth.info3.user_flgs);\n \n+\t\t/* inform about krb5 failures */\n+\t\t_pam_warn_krb5_failure(pamh, ctrl, user, response.data.auth.info3.user_flgs);\n+\n \t\t/* set some info3 info for other modules in the stack */\n \t\t_pam_set_data_info3(pamh, ctrl, &response);\n \n\nModified: branches/SAMBA_3_0/source/nsswitch/pam_winbind.h\n===================================================================\n--- branches/SAMBA_3_0/source/nsswitch/pam_winbind.h\t2007-05-06 20:32:36 UTC (rev 22711)\n+++ branches/SAMBA_3_0/source/nsswitch/pam_winbind.h\t2007-05-06 20:33:33 UTC (rev 22712)\n@@ -184,6 +184,8 @@\n /* from include/rpc_netlogon.h */\n #define LOGON_CACHED_ACCOUNT\t\t0x00000004\n #define LOGON_GRACE_LOGON\t\t0x01000000\n+#define LOGON_KRB5_FAIL_CLOCK_SKEW\t0x02000000\n \n #define PAM_WB_CACHED_LOGON(x) (x & LOGON_CACHED_ACCOUNT)\n+#define PAM_WB_KRB5_CLOCK_SKEW(x) (x & LOGON_KRB5_FAIL_CLOCK_SKEW)\n #define PAM_WB_GRACE_LOGON(x)  ((LOGON_CACHED_ACCOUNT|LOGON_GRACE_LOGON) == ( x & (LOGON_CACHED_ACCOUNT|LOGON_GRACE_LOGON)))\n\nModified: branches/SAMBA_3_0/source/nsswitch/winbindd_pam.c\n===================================================================\n--- branches/SAMBA_3_0/source/nsswitch/winbindd_pam.c\t2007-05-06 20:32:36 UTC (rev 22711)\n+++ branches/SAMBA_3_0/source/nsswitch/winbindd_pam.c\t2007-05-06 20:33:33 UTC (rev 22712)\n@@ -1326,6 +1326,7 @@\n \t\t\t\t\t    struct winbindd_cli_state *state) \n {\n \tNTSTATUS result = NT_STATUS_LOGON_FAILURE;\n+\tNTSTATUS krb5_result = NT_STATUS_OK;\t\n \tfstring name_domain, name_user;\n \tNET_USER_INFO_3 *info3 = NULL;\n \t\n@@ -1365,6 +1366,9 @@\n \tif (domain->online && (state->request.flags & WBFLAG_PAM_KRB5)) {\n \t\n \t\tresult = winbindd_dual_pam_auth_kerberos(domain, state, &info3);\n+\t\t/* save for later */\n+\t\tkrb5_result = result;\n+\t\t\n \n \t\tif (NT_STATUS_IS_OK(result)) {\n \t\t\tDEBUG(10,(\"winbindd_dual_pam_auth_kerberos succeeded\\n\"));\n@@ -1412,6 +1416,10 @@\n \t\n \t\tif (NT_STATUS_IS_OK(result)) {\n \t\t\tDEBUG(10,(\"winbindd_dual_pam_auth_samlogon succeeded\\n\"));\n+\t\t\t/* add the Krb5 err if we have one */\n+\t\t\tif ( NT_STATUS_EQUAL(krb5_result, NT_STATUS_TIME_DIFFERENCE_AT_DC ) ) {\n+\t\t\t\tinfo3->user_flgs |= LOGON_KRB5_FAIL_CLOCK_SKEW;\t\t\t\t\n+\t\t\t}\n \t\t\tgoto process_result;\n \t\t} else {\n \t\t\tDEBUG(10,(\"winbindd_dual_pam_auth_samlogon failed: %s\\n\", nt_errstr(result)));\n\nModified: branches/SAMBA_3_0_26/source/include/rpc_netlogon.h\n===================================================================\n--- branches/SAMBA_3_0_26/source/include/rpc_netlogon.h\t2007-05-06 20:32:36 UTC (rev 22711)\n+++ branches/SAMBA_3_0_26/source/include/rpc_netlogon.h\t2007-05-06 20:33:33 UTC (rev 22712)\n@@ -98,6 +98,7 @@\n #define LOGON_RESOURCE_GROUPS\t\t0x00000200\n #define LOGON_PROFILE_PATH_RETURNED\t0x00000400\n #define LOGON_GRACE_LOGON\t\t0x01000000\n+#define LOGON_KRB5_FAIL_CLOCK_SKEW\t0x02000000\n \n #define SE_GROUP_MANDATORY\t\t0x00000001\n #define SE_GROUP_ENABLED_BY_DEFAULT\t0x00000002\n\nModified: branches/SAMBA_3_0_26/source/nsswitch/pam_winbind.c\n===================================================================\n--- branches/SAMBA_3_0_26/source/nsswitch/pam_winbind.c\t2007-05-06 20:32:36 UTC (rev 22711)\n+++ branches/SAMBA_3_0_26/source/nsswitch/pam_winbind.c\t2007-05-06 20:33:33 UTC (rev 22712)\n@@ -928,6 +928,30 @@\n }\n \n /**\n+ * Send PAM_ERROR_MSG for krb5 errors.\n+ *\n+ * @param pamh PAM handle\n+ * @param ctrl PAM winbind options.\n+ * @param username User in PAM request.\n+ * @param info3_user_flgs Info3 flags containing logon type bits.\n+ *\n+ * @return void.\n+ */\n+\n+static void _pam_warn_krb5_failure(pam_handle_t *pamh, int ctrl, const char *username, uint32 info3_user_flgs)\n+{\n+\tif (PAM_WB_KRB5_CLOCK_SKEW(info3_user_flgs)) {\n+\t\t_make_remark(pamh, ctrl, PAM_ERROR_MSG, \n+\t\t\t     \"Failed to establish your Kerberos Ticket cache \"\n+\t\t\t     \"due time differences\\n\" \n+\t\t\t     \"with the domain controller.  \"\n+\t\t\t     \"Please verify the system time.\\n\");\t\t\n+\t\t_pam_log_debug(pamh, ctrl, LOG_DEBUG,\n+\t\t\t\"User %s: Clock skew when getting Krb5 TGT\\n\", username);\n+\t}\n+}\n+\n+/**\n  * Compose Password Restriction String for a PAM_ERROR_MSG conversation.\n  *\n  * @param response The struct winbindd_response.\n@@ -1125,6 +1149,9 @@\n \t\t/* inform about logon type */\n \t\t_pam_warn_logon_type(pamh, ctrl, user, response.data.auth.info3.user_flgs);\n \n+\t\t/* inform about krb5 failures */\n+\t\t_pam_warn_krb5_failure(pamh, ctrl, user, response.data.auth.info3.user_flgs);\n+\n \t\t/* set some info3 info for other modules in the stack */\n \t\t_pam_set_data_info3(pamh, ctrl, &response);\n \n\nModified: branches/SAMBA_3_0_26/source/nsswitch/pam_winbind.h\n===================================================================\n--- branches/SAMBA_3_0_26/source/nsswitch/pam_winbind.h\t2007-05-06 20:32:36 UTC (rev 22711)\n+++ branches/SAMBA_3_0_26/source/nsswitch/pam_winbind.h\t2007-05-06 20:33:33 UTC (rev 22712)\n@@ -184,6 +184,8 @@\n /* from include/rpc_netlogon.h */\n #define LOGON_CACHED_ACCOUNT\t\t0x00000004\n #define LOGON_GRACE_LOGON\t\t0x01000000\n+#define LOGON_KRB5_FAIL_CLOCK_SKEW\t0x02000000\n \n #define PAM_WB_CACHED_LOGON(x) (x & LOGON_CACHED_ACCOUNT)\n+#define PAM_WB_KRB5_CLOCK_SKEW(x) (x & LOGON_KRB5_FAIL_CLOCK_SKEW)\n #define PAM_WB_GRACE_LOGON(x)  ((LOGON_CACHED_ACCOUNT|LOGON_GRACE_LOGON) == ( x & (LOGON_CACHED_ACCOUNT|LOGON_GRACE_LOGON)))\n\nModified: branches/SAMBA_3_0_26/source/nsswitch/winbindd_pam.c\n===================================================================\n--- branches/SAMBA_3_0_26/source/nsswitch/winbindd_pam.c\t2007-05-06 20:32:36 UTC (rev 22711)\n+++ branches/SAMBA_3_0_26/source/nsswitch/winbindd_pam.c\t2007-05-06 20:33:33 UTC (rev 22712)\n@@ -1326,6 +1326,7 @@\n \t\t\t\t\t    struct winbindd_cli_state *state) \n {\n \tNTSTATUS result = NT_STATUS_LOGON_FAILURE;\n+\tNTSTATUS krb5_result = NT_STATUS_OK;\t\n \tfstring name_domain, name_user;\n \tNET_USER_INFO_3 *info3 = NULL;\n \t\n@@ -1365,6 +1366,9 @@\n \tif (domain->online && (state->request.flags & WBFLAG_PAM_KRB5)) {\n \t\n \t\tresult = winbindd_dual_pam_auth_kerberos(domain, state, &info3);\n+\t\t/* save for later */\n+\t\tkrb5_result = result;\n+\t\t\n \n \t\tif (NT_STATUS_IS_OK(result)) {\n \t\t\tDEBUG(10,(\"winbindd_dual_pam_auth_kerberos succeeded\\n\"));\n@@ -1412,6 +1416,10 @@\n \t\n \t\tif (NT_STATUS_IS_OK(result)) {\n \t\t\tDEBUG(10,(\"winbindd_dual_pam_auth_samlogon succeeded\\n\"));\n+\t\t\t/* add the Krb5 err if we have one */\n+\t\t\tif ( NT_STATUS_EQUAL(krb5_result, NT_STATUS_TIME_DIFFERENCE_AT_DC ) ) {\n+\t\t\t\tinfo3->user_flgs |= LOGON_KRB5_FAIL_CLOCK_SKEW;\t\t\t\t\n+\t\t\t}\n \t\t\tgoto process_result;\n \t\t} else {\n \t\t\tDEBUG(10,(\"winbindd_dual_pam_auth_samlogon failed: %s\\n\", nt_errstr(result)));\n\n"}