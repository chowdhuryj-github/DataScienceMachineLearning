{"category": "ham", "to_address": "samba-cvs@samba.org", "from_address": "tridge@samba.org", "subject": "Rev 384: more build tweaks in http://samba.org/~tridge/ctdb", "body": "------------------------------------------------------------\nrevno: 384\nrevision-id: tridge@samba.org-20070529055203-vy4qlp6x1syx879n\nparent: tridge@samba.org-20070529053642-xsoqyaoqc38ztq0o\ncommitter: Andrew Tridgell \nbranch nick: tridge\ntimestamp: Tue 2007-05-29 15:52:03 +1000\nmessage:\n  more build tweaks\nmodified:\n  Makefile.in                    makefile.in-20061117234101-o3qt14umlg9en8z0-1\n  packaging/RHEL/ctdb.spec       ctdb.spec-20070527204758-biuh7znabuwan3zn-3\n  packaging/RHEL/makerpms.sh     makerpms.sh-20070527204758-biuh7znabuwan3zn-4\n=== modified file 'Makefile.in'\n--- a/Makefile.in\t2007-05-29 05:20:41 +0000\n+++ b/Makefile.in\t2007-05-29 05:52:03 +0000\n@@ -7,6 +7,7 @@\n includedir = @includedir@\n libdir = @libdir@\n bindir = @bindir@\n+sbindir = @sbindir@\n localstatedir = @localstatedir@\n VPATH = @srcdir@:@tdbdir@:@tallocdir@:@libreplacedir@:@poptdir@\n srcdir = @srcdir@\n@@ -42,11 +43,13 @@\n \n OBJS = @TDB_OBJ@ @TALLOC_OBJ@ @LIBREPLACEOBJ@ @INFINIBAND_WRAPPER_OBJ@ $(EXTRA_OBJ) @EVENTS_OBJ@ $(CTDB_OBJ) $(UTIL_OBJ)\n \n-BINS = bin/ctdbd bin/ctdbd_test bin/ctdb_test bin/ctdb_bench bin/ctdb_messaging bin/ctdb_fetch bin/ctdb_fetch1 bin/lockwait bin/ctdb @INFINIBAND_BINS@\n+TEST_BINS=bin/ctdbd_test bin/ctdb_test bin/ctdb_bench bin/ctdb_messaging bin/ctdb_fetch bin/ctdb_fetch1 bin/lockwait @INFINIBAND_BINS@\n+BINS = bin/ctdb\n+SBINS = bin/ctdbd\n \n DIRS = lib bin\n \n-all: showflags dirs $(OBJS) $(BINS)\n+all: showflags dirs $(OBJS) $(BINS) $(SBINS) $(TEST_BINS)\n \n showflags:\n \t@echo 'ctdb will be compiled with flags:'\n@@ -115,6 +118,7 @@\n \tmkdir -p $(DESTDIR)$(bindir)\n \tmkdir -p $(DESTDIR)$(includedir)\n \trsync $(BINS) $(DESTDIR)$(bindir)\n+\trsync $(SBINS) $(DESTDIR)$(sbindir)\n \trsync $(srcdir)/include/ctdb.h $(DESTDIR)$(includedir)\n \n test: all\n\n=== modified file 'packaging/RHEL/ctdb.spec'\n--- a/packaging/RHEL/ctdb.spec\t2007-05-29 05:20:41 +0000\n+++ b/packaging/RHEL/ctdb.spec\t2007-05-29 05:52:03 +0000\n@@ -44,6 +44,7 @@\n CFLAGS=\"$RPM_OPT_FLAGS $EXTRA -D_GNU_SOURCE\" ./configure \\\n \t--prefix=%{_prefix} \\\n \n+make showflags\n make   \n \n %install\n\n=== modified file 'packaging/RHEL/makerpms.sh'\n--- a/packaging/RHEL/makerpms.sh\t2007-05-29 05:15:00 +0000\n+++ b/packaging/RHEL/makerpms.sh\t2007-05-29 05:52:03 +0000\n@@ -2,6 +2,7 @@\n # Copyright (C) John H Terpstra 1998-2002\n #               Gerald (Jerry) Carter 2003\n #\t\tJim McDonough 2007\n+#\t\tAndrew Tridgell 2007\n \n # The following allows environment variables to override the target directories\n #   the alternative is to have a file in your home directory calles .rpmmacros\n@@ -14,6 +15,14 @@\n \n EXTRA_OPTIONS=\"$1\"\n \n+RHEL=\"packaging/RHEL\"\n+\n+[ -d ${RHEL} ] || {\n+    echo \"Must run this from the ctdb directory\"\n+    exit 1\n+}\n+\n+\n SPECDIR=`rpm --eval %_specdir`\n SRCDIR=`rpm --eval %_sourcedir`\n \n@@ -25,7 +34,7 @@\n REVISION=''\n SPECFILE=\"ctdb.spec\"\n RPMVER=`rpm --version | awk '{print $3}'`\n-RPM=\"rpmbuild\"\n+RPMBUILD=\"rpmbuild\"\n \n ##\n ## Check the RPM version (paranoid)\n@@ -40,15 +49,11 @@\n        ;;\n esac\n \n-pushd .\n-cd ../..\n if [ -f Makefile ]; then \n \tmake distclean\n fi\n-popd\n \n pushd .\n-cd ../../\n BASEDIR=`basename $PWD`\n cd ..\n chown -R ${USERID}.${GRPID} $BASEDIR\n@@ -57,7 +62,7 @@\n \tREMOVE_LN=$PWD/ctdb-$VERSION\n fi\n echo -n \"Creating ctdb-${VERSION}.tar.bz2 ... \"\n-tar --exclude=.bzr --exclude .bzrignore --exclude packaging -cf - ctdb-${VERSION}/. | bzip2 > ${SRCDIR}/ctdb-${VERSION}.tar.bz2\n+tar --exclude=.bzr --exclude .bzrignore --exclude packaging --exclude=\"*~\" -cf - ctdb-${VERSION}/. | bzip2 > ${SRCDIR}/ctdb-${VERSION}.tar.bz2\n echo \"Done.\"\n if [ $? -ne 0 ]; then\n         echo \"Build failed!\"\n@@ -71,16 +76,15 @@\n ##\n ## copy additional source files\n ##\n-tar --exclude=.svn -jcvf - setup > ${SRCDIR}/ctdb-setup.tar.bz2\n-cp -p ${SPECFILE} ${SPECDIR}\n+(cd packaging/RHEL && tar --exclude=.bzr --exclude=\"*~\" -jcvf - setup) > ${SRCDIR}/ctdb-setup.tar.bz2\n+cp -p ${RHEL}/${SPECFILE} ${SPECDIR}\n \n ##\n ## Build\n ##\n echo \"$(basename $0): Getting Ready to build release package\"\n cd ${SPECDIR}\n-${RPM} -ba --clean --rmsource $EXTRA_OPTIONS $SPECFILE\n+${RPMBUILD} -ba --clean --rmsource $EXTRA_OPTIONS $SPECFILE\n \n echo \"$(basename $0): Done.\"\n [ ${REMOVE_LN} ] && rm $REMOVE_LN\n-\n\n"}