{"category": "ham", "to_address": "samba-cvs@samba.org", "from_address": "jerry@samba.org", "subject": "svn commit: samba r22158 - in branches: SAMBA_3_0/source/nsswitch\n\tSAMBA_3_0_25/source/nsswitch", "body": "Author: jerry\nDate: 2007-04-10 21:14:44 +0000 (Tue, 10 Apr 2007)\nNew Revision: 22158\n\nWebSVN: http://websvn.samba.org/cgi-bin/viewcvs.cgi?view=rev&root=samba&rev=22158\n\nLog:\nBUG 4501 (partial): Fix a crash caused by not using the \nnss_info_{rfc2307,sfu} plugin with idmap_ad.\n\n\nModified:\n   branches/SAMBA_3_0/source/nsswitch/idmap_ad.c\n   branches/SAMBA_3_0_25/source/nsswitch/idmap_ad.c\n\n\nChangeset:\nModified: branches/SAMBA_3_0/source/nsswitch/idmap_ad.c\n===================================================================\n--- branches/SAMBA_3_0/source/nsswitch/idmap_ad.c\t2007-04-10 20:35:30 UTC (rev 22157)\n+++ branches/SAMBA_3_0/source/nsswitch/idmap_ad.c\t2007-04-10 21:14:44 UTC (rev 22158)\n@@ -164,14 +164,10 @@\n {\n \tstruct idmap_ad_context *ctx;\n \tchar *config_option;\n-\tconst char *range;\n+\tconst char *range = NULL;\n+\tconst char *schema_mode = NULL;\t\n \tADS_STRUCT *ads;\n \n-\t/* verify AD is reachable (not critical, we may just be offline at start) */\n-\tif ( (ads = ad_idmap_cached_connection()) == NULL ) {\n-\t\tDEBUG(1, (\"WARNING: Could not init an AD connection! Mapping might not work.\\n\"));\n-\t}\n-\n \tif ( (ctx = talloc_zero(dom, struct idmap_ad_context)) == NULL ) {\n \t\tDEBUG(0, (\"Out of memory!\\n\"));\n \t\treturn NT_STATUS_NO_MEMORY;\n@@ -194,6 +190,20 @@\n \t\t}\n \t}\n \n+\t/* schema mode */\n+\tif ( ad_map_type == WB_POSIX_MAP_UNKNOWN )\n+\t\tad_map_type = WB_POSIX_MAP_RFC2307;\n+\tschema_mode = lp_parm_const_string(-1, config_option, \"schema_mode\", NULL);\n+\tif ( schema_mode && schema_mode[0] ) {\n+\t\tif ( strequal(schema_mode, \"sfu\") )\n+\t\t\tad_map_type = WB_POSIX_MAP_SFU;\n+\t\telse if ( strequal(schema_mode, \"rfc2307\" ) )\n+\t\t\tad_map_type = WB_POSIX_MAP_RFC2307;\n+\t\telse\n+\t\t\tDEBUG(0,(\"idmap_ad_initialize: Unknown schema_mode (%s)\\n\",\n+\t\t\t\t schema_mode));\n+\t}\n+\n \tdom->private_data = ctx;\n \n \ttalloc_free(config_option);\n\nModified: branches/SAMBA_3_0_25/source/nsswitch/idmap_ad.c\n===================================================================\n--- branches/SAMBA_3_0_25/source/nsswitch/idmap_ad.c\t2007-04-10 20:35:30 UTC (rev 22157)\n+++ branches/SAMBA_3_0_25/source/nsswitch/idmap_ad.c\t2007-04-10 21:14:44 UTC (rev 22158)\n@@ -164,14 +164,10 @@\n {\n \tstruct idmap_ad_context *ctx;\n \tchar *config_option;\n-\tconst char *range;\n+\tconst char *range = NULL;\n+\tconst char *schema_mode = NULL;\t\n \tADS_STRUCT *ads;\n \n-\t/* verify AD is reachable (not critical, we may just be offline at start) */\n-\tif ( (ads = ad_idmap_cached_connection()) == NULL ) {\n-\t\tDEBUG(1, (\"WARNING: Could not init an AD connection! Mapping might not work.\\n\"));\n-\t}\n-\n \tif ( (ctx = talloc_zero(dom, struct idmap_ad_context)) == NULL ) {\n \t\tDEBUG(0, (\"Out of memory!\\n\"));\n \t\treturn NT_STATUS_NO_MEMORY;\n@@ -194,6 +190,20 @@\n \t\t}\n \t}\n \n+\t/* schema mode */\n+\tif ( ad_map_type == WB_POSIX_MAP_UNKNOWN )\n+\t\tad_map_type = WB_POSIX_MAP_RFC2307;\n+\tschema_mode = lp_parm_const_string(-1, config_option, \"schema_mode\", NULL);\n+\tif ( schema_mode && schema_mode[0] ) {\n+\t\tif ( strequal(schema_mode, \"sfu\") )\n+\t\t\tad_map_type = WB_POSIX_MAP_SFU;\n+\t\telse if ( strequal(schema_mode, \"rfc2307\" ) )\n+\t\t\tad_map_type = WB_POSIX_MAP_RFC2307;\n+\t\telse\n+\t\t\tDEBUG(0,(\"idmap_ad_initialize: Unknown schema_mode (%s)\\n\",\n+\t\t\t\t schema_mode));\n+\t}\n+\n \tdom->private_data = ctx;\n \n \ttalloc_free(config_option);\n\n"}