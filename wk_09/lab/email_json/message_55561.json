{"category": "ham", "to_address": "samba-cvs@samba.org", "from_address": "obnox@samba.org", "subject": "svn commit: samba r23610 - in branches: SAMBA_3_0/source/lib\n\tSAMBA_3_0/source/nsswitch SAMBA_3_0_26/source/lib\n\tSAMBA_3_0_26/source/nsswitch", "body": "Author: obnox\nDate: 2007-06-26 13:45:07 +0000 (Tue, 26 Jun 2007)\nNew Revision: 23610\n\nWebSVN: http://websvn.samba.org/cgi-bin/viewcvs.cgi?view=rev&root=samba&rev=23610\n\nLog:\nMove some winbindd_cache specific flags and actions \nback to winbindd_cache.c. The generic mechanism\nshould open the cache tdb readonly and with default\nflags.\n\nMichael\n\n\nModified:\n   branches/SAMBA_3_0/source/lib/util_tdb.c\n   branches/SAMBA_3_0/source/nsswitch/winbindd_cache.c\n   branches/SAMBA_3_0_26/source/lib/util_tdb.c\n   branches/SAMBA_3_0_26/source/nsswitch/winbindd_cache.c\n\n\nChangeset:\nModified: branches/SAMBA_3_0/source/lib/util_tdb.c\n===================================================================\n--- branches/SAMBA_3_0/source/lib/util_tdb.c\t2007-06-26 10:19:06 UTC (rev 23609)\n+++ branches/SAMBA_3_0/source/lib/util_tdb.c\t2007-06-26 13:45:07 UTC (rev 23610)\n@@ -1005,12 +1005,7 @@\n \tv_status.unknown_key = False;\n \tv_status.success = True;\n \n-\ttdb = tdb_open_log(tdb_path,\n-\t\t\tWINBINDD_CACHE_TDB_DEFAULT_HASH_SIZE,\n-\t\t\tlp_winbind_offline_logon() \n-\t\t\t\t?  TDB_DEFAULT \n-\t\t\t\t: (TDB_DEFAULT | TDB_CLEAR_IF_FIRST),\n-\t\t\tO_RDWR|O_CREAT, 0600);\n+\ttdb = tdb_open_log(tdb_path, 0, TDB_DEFAULT, O_RDONLY, 0);\n \tif (!tdb) {\n \t\tv_status.tdb_error = True;\n \t\tv_status.success = False;\n@@ -1182,4 +1177,3 @@\n \n \treturn ret;\n }\n-\n\nModified: branches/SAMBA_3_0/source/nsswitch/winbindd_cache.c\n===================================================================\n--- branches/SAMBA_3_0/source/nsswitch/winbindd_cache.c\t2007-06-26 10:19:06 UTC (rev 23609)\n+++ branches/SAMBA_3_0/source/nsswitch/winbindd_cache.c\t2007-06-26 13:45:07 UTC (rev 23610)\n@@ -3279,14 +3279,32 @@\n \n int winbindd_validate_cache(void)\n {\n-\tint ret;\n+\tint ret = -1;\n+\tconst char *tdb_path = lock_path(\"winbindd_cache.tdb\");\n+\tTDB_CONTEXT *tdb = NULL;\n \n \tDEBUG(10, (\"winbindd_validate_cache: replacing panic function\\n\"));\n \tsmb_panic_fn = validate_panic;\n \n+\n+\ttdb = tdb_open_log(tdb_path, \n+\t\t\t   WINBINDD_CACHE_TDB_DEFAULT_HASH_SIZE,\n+\t\t\t   ( lp_winbind_offline_logon() \n+\t\t\t     ? TDB_DEFAULT \n+\t\t\t     : TDB_DEFAULT | TDB_CLEAR_IF_FIRST ),\n+\t\t\t   O_RDWR|O_CREAT, \n+\t\t\t   0600);\n+\tif (!tdb) {\n+\t\tDEBUG(0, (\"winbindd_validate_cache: \"\n+\t\t\t  \"error opening/initializing tdb\\n\"));\n+\t\tgoto done;\n+\t}\n+\ttdb_close(tdb);\n+\n \tret = tdb_validate(lock_path(\"winbindd_cache.tdb\"),\n \t\t\t   cache_traverse_validate_fn);\n \n+done:\n \tDEBUG(10, (\"winbindd_validate_cache: restoring panic function\\n\"));\n \tsmb_panic_fn = smb_panic;\n \treturn ret;\n\nModified: branches/SAMBA_3_0_26/source/lib/util_tdb.c\n===================================================================\n--- branches/SAMBA_3_0_26/source/lib/util_tdb.c\t2007-06-26 10:19:06 UTC (rev 23609)\n+++ branches/SAMBA_3_0_26/source/lib/util_tdb.c\t2007-06-26 13:45:07 UTC (rev 23610)\n@@ -1005,12 +1005,7 @@\n \tv_status.unknown_key = False;\n \tv_status.success = True;\n \n-\ttdb = tdb_open_log(tdb_path,\n-\t\t\tWINBINDD_CACHE_TDB_DEFAULT_HASH_SIZE,\n-\t\t\tlp_winbind_offline_logon() \n-\t\t\t\t?  TDB_DEFAULT \n-\t\t\t\t: (TDB_DEFAULT | TDB_CLEAR_IF_FIRST),\n-\t\t\tO_RDWR|O_CREAT, 0600);\n+\ttdb = tdb_open_log(tdb_path, 0, TDB_DEFAULT, O_RDONLY, 0);\n \tif (!tdb) {\n \t\tv_status.tdb_error = True;\n \t\tv_status.success = False;\n@@ -1182,4 +1177,3 @@\n \n \treturn ret;\n }\n-\n\nModified: branches/SAMBA_3_0_26/source/nsswitch/winbindd_cache.c\n===================================================================\n--- branches/SAMBA_3_0_26/source/nsswitch/winbindd_cache.c\t2007-06-26 10:19:06 UTC (rev 23609)\n+++ branches/SAMBA_3_0_26/source/nsswitch/winbindd_cache.c\t2007-06-26 13:45:07 UTC (rev 23610)\n@@ -3279,14 +3279,32 @@\n \n int winbindd_validate_cache(void)\n {\n-\tint ret;\n+\tint ret = -1;\n+\tconst char *tdb_path = lock_path(\"winbindd_cache.tdb\");\n+\tTDB_CONTEXT *tdb = NULL;\n \n \tDEBUG(10, (\"winbindd_validate_cache: replacing panic function\\n\"));\n \tsmb_panic_fn = validate_panic;\n \n+\n+\ttdb = tdb_open_log(tdb_path, \n+\t\t\t   WINBINDD_CACHE_TDB_DEFAULT_HASH_SIZE,\n+\t\t\t   ( lp_winbind_offline_logon() \n+\t\t\t     ? TDB_DEFAULT \n+\t\t\t     : TDB_DEFAULT | TDB_CLEAR_IF_FIRST ),\n+\t\t\t   O_RDWR|O_CREAT, \n+\t\t\t   0600);\n+\tif (!tdb) {\n+\t\tDEBUG(0, (\"winbindd_validate_cache: \"\n+\t\t\t  \"error opening/initializing tdb\\n\"));\n+\t\tgoto done;\n+\t}\n+\ttdb_close(tdb);\n+\n \tret = tdb_validate(lock_path(\"winbindd_cache.tdb\"),\n \t\t\t   cache_traverse_validate_fn);\n \n+done:\n \tDEBUG(10, (\"winbindd_validate_cache: restoring panic function\\n\"));\n \tsmb_panic_fn = smb_panic;\n \treturn ret;\n\n"}