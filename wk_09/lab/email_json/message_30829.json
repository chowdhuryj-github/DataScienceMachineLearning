{"category": "ham", "to_address": "samba-cvs@samba.org", "from_address": "vlendec@samba.org", "subject": "svn commit: samba r22929 - in branches/SAMBA_3_0/source/libsmb: .", "body": "Author: vlendec\nDate: 2007-05-16 09:53:41 +0000 (Wed, 16 May 2007)\nNew Revision: 22929\n\nWebSVN: http://websvn.samba.org/cgi-bin/viewcvs.cgi?view=rev&root=samba&rev=22929\n\nLog:\nAttempt to fix some build farm failures: On port 139 the first\nsuccessful packet gives len==0 from the server, so the = in \n\n        if (len <= 0) {\n\nin line 136 of clientgen.c throws a failure.\n\nJeremy, please fix this properly, I'm not merging this to 3_0_26 so that\nyou can filter it when you merge.\n\nVolker\n\n\nModified:\n   branches/SAMBA_3_0/source/libsmb/cliconnect.c\n   branches/SAMBA_3_0/source/libsmb/clientgen.c\n\n\nChangeset:\nModified: branches/SAMBA_3_0/source/libsmb/cliconnect.c\n===================================================================\n--- branches/SAMBA_3_0/source/libsmb/cliconnect.c\t2007-05-16 09:42:29 UTC (rev 22928)\n+++ branches/SAMBA_3_0/source/libsmb/cliconnect.c\t2007-05-16 09:53:41 UTC (rev 22929)\n@@ -1347,7 +1347,7 @@\n \tcli_send_smb(cli);\n \tDEBUG(5,(\"Sent session request\\n\"));\n \n-\tif (!cli_receive_smb(cli))\n+\tif (!cli_receive_sessionreply(cli))\n \t\treturn False;\n \n \tif (CVAL(cli->inbuf,0) == 0x84) {\n\nModified: branches/SAMBA_3_0/source/libsmb/clientgen.c\n===================================================================\n--- branches/SAMBA_3_0/source/libsmb/clientgen.c\t2007-05-16 09:42:29 UTC (rev 22928)\n+++ branches/SAMBA_3_0/source/libsmb/clientgen.c\t2007-05-16 09:53:41 UTC (rev 22929)\n@@ -191,6 +191,32 @@\n }\n \n /****************************************************************************\n+ Recv an smb session reply\n+****************************************************************************/\n+\n+BOOL cli_receive_sessionreply(struct cli_state *cli)\n+{\n+\tssize_t len;\n+\n+\t/* fd == -1 causes segfaults -- Tom (tom@ninja.nl) */\n+\tif (cli->fd == -1)\n+\t\treturn False; \n+\n+\tlen = client_receive_smb(cli, False, 0);\n+\n+\t/* If the server is not responding, note that now */\n+\tif (len < 0) {\n+                DEBUG(0, (\"Receiving SMB: Server stopped responding\\n\"));\n+\t\tcli->smb_rw_error = smb_read_error;\n+\t\tclose(cli->fd);\n+\t\tcli->fd = -1;\n+\t\treturn False;\n+\t}\n+\n+\treturn True;\n+}\n+\n+/****************************************************************************\n  Read the data portion of a readX smb.\n  The timeout is in milliseconds\n ****************************************************************************/\n\n"}