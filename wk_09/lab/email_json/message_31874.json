{"category": "ham", "to_address": "samba-cvs@samba.org", "from_address": "tridge@samba.org", "subject": "Rev 315: - don't try to send controls to dead nodes in\n\thttp://samba.org/~tridge/ctdb", "body": "------------------------------------------------------------\nrevno: 315\nrevision-id: tridge@samba.org-20070517132341-3syo9kztm9ckwpbs\nparent: tridge@samba.org-20070517075402-8uppvsgamxi878c5\ncommitter: Andrew Tridgell \nbranch nick: tridge\ntimestamp: Thu 2007-05-17 23:23:41 +1000\nmessage:\n  - don't try to send controls to dead nodes\n  - use only connected nodes in a traverse\nmodified:\n  common/ctdb.c                  ctdb.c-20061127094323-t50f58d65iaao5of-2\n  common/ctdb_control.c          ctdb_control.c-20070426122724-j6gkpiofhbwdin63-1\n  common/ctdb_recoverd.c         recoverd.c-20070503213540-bvxuyd9jm1f7ig90-1\n  common/ctdb_traverse.c         ctdb_traverse.c-20070503021550-ztfs5rwx8jfm8qqx-1\n  include/ctdb.h                 ctdb.h-20061117234101-o3qt14umlg9en8z0-11\n  include/ctdb_private.h         ctdb_private.h-20061117234101-o3qt14umlg9en8z0-13\n=== modified file 'common/ctdb.c'\n--- a/common/ctdb.c\t2007-05-12 09:54:40 +0000\n+++ b/common/ctdb.c\t2007-05-17 13:23:41 +0000\n@@ -217,6 +217,21 @@\n \treturn ctdb->num_nodes;\n }\n \n+/*\n+  return the number of connected nodes\n+*/\n+uint32_t ctdb_get_num_connected_nodes(struct ctdb_context *ctdb)\n+{\n+\tint i;\n+\tuint32_t count=0;\n+\tfor (i=0;ivnn_map->size;i++) {\n+\t\tif (ctdb->nodes[i]->flags & NODE_FLAGS_CONNECTED) {\n+\t\t\tcount++;\n+\t\t}\n+\t}\n+\treturn count;\n+}\n+\n \n /*\n   called by the transport layer when a packet comes in\n\n=== modified file 'common/ctdb_control.c'\n--- a/common/ctdb_control.c\t2007-05-17 04:10:38 +0000\n+++ b/common/ctdb_control.c\t2007-05-17 13:23:41 +0000\n@@ -395,6 +395,15 @@\n \t\treturn -1;\n \t}\n \n+\tif (destnode != CTDB_BROADCAST_VNNMAP && destnode != CTDB_BROADCAST_VNNMAP && \n+\t    (!ctdb_validate_vnn(ctdb, destnode) || \n+\t     !(ctdb->nodes[destnode]->flags & NODE_FLAGS_CONNECTED))) {\n+\t\tif (!(flags & CTDB_CTRL_FLAG_NOREPLY)) {\n+\t\t\tcallback(ctdb, -1, tdb_null, \"ctdb_control to disconnected node\", private_data);\n+\t\t}\n+\t\treturn 0;\n+\t}\n+\n \t/* the state is made a child of private_data if possible. This means any reply\n \t   will be discarded if the private_data goes away */\n \tstate = talloc(private_data?private_data:ctdb, struct ctdb_control_state);\n\n=== modified file 'common/ctdb_recoverd.c'\n--- a/common/ctdb_recoverd.c\t2007-05-16 01:12:28 +0000\n+++ b/common/ctdb_recoverd.c\t2007-05-17 13:23:41 +0000\n@@ -447,6 +447,8 @@\n \t\treturn -1;\n \t}\n \n+\t/* send a message to all clients telling them that the cluster has been reconfigured */\n+\tctdb_send_message(ctdb, CTDB_BROADCAST_ALL, CTDB_SRVID_RECONFIGURE, tdb_null);\n \n \tDEBUG(0, (__location__ \" Recovery complete\\n\"));\n \treturn 0;\n@@ -465,7 +467,6 @@\n \tuint64_t srvid;\n \t\n \tsrvid = CTDB_SRVTYPE_RECOVERY;\n-\tsrvid <<= 32;\n \n \temsg.vnn = vnn;\n \n@@ -857,7 +858,6 @@\n \n \t/* register a message port for recovery elections */\n \tsrvid = CTDB_SRVTYPE_RECOVERY;\n-\tsrvid <<= 32;\n \tctdb_set_message_handler(ctdb, srvid, election_handler, NULL);\n \n \tmonitor_cluster(ctdb);\n\n=== modified file 'common/ctdb_traverse.c'\n--- a/common/ctdb_traverse.c\t2007-05-10 07:43:45 +0000\n+++ b/common/ctdb_traverse.c\t2007-05-17 13:23:41 +0000\n@@ -365,7 +365,7 @@\n \n \tif (key.dsize == 0 && data.dsize == 0) {\n \t\tstate->null_count++;\n-\t\tif (state->null_count != ctdb_get_num_nodes(ctdb)) {\n+\t\tif (state->null_count != ctdb_get_num_connected_nodes(ctdb)) {\n \t\t\treturn 0;\n \t\t}\n \t}\n\n=== modified file 'include/ctdb.h'\n--- a/include/ctdb.h\t2007-05-17 02:07:29 +0000\n+++ b/include/ctdb.h\t2007-05-17 13:23:41 +0000\n@@ -56,10 +56,16 @@\n    a message handler ID meaning \"give me all messages\"\n  */\n #define CTDB_SRVID_ALL (~(uint64_t)0)\n+\n /*\n   srvid type : RECOVERY\n */\n-#define CTDB_SRVTYPE_RECOVERY\t0x64766372\n+#define CTDB_SRVTYPE_RECOVERY\t0xF100000000000000LL\n+\n+/* \n+   a message handler ID meaning that the cluster has been reconfigured\n+ */\n+#define CTDB_SRVID_RECONFIGURE 0xF200000000000000LL\n \n struct event_context;\n \n\n=== modified file 'include/ctdb_private.h'\n--- a/include/ctdb_private.h\t2007-05-17 04:10:38 +0000\n+++ b/include/ctdb_private.h\t2007-05-17 13:23:41 +0000\n@@ -802,4 +802,6 @@\n \n int ctdb_start_recoverd(struct ctdb_context *ctdb);\n \n+uint32_t ctdb_get_num_connected_nodes(struct ctdb_context *ctdb);\n+\n #endif\n\n"}