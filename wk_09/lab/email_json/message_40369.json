{"category": "ham", "to_address": "samba-cvs@samba.org", "from_address": "obnox@samba.org", "subject": "svn commit: samba r23291 - in branches: SAMBA_3_0/source/nsswitch\n\tSAMBA_3_0_26/source/nsswitch", "body": "Author: obnox\nDate: 2007-06-01 12:24:57 +0000 (Fri, 01 Jun 2007)\nNew Revision: 23291\n\nWebSVN: http://websvn.samba.org/cgi-bin/viewcvs.cgi?view=rev&root=samba&rev=23291\n\nLog:\nUndo the somewhat naive change of r23279:\nThe clear text presentaion of the sid in the ldap expression\ndoes work with w2k3 but not with w2k....\n\nThanks to Guenther for advising me of this issue.\n\nMichael\n\n\nModified:\n   branches/SAMBA_3_0/source/nsswitch/winbindd_ads.c\n   branches/SAMBA_3_0_26/source/nsswitch/winbindd_ads.c\n\n\nChangeset:\nModified: branches/SAMBA_3_0/source/nsswitch/winbindd_ads.c\n===================================================================\n--- branches/SAMBA_3_0/source/nsswitch/winbindd_ads.c\t2007-06-01 12:18:16 UTC (rev 23290)\n+++ branches/SAMBA_3_0/source/nsswitch/winbindd_ads.c\t2007-06-01 12:24:57 UTC (rev 23291)\n@@ -901,6 +901,7 @@\n \tADS_STRUCT *ads = NULL;\n \tchar *ldap_exp;\n \tNTSTATUS status = NT_STATUS_UNSUCCESSFUL;\n+\tchar *sidbinstr;\n \tchar **members = NULL;\n \tint i;\n \tsize_t num_members = 0;\n@@ -939,14 +940,21 @@\n \t\tgoto done;\n \t}\n \n+\tif ((sidbinstr = sid_binstring(group_sid)) == NULL) {\n+\t\tstatus = NT_STATUS_NO_MEMORY;\n+\t\tgoto done;\n+\t}\n+\n \t/* search for all members of the group */\n-\tif (!(ldap_exp = talloc_asprintf(tmp_ctx, \"(objectSid=%s)\",\n-\t\t\t\t\t sid_string_static(group_sid)))) \n+\tif (!(ldap_exp = talloc_asprintf(tmp_ctx, \"(objectSid=%s)\", \n+\t\t\t\t\t sidbinstr))) \n \t{\n+\t\tSAFE_FREE(sidbinstr);\n \t\tDEBUG(1, (\"ads: lookup_groupmem: talloc_asprintf for ldap_exp failed!\\n\"));\n \t\tstatus = NT_STATUS_NO_MEMORY;\n \t\tgoto done;\n \t}\n+\tSAFE_FREE(sidbinstr);\n \n \targs.control = ADS_EXTENDED_DN_OID;\n \targs.val = ADS_EXTENDED_DN_HEX_STRING;\n\nModified: branches/SAMBA_3_0_26/source/nsswitch/winbindd_ads.c\n===================================================================\n--- branches/SAMBA_3_0_26/source/nsswitch/winbindd_ads.c\t2007-06-01 12:18:16 UTC (rev 23290)\n+++ branches/SAMBA_3_0_26/source/nsswitch/winbindd_ads.c\t2007-06-01 12:24:57 UTC (rev 23291)\n@@ -901,6 +901,7 @@\n \tADS_STRUCT *ads = NULL;\n \tchar *ldap_exp;\n \tNTSTATUS status = NT_STATUS_UNSUCCESSFUL;\n+\tchar *sidbinstr;\n \tchar **members = NULL;\n \tint i;\n \tsize_t num_members = 0;\n@@ -939,14 +940,21 @@\n \t\tgoto done;\n \t}\n \n+\tif ((sidbinstr = sid_binstring(group_sid)) == NULL) {\n+\t\tstatus = NT_STATUS_NO_MEMORY;\n+\t\tgoto done;\n+\t}\n+\n \t/* search for all members of the group */\n-\tif (!(ldap_exp = talloc_asprintf(tmp_ctx, \"(objectSid=%s)\",\n-\t\t\t\t\t sid_string_static(group_sid)))) \n+\tif (!(ldap_exp = talloc_asprintf(tmp_ctx, \"(objectSid=%s)\", \n+\t\t\t\t\t sidbinstr))) \n \t{\n+\t\tSAFE_FREE(sidbinstr);\n \t\tDEBUG(1, (\"ads: lookup_groupmem: talloc_asprintf for ldap_exp failed!\\n\"));\n \t\tstatus = NT_STATUS_NO_MEMORY;\n \t\tgoto done;\n \t}\n+\tSAFE_FREE(sidbinstr);\n \n \targs.control = ADS_EXTENDED_DN_OID;\n \targs.val = ADS_EXTENDED_DN_HEX_STRING;\n\n"}