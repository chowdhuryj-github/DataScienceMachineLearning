{"category": "ham", "to_address": "samba-cvs@samba.org", "from_address": "jra@samba.org", "subject": "svn commit: samba r23390 - in branches: SAMBA_3_0/source/smbd\n\tSAMBA_3_0_26/source/smbd", "body": "Author: jra\nDate: 2007-06-08 19:52:18 +0000 (Fri, 08 Jun 2007)\nNew Revision: 23390\n\nWebSVN: http://websvn.samba.org/cgi-bin/viewcvs.cgi?view=rev&root=samba&rev=23390\n\nLog:\nFirst part of the patch to make Apple's life easier.\nDoing this in two stages to make it very easy to\nreview. Context switching must look like :\n\ngain_root();\nsys_setgroups(ngroups, groups);\nbecome_id(uid, gid);\n\nRe-arrange order so these three calls are always\nseen together.\n\nNext will be to turn these into a function.\n\nJeremy.\n\nModified:\n   branches/SAMBA_3_0/source/smbd/sec_ctx.c\n   branches/SAMBA_3_0_26/source/smbd/sec_ctx.c\n\n\nChangeset:\nModified: branches/SAMBA_3_0/source/smbd/sec_ctx.c\n===================================================================\n--- branches/SAMBA_3_0/source/smbd/sec_ctx.c\t2007-06-08 14:37:29 UTC (rev 23389)\n+++ branches/SAMBA_3_0/source/smbd/sec_ctx.c\t2007-06-08 19:52:18 UTC (rev 23390)\n@@ -243,11 +243,13 @@\n \tdebug_nt_user_token(DBGC_CLASS, 5, token);\n \tdebug_unix_user_token(DBGC_CLASS, 5, uid, gid, ngroups, groups);\n \n+\t/* Start context switch */\n \tgain_root();\n-\n #ifdef HAVE_SETGROUPS\n \tsys_setgroups(ngroups, groups);\n #endif\n+\tbecome_id(uid, gid);\n+\t/* end context switch */\n \n \tctx_p->ut.ngroups = ngroups;\n \n@@ -277,8 +279,6 @@\n \t\tctx_p->token = NULL;\n \t}\n \n-\tbecome_id(uid, gid);\n-\n \tctx_p->ut.uid = uid;\n \tctx_p->ut.gid = gid;\n \n@@ -334,15 +334,15 @@\n \n \tsec_ctx_stack_ndx--;\n \n-\tgain_root();\n-\n \tprev_ctx_p = &sec_ctx_stack[sec_ctx_stack_ndx];\n \n+\t/* Start context switch */\n+\tgain_root();\n #ifdef HAVE_SETGROUPS\n \tsys_setgroups(prev_ctx_p->ut.ngroups, prev_ctx_p->ut.groups);\n #endif\n-\n \tbecome_id(prev_ctx_p->ut.uid, prev_ctx_p->ut.gid);\n+\t/* end context switch */\n \n \t/* Update current_user stuff */\n \n\nModified: branches/SAMBA_3_0_26/source/smbd/sec_ctx.c\n===================================================================\n--- branches/SAMBA_3_0_26/source/smbd/sec_ctx.c\t2007-06-08 14:37:29 UTC (rev 23389)\n+++ branches/SAMBA_3_0_26/source/smbd/sec_ctx.c\t2007-06-08 19:52:18 UTC (rev 23390)\n@@ -243,11 +243,13 @@\n \tdebug_nt_user_token(DBGC_CLASS, 5, token);\n \tdebug_unix_user_token(DBGC_CLASS, 5, uid, gid, ngroups, groups);\n \n+\t/* Start context switch */\n \tgain_root();\n-\n #ifdef HAVE_SETGROUPS\n \tsys_setgroups(ngroups, groups);\n #endif\n+\tbecome_id(uid, gid);\n+\t/* end context switch */\n \n \tctx_p->ut.ngroups = ngroups;\n \n@@ -277,8 +279,6 @@\n \t\tctx_p->token = NULL;\n \t}\n \n-\tbecome_id(uid, gid);\n-\n \tctx_p->ut.uid = uid;\n \tctx_p->ut.gid = gid;\n \n@@ -334,15 +334,15 @@\n \n \tsec_ctx_stack_ndx--;\n \n-\tgain_root();\n-\n \tprev_ctx_p = &sec_ctx_stack[sec_ctx_stack_ndx];\n \n+\t/* Start context switch */\n+\tgain_root();\n #ifdef HAVE_SETGROUPS\n \tsys_setgroups(prev_ctx_p->ut.ngroups, prev_ctx_p->ut.groups);\n #endif\n-\n \tbecome_id(prev_ctx_p->ut.uid, prev_ctx_p->ut.gid);\n+\t/* end context switch */\n \n \t/* Update current_user stuff */\n \n\n"}