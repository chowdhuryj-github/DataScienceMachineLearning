{"category": "ham", "to_address": "Simon McVittie <simon.mcvittie@collabora.co.uk>", "from_address": "Dan Williams <dcbw@redhat.com>", "subject": "Re: [sugar] [PATCH] services/presence/: keep track of the\n\towner's\tTelepathy handles", "body": "On Tue, 2007-05-22 at 16:49 +0100, Simon McVittie wrote:\n> -----BEGIN PGP SIGNED MESSAGE-----\n> Hash: SHA1\n> \n> - ---\n>  services/presence/presenceservice.py |    7 +++++++\n>  services/presence/server_plugin.py   |    5 +++--\n>  2 files changed, 10 insertions(+), 2 deletions(-)\n\nLooks good\n\n> diff --git a/services/presence/presenceservice.py b/services/presence/presenceservice.py\n> index 4bd4da8..0c8a2a5 100644\n> - --- a/services/presence/presenceservice.py\n> +++ b/services/presence/presenceservice.py\n> @@ -107,12 +107,19 @@ class PresenceService(ExportedGObject):\n>          _logger.debug(\"Disconnected from session bus!!!\")\n>  \n>      def _server_status_cb(self, plugin, status, reason):\n> +\n>          # FIXME: figure out connection status when we have a salut plugin too\n>          old_status = self._connected\n>          if status == CONNECTION_STATUS_CONNECTED:\n>              self._connected = True\n> +            self._handles_buddies[plugin][plugin.self_handle] = self._owner\n> +            self._owner.add_telepathy_handle(plugin, plugin.self_handle)\n>          else:\n>              self._connected = False\n> +            if plugin.self_handle is not None:\n> +                self._handles_buddies.setdefault(plugin, {}).pop(\n> +                        plugin.self_handle, None)\n> +                self._owner.remove_telepathy_handle(plugin, plugin.self_handle)\n>  \n>          if self._connected != old_status:\n>              self.emit('connection-status', self._connected)\n> diff --git a/services/presence/server_plugin.py b/services/presence/server_plugin.py\n> index a886fdb..6b21888 100644\n> - --- a/services/presence/server_plugin.py\n> +++ b/services/presence/server_plugin.py\n> @@ -137,6 +137,7 @@ class ServerPlugin(gobject.GObject):\n>          self._owner = owner\n>          self._owner.connect(\"property-changed\", self._owner_property_changed_cb)\n>          self._owner.connect(\"icon-changed\", self._owner_icon_changed_cb)\n> +        self.self_handle = None\n>  \n>          self._account = self._get_account_info()\n>          self._conn_status = CONNECTION_STATUS_DISCONNECTED\n> @@ -348,8 +349,8 @@ class ServerPlugin(gobject.GObject):\n>              # accept pending subscriptions\n>              publish[CHANNEL_INTERFACE_GROUP].AddMembers(local_pending, '')\n>  \n> - -        self_handle = self._conn[CONN_INTERFACE].GetSelfHandle()\n> - -        self._online_contacts[self_handle] = self._account['account']\n> +        self.self_handle = self._conn[CONN_INTERFACE].GetSelfHandle()\n> +        self._online_contacts[self.self_handle] = self._account['account']\n>  \n>          # request subscriptions from people subscribed to us if we're not subscribed to them\n>          not_subscribed = list(set(publish_handles) - set(subscribe_handles))\n> - -- \n> 1.5.2-rc3.GIT\n> \n> -----BEGIN PGP SIGNATURE-----\n> Version: GnuPG v1.4.6 (GNU/Linux)\n> Comment: OpenPGP key: http://www.pseudorandom.co.uk/2003/contact/ or pgp.net\n> \n> iD8DBQFGUxEBWSc8zVUw7HYRAkjQAKDUfFxmfHBOqYOcLLM4mZX6lv72gQCcDm50\n> /W56qua0c+iTwNcMdXtC7DI=\n> =scbA\n> -----END PGP SIGNATURE-----\n> _______________________________________________\n> Sugar mailing list\n> Sugar@laptop.org\n> http://mailman.laptop.org/mailman/listinfo/sugar\n\n_______________________________________________\nSugar mailing list\nSugar@laptop.org\nhttp://mailman.laptop.org/mailman/listinfo/sugar\n\n"}