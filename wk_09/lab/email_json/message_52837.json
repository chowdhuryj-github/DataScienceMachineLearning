{"category": "ham", "to_address": "samba-cvs@samba.org", "from_address": "obnox@samba.org", "subject": "svn commit: samba r23585 - in branches: SAMBA_3_0/source/utils\n\tSAMBA_3_0_26/source/utils", "body": "Author: obnox\nDate: 2007-06-22 11:43:50 +0000 (Fri, 22 Jun 2007)\nNew Revision: 23585\n\nWebSVN: http://websvn.samba.org/cgi-bin/viewcvs.cgi?view=rev&root=samba&rev=23585\n\nLog:\nAdd a \"drop\" function to \"net conf\" that clears the\nwhole configuration stored in registry.\n\nMichael\n\n\nModified:\n   branches/SAMBA_3_0/source/utils/net_conf.c\n   branches/SAMBA_3_0_26/source/utils/net_conf.c\n\n\nChangeset:\nModified: branches/SAMBA_3_0/source/utils/net_conf.c\n===================================================================\n--- branches/SAMBA_3_0/source/utils/net_conf.c\t2007-06-22 11:42:17 UTC (rev 23584)\n+++ branches/SAMBA_3_0/source/utils/net_conf.c\t2007-06-22 11:43:50 UTC (rev 23585)\n@@ -54,6 +54,12 @@\n \treturn -1;\n }\n \n+static int net_conf_drop_usage(int argc, const char **argv)\n+{\n+\td_printf(\"USAGE: net conf drop\\n\");\n+\treturn -1;\n+}\n+\n static int net_conf_showshare_usage(int argc, const char **argv)\n {\n \td_printf(\"USAGE: net conf showshare \\n\");\n@@ -368,6 +374,56 @@\n \treturn werr; \n }\n \n+static WERROR drop_smbconf_internal(TALLOC_CTX *ctx)\n+{\n+\tchar *path, *p;\n+\tWERROR werr = WERR_OK;\n+\tNT_USER_TOKEN *token;\n+\tstruct registry_key *parent_key = NULL;\n+\tstruct registry_key *new_key = NULL;\n+\tTALLOC_CTX* tmp_ctx = NULL;\n+\tenum winreg_CreateAction action;\n+\n+\ttmp_ctx = talloc_new(ctx);\n+\tif (tmp_ctx == NULL) {\n+\t\twerr = WERR_NOMEM;\n+\t\tgoto done;\n+\t}\n+\n+\tif (!(token = registry_create_admin_token(tmp_ctx))) {\n+\t\t/* what is the appropriate error code here? */\n+\t\twerr = WERR_CAN_NOT_COMPLETE; \n+\t\tgoto done;\n+\t}\n+\n+\tpath = talloc_strdup(tmp_ctx, KEY_SMBCONF);\n+\tif (path == NULL) {\n+\t\td_fprintf(stderr, \"ERROR: out of memory!\\n\");\n+\t\twerr = WERR_NOMEM;\n+\t\tgoto done;\n+\t}\n+\tp = strrchr(path, '\\\\');\n+\t*p = '\\0';\n+\twerr = reg_open_path(tmp_ctx, path, REG_KEY_WRITE, token, &parent_key);\n+\n+\tif (!W_ERROR_IS_OK(werr)) {\n+\t\tgoto done;\n+\t}\n+\n+\twerr = reg_deletekey_recursive(tmp_ctx, parent_key, p+1);\n+\n+\tif (!W_ERROR_IS_OK(werr)) {\n+\t\tgoto done;\n+\t}\n+\t\n+\twerr = reg_createkey(tmp_ctx, parent_key, p+1, REG_KEY_WRITE, \n+\t\t\t     &new_key, &action);\n+\n+done:\n+\tTALLOC_FREE(tmp_ctx);\n+\treturn werr;\n+}\n+\n static int import_process_service(TALLOC_CTX *ctx, \n \t\t\t\t  struct share_params *share)\n {\n@@ -708,6 +764,29 @@\n \treturn ret;\n }\n \n+int net_conf_drop(int argc, const char **argv)\n+{\n+\tint ret = -1;\n+\tWERROR werr;\n+\n+\tif (argc != 0) {\n+\t\tnet_conf_drop_usage(argc, argv);\n+\t\tgoto done;\n+\t}\n+\n+\twerr = drop_smbconf_internal(NULL);\n+\tif (!W_ERROR_IS_OK(werr)) {\n+\t\td_fprintf(stderr, \"Error deleting configuration: %s\\n\",\n+\t\t\t  dos_errstr(werr));\n+\t\tgoto done;\n+\t}\n+\n+\tret = 0;\n+\n+done:\n+\treturn ret;\n+}\n+\n int net_conf_showshare(int argc, const char **argv)\n {\n \tint ret = -1;\n@@ -1067,6 +1146,8 @@\n \t\t \"Import configuration from file in smb.conf format.\"},\n \t\t{\"listshares\", net_conf_listshares, \n \t\t \"List the registry shares.\"},\n+\t\t{\"drop\", net_conf_drop,\n+\t\t \"Delete the complete configuration from registry.\"},\n \t\t{\"showshare\", net_conf_showshare, \n \t\t \"Show the definition of a registry share.\"},\n \t\t{\"addshare\", net_conf_addshare, \n\nModified: branches/SAMBA_3_0_26/source/utils/net_conf.c\n===================================================================\n--- branches/SAMBA_3_0_26/source/utils/net_conf.c\t2007-06-22 11:42:17 UTC (rev 23584)\n+++ branches/SAMBA_3_0_26/source/utils/net_conf.c\t2007-06-22 11:43:50 UTC (rev 23585)\n@@ -54,6 +54,12 @@\n \treturn -1;\n }\n \n+static int net_conf_drop_usage(int argc, const char **argv)\n+{\n+\td_printf(\"USAGE: net conf drop\\n\");\n+\treturn -1;\n+}\n+\n static int net_conf_showshare_usage(int argc, const char **argv)\n {\n \td_printf(\"USAGE: net conf showshare \\n\");\n@@ -368,6 +374,56 @@\n \treturn werr; \n }\n \n+static WERROR drop_smbconf_internal(TALLOC_CTX *ctx)\n+{\n+\tchar *path, *p;\n+\tWERROR werr = WERR_OK;\n+\tNT_USER_TOKEN *token;\n+\tstruct registry_key *parent_key = NULL;\n+\tstruct registry_key *new_key = NULL;\n+\tTALLOC_CTX* tmp_ctx = NULL;\n+\tenum winreg_CreateAction action;\n+\n+\ttmp_ctx = talloc_new(ctx);\n+\tif (tmp_ctx == NULL) {\n+\t\twerr = WERR_NOMEM;\n+\t\tgoto done;\n+\t}\n+\n+\tif (!(token = registry_create_admin_token(tmp_ctx))) {\n+\t\t/* what is the appropriate error code here? */\n+\t\twerr = WERR_CAN_NOT_COMPLETE; \n+\t\tgoto done;\n+\t}\n+\n+\tpath = talloc_strdup(tmp_ctx, KEY_SMBCONF);\n+\tif (path == NULL) {\n+\t\td_fprintf(stderr, \"ERROR: out of memory!\\n\");\n+\t\twerr = WERR_NOMEM;\n+\t\tgoto done;\n+\t}\n+\tp = strrchr(path, '\\\\');\n+\t*p = '\\0';\n+\twerr = reg_open_path(tmp_ctx, path, REG_KEY_WRITE, token, &parent_key);\n+\n+\tif (!W_ERROR_IS_OK(werr)) {\n+\t\tgoto done;\n+\t}\n+\n+\twerr = reg_deletekey_recursive(tmp_ctx, parent_key, p+1);\n+\n+\tif (!W_ERROR_IS_OK(werr)) {\n+\t\tgoto done;\n+\t}\n+\t\n+\twerr = reg_createkey(tmp_ctx, parent_key, p+1, REG_KEY_WRITE, \n+\t\t\t     &new_key, &action);\n+\n+done:\n+\tTALLOC_FREE(tmp_ctx);\n+\treturn werr;\n+}\n+\n static int import_process_service(TALLOC_CTX *ctx, \n \t\t\t\t  struct share_params *share)\n {\n@@ -708,6 +764,29 @@\n \treturn ret;\n }\n \n+int net_conf_drop(int argc, const char **argv)\n+{\n+\tint ret = -1;\n+\tWERROR werr;\n+\n+\tif (argc != 0) {\n+\t\tnet_conf_drop_usage(argc, argv);\n+\t\tgoto done;\n+\t}\n+\n+\twerr = drop_smbconf_internal(NULL);\n+\tif (!W_ERROR_IS_OK(werr)) {\n+\t\td_fprintf(stderr, \"Error deleting configuration: %s\\n\",\n+\t\t\t  dos_errstr(werr));\n+\t\tgoto done;\n+\t}\n+\n+\tret = 0;\n+\n+done:\n+\treturn ret;\n+}\n+\n int net_conf_showshare(int argc, const char **argv)\n {\n \tint ret = -1;\n@@ -1067,6 +1146,8 @@\n \t\t \"Import configuration from file in smb.conf format.\"},\n \t\t{\"listshares\", net_conf_listshares, \n \t\t \"List the registry shares.\"},\n+\t\t{\"drop\", net_conf_drop,\n+\t\t \"Delete the complete configuration from registry.\"},\n \t\t{\"showshare\", net_conf_showshare, \n \t\t \"Show the definition of a registry share.\"},\n \t\t{\"addshare\", net_conf_addshare, \n\n"}