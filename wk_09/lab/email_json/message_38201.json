{"category": "ham", "to_address": "samba-cvs@samba.org", "from_address": "abartlet@samba.org", "subject": "svn commit: samba r23191 - in branches/SAMBA_4_0/source/selftest: .", "body": "Author: abartlet\nDate: 2007-05-29 13:06:08 +0000 (Tue, 29 May 2007)\nNew Revision: 23191\n\nWebSVN: http://websvn.samba.org/cgi-bin/viewcvs.cgi?view=rev&root=samba&rev=23191\n\nLog:\nUse the new provision-backend script to setup Fedora DS for make test.\n\nOpenLDAP to follow once I get things working...\n\nAndrew Bartlett\n\nModified:\n   branches/SAMBA_4_0/source/selftest/Samba4.pm\n   branches/SAMBA_4_0/source/selftest/selftest.pl\n\n\nChangeset:\nModified: branches/SAMBA_4_0/source/selftest/Samba4.pm\n===================================================================\n--- branches/SAMBA_4_0/source/selftest/Samba4.pm\t2007-05-29 12:53:42 UTC (rev 23190)\n+++ branches/SAMBA_4_0/source/selftest/Samba4.pm\t2007-05-29 13:06:08 UTC (rev 23191)\n@@ -39,7 +39,7 @@\n \n \t# running slapd in the background means it stays in the same process group, so it can be\n \t# killed by timelimit\n-\tif ($self->{ldap} eq \"fedora\") {\n+\tif ($self->{ldap} eq \"fedora-ds\") {\n \t        system(\"$ENV{FEDORA_DS_PREFIX}/sbin/ns-slapd -D $env_vars->{FEDORA_DS_DIR} -d0 -i $env_vars->{FEDORA_DS_PIDFILE}> $env_vars->{LDAPDIR}/logs 2>&1 &\");\n \t} elsif ($self->{ldap} eq \"openldap\") {\n \t        openldap_start($env_vars->{SLAPD_CONF}, $uri, \"$env_vars->{LDAPDIR}/logs\");\n@@ -58,7 +58,7 @@\n sub slapd_stop($$)\n {\n \tmy ($self, $envvars) = @_;\n-\tif ($self->{ldap} eq \"fedora\") {\n+\tif ($self->{ldap} eq \"fedora-ds\") {\n \t\tsystem(\"$envvars->{LDAPDIR}/slapd-samba4/stop-slapd\");\n \t} elsif ($self->{ldap} eq \"openldap\") {\n \t\topen(IN, \"<$envvars->{OPENLDAP_PIDFILE}\") or \n@@ -177,54 +177,18 @@\n \");\n }\n \n-sub mk_fedora($$$$$$)\n+sub mk_fedora_ds($$$)\n {\n-\tmy ($self, $ldapdir, $basedn, $root, $password, $privatedir, $configuration) = @_;\n+\tmy ($self, $ldapdir, $configuration) = @_;\n \n-\tmkdir($ldapdir, 0777);\n-\n \tmy $fedora_ds_inf = \"$ldapdir/fedorads.inf\";\n-\tmy $fedora_ds_initial_ldif = \"$ldapdir/fedorads-initial.ldif\";\n+\tmy $fedora_ds_extra_ldif = \"$ldapdir/fedorads-partitions.ldif\";\n \n \t#Make the subdirectory be as fedora DS would expect\n \tmy $fedora_ds_dir = \"$ldapdir/slapd-samba4\";\n \n \tmy $pidfile = \"$fedora_ds_dir/logs/slapd-samba4.pid\";\n \n-\topen(CONF, \">$fedora_ds_inf\");\n-\tprint CONF \"\n-[General]\n-SuiteSpotUserID = $root\n-FullMachineName=   localhost\n-ServerRoot=   $ldapdir\n-\n-[slapd]\n-ldapifilepath=$ldapdir/ldapi\n-Suffix= $basedn\n-RootDN= cn=Manager,$basedn\n-RootDNPwd= $password\n-ServerIdentifier= samba4\n-#InstallLdifFile=$fedora_ds_initial_ldif\n-\n-inst_dir= $fedora_ds_dir\n-config_dir= $fedora_ds_dir\n-schema_dir= $fedora_ds_dir/schema\n-lock_dir= $fedora_ds_dir/lock\n-log_dir= $fedora_ds_dir/logs\n-run_dir= $fedora_ds_dir/logs\n-db_dir= $fedora_ds_dir/db\n-bak_dir= $fedora_ds_dir/bak\n-tmp_dir= $fedora_ds_dir/tmp\n-ldif_dir= $fedora_ds_dir/ldif\n-cert_dir= $fedora_ds_dir\n-\n-start_server= 0\n-install_full_schema= 0\n-\";\n-\tclose(CONF);\n-\n-\topen(LDIF, \">$fedora_ds_initial_ldif\");\n-\n my $dir = getcwd();\n chdir \"$ENV{FEDORA_DS_PREFIX}/bin\" || die;\n \tif (system(\"perl $ENV{FEDORA_DS_PREFIX}/bin/ds_newinst.pl $fedora_ds_inf >&2\") != 0) {\n@@ -233,40 +197,10 @@\n         }\n         chdir $dir || die;\n \n-\topen(LDIF, \">>$fedora_ds_dir/dse.ldif\");\n-\tprint LDIF \"dn: cn=\\\"cn=Configuration,$basedn\\\",cn=mapping tree,cn=config\n-objectclass: top\n-objectclass: extensibleObject\n-objectclass: nsMappingTree\n-nsslapd-state: backend\n-nsslapd-backend: configData\n-cn: cn=Configuration,$basedn\n+\tsystem(\"cat $fedora_ds_extra_ldif >> $fedora_ds_dir/dse.ldif\");\n \n-dn: cn=configData,cn=ldbm database,cn=plugins,cn=config\n-objectclass: extensibleObject\n-objectclass: nsBackendInstance\n-nsslapd-suffix: cn=Configuration,$basedn\n-cn: configData\n+\tsystem(\"$self->{bindir}/ad2oLschema $configuration -H $ldapdir/schema-tmp.ldb --option=convert:target=fedora-ds -I $self->{setupdir}/schema-map-fedora-ds-1.0 -O $fedora_ds_dir/schema/99_ad.ldif >&2\") == 0 or die(\"schema conversion for Fedora DS failed\");\n \n-dn: cn=\\\"cn=Schema,cn=Configuration,$basedn\\\",cn=mapping tree,cn=config\n-objectclass: top\n-objectclass: extensibleObject\n-objectclass: nsMappingTree\n-nsslapd-state: backend\n-nsslapd-backend: schemaData\n-cn: cn=Schema,cn=Configuration,$basedn\n-\n-dn: cn=schemaData,cn=ldbm database,cn=plugins,cn=config\n-objectclass: extensibleObject\n-objectclass: nsBackendInstance\n-nsslapd-suffix: cn=Schema,cn=Configuration,$basedn\n-cn: schemaData\n-\n-\";\n-\tclose(LDIF);\n-\n-\tsystem(\"$self->{bindir}/ad2oLschema $configuration -H $privatedir/sam.ldb --option=convert:target=fedora-ds -I $self->{setupdir}/schema-map-fedora-ds-1.0 -O $fedora_ds_dir/schema/99_ad.ldif >&2\") == 0 or die(\"schema conversion for Fedora DS failed\");\n-\n \treturn ($fedora_ds_dir, $pidfile);\n }\n \n@@ -425,8 +359,6 @@\n \tsystem(\"slapadd -b cn=Configuration,$basedn -f $slapd_conf -l $ldapdir/$dnsname-config.ldif >/dev/null\") == 0 or die(\"slapadd failed\");\n \tsystem(\"slapadd -b cn=Schema,cn=Configuration,$basedn -f $slapd_conf -l $ldapdir/$dnsname-schema.ldif >/dev/null\") == 0 or die(\"slapadd failed\");\n \n-    system(\"slaptest -u -f $slapd_conf >/dev/null\") == 0 or \n-\t\tdie (\"slaptest after database load failed\");\n     \n \t$ENV{PATH} = $oldpath;\n \n@@ -626,10 +558,11 @@\n \n \tif (defined($self->{ldap})) {\n \n+                system(\"$self->{bindir}/smbscript $self->{setupdir}/provision-backend $configuration --ldap-manager-pass=$password --root=$root --realm=$dnsname --host-name=$netbiosname --ldap-backend-type=$self->{ldap}>&2\") == 0 or die(\"backend provision failed\");\n \t        if ($self->{ldap} eq \"openldap\") {\n \t\t       ($ret->{SLAPD_CONF}, $ret->{OPENLDAP_PIDFILE}) = $self->mk_openldap($ldapdir, $basedn, $password, $privatedir, $dnsname, $configuration, join(' ', @provision_options)) or die(\"Unable to create openldap directories\");\n-\t        } elsif ($self->{ldap} eq \"fedora\") {\n-\t\t       ($ret->{FEDORA_DS_DIR}, $ret->{FEDORA_DS_PIDFILE}) = $self->mk_fedora($ldapdir, $basedn, $root, $password, $privatedir, $configuration) or die(\"Unable to create fedora ds directories\");\n+\t        } elsif ($self->{ldap} eq \"fedora-ds\") {\n+\t\t       ($ret->{FEDORA_DS_DIR}, $ret->{FEDORA_DS_PIDFILE}) = $self->mk_fedora_ds($ldapdir, $configuration) or die(\"Unable to create fedora ds directories\");\n \t\t       push (@provision_options, \"--ldap-module=nsuniqueid\");\n \t        }\n \n@@ -711,7 +644,7 @@\n \tmy ($self, $envvars) = @_;\n \tmy $provision_aci = \"\";\n \t\n-\tif ($self->{ldap} eq \"fedora\") {\n+\tif ($self->{ldap} eq \"fedora-ds\") {\n \t\t#it is easier to base64 encode this than correctly escape it:\n \t\t# (targetattr = \"*\") (version 3.0;acl \"full access to all by all\";allow (all)(userdn = \"ldap:///anyone\");)\n \t\t$provision_aci = \"--aci=aci:: KHRhcmdldGF0dHIgPSAiKiIpICh2ZXJzaW9uIDMuMDthY2wgImZ1bGwgYWNjZXNzIHRvIGFsbCBieSBhbGwiO2FsbG93IChhbGwpKHVzZXJkbiA9ICJsZGFwOi8vL2FueW9uZSIpOykK\";\n\nModified: branches/SAMBA_4_0/source/selftest/selftest.pl\n===================================================================\n--- branches/SAMBA_4_0/source/selftest/selftest.pl\t2007-05-29 12:53:42 UTC (rev 23190)\n+++ branches/SAMBA_4_0/source/selftest/selftest.pl\t2007-05-29 13:06:08 UTC (rev 23191)\n@@ -422,7 +422,7 @@\n  --expected-failures=FILE   specify list of tests that is guaranteed to fail\n \n Samba4 Specific:\n- --ldap=openldap|fedora     back smbd onto specified ldap server\n+ --ldap=openldap|fedora-ds     back smbd onto specified ldap server\n \n Samba3 Specific:\n  --bindir=PATH              path to binaries\n@@ -477,7 +477,7 @@\n # Backwards compatibility:\n if (defined($ENV{TEST_LDAP}) and $ENV{TEST_LDAP} eq \"yes\") {\n \tif (defined($ENV{FEDORA_DS_PREFIX})) {\n-\t\t$ldap = \"fedora\";\n+\t\t$ldap = \"fedora-ds\";\n \t} else {\n \t\t$ldap = \"openldap\";\n \t}\n\n"}