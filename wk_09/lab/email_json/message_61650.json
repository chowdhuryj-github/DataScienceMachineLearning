{"category": "ham", "to_address": "samba-cvs@samba.org", "from_address": "idra@samba.org", "subject": "svn commit: samba r23691 - in branches: SAMBA_3_0/source/modules\n\tSAMBA_3_0_26/source/modules", "body": "Author: idra\nDate: 2007-07-03 23:34:01 +0000 (Tue, 03 Jul 2007)\nNew Revision: 23691\n\nWebSVN: http://websvn.samba.org/cgi-bin/viewcvs.cgi?view=rev&root=samba&rev=23691\n\nLog:\n\nfix for bug on touching files as described here:\nhttps://bugzilla.redhat.com/bugzilla/show_bug.cgi?id=243897\n\n\nModified:\n   branches/SAMBA_3_0/source/modules/vfs_recycle.c\n   branches/SAMBA_3_0_26/source/modules/vfs_recycle.c\n\n\nChangeset:\nModified: branches/SAMBA_3_0/source/modules/vfs_recycle.c\n===================================================================\n--- branches/SAMBA_3_0/source/modules/vfs_recycle.c\t2007-07-03 20:00:02 UTC (rev 23690)\n+++ branches/SAMBA_3_0/source/modules/vfs_recycle.c\t2007-07-03 23:34:01 UTC (rev 23691)\n@@ -386,20 +386,28 @@\n /**\n  * Touch access or modify date\n  **/\n-static void recycle_do_touch(vfs_handle_struct *handle, const char *fname, BOOL touch_mtime)\n+static void recycle_do_touch(vfs_handle_struct *handle, const char *fname,\n+\t\t\t     BOOL touch_mtime)\n {\n \tSMB_STRUCT_STAT st;\n \tstruct timespec ts[2];\n-\t\n+\tint status, err;\n+\n \tif (SMB_VFS_NEXT_STAT(handle, fname, &st) != 0) {\n-\t\tDEBUG(0,(\"recycle: stat for %s returned %s\\n\", fname, strerror(errno)));\n+\t\tDEBUG(0,(\"recycle: stat for %s returned %s\\n\",\n+\t\t\t fname, strerror(errno)));\n \t\treturn;\n \t}\n \tts[0] = timespec_current(); /* atime */\n \tts[1] = touch_mtime ? ts[0] : get_mtimespec(&st); /* mtime */\n \n-\tif (SMB_VFS_NEXT_NTIMES(handle, fname, ts) == -1 ) {\n-\t\tDEBUG(0, (\"recycle: touching %s failed, reason = %s\\n\", fname, strerror(errno)));\n+\tbecome_root();\n+\tstatus = SMB_VFS_NEXT_NTIMES(handle, fname, ts);\n+\terr = errno;\n+\tunbecome_root();\n+\tif (status == -1 ) {\n+\t\tDEBUG(0, (\"recycle: touching %s failed, reason = %s\\n\",\n+\t\t\t  fname, strerror(err)));\n \t}\n }\n \n\nModified: branches/SAMBA_3_0_26/source/modules/vfs_recycle.c\n===================================================================\n--- branches/SAMBA_3_0_26/source/modules/vfs_recycle.c\t2007-07-03 20:00:02 UTC (rev 23690)\n+++ branches/SAMBA_3_0_26/source/modules/vfs_recycle.c\t2007-07-03 23:34:01 UTC (rev 23691)\n@@ -386,20 +386,28 @@\n /**\n  * Touch access or modify date\n  **/\n-static void recycle_do_touch(vfs_handle_struct *handle, const char *fname, BOOL touch_mtime)\n+static void recycle_do_touch(vfs_handle_struct *handle, const char *fname,\n+\t\t\t     BOOL touch_mtime)\n {\n \tSMB_STRUCT_STAT st;\n \tstruct timespec ts[2];\n-\t\n+\tint status, err;\n+\n \tif (SMB_VFS_NEXT_STAT(handle, fname, &st) != 0) {\n-\t\tDEBUG(0,(\"recycle: stat for %s returned %s\\n\", fname, strerror(errno)));\n+\t\tDEBUG(0,(\"recycle: stat for %s returned %s\\n\",\n+\t\t\t fname, strerror(errno)));\n \t\treturn;\n \t}\n \tts[0] = timespec_current(); /* atime */\n \tts[1] = touch_mtime ? ts[0] : get_mtimespec(&st); /* mtime */\n \n-\tif (SMB_VFS_NEXT_NTIMES(handle, fname, ts) == -1 ) {\n-\t\tDEBUG(0, (\"recycle: touching %s failed, reason = %s\\n\", fname, strerror(errno)));\n+\tbecome_root();\n+\tstatus = SMB_VFS_NEXT_NTIMES(handle, fname, ts);\n+\terr = errno;\n+\tunbecome_root();\n+\tif (status == -1 ) {\n+\t\tDEBUG(0, (\"recycle: touching %s failed, reason = %s\\n\",\n+\t\t\t  fname, strerror(err)));\n \t}\n }\n \n\n"}