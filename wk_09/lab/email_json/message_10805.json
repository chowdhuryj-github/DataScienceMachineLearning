{"category": "ham", "to_address": "vlendec@sernet.de", "from_address": "Peter Somogyi <psomogyi@gamax.hu>", "subject": "ctdb debug vasprintf memory overwrite in ib", "body": "Hi Volker,\n\nAccidentally I've run into a memory overwrite problem with your debug code \n(ctdb/lib/util/debug.c/do_debug).\n\n# gdb bin/ibwrapper_test #-i 1 -d 10.0.0.2:8001 -t 0 -n 1000\nGNU gdb 6.4\nCopyright 2005 Free Software Foundation, Inc.\nGDB is free software, covered by the GNU General Public License, and you are\nwelcome to change it and/or distribute copies of it under certain conditions.\nType \"show copying\" to see the conditions.\nThere is absolutely no warranty for GDB.  Type \"show warranty\" for details.\nThis GDB was configured as \"i586-suse-linux\"...Using host libthread_db \nlibrary \"/lib/libthread_db.so.1\".\n\n(gdb) break ibwrapper.c:559\nBreakpoint 1 at 0x805697b: file ib/ibwrapper.c, line 559.\n(gdb) run -i 1 -d 10.0.0.2:8001 -t 0 -n 1000\nStarting program: /root/psomogyi/ctdb/bin/ibwrapper_test -i 1 -d \n10.0.0.2:8001 -t 0 -n 1000\n[Thread debugging using libthread_db enabled]\n[New Thread -1209997120 (LWP 9731)]\n[Switching to Thread -1209997120 (LWP 9731)]\n\nBreakpoint 1, ibw_event_handler_cm (ev=0x80691c8, fde=0x8069868, flags=1, \nprivate_data=0x8069258) at ib/ibwrapper.c:559\n559             if (event!=NULL && (rc=rdma_ack_cm_event(event))) {\n(gdb) print cma_id->context\n$1 = (void *) 0x806b788\n(gdb) next\n563             DEBUG(0, (\"cm event handler: %s\", ibw_lasterr));\n(gdb) print cma_id->context\n$2 = (void *) 0x806b788\n(gdb) next\n1177065484.603498 [9731]: cm event handler: RDMA_CM_EVENT_REJECTED, error 8\n565             if (cma_id!=pctx->cm_id) {\n(gdb) print cma_id->context\n$3 = (void *) 0x6e616820\n\nMore precisely, after the call vasprintf gets the memory overwritten (shows me \ngdb by stepping).\nWhen I change vasprintf usage to vsprintf/vsnprintf with fixed buffer then it \nruns fine. Also runs fine when I comment its line.\n\nBTW. man says vasprintf is a GNU extension, not in POSIX or C. It tells \nsomething also about #define _GNU_SOURCE.\n\nI'm still not aware of *why* this overwrite happens, but on my system somehow \nit occures. (vasprintf returns 50 which is ok, so we don't have failure.)\n\n(glibc version is 2.4-31.2 on my SLES10)\n\nPicking another vasprintf implementation like this solves my problem:\n\nint vasprintf(char **ptr, const char *format, va_list ap)\n{\n    int ret;\n    va_list tmp_ap;\n\n    va_copy(tmp_ap, ap);\n    ret = vsnprintf(NULL, 0, format, tmp_ap);\n    if (ret <= 0) return ret;\n\n    (*ptr) = (char *)malloc(ret+1);\n    if (!*ptr) return -1;\n    ret = vsnprintf(*ptr, ret+1, format, ap);\n\n    return ret;\n}\n(code is from jerry@samba.org \nhttp://lists.samba.org/archive/samba-technical/2001-October/016595.html)\n\nDo you agree changing do_debug this way?\n\n-- \nPeter Somogyi\nGamax Kft\nBartok Bela ut 15/D\nH-1114, Budapest, Hungary\ne-mail: psomogyi@gamax.hu\n\n"}