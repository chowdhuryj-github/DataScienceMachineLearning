{"category": "ham", "to_address": "samba-cvs@samba.org", "from_address": "vlendec@samba.org", "subject": "svn commit: samba r23467 - in branches: SAMBA_3_0/source/smbd\n\tSAMBA_3_0_26/source/smbd", "body": "Author: vlendec\nDate: 2007-06-13 12:52:36 +0000 (Wed, 13 Jun 2007)\nNew Revision: 23467\n\nWebSVN: http://websvn.samba.org/cgi-bin/viewcvs.cgi?view=rev&root=samba&rev=23467\n\nLog:\nNext little simplification: In rename_internals it's a bit pointless to\nfirst ask for existence of a file when we do the open_file_ntcreate in\ncan_rename later on anyway. That also gets us the right error message in\ncase the file is not there automatically.\n\nModified:\n   branches/SAMBA_3_0/source/smbd/reply.c\n   branches/SAMBA_3_0_26/source/smbd/reply.c\n\n\nChangeset:\nModified: branches/SAMBA_3_0/source/smbd/reply.c\n===================================================================\n--- branches/SAMBA_3_0/source/smbd/reply.c\t2007-06-13 11:32:46 UTC (rev 23466)\n+++ branches/SAMBA_3_0/source/smbd/reply.c\t2007-06-13 12:52:36 UTC (rev 23467)\n@@ -4588,38 +4588,9 @@\n \t\t}\n \n \t\t/*\n-\t\t * The source object must exist.\n+\t\t * The source object must exist, and it may not have a\n+\t\t * conflicting share mode.\n \t\t */\n-\n-\t\tif (!vfs_object_exist(conn, directory, &sbuf1)) {\n-\t\t\tDEBUG(3, (\"rename_internals: source doesn't exist \"\n-\t\t\t\t  \"doing rename %s -> %s\\n\",\n-\t\t\t\tdirectory,newname));\n-\n-\t\t\tif (errno == ENOTDIR || errno == EISDIR\n-\t\t\t    || errno == ENOENT) {\n-\t\t\t\t/*\n-\t\t\t\t * Must return different errors depending on\n-\t\t\t\t * whether the parent directory existed or\n-\t\t\t\t * not.\n-\t\t\t\t */\n-\n-\t\t\t\tp = strrchr_m(directory, '/');\n-\t\t\t\tif (!p)\n-\t\t\t\t\treturn NT_STATUS_OBJECT_NAME_NOT_FOUND;\n-\t\t\t\t*p = '\\0';\n-\t\t\t\tif (vfs_object_exist(conn, directory, NULL))\n-\t\t\t\t\treturn NT_STATUS_OBJECT_NAME_NOT_FOUND;\n-\t\t\t\treturn NT_STATUS_OBJECT_PATH_NOT_FOUND;\n-\t\t\t}\n-\t\t\tstatus = map_nt_error_from_unix(errno);\n-\t\t\tDEBUG(3, (\"rename_internals: Error %s rename %s -> \"\n-\t\t\t\t  \"%s\\n\", nt_errstr(status), directory,\n-\t\t\t\t  newname));\n-\n-\t\t\treturn status;\n-\t\t}\n-\n \t\tstatus = can_rename(conn,directory,attrs,&sbuf1,False);\n \n \t\tif (!NT_STATUS_IS_OK(status)) {\n@@ -4740,15 +4711,19 @@\n \t\t\treturn status;\n \t\t}\n \n-\t\tif (!vfs_object_exist(conn, fname, &sbuf1)) {\n-\t\t\tstatus = NT_STATUS_OBJECT_NAME_NOT_FOUND;\n-\t\t\tDEBUG(6, (\"rename %s failed. Error %s\\n\",\n-\t\t\t\t  fname, nt_errstr(status)));\n-\t\t\tcontinue;\n-\t\t}\n+\t\t/*\n+\t\t * can_rename does an open_file_ntcreate which needs a valid\n+\t\t * stat in case the file exists\n+\t\t */\n+\n+\t\tZERO_STRUCT(sbuf1);\n+\t\tSMB_VFS_STAT(conn, fname, &sbuf1);\n+\n \t\tstatus = can_rename(conn,fname,attrs,&sbuf1,False);\n+\n \t\tif (!NT_STATUS_IS_OK(status)) {\n-\t\t\tDEBUG(6, (\"rename %s refused\\n\", fname));\n+\t\t\tDEBUG(6, (\"rename %s refused: %s\\n\", fname,\n+\t\t\t\t  nt_errstr(status)));\n \t\t\tcontinue;\n \t\t}\n \t\tpstrcpy(destname,newname);\n\nModified: branches/SAMBA_3_0_26/source/smbd/reply.c\n===================================================================\n--- branches/SAMBA_3_0_26/source/smbd/reply.c\t2007-06-13 11:32:46 UTC (rev 23466)\n+++ branches/SAMBA_3_0_26/source/smbd/reply.c\t2007-06-13 12:52:36 UTC (rev 23467)\n@@ -4586,38 +4586,9 @@\n \t\t}\n \n \t\t/*\n-\t\t * The source object must exist.\n+\t\t * The source object must exist, and it may not have a\n+\t\t * conflicting share mode.\n \t\t */\n-\n-\t\tif (!vfs_object_exist(conn, directory, &sbuf1)) {\n-\t\t\tDEBUG(3, (\"rename_internals: source doesn't exist \"\n-\t\t\t\t  \"doing rename %s -> %s\\n\",\n-\t\t\t\tdirectory,newname));\n-\n-\t\t\tif (errno == ENOTDIR || errno == EISDIR\n-\t\t\t    || errno == ENOENT) {\n-\t\t\t\t/*\n-\t\t\t\t * Must return different errors depending on\n-\t\t\t\t * whether the parent directory existed or\n-\t\t\t\t * not.\n-\t\t\t\t */\n-\n-\t\t\t\tp = strrchr_m(directory, '/');\n-\t\t\t\tif (!p)\n-\t\t\t\t\treturn NT_STATUS_OBJECT_NAME_NOT_FOUND;\n-\t\t\t\t*p = '\\0';\n-\t\t\t\tif (vfs_object_exist(conn, directory, NULL))\n-\t\t\t\t\treturn NT_STATUS_OBJECT_NAME_NOT_FOUND;\n-\t\t\t\treturn NT_STATUS_OBJECT_PATH_NOT_FOUND;\n-\t\t\t}\n-\t\t\tstatus = map_nt_error_from_unix(errno);\n-\t\t\tDEBUG(3, (\"rename_internals: Error %s rename %s -> \"\n-\t\t\t\t  \"%s\\n\", nt_errstr(status), directory,\n-\t\t\t\t  newname));\n-\n-\t\t\treturn status;\n-\t\t}\n-\n \t\tstatus = can_rename(conn,directory,attrs,&sbuf1,False);\n \n \t\tif (!NT_STATUS_IS_OK(status)) {\n@@ -4738,15 +4709,19 @@\n \t\t\treturn status;\n \t\t}\n \n-\t\tif (!vfs_object_exist(conn, fname, &sbuf1)) {\n-\t\t\tstatus = NT_STATUS_OBJECT_NAME_NOT_FOUND;\n-\t\t\tDEBUG(6, (\"rename %s failed. Error %s\\n\",\n-\t\t\t\t  fname, nt_errstr(status)));\n-\t\t\tcontinue;\n-\t\t}\n+\t\t/*\n+\t\t * can_rename does an open_file_ntcreate which needs a valid\n+\t\t * stat in case the file exists\n+\t\t */\n+\n+\t\tZERO_STRUCT(sbuf1);\n+\t\tSMB_VFS_STAT(conn, fname, &sbuf1);\n+\n \t\tstatus = can_rename(conn,fname,attrs,&sbuf1,False);\n+\n \t\tif (!NT_STATUS_IS_OK(status)) {\n-\t\t\tDEBUG(6, (\"rename %s refused\\n\", fname));\n+\t\t\tDEBUG(6, (\"rename %s refused: %s\\n\", fname,\n+\t\t\t\t  nt_errstr(status)));\n \t\t\tcontinue;\n \t\t}\n \t\tpstrcpy(destname,newname);\n\n"}