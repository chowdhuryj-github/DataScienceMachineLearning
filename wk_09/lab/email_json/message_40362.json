{"category": "ham", "to_address": "samba-cvs@samba.org", "from_address": "tridge@samba.org", "subject": "Rev 418: use a subdirectory for ctdb state files in\n\thttp://samba.org/~tridge/ctdb", "body": "------------------------------------------------------------\nrevno: 418\nrevision-id: tridge@samba.org-20070601091658-s52qj3zi6l24os2y\nparent: tridge@samba.org-20070601090541-bzd2s1tp0tpiz3hn\ncommitter: Andrew Tridgell \nbranch nick: tridge\ntimestamp: Fri 2007-06-01 19:16:58 +1000\nmessage:\n  use a subdirectory for ctdb state files\nmodified:\n  tools/events                   events-20070529030121-04fjh63cxfh8v1pj-1\n  tools/statd-callout            statdcallout-20070531010857-6sdlz455vusye5y5-1\n=== modified file 'tools/events'\n--- a/tools/events\t2007-06-01 05:23:16 +0000\n+++ b/tools/events\t2007-06-01 09:16:58 +0000\n@@ -8,6 +8,8 @@\n \n case $cmd in \n      startup)\n+\t/bin/rm -rf /etc/ctdb/state\n+\t/bin/mkdir -p /etc/ctdb/state\n \t# wait for local services to come up.\n \t[ -z \"$CTDB_WAIT_TCP_PORTS\" ] || {\n \t  all_ok=0\n@@ -58,15 +60,15 @@\n \t\t echo \"`/bin/date` Failed to add $ip/$maskbits on dev $iface\"\n \t\t exit 1\n \t}\n-\techo $ip >> /etc/ctdb/taken_ips\n-\techo $ip >> /etc/ctdb/changed_ips\n+\techo $ip >> /etc/ctdb/state/taken_ips\n+\techo $ip >> /etc/ctdb/state/changed_ips\n \n-\t# if we have a local arp entry for this IP then remove it\n-\t/sbin/arp -d $ip 2> /dev/null\n+\t# flush our route cache\n+\techo 1 > /proc/sys/net/ipv4/route/flush\n \n \t# having a list of what IPs we have allows statd to do the right \n \t# thing via /etc/ctdb/statd-callout\n-\t/bin/touch /etc/ctdb/ip.$ip\n+\t/bin/touch /etc/ctdb/state/ip.$ip\n \texit 0\n \t;;\n \n@@ -82,30 +84,32 @@\n \t\t echo \"`/bin/date` Failed to del $ip on dev $iface\"\n \t\t exit 1\n \t}\n-\t# if we have a local arp entry for this IP then remove it\n-\t/sbin/arp -d $ip 2> /dev/null\n-\techo $ip >> /etc/ctdb/released_ips\n-\techo $ip >> /etc/ctdb/changed_ips\n-\t/bin/rm -f /etc/ctdb/ip.$ip\n+\n+\t# flush our route cache\n+\techo 1 > /proc/sys/net/ipv4/route/flush\n+\n+\techo $ip >> /etc/ctdb/state/released_ips\n+\techo $ip >> /etc/ctdb/state/changed_ips\n+\t/bin/rm -f /etc/ctdb/state/ip.$ip\n \texit 0\n \t;;\n \n      recovered)\n \t# if we have taken or released any ips we must send out\n \t# statd notifications to recover lost nfs locks\n-\t[ -x /etc/ctdb/statd-callout ] && [ -f /etc/ctdb/changed_ips ] && {\n+\t[ -x /etc/ctdb/statd-callout ] && [ -f /etc/ctdb/state/changed_ips ] && {\n \t\t/etc/ctdb/statd-callout notify &\n \t} >/dev/null 2>&1\n \n         # restart NFS to ensure that all TCP connections to the released ip\n \t# are closed\n-\t[ -f /etc/ctdb/released_ips ] && {\n+\t[ -f /etc/ctdb/state/released_ips ] && {\n \t\t( /sbin/service nfs status > /dev/null 2>&1 && \n                       /sbin/service nfs restart > /dev/null 2>&1 ) &\n \t} > /dev/null 2>&1\n-\t/bin/rm -f /etc/ctdb/changed_ips\n-\t/bin/rm -f /etc/ctdb/released_ips\n-\t/bin/rm -f /etc/ctdb/taken_ips\n+\t/bin/rm -f /etc/ctdb/state/changed_ips\n+\t/bin/rm -f /etc/ctdb/state/released_ips\n+\t/bin/rm -f /etc/ctdb/state/taken_ips\n \texit 0\n \t;;\n \n\n=== modified file 'tools/statd-callout'\n--- a/tools/statd-callout\t2007-06-01 03:14:05 +0000\n+++ b/tools/statd-callout\t2007-06-01 09:16:58 +0000\n@@ -8,7 +8,7 @@\n \n case \"$1\" in\n   add-client)\n-        for f in `/bin/ls /etc/ctdb/ip.*`; do\n+        for f in `/bin/ls /etc/ctdb/state/ip.*`; do\n \t    fname=`/bin/basename $f`\n \t    ip=`echo $fname | cut -d. -f2-`\n \t    [ -d $STATD_SHARED_DIRECTORY/$ip ] || /bin/mkdir $STATD_SHARED_DIRECTORY/$ip\n@@ -16,7 +16,7 @@\n \tdone\n \t;;\n   del-client)\n-        for f in `/bin/ls /etc/ctdb/ip.*`; do\n+        for f in `/bin/ls /etc/ctdb/state/ip.*`; do\n \t    fname=`/bin/basename $f`\n \t    ip=`echo $fname | cut -d. -f2-`\n \t    /bin/rm -f $STATD_SHARED_DIRECTORY/$ip/$2\n@@ -27,7 +27,7 @@\n \t/sbin/service nfslock stop > /dev/null 2>&1 \n \t/sbin/service nfslock start > /dev/null 2>&1 \n \t# send out notifications to any additional ips we now serve\n-        for f in `/bin/ls /etc/ctdb/ip.*`; do\n+        for f in `/bin/ls /etc/ctdb/state/ip.*`; do\n \t    fname=`/bin/basename $f`\n \t    ip=`echo $fname | cut -d. -f2-`\n \t    [ -d $STATD_SHARED_DIRECTORY/$ip ] && {\n\n"}