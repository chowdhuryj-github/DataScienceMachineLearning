{"category": "ham", "to_address": "samba-cvs@samba.org", "from_address": "tridge@samba.org", "subject": "Rev 95: merge from volker in http://samba.org/~tridge/ctdb", "body": "------------------------------------------------------------\nrevno: 95\nrevision-id: tridge@samba.org-20070411121724-5e763a4a0a3fc6ac\nparent: tridge@samba.org-20070411121107-b9d7c18f685f344f\nparent: vl@samba.org-20070411115758-oua7f39sry0tw1z9\ncommitter: Andrew Tridgell \nbranch nick: tridge\ntimestamp: Wed 2007-04-11 22:17:24 +1000\nmessage:\n  merge from volker\nmodified:\n  common/ctdb_call.c             ctdb_call.c-20061128065342-to93h6eejj5kon81-1\n  common/ctdb_daemon.c           ctdb_daemon.c-20070409200331-3el1kqgdb9m4ib0g-1\n  direct/ctdbd.c                 ctdbd.c-20070411085044-dqmhr6mfeexnyt4m-1\n    ------------------------------------------------------------\n    merged: vl@samba.org-20070411115758-oua7f39sry0tw1z9\n    parent: ronniesahlberg@gmail.com-20070411103224-hvqzewjcfhpxcgbg\n    parent: vl@samba.org-20070411111736-rllo7o2u3tnzq0pg\n    committer: Volker Lendecke \n    branch nick: ctdb-vl\n    timestamp: Wed 2007-04-11 13:57:58 +0200\n    message:\n      merge\n    ------------------------------------------------------------\n    merged: vl@samba.org-20070411111736-rllo7o2u3tnzq0pg\n    parent: vl@samba.org-20070411104910-78d551d2qsfxpytz\n    committer: Volker Lendecke \n    branch nick: ctdb\n    timestamp: Wed 2007-04-11 13:17:36 +0200\n    message:\n      Handle a client that exited correctly: We need to ignore SIGPIPE and when the\n      read returns 0 bytes this means the client has exited. Close the connection\n      then.\n    ------------------------------------------------------------\n    merged: vl@samba.org-20070411104910-78d551d2qsfxpytz\n    parent: ronniesahlberg@gmail.com-20070411103224-hvqzewjcfhpxcgbg\n    committer: Volker Lendecke \n    branch nick: ctdb\n    timestamp: Wed 2007-04-11 12:49:10 +0200\n    message:\n      Fix uninitialized variable warnings\n=== modified file 'common/ctdb_call.c'\n--- a/common/ctdb_call.c\t2007-04-11 01:58:28 +0000\n+++ b/common/ctdb_call.c\t2007-04-11 10:49:10 +0000\n@@ -248,7 +248,9 @@\n \t\t}\n \t}\n \tif (!ctdb_db) {\n-\t\tctdb_send_error(ctdb, hdr, ret, \"Unknown database in request. db_id==0x%08x\",c->db_id);\n+\t\tctdb_send_error(ctdb, hdr, -1,\n+\t\t\t\t\"Unknown database in request. db_id==0x%08x\",\n+\t\t\t\tc->db_id);\n \t\treturn;\n \t}\n \t\n@@ -315,7 +317,9 @@\n \t\t}\n \t}\n \tif (!ctdb_db) {\n-\t\tctdb_send_error(ctdb, hdr, ret, \"Unknown database in request. db_id==0x%08x\",c->db_id);\n+\t\tctdb_send_error(ctdb, hdr, -1,\n+\t\t\t\t\"Unknown database in request. db_id==0x%08x\",\n+\t\t\t\tc->db_id);\n \t\treturn;\n \t}\n \n\n=== modified file 'common/ctdb_daemon.c'\n--- a/common/ctdb_daemon.c\t2007-04-11 09:04:09 +0000\n+++ b/common/ctdb_daemon.c\t2007-04-11 11:17:36 +0000\n@@ -283,6 +283,11 @@\n \tstruct ctdb_client *client = talloc_get_type(args, struct ctdb_client);\n \tstruct ctdb_req_header *hdr;\n \n+\tif (cnt == 0) {\n+\t\ttalloc_free(client);\n+\t\treturn;\n+\t}\n+\n \tif (cnt < sizeof(*hdr)) {\n \t\tctdb_set_error(client->ctdb, \"Bad packet length %d\\n\", cnt);\n \t\treturn;\n\n=== modified file 'direct/ctdbd.c'\n--- a/direct/ctdbd.c\t2007-04-11 08:54:22 +0000\n+++ b/direct/ctdbd.c\t2007-04-11 11:17:36 +0000\n@@ -22,6 +22,19 @@\n #include \"lib/events/events.h\"\n #include \"system/filesys.h\"\n #include \"popt.h\"\n+#include \n+\n+static void block_signal(int signum)\n+{\n+\tstruct sigaction act;\n+\n+\tmemset(&act, 0, sizeof(act));\n+\n+\tact.sa_handler = SIG_IGN;\n+\tsigemptyset(&act.sa_mask);\n+\tsigaddset(&act.sa_mask, signum);\n+\tsigaction(signum, &act, NULL);\n+}\n \n \n /*\n@@ -75,6 +88,8 @@\n \t\texit(1);\n \t}\n \n+\tblock_signal(SIGPIPE);\n+\n \tev = event_context_init(NULL);\n \n \t/* initialise ctdb */\n\n"}