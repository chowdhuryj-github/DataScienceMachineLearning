{"category": "ham", "to_address": "samba-cvs@samba.org", "from_address": "tridge@samba.org", "subject": "Rev 335: fixed some memory leaks on the traverse code in\n\thttp://samba.org/~tridge/ctdb", "body": "------------------------------------------------------------\nrevno: 335\nrevision-id: tridge@samba.org-20070523100637-sr7fh7uhl7s143rk\nparent: tridge@samba.org-20070523072114-j47jv4v2y7a7td0n\ncommitter: Andrew Tridgell \nbranch nick: tridge\ntimestamp: Wed 2007-05-23 20:06:37 +1000\nmessage:\n  fixed some memory leaks on the traverse code\nmodified:\n  common/ctdb.c                  ctdb.c-20061127094323-t50f58d65iaao5of-2\n  common/ctdb_traverse.c         ctdb_traverse.c-20070503021550-ztfs5rwx8jfm8qqx-1\n  tools/ctdb_control.c           ctdb_control.c-20070426122705-9ehj1l5lu2gn9kuj-1\n=== modified file 'common/ctdb.c'\n--- a/common/ctdb.c\t2007-05-23 04:50:41 +0000\n+++ b/common/ctdb.c\t2007-05-23 10:06:37 +0000\n@@ -437,6 +437,7 @@\n {\n \tstruct queue_next *q = talloc_get_type(private_data, struct queue_next);\n \tctdb_input_pkt(q->ctdb, q->hdr);\n+\ttalloc_free(q);\n }\t\n \n /*\n\n=== modified file 'common/ctdb_traverse.c'\n--- a/common/ctdb_traverse.c\t2007-05-17 13:23:41 +0000\n+++ b/common/ctdb_traverse.c\t2007-05-23 10:06:37 +0000\n@@ -277,6 +277,7 @@\n \tstruct traverse_all_state *state = talloc_get_type(p, struct traverse_all_state);\n \tint ret;\n \tstruct ctdb_rec_data *d;\n+\tTDB_DATA cdata;\n \n \td = ctdb_marshall_record(state, state->reqid, key, data);\n \tif (d == NULL) {\n@@ -285,14 +286,19 @@\n \t\treturn;\n \t}\n \n-\tdata.dptr = (uint8_t *)d;\n-\tdata.dsize = d->length;\n+\tcdata.dptr = (uint8_t *)d;\n+\tcdata.dsize = d->length;\n \n \tret = ctdb_daemon_send_control(state->ctdb, state->srcnode, 0, CTDB_CONTROL_TRAVERSE_DATA,\n-\t\t\t\t       0, CTDB_CTRL_FLAG_NOREPLY, data, NULL, NULL);\n+\t\t\t\t       0, CTDB_CTRL_FLAG_NOREPLY, cdata, NULL, NULL);\n \tif (ret != 0) {\n \t\tDEBUG(0,(\"Failed to send traverse data\\n\"));\n \t}\n+\n+\tif (key.dsize == 0 && data.dsize == 0) {\n+\t\t/* we're done */\n+\t\ttalloc_free(state);\n+\t}\n }\n \n /*\n@@ -397,6 +403,7 @@\n {\n \tstruct traverse_start_state *state;\n \tstruct ctdb_rec_data *d;\n+\tTDB_DATA cdata;\n \n \tstate = talloc_get_type(p, struct traverse_start_state);\n \n@@ -405,10 +412,10 @@\n \t\treturn;\n \t}\n \n-\tdata.dptr = (uint8_t *)d;\n-\tdata.dsize = d->length;\n+\tcdata.dptr = (uint8_t *)d;\n+\tcdata.dsize = d->length;\n \n-\tctdb_dispatch_message(state->ctdb, state->srvid, data);\n+\tctdb_dispatch_message(state->ctdb, state->srvid, cdata);\n \tif (key.dsize == 0 && data.dsize == 0) {\n \t\t/* end of traverse */\n \t\ttalloc_free(state);\n\n=== modified file 'tools/ctdb_control.c'\n--- a/tools/ctdb_control.c\t2007-05-20 23:24:34 +0000\n+++ b/tools/ctdb_control.c\t2007-05-23 10:06:37 +0000\n@@ -59,6 +59,7 @@\n \t\t\"  setmonmode              set monitoring mode\\n\"\n \t\t\"  attach                     attach a database\\n\"\n \t\t\"  getpid                        get the pid of a ctdb daemon\\n\"\n+\t\t\"  dumpmemory                dump memory map to log\\n\"\n \t\t\"  shutdown                      shutdown a remote ctdb\\n\"\n \t\t\"  freeze                    freeze a node\\n\"\n \t\t\"  thaw                      thaw a node\\n\"\n\n"}