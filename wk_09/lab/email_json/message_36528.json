{"category": "ham", "to_address": "samba-cvs@samba.org", "from_address": "tridge@samba.org", "subject": "Rev 353: drop any partialialy send packets when we get a socket\n\twrite error in http://samba.org/~tridge/ctdb", "body": "------------------------------------------------------------\nrevno: 353\nrevision-id: tridge@samba.org-20070526064132-e3rizx7rz3bkj5ra\nparent: tridge@samba.org-20070526063541-ejidxmkfrpxmu0hz\ncommitter: Andrew Tridgell \nbranch nick: tridge\ntimestamp: Sat 2007-05-26 16:41:32 +1000\nmessage:\n  drop any partialialy send packets when we get a socket write error\nmodified:\n  common/ctdb_io.c               ctdb_io.c-20070409200335-dzfc7f3rra5rcf60-1\n=== modified file 'common/ctdb_io.c'\n--- a/common/ctdb_io.c\t2007-05-26 04:46:12 +0000\n+++ b/common/ctdb_io.c\t2007-05-26 06:41:32 +0000\n@@ -40,6 +40,7 @@\n \tstruct ctdb_queue_pkt *next, *prev;\n \tuint8_t *data;\n \tuint32_t length;\n+\tuint32_t full_length;\n };\n \n struct ctdb_queue {\n@@ -175,6 +176,11 @@\n \t\t}\n \n \t\tif (n == -1 && errno != EAGAIN && errno != EWOULDBLOCK) {\n+\t\t\tif (pkt->length != pkt->full_length) {\n+\t\t\t\t/* partial packet sent - we have to drop it */\n+\t\t\t\tDLIST_REMOVE(queue->out_queue, pkt);\n+\t\t\t\ttalloc_free(pkt);\n+\t\t\t}\n \t\t\ttalloc_free(queue->fde);\n \t\t\tqueue->fde = NULL;\n \t\t\tqueue->fd = -1;\n@@ -262,6 +268,7 @@\n \tCTDB_NO_MEMORY(queue->ctdb, pkt->data);\n \n \tpkt->length = length2;\n+\tpkt->full_length = length2;\n \n \tif (queue->out_queue == NULL && queue->fd != -1) {\n \t\tEVENT_FD_WRITEABLE(queue->fde);\n\n"}