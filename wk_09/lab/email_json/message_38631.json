{"category": "ham", "to_address": "samba-cvs@samba.org", "from_address": "abartlet@samba.org", "subject": "svn commit: samba r23235 - in branches/SAMBA_4_0/source: selftest\n\tsetup", "body": "Author: abartlet\nDate: 2007-05-30 01:09:18 +0000 (Wed, 30 May 2007)\nNew Revision: 23235\n\nWebSVN: http://websvn.samba.org/cgi-bin/viewcvs.cgi?view=rev&root=samba&rev=23235\n\nLog:\nDon't do a seperate LDAP provision step.  Instead, everything we need\n(including the config files) is created by provision-backend.\n\nAndrew Bartlett\n\nModified:\n   branches/SAMBA_4_0/source/selftest/Samba4.pm\n   branches/SAMBA_4_0/source/setup/DB_CONFIG\n\n\nChangeset:\nModified: branches/SAMBA_4_0/source/selftest/Samba4.pm\n===================================================================\n--- branches/SAMBA_4_0/source/selftest/Samba4.pm\t2007-05-30 00:40:31 UTC (rev 23234)\n+++ branches/SAMBA_4_0/source/selftest/Samba4.pm\t2007-05-30 01:09:18 UTC (rev 23235)\n@@ -204,137 +204,17 @@\n \treturn ($fedora_ds_dir, $pidfile);\n }\n \n-sub write_openldap_dbconfig($) {\n-    my ( $ldapdbdir ) = @_;\n-\topen(CONF, \">$ldapdbdir/DB_CONFIG\");\n-\tprint CONF \"\n-#\n-\t# Set the database in memory cache size.\n-\t#\n-\tset_cachesize   0       524288        0\n-\t\n-\t\n-\t#\n-\t# Set database flags (this is a test environment, we don't need to fsync()).\n-\t#\t\t\n-\tset_flags       DB_TXN_NOSYNC\n-\t\n-\t#\n-\t# Set log values.\n-\t#\n-\tset_lg_regionmax        104857\n-\tset_lg_max              1048576\n-\tset_lg_bsize            209715\n-\tset_lg_dir              $ldapdbdir/bdb-logs\n-\t\n-\t\n-\t#\n-\t# Set temporary file creation directory.\n-\t#\t\t\t\n-\tset_tmp_dir             $ldapdbdir/tmp\n-\t\";\n-\tclose(CONF);\n-\n-\n-}\n-\n-sub mk_openldap($$$$$$$$)\n+sub mk_openldap($$$$$)\n {\n-\tmy ($self, $ldapdir, $basedn, $password, $privatedir, $dnsname, $configuration, $provision_options) = @_;\n+\tmy ($self, $ldapdir, $configuration, $basedn, $dnsname, $password) = @_;\n \n \tmy $slapd_conf = \"$ldapdir/slapd.conf\";\n \tmy $pidfile = \"$ldapdir/slapd.pid\";\n \tmy $modconf = \"$ldapdir/modules.conf\";\n \n-\tmkdir($_, 0777) foreach ($ldapdir, \"$ldapdir/db\", \"$ldapdir/db/user\", \"$ldapdir/db/config\", \"$ldapdir/db/schema\", \"$ldapdir/db/bdb-logs\", \n-\t\t\"$ldapdir/db/tmp\");\n+\t#This uses the backend provision we just did, to read out the schema\n+\tsystem(\"$self->{bindir}/ad2oLschema $configuration --option=convert:target=openldap -H $ldapdir/schema-tmp.ldb -I $self->{setupdir}/schema-map-openldap-2.3 -O $ldapdir/backend-schema.schema >&2\") == 0 or die(\"schema conversion for OpenLDAP failed\");\n \n-\topen(CONF, \">$slapd_conf\");\n-\tprint CONF \"\n-loglevel 0\n-\n-include $ldapdir/ad.schema\n-\n-pidfile\t\t$pidfile\n-argsfile\t$ldapdir/slapd.args\n-sasl-realm $dnsname\n-access to * by * write\n-\n-allow update_anon\n-\n-authz-regexp\n-          uid=([^,]*),cn=$dnsname,cn=digest-md5,cn=auth\n-          ldap:///$basedn??sub?(samAccountName=\\$1)\n-\n-authz-regexp\n-          uid=([^,]*),cn=([^,]*),cn=digest-md5,cn=auth\n-          ldap:///$basedn??sub?(samAccountName=\\$1)\n-\n-include $modconf\n-\n-defaultsearchbase \\\"$basedn\\\"\n-\n-backend\t\tbdb\n-database        bdb\n-suffix\t\t\\\"cn=Schema,cn=Configuration,$basedn\\\"\n-directory\t$ldapdir/db/schema\n-index           objectClass eq\n-index           samAccountName eq\n-index name eq\n-index objectCategory eq\n-index lDAPDisplayName eq\n-index subClassOf eq\n-\n-database        bdb\n-suffix\t\t\\\"cn=Configuration,$basedn\\\"\n-directory\t$ldapdir/db/config\n-index           objectClass eq\n-index           samAccountName eq\n-index name eq\n-index objectSid eq\n-index objectCategory eq\n-index nCName eq pres\n-index subClassOf eq\n-index dnsRoot eq\n-index nETBIOSName eq pres\n-\n-database        bdb\n-suffix\t\t\\\"$basedn\\\"\n-rootdn          \\\"cn=Manager,$basedn\\\"\n-rootpw          $password\n-directory\t$ldapdir/db/user\n-index           objectClass eq\n-index           samAccountName eq\n-index name eq\n-index objectSid eq\n-index objectCategory eq\n-index member eq\n-index uidNumber eq\n-index gidNumber eq\n-index unixName eq\n-index privilege eq\n-index nCName eq pres\n-index lDAPDisplayName eq\n-index subClassOf eq\n-index dnsRoot eq\n-index nETBIOSName eq pres\n-\n-#syncprov is stable in OpenLDAP 2.3, and available in 2.2.  \n-#We only need this for the contextCSN attribute anyway....\n-overlay syncprov\n-syncprov-checkpoint 100 10\n-syncprov-sessionlog 100\n-\";\n-\n-\tclose(CONF);\n-\t\n-\twrite_openldap_dbconfig(\"$ldapdir/db/user\");\n-\twrite_openldap_dbconfig(\"$ldapdir/db/config\");\n-\twrite_openldap_dbconfig(\"$ldapdir/db/schema\");\n-\n-\t#This uses the provision-backend we just did, to read out the schema\n-\tsystem(\"$self->{bindir}/ad2oLschema $configuration -H $ldapdir/schema-tmp.ldb -I $self->{setupdir}/schema-map-openldap-2.3 -O $ldapdir/ad.schema >&2\") == 0 or die(\"schema conversion for OpenLDAP failed\");\n-\n \tmy $oldpath = $ENV{PATH};\n \t$ENV{PATH} = \"/usr/local/sbin:/usr/sbin:/sbin:$ENV{PATH}\";\n \n@@ -514,22 +394,21 @@\n \n \t(system(\"($self->{bindir}/testparm $configuration -v --suppress-prompt --parameter-name=\\\"netbios name\\\" --section-name=global 2> /dev/null | grep -i \\\"^$netbiosname\\\" ) >/dev/null 2>&1\") == 0) or die(\"Failed to create a valid smb.conf configuration!\");\n \n-\tmy @provision_options = ($configuration);\n+my @provision_options = (\"$self->{bindir}/smbscript\", \"$self->{setupdir}/provision\");\n+\tpush (@provision_options, split(' ', $configuration));\n \tpush (@provision_options, \"--host-name=$netbiosname\");\n \tpush (@provision_options, \"--host-ip=$ifaceipv4\");\n \tpush (@provision_options, \"--quiet\");\n-\tpush (@provision_options, \"--domain $localdomain\");\n-\tpush (@provision_options, \"--realm $localrealm\");\n-\tpush (@provision_options, \"--adminpass $password\");\n-\tpush (@provision_options, \"--krbtgtpass krbtgt$password\");\n-\tpush (@provision_options, \"--machinepass machine$password\");\n+\tpush (@provision_options, \"--domain=$localdomain\");\n+\tpush (@provision_options, \"--realm=$localrealm\");\n+\tpush (@provision_options, \"--adminpass=$password\");\n+\tpush (@provision_options, \"--krbtgtpass=krbtgt$password\");\n+\tpush (@provision_options, \"--machinepass=machine$password\");\n \tpush (@provision_options, \"--root=$root\");\n \tpush (@provision_options, \"--simple-bind-dn=cn=Manager,$basedn\");\n \tpush (@provision_options, \"--password=$password\");\n \tpush (@provision_options, \"--root=$root\");\n \n-\t(system(\"$self->{bindir}/smbscript $self->{setupdir}/provision \" .  join(' ', @provision_options) . \">&2\") == 0) or die(\"Unable to provision\");\n-\n \tmy $ldap_uri= \"$ldapdir/ldapi\";\n \t$ldap_uri =~ s|/|%2F|g;\n \t$ldap_uri = \"ldapi://$ldap_uri\";\n@@ -555,27 +434,28 @@\n \n \tif (defined($self->{ldap})) {\n \n-                system(\"$self->{bindir}/smbscript $self->{setupdir}/provision-backend $configuration --ldap-manager-pass=$password --root=$root --realm=$dnsname --host-name=$netbiosname --ldap-backend-type=$self->{ldap}>&2\") == 0 or die(\"backend provision failed\");\n+                push (@provision_options, \"--ldap-backend=$ldap_uri\");\n+\t        system(\"$self->{bindir}/smbscript $self->{setupdir}/provision-backend $configuration --ldap-manager-pass=$password --root=$root --realm=$dnsname --host-name=$netbiosname --ldap-backend-type=$self->{ldap}>&2\") == 0 or die(\"backend provision failed\");\n+\n \t        if ($self->{ldap} eq \"openldap\") {\n-\t\t       ($ret->{SLAPD_CONF}, $ret->{OPENLDAP_PIDFILE}) = $self->mk_openldap($ldapdir, $basedn, $password, $privatedir, $dnsname, $configuration, join(' ', @provision_options)) or die(\"Unable to create openldap directories\");\n+\t\t       ($ret->{SLAPD_CONF}, $ret->{OPENLDAP_PIDFILE}) = $self->mk_openldap($ldapdir, $configuration, $basedn, $dnsname, $password) or die(\"Unable to create openldap directories\");\n \t        } elsif ($self->{ldap} eq \"fedora-ds\") {\n \t\t       ($ret->{FEDORA_DS_DIR}, $ret->{FEDORA_DS_PIDFILE}) = $self->mk_fedora_ds($ldapdir, $configuration) or die(\"Unable to create fedora ds directories\");\n \t\t       push (@provision_options, \"--ldap-module=nsuniqueid\");\n-\t        }\n+\t\t       push (@provision_options, \"--aci=aci:: KHRhcmdldGF0dHIgPSAiKiIpICh2ZXJzaW9uIDMuMDthY2wgImZ1bGwgYWNjZXNzIHRvIGFsbCBieSBhbGwiO2FsbG93IChhbGwpKHVzZXJkbiA9ICJsZGFwOi8vL2FueW9uZSIpOykK\");\n+                 }\n \n \t\t$self->slapd_start($ret) or \n \t\t\tdie(\"couldn't start slapd\");\n-\t\t    \n-\t        $ret->{PROVISION_OPTIONS} = join(' ', @provision_options);\n+\t}\n \n-\t\tprint \"LDAP PROVISIONING...\";\n-\t\t$self->provision_ldap($ret);\n+\t(system(@provision_options) == 0) or die(\"Unable to provision\");\n \n+\tif (defined($self->{ldap})) {\n \t\t$self->slapd_stop($ret) or \n \t\t\tdie(\"couldn't stop slapd\");\n-\t} else {\n-\t        $ret->{PROVISION_OPTIONS} = join(' ', @provision_options);\n         }\n+\n \treturn $ret; \n }\n \n@@ -636,21 +516,6 @@\n \treturn $ret;\n }\n \n-sub provision_ldap($$)\n-{\n-\tmy ($self, $envvars) = @_;\n-\tmy $provision_aci = \"\";\n-\t\n-\tif ($self->{ldap} eq \"fedora-ds\") {\n-\t\t#it is easier to base64 encode this than correctly escape it:\n-\t\t# (targetattr = \"*\") (version 3.0;acl \"full access to all by all\";allow (all)(userdn = \"ldap:///anyone\");)\n-\t\t$provision_aci = \"--aci=aci:: KHRhcmdldGF0dHIgPSAiKiIpICh2ZXJzaW9uIDMuMDthY2wgImZ1bGwgYWNjZXNzIHRvIGFsbCBieSBhbGwiO2FsbG93IChhbGwpKHVzZXJkbiA9ICJsZGFwOi8vL2FueW9uZSIpOykK\";\n-\t}\n-\n-\tsystem(\"$self->{bindir}/smbscript $self->{setupdir}/provision $envvars->{PROVISION_OPTIONS} \\\"$provision_aci\\\" --ldap-backend=$envvars->{LDAP_URI}\") and\n-\t\tdie(\"LDAP PROVISIONING failed: $self->{bindir}/smbscript $self->{setupdir}/provision $envvars->{PROVISION_OPTIONS} \\\"$provision_aci\\\" --ldap-backend=$envvars->{LDAP_URI}\");\n-}\n-\n sub teardown_env($$)\n {\n \tmy ($self, $envvars) = @_;\n\nModified: branches/SAMBA_4_0/source/setup/DB_CONFIG\n===================================================================\n--- branches/SAMBA_4_0/source/setup/DB_CONFIG\t2007-05-30 00:40:31 UTC (rev 23234)\n+++ branches/SAMBA_4_0/source/setup/DB_CONFIG\t2007-05-30 01:09:18 UTC (rev 23235)\n@@ -1,3 +1,4 @@\n+#\n # Set the database in memory cache size.\n #\n set_cachesize   0       524288        0\n@@ -2,11 +3,5 @@\n \n-\n #\n-# Set database flags (this is a test environment, we don't need to fsync()).\n-#\t\t\n-set_flags       DB_TXN_NOSYNC\n-\n+# Set log values.\n #\n- Set log values.\n-#\n set_lg_regionmax        104857\n@@ -16,7 +11,6 @@\n set_lg_bsize            209715\n set_lg_dir              ${LDAPDBDIR}/bdb-logs\n \n-\n #\n # Set temporary file creation directory.\n #\t\t\t\n\n"}