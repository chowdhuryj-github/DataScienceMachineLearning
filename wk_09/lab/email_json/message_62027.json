{"category": "ham", "to_address": "samba-cvs@samba.org", "from_address": "abartlet@samba.org", "subject": "svn commit: samba r23703 - in branches/SAMBA_4_0/source:\n\tlib/ldb/modules scripting/libjs setup", "body": "Author: abartlet\nDate: 2007-07-04 11:06:32 +0000 (Wed, 04 Jul 2007)\nNew Revision: 23703\n\nWebSVN: http://websvn.samba.org/cgi-bin/viewcvs.cgi?view=rev&root=samba&rev=23703\n\nLog:\nStart to get Samba4 to again work with LDAP backends, after I turned\non metze's schema work.\n\nAndrew Bartlett\n\nModified:\n   branches/SAMBA_4_0/source/lib/ldb/modules/paged_searches.c\n   branches/SAMBA_4_0/source/scripting/libjs/provision.js\n   branches/SAMBA_4_0/source/setup/provision\n   branches/SAMBA_4_0/source/setup/provision-backend\n\n\nChangeset:\nModified: branches/SAMBA_4_0/source/lib/ldb/modules/paged_searches.c\n===================================================================\n--- branches/SAMBA_4_0/source/lib/ldb/modules/paged_searches.c\t2007-07-04 07:45:41 UTC (rev 23702)\n+++ branches/SAMBA_4_0/source/lib/ldb/modules/paged_searches.c\t2007-07-04 11:06:32 UTC (rev 23703)\n@@ -412,6 +412,7 @@\n \n \tdata = talloc(module, struct private_data);\n \tif (data == NULL) {\n+\t\tldb_set_errstring(module->ldb, \"Out of Memory\");\n \t\treturn LDB_ERR_OTHER;\n \t}\n \tmodule->private_data = data;\n@@ -424,7 +425,7 @@\n \t}\n \n \treq->operation = LDB_SEARCH;\n-\treq->op.search.base = ldb_dn_new(req, module->ldb, NULL);\n+\treq->op.search.base = ldb_dn_new(req, module->ldb, \"\");\n \treq->op.search.scope = LDB_SCOPE_BASE;\n \n \treq->op.search.tree = ldb_parse_tree(req, \"objectClass=*\");\n\nModified: branches/SAMBA_4_0/source/scripting/libjs/provision.js\n===================================================================\n--- branches/SAMBA_4_0/source/scripting/libjs/provision.js\t2007-07-04 07:45:41 UTC (rev 23702)\n+++ branches/SAMBA_4_0/source/scripting/libjs/provision.js\t2007-07-04 11:06:32 UTC (rev 23703)\n@@ -450,12 +450,9 @@\n \t\t\t\t      subobj.DNSDOMAIN);\n \trdn_list = split(\".\", subobj.DNSDOMAIN);\n \tsubobj.DOMAINDN     = \"DC=\" + join(\",DC=\", rdn_list);\n-\tsubobj.DOMAINDN_LDB = \"users.ldb\";\n \tsubobj.ROOTDN       = subobj.DOMAINDN;\n \tsubobj.CONFIGDN     = \"CN=Configuration,\" + subobj.ROOTDN;\n-\tsubobj.CONFIGDN_LDB = \"configuration.ldb\";\n \tsubobj.SCHEMADN     = \"CN=Schema,\" + subobj.CONFIGDN;\n-\tsubobj.SCHEMADN_LDB = \"schema.ldb\";\n \n \tvar rdns = split(\",\", subobj.DOMAINDN);\n \tsubobj.RDN_DC = substr(rdns[0], strlen(\"DC=\"));\n@@ -888,6 +885,9 @@\n \t\t\t\t\t\"show_deleted\",\n \t\t\t\t\t\"partition\");\n \tsubobj.MODULES_LIST = join(\",\", modules_list);\n+\tsubobj.DOMAINDN_LDB = \"users.ldb\";\n+\tsubobj.CONFIGDN_LDB = \"configuration.ldb\";\n+\tsubobj.SCHEMADN_LDB = \"schema.ldb\";\n \tsubobj.DOMAINDN_MOD = \"pdc_fsmo,password_hash\";\n \tsubobj.CONFIGDN_MOD = \"naming_fsmo\";\n \tsubobj.SCHEMADN_MOD = \"schema_fsmo\";\n\nModified: branches/SAMBA_4_0/source/setup/provision\n===================================================================\n--- branches/SAMBA_4_0/source/setup/provision\t2007-07-04 07:45:41 UTC (rev 23702)\n+++ branches/SAMBA_4_0/source/setup/provision\t2007-07-04 11:06:32 UTC (rev 23703)\n@@ -129,14 +129,15 @@\n \n if (ldapbackend) {\n \tif (!ldapmodule) {\n-\t\tsubobj[\"LDAPMODULE\"] = \"entryUUID\";\n+\t\tsubobj.LDAPMODULE = \"entryUUID\";\n \t}\n-\tsubobj[\"DOMAINDN_LDB\"] = subobj[\"LDAPBACKEND\"];\n-\tsubobj[\"DOMAINDN_MOD2\"] = subobj[\"LDAPMODULE\"] + \",paged_searches\";\n-\tsubobj[\"CONFIGDN_LDB\"] = subobj[\"LDAPBACKEND\"];\n-\tsubobj[\"CONFIGDN_MOD2\"] = subobj[\"LDAPMODULE\"] + \",paged_searches\";\n-\tsubobj[\"SCHEMADN_LDB\"] = subobj[\"LDAPBACKEND\"];\n-\tsubobj[\"SCHEMADN_MOD2\"] = subobj[\"LDAPMODULE\"] + \",paged_searches\";\n+\tsubobj.DOMAINDN_LDB = subobj.LDAPBACKEND;\n+\tsubobj.DOMAINDN_MOD2 = \",\" + subobj.LDAPMODULE + \",paged_searches\";\n+\tsubobj.CONFIGDN_LDB = subobj.LDAPBACKEND;\n+\tsubobj.CONFIGDN_MOD2 = \",\" + subobj.LDAPMODULE + \",paged_searches\";\n+\tsubobj.SCHEMADN_LDB = subobj.LDAPBACKEND;\n+\tsubobj.SCHEMADN_MOD2 = \",\" + subobj.LDAPMODULE + \",paged_searches\";\n+\tmessage(\"LDAP module: %s backend: %s\\n\", subobj.LDAPMODULE, subobj.LDAPBACKEND);\n }\n \n if (!provision_validate(subobj, message)) {\n\nModified: branches/SAMBA_4_0/source/setup/provision-backend\n===================================================================\n--- branches/SAMBA_4_0/source/setup/provision-backend\t2007-07-04 07:45:41 UTC (rev 23702)\n+++ branches/SAMBA_4_0/source/setup/provision-backend\t2007-07-04 11:06:32 UTC (rev 23703)\n@@ -88,7 +88,7 @@\n \n \n var paths = provision_default_paths(subobj);\n-provision_fix_subobj(subobj, message, paths);\n+provision_fix_subobj(subobj, paths);\n message(\"Provisioning LDAP backend for %s in realm %s into %s\\n\", subobj.HOSTNAME, subobj.REALM, subobj.LDAPDIR);\n message(\"Using LDAP Manager password: %s\\n\", subobj.LDAPMANAGERPASS);\n var tmp_schema_ldb = subobj.LDAPDIR + \"/schema-tmp.ldb\";\n\n"}