{"category": "ham", "to_address": "samba-cvs@samba.org", "from_address": "metze@samba.org", "subject": "svn commit: samba r22946 - in branches/SAMBA_3_0_26/source: .\n\tinclude nsswitch", "body": "Author: metze\nDate: 2007-05-16 15:39:08 +0000 (Wed, 16 May 2007)\nNew Revision: 22946\n\nWebSVN: http://websvn.samba.org/cgi-bin/viewcvs.cgi?view=rev&root=samba&rev=22946\n\nLog:\nremove reference to backup_tdb()\n\nmetze\nModified:\n   branches/SAMBA_3_0_26/source/Makefile.in\n   branches/SAMBA_3_0_26/source/include/includes.h\n   branches/SAMBA_3_0_26/source/nsswitch/idmap_tdb.c\n\n\nChangeset:\nModified: branches/SAMBA_3_0_26/source/Makefile.in\n===================================================================\n--- branches/SAMBA_3_0_26/source/Makefile.in\t2007-05-16 14:54:54 UTC (rev 22945)\n+++ branches/SAMBA_3_0_26/source/Makefile.in\t2007-05-16 15:39:08 UTC (rev 22946)\n@@ -199,7 +199,7 @@\n \tlib/tdb/common/freelist.o lib/tdb/common/freelistcheck.o lib/tdb/common/io.o lib/tdb/common/lock.o \\\n \tlib/tdb/common/open.o lib/tdb/common/transaction.o lib/tdb/common/traverse.o\n \n-TDB_OBJ = $(TDBBASE_OBJ) lib/util_tdb.o lib/tdb/common/tdbback.o \\\n+TDB_OBJ = $(TDBBASE_OBJ) lib/util_tdb.o \\\n \tlib/dbwrap.o lib/dbwrap_tdb.o\n \n SMBLDAP_OBJ = @SMBLDAP@ @SMBLDAPUTIL@\n@@ -813,7 +813,7 @@\n INIPARSER_OBJ = iniparser/src/iniparser.o iniparser/src/dictionary.o \\\n \t\tiniparser/src/strlib.o\n \n-TDBBACKUP_OBJ = lib/tdb/tools/tdbbackup.o lib/tdb/common/tdbback.o $(LIBREPLACE_OBJ) \\\n+TDBBACKUP_OBJ = lib/tdb/tools/tdbbackup.o $(LIBREPLACE_OBJ) \\\n \t$(TDBBASE_OBJ) $(SOCKET_WRAPPER_OBJ)\n \n TDBTOOL_OBJ = lib/tdb/tools/tdbtool.o $(TDBBASE_OBJ) $(LIBREPLACE_OBJ) \\\n\nModified: branches/SAMBA_3_0_26/source/include/includes.h\n===================================================================\n--- branches/SAMBA_3_0_26/source/include/includes.h\t2007-05-16 14:54:54 UTC (rev 22945)\n+++ branches/SAMBA_3_0_26/source/include/includes.h\t2007-05-16 15:39:08 UTC (rev 22946)\n@@ -635,7 +635,6 @@\n #include \"dlinklist.h\"\n #include \"tdb.h\"\n #include \"util_tdb.h\"\n-#include \"tdbback.h\"\n \n #include \"lib/talloc/talloc.h\"\n /* And a little extension. Abort on type mismatch */\n\nModified: branches/SAMBA_3_0_26/source/nsswitch/idmap_tdb.c\n===================================================================\n--- branches/SAMBA_3_0_26/source/nsswitch/idmap_tdb.c\t2007-05-16 14:54:54 UTC (rev 22945)\n+++ branches/SAMBA_3_0_26/source/nsswitch/idmap_tdb.c\t2007-05-16 15:39:08 UTC (rev 22946)\n@@ -115,13 +115,15 @@\n  Convert the idmap database from an older version.\n *****************************************************************************/\n \n-static BOOL idmap_tdb_convert(const char *idmap_name)\n+static BOOL idmap_tdb_upgrade(const char *idmap_name)\n {\n \tint32 vers;\n \tBOOL bigendianheader;\n \tBOOL failed = False;\n \tTDB_CONTEXT *idmap_tdb;\n \n+\tDEBUG(0, (\"Upgrading winbindd_idmap.tdb from an old version\\n\"));\n+\n \tif (!(idmap_tdb = tdb_open_log(idmap_name, 0,\n \t\t\t\t\tTDB_DEFAULT, O_RDWR,\n \t\t\t\t\t0600))) {\n@@ -189,32 +191,6 @@\n \treturn True;\n }\n \n-/*****************************************************************************\n- Convert the idmap database from an older version if necessary\n-*****************************************************************************/\n-\n-BOOL idmap_tdb_upgrade(TALLOC_CTX *ctx, const char *tdbfile)\n-{\n-\tchar *backup_name;\n-\n-\tDEBUG(0, (\"Upgrading winbindd_idmap.tdb from an old version\\n\"));\n-\n-\tbackup_name = talloc_asprintf(ctx, \"%s.bak\", tdbfile);\n-\tif ( ! backup_name) {\n-\t\tDEBUG(0, (\"Out of memory!\\n\"));\n-\t\treturn False;\n-\t}\n-\n-\tif (backup_tdb(tdbfile, backup_name, 0) != 0) {\n-\t\tDEBUG(0, (\"Could not backup idmap database\\n\"));\n-\t\ttalloc_free(backup_name);\n-\t\treturn False;\n-\t}\n-\n-\ttalloc_free(backup_name);\n-\treturn idmap_tdb_convert(tdbfile);\n-}\n-\n /* WARNING: We can't open a tdb twice inthe same process, for that reason\n  * I'm going to use a hack with open ref counts to open the winbindd_idmap.tdb\n  * only once. We will later decide whether to split the db in multiple files\n@@ -282,7 +258,7 @@\n \t\t/* backup_tdb expects the tdb not to be open */\n \t\ttdb_close(idmap_tdb_common_ctx);\n \n-\t\tif ( ! idmap_tdb_upgrade(ctx, tdbfile)) {\n+\t\tif ( ! idmap_tdb_upgrade(tdbfile)) {\n \t\t\n \t\t\tDEBUG(0, (\"Unable to open idmap database, it's in an old formati, and upgrade failed!\\n\"));\n \t\t\tret = NT_STATUS_INTERNAL_DB_ERROR;\n\n"}