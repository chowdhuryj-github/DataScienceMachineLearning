{"category": "ham", "to_address": "samba-cvs@samba.org", "from_address": "Jelmer Vernooij <jelmer@samba.org>", "subject": "Rev 11882: Fix running against openldap. in\n\tfile:///home/jelmer/bzr.samba/SAMBA_4_0/", "body": "At file:///home/jelmer/bzr.samba/SAMBA_4_0/\n\n------------------------------------------------------------\nrevno: 11882\nrevision-id: jelmer@samba.org-20070417003537-smfal94m26ngylh8\nparent: jelmer@samba.org-20070417001333-mff8mosr6a5i3sb3\ncommitter: Jelmer Vernooij \nbranch nick: SAMBA_4_0\ntimestamp: Tue 2007-04-17 02:35:37 +0200\nmessage:\n  Fix running against openldap.\nmodified:\n  source/script/tests/Samba4.pm  svn-v2:21707@0c0555d6-39d7-0310-84fc-f1cc0bd64818-branches%2fSAMBA_4_0-source%2fscript%2ftests%2fSamba4.pm\n=== modified file 'source/script/tests/Samba4.pm'\n--- a/source/script/tests/Samba4.pm\t2007-04-17 00:13:33 +0000\n+++ b/source/script/tests/Samba4.pm\t2007-04-17 00:35:37 +0000\n@@ -26,7 +26,6 @@\n \tmy $count = 0;\n \tmy ($self, $env_vars) = @_;\n \n-\tmy $conf = $env_vars->{SLAPD_CONF};\n \tmy $uri = $env_vars->{LDAP_URI};\n \n \t# running slapd in the background means it stays in the same process group, so it can be\n@@ -36,7 +35,7 @@\n \t} elsif ($self->{ldap} eq \"openldap\") {\n \t\tmy $oldpath = $ENV{PATH};\n \t\t$ENV{PATH} = \"/usr/local/sbin:/usr/sbin:/sbin:$ENV{PATH}\";\n-\t\tsystem(\"slapd -d0 -f $conf -h $uri > $env_vars->{LDAPDIR}/logs 2>&1 &\");\n+\t\tsystem(\"slapd -d0 -f $env_vars->{SLAPD_CONF} -h $uri > $env_vars->{LDAPDIR}/logs 2>&1 &\");\n \t\t$ENV{PATH} = $oldpath;\n \t}\n \twhile (system(\"$self->{bindir}/ldbsearch -H $uri -s base -b \\\"\\\" supportedLDAPVersion > /dev/null\") != 0) {\n@@ -229,7 +228,7 @@\n \n \tsystem(\"perl $ENV{FEDORA_DS_PREFIX}/bin/ds_newinst.pl $fedora_ds_inf >&2\") == 0 or return 0;\n \n-\tunlink(<$fedora_ds_dir/schema/00core.*>);\n+\tsystem(<$fedora_ds_dir/schema/00core.*>);\n \n \topen(LDIF, \">$fedora_ds_dir/dse.ldif\");\n \tprint LDIF \"\n@@ -295,7 +294,7 @@\n suffix\t\t\\\"$basedn\\\"\n rootdn          \\\"cn=Manager,$basedn\\\"\n rootpw          $password\n-directory\t\\$ldapdir/db\n+directory\t$ldapdir/db\n index           objectClass eq\n index           samAccountName eq\n index name eq\n@@ -363,9 +362,9 @@\n \topen(CONF, \">$modconf\"); close(CONF);\n \n \tif (system(\"slaptest -u -f $slapd_conf >&2\") != 0) {\n-\t\topen(CONF, \">modconf\"); \n+\t\topen(CONF, \">$modconf\"); \n \t\t# enable slapd modules\n-\t\tprint \"\n+\t\tprint CONF \"\n modulepath\t/usr/lib/ldap\n moduleload\tback_bdb\n moduleload\tsyncprov\n@@ -373,16 +372,15 @@\n \t\tclose(CONF);\n \t}\n \n-\tif (system(\"slaptest -u -f $slapd_conf\") == 0) {\n-    \tsystem(\"slapadd -f $slapd_conf < $privatedir/$dnsname.ldif >/dev/null\") == 0 or die(\"slapadd failed\");\n-    }\n+\tsystem(\"slaptest -u -f $slapd_conf\") == 0 or die(\"slaptest still fails after adding modules\");\n+\tsystem(\"slapadd -f $slapd_conf < $privatedir/$dnsname.ldif >/dev/null\") == 0 or die(\"slapadd failed\");\n \n     system(\"slaptest -f $slapd_conf >/dev/null\") == 0 or \n \t\tdie (\"slaptest after database load failed\");\n     \n \t$ENV{PATH} = $oldpath;\n \n-\treturn $pidfile;\n+\treturn ($slapd_conf, $pidfile);\n }\n \n sub provision($$$$$)\n@@ -564,7 +562,7 @@\n \n \tif (not defined($self->{ldap})) {\n \t} elsif ($self->{ldap} eq \"openldap\") {\n-\t\t$ret->{OPENLDAP_PIDFILE} = $self->mk_openldap($ldapdir, $basedn, $password, $privatedir, $dnsname, $configuration, join(' ', @provision_options)) or die(\"Unable to create openldap directories\");\n+\t\t($ret->{SLAPD_CONF}, $ret->{OPENLDAP_PIDFILE}) = $self->mk_openldap($ldapdir, $basedn, $password, $privatedir, $dnsname, $configuration, join(' ', @provision_options)) or die(\"Unable to create openldap directories\");\n \t} elsif ($self->{ldap} eq \"fedora\") {\n \t\t($ret->{FEDORA_DS_DIR}, $ret->{FEDORA_DS_PIDFILE}) = $self->mk_fedora($ldapdir, $basedn, $root, $password, $privatedir, $configuration) or die(\"Unable to create fedora ds directories\");\n \t\tpush (@provision_options, \"--ldap-module=nsuniqueid\");\n\n"}