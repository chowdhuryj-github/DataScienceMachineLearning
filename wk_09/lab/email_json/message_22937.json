{"category": "ham", "to_address": "samba-cvs@samba.org", "from_address": "tridge@samba.org", "subject": "svn commit: samba r22670 - in\n\tbranches/SAMBA_4_0/source/torture/raw: .", "body": "Author: tridge\nDate: 2007-05-04 12:41:28 +0000 (Fri, 04 May 2007)\nNew Revision: 22670\n\nWebSVN: http://websvn.samba.org/cgi-bin/viewcvs.cgi?view=rev&root=samba&rev=22670\n\nLog:\n\nchanged the RAW-NOTIFY test to support clustered testing (two nodes)\n\nModified:\n   branches/SAMBA_4_0/source/torture/raw/notify.c\n\n\nChangeset:\nModified: branches/SAMBA_4_0/source/torture/raw/notify.c\n===================================================================\n--- branches/SAMBA_4_0/source/torture/raw/notify.c\t2007-05-04 11:26:25 UTC (rev 22669)\n+++ branches/SAMBA_4_0/source/torture/raw/notify.c\t2007-05-04 12:41:28 UTC (rev 22670)\n@@ -55,7 +55,8 @@\n /* \n    basic testing of change notify on directories\n */\n-static BOOL test_notify_dir(struct smbcli_state *cli, TALLOC_CTX *mem_ctx)\n+static BOOL test_notify_dir(struct smbcli_state *cli, struct smbcli_state *cli2, \n+\t\t\t    TALLOC_CTX *mem_ctx)\n {\n \tBOOL ret = True;\n \tNTSTATUS status;\n@@ -110,7 +111,7 @@\n \tprintf(\"testing notify mkdir\\n\");\n \n \treq = smb_raw_changenotify_send(cli->tree, &notify);\n-\tsmbcli_mkdir(cli->tree, BASEDIR \"\\\\subdir-name\");\n+\tsmbcli_mkdir(cli2->tree, BASEDIR \"\\\\subdir-name\");\n \n \tstatus = smb_raw_changenotify_recv(req, mem_ctx, &notify);\n \tCHECK_STATUS(status, NT_STATUS_OK);\n@@ -122,7 +123,7 @@\n \tprintf(\"testing notify rmdir\\n\");\n \n \treq = smb_raw_changenotify_send(cli->tree, &notify);\n-\tsmbcli_rmdir(cli->tree, BASEDIR \"\\\\subdir-name\");\n+\tsmbcli_rmdir(cli2->tree, BASEDIR \"\\\\subdir-name\");\n \n \tstatus = smb_raw_changenotify_recv(req, mem_ctx, &notify);\n \tCHECK_STATUS(status, NT_STATUS_OK);\n@@ -132,10 +133,10 @@\n \n \tprintf(\"testing notify mkdir - rmdir - mkdir - rmdir\\n\");\n \n-\tsmbcli_mkdir(cli->tree, BASEDIR \"\\\\subdir-name\");\n-\tsmbcli_rmdir(cli->tree, BASEDIR \"\\\\subdir-name\");\n-\tsmbcli_mkdir(cli->tree, BASEDIR \"\\\\subdir-name\");\n-\tsmbcli_rmdir(cli->tree, BASEDIR \"\\\\subdir-name\");\n+\tsmbcli_mkdir(cli2->tree, BASEDIR \"\\\\subdir-name\");\n+\tsmbcli_rmdir(cli2->tree, BASEDIR \"\\\\subdir-name\");\n+\tsmbcli_mkdir(cli2->tree, BASEDIR \"\\\\subdir-name\");\n+\tsmbcli_rmdir(cli2->tree, BASEDIR \"\\\\subdir-name\");\n \treq = smb_raw_changenotify_send(cli->tree, &notify);\n \tstatus = smb_raw_changenotify_recv(req, mem_ctx, &notify);\n \tCHECK_STATUS(status, NT_STATUS_OK);\n@@ -174,11 +175,14 @@\n \tnotify.nttrans.in.file.fnum = fnum;\n \treq = smb_raw_changenotify_send(cli->tree, &notify);\n \n+\tstatus = smbcli_unlink(cli->tree, BASEDIR \"\\\\nonexistant.txt\");\n+\tCHECK_STATUS(status, NT_STATUS_OBJECT_NAME_NOT_FOUND);\n+\n \t/* (1st unlink) as the 2nd notify directly returns,\n \t   this unlink is only seen by the 1st notify and \n \t   the 3rd notify (later) */\n \tprintf(\"testing notify on unlink for the first file\\n\");\n-\tstatus = smbcli_unlink(cli->tree, BASEDIR \"\\\\test0.txt\");\n+\tstatus = smbcli_unlink(cli2->tree, BASEDIR \"\\\\test0.txt\");\n \tCHECK_STATUS(status, NT_STATUS_OK);\n \n \t/* receive the reply from the 2nd notify */\n@@ -186,24 +190,27 @@\n \tCHECK_STATUS(status, NT_STATUS_OK);\n \n \tCHECK_VAL(notify.nttrans.out.num_changes, count);\n-\tfor (i=1;itree, &notify);\n \n+\tstatus = smbcli_unlink(cli->tree, BASEDIR \"\\\\nonexistant.txt\");\n+\tCHECK_STATUS(status, NT_STATUS_OBJECT_NAME_NOT_FOUND);\n+\n \tprintf(\"testing notify on wildcard unlink for %d files\\n\", count-1);\n \t/* (2nd unlink) do a wildcard unlink */\n-\tstatus = smbcli_unlink(cli->tree, BASEDIR \"\\\\test*.txt\");\n+\tstatus = smbcli_unlink(cli2->tree, BASEDIR \"\\\\test*.txt\");\n \tCHECK_STATUS(status, NT_STATUS_OK);\n \n \t/* receive the 3rd notify */\n@@ -1149,13 +1156,16 @@\n */\n BOOL torture_raw_notify(struct torture_context *torture)\n {\n-\tstruct smbcli_state *cli;\n+\tstruct smbcli_state *cli, *cli2;\n \tBOOL ret = True;\n \tTALLOC_CTX *mem_ctx;\n \t\t\n \tif (!torture_open_connection(&cli, 0)) {\n \t\treturn False;\n \t}\n+\tif (!torture_open_connection(&cli2, 0)) {\n+\t\treturn False;\n+\t}\n \n \tmem_ctx = talloc_init(\"torture_raw_notify\");\n \n@@ -1163,7 +1173,7 @@\n \t\treturn False;\n \t}\n \n-\tret &= test_notify_dir(cli, mem_ctx);\n+\tret &= test_notify_dir(cli, cli2, mem_ctx);\n \tret &= test_notify_mask(cli, mem_ctx);\n \tret &= test_notify_recursive(cli, mem_ctx);\n \tret &= test_notify_file(cli, mem_ctx);\n@@ -1177,6 +1187,7 @@\n \tsmb_raw_exit(cli->session);\n \tsmbcli_deltree(cli->tree, BASEDIR);\n \ttorture_close_connection(cli);\n+\ttorture_close_connection(cli2);\n \ttalloc_free(mem_ctx);\n \treturn ret;\n }\n\n"}