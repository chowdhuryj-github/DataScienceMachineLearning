{"category": "ham", "to_address": "samba-cvs@samba.org", "from_address": "Michael Adam <ma@sernet.de>", "subject": "Rev 5379: merge from upstream in\n\thttp://samba.sernet.de/ma/bzr/SAMBA_3_0-registry.bzr/", "body": "At http://samba.sernet.de/ma/bzr/SAMBA_3_0-registry.bzr/\n\n------------------------------------------------------------\nrevno: 5379\nrevision-id: ma@sernet.de-20070603190723-224q0v6t9b0okndn\nparent: ma@sernet.de-20070602232613-1ohum1a444koaoeo\nparent: metze@samba.org-20070603163110-bc1fydjxp5qr4qg0\ncommitter: Michael Adam \nbranch nick: SAMBA_3_0-registry.bzr\ntimestamp: Sun 2007-06-03 21:07:23 +0200\nmessage:\n  merge from upstream\nadded:\n  source/iniparser_build/        iniparser_build-20070603160029-8hjfwb4brph2pn1f-1\n  source/iniparser_build/dictionary.c dictionary.c-20070603160029-8hjfwb4brph2pn1f-2\n  source/iniparser_build/iniparser.c iniparser.c-20070603160029-8hjfwb4brph2pn1f-3\n  source/iniparser_build/strlib.c strlib.c-20070603160029-8hjfwb4brph2pn1f-4\nmodified:\n  REVISION                       REVISION-20060530022625-68239662668b41c3\n  source/Makefile.in             Makefile.in-20060530022626-b16dac2328ebe703\n  source/lib/dbwrap_tdb.c        dbwrap_tdb.c-20070510110204-r3qybke0030vfwde-1\n  source/nsswitch/winbindd_cache.c winbindd_cache.c-20060530022627-45b83e217d38566d\n    ------------------------------------------------------------\n    revno: 5275.1.774\n    merged: metze@samba.org-20070603163110-bc1fydjxp5qr4qg0\n    parent: metze@samba.org-20070603160032-jpw6l1rj17bfa00m\n    committer: metze@samba.org\n    branch nick: SAMBA_3_0.bzr\n    timestamp: Sun 2007-06-03 11:31:10 -0500\n    message:\n      metze@samba.org (r23315)  2007-06-03 11:21:40 -0500 (Sun, 03 Jun 2007)\n          \n          - don't use the builtin and -liniparser together in bin/net\n          - unify handling on @BUILD_INIPARSER@\n          \n          btw: nsswitch/pam_winbind.c doesn't compile anymore on SuSE 10.2!\n          I think we should build pam modules by default to notice things\n          like this in the build-farm...\n          \n          metze\n    ------------------------------------------------------------\n    revno: 5275.1.773\n    merged: metze@samba.org-20070603160032-jpw6l1rj17bfa00m\n    parent: vlendec@samba.org-20070603070110-cuazddmzym63nrx9\n    committer: metze@samba.org\n    branch nick: SAMBA_3_0.bzr\n    timestamp: Sun 2007-06-03 11:00:32 -0500\n    message:\n      metze@samba.org (r23314)  2007-06-03 10:51:09 -0500 (Sun, 03 Jun 2007)\n          \n          For some systems it's needed to inject replace.h into\n          the iniparser source code, I do it in a way we can still have\n          a unmodified copy of iniparser in source/iniparser/\n          and have the wrapper stuff in source/iniparser_build/.\n          \n          If the build-farm is happy with this I'll merge it to 3_0_26\n          tomorrow...\n          \n          metze\n    ------------------------------------------------------------\n    revno: 5275.1.772\n    merged: vlendec@samba.org-20070603070110-cuazddmzym63nrx9\n    parent: jpeach@samba.org-20070602211552-k2ixcuyxyo7lubnx\n    committer: vlendec@samba.org\n    branch nick: SAMBA_3_0.bzr\n    timestamp: Sun 2007-06-03 02:01:10 -0500\n    message:\n      vlendec@samba.org (r23313)  2007-06-03 01:54:51 -0500 (Sun, 03 Jun 2007)\n          \n          Janitor for tridge:\n          \n          we need to use tdb_wrap_open in both these backends to allow for\n          multiple opens.  This is done for notify.tdb. Otherwise we die when a\n          2nd share with notify is setup\n          \n          \n    ------------------------------------------------------------\n    revno: 5275.1.771\n    merged: jpeach@samba.org-20070602211552-k2ixcuyxyo7lubnx\n    parent: metze@samba.org-20070602091615-xqyv9sa9e5bvil52\n    committer: jpeach@samba.org\n    branch nick: SAMBA_3_0.bzr\n    timestamp: Sat 2007-06-02 16:15:52 -0500\n    message:\n      jpeach@samba.org (r23312)  2007-06-02 16:12:47 -0500 (Sat, 02 Jun 2007)\n          \n          As per Volker, rename the \"windbind:ads\" parameter \"winbind:rpc only\".\n          \n=== added directory 'source/iniparser_build'\n=== added file 'source/iniparser_build/dictionary.c'\n--- a/source/iniparser_build/dictionary.c\t1970-01-01 00:00:00 +0000\n+++ b/source/iniparser_build/dictionary.c\t2007-06-03 16:00:32 +0000\n@@ -0,0 +1,7 @@\n+/*\n+ for someplatforms it's needed to inject replace.h into\n+ the iniparser source code\n+ --metze\n+*/\n+#include \"lib/replace/replace.h\"\n+#include \"iniparser/src/dictionary.c\"\n\n=== added file 'source/iniparser_build/iniparser.c'\n--- a/source/iniparser_build/iniparser.c\t1970-01-01 00:00:00 +0000\n+++ b/source/iniparser_build/iniparser.c\t2007-06-03 16:00:32 +0000\n@@ -0,0 +1,7 @@\n+/*\n+ for someplatforms it's needed to inject replace.h into\n+ the iniparser source code\n+ --metze\n+*/\n+#include \"lib/replace/replace.h\"\n+#include \"iniparser/src/iniparser.c\"\n\n=== added file 'source/iniparser_build/strlib.c'\n--- a/source/iniparser_build/strlib.c\t1970-01-01 00:00:00 +0000\n+++ b/source/iniparser_build/strlib.c\t2007-06-03 16:00:32 +0000\n@@ -0,0 +1,7 @@\n+/*\n+ for someplatforms it's needed to inject replace.h into\n+ the iniparser source code\n+ --metze\n+*/\n+#include \"lib/replace/replace.h\"\n+#include \"iniparser/src/strlib.c\"\n\n=== modified file 'REVISION'\n--- a/REVISION\t2007-06-02 09:16:15 +0000\n+++ b/REVISION\t2007-06-03 16:31:10 +0000\n@@ -2,9 +2,9 @@\n URL: file:///home/drizzt/jerry/src/svn/samba/branches/SAMBA_3_0\n Repository Root: file:///home/drizzt/jerry/src/svn/samba\n Repository UUID: 0c0555d6-39d7-0310-84fc-f1cc0bd64818\n-Revision: 23309\n+Revision: 23315\n Node Kind: directory\n Last Changed Author: metze\n-Last Changed Rev: 23309\n-Last Changed Date: 2007-06-02 04:10:08 -0500 (Sat, 02 Jun 2007)\n+Last Changed Rev: 23315\n+Last Changed Date: 2007-06-03 11:21:40 -0500 (Sun, 03 Jun 2007)\n \n\n=== modified file 'source/Makefile.in'\n--- a/source/Makefile.in\t2007-06-02 23:26:13 +0000\n+++ b/source/Makefile.in\t2007-06-03 19:07:23 +0000\n@@ -634,7 +634,7 @@\n \t     $(SMBLDAP_OBJ) $(DCUTIL_OBJ) $(LDB_OBJ)\n \n PAM_WINBIND_OBJ = nsswitch/pam_winbind.o $(WBCOMMON_OBJ) \\\n-\t\t  $(LIBREPLACE_OBJ) $(SOCKET_WRAPPER_OBJ) @BUILD_INIPARSER@\n+\t\t  $(LIBREPLACE_OBJ) $(SOCKET_WRAPPER_OBJ)\n \n LIBSMBCLIENT_OBJ = libsmb/libsmbclient.o libsmb/libsmb_compat.o \\\n \t\t   libsmb/libsmb_cache.o \\\n@@ -732,7 +732,7 @@\n \t  $(LIBADS_OBJ) $(LIBADS_SERVER_OBJ) $(POPT_LIB_OBJ) \\\n \t  $(SMBLDAP_OBJ) $(DCUTIL_OBJ) $(SERVER_MUTEX_OBJ) \\\n \t  $(AFS_OBJ) $(AFS_SETTOKEN_OBJ) $(REGFIO_OBJ) $(READLINE_OBJ) \\\n-\t  $(LDB_OBJ) $(LIBGPO_OBJ) $(INIPARSER_OBJ) $(DISPLAY_SEC_OBJ) \n+\t  $(LDB_OBJ) $(LIBGPO_OBJ) $(DISPLAY_SEC_OBJ)\n \n CUPS_OBJ = client/smbspool.o $(PARAM_OBJ) $(LIBSMB_OBJ) \\\n \t  $(LIB_NONSMBD_OBJ) $(KRBCLIENT_OBJ) $(SECRETS_OBJ) \\\n@@ -981,8 +981,8 @@\n POPT_OBJ=popt/findme.o popt/popt.o popt/poptconfig.o \\\n           popt/popthelp.o popt/poptparse.o\n \n-INIPARSER_OBJ = iniparser/src/iniparser.o iniparser/src/dictionary.o \\\n-\t\tiniparser/src/strlib.o\n+INIPARSER_OBJ = iniparser_build/iniparser.o iniparser_build/dictionary.o \\\n+\t\tiniparser_build/strlib.o\n \n TDBBACKUP_OBJ = lib/tdb/tools/tdbbackup.o $(LIBREPLACE_OBJ) \\\n \t$(TDBBASE_OBJ) $(SOCKET_WRAPPER_OBJ)\n@@ -1561,7 +1561,7 @@\n \t\t$(LDAP_LIBS) $(LIBS) -lcom_err \\\n \t\t@SONAMEFLAG@`basename $@`\n \n-bin/pam_winbind.@SHLIBEXT@: $(BINARY_PREREQS) $(PAM_WINBIND_OBJ)\n+bin/pam_winbind.@SHLIBEXT@: $(BINARY_PREREQS) $(PAM_WINBIND_OBJ) @BUILD_INIPARSER@\n \t@echo \"Linking shared library $@\"\n \t@$(SHLD) $(LDSHFLAGS) -o $@ $(PAM_WINBIND_OBJ) -lpam @INIPARSERLIBS@ $(GPLIBS) \\\n \t\t@SONAMEFLAG@`basename $@`\n\n=== modified file 'source/lib/dbwrap_tdb.c'\n--- a/source/lib/dbwrap_tdb.c\t2007-05-29 18:35:39 +0000\n+++ b/source/lib/dbwrap_tdb.c\t2007-06-03 07:01:10 +0000\n@@ -21,7 +21,7 @@\n #include \"includes.h\"\n \n struct db_tdb_ctx {\n-\tTDB_CONTEXT *tdb;\n+\tstruct tdb_wrap *wtdb;\n };\n \n static NTSTATUS db_tdb_store(struct db_record *rec, TDB_DATA data, int flag);\n@@ -36,7 +36,7 @@\n \t\t   hex_encode(data, (unsigned char *)data->key.dptr,\n \t\t\t      data->key.dsize)));\n \n-\tif (tdb_chainunlock(ctx->tdb, data->key) != 0) {\n+\tif (tdb_chainunlock(ctx->wtdb->tdb, data->key) != 0) {\n \t\tDEBUG(0, (\"tdb_chainunlock failed\\n\"));\n \t\treturn -1;\n \t}\n@@ -78,7 +78,7 @@\n \t\tTALLOC_FREE(keystr);\n \t}\n \n-\tif (tdb_chainlock(ctx->tdb, key) != 0) {\n+\tif (tdb_chainlock(ctx->wtdb->tdb, key) != 0) {\n \t\tDEBUG(3, (\"tdb_chainlock failed\\n\"));\n \t\tTALLOC_FREE(result);\n \t\treturn NULL;\n@@ -86,7 +86,7 @@\n \n \ttalloc_set_destructor(result, db_tdb_record_destr);\n \n-\tvalue = tdb_fetch(ctx->tdb, key);\n+\tvalue = tdb_fetch(ctx->wtdb->tdb, key);\n \n \tif (value.dptr == NULL) {\n \t\treturn result;\n@@ -119,7 +119,7 @@\n \t * anymore after it was stored.\n \t */\n \n-\treturn (tdb_store(ctx->tdb, rec->key, data, flag) == 0) ?\n+\treturn (tdb_store(ctx->wtdb->tdb, rec->key, data, flag) == 0) ?\n \t\tNT_STATUS_OK : NT_STATUS_UNSUCCESSFUL;\n }\n \n@@ -129,13 +129,13 @@\n \t\t\t\t\t\t       struct db_tdb_ctx);\n \tint res;\n \t\n-\tres = tdb_delete(ctx->tdb, rec->key);\n+\tres = tdb_delete(ctx->wtdb->tdb, rec->key);\n \n \tif (res == 0) {\n \t\treturn NT_STATUS_OK;\n \t}\n \n-\treturn map_nt_error_from_tdb(tdb_error(ctx->tdb));\n+\treturn map_nt_error_from_tdb(tdb_error(ctx->wtdb->tdb));\n }\n \n struct db_tdb_traverse_ctx {\n@@ -171,7 +171,7 @@\n \tctx.db = db;\n \tctx.f = f;\n \tctx.private_data = private_data;\n-\treturn tdb_traverse(db_ctx->tdb, db_tdb_traverse_func, &ctx);\n+\treturn tdb_traverse(db_ctx->wtdb->tdb, db_tdb_traverse_func, &ctx);\n }\n \n static NTSTATUS db_tdb_store_deny(struct db_record *rec, TDB_DATA data, int flag)\n@@ -211,7 +211,7 @@\n \tctx.db = db;\n \tctx.f = f;\n \tctx.private_data = private_data;\n-\treturn tdb_traverse_read(db_ctx->tdb, db_tdb_traverse_read_func, &ctx);\n+\treturn tdb_traverse_read(db_ctx->wtdb->tdb, db_tdb_traverse_read_func, &ctx);\n }\n \n static int db_tdb_get_seqnum(struct db_context *db)\n@@ -219,17 +219,7 @@\n {\n \tstruct db_tdb_ctx *db_ctx =\n \t\ttalloc_get_type_abort(db->private_data, struct db_tdb_ctx);\n-\treturn tdb_get_seqnum(db_ctx->tdb);\n-}\n-\n-static int db_tdb_ctx_destr(struct db_tdb_ctx *ctx)\n-{\n-\tif (tdb_close(ctx->tdb) != 0) {\n-\t\tDEBUG(0, (\"Failed to close tdb: %s\\n\", strerror(errno)));\n-\t\treturn -1;\n-\t}\n-\n-\treturn 0;\n+\treturn tdb_get_seqnum(db_ctx->wtdb->tdb);\n }\n \n struct db_context *db_open_tdb(TALLOC_CTX *mem_ctx,\n@@ -252,14 +242,13 @@\n \t\tgoto fail;\n \t}\n \n-\tdb_tdb->tdb = tdb_open_log(name, hash_size, tdb_flags,\n-\t\t\t\t   open_flags, mode);\n-\tif (db_tdb->tdb == NULL) {\n+\tdb_tdb->wtdb = tdb_wrap_open(db_tdb, name, hash_size, tdb_flags,\n+\t\t\t\t     open_flags, mode);\n+\tif (db_tdb->wtdb == NULL) {\n \t\tDEBUG(3, (\"Could not open tdb: %s\\n\", strerror(errno)));\n \t\tgoto fail;\n \t}\n \n-\ttalloc_set_destructor(db_tdb, db_tdb_ctx_destr);\n \tresult->fetch_locked = db_tdb_fetch_locked;\n \tresult->traverse = db_tdb_traverse;\n \tresult->traverse_read = db_tdb_traverse_read;\n\n=== modified file 'source/nsswitch/winbindd_cache.c'\n--- a/source/nsswitch/winbindd_cache.c\t2007-06-01 18:46:00 +0000\n+++ b/source/nsswitch/winbindd_cache.c\t2007-06-02 21:15:52 +0000\n@@ -133,9 +133,6 @@\n static struct winbind_cache *get_cache(struct winbindd_domain *domain)\n {\n \tstruct winbind_cache *ret = wcache;\n-#ifdef HAVE_ADS\n-\tstruct winbindd_domain *our_domain = domain;\n-#endif\n \n \t/* We have to know what type of domain we are dealing with first. */\n \n@@ -163,6 +160,8 @@\n \n \tif (!domain->backend) {\n #ifdef HAVE_ADS\n+\t\tstruct winbindd_domain *our_domain = domain;\n+\n \t\t/* find our domain first so we can figure out if we \n \t\t   are joined to a kerberized domain */\n \n@@ -171,7 +170,7 @@\n \n \t\tif ((our_domain->active_directory || IS_DC)\n \t\t    && domain->active_directory\n-\t\t    && lp_parm_bool(-1, \"winbind\", \"ads\", True)) {\n+\t\t    && !lp_parm_bool(-1, \"winbind\", \"rpc only\", False)) {\n \t\t\tDEBUG(5,(\"get_cache: Setting ADS methods for domain %s\\n\", domain->name));\n \t\t\tdomain->backend = &ads_methods;\n \t\t} else {\n\n"}