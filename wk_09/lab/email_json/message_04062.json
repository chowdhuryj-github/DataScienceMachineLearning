{"category": "ham", "to_address": "samba-cvs@samba.org", "from_address": "jra@samba.org", "subject": "svn commit: samba r22207 - in branches/SAMBA_3_0/source/nsswitch: .", "body": "Author: jra\nDate: 2007-04-13 01:46:47 +0000 (Fri, 13 Apr 2007)\nNew Revision: 22207\n\nWebSVN: http://websvn.samba.org/cgi-bin/viewcvs.cgi?view=rev&root=samba&rev=22207\n\nLog:\nFill in the validation functions. Now to test...\nJeremy.\n\nModified:\n   branches/SAMBA_3_0/source/nsswitch/winbindd_cache.c\n\n\nChangeset:\nModified: branches/SAMBA_3_0/source/nsswitch/winbindd_cache.c\n===================================================================\n--- branches/SAMBA_3_0/source/nsswitch/winbindd_cache.c\t2007-04-13 01:00:44 UTC (rev 22206)\n+++ branches/SAMBA_3_0/source/nsswitch/winbindd_cache.c\t2007-04-13 01:46:47 UTC (rev 22207)\n@@ -2757,7 +2757,11 @@\n \t\treturn 1;\n \t}\n \n-\t/* FIXME - fill in details here... */\n+\t(void)centry_uint16(centry);\n+\t(void)centry_uint16(centry);\n+\t(void)centry_uint32(centry);\n+\t(void)centry_nttime(centry);\n+\t(void)centry_nttime(centry);\n \n \tcentry_free(centry);\n \n@@ -2776,8 +2780,14 @@\n \t\treturn 1;\n \t}\n \n-\t/* FIXME - fill in details here... */\n+\t(void)centry_time(centry);\n+\t(void)centry_hash16(centry, mem_ctx);\n \n+\t/* We only have 17 bytes more data in the salted cred case. */\n+\tif (centry->len - centry->ofs == 17) {\n+\t\t(void)centry_hash16(centry, mem_ctx);\n+\t}\n+\n \tcentry_free(centry);\n \n \tif (bad_cache_entry) {\n@@ -2790,13 +2800,24 @@\n static int validate_ul(TALLOC_CTX *mem_ctx, const char *keystr, TDB_DATA dbuf)\n {\n \tstruct cache_entry *centry = create_centry_validate(keystr, dbuf);\n+\tint32 num_entries, i;\n \n \tif (!centry) {\n \t\treturn 1;\n \t}\n \n-\t/* FIXME - fill in details here... */\n+\tnum_entries = (int32)centry_uint32(centry);\n \n+\tfor (i=0; i< num_entries; i++) {\n+\t\tDOM_SID sid;\n+\t\t(void)centry_string(centry, mem_ctx);\n+\t\t(void)centry_string(centry, mem_ctx);\n+\t\t(void)centry_string(centry, mem_ctx);\n+\t\t(void)centry_string(centry, mem_ctx);\n+\t\t(void)centry_sid(centry, mem_ctx, &sid);\n+\t\t(void)centry_sid(centry, mem_ctx, &sid);\n+\t}\n+\n \tcentry_free(centry);\n \n \tif (bad_cache_entry) {\n@@ -2809,12 +2830,19 @@\n static int validate_gl(TALLOC_CTX *mem_ctx, const char *keystr, TDB_DATA dbuf)\n {\n \tstruct cache_entry *centry = create_centry_validate(keystr, dbuf);\n+\tint32 num_entries, i;\n \n \tif (!centry) {\n \t\treturn 1;\n \t}\n \n-\t/* FIXME - fill in details here... */\n+\tnum_entries = centry_uint32(centry);\n+\t\n+\tfor (i=0; i< num_entries; i++) {\n+\t\t(void)centry_string(centry, mem_ctx);\n+\t\t(void)centry_string(centry, mem_ctx);\n+\t\t(void)centry_uint32(centry);\n+\t}\n \n \tcentry_free(centry);\n \n@@ -2828,13 +2856,19 @@\n static int validate_ug(TALLOC_CTX *mem_ctx, const char *keystr, TDB_DATA dbuf)\n {\n \tstruct cache_entry *centry = create_centry_validate(keystr, dbuf);\n+\tint32 num_groups, i;\n \n \tif (!centry) {\n \t\treturn 1;\n \t}\n \n-\t/* FIXME - fill in details here... */\n+\tnum_groups = centry_uint32(centry);\n \n+\tfor (i=0; i< num_groups; i++) {\n+\t\tDOM_SID sid;\n+\t\tcentry_sid(centry, mem_ctx, &sid);\n+\t}\n+\n \tcentry_free(centry);\n \n \tif (bad_cache_entry) {\n@@ -2847,13 +2881,18 @@\n static int validate_ua(TALLOC_CTX *mem_ctx, const char *keystr, TDB_DATA dbuf)\n {\n \tstruct cache_entry *centry = create_centry_validate(keystr, dbuf);\n+\tint32 num_aliases, i;\n \n \tif (!centry) {\n \t\treturn 1;\n \t}\n \n-\t/* FIXME - fill in details here... */\n+\tnum_aliases = centry_uint32(centry);\n \n+\tfor (i=0; i < num_aliases; i++) {\n+\t\t(void)centry_uint32(centry);\n+\t}\n+\n \tcentry_free(centry);\n \n \tif (bad_cache_entry) {\n@@ -2866,13 +2905,21 @@\n static int validate_gm(TALLOC_CTX *mem_ctx, const char *keystr, TDB_DATA dbuf)\n {\n \tstruct cache_entry *centry = create_centry_validate(keystr, dbuf);\n+\tint32 num_names, i;\n \n \tif (!centry) {\n \t\treturn 1;\n \t}\n \n-\t/* FIXME - fill in details here... */\n+\tnum_names = centry_uint32(centry);\n \n+\tfor (i=0; i< num_names; i++) {\n+\t\tDOM_SID sid;\n+\t\tcentry_sid(centry, mem_ctx, &sid);\n+\t\t(void)centry_string(centry, mem_ctx);\n+\t\t(void)centry_uint32(centry);\n+\t}\n+\n \tcentry_free(centry);\n \n \tif (bad_cache_entry) {\n@@ -2884,38 +2931,28 @@\n \n static int validate_dr(TALLOC_CTX *mem_ctx, const char *keystr, TDB_DATA dbuf)\n {\n-\tstruct cache_entry *centry = create_centry_validate(keystr, dbuf);\n-\n-\tif (!centry) {\n+\t/* Can't say anything about this other than must be nonzero. */\n+\tif (dbuf.dsize == 0) {\n+\t\tDEBUG(0,(\"validate_dr: Corrupt cache for key %s (len == 0) ?\\n\",\n+\t\t\t\tkeystr));\n+\t\tbad_cache_entry = True;\n \t\treturn 1;\n \t}\n \n-\t/* FIXME - fill in details here... */\n-\n-\tcentry_free(centry);\n-\n-\tif (bad_cache_entry) {\n-\t\treturn 1;\n-\t}\n \tDEBUG(10,(\"validate_dr: %s ok\\n\", keystr));\n \treturn 0;\n }\n \n static int validate_de(TALLOC_CTX *mem_ctx, const char *keystr, TDB_DATA dbuf)\n {\n-\tstruct cache_entry *centry = create_centry_validate(keystr, dbuf);\n-\n-\tif (!centry) {\n+\t/* Can't say anything about this other than must be nonzero. */\n+\tif (dbuf.dsize == 0) {\n+\t\tDEBUG(0,(\"validate_de: Corrupt cache for key %s (len == 0) ?\\n\",\n+\t\t\t\tkeystr));\n+\t\tbad_cache_entry = True;\n \t\treturn 1;\n \t}\n \n-\t/* FIXME - fill in details here... */\n-\n-\tcentry_free(centry);\n-\n-\tif (bad_cache_entry) {\n-\t\treturn 1;\n-\t}\n \tDEBUG(10,(\"validate_de: %s ok\\n\", keystr));\n \treturn 0;\n }\n@@ -2923,12 +2960,20 @@\n static int validate_trustdoms(TALLOC_CTX *mem_ctx, const char *keystr, TDB_DATA dbuf)\n {\n \tstruct cache_entry *centry = create_centry_validate(keystr, dbuf);\n+\tint32 num_domains, i;\n \n \tif (!centry) {\n \t\treturn 1;\n \t}\n \n-\t/* FIXME - fill in details here... */\n+\tnum_domains = centry_uint32(centry);\n+\t\n+\tfor (i=0; i< num_domains; i++) {\n+\t\tDOM_SID sid;\n+\t\t(void)centry_string(centry, mem_ctx);\n+\t\t(void)centry_string(centry, mem_ctx);\n+\t\t(void)centry_sid(centry, mem_ctx, &sid);\n+\t}\n \n \tcentry_free(centry);\n \n\n"}