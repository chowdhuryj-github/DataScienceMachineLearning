{"category": "ham", "to_address": "Volker.Lendecke@SerNet.DE", "from_address": "tridge@samba.org", "subject": "posix locking and the brlock database", "body": "Volker,\n\nI just came across what I think is a generic problem with the Samba3\nbrlock code. \n\nImagine you have \"posix locking = yes\", and a NFS client or local unix\napp has a file locked for a short time.\n\nWhile the file is locked, a windows client tries to get the lock. It\nwill check the posix lock in brlock.c, and see that it can't get the\nlock, so it puts in a pending lock entry in the brlock.tdb record for\nthat file.\n\nThen the NFS client or local unix application releases the byte range\nlock. What triggers the retry of the pending lock? We don't get any\nnotification from the kernel, and we don't retry internally.\n\nThis is only a problem for timed locks with long timeouts of\ncourse. They aren't common, but it would be nice to handle them.\n\nPerhaps we need a timer which re-scans our pending lock list and\nretries those that were denied by posix locks at regular\nintervals. Maybe once every 10 seconds or so.\n\nCheers, Tridge\n\n"}