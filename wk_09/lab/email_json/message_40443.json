{"category": "ham", "to_address": "samba-cvs@samba.org", "from_address": "tridge@samba.org", "subject": "Rev 424: added nfs event script in http://samba.org/~tridge/ctdb", "body": "------------------------------------------------------------\nrevno: 424\nrevision-id: tridge@samba.org-20070601141022-6r6bw0fas6x14vzn\nparent: tridge@samba.org-20070601133301-rtnxemka2ry7cw4e\ncommitter: Andrew Tridgell \nbranch nick: tridge\ntimestamp: Sat 2007-06-02 00:10:22 +1000\nmessage:\n  added nfs event script\nadded:\n  tools/events.d/nfs             nfs-20070601141008-hy3h4qgbk1jd2jci-1\nmodified:\n  tools/events.d/samba           samba-20070601105340-vlcvnp6euoj3zdwy-3\n=== added file 'tools/events.d/nfs'\n--- a/tools/events.d/nfs\t1970-01-01 00:00:00 +0000\n+++ b/tools/events.d/nfs\t2007-06-01 14:10:22 +0000\n@@ -0,0 +1,36 @@\n+#!/bin/sh\n+# script to manage nfs in a clustered environment\n+\n+. /etc/sysconfig/ctdb\n+. /etc/ctdb/functions\n+\n+cmd=\"$1\"\n+shift\n+\n+case $cmd in \n+     startup)\n+\tmkdir -p /etc/ctdb/state/nfs\n+\t;;\n+\n+     releaseip)\n+\tiface=$1\n+\tip=$2\n+\tmaskbits=$3\n+\n+\techo $ip >> /etc/ctdb/state/nfs/restart\n+\texit 0\n+\t;;\n+\n+     recovered)\n+        # restart NFS to ensure that all TCP connections to the released ip\n+\t# are closed\n+\t[ -f /etc/ctdb/state/nfs/restart ] && {\n+\t\t( /sbin/service nfs status > /dev/null 2>&1 && \n+                      /sbin/service nfs restart > /dev/null 2>&1 ) &\n+\t} > /dev/null 2>&1\n+\t/bin/rm -f /etc/ctdb/state/nfs/restart\n+\t;;\n+\n+esac\n+\n+exit 0\n\n=== modified file 'tools/events.d/samba'\n--- a/tools/events.d/samba\t2007-06-01 13:25:33 +0000\n+++ b/tools/events.d/samba\t2007-06-01 14:10:22 +0000\n@@ -34,9 +34,8 @@\n \t;;\n \n      shutdown)\n-\t# shutdown Samba cleanly when ctdb goes down\n-\t/etc/init.d/smb stop\n-\t/etc/init.d/winbind stop\n+\t# shutdown Samba when ctdb goes down\n+\tkillall -q smbd nmbd winbindd\n \t;;\n esac\n \n\n"}