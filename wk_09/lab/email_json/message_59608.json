{"category": "ham", "to_address": "samba-technical@lists.samba.org", "from_address": "seatec <seatec-astronomy@gmx.de>", "subject": "win2k3 to win98", "body": "Hi everyone,\n\nafter talking to Kai Blin on irc for half a night and part of the day he\npointed me to the list.\n\nI wrote a little pseudo-cifs server about 2 years ago, which works fine\nfor smbclient, XP (SP2) and others. It doesn't offer much, but it\nnegotiates the challenge/response authentication scheme\n\nThe client password gets uppercased, padded with zeros to 14 bytes,\nsplit into two halves of 7 bytes, 2 eight byte DES keys are created out\nof those. These 2 keys are used to encrypt a static string -> 2 LM hashes.\nThose two 16 byte lm hashes are padded with 5 zeros to 21 bytes, split\ninto 3 chunks, DES key creation, those are used to encrypt the challenge\n-> 24 byte ntlm hash. Thats the scheme we are talking about.\n\n2 nights ago I noticed it doesnt work for win2k3. Knowing the plaintext\npassword and seeing the challenge on the wire, I can create the hash,\nand I can see smbclient or XP send exactly what I created. Win2k3 also\nsends a 24 byte hash, but that one is completely off.\n\nWhats even more strange: I setup a win98 in vmware and made win2k3\nconnect to a share. I see the whole session negotiation, challenge/hash\nexchange and everything, and again the hash \"should be\" different than\nwin2k3 is sending. But not only is the hash I see on the wire different,\nwin98 even accepts that hash and allows the client to log in with it.\n\nI don't have the slightest idea what kind of hash win2k3 is sending, and\nwhy it works.\n\nLast night I compared the pcap of a winxp logging into my little pseudo\nserver with a win2k3 logging in. Both clients send the same flags, the\nsame fields(different account and machine names. but that shouldnt\nmatter), the same everything. As the plaintext password is the same and\nthe challenge for this testcase was static, they should both send the\nsame hash. smbclient sends what xp sends. win2k3 also sends a 24 byte\nhash, but it's different.\n\nIf anyone could tell me what kind of hash win2k3 is sending there I'd be\n grateful. I can provide pcaps, plaintext password, hash, session\nkey(challenge), ...\n\n\nseatec\n\n"}