{"category": "ham", "to_address": "samba-cvs@samba.org", "from_address": "tridge@samba.org", "subject": "Rev 397: wait for local tcp services like smbd to come up before\n\tallowing ctdb to start talking to other nodes in\n\thttp://samba.org/~tridge/ctdb", "body": "------------------------------------------------------------\nrevno: 397\nrevision-id: tridge@samba.org-20070530022758-26c4o6952lel86gt\nparent: tridge@samba.org-20070530011752-x8gi0mp8otg937uu\ncommitter: Andrew Tridgell \nbranch nick: tridge\ntimestamp: Wed 2007-05-30 12:27:58 +1000\nmessage:\n  wait for local tcp services like smbd to come up before allowing ctdb to start talking to other nodes\nmodified:\n  common/ctdb_daemon.c           ctdb_daemon.c-20070409200331-3el1kqgdb9m4ib0g-1\n  tools/events                   events-20070529030121-04fjh63cxfh8v1pj-1\n=== modified file 'common/ctdb_daemon.c'\n--- a/common/ctdb_daemon.c\t2007-05-29 07:23:29 +0000\n+++ b/common/ctdb_daemon.c\t2007-05-30 02:27:58 +0000\n@@ -50,6 +50,12 @@\n \t\treturn;\n \t}\n \n+\tret = ctdb_event_script(ctdb, \"startup\");\n+\tif (ret != 0) {\n+\t\tDEBUG(0,(\"Failed startup event script\\n\"));\n+\t\treturn;\n+\t}\n+\n \t/* start the transport running */\n \tif (ctdb->methods->start(ctdb) != 0) {\n \t\tDEBUG(0,(\"transport failed to start!\\n\"));\n\n=== modified file 'tools/events'\n--- a/tools/events\t2007-05-30 00:21:16 +0000\n+++ b/tools/events\t2007-05-30 02:27:58 +0000\n@@ -1,10 +1,28 @@\n #!/bin/sh\n # sample event script for ctdb\n \n+. /etc/sysconfig/ctdb\n+\n cmd=\"$1\"\n shift\n \n case $cmd in \n+     startup)\n+\t# wait for local services to come up\n+\t[ -z \"$CTDB_WAIT_TCP_PORTS\" ] || {\n+\t  all_ok=0\n+\t  while [ $all_ok -eq 0 ]; do\n+\t  \t  all_ok=1\n+\t  \t  for p in $CTDB_WAIT_TCP_PORTS; do\n+\t  \t      /usr/bin/nc -z 127.0.0.1 $p || all_ok=0\n+\t\t  done\n+\t\t  [ $all_ok -eq 1 ] || sleep 1\n+          done\n+\t  echo \"Local services on $CTDB_WAIT_TCP_PORTS are up\"\n+\t}\n+\texit 0;\t\n+\t;;\n+\t\n      takeip)\n \tif [ $# != 3 ]; then\n \t   echo \"must supply interface, IP and maskbits\"\n@@ -13,6 +31,7 @@\n \tiface=$1\n \tip=$2\n \tmaskbits=$3\n+\n \t/sbin/ip addr add $ip/$maskbits dev $iface || {\n \t\t echo \"Failed to add $ip/$maskbits on dev $iface\"\n \t\t exit 1\n\n"}