{"category": "ham", "to_address": "samba-cvs@samba.org", "from_address": "vlendec@samba.org", "subject": "svn commit: samba r22895 - in branches: SAMBA_3_0/source/nsswitch\n\tSAMBA_3_0/source/printing SAMBA_3_0/source/rpc_server\n\tSAMBA_3_0_26/source/nsswitch SAMBA_3_0_26/source/printing\n\tSAMBA_3_0_26/source/rpc_server", "body": "Author: vlendec\nDate: 2007-05-15 10:50:44 +0000 (Tue, 15 May 2007)\nNew Revision: 22895\n\nWebSVN: http://websvn.samba.org/cgi-bin/viewcvs.cgi?view=rev&root=samba&rev=22895\n\nLog:\nConvert some more calls from message_send_buf to messaging_send_buf\n\nModified:\n   branches/SAMBA_3_0/source/nsswitch/winbindd.c\n   branches/SAMBA_3_0/source/nsswitch/winbindd_cm.c\n   branches/SAMBA_3_0/source/nsswitch/winbindd_dual.c\n   branches/SAMBA_3_0/source/printing/printing.c\n   branches/SAMBA_3_0/source/rpc_server/srv_spoolss_nt.c\n   branches/SAMBA_3_0/source/rpc_server/srv_srvsvc_nt.c\n   branches/SAMBA_3_0_26/source/nsswitch/winbindd.c\n   branches/SAMBA_3_0_26/source/nsswitch/winbindd_cm.c\n   branches/SAMBA_3_0_26/source/nsswitch/winbindd_dual.c\n   branches/SAMBA_3_0_26/source/printing/printing.c\n   branches/SAMBA_3_0_26/source/rpc_server/srv_spoolss_nt.c\n   branches/SAMBA_3_0_26/source/rpc_server/srv_srvsvc_nt.c\n\n\nChangeset:\nModified: branches/SAMBA_3_0/source/nsswitch/winbindd.c\n===================================================================\n--- branches/SAMBA_3_0/source/nsswitch/winbindd.c\t2007-05-15 10:50:25 UTC (rev 22894)\n+++ branches/SAMBA_3_0/source/nsswitch/winbindd.c\t2007-05-15 10:50:44 UTC (rev 22895)\n@@ -44,6 +44,17 @@\n \treturn ctx;\n }\n \n+struct messaging_context *winbind_messaging_context(void)\n+{\n+\tstatic struct messaging_context *ctx;\n+\n+\tif (!ctx && !(ctx = messaging_init(NULL, server_id_self(),\n+\t\t\t\t\t   winbind_event_context()))) {\n+\t\tsmb_panic(\"Could not init winbind messaging context\\n\");\n+\t}\n+\treturn ctx;\n+}\n+\n /* Reload configuration */\n \n static BOOL reload_services_file(void)\n\nModified: branches/SAMBA_3_0/source/nsswitch/winbindd_cm.c\n===================================================================\n--- branches/SAMBA_3_0/source/nsswitch/winbindd_cm.c\t2007-05-15 10:50:25 UTC (rev 22894)\n+++ branches/SAMBA_3_0/source/nsswitch/winbindd_cm.c\t2007-05-15 10:50:44 UTC (rev 22895)\n@@ -219,18 +219,22 @@\n \n \tif ((!get_dcs(mem_ctx, domain, &dcs, &num_dcs)) || (num_dcs == 0)) {\n \t\t/* Still offline ? Can't find DC's. */\n-\t\tmessage_send_pid(pid_to_procid(parent_pid), MSG_WINBIND_FAILED_TO_GO_ONLINE,\n-\t\t\t\tdomain->name,\n-\t\t\t\tstrlen(domain->name)+1, False);\n+\t\tmessaging_send_buf(winbind_messaging_context(),\n+\t\t\t\t   pid_to_procid(parent_pid),\n+\t\t\t\t   MSG_WINBIND_FAILED_TO_GO_ONLINE,\n+\t\t\t\t   (uint8 *)domain->name,\n+\t\t\t\t   strlen(domain->name)+1);\n \t\t_exit(0);\n \t}\n \n \t/* We got a DC. Send a message to our parent to get it to\n \t   try and do the same. */\n \n-\tmessage_send_pid(pid_to_procid(parent_pid), MSG_WINBIND_TRY_TO_GO_ONLINE,\n-\t\t\t\tdomain->name,\n-\t\t\t\tstrlen(domain->name)+1, False);\n+\tmessaging_send_buf(winbind_messaging_context(),\n+\t\t\t   pid_to_procid(parent_pid),\n+\t\t\t   MSG_WINBIND_TRY_TO_GO_ONLINE,\n+\t\t\t   (uint8 *)domain->name,\n+\t\t\t   strlen(domain->name)+1);\n \t_exit(0);\n }\n \n@@ -358,11 +362,11 @@\n \t\tstruct winbindd_child *idmap = idmap_child();\n \t\t\n \t\tif ( idmap->pid != 0 ) {\n-\t\t\tmessage_send_pid(pid_to_procid(idmap->pid), \n-\t\t\t\t\t MSG_WINBIND_OFFLINE, \n-\t\t\t\t\t domain->name, \n-\t\t\t\t\t strlen(domain->name)+1, \n-\t\t\t\t\t False);\n+\t\t\tmessaging_send_buf(winbind_messaging_context(),\n+\t\t\t\t\t   pid_to_procid(idmap->pid), \n+\t\t\t\t\t   MSG_WINBIND_OFFLINE, \n+\t\t\t\t\t   (uint8 *)domain->name, \n+\t\t\t\t\t   strlen(domain->name)+1);\n \t\t}\t\t\t\n \t}\n \n@@ -435,11 +439,11 @@\n \t\tstruct winbindd_child *idmap = idmap_child();\n \t\t\n \t\tif ( idmap->pid != 0 ) {\n-\t\t\tmessage_send_pid(pid_to_procid(idmap->pid), \n-\t\t\t\t\t MSG_WINBIND_ONLINE, \n-\t\t\t\t\t domain->name, \n-\t\t\t\t\t strlen(domain->name)+1, \n-\t\t\t\t\t False);\n+\t\t\tmessaging_send_buf(winbind_messaging_context(),\n+\t\t\t\t\t   pid_to_procid(idmap->pid), \n+\t\t\t\t\t   MSG_WINBIND_ONLINE, \n+\t\t\t\t\t   (uint8 *)domain->name, \n+\t\t\t\t\t   strlen(domain->name)+1);\n \t\t}\t\t\t\n \t}\n \n\nModified: branches/SAMBA_3_0/source/nsswitch/winbindd_dual.c\n===================================================================\n--- branches/SAMBA_3_0/source/nsswitch/winbindd_dual.c\t2007-05-15 10:50:25 UTC (rev 22894)\n+++ branches/SAMBA_3_0/source/nsswitch/winbindd_dual.c\t2007-05-15 10:50:44 UTC (rev 22895)\n@@ -524,8 +524,11 @@\n \t\tDEBUG(10,(\"winbind_msg_offline: sending message to pid %u for domain %s.\\n\",\n \t\t\t(unsigned int)child->pid, domain->name ));\n \n-\t\tmessage_send_pid(pid_to_procid(child->pid), MSG_WINBIND_OFFLINE, child->domain->name,\n-\t\t\tstrlen(child->domain->name)+1, False);\n+\t\tmessaging_send_buf(winbind_messaging_context(),\n+\t\t\t\t   pid_to_procid(child->pid),\n+\t\t\t\t   MSG_WINBIND_OFFLINE,\n+\t\t\t\t   (uint8 *)child->domain->name,\n+\t\t\t\t   strlen(child->domain->name)+1);\n \t}\n }\n \n@@ -567,11 +570,11 @@\n \t\t\tstruct winbindd_child *idmap = idmap_child();\n \t\t\t\n \t\t\tif ( idmap->pid != 0 ) {\n-\t\t\t\tmessage_send_pid(pid_to_procid(idmap->pid), \n-\t\t\t\t\t\t MSG_WINBIND_ONLINE,\n-\t\t\t\t\t\t domain->name,\n-\t\t\t\t\t\t strlen(domain->name)+1, \n-\t\t\t\t\t\t False);\n+\t\t\t\tmessaging_send_buf(winbind_messaging_context(),\n+\t\t\t\t\t\t   pid_to_procid(idmap->pid), \n+\t\t\t\t\t\t   MSG_WINBIND_ONLINE,\n+\t\t\t\t\t\t   (uint8 *)domain->name,\n+\t\t\t\t\t\t   strlen(domain->name)+1);\n \t\t\t}\n \t\t\t\n \t\t}\n@@ -594,8 +597,11 @@\n \t\tDEBUG(10,(\"winbind_msg_online: sending message to pid %u for domain %s.\\n\",\n \t\t\t(unsigned int)child->pid, child->domain->name ));\n \n-\t\tmessage_send_pid(pid_to_procid(child->pid), MSG_WINBIND_ONLINE, child->domain->name,\n-\t\t\tstrlen(child->domain->name)+1, False);\n+\t\tmessaging_send_buf(winbind_messaging_context(),\n+\t\t\t\t   pid_to_procid(child->pid),\n+\t\t\t\t   MSG_WINBIND_ONLINE,\n+\t\t\t\t   (uint8 *)child->domain->name,\n+\t\t\t\t   strlen(child->domain->name)+1);\n \t}\n }\n \n@@ -612,8 +618,10 @@\n \t\t\tDEBUG(10,(\"winbind_msg_onlinestatus: \"\n \t\t\t\t  \"sending message to pid %u of primary domain.\\n\",\n \t\t\t\t  (unsigned int)child->pid));\n-\t\t\tmessage_send_pid(pid_to_procid(child->pid), \n-\t\t\t\t\t MSG_WINBIND_ONLINESTATUS, buf, len, False);\n+\t\t\tmessaging_send_buf(winbind_messaging_context(),\n+\t\t\t\t\t   pid_to_procid(child->pid), \n+\t\t\t\t\t   MSG_WINBIND_ONLINESTATUS,\n+\t\t\t\t\t   (uint8 *)buf, len);\n \t\t\tbreak;\n \t\t}\n \t}\n@@ -791,8 +799,9 @@\n \t\treturn;\n \t}\n \n-\tmessage_send_pid(*sender, MSG_WINBIND_ONLINESTATUS, \n-\t\t\t message, strlen(message) + 1, True);\n+\tmessaging_send_buf(winbind_messaging_context(),\n+\t\t\t   *sender, MSG_WINBIND_ONLINESTATUS, \n+\t\t\t   (uint8 *)message, strlen(message) + 1);\n \n \ttalloc_destroy(mem_ctx);\n }\n\nModified: branches/SAMBA_3_0/source/printing/printing.c\n===================================================================\n--- branches/SAMBA_3_0/source/printing/printing.c\t2007-05-15 10:50:25 UTC (rev 22894)\n+++ branches/SAMBA_3_0/source/printing/printing.c\t2007-05-15 10:50:44 UTC (rev 22895)\n@@ -1535,8 +1535,9 @@\n \n \t/* finally send the message */\n \t\n-\tmessage_send_pid(pid_to_procid(background_lpq_updater_pid),\n-\t\t MSG_PRINTER_UPDATE, buffer, len, False);\n+\tmessaging_send_buf(smbd_messaging_context(),\n+\t\t\t   pid_to_procid(background_lpq_updater_pid),\n+\t\t\t   MSG_PRINTER_UPDATE, (uint8 *)buffer, len);\n \n \tSAFE_FREE( buffer );\n \n\nModified: branches/SAMBA_3_0/source/rpc_server/srv_spoolss_nt.c\n===================================================================\n--- branches/SAMBA_3_0/source/rpc_server/srv_spoolss_nt.c\t2007-05-15 10:50:25 UTC (rev 22894)\n+++ branches/SAMBA_3_0/source/rpc_server/srv_spoolss_nt.c\t2007-05-15 10:50:44 UTC (rev 22895)\n@@ -1212,8 +1212,9 @@\n \tDEBUG(10,(\"srv_spoolss_drv_upgrade_printer: Sending message about driver upgrade [%s]\\n\",\n \t\tdrivername));\n \t\t\n-\tmessage_send_pid(pid_to_procid(sys_getpid()),\n-\t\t\t MSG_PRINTER_DRVUPGRADE, drivername, len+1, False);\n+\tmessaging_send_buf(smbd_messaging_context(), procid_self(),\n+\t\t\t   MSG_PRINTER_DRVUPGRADE,\n+\t\t\t   (uint8 *)drivername, len+1);\n \n \treturn True;\n }\n@@ -1310,8 +1311,9 @@\n \tDEBUG(10,(\"srv_spoolss_reset_printerdata: Sending message about resetting printerdata [%s]\\n\",\n \t\tdrivername));\n \t\t\n-\tmessage_send_pid(pid_to_procid(sys_getpid()),\n-\t\t\t MSG_PRINTERDATA_INIT_RESET, drivername, len+1, False);\n+\tmessaging_send_buf(smbd_messaging_context(), procid_self(),\n+\t\t\t   MSG_PRINTERDATA_INIT_RESET,\n+\t\t\t   (uint8 *)drivername, len+1);\n \n \treturn True;\n }\n\nModified: branches/SAMBA_3_0/source/rpc_server/srv_srvsvc_nt.c\n===================================================================\n--- branches/SAMBA_3_0/source/rpc_server/srv_srvsvc_nt.c\t2007-05-15 10:50:25 UTC (rev 22894)\n+++ branches/SAMBA_3_0/source/rpc_server/srv_srvsvc_nt.c\t2007-05-15 10:50:44 UTC (rev 22895)\n@@ -1231,8 +1231,13 @@\n \n \t\tif ((strequal(session_list[snum].username, r->in.user) || r->in.user[0] == '\\0' ) &&\n \t\t     strequal(session_list[snum].remote_machine, machine)) {\n+\t\t\tNTSTATUS ntstat;\n+\n+\t\t\tntstat = messaging_send(smbd_messaging_context(),\n+\t\t\t\t\t\tsession_list[snum].pid,\n+\t\t\t\t\t\tMSG_SHUTDOWN, &data_blob_null);\n \t\t\n-\t\t\tif (NT_STATUS_IS_OK(message_send_pid(session_list[snum].pid, MSG_SHUTDOWN, NULL, 0, False)))\n+\t\t\tif (NT_STATUS_IS_OK(ntstat))\n \t\t\t\tstatus = WERR_OK;\n \t\t}\n \t}\n\nModified: branches/SAMBA_3_0_26/source/nsswitch/winbindd.c\n===================================================================\n--- branches/SAMBA_3_0_26/source/nsswitch/winbindd.c\t2007-05-15 10:50:25 UTC (rev 22894)\n+++ branches/SAMBA_3_0_26/source/nsswitch/winbindd.c\t2007-05-15 10:50:44 UTC (rev 22895)\n@@ -44,6 +44,17 @@\n \treturn ctx;\n }\n \n+struct messaging_context *winbind_messaging_context(void)\n+{\n+\tstatic struct messaging_context *ctx;\n+\n+\tif (!ctx && !(ctx = messaging_init(NULL, server_id_self(),\n+\t\t\t\t\t   winbind_event_context()))) {\n+\t\tsmb_panic(\"Could not init winbind messaging context\\n\");\n+\t}\n+\treturn ctx;\n+}\n+\n /* Reload configuration */\n \n static BOOL reload_services_file(void)\n\nModified: branches/SAMBA_3_0_26/source/nsswitch/winbindd_cm.c\n===================================================================\n--- branches/SAMBA_3_0_26/source/nsswitch/winbindd_cm.c\t2007-05-15 10:50:25 UTC (rev 22894)\n+++ branches/SAMBA_3_0_26/source/nsswitch/winbindd_cm.c\t2007-05-15 10:50:44 UTC (rev 22895)\n@@ -219,18 +219,22 @@\n \n \tif ((!get_dcs(mem_ctx, domain, &dcs, &num_dcs)) || (num_dcs == 0)) {\n \t\t/* Still offline ? Can't find DC's. */\n-\t\tmessage_send_pid(pid_to_procid(parent_pid), MSG_WINBIND_FAILED_TO_GO_ONLINE,\n-\t\t\t\tdomain->name,\n-\t\t\t\tstrlen(domain->name)+1, False);\n+\t\tmessaging_send_buf(winbind_messaging_context(),\n+\t\t\t\t   pid_to_procid(parent_pid),\n+\t\t\t\t   MSG_WINBIND_FAILED_TO_GO_ONLINE,\n+\t\t\t\t   (uint8 *)domain->name,\n+\t\t\t\t   strlen(domain->name)+1);\n \t\t_exit(0);\n \t}\n \n \t/* We got a DC. Send a message to our parent to get it to\n \t   try and do the same. */\n \n-\tmessage_send_pid(pid_to_procid(parent_pid), MSG_WINBIND_TRY_TO_GO_ONLINE,\n-\t\t\t\tdomain->name,\n-\t\t\t\tstrlen(domain->name)+1, False);\n+\tmessaging_send_buf(winbind_messaging_context(),\n+\t\t\t   pid_to_procid(parent_pid),\n+\t\t\t   MSG_WINBIND_TRY_TO_GO_ONLINE,\n+\t\t\t   (uint8 *)domain->name,\n+\t\t\t   strlen(domain->name)+1);\n \t_exit(0);\n }\n \n@@ -358,11 +362,11 @@\n \t\tstruct winbindd_child *idmap = idmap_child();\n \t\t\n \t\tif ( idmap->pid != 0 ) {\n-\t\t\tmessage_send_pid(pid_to_procid(idmap->pid), \n-\t\t\t\t\t MSG_WINBIND_OFFLINE, \n-\t\t\t\t\t domain->name, \n-\t\t\t\t\t strlen(domain->name)+1, \n-\t\t\t\t\t False);\n+\t\t\tmessaging_send_buf(winbind_messaging_context(),\n+\t\t\t\t\t   pid_to_procid(idmap->pid), \n+\t\t\t\t\t   MSG_WINBIND_OFFLINE, \n+\t\t\t\t\t   (uint8 *)domain->name, \n+\t\t\t\t\t   strlen(domain->name)+1);\n \t\t}\t\t\t\n \t}\n \n@@ -435,11 +439,11 @@\n \t\tstruct winbindd_child *idmap = idmap_child();\n \t\t\n \t\tif ( idmap->pid != 0 ) {\n-\t\t\tmessage_send_pid(pid_to_procid(idmap->pid), \n-\t\t\t\t\t MSG_WINBIND_ONLINE, \n-\t\t\t\t\t domain->name, \n-\t\t\t\t\t strlen(domain->name)+1, \n-\t\t\t\t\t False);\n+\t\t\tmessaging_send_buf(winbind_messaging_context(),\n+\t\t\t\t\t   pid_to_procid(idmap->pid), \n+\t\t\t\t\t   MSG_WINBIND_ONLINE, \n+\t\t\t\t\t   (uint8 *)domain->name, \n+\t\t\t\t\t   strlen(domain->name)+1);\n \t\t}\t\t\t\n \t}\n \n\nModified: branches/SAMBA_3_0_26/source/nsswitch/winbindd_dual.c\n===================================================================\n--- branches/SAMBA_3_0_26/source/nsswitch/winbindd_dual.c\t2007-05-15 10:50:25 UTC (rev 22894)\n+++ branches/SAMBA_3_0_26/source/nsswitch/winbindd_dual.c\t2007-05-15 10:50:44 UTC (rev 22895)\n@@ -524,8 +524,11 @@\n \t\tDEBUG(10,(\"winbind_msg_offline: sending message to pid %u for domain %s.\\n\",\n \t\t\t(unsigned int)child->pid, domain->name ));\n \n-\t\tmessage_send_pid(pid_to_procid(child->pid), MSG_WINBIND_OFFLINE, child->domain->name,\n-\t\t\tstrlen(child->domain->name)+1, False);\n+\t\tmessaging_send_buf(winbind_messaging_context(),\n+\t\t\t\t   pid_to_procid(child->pid),\n+\t\t\t\t   MSG_WINBIND_OFFLINE,\n+\t\t\t\t   (uint8 *)child->domain->name,\n+\t\t\t\t   strlen(child->domain->name)+1);\n \t}\n }\n \n@@ -567,11 +570,11 @@\n \t\t\tstruct winbindd_child *idmap = idmap_child();\n \t\t\t\n \t\t\tif ( idmap->pid != 0 ) {\n-\t\t\t\tmessage_send_pid(pid_to_procid(idmap->pid), \n-\t\t\t\t\t\t MSG_WINBIND_ONLINE,\n-\t\t\t\t\t\t domain->name,\n-\t\t\t\t\t\t strlen(domain->name)+1, \n-\t\t\t\t\t\t False);\n+\t\t\t\tmessaging_send_buf(winbind_messaging_context(),\n+\t\t\t\t\t\t   pid_to_procid(idmap->pid), \n+\t\t\t\t\t\t   MSG_WINBIND_ONLINE,\n+\t\t\t\t\t\t   (uint8 *)domain->name,\n+\t\t\t\t\t\t   strlen(domain->name)+1);\n \t\t\t}\n \t\t\t\n \t\t}\n@@ -594,8 +597,11 @@\n \t\tDEBUG(10,(\"winbind_msg_online: sending message to pid %u for domain %s.\\n\",\n \t\t\t(unsigned int)child->pid, child->domain->name ));\n \n-\t\tmessage_send_pid(pid_to_procid(child->pid), MSG_WINBIND_ONLINE, child->domain->name,\n-\t\t\tstrlen(child->domain->name)+1, False);\n+\t\tmessaging_send_buf(winbind_messaging_context(),\n+\t\t\t\t   pid_to_procid(child->pid),\n+\t\t\t\t   MSG_WINBIND_ONLINE,\n+\t\t\t\t   (uint8 *)child->domain->name,\n+\t\t\t\t   strlen(child->domain->name)+1);\n \t}\n }\n \n@@ -612,8 +618,10 @@\n \t\t\tDEBUG(10,(\"winbind_msg_onlinestatus: \"\n \t\t\t\t  \"sending message to pid %u of primary domain.\\n\",\n \t\t\t\t  (unsigned int)child->pid));\n-\t\t\tmessage_send_pid(pid_to_procid(child->pid), \n-\t\t\t\t\t MSG_WINBIND_ONLINESTATUS, buf, len, False);\n+\t\t\tmessaging_send_buf(winbind_messaging_context(),\n+\t\t\t\t\t   pid_to_procid(child->pid), \n+\t\t\t\t\t   MSG_WINBIND_ONLINESTATUS,\n+\t\t\t\t\t   (uint8 *)buf, len);\n \t\t\tbreak;\n \t\t}\n \t}\n@@ -791,8 +799,9 @@\n \t\treturn;\n \t}\n \n-\tmessage_send_pid(*sender, MSG_WINBIND_ONLINESTATUS, \n-\t\t\t message, strlen(message) + 1, True);\n+\tmessaging_send_buf(winbind_messaging_context(),\n+\t\t\t   *sender, MSG_WINBIND_ONLINESTATUS, \n+\t\t\t   (uint8 *)message, strlen(message) + 1);\n \n \ttalloc_destroy(mem_ctx);\n }\n\nModified: branches/SAMBA_3_0_26/source/printing/printing.c\n===================================================================\n--- branches/SAMBA_3_0_26/source/printing/printing.c\t2007-05-15 10:50:25 UTC (rev 22894)\n+++ branches/SAMBA_3_0_26/source/printing/printing.c\t2007-05-15 10:50:44 UTC (rev 22895)\n@@ -1538,8 +1538,9 @@\n \n \t/* finally send the message */\n \t\n-\tmessage_send_pid(pid_to_procid(background_lpq_updater_pid),\n-\t\t MSG_PRINTER_UPDATE, buffer, len, False);\n+\tmessaging_send_buf(smbd_messaging_context(),\n+\t\t\t   pid_to_procid(background_lpq_updater_pid),\n+\t\t\t   MSG_PRINTER_UPDATE, (uint8 *)buffer, len);\n \n \tSAFE_FREE( buffer );\n \n\nModified: branches/SAMBA_3_0_26/source/rpc_server/srv_spoolss_nt.c\n===================================================================\n--- branches/SAMBA_3_0_26/source/rpc_server/srv_spoolss_nt.c\t2007-05-15 10:50:25 UTC (rev 22894)\n+++ branches/SAMBA_3_0_26/source/rpc_server/srv_spoolss_nt.c\t2007-05-15 10:50:44 UTC (rev 22895)\n@@ -1204,8 +1204,9 @@\n \tDEBUG(10,(\"srv_spoolss_drv_upgrade_printer: Sending message about driver upgrade [%s]\\n\",\n \t\tdrivername));\n \t\t\n-\tmessage_send_pid(pid_to_procid(sys_getpid()),\n-\t\t\t MSG_PRINTER_DRVUPGRADE, drivername, len+1, False);\n+\tmessaging_send_buf(smbd_messaging_context(), procid_self(),\n+\t\t\t   MSG_PRINTER_DRVUPGRADE,\n+\t\t\t   (uint8 *)drivername, len+1);\n \n \treturn True;\n }\n@@ -1302,8 +1303,9 @@\n \tDEBUG(10,(\"srv_spoolss_reset_printerdata: Sending message about resetting printerdata [%s]\\n\",\n \t\tdrivername));\n \t\t\n-\tmessage_send_pid(pid_to_procid(sys_getpid()),\n-\t\t\t MSG_PRINTERDATA_INIT_RESET, drivername, len+1, False);\n+\tmessaging_send_buf(smbd_messaging_context(), procid_self(),\n+\t\t\t   MSG_PRINTERDATA_INIT_RESET,\n+\t\t\t   (uint8 *)drivername, len+1);\n \n \treturn True;\n }\n\nModified: branches/SAMBA_3_0_26/source/rpc_server/srv_srvsvc_nt.c\n===================================================================\n--- branches/SAMBA_3_0_26/source/rpc_server/srv_srvsvc_nt.c\t2007-05-15 10:50:25 UTC (rev 22894)\n+++ branches/SAMBA_3_0_26/source/rpc_server/srv_srvsvc_nt.c\t2007-05-15 10:50:44 UTC (rev 22895)\n@@ -1339,13 +1339,19 @@\n \n \t\tif ((strequal(session_list[snum].username, username) || username[0] == '\\0' ) &&\n \t\t    strequal(session_list[snum].remote_machine, machine)) {\n+\n+\t\t\tNTSTATUS ntstat;\n \t\t\n \t\t\tif (user.ut.uid != sec_initial_uid()) {\n \t\t\t\tnot_root = True;\n \t\t\t\tbecome_root();\n \t\t\t}\n \n-\t\t\tif (NT_STATUS_IS_OK(message_send_pid(session_list[snum].pid, MSG_SHUTDOWN, NULL, 0, False)))\n+\t\t\tntstat = messaging_send(smbd_messaging_context(),\n+\t\t\t\t\t\tsession_list[snum].pid,\n+\t\t\t\t\t\tMSG_SHUTDOWN, &data_blob_null);\n+\t\t\t\n+\t\t\tif (NT_STATUS_IS_OK(ntstat))\n \t\t\t\tr_u->status = WERR_OK;\n \n \t\t\tif (not_root) \n\n"}