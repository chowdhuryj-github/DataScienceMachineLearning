{"category": "ham", "to_address": "samba-cvs@samba.org", "from_address": "Michael Adam <ma@sernet.de>", "subject": "Rev 5348: merge from upstream in\n\thttp://samba.sernet.de/ma/bzr/SAMBA_3_0-registry.bzr/", "body": "At http://samba.sernet.de/ma/bzr/SAMBA_3_0-registry.bzr/\n\n------------------------------------------------------------\nrevno: 5348\nrevision-id: ma@sernet.de-20070411143428-49f14e3085db5e99\nparent: ma@sernet.de-20070410212018-6a54e7de1e2cc21b\nparent: jra@samba.org-20070411110342-vmenxo050isa4psg\ncommitter: Michael Adam \nbranch nick: SAMBA_3_0-registry.bzr\ntimestamp: Wed 2007-04-11 16:34:28 +0200\nmessage:\n  merge from upstream\nmodified:\n  REVISION                       REVISION-20060530022625-68239662668b41c3\n  source/client/client.c         client.c-20060530022627-a5e98bdfdd1ca9d9\n  source/include/smb_share_modes.h smb_share_modes.h-20060530073737-c8fce1dbe2345de9\n  source/libsmb/smb_share_modes.c smb_share_modes.c-20060530073738-d37c371a41d3c54a\n  source/nmbd/nmbd_subnetdb.c    nmbd_subnetdb.c-20060530022627-74c441c66a29c8c4\n  source/nsswitch/idmap.c        idmap.c-20061212152801-ke1ub3n5v1jjf8gy-1\n  source/nsswitch/idmap_ad.c     idmap_ad.c-20061212152802-3w9k6jbk4ef61xmv-1\n  source/rpc_parse/parse_prs.c   parse_prs.c-20060530022627-0ebae6d950fb538d\n  source/tdb/common/transaction.c transaction.c-20060823151029-6cd356e535b2baa2\n    ------------------------------------------------------------\n    merged: jra@samba.org-20070411110342-vmenxo050isa4psg\n    parent: jra@samba.org-20070411110155-o9ry9zx1awjiqayl\n    committer: jra@samba.org\n    branch nick: SAMBA_3_0.bzr\n    timestamp: Wed 2007-04-11 06:03:42 -0500\n    message:\n      jra@samba.org (r22164)  2007-04-11 00:27:00 -0500 (Wed, 11 Apr 2007)\n          \n          Fix missing lock count release in transaction cancel.\n          Found by Taj Khattra .\n          Jeremy.\n          \n    ------------------------------------------------------------\n    merged: jra@samba.org-20070411110155-o9ry9zx1awjiqayl\n    parent: jerry@samba.org-20070410231730-0adilk9fmoa50vc6\n    committer: jra@samba.org\n    branch nick: SAMBA_3_0.bzr\n    timestamp: Wed 2007-04-11 06:01:55 -0500\n    message:\n      jra@samba.org (r22163)  2007-04-11 00:05:33 -0500 (Wed, 11 Apr 2007)\n          \n          Pure reformatting. I hate 4 space tabstops :-).\n          Jeremy.\n          \n    ------------------------------------------------------------\n    merged: jerry@samba.org-20070410231730-0adilk9fmoa50vc6\n    parent: jerry@samba.org-20070410231555-1vf31cp6cvs7r5kz\n    committer: jerry@samba.org\n    branch nick: SAMBA_3_0.bzr\n    timestamp: Tue 2007-04-10 18:17:30 -0500\n    message:\n      jerry@samba.org (r22159)  2007-04-10 17:59:42 -0500 (Tue, 10 Apr 2007)\n          \n          BUG 4501 (second half of fix): Just disable the\n          uid/gid allocation if no idmap alloca backend has been \n          defined and we are not using a 3.0.24 idmap backend \n          compatible configuration.\n          \n          \n    ------------------------------------------------------------\n    merged: jerry@samba.org-20070410231555-1vf31cp6cvs7r5kz\n    parent: jra@samba.org-20070410231420-33x8mp3fbhfx8gn3\n    committer: jerry@samba.org\n    branch nick: SAMBA_3_0.bzr\n    timestamp: Tue 2007-04-10 18:15:55 -0500\n    message:\n      jerry@samba.org (r22158)  2007-04-10 16:14:44 -0500 (Tue, 10 Apr 2007)\n          \n          BUG 4501 (partial): Fix a crash caused by not using the \n          nss_info_{rfc2307,sfu} plugin with idmap_ad.\n          \n          \n    ------------------------------------------------------------\n    merged: jra@samba.org-20070410231420-33x8mp3fbhfx8gn3\n    parent: jra@samba.org-20070410231110-gqxo6ew39ujd803u\n    committer: jra@samba.org\n    branch nick: SAMBA_3_0.bzr\n    timestamp: Tue 2007-04-10 18:14:20 -0500\n    message:\n      jra@samba.org (r22157)  2007-04-10 15:35:30 -0500 (Tue, 10 Apr 2007)\n          \n          Fix bug #3634 - stop nmbd segfaulting with bad interface line.\n          Jeremy.\n          \n    ------------------------------------------------------------\n    merged: jra@samba.org-20070410231110-gqxo6ew39ujd803u\n    parent: jra@samba.org-20070410230833-e0t6woa3l9l5ozde\n    committer: jra@samba.org\n    branch nick: SAMBA_3_0.bzr\n    timestamp: Tue 2007-04-10 18:11:10 -0500\n    message:\n      jra@samba.org (r22155)  2007-04-10 13:21:37 -0500 (Tue, 10 Apr 2007)\n          \n          Fixed warning #4498 from jason@ncac.gwu.edu.\n          Jeremy.\n          \n    ------------------------------------------------------------\n    merged: jra@samba.org-20070410230833-e0t6woa3l9l5ozde\n    parent: metze@samba.org-20070410170757-9ky0kr0jt9elqesd\n    committer: jra@samba.org\n    branch nick: SAMBA_3_0.bzr\n    timestamp: Tue 2007-04-10 18:08:33 -0500\n    message:\n      jra@samba.org (r22154)  2007-04-10 13:12:25 -0500 (Tue, 10 Apr 2007)\n          \n          Make struct smbdb_ctx an opaque pointer so users of the API\n          don't need to have tdb.h.\n          Jeremy.\n          \n=== modified file 'REVISION'\n--- a/REVISION\t2007-04-10 17:07:57 +0000\n+++ b/REVISION\t2007-04-11 11:03:42 +0000\n@@ -2,9 +2,9 @@\n URL: svn+ssh://svn.samba.org/home/svn/samba/branches/SAMBA_3_0\n Repository Root: svn+ssh://svn.samba.org/home/svn/samba\n Repository UUID: 0c0555d6-39d7-0310-84fc-f1cc0bd64818\n-Revision: 22153\n+Revision: 22164\n Node Kind: directory\n-Last Changed Author: metze\n-Last Changed Rev: 22153\n-Last Changed Date: 2007-04-10 11:04:22 -0500 (Tue, 10 Apr 2007)\n+Last Changed Author: jra\n+Last Changed Rev: 22164\n+Last Changed Date: 2007-04-11 00:27:00 -0500 (Wed, 11 Apr 2007)\n \n\n=== modified file 'source/client/client.c'\n--- a/source/client/client.c\t2007-03-30 15:40:29 +0000\n+++ b/source/client/client.c\t2007-04-10 23:11:10 +0000\n@@ -4020,13 +4020,13 @@\n \t\t\t/* We must use old option processing for this. Find the\n \t\t\t * position of the -T option in the raw argv[]. */\n \t\t\t{\n-\t\t\t\tint i, optnum;\n+\t\t\t\tint i;\n \t\t\t\tfor (i = 1; i < argc; i++) {\n \t\t\t\t\tif (strncmp(\"-T\", argv[i],2)==0)\n \t\t\t\t\t\tbreak;\n \t\t\t\t}\n \t\t\t\ti++;\n-\t\t\t\tif (!(optnum = tar_parseargs(argc, argv, poptGetOptArg(pc), i))) {\n+\t\t\t\tif (!tar_parseargs(argc, argv, poptGetOptArg(pc), i)) {\n \t\t\t\t\tpoptPrintUsage(pc, stderr, 0);\n \t\t\t\t\texit(1);\n \t\t\t\t}\n\n=== modified file 'source/include/smb_share_modes.h'\n--- a/source/include/smb_share_modes.h\t2006-05-30 07:47:30 +0000\n+++ b/source/include/smb_share_modes.h\t2007-04-10 23:08:33 +0000\n@@ -33,12 +33,8 @@\n # endif\n #endif\n \n-#include \"tdb.h\"\n-\n-/* Database context handle. */\n-struct smbdb_ctx {\n-\tTDB_CONTEXT *smb_tdb;\n-};\n+/* Opaque database context handle. */\n+struct smbdb_ctx;\n \n /* Share mode entry. */\n /*\n\n=== modified file 'source/libsmb/smb_share_modes.c'\n--- a/source/libsmb/smb_share_modes.c\t2007-03-30 15:45:48 +0000\n+++ b/source/libsmb/smb_share_modes.c\t2007-04-10 23:08:33 +0000\n@@ -28,6 +28,11 @@\n #include \"includes.h\"\n #include \"smb_share_modes.h\"\n \n+/* Database context handle. */\n+struct smbdb_ctx {\n+\tTDB_CONTEXT *smb_tdb;\n+};\n+\n /* Remove the paranoid malloc checker. */\n #ifdef malloc\n #undef malloc\n\n=== modified file 'source/nmbd/nmbd_subnetdb.c'\n--- a/source/nmbd/nmbd_subnetdb.c\t2006-06-28 01:36:29 +0000\n+++ b/source/nmbd/nmbd_subnetdb.c\t2007-04-10 23:14:20 +0000\n@@ -223,6 +223,13 @@\n \t\t\treturn False;\n \t}\n \n+        /* We must have at least one subnet. */\n+\tif (subnetlist == NULL) {\n+\t\tDEBUG(0,(\"create_subnets: unable to create any subnet from \"\n+\t\t\t\t\"given interfaces. nmbd is terminating\\n\"));\n+\t\treturn False;\n+\t}\n+\n \tif (lp_we_are_a_wins_server()) {\n \t\t/* Pick the first interface ip address as the WINS server ip. */\n \t\tstruct in_addr *nip = iface_n_ip(0);\n\n=== modified file 'source/nsswitch/idmap.c'\n--- a/source/nsswitch/idmap.c\t2007-04-06 23:11:38 +0000\n+++ b/source/nsswitch/idmap.c\t2007-04-10 23:17:30 +0000\n@@ -259,7 +259,7 @@\n \tchar *compat_backend = NULL;\n \tchar *compat_params = NULL;\n \tconst char **dom_list = NULL;\n-\tchar *alloc_backend;\n+\tchar *alloc_backend = NULL;\n \tBOOL default_already_defined = False;\n \tBOOL pri_dom_is_in_list = False;\n \tint compat = 0;\n@@ -561,11 +561,11 @@\n \t}\n \n \n-\t/***************************\n-\t * initialize alloc module\n-\t */\n-\tDEBUG(1, (\"Initializing idmap alloc module\\n\"));\n-\n+\t/* Initialize alloc module */\n+\n+\tDEBUG(3, (\"Initializing idmap alloc module\\n\"));\n+\n+\talloc_backend = NULL;\n \tif (compat) {\n \t\talloc_backend = talloc_strdup(idmap_ctx, compat_backend);\n \t} else {\n@@ -573,11 +573,10 @@\n \t\t\n \t\tif (ab && (ab[0] != '\\0')) {\n \t\t\talloc_backend = talloc_strdup(idmap_ctx, lp_idmap_alloc_backend());\n-\t\t} else {\n-\t\t\talloc_backend = talloc_strdup(idmap_ctx, \"tdb\");\n \t\t}\n \t}\n-\tIDMAP_CHECK_ALLOC(alloc_backend);\n+\n+\tif ( alloc_backend ) {\n \n \talloc_methods = get_alloc_methods(alloc_backends, alloc_backend);\n \tif ( ! alloc_methods) {\n@@ -603,6 +602,7 @@\n \t\telse\n \t\t\tret = NT_STATUS_UNSUCCESSFUL;\n \t}\n+\t}\n \n \t/* cleanpu temporary strings */\n \tTALLOC_FREE( compat_backend );\n\n=== modified file 'source/nsswitch/idmap_ad.c'\n--- a/source/nsswitch/idmap_ad.c\t2007-04-06 23:11:38 +0000\n+++ b/source/nsswitch/idmap_ad.c\t2007-04-10 23:15:55 +0000\n@@ -164,14 +164,10 @@\n {\n \tstruct idmap_ad_context *ctx;\n \tchar *config_option;\n-\tconst char *range;\n+\tconst char *range = NULL;\n+\tconst char *schema_mode = NULL;\t\n \tADS_STRUCT *ads;\n \n-\t/* verify AD is reachable (not critical, we may just be offline at start) */\n-\tif ( (ads = ad_idmap_cached_connection()) == NULL ) {\n-\t\tDEBUG(1, (\"WARNING: Could not init an AD connection! Mapping might not work.\\n\"));\n-\t}\n-\n \tif ( (ctx = talloc_zero(dom, struct idmap_ad_context)) == NULL ) {\n \t\tDEBUG(0, (\"Out of memory!\\n\"));\n \t\treturn NT_STATUS_NO_MEMORY;\n@@ -194,6 +190,20 @@\n \t\t}\n \t}\n \n+\t/* schema mode */\n+\tif ( ad_map_type == WB_POSIX_MAP_UNKNOWN )\n+\t\tad_map_type = WB_POSIX_MAP_RFC2307;\n+\tschema_mode = lp_parm_const_string(-1, config_option, \"schema_mode\", NULL);\n+\tif ( schema_mode && schema_mode[0] ) {\n+\t\tif ( strequal(schema_mode, \"sfu\") )\n+\t\t\tad_map_type = WB_POSIX_MAP_SFU;\n+\t\telse if ( strequal(schema_mode, \"rfc2307\" ) )\n+\t\t\tad_map_type = WB_POSIX_MAP_RFC2307;\n+\t\telse\n+\t\t\tDEBUG(0,(\"idmap_ad_initialize: Unknown schema_mode (%s)\\n\",\n+\t\t\t\t schema_mode));\n+\t}\n+\n \tdom->private_data = ctx;\n \n \ttalloc_free(config_option);\n\n=== modified file 'source/rpc_parse/parse_prs.c'\n--- a/source/rpc_parse/parse_prs.c\t2007-03-30 15:43:31 +0000\n+++ b/source/rpc_parse/parse_prs.c\t2007-04-11 11:01:55 +0000\n@@ -1456,38 +1456,38 @@\n /* useful function to store a structure in rpc wire format */\n int tdb_prs_store(TDB_CONTEXT *tdb, TDB_DATA kbuf, prs_struct *ps)\n {\n-    TDB_DATA dbuf;\n-    dbuf.dptr = (uint8 *)ps->data_p;\n-    dbuf.dsize = prs_offset(ps);\n-    return tdb_trans_store(tdb, kbuf, dbuf, TDB_REPLACE);\n+\tTDB_DATA dbuf;\n+\tdbuf.dptr = (uint8 *)ps->data_p;\n+\tdbuf.dsize = prs_offset(ps);\n+\treturn tdb_trans_store(tdb, kbuf, dbuf, TDB_REPLACE);\n }\n \n int tdb_prs_store_bystring(TDB_CONTEXT *tdb, char *keystr, prs_struct *ps)\n {\n-    TDB_DATA kbuf = string_term_tdb_data(keystr);\n-    return tdb_prs_store(tdb, kbuf, ps);\n+\tTDB_DATA kbuf = string_term_tdb_data(keystr);\n+\treturn tdb_prs_store(tdb, kbuf, ps);\n }\n \n /* useful function to fetch a structure into rpc wire format */\n int tdb_prs_fetch(TDB_CONTEXT *tdb, TDB_DATA kbuf, prs_struct *ps, TALLOC_CTX *mem_ctx)\n {\n-    TDB_DATA dbuf;\n-\n-    prs_init(ps, 0, mem_ctx, UNMARSHALL);\n-\n-    dbuf = tdb_fetch(tdb, kbuf);\n-    if (!dbuf.dptr)\n-\t    return -1;\n-\n-    prs_give_memory(ps, (char *)dbuf.dptr, dbuf.dsize, True);\n-\n-    return 0;\n+\tTDB_DATA dbuf;\n+\n+\tprs_init(ps, 0, mem_ctx, UNMARSHALL);\n+\n+\tdbuf = tdb_fetch(tdb, kbuf);\n+\tif (!dbuf.dptr)\n+\t\treturn -1;\n+\n+\tprs_give_memory(ps, (char *)dbuf.dptr, dbuf.dsize, True);\n+\n+\treturn 0;\n } \n \n int tdb_prs_fetch_bystring(TDB_CONTEXT *tdb, char *keystr, prs_struct *ps, TALLOC_CTX *mem_ctx)\n {\n-    TDB_DATA kbuf = string_term_tdb_data(keystr);\n-    return tdb_prs_fetch(tdb, kbuf, ps, mem_ctx);\n+\tTDB_DATA kbuf = string_term_tdb_data(keystr);\n+\treturn tdb_prs_fetch(tdb, kbuf, ps, mem_ctx);\n }\n \n /*******************************************************************\n\n=== modified file 'source/tdb/common/transaction.c'\n--- a/source/tdb/common/transaction.c\t2007-04-02 23:02:06 +0000\n+++ b/source/tdb/common/transaction.c\t2007-04-11 11:03:42 +0000\n@@ -523,6 +523,8 @@\n \t\t\t\t   F_UNLCK,F_SETLKW, 0, 1);\n \t\t}\n \t\ttdb->num_locks = 0;\n+\t\ttdb->num_lockrecs = 0;\n+\t\tSAFE_FREE(tdb->lockrecs);\n \t}\n \n \t/* restore the normal io methods */\n\n"}