{"category": "ham", "to_address": "samba-cvs@samba.org", "from_address": "tridge@samba.org", "subject": "Rev 524: propogate flag changes to all connected nodes in\n\thttp://samba.org/~tridge/ctdb", "body": "------------------------------------------------------------\nrevno: 524\nrevision-id: tridge@samba.org-20070609115850-l2fqzlhyvl68lzrl\nparent: tridge@samba.org-20070609115747-u1bcpt53aa1sff1j\ncommitter: Andrew Tridgell \nbranch nick: tridge\ntimestamp: Sat 2007-06-09 21:58:50 +1000\nmessage:\n  propogate flag changes to all connected nodes\nmodified:\n  include/ctdb.h                 ctdb.h-20061117234101-o3qt14umlg9en8z0-11\n  server/ctdb_control.c          ctdb_control.c-20070426122724-j6gkpiofhbwdin63-1\n  server/ctdb_monitor.c          ctdb_monitor.c-20070518100625-8jf4ft1mjzmb22ck-1\n  server/ctdb_recoverd.c         recoverd.c-20070503213540-bvxuyd9jm1f7ig90-1\n  server/ctdb_server.c           ctdb.c-20061127094323-t50f58d65iaao5of-2\n  server/ctdb_traverse.c         ctdb_traverse.c-20070503021550-ztfs5rwx8jfm8qqx-1\n=== modified file 'include/ctdb.h'\n--- a/include/ctdb.h\t2007-06-07 06:34:33 +0000\n+++ b/include/ctdb.h\t2007-06-09 11:58:50 +0000\n@@ -93,6 +93,8 @@\n #define CTDB_BROADCAST_ALL    0xF0000002\n /* send a broadcast to all nodes in the current vnn map */\n #define CTDB_BROADCAST_VNNMAP 0xF0000003\n+/* send a broadcast to all connected nodes */\n+#define CTDB_BROADCAST_CONNECTED 0xF0000004\n \n \n struct event_context;\n\n=== modified file 'server/ctdb_control.c'\n--- a/server/ctdb_control.c\t2007-06-07 12:06:19 +0000\n+++ b/server/ctdb_control.c\t2007-06-09 11:58:50 +0000\n@@ -433,12 +433,17 @@\n \tstruct ctdb_control_state *state;\n \tsize_t len;\n \n-\tif (((destnode == CTDB_BROADCAST_VNNMAP) || (destnode == CTDB_BROADCAST_VNNMAP)) && !(flags & CTDB_CTRL_FLAG_NOREPLY)) {\n+\tif (((destnode == CTDB_BROADCAST_VNNMAP) || \n+\t     (destnode == CTDB_BROADCAST_ALL) ||\n+\t     (destnode == CTDB_BROADCAST_CONNECTED)) && \n+\t    !(flags & CTDB_CTRL_FLAG_NOREPLY)) {\n \t\tDEBUG(0,(\"Attempt to broadcast control without NOREPLY\\n\"));\n \t\treturn -1;\n \t}\n \n-\tif (destnode != CTDB_BROADCAST_VNNMAP && destnode != CTDB_BROADCAST_ALL && \n+\tif (destnode != CTDB_BROADCAST_VNNMAP && \n+\t    destnode != CTDB_BROADCAST_ALL && \n+\t    destnode != CTDB_BROADCAST_CONNECTED && \n \t    (!ctdb_validate_vnn(ctdb, destnode) || \n \t     (ctdb->nodes[destnode]->flags & NODE_FLAGS_DISCONNECTED))) {\n \t\tif (!(flags & CTDB_CTRL_FLAG_NOREPLY)) {\n\n=== modified file 'server/ctdb_monitor.c'\n--- a/server/ctdb_monitor.c\t2007-06-07 12:06:19 +0000\n+++ b/server/ctdb_monitor.c\t2007-06-09 11:58:50 +0000\n@@ -122,7 +122,7 @@\n \tdata.dsize = sizeof(c);\n \n \t/* tell the other nodes that something has changed */\n-\tctdb_daemon_send_message(ctdb, CTDB_BROADCAST_VNNMAP,\n+\tctdb_daemon_send_message(ctdb, CTDB_BROADCAST_CONNECTED,\n \t\t\t\t CTDB_SRVID_NODE_FLAGS_CHANGED, data);\n \n }\n@@ -213,7 +213,7 @@\n \tdata.dsize = sizeof(c);\n \n \t/* tell the other nodes that something has changed */\n-\tctdb_daemon_send_message(ctdb, CTDB_BROADCAST_VNNMAP,\n+\tctdb_daemon_send_message(ctdb, CTDB_BROADCAST_CONNECTED,\n \t\t\t\t CTDB_SRVID_NODE_FLAGS_CHANGED, data);\n \n \tif ((node->flags & NODE_FLAGS_BANNED) && !(old_flags & NODE_FLAGS_BANNED)) {\n\n=== modified file 'server/ctdb_recoverd.c'\n--- a/server/ctdb_recoverd.c\t2007-06-09 10:13:25 +0000\n+++ b/server/ctdb_recoverd.c\t2007-06-09 11:58:50 +0000\n@@ -392,7 +392,7 @@\n \t\tdata.dptr = (uint8_t *)&c\n \t\tdata.dsize = sizeof(c);\n \n-\t\tctdb_send_message(ctdb, CTDB_BROADCAST_VNNMAP,\n+\t\tctdb_send_message(ctdb, CTDB_BROADCAST_CONNECTED,\n \t\t\t\t  CTDB_SRVID_NODE_FLAGS_CHANGED, data);\n \n \t}\n\n=== modified file 'server/ctdb_server.c'\n--- a/server/ctdb_server.c\t2007-06-07 12:16:48 +0000\n+++ b/server/ctdb_server.c\t2007-06-09 11:58:50 +0000\n@@ -390,7 +390,8 @@\n /*\n   broadcast a packet to all nodes\n */\n-static void ctdb_broadcast_packet_all(struct ctdb_context *ctdb, struct ctdb_req_header *hdr)\n+static void ctdb_broadcast_packet_all(struct ctdb_context *ctdb, \n+\t\t\t\t      struct ctdb_req_header *hdr)\n {\n \tint i;\n \tfor (i=0;inum_nodes;i++) {\n@@ -402,7 +403,8 @@\n /*\n   broadcast a packet to all nodes in the current vnnmap\n */\n-static void ctdb_broadcast_packet_vnnmap(struct ctdb_context *ctdb, struct ctdb_req_header *hdr)\n+static void ctdb_broadcast_packet_vnnmap(struct ctdb_context *ctdb, \n+\t\t\t\t\t struct ctdb_req_header *hdr)\n {\n \tint i;\n \tfor (i=0;ivnn_map->size;i++) {\n@@ -412,6 +414,21 @@\n }\n \n /*\n+  broadcast a packet to all connected nodes\n+*/\n+static void ctdb_broadcast_packet_connected(struct ctdb_context *ctdb, \n+\t\t\t\t\t    struct ctdb_req_header *hdr)\n+{\n+\tint i;\n+\tfor (i=0;inum_nodes;i++) {\n+\t\tif (!(ctdb->nodes[i]->flags & NODE_FLAGS_DISCONNECTED)) {\n+\t\t\thdr->destnode = ctdb->nodes[i]->vnn;\n+\t\t\tctdb_queue_packet(ctdb, hdr);\n+\t\t}\n+\t}\n+}\n+\n+/*\n   queue a packet or die\n */\n void ctdb_queue_packet(struct ctdb_context *ctdb, struct ctdb_req_header *hdr)\n@@ -425,6 +442,9 @@\n \tcase CTDB_BROADCAST_VNNMAP:\n \t\tctdb_broadcast_packet_vnnmap(ctdb, hdr);\n \t\treturn;\n+\tcase CTDB_BROADCAST_CONNECTED:\n+\t\tctdb_broadcast_packet_connected(ctdb, hdr);\n+\t\treturn;\n \t}\n \n \tctdb->statistics.node_packets_sent++;\n\n=== modified file 'server/ctdb_traverse.c'\n--- a/server/ctdb_traverse.c\t2007-06-07 12:06:19 +0000\n+++ b/server/ctdb_traverse.c\t2007-06-09 11:58:50 +0000\n@@ -248,7 +248,8 @@\n \tdata.dsize = sizeof(r);\n \n \t/* tell all the nodes in the cluster to start sending records to this node */\n-\tret = ctdb_daemon_send_control(ctdb, CTDB_BROADCAST_VNNMAP, 0, CTDB_CONTROL_TRAVERSE_ALL,\n+\tret = ctdb_daemon_send_control(ctdb, CTDB_BROADCAST_VNNMAP, 0, \n+\t\t\t\t       CTDB_CONTROL_TRAVERSE_ALL,\n \t\t\t\t       0, CTDB_CTRL_FLAG_NOREPLY, data, NULL, NULL);\n \tif (ret != 0) {\n \t\ttalloc_free(state);\n\n"}