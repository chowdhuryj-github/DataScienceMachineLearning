{"category": "ham", "to_address": "samba-cvs@samba.org", "from_address": "gd@samba.org", "subject": "svn commit: samba r23588 - in branches: SAMBA_3_0/source/libsmb\n\tSAMBA_3_0_26/source/libsmb", "body": "Author: gd\nDate: 2007-06-22 14:54:39 +0000 (Fri, 22 Jun 2007)\nNew Revision: 23588\n\nWebSVN: http://websvn.samba.org/cgi-bin/viewcvs.cgi?view=rev&root=samba&rev=23588\n\nLog:\nSome more cleanups and error checks in the krb5 renew function.\n\nGuenther\n\nModified:\n   branches/SAMBA_3_0/source/libsmb/clikrb5.c\n   branches/SAMBA_3_0_26/source/libsmb/clikrb5.c\n\n\nChangeset:\nModified: branches/SAMBA_3_0/source/libsmb/clikrb5.c\n===================================================================\n--- branches/SAMBA_3_0/source/libsmb/clikrb5.c\t2007-06-22 14:50:15 UTC (rev 23587)\n+++ branches/SAMBA_3_0/source/libsmb/clikrb5.c\t2007-06-22 14:54:39 UTC (rev 23588)\n@@ -1151,6 +1151,11 @@\n \t\tccache_string = krb5_cc_default_name(context);\n \t}\n \n+\tif (!ccache_string) {\n+\t\tret = EINVAL;\n+\t\tgoto done;\n+\t}\n+\n \tDEBUG(10,(\"smb_krb5_renew_ticket: using %s as ccache\\n\", ccache_string));\n \n \t/* FIXME: we should not fall back to defaults */\n@@ -1175,6 +1180,8 @@\n \t{\n \t\tkrb5_creds creds;\n \n+\t\tZERO_STRUCT(creds);\n+\n \t\tret = krb5_get_renewed_creds(context, &creds, client, ccache, CONST_DISCARD(char *, service_string));\n \t\tif (ret) {\n \t\t\tDEBUG(10,(\"smb_krb5_renew_ticket: krb5_get_kdc_cred failed: %s\\n\", error_message(ret)));\n@@ -1202,7 +1209,7 @@\n \t\tkrb5_realm *client_realm;\n \t\tkrb5_creds *creds;\n \n-\t\tmemset(&creds_in, 0, sizeof(creds_in));\n+\t\tZERO_STRUCT(creds_in);\n \n \t\tret = krb5_copy_principal(context, client, &creds_in.client);\n \t\tif (ret) {\n@@ -1252,7 +1259,7 @@\n \t\tkrb5_free_creds(context, creds);\n \t}\n #else\n-#error NO_SUITABKE_KRB5_TICKET_RENEW_FUNCTION_AVAILABLE\n+#error NO_SUITABLE_KRB5_TICKET_RENEW_FUNCTION_AVAILABLE\n #endif\n \n \n@@ -1260,15 +1267,14 @@\n \tif (client) {\n \t\tkrb5_free_principal(context, client);\n \t}\n+\tif (ccache) {\n+\t\tkrb5_cc_close(context, ccache);\n+\t}\n \tif (context) {\n \t\tkrb5_free_context(context);\n \t}\n-\tif (ccache) {\n-\t\tkrb5_cc_close(context, ccache);\n-\t}\n \n \treturn ret;\n-    \n }\n \n  krb5_error_code smb_krb5_free_addresses(krb5_context context, smb_krb5_addresses *addr)\n\nModified: branches/SAMBA_3_0_26/source/libsmb/clikrb5.c\n===================================================================\n--- branches/SAMBA_3_0_26/source/libsmb/clikrb5.c\t2007-06-22 14:50:15 UTC (rev 23587)\n+++ branches/SAMBA_3_0_26/source/libsmb/clikrb5.c\t2007-06-22 14:54:39 UTC (rev 23588)\n@@ -1151,6 +1151,11 @@\n \t\tccache_string = krb5_cc_default_name(context);\n \t}\n \n+\tif (!ccache_string) {\n+\t\tret = EINVAL;\n+\t\tgoto done;\n+\t}\n+\n \tDEBUG(10,(\"smb_krb5_renew_ticket: using %s as ccache\\n\", ccache_string));\n \n \t/* FIXME: we should not fall back to defaults */\n@@ -1175,6 +1180,8 @@\n \t{\n \t\tkrb5_creds creds;\n \n+\t\tZERO_STRUCT(creds);\n+\n \t\tret = krb5_get_renewed_creds(context, &creds, client, ccache, CONST_DISCARD(char *, service_string));\n \t\tif (ret) {\n \t\t\tDEBUG(10,(\"smb_krb5_renew_ticket: krb5_get_kdc_cred failed: %s\\n\", error_message(ret)));\n@@ -1202,7 +1209,7 @@\n \t\tkrb5_realm *client_realm;\n \t\tkrb5_creds *creds;\n \n-\t\tmemset(&creds_in, 0, sizeof(creds_in));\n+\t\tZERO_STRUCT(creds_in);\n \n \t\tret = krb5_copy_principal(context, client, &creds_in.client);\n \t\tif (ret) {\n@@ -1252,7 +1259,7 @@\n \t\tkrb5_free_creds(context, creds);\n \t}\n #else\n-#error NO_SUITABKE_KRB5_TICKET_RENEW_FUNCTION_AVAILABLE\n+#error NO_SUITABLE_KRB5_TICKET_RENEW_FUNCTION_AVAILABLE\n #endif\n \n \n@@ -1260,15 +1267,14 @@\n \tif (client) {\n \t\tkrb5_free_principal(context, client);\n \t}\n+\tif (ccache) {\n+\t\tkrb5_cc_close(context, ccache);\n+\t}\n \tif (context) {\n \t\tkrb5_free_context(context);\n \t}\n-\tif (ccache) {\n-\t\tkrb5_cc_close(context, ccache);\n-\t}\n \n \treturn ret;\n-    \n }\n \n  krb5_error_code smb_krb5_free_addresses(krb5_context context, smb_krb5_addresses *addr)\n\n"}