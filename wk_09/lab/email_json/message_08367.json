{"category": "ham", "to_address": "samba-cvs@samba.org", "from_address": "Jelmer Vernooij <jelmer@samba.org>", "subject": "Rev 11908: Add initial testsuite for share code. in\n\tfile:///home/jelmer/bzr.samba/SAMBA_4_0/", "body": "At file:///home/jelmer/bzr.samba/SAMBA_4_0/\n\n------------------------------------------------------------\nrevno: 11908\nrevision-id: jelmer@samba.org-20070418021657-yfspskt0b29tzpbg\nparent: svn-v2:22326@0c0555d6-39d7-0310-84fc-f1cc0bd64818-branches%2fSAMBA_4_0\ncommitter: Jelmer Vernooij \nbranch nick: SAMBA_4_0\ntimestamp: Wed 2007-04-18 04:16:57 +0200\nmessage:\n  Add initial testsuite for share code.\nadded:\n  source/torture/local/share.c   share.c-20070418015705-k38bhzpxse57ioyv-1\nmodified:\n  source/param/share.c           svn-v2:17206@0c0555d6-39d7-0310-84fc-f1cc0bd64818-branches%2fSAMBA_4_0-source%2fparam%2fshare.c\n  source/torture/local/config.mk svn-v2:12008@0c0555d6-39d7-0310-84fc-f1cc0bd64818-branches%2fSAMBA_4_0-source%2ftorture%2flocal%2fconfig.mk\n  source/torture/local/local.c   svn-v2:16333@0c0555d6-39d7-0310-84fc-f1cc0bd64818-branches%2fSAMBA_4_0-source%2ftorture%2flocal%2flocal.c\n=== added file 'source/torture/local/share.c'\n--- a/source/torture/local/share.c\t1970-01-01 00:00:00 +0000\n+++ b/source/torture/local/share.c\t2007-04-18 02:16:57 +0000\n@@ -0,0 +1,79 @@\n+/* \n+   Unix SMB/CIFS implementation.\n+\n+   local testing of share code\n+\n+   Copyright (C) Jelmer Vernooij 2007\n+   \n+   This program is free software; you can redistribute it and/or modify\n+   it under the terms of the GNU General Public License as published by\n+   the Free Software Foundation; either version 2 of the License, or\n+   (at your option) any later version.\n+   \n+   This program is distributed in the hope that it will be useful,\n+   but WITHOUT ANY WARRANTY; without even the implied warranty of\n+   MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the\n+   GNU General Public License for more details.\n+   \n+   You should have received a copy of the GNU General Public License\n+   along with this program; if not, write to the Free Software\n+   Foundation, Inc., 675 Mass Ave, Cambridge, MA 02139, USA.\n+*/\n+\n+#include \"includes.h\"\n+#include \"param/share.h\"\n+#include \"torture/torture.h\"\n+\n+static bool test_list_empty(struct torture_context *tctx, \n+\t\t\t\t\t\t\tvoid *tcase_data, \n+\t\t\t\t\t\t\tvoid *test_data)\n+{\n+\tstruct share_context *ctx = tcase_data;\n+\tint count;\n+\tconst char **names;\n+\n+\ttorture_assert_ntstatus_ok(tctx, share_list_all(tctx, ctx, &count, &names),\n+\t\t\t\t\t\t\t   \"share_list_all failed\");\n+\n+\treturn true;\n+}\n+\n+static void tcase_add_share_tests(struct torture_tcase *tcase)\n+{\n+\ttorture_tcase_add_test(tcase, \"list_empty\", test_list_empty, NULL);\n+}\n+\n+static BOOL setup_ldb(struct torture_context *tctx, void **data)\n+{\n+\treturn NT_STATUS_IS_OK(share_get_context_by_name(tctx, \"ldb\", data));\n+}\n+\n+static BOOL setup_classic(struct torture_context *tctx, void **data)\n+{\n+\treturn NT_STATUS_IS_OK(share_get_context_by_name(tctx, \"classic\", data));\n+}\n+\n+static BOOL teardown(struct torture_context *tctx, void *data)\n+{\n+\ttalloc_free(data);\n+\treturn true;\n+}\n+\n+struct torture_suite *torture_local_share(TALLOC_CTX *mem_ctx)\n+{\n+\tstruct torture_suite *suite = torture_suite_create(mem_ctx, \n+\t\t\t\t\t\t\t\t\t\t\t\t\t   \"SHARE\");\n+\tstruct torture_tcase *tcase;\n+\n+\tshare_init();\n+\n+\ttcase = torture_suite_add_tcase(suite, \"ldb\");\n+\ttorture_tcase_set_fixture(tcase, setup_ldb, teardown);\n+\ttcase_add_share_tests(tcase);\n+\n+\ttcase = torture_suite_add_tcase(suite, \"classic\");\n+\ttorture_tcase_set_fixture(tcase, setup_classic, teardown);\n+\ttcase_add_share_tests(tcase);\n+\n+\treturn suite;\n+}\n\n=== modified file 'source/param/share.c'\n--- a/source/param/share.c\t2006-09-17 00:15:13 +0000\n+++ b/source/param/share.c\t2007-04-18 02:16:57 +0000\n@@ -131,11 +131,13 @@\n \treturn NT_STATUS_OK;\n }\n \n-NTSTATUS share_get_context(TALLOC_CTX *mem_ctx, struct share_context **ctx)\n+NTSTATUS share_get_context_by_name(TALLOC_CTX *mem_ctx, \n+\t\t\t\t\t\t\t\t   const char *backend_name,\n+\t\t\t\t\t\t\t\t   struct share_context **ctx)\n {\n \tconst struct share_ops *ops;\n \n-\tops = share_backend_by_name(lp_share_backend());\n+\tops = share_backend_by_name(backend_name);\n \tif (!ops) {\n \t\tDEBUG(0, (\"share_init_connection: share backend [%s] not found!\\n\", lp_share_backend()));\n \t\treturn NT_STATUS_INTERNAL_ERROR;\n@@ -144,6 +146,11 @@\n \treturn ops->init(mem_ctx, ops, ctx);\n }\n \n+NTSTATUS share_get_context(TALLOC_CTX *mem_ctx, struct share_context **ctx)\n+{\n+\treturn share_get_context_by_name(mem_ctx, lp_share_backend(), ctx);\n+}\n+\n /*\n   initialise the SHARE subsystem\n */\n\n=== modified file 'source/torture/local/config.mk'\n--- a/source/torture/local/config.mk\t2007-04-15 16:13:06 +0000\n+++ b/source/torture/local/config.mk\t2007-04-18 02:16:57 +0000\n@@ -32,6 +32,7 @@\n \t\tsddl.o \\\n \t\t../../lib/tdr/testsuite.o \\\n \t\tevent.o \\\n+\t\tshare.o \\\n \t\tlocal.o \\\n \t\tdbspeed.o \\\n \t\ttorture.o\n@@ -46,7 +47,8 @@\n \t\tPOPT_CREDENTIALS \\\n \t\tTORTURE_AUTH \\\n \t\tTORTURE_UTIL\n-PRIVATE_DEPENDENCIES = TORTURE_NDR\n+PRIVATE_DEPENDENCIES = TORTURE_NDR \\\n+\t\t\t\t\t   share\n # End SUBSYSTEM TORTURE_LOCAL\n #################################\n \n\n=== modified file 'source/torture/local/local.c'\n--- a/source/torture/local/local.c\t2007-03-05 01:50:33 +0000\n+++ b/source/torture/local/local.c\t2007-04-18 02:16:57 +0000\n@@ -45,6 +45,7 @@\n \ttorture_local_sddl,\n \ttorture_local_ndr, \n \ttorture_local_tdr, \n+\ttorture_local_share,\n \ttorture_local_charset,\n \ttorture_local_compression,\n \ttorture_local_event, \n\n"}