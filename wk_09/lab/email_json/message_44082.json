{"category": "ham", "to_address": "samba-cvs@samba.org", "from_address": "tridge@samba.org", "subject": "Rev 491: handle CTDB_CURRENT_NODE in ban commands in\n\thttp://samba.org/~tridge/ctdb", "body": "------------------------------------------------------------\nrevno: 491\nrevision-id: tridge@samba.org-20070607064831-cs6ed30jggx07qp9\nparent: tridge@samba.org-20070607063433-1twaia604wl2j5hj\ncommitter: Andrew Tridgell \nbranch nick: tridge\ntimestamp: Thu 2007-06-07 16:48:31 +1000\nmessage:\n  handle CTDB_CURRENT_NODE in ban commands\nmodified:\n  common/ctdb_recoverd.c         recoverd.c-20070503213540-bvxuyd9jm1f7ig90-1\n  tools/ctdb_control.c           ctdb_control.c-20070426122705-9ehj1l5lu2gn9kuj-1\n=== modified file 'common/ctdb_recoverd.c'\n--- a/common/ctdb_recoverd.c\t2007-06-07 06:34:33 +0000\n+++ b/common/ctdb_recoverd.c\t2007-06-07 06:48:31 +0000\n@@ -54,6 +54,11 @@\n {\n \tstruct ctdb_context *ctdb = rec->ctdb;\n \n+\tif (!ctdb_validate_vnn(ctdb, vnn)) {\n+\t\tDEBUG(0,(\"Bad vnn %u in ctdb_ban_node\\n\", vnn));\n+\t\treturn;\n+\t}\n+\n \tif (rec->banned_nodes[vnn] == NULL) {\n \t\treturn;\n \t}\n@@ -85,6 +90,11 @@\n {\n \tstruct ctdb_context *ctdb = rec->ctdb;\n \n+\tif (!ctdb_validate_vnn(ctdb, vnn)) {\n+\t\tDEBUG(0,(\"Bad vnn %u in ctdb_ban_node\\n\", vnn));\n+\t\treturn;\n+\t}\n+\n \tctdb_ctrl_modflags(ctdb, CONTROL_TIMEOUT(), vnn, NODE_FLAGS_BANNED, 0);\n \n \trec->banned_nodes[vnn] = talloc(rec, struct ban_state);\n\n=== modified file 'tools/ctdb_control.c'\n--- a/tools/ctdb_control.c\t2007-06-07 06:34:33 +0000\n+++ b/tools/ctdb_control.c\t2007-06-07 06:48:31 +0000\n@@ -462,6 +462,10 @@\n \t\tusage();\n \t}\n \n+\tif (options.vnn == CTDB_CURRENT_NODE) {\n+\t\toptions.vnn = ctdb_ctrl_getvnn(ctdb, TIMELIMIT(), options.vnn);\t\t\n+\t}\n+\n \tif (options.vnn == CTDB_BROADCAST_ALL) {\n \t\tuint32_t *nodes;\n \t\tuint32_t num_nodes;\n@@ -512,6 +516,10 @@\n \tuint32_t recmaster;\n \tTDB_DATA data;\n \n+\tif (options.vnn == CTDB_CURRENT_NODE) {\n+\t\toptions.vnn = ctdb_ctrl_getvnn(ctdb, TIMELIMIT(), options.vnn);\t\t\n+\t}\n+\n \tif (options.vnn == CTDB_BROADCAST_ALL) {\n \t\tuint32_t *nodes;\n \t\tuint32_t num_nodes;\n\n"}