{"category": "ham", "to_address": "samba-cvs@samba.org", "from_address": "metze@samba.org", "subject": "svn commit: samba r22629 - in\n\tbranches/SAMBA_4_0/source/lib/messaging: .", "body": "Author: metze\nDate: 2007-05-01 09:55:36 +0000 (Tue, 01 May 2007)\nNew Revision: 22629\n\nWebSVN: http://websvn.samba.org/cgi-bin/viewcvs.cgi?view=rev&root=samba&rev=22629\n\nLog:\nif irpc gets freed within event_loop_once() we crash...\nso deferr the freeing\n\nmetze\nModified:\n   branches/SAMBA_4_0/source/lib/messaging/irpc.h\n   branches/SAMBA_4_0/source/lib/messaging/messaging.c\n\n\nChangeset:\nModified: branches/SAMBA_4_0/source/lib/messaging/irpc.h\n===================================================================\n--- branches/SAMBA_4_0/source/lib/messaging/irpc.h\t2007-05-01 09:06:25 UTC (rev 22628)\n+++ branches/SAMBA_4_0/source/lib/messaging/irpc.h\t2007-05-01 09:55:36 UTC (rev 22629)\n@@ -69,6 +69,7 @@\n \tvoid *r;\n \tNTSTATUS status;\n \tBOOL done;\n+\tBOOL reject_free;\n \tTALLOC_CTX *mem_ctx;\n \tstruct {\n \t\tvoid (*fn)(struct irpc_request *);\n\nModified: branches/SAMBA_4_0/source/lib/messaging/messaging.c\n===================================================================\n--- branches/SAMBA_4_0/source/lib/messaging/messaging.c\t2007-05-01 09:06:25 UTC (rev 22628)\n+++ branches/SAMBA_4_0/source/lib/messaging/messaging.c\t2007-05-01 09:55:36 UTC (rev 22629)\n@@ -773,7 +773,14 @@\n */\n static int irpc_destructor(struct irpc_request *irpc)\n {\n-\tidr_remove(irpc->msg_ctx->idr, irpc->callid);\n+\tif (irpc->callid != -1) {\n+\t\tidr_remove(irpc->msg_ctx->idr, irpc->callid);\n+\t\tirpc->callid = -1;\n+\t}\n+\n+\tif (irpc->reject_free) {\n+\t\treturn -1;\n+\t}\n \treturn 0;\n }\n \n@@ -866,11 +873,16 @@\n \n \tNT_STATUS_HAVE_NO_MEMORY(irpc);\n \n+\tirpc->reject_free = true;\n+\n \twhile (!irpc->done) {\n \t\tif (event_loop_once(irpc->msg_ctx->event.ev) != 0) {\n \t\t\treturn NT_STATUS_CONNECTION_DISCONNECTED;\n \t\t}\n \t}\n+\n+\tirpc->reject_free = false;\n+\n \tstatus = irpc->status;\n \ttalloc_free(irpc);\n \treturn status;\n\n"}