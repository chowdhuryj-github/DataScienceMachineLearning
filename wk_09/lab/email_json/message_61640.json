{"category": "ham", "to_address": "samba-technical <samba-technical@samba.org>,\n   Volker Lendecke <Volker.Lendecke@SerNet.DE>", "from_address": "Todd Stecher <todd.stecher@isilon.com>", "subject": "SPNEGO in Samba - Longhorn Server interop issues...", "body": "When Windows shipped, there were no other SPNEGO implementations to  \ntest against, and so Windows really didn't match SPNEGO RFC 2478  \n100%.  Eventually, Larry, Paul \"Mr. CIFS\" Leach, & company at  \nMicrosoft made an effort to clean this mess up, and revisit the  \nstandard so that everyone could play well together.  The end result  \nis RFC 4178, which supersedes 2478.\n\nAs such, in early versions of Windows SPNEGO, there were some \"extra\"  \nfields added to the negTokenInit message which are being deprecated  \nin Vista, Longhorn Server, and eventually service packs for older  \nplatforms.  The most significant of these fields is the principal  \nname - there is really no place in either standard which allows the  \nreturn of a principal in negTokenInit messages.  This is being  \ncorrected for in Vista and Longhorn server by continuing to add the  \nfield, but instead of a \"real\" principal, it now contains  \n\"not_defined_in_RFC4178 at please_ignore\".\n\n From a security standpoint, allowing the server to specify its  \nservice principal is a \"bad idea\" - I'm OK with this change, but it  \nmeans we'll need to fix up some Samba code, and we'll need to start  \nusing / generating real service principal names in order to get  \nKerberos authentication.  Currently, we try to get a service ticket  \nto the @please_ignore realm!!!\n\nVolker made a fix in cliconnect.c (http://lists.samba.org/archive/ \nsamba-cvs/2006-October/071344.html) to partially address this.   \nHowever, this does not address issues when operating against Longhorn  \nServer (Windows 2008 server?).  I'm sorting through the issues, but  \nthe first error occurs when trying to join a Samba server to the  \ndomain - the code in ads_sasl_spnego_bind() uses this principal to  \nattempt to get a Kerberos ticket to the ldap head.\n\nI'm sure this is the first layer of the onion (there are encoding  \nissues in the old Microsoft implementation as well), but there'll be  \nmore - before I get too deep, is this work already being done  \nelsewhere???  If not, I should be able to get fairly solid Longhorn  \nServer interop moving forward in the next week, and will submit a patch.\n\n\nThanks,\nTodd\n\n\n\n\nTodd Stecher | Windows Interop Dev\nIsilon Systems    P +1-206-315-7500     F  +1-206-315-7501\nwww.isilon.com    D +1-206-315-7638    M +1-425-205-1180\n\n\n\n"}