{"category": "ham", "to_address": "samba-cvs@samba.org", "from_address": "metze@samba.org", "subject": "svn commit: samba r22843 - in\n\tbranches/SAMBA_4_0/source/smb_server/smb2: .", "body": "Author: metze\nDate: 2007-05-14 11:50:51 +0000 (Mon, 14 May 2007)\nNew Revision: 22843\n\nWebSVN: http://websvn.samba.org/cgi-bin/viewcvs.cgi?view=rev&root=samba&rev=22843\n\nLog:\npass smb2 lock requests to the ntvfs layer\n\nmetze\nModified:\n   branches/SAMBA_4_0/source/smb_server/smb2/fileio.c\n\n\nChangeset:\nModified: branches/SAMBA_4_0/source/smb_server/smb2/fileio.c\n===================================================================\n--- branches/SAMBA_4_0/source/smb_server/smb2/fileio.c\t2007-05-14 11:45:39 UTC (rev 22842)\n+++ branches/SAMBA_4_0/source/smb_server/smb2/fileio.c\t2007-05-14 11:50:51 UTC (rev 22843)\n@@ -156,6 +156,7 @@\n \tSMB2SRV_CHECK_ASYNC_STATUS(io, union smb_read);\n \tSMB2SRV_CHECK(smb2srv_setup_reply(req, 0x10, True, io->smb2.out.data.length));\n \n+\t/* TODO: avoid the memcpy */\n \tSMB2SRV_CHECK(smb2_push_o16s32_blob(&req->out, 0x02, io->smb2.out.data));\n \tSBVAL(req->out.body,\t0x08,\tio->smb2.out.unknown1);\n \n@@ -224,9 +225,39 @@\n \tSMB2SRV_CALL_NTVFS_BACKEND(ntvfs_write(req->ntvfs, io));\n }\n \n+static void smb2srv_lock_send(struct ntvfs_request *ntvfs)\n+{\n+\tstruct smb2srv_request *req;\n+\tunion smb_lock *io;\n+\n+\tSMB2SRV_CHECK_ASYNC_STATUS_ERR(io, union smb_lock);\n+\tSMB2SRV_CHECK(smb2srv_setup_reply(req, 0x04, False, 0));\n+\n+\tSSVAL(req->out.body,\t0x02,\tio->smb2.out.unknown1);\n+\n+\tsmb2srv_send_reply(req);\n+}\n+\n void smb2srv_lock_recv(struct smb2srv_request *req)\n {\n-\tsmb2srv_send_error(req, NT_STATUS_NOT_IMPLEMENTED);\n+\tunion smb_lock *io;\n+\n+\tSMB2SRV_CHECK_BODY_SIZE(req, 0x30, False);\n+\tSMB2SRV_TALLOC_IO_PTR(io, union smb_lock);\n+\tSMB2SRV_SETUP_NTVFS_REQUEST(smb2srv_lock_send, NTVFS_ASYNC_STATE_MAY_ASYNC);\n+\n+\tio->smb2.level\t\t\t= RAW_LOCK_SMB2;\n+\n+\tio->smb2.in.unknown1\t\t= SVAL(req->in.body, 0x02);\n+\tio->smb2.in.unknown2\t\t= IVAL(req->in.body, 0x04);\n+\tio->smb2.in.file.ntvfs\t\t= smb2srv_pull_handle(req, req->in.body, 0x08);\n+\tio->smb2.in.offset\t\t= BVAL(req->in.body, 0x18);\n+\tio->smb2.in.count\t\t= BVAL(req->in.body, 0x20);\n+\tio->smb2.in.unknown5\t\t= IVAL(req->in.body, 0x24);\n+\tio->smb2.in.flags\t\t= IVAL(req->in.body, 0x28);\n+\n+\tSMB2SRV_CHECK_FILE_HANDLE(io->smb2.in.file.ntvfs);\n+\tSMB2SRV_CALL_NTVFS_BACKEND(ntvfs_lock(req->ntvfs, io));\n }\n \n static void smb2srv_ioctl_send(struct ntvfs_request *ntvfs)\n\n"}