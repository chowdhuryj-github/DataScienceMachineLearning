{"category": "ham", "to_address": "samba-cvs@samba.org", "from_address": "tridge@samba.org", "subject": "Rev 346: make sure we find out about new nodes as fast as possible\n\tin http://samba.org/~tridge/ctdb", "body": "------------------------------------------------------------\nrevno: 346\nrevision-id: tridge@samba.org-20070525120745-40ik47s270sgbx07\nparent: tridge@samba.org-20070525112726-m22jkf53zf4xkfpc\ncommitter: Andrew Tridgell \nbranch nick: tridge\ntimestamp: Fri 2007-05-25 22:07:45 +1000\nmessage:\n  make sure we find out about new nodes as fast as possible\nmodified:\n  tcp/ctdb_tcp.h                 ctdb_tcp.h-20061127103747-l8xeniwiapbydehq-3\n  tcp/tcp_connect.c              tcp_connect.c-20061128004937-x70q1cu5xzg5g2tm-1\n=== modified file 'tcp/ctdb_tcp.h'\n--- a/tcp/ctdb_tcp.h\t2007-04-13 10:38:24 +0000\n+++ b/tcp/ctdb_tcp.h\t2007-05-25 12:07:45 +0000\n@@ -39,6 +39,8 @@\n struct ctdb_tcp_node {\n \tint fd;\n \tstruct ctdb_queue *queue;\n+\tstruct fd_event *connect_fde;\n+\tstruct timed_event *connect_te;\n };\n \n \n\n=== modified file 'tcp/tcp_connect.c'\n--- a/tcp/tcp_connect.c\t2007-05-15 08:40:56 +0000\n+++ b/tcp/tcp_connect.c\t2007-05-25 12:07:45 +0000\n@@ -50,6 +50,7 @@\n \t/* start a new connect cycle to try to re-establish the\n \t   link */\n \tctdb_queue_set_fd(tnode->queue, -1);\n+\ttnode->fd = -1;\n \tevent_add_timed(node->ctdb->ev, node, timeval_zero(), \n \t\t\tctdb_tcp_node_connect, node);\n }\n@@ -69,6 +70,9 @@\n \tsocklen_t len = sizeof(error);\n \tint one = 1;\n \n+\ttalloc_free(tnode->connect_te);\n+\ttnode->connect_te = NULL;\n+\n \tif (getsockopt(tnode->fd, SOL_SOCKET, SO_ERROR, &error, &len) != 0 ||\n \t    error != 0) {\n \t\ttalloc_free(fde);\n@@ -120,6 +124,13 @@\n         struct sockaddr_in sock_in;\n         struct sockaddr_in sock_out;\n \n+\tif (tnode->fd != -1) {\n+\t\ttalloc_free(tnode->connect_fde);\n+\t\ttnode->connect_fde = NULL;\n+\t\tclose(tnode->fd);\n+\t\ttnode->fd = -1;\n+\t}\n+\n \ttnode->fd = socket(PF_INET, SOCK_STREAM, IPPROTO_TCP);\n \n \tset_nonblocking(tnode->fd);\n@@ -163,8 +174,15 @@\n \t}\n \n \t/* non-blocking connect - wait for write event */\n-\tevent_add_fd(node->ctdb->ev, node, tnode->fd, EVENT_FD_WRITE|EVENT_FD_READ, \n-\t\t     ctdb_node_connect_write, node);\n+\ttnode->connect_fde = event_add_fd(node->ctdb->ev, node, tnode->fd, \n+\t\t\t\t\t  EVENT_FD_WRITE|EVENT_FD_READ, \n+\t\t\t\t\t  ctdb_node_connect_write, node);\n+\n+\t/* don't give it long to connect - retry in one second. This ensures\n+\t   that we find a node is up quickly (tcp normally backs off a syn reply\n+\t   delay by quite a lot) */\n+\ttnode->connect_te = event_add_timed(ctdb->ev, node, timeval_current_ofs(1, 0), \n+\t\t\t\t\t    ctdb_tcp_node_connect, node);\n }\n \n /*\n\n"}