{"category": "ham", "to_address": "samba-cvs@samba.org", "from_address": "tridge@samba.org", "subject": "Rev 598: make sure smbstatus cleans up stale records in connections\n\tand sessionid database. Otherwise they grow without bounds in\n\thttp://samba.org/~tridge/3_0-ctdb", "body": "------------------------------------------------------------\nrevno: 598\nrevision-id: tridge@samba.org-20070617161549-tkgvbm3beypwj030\nparent: tridge@samba.org-20070617012205-k626bylogn6ky4tr\ncommitter: Andrew Tridgell \nbranch nick: s3-ctdb-tridge\ntimestamp: Mon 2007-06-18 02:15:49 +1000\nmessage:\n  make sure smbstatus cleans up stale records in connections and sessionid database. Otherwise they grow without bounds\nmodified:\n  source/lib/conn_tdb.c          conn_tdb.c-20070428165234-v42k4o13p6tqo5cr-1\n  source/lib/messages.c          messages.c-20070210173807-1wjifrbwaz6xnmgl-491\n  source/utils/status.c          status.c-20070210173807-1wjifrbwaz6xnmgl-1163\n=== modified file 'source/lib/conn_tdb.c'\n--- a/source/lib/conn_tdb.c\t2007-05-17 12:44:40 +0000\n+++ b/source/lib/conn_tdb.c\t2007-06-17 16:15:49 +0000\n@@ -104,7 +104,7 @@\n \t\treturn -1;\n \t}\n \n-\treturn ctx->traverse_read(ctx, fn, private_data);\n+\treturn ctx->traverse(ctx, fn, private_data);\n }\n \n int connections_forall(int (*fn)(struct db_record *rec,\n\n=== modified file 'source/lib/messages.c'\n--- a/source/lib/messages.c\t2007-06-02 05:17:47 +0000\n+++ b/source/lib/messages.c\t2007-06-17 16:15:49 +0000\n@@ -1701,7 +1701,8 @@\n \t\tdata.dsize -= sizeof(struct ctdb_ltdb_header);\n \t\tdata.dptr += sizeof(struct ctdb_ltdb_header);\n \n-\t\tif (fn) {\n+\t\t/* empty records are deleted records in ctdb */\n+\t\tif (data.dsize != 0 && fn) {\n \t\t\tfn(key, data, private_data);\n \t\t}\n \n\n=== modified file 'source/utils/status.c'\n--- a/source/utils/status.c\t2007-05-21 10:59:16 +0000\n+++ b/source/utils/status.c\t2007-06-17 16:15:49 +0000\n@@ -210,13 +210,14 @@\n \t\t\tconst struct connections_data *crec,\n \t\t\tvoid *state)\n {\n+\tif (!process_exists(crec->pid) || !Ucrit_checkUid(crec->uid)) {\n+\t\tcrec->delete_rec(crec);\n+\t\treturn 0;\n+\t}\n+\n \tif (crec->cnum == -1)\n \t\treturn 0;\n \n-\tif (!process_exists(crec->pid) || !Ucrit_checkUid(crec->uid)) {\n-\t\treturn 0;\n-\t}\n-\n \td_printf(\"%-10s   %s   %-12s  %s\",\n \t\t crec->servicename,procid_str_static(&crec->pid),\n \t\t crec->machine,\n@@ -230,12 +231,15 @@\n \tstruct sessionid sessionid;\n \tfstring uid_str, gid_str;\n \n-\tif (db->value.dsize != sizeof(sessionid))\n+\tif (db->value.dsize != sizeof(sessionid)) {\n+\t\tdb->delete_rec(db);\n \t\treturn 0;\n+\t}\n \n \tmemcpy(&sessionid, db->value.dptr, sizeof(sessionid));\n \n \tif (!process_exists(sessionid.pid) || !Ucrit_checkUid(sessionid.uid)) {\n+\t\tdb->delete_rec(db);\n \t\treturn 0;\n \t}\n \n@@ -346,7 +350,7 @@\n \t\t\td_printf(\"PID     Username      Group         Machine                        \\n\");\n \t\t\td_printf(\"-------------------------------------------------------------------\\n\");\n \n-\t\t\tdb->traverse_read(db, traverse_sessionid, NULL);\n+\t\t\tdb->traverse(db, traverse_sessionid, NULL);\n \t\t\ttalloc_free(db);\n \t\t}\n \n\n"}