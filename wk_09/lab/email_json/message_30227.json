{"category": "ham", "to_address": "<gyadav@ccilindia.co.in>", "from_address": "\"Patnaik, Tirthankar \" <tirthankar.patnaik@citi.com>", "subject": "Re: [R] Conditional Sums for Index creation", "body": "All,\n Happy to say that the problem could be solved.  The key idea was from\nPatrick Burns (Convert the data-frame to a matrix!).  As written\nearlier, the steps were to first get a object (call it ad)  containing\nthe non-missing entries at each row. Then run a sum over each row,\nselecting only those columns  that are pointed to in the object ad.\n \nAnother quick step was to use the fact that if there's an NA in any\ncolumn (after a stock has entered the portfolio), then we could use the\nprevious value just as well (e.g., the market cap of a stock). So\nna.locf was a big help! \n \nJust providing the code here for illustration purposes:\n \n> set.seed(1)\n> ab <- matrix(round(runif(100)*100),nrow=20,ncol=5)\n> ab[1:5,4:5] <- NA\n> ab[6:10,5] <- NA\n> ac <- as.data.frame(ifelse(ab <= 7,NA,ab))\n> ac\n   V1 V2 V3 V4 V5\n1  27 93 82 NA NA\n2  37 21 65 NA NA\n3  57 65 78 NA NA\n4  91 13 55 NA NA\n5  20 27 53 NA NA\n6  90 39 79 26 NA\n7  94 NA NA 48 NA\n8  66 38 48 77 NA\n9  63 87 73  8 NA\n10 NA 34 69 88 NA\n11 21 48 48 34 24\n12 18 60 86 84 NA\n13 69 49 44 35 64\n14 38 19 24 33 88\n15 77 83 NA 48 78\n16 50 67 10 89 80\n17 72 79 32 86 46\n18 99 11 52 39 41\n19 38 72 66 78 81\n20 78 41 41 96 60\n> \n\n> # -----------------------------------------------------\n> # Indexes of all the non-missing in all the rows\n> ad <- apply(ac,1,function(y)which(!is.na(y)))\n> \n> af <- data.matrix(na.locf(ac,na.rm=FALSE))\n> # Include another column as placeholder\n> ag <- cbind(af,rep(1,nrow(af)))\n> # Call it, \"sumCorr\".\n> colnames(ag)[6] <- \"sumCorr\"\n> ag[1,6] <- sum(ag[1,],na.rm=TRUE)\n> for (r in 2:nrow(ag)){\n+ sumCorr <- unlist(sum(ag[r,unlist(ad[r-1])],na.rm=TRUE))\n+ ag[r,6] <- sumCorr\n+ }\n> ag\n   V1 V2 V3 V4 V5 sumCorr\n1  27 93 82 NA NA     203\n2  37 21 65 NA NA     123\n3  57 65 78 NA NA     200\n4  91 13 55 NA NA     159\n5  20 27 53 NA NA     100\n6  90 39 79 26 NA     208\n7  94 39 79 48 NA     260\n8  66 38 48 77 NA     143\n9  63 87 73  8 NA     231\n10 63 34 69 88 NA     254\n11 21 48 48 34 24     130\n12 18 60 86 84 24     272\n13 69 49 44 35 64     197\n14 38 19 24 33 88     202\n15 77 83 24 48 78     310\n16 50 67 10 89 80     286\n17 72 79 32 86 46     315\n18 99 11 52 39 41     242\n19 38 72 66 78 81     335\n20 78 41 41 96 60     316\n> \n\nGaurav,\nAnything to not implement a double for-loop! :)\nWith the implementation, I was able to generate my index at last.\nPerhaps it's because I'm quite new with R, but I find it quite arcane\nsometimes! :)\n \n \nbest,\n-Tir\n \nTirthankar Patnaik\nIndia Strategy\nCitigroup Investment Research\n+91-22-6631 9887\n\n  _____  \n\nFrom: gyadav@ccilindia.co.in [mailto:gyadav@ccilindia.co.in] \nSent: Monday, May 14, 2007 6:29 PM\nTo: Patnaik, Tirthankar [GWM-CIR]\nCc: r-help@stat.math.ethz.ch; r-help-bounces@stat.math.ethz.ch\nSubject: Re: [R] Conditional Sums for Index creation\n\n\n\nHi Tirthankar \n\nthis will help you \n\nind is a matrix which indicates the start of any new stock. \nind[i,j] means that in j + 1 column all the values from 1st row to i - 1\nrow are all NAs. \n\n\n\n> x \n      V2 V3 V4 V5 V6 \n [1,] 27 93 82 NA NA \n [2,] 37 21 65 NA NA \n [3,] 57 65 78 NA NA \n [4,] 91 13 55 NA NA \n [5,] 20 27 53 NA NA \n [6,] 90 39 79 26 NA \n [7,] 94 NA NA 48 NA \n [8,] 66 38 48 77 NA \n [9,] 63 87 73  8 NA \n[10,] NA 34 69 88 NA \n[11,] 21 48 48 34 24 \n[12,] 18 60 86 84 NA \n[13,] 69 49 44 35 64 \n[14,] 38 19 24 33 88 \n[15,] 77 83 NA 48 78 \n[16,] 50 67 10 89 80 \n[17,] 72 79 32 86 46 \n[18,] 99 11 52 39 41 \n[19,] 38 72 66 78 81 \n[20,] 78 41 41 96 60 \n> \n> for ( j in 1:length(x[1,]) - 1) { \n+ for ( i in 2:length(x[,1])) { \n+ indicator<-TRUE \n+ for (k in 1: i - 1){ \n+ indicator <- indicator && is.na(x[k,j+1]) \n+ } \n+ ind[i,j]<-indicator \n+ \n+ } \n+ } \n> ind \n      V2 V3 V4 V5 V6 \n [1,] NA NA NA NA NA \n [2,]  0  0 NA NA  0 \n [3,]  0  0 NA NA  0 \n [4,]  0  0 NA NA  0 \n [5,]  0  0 NA NA  0 \n [6,]  0  0 NA NA  0 \n [7,]  0  0  0 NA  0 \n [8,]  0  0  0 NA  0 \n [9,]  0  0  0 NA  0 \n[10,]  0  0  0 NA  0 \n[11,]  0  0  0 NA  0 \n[12,]  0  0  0  0  0 \n[13,]  0  0  0  0  0 \n[14,]  0  0  0  0  0 \n[15,]  0  0  0  0  0 \n[16,]  0  0  0  0  0 \n[17,]  0  0  0  0  0 \n[18,]  0  0  0  0  0 \n[19,]  0  0  0  0  0 \n[20,]  0  0  0  0  0 \n> \n\n\nRegards,\n\nGaurav Yadav\n+++++++++++\nAssistant Manager, CCIL, Mumbai (India)\nMob: +919821286118 Email: mailtogauravyadav@gmail.com\nBhagavad Gita:  Man is made by his Belief, as He believes, so He is \n\n\n\n\"Patnaik, Tirthankar \"  \nSent by: r-help-bounces@stat.math.ethz.ch \n\n05/14/2007 11:53 AM \n\nTo\n \ncc\nSubject\n[R] Conditional Sums for Index creation\n\n\t\n\n\n\n\nHi,\n                Apologies for the long mail. I have a data.frame with\ncolumns of\nprice/mcap data for a portfolio of stocks, and the date. To get the\ntotal value of the portfolio on a daily basis, I calculate rowSums of\nthe data.frame. \n\n> set.seed(1)\n> ab <- matrix(round(runif(100)*100),nrow=20,ncol=5)\n> ab[1:5,4:5] <- NA\n> ab[6:10,5] <- NA\n> ac <- as.data.frame(ifelse(ab <= 7,NA,ab))\n> ac\n  V1 V2 V3 V4 V5\n1  27 93 82 NA NA\n2  37 21 65 NA NA\n3  57 65 78 NA NA\n4  91 13 55 NA NA\n5  20 27 53 NA NA\n6  90 39 79 26 NA\n7  94 NA NA 48 NA\n8  66 38 48 77 NA\n9  63 87 73  8 NA\n10 NA 34 69 88 NA\n11 21 48 48 34 24\n12 18 60 86 84 NA\n13 69 49 44 35 64\n14 38 19 24 33 88\n15 77 83 NA 48 78\n16 50 67 10 89 80\n17 72 79 32 86 46\n18 99 11 52 39 41\n19 38 72 66 78 81\n20 78 41 41 96 60\n> \n\nHere the rows 1:20 are dates (also in my data.frame). \n\nSince some of the prices have NA, the rowSums is made to ignore these\nentries. \n\n> rowSums(ac,na.rm=TRUE)\n 1   2   3   4   5   6   7   8   9  10  11  12  13  14  15  16  17  18\n19  20 \n202 123 200 159 100 234 142 229 231 191 175 248 261 202 286 296 315 242\n335 316 \n> \n\nStocks are being added to the portfolio too. So from date=6 (or row=6)\nwe have the 4th stock V4, and from date=11, we have the 5th stock V5. My\nproblem is that I need to calculate the rowSums for row=6 (When a new\nstock was added), _with_ and _without_ the new stock. So my answer for\nrow=6 would be 234 for the plain row-sum, and 234 - 26 = 208 for the\noriginal set of stocks (without V4). Similarly, my answer for row=11\nwould be 175 for the plain sum, and 175 - 24 = 151 for the original sum\n(without V5). \n\nBasically I'm interested in finding out the value of the portfolio with\nand without the new stock for the purposes of creating an index. It's\npossible that some stocks my get dropped later, in which case there\nwould be an NA series starting for say V1 at row=18 and so on. In that\ncase, the aim would be to find the sum at row=18 with and without the\nvalue of V1. \n\nIs there any way I can get the sum over columns, deleting specific\ncolums? To get the columns that are NA in any row, I tried (shown for\nthe first 12 rows):\n\n> apply(ac[1:12,],1,function(y)which(is.na(y)))\n\nWhich correctly gives \n\n$`1`\nV4 V5 \n4  5 \n\n$`2`\nV4 V5 \n4  5 \n\n$`3`\nV4 V5 \n4  5 \n\n$`4`\nV4 V5 \n4  5 \n\n$`5`\nV4 V5 \n4  5 \n\n$`6`\nV5 \n5 \n\n$`7`\nV2 V3 V5 \n2  3  5 \n\n$`8`\nV5 \n5 \n\n$`9`\nV5 \n5 \n\n$`10`\nV1 V5 \n1  5 \n\n$`11`\ninteger(0)\n\n$`12`\nV5 \n5 \n\n> \n\nBut now I'm stuck. I don't how to use this list of indices at each row\nto exclude my columns. \n\nAny pointers please? Would such an exercise be easier if I use a\ntime-series based object, like a zoo.\n\n\nTIA and best,\n-Tir\n\nTirthankar Patnaik\nIndia Strategy\nCitigroup Investment Research\n+91-22-6631 9887\n\n______________________________________________\nR-help@stat.math.ethz.ch mailing list\nhttps://stat.ethz.ch/mailman/listinfo/r-help\nPLEASE do read the posting guide\nhttp://www.R-project.org/posting-guide.html\nand provide commented, minimal, self-contained, reproducible code.\n\n\n========================================================================\n====================\nDISCLAIMER AND CONFIDENTIALITY CAUTION:\\ \\ This message and ...{{dropped}}\n\n______________________________________________\nR-help@stat.math.ethz.ch mailing list\nhttps://stat.ethz.ch/mailman/listinfo/r-help\nPLEASE do read the posting guide http://www.R-project.org/posting-guide.html\nand provide commented, minimal, self-contained, reproducible code.\n\n"}