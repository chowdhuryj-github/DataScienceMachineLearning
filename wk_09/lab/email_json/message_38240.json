{"category": "ham", "to_address": "samba-cvs@samba.org", "from_address": "jerry@samba.org", "subject": "svn commit: samba r23197 - in branches/SAMBA_3_0_26/source: include\n\tlibsmb", "body": "Author: jerry\nDate: 2007-05-29 14:09:46 +0000 (Tue, 29 May 2007)\nNew Revision: 23197\n\nWebSVN: http://websvn.samba.org/cgi-bin/viewcvs.cgi?view=rev&root=samba&rev=23197\n\nLog:\nmerge some libsmbclient changes (name changes and formatting only)\nModified:\n   branches/SAMBA_3_0_26/source/include/libsmbclient.h\n   branches/SAMBA_3_0_26/source/include/nterr.h\n   branches/SAMBA_3_0_26/source/libsmb/clitrans.c\n\n\nChangeset:\nModified: branches/SAMBA_3_0_26/source/include/libsmbclient.h\n===================================================================\n--- branches/SAMBA_3_0_26/source/include/libsmbclient.h\t2007-05-29 14:05:25 UTC (rev 23196)\n+++ branches/SAMBA_3_0_26/source/include/libsmbclient.h\t2007-05-29 14:09:46 UTC (rev 23197)\n@@ -1242,14 +1242,16 @@\n  */\n int smbc_chmod(const char *url, mode_t mode);\n \n-/**@ingroup attribute\n+/**\n+ * @ingroup attribute\n  * Change the last modification time on a file\n  *\n  * @param url       The smb url of the file or directory to change\n  *                  the modification time of\n- * \n- * @param tbuf      A timeval structure which contains the desired\n- *                  modification time.  NOTE: Only the tv_sec field is\n+ *\n+ * @param tbuf      An array of two timeval structures which contains,\n+ *                  respectively, the desired access and modification times.\n+ *                  NOTE: Only the tv_sec field off each timeval structure is\n  *                  used.  The tv_usec (microseconds) portion is ignored.\n  *\n  * @return          0 on success, < 0 on error with errno set:\n@@ -1260,16 +1262,16 @@\n int smbc_utimes(const char *url, struct timeval *tbuf);\n \n #ifdef HAVE_UTIME_H\n-/**@ingroup attribute\n+/**\n+ * @ingroup attribute\n  * Change the last modification time on a file\n  *\n  * @param url       The smb url of the file or directory to change\n  *                  the modification time of\n- * \n- * @param utbuf     A utimebuf structure which contains the desired\n- *                  modification time.  NOTE: Although the structure contains\n- *                  an access time as well, the access time value is ignored.\n  *\n+ * @param utbuf     A pointer to a utimebuf structure which contains the\n+ *                  desired access and modification times.\n+ *\n  * @return          0 on success, < 0 on error with errno set:\n  *                  - EINVAL The client library is not properly initialized\n  *                  - ENOMEM No memory was available for internal needs\n\nModified: branches/SAMBA_3_0_26/source/include/nterr.h\n===================================================================\n--- branches/SAMBA_3_0_26/source/include/nterr.h\t2007-05-29 14:05:25 UTC (rev 23196)\n+++ branches/SAMBA_3_0_26/source/include/nterr.h\t2007-05-29 14:09:46 UTC (rev 23197)\n@@ -31,7 +31,7 @@\n #define NT_STATUS_NO_MORE_ENTRIES         NT_STATUS(0x8000001a)\n \n /* Vista Status codes. */\n-#define STATUS_INACCESSIBLE_SYSTEM_SHORTCUT         NT_STATUS(0x8000002d)\n+#define NT_STATUS_INACCESSIBLE_SYSTEM_SHORTCUT         NT_STATUS(0x8000002d)\n \n #define STATUS_MORE_ENTRIES               NT_STATUS(0x0105)\n #define STATUS_SOME_UNMAPPED              NT_STATUS(0x0107)\n\nModified: branches/SAMBA_3_0_26/source/libsmb/clitrans.c\n===================================================================\n--- branches/SAMBA_3_0_26/source/libsmb/clitrans.c\t2007-05-29 14:05:25 UTC (rev 23196)\n+++ branches/SAMBA_3_0_26/source/libsmb/clitrans.c\t2007-05-29 14:09:46 UTC (rev 23197)\n@@ -194,13 +194,22 @@\n \t * to a trans call. This is not an error and should not\n \t * be treated as such. Note that STATUS_NO_MORE_FILES is\n \t * returned when a trans2 findfirst/next finishes.\n+\t * When setting up an encrypted transport we can also\n+\t * see NT_STATUS_MORE_PROCESSING_REQUIRED here.\n+         *\n+         * Vista returns NT_STATUS_INACCESSIBLE_SYSTEM_SHORTCUT if the folder\n+         * \"/Users/All Users\" is enumerated.  This is a special pseudo\n+         * folder, and the response does not have parameters (nor a parameter\n+         * length).\n \t */\n \tstatus = cli_nt_error(cli);\n \t\n-\tif (NT_STATUS_IS_ERR(status) ||\n-            NT_STATUS_EQUAL(status,STATUS_NO_MORE_FILES) ||\n-            NT_STATUS_EQUAL(status,STATUS_INACCESSIBLE_SYSTEM_SHORTCUT)) {\n-\t\tgoto out;\n+\tif (!NT_STATUS_EQUAL(status, NT_STATUS_MORE_PROCESSING_REQUIRED)) {\n+\t\tif (NT_STATUS_IS_ERR(status) ||\n+                    NT_STATUS_EQUAL(status,STATUS_NO_MORE_FILES) ||\n+                    NT_STATUS_EQUAL(status,NT_STATUS_INACCESSIBLE_SYSTEM_SHORTCUT)) {\n+\t\t\tgoto out;\n+\t\t}\n \t}\n \n \t/* parse out the lengths */\n@@ -305,8 +314,10 @@\n \t\t\t\t CVAL(cli->inbuf,smb_com)));\n \t\t\tgoto out;\n \t\t}\n-\t\tif (NT_STATUS_IS_ERR(cli_nt_error(cli))) {\n-\t\t\tgoto out;\n+\t\tif (!NT_STATUS_EQUAL(status, NT_STATUS_MORE_PROCESSING_REQUIRED)) {\n+\t\t\tif (NT_STATUS_IS_ERR(cli_nt_error(cli))) {\n+\t\t\t\tgoto out;\n+\t\t\t}\n \t\t}\n \n \t\t/* parse out the total lengths again - they can shrink! */\n\n"}