{"category": "ham", "to_address": "samba-cvs@samba.org", "from_address": "Jelmer Vernooij <jelmer@samba.org>", "subject": "Rev 11896: Add a --socket-wrapper-keep-pcap option. in\n\tfile:///home/jelmer/bzr.samba/SAMBA_4_0/", "body": "At file:///home/jelmer/bzr.samba/SAMBA_4_0/\n\n------------------------------------------------------------\nrevno: 11896\nrevision-id: jelmer@samba.org-20070418010153-7finy566c391pldb\nparent: jelmer@samba.org-20070417123659-yqoyuis1mvjh2kz8\ncommitter: Jelmer Vernooij \nbranch nick: SAMBA_4_0\ntimestamp: Wed 2007-04-18 03:01:53 +0200\nmessage:\n  Add a --socket-wrapper-keep-pcap option.\n  \n  Create one pcap file per test.\nmodified:\n  source/script/tests/selftest.pl svn-v2:20693@0c0555d6-39d7-0310-84fc-f1cc0bd64818-branches%2fSAMBA_4_0-source%2fscript%2ftests%2fselftest.pl\n=== modified file 'source/script/tests/selftest.pl'\n--- a/source/script/tests/selftest.pl\t2007-04-17 12:11:00 +0000\n+++ b/source/script/tests/selftest.pl\t2007-04-18 01:01:53 +0000\n@@ -124,6 +124,7 @@\n my $opt_quick = 0;\n my $opt_socket_wrapper = 0;\n my $opt_socket_wrapper_pcap = undef;\n+my $opt_socket_wrapper_keep_pcap = undef;\n my $opt_one = 0;\n my $opt_immediate = 0;\n my $opt_expected_failures = undef;\n@@ -228,6 +229,8 @@\n \t\tprint \"TEST FAILED: $name (status $ret)\\n\";\n \t}\n \tprint \"==========================================\\n\";\n+\n+\treturn ($ret == $expected_ret);\n }\n \n my $test_output = {};\n@@ -287,6 +290,8 @@\n \t} else {\n \t\t$statistics->{SUITES_OK}++;\n \t}\n+\n+\treturn ($ret == $expected_ret);\n }\n \n sub ShowHelp()\n@@ -306,7 +311,9 @@\n  --builddir=DIR             output directory [.]\n \n Target Specific:\n- --socket-wrapper-pcap=FILE save traffic to pcap file\n+ --socket-wrapper-pcap=DIR\tsave traffic to pcap directories\n+ --socket-wrapper-keep-pcap keep all pcap files, not just those for tests that \n+                            failed\n  --socket-wrapper           enable socket wrapper\n  --expected-failures=FILE   specify list of tests that is guaranteed to fail\n \n@@ -331,7 +338,8 @@\n \t\t'target=s' => \\$opt_target,\n \t\t'prefix=s' => \\$prefix,\n \t\t'socket-wrapper' => \\$opt_socket_wrapper,\n-\t\t'socket-wrapper-pcap=s' => \\$opt_socket_wrapper_pcap,\n+\t\t'socket-wrapper-pcap' => \\$opt_socket_wrapper_pcap,\n+\t\t'socket-wrapper-keep-pcap' => \\$opt_socket_wrapper_keep_pcap,\n \t\t'quick' => \\$opt_quick,\n \t\t'one' => \\$opt_one,\n \t\t'immediate' => \\$opt_immediate,\n@@ -398,8 +406,10 @@\n $ENV{PKG_CONFIG_PATH} = \"$old_pwd/bin/pkgconfig:$ENV{PKG_CONFIG_PATH}\";\n $ENV{PATH} = \"$old_pwd/bin:$ENV{PATH}\";\n \n+my $pcap_dir = \"$prefix/pcap\";\n+\n if ($opt_socket_wrapper_pcap) {\n-\tSocketWrapper::setup_pcap($opt_socket_wrapper_pcap);\n+\tmkdir($pcap_dir);\n \t# Socket wrapper pcap implies socket wrapper\n \t$opt_socket_wrapper = 1;\n }\n@@ -622,10 +632,19 @@\n \n \t\tsetup_env($envname);\n \n+\t\tmy $pcap_file = \"$pcap_dir/$name.cap\";\n+\n+\t\tSocketWrapper::setup_pcap($pcap_file) if ($opt_socket_wrapper_pcap);\n+\t\tmy $result;\n \t\tif ($from_build_farm) {\n-\t\t\trun_test_buildfarm($name, $cmd, $i, $suitestotal);\n+\t\t\t$result = run_test_buildfarm($name, $cmd, $i, $suitestotal);\n \t\t} else {\n-\t\t\trun_test_plain($name, $cmd, $i, $suitestotal);\n+\t\t\t$result = run_test_plain($name, $cmd, $i, $suitestotal);\n+\t\t}\n+\n+\t\tif ($opt_socket_wrapper_pcap and $result and \n+\t\t\tnot $opt_socket_wrapper_keep_pcap) {\n+\t\t\tunlink($pcap_file);\n \t\t}\n \n \t\tif (defined($opt_analyse_cmd)) {\n\n"}