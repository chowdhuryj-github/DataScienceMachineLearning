{"category": "ham", "to_address": "samba-cvs@samba.org", "from_address": "tridge@samba.org", "subject": "Rev 404: tell newly connected nodes about any tcp tickle records\n\tthat we have that they don't have in http://samba.org/~tridge/ctdb", "body": "------------------------------------------------------------\nrevno: 404\nrevision-id: tridge@samba.org-20070530063739-zc29gbh3p4b307ic\nparent: tridge@samba.org-20070530061139-3n42c8eoi2nk007e\ncommitter: Andrew Tridgell \nbranch nick: tridge\ntimestamp: Wed 2007-05-30 16:37:39 +1000\nmessage:\n  tell newly connected nodes about any tcp tickle records that we have that they don't have\nmodified:\n  takeover/ctdb_takeover.c       ctdb_takeover.c-20070525071636-a5n1ihghjtppy08r-2\n=== modified file 'takeover/ctdb_takeover.c'\n--- a/takeover/ctdb_takeover.c\t2007-05-30 06:11:39 +0000\n+++ b/takeover/ctdb_takeover.c\t2007-05-30 06:37:39 +0000\n@@ -463,6 +463,13 @@\n \n \tif (NULL == ctdb_tcp_find(ctdb->tcp_list, tcp)) {\n \t\tDLIST_ADD(ctdb->tcp_list, tcp);\n+\t\tDEBUG(2,(\"Added tickle info for %s:%u from vnn %u\\n\",\n+\t\t\t inet_ntoa(tcp->daddr.sin_addr), ntohs(tcp->daddr.sin_port),\n+\t\t\t tcp->vnn));\n+\t} else {\n+\t\tDEBUG(4,(\"Already had tickle info for %s:%u from vnn %u\\n\",\n+\t\t\t inet_ntoa(tcp->daddr.sin_addr), ntohs(tcp->daddr.sin_port),\n+\t\t\t tcp->vnn));\n \t}\n \n \treturn 0;\n@@ -484,7 +491,11 @@\n \n \ttcp = ctdb_tcp_find(ctdb->tcp_list, &t);\n \tif (tcp) {\n+\t\tDEBUG(2,(\"Removed tickle info for %s:%u from vnn %u\\n\",\n+\t\t\t inet_ntoa(tcp->daddr.sin_addr), ntohs(tcp->daddr.sin_port),\n+\t\t\t tcp->vnn));\n \t\tDLIST_REMOVE(ctdb->tcp_list, tcp);\n+\t\ttalloc_free(tcp);\n \t}\n \n \treturn 0;\n@@ -503,6 +514,24 @@\n \t\t\tDLIST_REMOVE(ctdb->tcp_list, tcp);\n \t\t\ttalloc_free(tcp);\n \t\t}\n+\n+\t\t/* and tell the new guy about any that he should have\n+\t\t   from us */\n+\t\tif (tcp->vnn == ctdb->vnn) {\n+\t\t\tstruct ctdb_control_tcp_vnn t;\n+\t\t\tTDB_DATA data;\n+\n+\t\t\tt.vnn  = tcp->vnn;\n+\t\t\tt.src  = tcp->saddr;\n+\t\t\tt.dest = tcp->daddr;\n+\n+\t\t\tdata.dptr = (uint8_t *)&t\n+\t\t\tdata.dsize = sizeof(t);\n+\n+\t\t\tctdb_daemon_send_control(ctdb, vnn, 0, \n+\t\t\t\t\t\t CTDB_CONTROL_TCP_ADD,\n+\t\t\t\t\t\t 0, CTDB_CTRL_FLAG_NOREPLY, data, NULL, NULL);\n+\t\t}\n \t}\n \treturn 0;\n }\n\n"}