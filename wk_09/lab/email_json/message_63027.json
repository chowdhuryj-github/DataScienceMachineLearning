{"category": "ham", "to_address": "samba-cvs@samba.org", "from_address": "jra@samba.org", "subject": "svn commit: samba r23728 - in branches: SAMBA_3_0/source/smbd\n\tSAMBA_3_0_25/source/smbd SAMBA_3_0_26/source/smbd", "body": "Author: jra\nDate: 2007-07-05 18:28:18 +0000 (Thu, 05 Jul 2007)\nNew Revision: 23728\n\nWebSVN: http://websvn.samba.org/cgi-bin/viewcvs.cgi?view=rev&root=samba&rev=23728\n\nLog:\nFirst part of bugfix for #4763. Limit notify responses\nto client max buf size.\nJeremy.\n\nModified:\n   branches/SAMBA_3_0/source/smbd/notify.c\n   branches/SAMBA_3_0_25/source/smbd/notify.c\n   branches/SAMBA_3_0_26/source/smbd/notify.c\n\n\nChangeset:\nModified: branches/SAMBA_3_0/source/smbd/notify.c\n===================================================================\n--- branches/SAMBA_3_0/source/smbd/notify.c\t2007-07-05 16:36:15 UTC (rev 23727)\n+++ branches/SAMBA_3_0/source/smbd/notify.c\t2007-07-05 18:28:18 UTC (rev 23728)\n@@ -22,6 +22,9 @@\n \n #include \"includes.h\"\n \n+/* Max size we can send to client in a notify response. */\n+extern int max_send;\n+\n struct notify_change_request {\n \tstruct notify_change_request *prev, *next;\n \tstruct files_struct *fsp;\t/* backpointer for cancel by mid */\n@@ -147,6 +150,15 @@\n \n \tbuflen = smb_size+38+prs_offset(&ps) + 4 /* padding */;\n \n+\tif (buflen > max_send) {\n+\t\t/*\n+\t\t * We exceed what the client is willing to accept. Send\n+\t\t * nothing.\n+\t\t */\n+\t\tchange_notify_reply_packet(request_buf, NT_STATUS_OK);\n+\t\tgoto done;\n+\t}\n+\n \tif (!(outbuf = SMB_MALLOC_ARRAY(char, buflen))) {\n \t\tchange_notify_reply_packet(request_buf, NT_STATUS_NO_MEMORY);\n \t\tgoto done;\n\nModified: branches/SAMBA_3_0_25/source/smbd/notify.c\n===================================================================\n--- branches/SAMBA_3_0_25/source/smbd/notify.c\t2007-07-05 16:36:15 UTC (rev 23727)\n+++ branches/SAMBA_3_0_25/source/smbd/notify.c\t2007-07-05 18:28:18 UTC (rev 23728)\n@@ -22,6 +22,9 @@\n \n #include \"includes.h\"\n \n+/* Max size we can send to client in a notify response. */\n+extern int max_send;\n+\n struct notify_change_request {\n \tstruct notify_change_request *prev, *next;\n \tstruct files_struct *fsp;\t/* backpointer for cancel by mid */\n@@ -146,6 +149,15 @@\n \n \tbuflen = smb_size+38+prs_offset(&ps) + 4 /* padding */;\n \n+\tif (buflen > max_send) {\n+\t\t/*\n+\t\t * We exceed what the client is willing to accept. Send\n+\t\t * nothing.\n+\t\t */\n+\t\tchange_notify_reply_packet(request_buf, NT_STATUS_OK);\n+\t\tgoto done;\n+\t}\n+\n \tif (!(outbuf = SMB_MALLOC_ARRAY(char, buflen))) {\n \t\tchange_notify_reply_packet(request_buf, NT_STATUS_NO_MEMORY);\n \t\tgoto done;\n\nModified: branches/SAMBA_3_0_26/source/smbd/notify.c\n===================================================================\n--- branches/SAMBA_3_0_26/source/smbd/notify.c\t2007-07-05 16:36:15 UTC (rev 23727)\n+++ branches/SAMBA_3_0_26/source/smbd/notify.c\t2007-07-05 18:28:18 UTC (rev 23728)\n@@ -22,6 +22,9 @@\n \n #include \"includes.h\"\n \n+/* Max size we can send to client in a notify response. */\n+extern int max_send;\n+\n struct notify_change_request {\n \tstruct notify_change_request *prev, *next;\n \tstruct files_struct *fsp;\t/* backpointer for cancel by mid */\n@@ -146,6 +149,15 @@\n \n \tbuflen = smb_size+38+prs_offset(&ps) + 4 /* padding */;\n \n+\tif (buflen > max_send) {\n+\t\t/*\n+\t\t * We exceed what the client is willing to accept. Send\n+\t\t * nothing.\n+\t\t */\n+\t\tchange_notify_reply_packet(request_buf, NT_STATUS_OK);\n+\t\tgoto done;\n+\t}\n+\n \tif (!(outbuf = SMB_MALLOC_ARRAY(char, buflen))) {\n \t\tchange_notify_reply_packet(request_buf, NT_STATUS_NO_MEMORY);\n \t\tgoto done;\n\n"}