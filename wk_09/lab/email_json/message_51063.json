{"category": "ham", "to_address": "samba-cvs@samba.org", "from_address": "abartlet@samba.org", "subject": "svn commit: samba r23551 - in branches/SAMBA_4_0/source:\n\tlib/registry lib/util librpc/rpc rpc_server/epmapper torture/basic", "body": "Author: abartlet\nDate: 2007-06-20 04:15:39 +0000 (Wed, 20 Jun 2007)\nNew Revision: 23551\n\nWebSVN: http://websvn.samba.org/cgi-bin/viewcvs.cgi?view=rev&root=samba&rev=23551\n\nLog:\nChange data_blob_equal to data_blob_cmp, suitable for sorting with qsort().\n\nAndrew Bartlett\n\nModified:\n   branches/SAMBA_4_0/source/lib/registry/patchfile.c\n   branches/SAMBA_4_0/source/lib/util/data_blob.c\n   branches/SAMBA_4_0/source/librpc/rpc/dcerpc.c\n   branches/SAMBA_4_0/source/rpc_server/epmapper/rpc_epmapper.c\n   branches/SAMBA_4_0/source/torture/basic/aliases.c\n\n\nChangeset:\nModified: branches/SAMBA_4_0/source/lib/registry/patchfile.c\n===================================================================\n--- branches/SAMBA_4_0/source/lib/registry/patchfile.c\t2007-06-20 01:26:18 UTC (rev 23550)\n+++ branches/SAMBA_4_0/source/lib/registry/patchfile.c\t2007-06-20 04:15:39 UTC (rev 23551)\n@@ -125,7 +125,7 @@\n \t\t\treturn error2;\n \t\t}\n \n-\t\tif (W_ERROR_IS_OK(error2) && data_blob_equal(&v1->data, &v2->data))\n+\t\tif (W_ERROR_IS_OK(error2) && data_blob_cmp(&v1->data, &v2->data) == 0)\n \t\t\tcontinue;\n \n \t\tthiskey = diff_find_add_key(diff, oldkey->path);\n\nModified: branches/SAMBA_4_0/source/lib/util/data_blob.c\n===================================================================\n--- branches/SAMBA_4_0/source/lib/util/data_blob.c\t2007-06-20 01:26:18 UTC (rev 23550)\n+++ branches/SAMBA_4_0/source/lib/util/data_blob.c\t2007-06-20 04:15:39 UTC (rev 23551)\n@@ -130,21 +130,23 @@\n /**\n check if two data blobs are equal\n **/\n-_PUBLIC_ BOOL data_blob_equal(const DATA_BLOB *d1, const DATA_BLOB *d2)\n+_PUBLIC_ int data_blob_cmp(const DATA_BLOB *d1, const DATA_BLOB *d2)\n {\n-\tif (d1->length != d2->length) {\n-\t\treturn False;\n+\tint ret;\n+\tif (d1->data == NULL && d2->data != NULL) {\n+\t\treturn -1;\n \t}\n+\tif (d1->data != NULL && d2->data == NULL) {\n+\t\treturn 1;\n+\t}\n \tif (d1->data == d2->data) {\n-\t\treturn True;\n+\t\treturn d1->length - d2->length;\n \t}\n-\tif (d1->data == NULL || d2->data == NULL) {\n-\t\treturn False;\n+\tret = memcmp(d1->data, d2->data, MIN(d1->length, d2->length));\n+\tif (ret == 0) {\n+\t\treturn d1->length - d2->length;\n \t}\n-\tif (memcmp(d1->data, d2->data, d1->length) == 0) {\n-\t\treturn True;\n-\t}\n-\treturn False;\n+\treturn ret;\n }\n \n /**\n\nModified: branches/SAMBA_4_0/source/librpc/rpc/dcerpc.c\n===================================================================\n--- branches/SAMBA_4_0/source/librpc/rpc/dcerpc.c\t2007-06-20 01:26:18 UTC (rev 23550)\n+++ branches/SAMBA_4_0/source/librpc/rpc/dcerpc.c\t2007-06-20 04:15:39 UTC (rev 23551)\n@@ -1193,7 +1193,7 @@\n \n \tblob2 = ndr_push_blob(push);\n \n-\tif (!data_blob_equal(&blob, &blob2)) {\n+\tif (data_blob_cmp(&blob, &blob2) != 0) {\n \t\tDEBUG(3,(\"original:\\n\"));\n \t\tdump_data(3, blob.data, blob.length);\n \t\tDEBUG(3,(\"secondary:\\n\"));\n@@ -1276,7 +1276,7 @@\n \n \tblob2 = ndr_push_blob(push);\n \n-\tif (!data_blob_equal(&blob, &blob2)) {\n+\tif (data_blob_cmp(&blob, &blob2) != 0) {\n \t\tDEBUG(3,(\"original:\\n\"));\n \t\tdump_data(3, blob.data, blob.length);\n \t\tDEBUG(3,(\"secondary:\\n\"));\n\nModified: branches/SAMBA_4_0/source/rpc_server/epmapper/rpc_epmapper.c\n===================================================================\n--- branches/SAMBA_4_0/source/rpc_server/epmapper/rpc_epmapper.c\t2007-06-20 01:26:18 UTC (rev 23550)\n+++ branches/SAMBA_4_0/source/rpc_server/epmapper/rpc_epmapper.c\t2007-06-20 04:15:39 UTC (rev 23551)\n@@ -218,8 +218,8 @@\n \n \tfor (i=0;iin.map_tower->tower.floors[0].lhs.lhs_data, \n-\t\t\t&eps[i].ep.floors[0].lhs.lhs_data) \n+\t\t\tdata_blob_cmp(&r->in.map_tower->tower.floors[0].lhs.lhs_data, \n+\t\t\t&eps[i].ep.floors[0].lhs.lhs_data) != 0 \n \t\t\t|| transport != dcerpc_transport_by_tower(&eps[i].ep)) {\n \t\t\tcontinue;\n \t\t}\n\nModified: branches/SAMBA_4_0/source/torture/basic/aliases.c\n===================================================================\n--- branches/SAMBA_4_0/source/torture/basic/aliases.c\t2007-06-20 01:26:18 UTC (rev 23550)\n+++ branches/SAMBA_4_0/source/torture/basic/aliases.c\t2007-06-20 04:15:39 UTC (rev 23551)\n@@ -68,8 +68,8 @@\n \tfor (t2b=alias_blobs; t2b; t2b=t2b->next) {\n \t\tfor (t2b2=alias_blobs; t2b2; t2b2=t2b2->next) {\n \t\t\tif (t2b->level >= t2b2->level) continue;\n-\t\t\tif (data_blob_equal(&t2b->params, &t2b2->params) &&\n-\t\t\t    data_blob_equal(&t2b->data, &t2b2->data)) {\n+\t\t\tif (data_blob_cmp(&t2b->params, &t2b2->params) == 0 &&\n+\t\t\t    data_blob_cmp(&t2b->data, &t2b2->data) == 0) {\n \t\t\t\ttorture_comment(tctx, \n \t\t\t\t\"\\tLevel %u (0x%x) and level %u (0x%x) are possible aliases\\n\", \n \t\t\t\t       t2b->level, t2b->level, t2b2->level, t2b2->level);\n\n"}