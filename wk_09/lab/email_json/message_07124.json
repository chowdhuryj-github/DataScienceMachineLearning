{"category": "ham", "to_address": "samba-cvs@samba.org", "from_address": "Jelmer Vernooij <jelmer@samba.org>", "subject": "Rev 11877: Make the actual domain join work by using a different\n\tnetbios name than the the dc. in\n\tfile:///home/jelmer/bzr.samba/SAMBA_4_0/", "body": "At file:///home/jelmer/bzr.samba/SAMBA_4_0/\n\n------------------------------------------------------------\nrevno: 11877\nrevision-id: jelmer@samba.org-20070416215315-ntt9aikw1i1nbpgl\nparent: jelmer@samba.org-20070416204856-62lyprph2k1ob7qh\ncommitter: Jelmer Vernooij \nbranch nick: SAMBA_4_0\ntimestamp: Mon 2007-04-16 23:53:15 +0200\nmessage:\n  Make the actual domain join work by using a different netbios name than the the dc.\nmodified:\n  source/script/tests/Samba4.pm  svn-v2:21707@0c0555d6-39d7-0310-84fc-f1cc0bd64818-branches%2fSAMBA_4_0-source%2fscript%2ftests%2fSamba4.pm\n  source/script/tests/mksamba4server.pl svn-v2:22260@0c0555d6-39d7-0310-84fc-f1cc0bd64818-branches%2fSAMBA_4_0-source%2fscript%2ftests%2fmksamba4server.sh\n  testprogs/blackbox/test_kinit.sh* svn-v2:22235@0c0555d6-39d7-0310-84fc-f1cc0bd64818-branches%2fSAMBA_4_0-testprogs%2fblackbox%2ftest_kinit.sh\n=== modified file 'source/script/tests/Samba4.pm'\n--- a/source/script/tests/Samba4.pm\t2007-04-16 20:48:56 +0000\n+++ b/source/script/tests/Samba4.pm\t2007-04-16 21:53:15 +0000\n@@ -93,7 +93,7 @@\n \t\tif (defined($max_time)) {\n \t\t\t$optarg = \"--maximum-runtime=$max_time \";\n \t\t}\n-\t\tmy $ret = system(\"$valgrind $self->{bindir}/smbd $optarg -s $env_vars->{CONFFILE} -M single -i --leak-report-full\");\n+\t\tmy $ret = system(\"$valgrind $self->{bindir}/smbd $optarg $env_vars->{CONFIGURATION} -M single -i --leak-report-full\");\n \t\tif ($? == -1) {\n \t\t\tprint \"Unable to start smbd: $ret: $!\\n\";\n \t\t\texit 1;\n@@ -140,14 +140,14 @@\n \tmy ($self, $prefix, $dcvars) = @_;\n \tmy %ret = ();\n \tprint \"PROVISIONING...\";\n-\topen(IN, \"$RealBin/mksamba4server.pl --netbiosname=nbmember --server-role=\\\"member server\\\" $prefix|\") or die(\"Unable to setup\");\n+\topen(IN, \"$RealBin/mksamba4server.pl --netbios-name=nbmember --server-role=\\\"member server\\\" $prefix|\") or die(\"Unable to setup\");\n \twhile () {\n \t\tdie (\"Error parsing `$_'\") unless (/^([A-Z0-9a-z_]+)=(.*)$/);\n \t\t$ret{$1} = $2;\n \t}\n \tclose(IN);\n \n-\tsystem(\"$self->{bindir}/net join $ret{CONFIGURATION} $dcvars->{DOMAIN} member -U$dcvars->{USERNAME}\\%$dcvars->{PASSWORD}\") or die(\"Join failed\");\n+\tsystem(\"$self->{bindir}/net join $ret{CONFIGURATION} $dcvars->{DOMAIN} member -U$dcvars->{USERNAME}\\%$dcvars->{PASSWORD}\") == 0 or die(\"Join failed\");\n \n \t$ret{SMBD_TEST_FIFO} = \"$prefix/smbd_test.fifo\";\n \t$ret{SMBD_TEST_LOG} = \"$prefix/smbd_test.log\";\n\n=== modified file 'source/script/tests/mksamba4server.pl'\n--- a/source/script/tests/mksamba4server.pl\t2007-04-16 20:48:56 +0000\n+++ b/source/script/tests/mksamba4server.pl\t2007-04-16 21:53:15 +0000\n@@ -267,7 +267,9 @@\n \n (system(\"$srcdir/bin/smbscript $srcdir/setup/provision \" .  join(' ', @provision_options) . \">&2\") == 0) or die(\"Unable to provision\");\n \n-my $ldap_uri=\"ldapi://\" . `echo $ldapdir/ldapi | sed 's|/|%2F|g'`;\n+my $ldap_uri= \"$ldapdir/ldapi\";\n+$ldap_uri =~ s|/|%2F|g;\n+$ldap_uri = \"ldapi://$ldap_uri\";\n my $provision_aci = \"\";\n \n if (not defined($opt_ldap)) {\n@@ -293,9 +295,8 @@\n close(LDIF);\n \n system(\"$srcdir/bin/ldbadd -H $privatedir/wins_config.ldb < $privatedir/wins_config.ldif >/dev/null\") == 0 or die(\"Unable to add wins configuration\");\n-;\n+\n print \"KRB5_CONFIG=$krb5_config\\n\";\n-print \"SLAPD_CONF=$slapd_conf\\n\";\n print \"PIDDIR=$piddir\\n\";\n print \"SERVER=$server\\n\";\n print \"NETBIOSNAME=$netbiosname\\n\";\n\n=== modified file 'testprogs/blackbox/test_kinit.sh' (properties changed)\n\n"}