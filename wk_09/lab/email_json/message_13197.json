{"category": "ham", "to_address": "samba-cvs@samba.org", "from_address": "jra@samba.org", "subject": "svn commit: samba r22481 - in branches: SAMBA_3_0/source/lib\n\tSAMBA_3_0/source/smbd SAMBA_3_0_25/source/lib\n\tSAMBA_3_0_25/source/smbd", "body": "Author: jra\nDate: 2007-04-23 09:19:35 +0000 (Mon, 23 Apr 2007)\nNew Revision: 22481\n\nWebSVN: http://websvn.samba.org/cgi-bin/viewcvs.cgi?view=rev&root=samba&rev=22481\n\nLog:\nMove check for non-mappable SIDs to after sid_to_uid,\nsid_to_gid mapping, add LocalSystem to non-mappable\nlist.\nJeremy.\n\nModified:\n   branches/SAMBA_3_0/source/lib/util_sid.c\n   branches/SAMBA_3_0/source/smbd/posix_acls.c\n   branches/SAMBA_3_0_25/source/lib/util_sid.c\n   branches/SAMBA_3_0_25/source/smbd/posix_acls.c\n\n\nChangeset:\nModified: branches/SAMBA_3_0/source/lib/util_sid.c\n===================================================================\n--- branches/SAMBA_3_0/source/lib/util_sid.c\t2007-04-23 08:46:10 UTC (rev 22480)\n+++ branches/SAMBA_3_0/source/lib/util_sid.c\t2007-04-23 09:19:35 UTC (rev 22481)\n@@ -510,6 +510,9 @@\n \tDOM_SID dom;\n \tuint32 rid;\n \n+\tif (sid_equal(sid, &global_sid_System))\n+\t\treturn True;\n+\n \tsid_copy(&dom, sid);\n \tsid_split_rid(&dom, &rid);\n \n\nModified: branches/SAMBA_3_0/source/smbd/posix_acls.c\n===================================================================\n--- branches/SAMBA_3_0/source/smbd/posix_acls.c\t2007-04-23 08:46:10 UTC (rev 22480)\n+++ branches/SAMBA_3_0/source/smbd/posix_acls.c\t2007-04-23 09:19:35 UTC (rev 22481)\n@@ -1347,17 +1347,6 @@\n \t\tSEC_ACE *psa = &dacl->aces[i];\n \n \t\t/*\n-\t\t * Ignore non-mappable SIDs (NT Authority, BUILTIN etc).\n-\t\t */\n-\n-\t\tif (non_mappable_sid(&psa->trustee)) {\n-\t\t\tfstring str;\n-\t\t\tDEBUG(10,(\"create_canon_ace_lists: ignoring non-mappable SID %s\\n\",\n-\t\t\t\tsid_to_string(str, &psa->trustee) ));\n-\t\t\tcontinue;\n-\t\t}\n-\n-\t\t/*\n \t\t * Create a cannon_ace entry representing this NT DACL ACE.\n \t\t */\n \n@@ -1417,6 +1406,16 @@\n \t\t} else {\n \t\t\tfstring str;\n \n+\t\t\t/*\n+\t\t\t * Silently ignore map failures in non-mappable SIDs (NT Authority, BUILTIN etc).\n+\t\t\t */\n+\n+\t\t\tif (non_mappable_sid(&psa->trustee)) {\n+\t\t\t\tDEBUG(10,(\"create_canon_ace_lists: ignoring non-mappable SID %s\\n\",\n+\t\t\t\t\tsid_to_string(str, &psa->trustee) ));\n+\t\t\t\tcontinue;\n+\t\t\t}\n+\n \t\t\tfree_canon_ace_list(file_ace);\n \t\t\tfree_canon_ace_list(dir_ace);\n \t\t\tDEBUG(0,(\"create_canon_ace_lists: unable to map SID %s to uid or gid.\\n\",\n\nModified: branches/SAMBA_3_0_25/source/lib/util_sid.c\n===================================================================\n--- branches/SAMBA_3_0_25/source/lib/util_sid.c\t2007-04-23 08:46:10 UTC (rev 22480)\n+++ branches/SAMBA_3_0_25/source/lib/util_sid.c\t2007-04-23 09:19:35 UTC (rev 22481)\n@@ -510,6 +510,9 @@\n \tDOM_SID dom;\n \tuint32 rid;\n \n+\tif (sid_equal(sid, &global_sid_System))\n+\t\treturn True;\n+\n \tsid_copy(&dom, sid);\n \tsid_split_rid(&dom, &rid);\n \n\nModified: branches/SAMBA_3_0_25/source/smbd/posix_acls.c\n===================================================================\n--- branches/SAMBA_3_0_25/source/smbd/posix_acls.c\t2007-04-23 08:46:10 UTC (rev 22480)\n+++ branches/SAMBA_3_0_25/source/smbd/posix_acls.c\t2007-04-23 09:19:35 UTC (rev 22481)\n@@ -1347,17 +1347,6 @@\n \t\tSEC_ACE *psa = &dacl->aces[i];\n \n \t\t/*\n-\t\t * Ignore non-mappable SIDs (NT Authority, BUILTIN etc).\n-\t\t */\n-\n-\t\tif (non_mappable_sid(&psa->trustee)) {\n-\t\t\tfstring str;\n-\t\t\tDEBUG(10,(\"create_canon_ace_lists: ignoring non-mappable SID %s\\n\",\n-\t\t\t\tsid_to_string(str, &psa->trustee) ));\n-\t\t\tcontinue;\n-\t\t}\n-\n-\t\t/*\n \t\t * Create a cannon_ace entry representing this NT DACL ACE.\n \t\t */\n \n@@ -1417,6 +1406,16 @@\n \t\t} else {\n \t\t\tfstring str;\n \n+\t\t\t/*\n+\t\t\t * Silently ignore map failures in non-mappable SIDs (NT Authority, BUILTIN etc).\n+\t\t\t */\n+\n+\t\t\tif (non_mappable_sid(&psa->trustee)) {\n+\t\t\t\tDEBUG(10,(\"create_canon_ace_lists: ignoring non-mappable SID %s\\n\",\n+\t\t\t\t\tsid_to_string(str, &psa->trustee) ));\n+\t\t\t\tcontinue;\n+\t\t\t}\n+\n \t\t\tfree_canon_ace_list(file_ace);\n \t\t\tfree_canon_ace_list(dir_ace);\n \t\t\tDEBUG(0,(\"create_canon_ace_lists: unable to map SID %s to uid or gid.\\n\",\n\n"}