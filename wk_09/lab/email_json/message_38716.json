{"category": "ham", "to_address": "samba-cvs@samba.org", "from_address": "tridge@samba.org", "subject": "Rev 401: we need to listen at transport initialise stage to find\n\tour own node number in http://samba.org/~tridge/ctdb", "body": "------------------------------------------------------------\nrevno: 401\nrevision-id: tridge@samba.org-20070530044614-e6rt2yb1v1345p34\nparent: tridge@samba.org-20070530043522-e7fwbj5jcoq6m8b1\ncommitter: Andrew Tridgell \nbranch nick: tridge\ntimestamp: Wed 2007-05-30 14:46:14 +1000\nmessage:\n  we need to listen at transport initialise stage to find our own node number\nmodified:\n  common/ctdb_monitor.c          ctdb_monitor.c-20070518100625-8jf4ft1mjzmb22ck-1\n  ib/ibw_ctdb_init.c             ibw_ctdb_init.c-20070102171305-cn2z4k7ibx8141d5-1\n  tcp/tcp_init.c                 tcp_init.c-20061128004937-x70q1cu5xzg5g2tm-2\n=== modified file 'common/ctdb_monitor.c'\n--- a/common/ctdb_monitor.c\t2007-05-20 23:24:34 +0000\n+++ b/common/ctdb_monitor.c\t2007-05-30 04:46:14 +0000\n@@ -64,13 +64,14 @@\n \n \t\tif (node->dead_count >= CTDB_MONITORING_DEAD_COUNT) {\n \t\t\tctdb_node_dead(node);\n+\t\t\tctdb_send_keepalive(ctdb, node->vnn);\n \t\t\t/* maybe tell the transport layer to kill the\n \t\t\t   sockets as well?\n \t\t\t*/\n \t\t\tcontinue;\n \t\t}\n \t\t\n-\t\tif (node->tx_cnt == 0) {\n+\t\tif (node->tx_cnt == 0 && (node->flags & NODE_FLAGS_CONNECTED)) {\n \t\t\tctdb_send_keepalive(ctdb, node->vnn);\n \t\t}\n \n\n=== modified file 'ib/ibw_ctdb_init.c'\n--- a/ib/ibw_ctdb_init.c\t2007-05-30 03:26:50 +0000\n+++ b/ib/ibw_ctdb_init.c\t2007-05-30 04:46:14 +0000\n@@ -88,6 +88,10 @@\n \t\t}\n \t}\n \n+\t/* listen on our own address */\n+\tif (ctdb_ibw_listen(ctdb, 10)) /* TODO: backlog as param */\n+\t\treturn -1;\n+\n \treturn 0;\n }\n \n@@ -99,10 +103,6 @@\n {\n \tint i, ret;\n \n-\t/* listen on our own address */\n-\tif (ctdb_ibw_listen(ctdb, 10)) /* TODO: backlog as param */\n-\t\treturn -1;\n-\n \t/* everything async here */\n \tfor (i=0;inum_nodes;i++) {\n \t\tstruct ctdb_node *node = ctdb->nodes[i];\n\n=== modified file 'tcp/tcp_init.c'\n--- a/tcp/tcp_init.c\t2007-05-30 03:26:50 +0000\n+++ b/tcp/tcp_init.c\t2007-05-30 04:46:14 +0000\n@@ -52,6 +52,9 @@\n {\n \tint i;\n \n+\t/* listen on our own address */\n+\tif (ctdb_tcp_listen(ctdb) != 0) return -1;\n+\n \tfor (i=0; inum_nodes; i++) {\n \t\tif (ctdb_tcp_add_node(ctdb->nodes[i]) != 0) {\n \t\t\tDEBUG(0, (\"methods->add_node failed at %d\\n\", i));\n@@ -69,9 +72,6 @@\n {\n \tint i;\n \n-\t/* listen on our own address */\n-\tif (ctdb_tcp_listen(ctdb) != 0) return -1;\n-\n \t/* startup connections to the other servers - will happen on\n \t   next event loop */\n \tfor (i=0;inum_nodes;i++) {\n\n"}