{"category": "ham", "to_address": "samba-cvs@samba.org", "from_address": "tridge@samba.org", "subject": "Rev 93: added --num-clients option to ctdb_messaging test in\n\thttp://samba.org/~tridge/ctdb", "body": "------------------------------------------------------------\nrevno: 93\nrevision-id: tridge@samba.org-20070411052350-eb4fe86cc87ea5ed\nparent: tridge@samba.org-20070411050922-59469f0a8a24cf4b\ncommitter: Andrew Tridgell \nbranch nick: tridge\ntimestamp: Wed 2007-04-11 15:23:50 +1000\nmessage:\n  added --num-clients option to ctdb_messaging test\nmodified:\n  tests/ctdb_messaging.c         ctdb_messaging.c-20070411034205-6d6vne56pbih2x1p-1\n=== modified file 'tests/ctdb_messaging.c'\n--- a/tests/ctdb_messaging.c\t2007-04-11 05:09:22 +0000\n+++ b/tests/ctdb_messaging.c\t2007-04-11 05:23:50 +0000\n@@ -27,6 +27,7 @@\n static int num_records = 10;\n static int num_msgs = 1;\n static int num_repeats = 100;\n+static int num_clients = 2;\n \n \n /*\n@@ -36,6 +37,7 @@\n \t\t\t\t TDB_DATA data, void *private)\n {\n \tprintf(\"client vnn:%d received a message to srvid:%d\\n\",ctdb_get_vnn(ctdb),srvid);\n+\tfflush(stdout);\n }\n \n /*\n@@ -61,16 +63,17 @@\n \t\t{ \"timelimit\", 't', POPT_ARG_INT, &timelimit, 0, \"timelimit\", \"integer\" },\n \t\t{ \"num-records\", 'r', POPT_ARG_INT, &num_records, 0, \"num_records\", \"integer\" },\n \t\t{ \"num-msgs\", 'n', POPT_ARG_INT, &num_msgs, 0, \"num_msgs\", \"integer\" },\n+\t\t{ \"num-clients\", 0, POPT_ARG_INT, &num_clients, 0, \"num_clients\", \"integer\" },\n \t\tPOPT_TABLEEND\n \t};\n \tint opt;\n \tconst char **extra_argv;\n \tint extra_argc = 0;\n-\tint ret;\n+\tint ret, i, j;\n \tpoptContext pc;\n \tstruct event_context *ev;\n \tpid_t pid;\n-\tuint32_t srvid;\n+\tint srvid;\n \tTDB_DATA data;\n \n \tpc = poptGetContext(argv[0], argc, argv, popt_options, POPT_CONTEXT_KEEP_FIRST);\n@@ -142,11 +145,16 @@\n \t/* start the protocol running */\n \tret = ctdb_start(ctdb);\n \n-\tpid=fork();\n-\tif (pid) {\n-\t\tsrvid=0;\n-\t} else {\n-\t\tsrvid=1;\n+\tsrvid = -1;\n+\tfor (i=0;i<num_clients-1;i++) {\n+\t\tpid=fork();\n+\t\tif (pid) {\n+\t\t\tsrvid = i;\n+\t\t\tbreak;\n+\t\t}\n+\t}\n+\tif (srvid == -1) {\n+\t\tsrvid = num_clients-1;\n \t}\n \n \t/* wait until all nodes are connected (should not be needed\n@@ -157,12 +165,17 @@\n \n \tctdb_connect_wait(ctdb);\n \n-\tsleep(2);\n+\tsleep(1);\n \n \tprintf(\"sending message from vnn:%d to vnn:%d/srvid:%d\\n\",ctdb_get_vnn(ctdb),ctdb_get_vnn(ctdb), 1-srvid);\n-\tctdb_send_message(ctdb, ctdb_get_vnn(ctdb), 1-srvid, data);\n+\tfor (i=0;i<ctdb_get_num_nodes(ctdb);i++) {\n+\t\tfor (j=0;j<num_clients;j++) {\n+\t\t\tprintf(\"sending message to %d:%d\\n\", i, j);\n+\t\t\tctdb_send_message(ctdb, i, j, data);\n+\t\t}\n+\t}\n \n-\twhile(1){\n+\twhile (1) {\n \t\tevent_loop_once(ev);\n \t}\n        \n\n"}