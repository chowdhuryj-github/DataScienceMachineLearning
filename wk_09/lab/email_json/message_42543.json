{"category": "ham", "to_address": "samba-cvs@samba.org", "from_address": "jra@samba.org", "subject": "svn commit: samba r23349 - in branches: SAMBA_3_0/source/nmbd\n\tSAMBA_3_0_25/source/nmbd SAMBA_3_0_26/source/nmbd", "body": "Author: jra\nDate: 2007-06-05 01:59:37 +0000 (Tue, 05 Jun 2007)\nNew Revision: 23349\n\nWebSVN: http://websvn.samba.org/cgi-bin/viewcvs.cgi?view=rev&root=samba&rev=23349\n\nLog:\nFix from Steve Langasek  to\nallow SIGTERM to cause nmbd to exit on awaiting\nan interface to come up. Debian bug #168079\nJeremy.\n\nModified:\n   branches/SAMBA_3_0/source/nmbd/nmbd_subnetdb.c\n   branches/SAMBA_3_0_25/source/nmbd/nmbd_subnetdb.c\n   branches/SAMBA_3_0_26/source/nmbd/nmbd_subnetdb.c\n\n\nChangeset:\nModified: branches/SAMBA_3_0/source/nmbd/nmbd_subnetdb.c\n===================================================================\n--- branches/SAMBA_3_0/source/nmbd/nmbd_subnetdb.c\t2007-06-04 23:51:19 UTC (rev 23348)\n+++ branches/SAMBA_3_0/source/nmbd/nmbd_subnetdb.c\t2007-06-05 01:59:37 UTC (rev 23349)\n@@ -185,12 +185,28 @@\n \tstruct in_addr unicast_ip, ipzero;\n \n \tif(num_interfaces == 0) {\n+\t\tvoid (*saved_handler)(int);\n+\n \t\tDEBUG(0,(\"create_subnets: No local interfaces !\\n\"));\n \t\tDEBUG(0,(\"create_subnets: Waiting for an interface to appear ...\\n\"));\n+\n+\t\t/* \n+\t\t * Whilst we're waiting for an interface, allow SIGTERM to\n+\t\t * cause us to exit.\n+\t\t */\n+\n+\t\tsaved_handler = CatchSignal( SIGTERM, SIGNAL_CAST SIG_DFL );\n+\n \t\twhile (iface_count() == 0) {\n \t\t\tsleep(5);\n \t\t\tload_interfaces();\n \t\t}\n+\n+\t\t/* \n+\t\t * We got an interface, restore our normal term handler.\n+\t\t */\n+\n+\t\tCatchSignal( SIGTERM, SIGNAL_CAST saved_handler );\n \t}\n \n \tnum_interfaces = iface_count();\n\nModified: branches/SAMBA_3_0_25/source/nmbd/nmbd_subnetdb.c\n===================================================================\n--- branches/SAMBA_3_0_25/source/nmbd/nmbd_subnetdb.c\t2007-06-04 23:51:19 UTC (rev 23348)\n+++ branches/SAMBA_3_0_25/source/nmbd/nmbd_subnetdb.c\t2007-06-05 01:59:37 UTC (rev 23349)\n@@ -185,12 +185,28 @@\n \tstruct in_addr unicast_ip, ipzero;\n \n \tif(num_interfaces == 0) {\n+\t\tvoid (*saved_handler)(int);\n+\n \t\tDEBUG(0,(\"create_subnets: No local interfaces !\\n\"));\n \t\tDEBUG(0,(\"create_subnets: Waiting for an interface to appear ...\\n\"));\n+\n+\t\t/* \n+\t\t * Whilst we're waiting for an interface, allow SIGTERM to\n+\t\t * cause us to exit.\n+\t\t */\n+\n+\t\tsaved_handler = CatchSignal( SIGTERM, SIGNAL_CAST SIG_DFL );\n+\n \t\twhile (iface_count() == 0) {\n \t\t\tsleep(5);\n \t\t\tload_interfaces();\n \t\t}\n+\n+\t\t/* \n+\t\t * We got an interface, restore our normal term handler.\n+\t\t */\n+\n+\t\tCatchSignal( SIGTERM, SIGNAL_CAST saved_handler );\n \t}\n \n \tnum_interfaces = iface_count();\n\nModified: branches/SAMBA_3_0_26/source/nmbd/nmbd_subnetdb.c\n===================================================================\n--- branches/SAMBA_3_0_26/source/nmbd/nmbd_subnetdb.c\t2007-06-04 23:51:19 UTC (rev 23348)\n+++ branches/SAMBA_3_0_26/source/nmbd/nmbd_subnetdb.c\t2007-06-05 01:59:37 UTC (rev 23349)\n@@ -185,12 +185,28 @@\n \tstruct in_addr unicast_ip, ipzero;\n \n \tif(num_interfaces == 0) {\n+\t\tvoid (*saved_handler)(int);\n+\n \t\tDEBUG(0,(\"create_subnets: No local interfaces !\\n\"));\n \t\tDEBUG(0,(\"create_subnets: Waiting for an interface to appear ...\\n\"));\n+\n+\t\t/* \n+\t\t * Whilst we're waiting for an interface, allow SIGTERM to\n+\t\t * cause us to exit.\n+\t\t */\n+\n+\t\tsaved_handler = CatchSignal( SIGTERM, SIGNAL_CAST SIG_DFL );\n+\n \t\twhile (iface_count() == 0) {\n \t\t\tsleep(5);\n \t\t\tload_interfaces();\n \t\t}\n+\n+\t\t/* \n+\t\t * We got an interface, restore our normal term handler.\n+\t\t */\n+\n+\t\tCatchSignal( SIGTERM, SIGNAL_CAST saved_handler );\n \t}\n \n \tnum_interfaces = iface_count();\n\n"}