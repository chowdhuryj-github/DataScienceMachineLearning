{"category": "ham", "to_address": "samba-cvs@samba.org", "from_address": "vlendec@samba.org", "subject": "svn commit: samba r23595 - in branches: SAMBA_3_0/source/lib\n\tSAMBA_3_0_26/source/lib", "body": "Author: vlendec\nDate: 2007-06-24 13:40:58 +0000 (Sun, 24 Jun 2007)\nNew Revision: 23595\n\nWebSVN: http://websvn.samba.org/cgi-bin/viewcvs.cgi?view=rev&root=samba&rev=23595\n\nLog:\nOne pstring a day...\nModified:\n   branches/SAMBA_3_0/source/lib/pidfile.c\n   branches/SAMBA_3_0_26/source/lib/pidfile.c\n\n\nChangeset:\nModified: branches/SAMBA_3_0/source/lib/pidfile.c\n===================================================================\n--- branches/SAMBA_3_0/source/lib/pidfile.c\t2007-06-24 13:24:20 UTC (rev 23594)\n+++ branches/SAMBA_3_0/source/lib/pidfile.c\t2007-06-24 13:40:58 UTC (rev 23595)\n@@ -34,12 +34,15 @@\n \tchar pidstr[20];\n \tpid_t pid;\n \tunsigned int ret;\n-\tpstring pidFile;\n+\tchar * pidFile;\n \n-\tslprintf(pidFile, sizeof(pidFile)-1, \"%s/%s.pid\", lp_piddir(), name);\n+\tif (asprintf(&pidFile, \"%s/%s.pid\", lp_piddir(), name) == -1) {\n+\t\treturn 0;\n+\t}\n \n \tfd = sys_open(pidFile, O_NONBLOCK | O_RDONLY, 0644);\n \tif (fd == -1) {\n+\t\tSAFE_FREE(pidFile);\n \t\treturn 0;\n \t}\n \n@@ -68,12 +71,14 @@\n \t\tgoto noproc;\n \t}\n \n+\tSAFE_FREE(pidFile);\n \tclose(fd);\n \treturn (pid_t)ret;\n \n  noproc:\n \tclose(fd);\n \tunlink(pidFile);\n+\tSAFE_FREE(pidFile);\n \treturn 0;\n }\n \n@@ -83,14 +88,14 @@\n \tint     fd;\n \tchar    buf[20];\n \tchar    *short_configfile;\n-\tpstring name;\n-\tpstring pidFile;\n+\tchar *name;\n+\tchar *pidFile;\n \tpid_t pid;\n \n \t/* Add a suffix to the program name if this is a process with a\n \t * none default configuration file name. */\n \tif (strcmp( CONFIGFILE, dyn_CONFIGFILE) == 0) {\n-\t\tstrncpy( name, program_name, sizeof( name)-1);\n+\t\tname = SMB_STRDUP(program_name);\n \t} else {\n \t\tshort_configfile = strrchr( dyn_CONFIGFILE, '/');\n \t\tif (short_configfile == NULL) {\n@@ -100,10 +105,15 @@\n \t\t\t/* full/relative path provided */\n \t\t\tshort_configfile++;\n \t\t}\n-\t\tslprintf( name, sizeof( name)-1, \"%s-%s\", program_name, short_configfile+1);\n+\t\tif (asprintf(&name, \"%s-%s\", program_name,\n+\t\t\t     short_configfile+1) == -1) {\n+\t\t\tsmb_panic(\"asprintf failed\");\n+\t\t}\n \t}\n \n-\tslprintf(pidFile, sizeof(pidFile)-1, \"%s/%s.pid\", lp_piddir(), name);\n+\tif (asprintf(&pidFile, \"%s/%s.pid\", lp_piddir(), name) == -1) {\n+\t\tsmb_panic(\"asprintf failed\");\n+\t}\n \n \tpid = pidfile_pid(name);\n \tif (pid != 0) {\n@@ -133,4 +143,6 @@\n \t\texit(1);\n \t}\n \t/* Leave pid file open & locked for the duration... */\n+\tSAFE_FREE(name);\n+\tSAFE_FREE(pidFile);\n }\n\nModified: branches/SAMBA_3_0_26/source/lib/pidfile.c\n===================================================================\n--- branches/SAMBA_3_0_26/source/lib/pidfile.c\t2007-06-24 13:24:20 UTC (rev 23594)\n+++ branches/SAMBA_3_0_26/source/lib/pidfile.c\t2007-06-24 13:40:58 UTC (rev 23595)\n@@ -34,12 +34,15 @@\n \tchar pidstr[20];\n \tpid_t pid;\n \tunsigned int ret;\n-\tpstring pidFile;\n+\tchar * pidFile;\n \n-\tslprintf(pidFile, sizeof(pidFile)-1, \"%s/%s.pid\", lp_piddir(), name);\n+\tif (asprintf(&pidFile, \"%s/%s.pid\", lp_piddir(), name) == -1) {\n+\t\treturn 0;\n+\t}\n \n \tfd = sys_open(pidFile, O_NONBLOCK | O_RDONLY, 0644);\n \tif (fd == -1) {\n+\t\tSAFE_FREE(pidFile);\n \t\treturn 0;\n \t}\n \n@@ -68,12 +71,14 @@\n \t\tgoto noproc;\n \t}\n \n+\tSAFE_FREE(pidFile);\n \tclose(fd);\n \treturn (pid_t)ret;\n \n  noproc:\n \tclose(fd);\n \tunlink(pidFile);\n+\tSAFE_FREE(pidFile);\n \treturn 0;\n }\n \n@@ -83,14 +88,14 @@\n \tint     fd;\n \tchar    buf[20];\n \tchar    *short_configfile;\n-\tpstring name;\n-\tpstring pidFile;\n+\tchar *name;\n+\tchar *pidFile;\n \tpid_t pid;\n \n \t/* Add a suffix to the program name if this is a process with a\n \t * none default configuration file name. */\n \tif (strcmp( CONFIGFILE, dyn_CONFIGFILE) == 0) {\n-\t\tstrncpy( name, program_name, sizeof( name)-1);\n+\t\tname = SMB_STRDUP(program_name);\n \t} else {\n \t\tshort_configfile = strrchr( dyn_CONFIGFILE, '/');\n \t\tif (short_configfile == NULL) {\n@@ -100,10 +105,15 @@\n \t\t\t/* full/relative path provided */\n \t\t\tshort_configfile++;\n \t\t}\n-\t\tslprintf( name, sizeof( name)-1, \"%s-%s\", program_name, short_configfile+1);\n+\t\tif (asprintf(&name, \"%s-%s\", program_name,\n+\t\t\t     short_configfile+1) == -1) {\n+\t\t\tsmb_panic(\"asprintf failed\");\n+\t\t}\n \t}\n \n-\tslprintf(pidFile, sizeof(pidFile)-1, \"%s/%s.pid\", lp_piddir(), name);\n+\tif (asprintf(&pidFile, \"%s/%s.pid\", lp_piddir(), name) == -1) {\n+\t\tsmb_panic(\"asprintf failed\");\n+\t}\n \n \tpid = pidfile_pid(name);\n \tif (pid != 0) {\n@@ -133,4 +143,6 @@\n \t\texit(1);\n \t}\n \t/* Leave pid file open & locked for the duration... */\n+\tSAFE_FREE(name);\n+\tSAFE_FREE(pidFile);\n }\n\n"}