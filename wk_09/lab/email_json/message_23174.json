{"category": "ham", "to_address": "samba-cvs@samba.org", "from_address": "jra@samba.org", "subject": "svn commit: samba r22673 - in branches: SAMBA_3_0/source/rpc_parse\n\tSAMBA_3_0_25/source/rpc_parse SAMBA_3_0_26/source/rpc_parse", "body": "Author: jra\nDate: 2007-05-04 19:14:51 +0000 (Fri, 04 May 2007)\nNew Revision: 22673\n\nWebSVN: http://websvn.samba.org/cgi-bin/viewcvs.cgi?view=rev&root=samba&rev=22673\n\nLog:\nFix for Jerry's reversion. We still need to check size\nbefore talloc.\nJeremy.\n\nModified:\n   branches/SAMBA_3_0/source/rpc_parse/parse_samr.c\n   branches/SAMBA_3_0_25/source/rpc_parse/parse_samr.c\n   branches/SAMBA_3_0_26/source/rpc_parse/parse_samr.c\n\n\nChangeset:\nModified: branches/SAMBA_3_0/source/rpc_parse/parse_samr.c\n===================================================================\n--- branches/SAMBA_3_0/source/rpc_parse/parse_samr.c\t2007-05-04 18:59:51 UTC (rev 22672)\n+++ branches/SAMBA_3_0/source/rpc_parse/parse_samr.c\t2007-05-04 19:14:51 UTC (rev 22673)\n@@ -4838,9 +4838,14 @@\n \t\tif(!prs_uint32(\"num_sids1\", ps, depth, &r_u->num_sids1))\n \t\t\treturn False;\n \n-\t\tptr_sid = TALLOC_ARRAY(ps->mem_ctx, uint32, r_u->num_sids1);\n-\t\tif (!ptr_sid) {\n-\t\t\treturn False;\n+\t\t/* We must always use talloc here even when marshalling. */\n+\t\tif (r_u->num_sids1) {\n+\t\t\tptr_sid = TALLOC_ARRAY(ps->mem_ctx, uint32, r_u->num_sids1);\n+\t\t\tif (!ptr_sid) {\n+\t\t\t\treturn False;\n+\t\t\t}\n+\t\t} else {\n+\t\t\tptr_sid = NULL;\n \t\t}\n \t\t\n \t\tfor (i = 0; i < r_u->num_sids1; i++) {\n@@ -4850,7 +4855,14 @@\n \t\t}\n \t\t\n \t\tif (UNMARSHALLING(ps)) {\n-\t\t\tr_u->sid = TALLOC_ARRAY(ps->mem_ctx, DOM_SID2, r_u->num_sids1);\n+\t\t\tif (r_u->num_sids1) {\n+\t\t\t\tr_u->sid = TALLOC_ARRAY(ps->mem_ctx, DOM_SID2, r_u->num_sids1);\n+\t\t\t\tif (!r_u->sid) {\n+\t\t\t\t\treturn False;\n+\t\t\t\t}\n+\t\t\t} else {\n+\t\t\t\tr_u->sid = NULL;\n+\t\t\t}\n \t\t}\n \t\t\n \t\tfor (i = 0; i < r_u->num_sids1; i++) {\n\nModified: branches/SAMBA_3_0_25/source/rpc_parse/parse_samr.c\n===================================================================\n--- branches/SAMBA_3_0_25/source/rpc_parse/parse_samr.c\t2007-05-04 18:59:51 UTC (rev 22672)\n+++ branches/SAMBA_3_0_25/source/rpc_parse/parse_samr.c\t2007-05-04 19:14:51 UTC (rev 22673)\n@@ -4768,9 +4768,14 @@\n \t\tif(!prs_uint32(\"num_sids1\", ps, depth, &r_u->num_sids1))\n \t\t\treturn False;\n \n-\t\tptr_sid = TALLOC_ARRAY(ps->mem_ctx, uint32, r_u->num_sids1);\n-\t\tif (!ptr_sid) {\n-\t\t\treturn False;\n+\t\t/* We must always use talloc here even when marshalling. */\n+\t\tif (r_u->num_sids1) {\n+\t\t\tptr_sid = TALLOC_ARRAY(ps->mem_ctx, uint32, r_u->num_sids1);\n+\t\t\tif (!ptr_sid) {\n+\t\t\t\treturn False;\n+\t\t\t}\n+\t\t} else {\n+\t\t\tptr_sid = NULL;\n \t\t}\n \t\t\n \t\tfor (i = 0; i < r_u->num_sids1; i++) {\n@@ -4780,7 +4785,14 @@\n \t\t}\n \t\t\n \t\tif (UNMARSHALLING(ps)) {\n-\t\t\tr_u->sid = TALLOC_ARRAY(ps->mem_ctx, DOM_SID2, r_u->num_sids1);\n+\t\t\tif (r_u->num_sids1) {\n+\t\t\t\tr_u->sid = TALLOC_ARRAY(ps->mem_ctx, DOM_SID2, r_u->num_sids1);\n+\t\t\t\tif (!r_u->sid) {\n+\t\t\t\t\treturn False;\n+\t\t\t\t}\n+\t\t\t} else {\n+\t\t\t\tr_u->sid = NULL;\n+\t\t\t}\n \t\t}\n \t\t\n \t\tfor (i = 0; i < r_u->num_sids1; i++) {\n\nModified: branches/SAMBA_3_0_26/source/rpc_parse/parse_samr.c\n===================================================================\n--- branches/SAMBA_3_0_26/source/rpc_parse/parse_samr.c\t2007-05-04 18:59:51 UTC (rev 22672)\n+++ branches/SAMBA_3_0_26/source/rpc_parse/parse_samr.c\t2007-05-04 19:14:51 UTC (rev 22673)\n@@ -4768,9 +4768,14 @@\n \t\tif(!prs_uint32(\"num_sids1\", ps, depth, &r_u->num_sids1))\n \t\t\treturn False;\n \n-\t\tptr_sid = TALLOC_ARRAY(ps->mem_ctx, uint32, r_u->num_sids1);\n-\t\tif (!ptr_sid) {\n-\t\t\treturn False;\n+\t\t/* We must always use talloc here even when marshalling. */\n+\t\tif (r_u->num_sids1) {\n+\t\t\tptr_sid = TALLOC_ARRAY(ps->mem_ctx, uint32, r_u->num_sids1);\n+\t\t\tif (!ptr_sid) {\n+\t\t\t\treturn False;\n+\t\t\t}\n+\t\t} else {\n+\t\t\tptr_sid = NULL;\n \t\t}\n \t\t\n \t\tfor (i = 0; i < r_u->num_sids1; i++) {\n@@ -4780,7 +4785,14 @@\n \t\t}\n \t\t\n \t\tif (UNMARSHALLING(ps)) {\n-\t\t\tr_u->sid = TALLOC_ARRAY(ps->mem_ctx, DOM_SID2, r_u->num_sids1);\n+\t\t\tif (r_u->num_sids1) {\n+\t\t\t\tr_u->sid = TALLOC_ARRAY(ps->mem_ctx, DOM_SID2, r_u->num_sids1);\n+\t\t\t\tif (!r_u->sid) {\n+\t\t\t\t\treturn False;\n+\t\t\t\t}\n+\t\t\t} else {\n+\t\t\t\tr_u->sid = NULL;\n+\t\t\t}\n \t\t}\n \t\t\n \t\tfor (i = 0; i < r_u->num_sids1; i++) {\n\n"}