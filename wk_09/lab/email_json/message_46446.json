{"category": "ham", "to_address": "samba-cvs@samba.org", "from_address": "Jelmer Vernooij <jelmer@samba.org>", "subject": "Rev 12285: Add generic tests for ReplyOpenPrinter() and\n\tReplyClosePrinter(). in file:///home/jelmer/bzr.samba4/spoolss/", "body": "At file:///home/jelmer/bzr.samba4/spoolss/\n\n------------------------------------------------------------\nrevno: 12285\nrevision-id: jelmer@samba.org-20070528232035-25ruz8bhjnclnzps\nparent: jelmer@samba.org-20070528194403-hw2nim09zkr7rqiq\ncommitter: Jelmer Vernooij \nbranch nick: spoolss\ntimestamp: Tue 2007-05-29 01:20:35 +0200\nmessage:\n  Add generic tests for ReplyOpenPrinter() and ReplyClosePrinter().\nmodified:\n  source/rpc_server/spoolss/dcesrv_spoolss.c 1185@0c0555d6-39d7-0310-84fc-f1cc0bd64818:branches%2FSAMBA_4_0:source%2Frpc_server%2Fspoolss%2Fdcesrv_spoolss.c\n  source/torture/rpc/spoolss.c   6@0c0555d6-39d7-0310-84fc-f1cc0bd64818:branches%2FSAMBA_4_0:source%2Ftorture%2Frpc%2Fspoolss.c\n=== modified file 'source/rpc_server/spoolss/dcesrv_spoolss.c'\n--- a/source/rpc_server/spoolss/dcesrv_spoolss.c\t2007-05-28 19:44:03 +0000\n+++ b/source/rpc_server/spoolss/dcesrv_spoolss.c\t2007-05-28 23:20:35 +0000\n@@ -1070,7 +1070,13 @@\n static WERROR dcesrv_spoolss_ReplyClosePrinter(struct dcesrv_call_state *dce_call, TALLOC_CTX *mem_ctx,\n \t\t       struct spoolss_ReplyClosePrinter *r)\n {\n-\tDCESRV_FAULT(DCERPC_FAULT_OP_RNG_ERROR);\n+\tstruct dcesrv_handle *handle;\n+\t\n+\tDCESRV_PULL_HANDLE_WERR(handle, r->in.handle, SPOOLSS_NOTIFY);\n+\n+\ttalloc_free(handle);\n+\n+\treturn WERR_OK;\n }\n \n \n\n=== modified file 'source/torture/rpc/spoolss.c'\n--- a/source/torture/rpc/spoolss.c\t2007-05-28 19:44:03 +0000\n+++ b/source/torture/rpc/spoolss.c\t2007-05-28 23:20:35 +0000\n@@ -2072,6 +2072,41 @@\n \treturn ret;\n }\n \n+/** Test that makes sure that calling ReplyOpenPrinter()\n+ * on Samba 4 will cause an irpc broadcast call.\n+ */\n+static bool test_ReplyOpenPrinter(struct torture_context *tctx, \n+\t\t\t\t\t\t\t\t  struct dcerpc_pipe *pipe)\n+{\n+\tstruct spoolss_ReplyOpenPrinter r;\n+\tstruct spoolss_ReplyClosePrinter s;\n+\tstruct policy_handle h;\n+\n+\tr.in.server_name = \"earth\";\n+\tr.in.printer_local = 2;\n+\tr.in.type = REG_DWORD;\n+\tr.in.unknown1 = 0;\n+\tr.in.unknown2 = 0;\n+\tr.out.handle = &h\n+\n+\ttorture_assert_ntstatus_ok(tctx, \n+\t\t\tdcerpc_spoolss_ReplyOpenPrinter(pipe, tctx, &r),\n+\t\t\t\"spoolss_ReplyOpenPrinter call failed\");\n+\n+\ttorture_assert_werr_ok(tctx, r.out.result, \"error return code\");\n+\n+\ts.in.handle = &h\n+\ts.out.handle = &h\n+\n+\ttorture_assert_ntstatus_ok(tctx,\n+\t\t\tdcerpc_spoolss_ReplyClosePrinter(pipe, tctx, &s),\n+\t\t\t\"spoolss_ReplyClosePrinter call failed\");\n+\n+\ttorture_assert_werr_ok(tctx, r.out.result, \"error return code\");\n+\n+\treturn true;\n+}\n+\n BOOL torture_rpc_spoolss(struct torture_context *torture)\n {\n \tNTSTATUS status;\n@@ -2133,6 +2168,8 @@\n \n \tret &= test_EnumPrinterDrivers_old(p, mem_ctx);\n \n+\tret &= test_ReplyOpenPrinter(torture, p);\n+\n \ttalloc_free(mem_ctx);\n \n \treturn ret;\n\n"}