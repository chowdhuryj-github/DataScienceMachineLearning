{"category": "ham", "to_address": "samba-cvs@samba.org", "from_address": "jra@samba.org", "subject": "svn commit: samba r22266 - in branches: SAMBA_3_0/source/include\n\tSAMBA_3_0/source/param SAMBA_3_0/source/smbd\n\tSAMBA_3_0_25/source/include SAMBA_3_0_25/source/param\n\tSAMBA_3_0_25/source/smbd", "body": "Author: jra\nDate: 2007-04-16 19:10:16 +0000 (Mon, 16 Apr 2007)\nNew Revision: 22266\n\nWebSVN: http://websvn.samba.org/cgi-bin/viewcvs.cgi?view=rev&root=samba&rev=22266\n\nLog:\nFix bug #4512 - we were returning a volume label greater than\n32 unicode chars. Windows XP doesn't like that :-).\nJeremy\n\nModified:\n   branches/SAMBA_3_0/source/include/smb.h\n   branches/SAMBA_3_0/source/param/loadparm.c\n   branches/SAMBA_3_0/source/smbd/connection.c\n   branches/SAMBA_3_0/source/smbd/trans2.c\n   branches/SAMBA_3_0_25/source/include/smb.h\n   branches/SAMBA_3_0_25/source/param/loadparm.c\n   branches/SAMBA_3_0_25/source/smbd/connection.c\n   branches/SAMBA_3_0_25/source/smbd/trans2.c\n\n\nChangeset:\nModified: branches/SAMBA_3_0/source/include/smb.h\n===================================================================\n--- branches/SAMBA_3_0/source/include/smb.h\t2007-04-16 12:44:13 UTC (rev 22265)\n+++ branches/SAMBA_3_0/source/include/smb.h\t2007-04-16 19:10:16 UTC (rev 22266)\n@@ -878,7 +878,7 @@\n \tint cnum;\n \tuid_t uid;\n \tgid_t gid;\n-\tchar name[24];\n+\tchar servicename[FSTRING_LEN];\n \tchar addr[24];\n \tchar machine[FSTRING_LEN];\n \ttime_t start;\n\nModified: branches/SAMBA_3_0/source/param/loadparm.c\n===================================================================\n--- branches/SAMBA_3_0/source/param/loadparm.c\t2007-04-16 12:44:13 UTC (rev 22265)\n+++ branches/SAMBA_3_0/source/param/loadparm.c\t2007-04-16 19:10:16 UTC (rev 22266)\n@@ -5299,15 +5299,22 @@\n  A useful volume label function. \n ********************************************************************/\n \n-char *volume_label(int snum)\n+const char *volume_label(int snum)\n {\n-\tchar *ret = lp_volume(snum);\n-\tif (!*ret)\n-\t\treturn lp_servicename(snum);\n-\treturn (ret);\n+\tchar *ret;\n+\tconst char *label = lp_volume(snum);\n+\tif (!*label) {\n+\t\tlabel = lp_servicename(snum);\n+\t}\n+\t\t\n+\t/* This returns a 33 byte guarenteed null terminated string. */\n+\tret = talloc_strndup(main_loop_talloc_get(), label, 32);\n+\tif (!ret) {\n+\t\treturn \"\";\n+\t}\t\t\n+\treturn ret;\n }\n \n-\n /*******************************************************************\n  Set the server type we will announce as via nmbd.\n ********************************************************************/\n\nModified: branches/SAMBA_3_0/source/smbd/connection.c\n===================================================================\n--- branches/SAMBA_3_0/source/smbd/connection.c\t2007-04-16 12:44:13 UTC (rev 22265)\n+++ branches/SAMBA_3_0/source/smbd/connection.c\t2007-04-16 19:10:16 UTC (rev 22266)\n@@ -108,13 +108,13 @@\n \n \tif (cs->Clear && !process_exists(crec.pid) && (errno == ESRCH)) {\n \t\tDEBUG(2,(\"pid %s doesn't exist - deleting connections %d [%s]\\n\",\n-\t\t\tprocid_str_static(&crec.pid), crec.cnum, crec.name));\n+\t\t\tprocid_str_static(&crec.pid), crec.cnum, crec.servicename));\n \t\tif (tdb_delete(the_tdb, kbuf) != 0)\n \t\t\tDEBUG(0,(\"count_fn: tdb_delete failed with error %s\\n\", tdb_errorstr(tdb) ));\n \t\treturn 0;\n \t}\n \n-\tif (strequal(crec.name, cs->name))\n+\tif (strequal(crec.servicename, cs->name))\n \t\tcs->curr_connections++;\n \n \treturn 0;\n@@ -191,8 +191,8 @@\n \tif (conn) {\n \t\tcrec.uid = conn->uid;\n \t\tcrec.gid = conn->gid;\n-\t\tsafe_strcpy(crec.name,\n-\t\t\t    lp_servicename(SNUM(conn)),sizeof(crec.name)-1);\n+\t\tsafe_strcpy(crec.servicename,\n+\t\t\t    lp_servicename(SNUM(conn)),sizeof(crec.servicename)-1);\n \t}\n \tcrec.start = time(NULL);\n \tcrec.bcast_msg_flags = msg_flags;\n\nModified: branches/SAMBA_3_0/source/smbd/trans2.c\n===================================================================\n--- branches/SAMBA_3_0/source/smbd/trans2.c\t2007-04-16 12:44:13 UTC (rev 22265)\n+++ branches/SAMBA_3_0/source/smbd/trans2.c\t2007-04-16 19:10:16 UTC (rev 22266)\n@@ -2247,7 +2247,7 @@\n \tuint16 info_level;\n \tint data_len, len;\n \tSMB_STRUCT_STAT st;\n-\tchar *vname = volume_label(SNUM(conn));\n+\tconst char *vname = volume_label(SNUM(conn));\n \tint snum = SNUM(conn);\n \tchar *fstype = lp_fstype(SNUM(conn));\n \tint quota_flag = 0;\n@@ -2368,9 +2368,11 @@\n \t\t\tSIVAL(pdata,8,str_checksum(lp_servicename(snum)) ^ \n \t\t\t\t(str_checksum(get_local_machine_name())<<16));\n \n+\t\t\t/* Max label len is 32 characters. */\n \t\t\tlen = srvstr_push(outbuf, pdata+18, vname, -1, STR_UNICODE);\n \t\t\tSIVAL(pdata,12,len);\n \t\t\tdata_len = 18+len;\n+\n \t\t\tDEBUG(5,(\"call_trans2qfsinfo : SMB_QUERY_FS_VOLUME_INFO namelen = %d, vol=%s serv=%s\\n\", \n \t\t\t\t(int)strlen(vname),vname, lp_servicename(snum)));\n \t\t\tbreak;\n\nModified: branches/SAMBA_3_0_25/source/include/smb.h\n===================================================================\n--- branches/SAMBA_3_0_25/source/include/smb.h\t2007-04-16 12:44:13 UTC (rev 22265)\n+++ branches/SAMBA_3_0_25/source/include/smb.h\t2007-04-16 19:10:16 UTC (rev 22266)\n@@ -885,7 +885,7 @@\n \tint cnum;\n \tuid_t uid;\n \tgid_t gid;\n-\tchar name[24];\n+\tchar servicename[FSTRING_LEN];\n \tchar addr[24];\n \tchar machine[FSTRING_LEN];\n \ttime_t start;\n\nModified: branches/SAMBA_3_0_25/source/param/loadparm.c\n===================================================================\n--- branches/SAMBA_3_0_25/source/param/loadparm.c\t2007-04-16 12:44:13 UTC (rev 22265)\n+++ branches/SAMBA_3_0_25/source/param/loadparm.c\t2007-04-16 19:10:16 UTC (rev 22266)\n@@ -5293,15 +5293,22 @@\n  A useful volume label function. \n ********************************************************************/\n \n-char *volume_label(int snum)\n+const char *volume_label(int snum)\n {\n-\tchar *ret = lp_volume(snum);\n-\tif (!*ret)\n-\t\treturn lp_servicename(snum);\n-\treturn (ret);\n+\tchar *ret;\n+\tconst char *label = lp_volume(snum);\n+\tif (!*label) {\n+\t\tlabel = lp_servicename(snum);\n+\t}\n+\t\t\n+\t/* This returns a 33 byte guarenteed null terminated string. */\n+\tret = talloc_strndup(main_loop_talloc_get(), label, 32);\n+\tif (!ret) {\n+\t\treturn \"\";\n+\t}\t\t\n+\treturn ret;\n }\n \n-\n /*******************************************************************\n  Set the server type we will announce as via nmbd.\n ********************************************************************/\n\nModified: branches/SAMBA_3_0_25/source/smbd/connection.c\n===================================================================\n--- branches/SAMBA_3_0_25/source/smbd/connection.c\t2007-04-16 12:44:13 UTC (rev 22265)\n+++ branches/SAMBA_3_0_25/source/smbd/connection.c\t2007-04-16 19:10:16 UTC (rev 22266)\n@@ -108,13 +108,13 @@\n \n \tif (cs->Clear && !process_exists(crec.pid) && (errno == ESRCH)) {\n \t\tDEBUG(2,(\"pid %s doesn't exist - deleting connections %d [%s]\\n\",\n-\t\t\tprocid_str_static(&crec.pid), crec.cnum, crec.name));\n+\t\t\tprocid_str_static(&crec.pid), crec.cnum, crec.servicename));\n \t\tif (tdb_delete(the_tdb, kbuf) != 0)\n \t\t\tDEBUG(0,(\"count_fn: tdb_delete failed with error %s\\n\", tdb_errorstr(tdb) ));\n \t\treturn 0;\n \t}\n \n-\tif (strequal(crec.name, cs->name))\n+\tif (strequal(crec.servicename, cs->name))\n \t\tcs->curr_connections++;\n \n \treturn 0;\n@@ -191,8 +191,8 @@\n \tif (conn) {\n \t\tcrec.uid = conn->uid;\n \t\tcrec.gid = conn->gid;\n-\t\tsafe_strcpy(crec.name,\n-\t\t\t    lp_servicename(SNUM(conn)),sizeof(crec.name)-1);\n+\t\tsafe_strcpy(crec.servicename,\n+\t\t\t    lp_servicename(SNUM(conn)),sizeof(crec.servicename)-1);\n \t}\n \tcrec.start = time(NULL);\n \tcrec.bcast_msg_flags = msg_flags;\n\nModified: branches/SAMBA_3_0_25/source/smbd/trans2.c\n===================================================================\n--- branches/SAMBA_3_0_25/source/smbd/trans2.c\t2007-04-16 12:44:13 UTC (rev 22265)\n+++ branches/SAMBA_3_0_25/source/smbd/trans2.c\t2007-04-16 19:10:16 UTC (rev 22266)\n@@ -2232,7 +2232,7 @@\n \tuint16 info_level;\n \tint data_len, len;\n \tSMB_STRUCT_STAT st;\n-\tchar *vname = volume_label(SNUM(conn));\n+\tconst char *vname = volume_label(SNUM(conn));\n \tint snum = SNUM(conn);\n \tchar *fstype = lp_fstype(SNUM(conn));\n \tint quota_flag = 0;\n@@ -2353,9 +2353,11 @@\n \t\t\tSIVAL(pdata,8,str_checksum(lp_servicename(snum)) ^ \n \t\t\t\t(str_checksum(get_local_machine_name())<<16));\n \n+\t\t\t/* Max label len is 32 characters. */\n \t\t\tlen = srvstr_push(outbuf, pdata+18, vname, -1, STR_UNICODE);\n \t\t\tSIVAL(pdata,12,len);\n \t\t\tdata_len = 18+len;\n+\n \t\t\tDEBUG(5,(\"call_trans2qfsinfo : SMB_QUERY_FS_VOLUME_INFO namelen = %d, vol=%s serv=%s\\n\", \n \t\t\t\t(int)strlen(vname),vname, lp_servicename(snum)));\n \t\t\tbreak;\n\n"}