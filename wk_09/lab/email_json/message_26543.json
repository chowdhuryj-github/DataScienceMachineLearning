{"category": "ham", "to_address": "samba-cvs@samba.org", "from_address": "tridge@samba.org", "subject": "Rev 268: separate the wire format and internal format for the\n\tvnn_map in http://samba.org/~tridge/ctdb", "body": "------------------------------------------------------------\nrevno: 268\nrevision-id: tridge@samba.org-20070509221319-2i6pfo0e6gudc6dz\nparent: tridge@samba.org-20070509215546-6s0mhsloyilervjf\ncommitter: Andrew Tridgell \nbranch nick: tridge\ntimestamp: Thu 2007-05-10 08:13:19 +1000\nmessage:\n  separate the wire format and internal format for the vnn_map\nmodified:\n  common/ctdb.c                  ctdb.c-20061127094323-t50f58d65iaao5of-2\n  common/ctdb_client.c           ctdb_client.c-20070411010216-3kd8v37k61steeya-1\n  common/ctdb_recover.c          ctdb_recover.c-20070503002147-admmfgt1oj6gexfo-1\n  include/ctdb_private.h         ctdb_private.h-20061117234101-o3qt14umlg9en8z0-13\n  tests/ctdbd.sh                 ctdbd.sh-20070411085038-phusiewluwzyqjpc-2\n=== modified file 'common/ctdb.c'\n--- a/common/ctdb.c\t2007-05-09 21:55:46 +0000\n+++ b/common/ctdb.c\t2007-05-09 22:13:19 +0000\n@@ -161,15 +161,16 @@\n XXX generation==0 (==invalid) and let the recovery tool populate this \n XXX table for the daemons. \n */\n-\tctdb->vnn_map = talloc_zero_size(ctdb, offsetof(struct ctdb_vnn_map, map) + 4*ctdb->num_nodes);\n-\tif (ctdb->vnn_map == NULL) {\n-\t\tDEBUG(0,(__location__ \" Unable to allocate vnn_map structure\\n\"));\n-\t\texit(1);\n-\t}\n+\tctdb->vnn_map = talloc(ctdb, struct ctdb_vnn_map);\n+\tCTDB_NO_MEMORY(ctdb, ctdb->vnn_map);\n+\n \tctdb->vnn_map->generation = 1;\n \tctdb->vnn_map->size = ctdb->num_nodes;\n-\tfor(i=0;ivnn_map->size;i++){\n-\t\tctdb->vnn_map->map[i] = i%ctdb->num_nodes;\n+\tctdb->vnn_map->map = talloc_array(ctdb->vnn_map, uint32_t, ctdb->vnn_map->size);\n+\tCTDB_NO_MEMORY(ctdb, ctdb->vnn_map->map);\n+\n+\tfor(i=0;ivnn_map->size;i++) {\n+\t\tctdb->vnn_map->map[i] = i;\n \t}\n \t\n \ttalloc_free(lines);\n\n=== modified file 'common/ctdb_client.c'\n--- a/common/ctdb_client.c\t2007-05-06 21:54:17 +0000\n+++ b/common/ctdb_client.c\t2007-05-09 22:13:19 +0000\n@@ -808,6 +808,7 @@\n \tint ret;\n \tTDB_DATA data, outdata;\n \tint32_t res;\n+\tstruct ctdb_vnn_map_wire *map;\n \n \tZERO_STRUCT(data);\n \tret = ctdb_control(ctdb, destnode, 0, \n@@ -817,8 +818,22 @@\n \t\tDEBUG(0,(__location__ \" ctdb_control for getvnnmap failed\\n\"));\n \t\treturn -1;\n \t}\n-\n-\t*vnnmap = (struct ctdb_vnn_map *)talloc_memdup(mem_ctx, outdata.dptr, outdata.dsize);\n+\t\n+\tmap = (struct ctdb_vnn_map_wire *)outdata.dptr;\n+\tif (outdata.dsize < offsetof(struct ctdb_vnn_map_wire, map) ||\n+\t    outdata.dsize != map->size*sizeof(uint32_t) + offsetof(struct ctdb_vnn_map_wire, map)) {\n+\t\tDEBUG(0,(\"Bad vnn map size received in ctdb_ctrl_getvnnmap\\n\"));\n+\t\treturn -1;\n+\t}\n+\n+\t(*vnnmap) = talloc(mem_ctx, struct ctdb_vnn_map);\n+\tCTDB_NO_MEMORY(ctdb, *vnnmap);\n+\t(*vnnmap)->generation = map->generation;\n+\t(*vnnmap)->size       = map->size;\n+\t(*vnnmap)->map        = talloc_array(*vnnmap, uint32_t, map->size);\n+\n+\tCTDB_NO_MEMORY(ctdb, (*vnnmap)->map);\n+\tmemcpy((*vnnmap)->map, map->map, sizeof(uint32_t)*map->size);\n \t\t    \n \treturn 0;\n }\n\n=== modified file 'common/ctdb_recover.c'\n--- a/common/ctdb_recover.c\t2007-05-03 06:18:03 +0000\n+++ b/common/ctdb_recover.c\t2007-05-09 22:13:19 +0000\n@@ -32,9 +32,19 @@\n ctdb_control_getvnnmap(struct ctdb_context *ctdb, uint32_t opcode, TDB_DATA indata, TDB_DATA *outdata)\n {\n \tCHECK_CONTROL_DATA_SIZE(0);\n-\n-\toutdata->dsize = offsetof(struct ctdb_vnn_map, map) + 4*ctdb->vnn_map->size;\n-\toutdata->dptr  = (unsigned char *)ctdb->vnn_map;\n+\tstruct ctdb_vnn_map_wire *map;\n+\tsize_t len;\n+\n+\tlen = offsetof(struct ctdb_vnn_map_wire, map) + sizeof(uint32_t)*ctdb->vnn_map->size;\n+\tmap = talloc_size(outdata, len);\n+\tCTDB_NO_MEMORY_VOID(ctdb, map);\n+\n+\tmap->generation = ctdb->vnn_map->generation;\n+\tmap->size = ctdb->vnn_map->size;\n+\tmemcpy(map->map, ctdb->vnn_map->map, sizeof(uint32_t)*map->size);\n+\n+\toutdata->dsize = len;\n+\toutdata->dptr  = (uint8_t *)map;\n \n \treturn 0;\n }\n\n=== modified file 'include/ctdb_private.h'\n--- a/include/ctdb_private.h\t2007-05-08 11:16:29 +0000\n+++ b/include/ctdb_private.h\t2007-05-09 22:13:19 +0000\n@@ -192,6 +192,15 @@\n struct ctdb_vnn_map {\n \tuint32_t generation;\n \tuint32_t size;\n+\tuint32_t *map;\n+};\n+\n+/* \n+   a wire representation of the vnn map\n+ */\n+struct ctdb_vnn_map_wire {\n+\tuint32_t generation;\n+\tuint32_t size;\n \tuint32_t map[1];\n };\n \n\n=== modified file 'tests/ctdbd.sh'\n--- a/tests/ctdbd.sh\t2007-05-04 02:18:39 +0000\n+++ b/tests/ctdbd.sh\t2007-05-09 22:13:19 +0000\n@@ -31,4 +31,6 @@\n echo \"Testing getdbmap\"\n $VALGRIND bin/ctdb_control getdbmap 0 || exit 1\n \n+echo \"All done\"\n+\n killall -q ctdbd\n\n"}