{"category": "ham", "to_address": "samba-cvs@samba.org", "from_address": "vlendec@samba.org", "subject": "svn commit: samba r22213 - in branches/SAMBA_3_0/source: lib smbd", "body": "Author: vlendec\nDate: 2007-04-14 06:40:47 +0000 (Sat, 14 Apr 2007)\nNew Revision: 22213\n\nWebSVN: http://websvn.samba.org/cgi-bin/viewcvs.cgi?view=rev&root=samba&rev=22213\n\nLog:\nWe can't use become_root() here, as it does DEBUG()\nitself. become_root_uid_only did not :-)\n\nRevert 21868, we need to find a better way.\n\nVolker\n\nModified:\n   branches/SAMBA_3_0/source/lib/debug.c\n   branches/SAMBA_3_0/source/smbd/process.c\n\n\nChangeset:\nModified: branches/SAMBA_3_0/source/lib/debug.c\n===================================================================\n--- branches/SAMBA_3_0/source/lib/debug.c\t2007-04-14 00:53:38 UTC (rev 22212)\n+++ branches/SAMBA_3_0/source/lib/debug.c\t2007-04-14 06:40:47 UTC (rev 22213)\n@@ -688,15 +688,20 @@\n \tint         maxlog;\n \tSMB_STRUCT_STAT st;\n \n+\t/*\n+\t *  We need to be root to check/change log-file, skip this and let the main\n+\t *  loop check do a new check as root.\n+\t */\n+\n+\tif( geteuid() != 0 )\n+\t\treturn;\n+\n \tif(log_overflow || !need_to_check_log_size() )\n \t\treturn;\n \n \tmaxlog = lp_max_log_size() * 1024;\n \n \tif( sys_fstat( x_fileno( dbf ), &st ) == 0 && st.st_size > maxlog ) {\n-\n-\t\tbecome_root();\n-\n \t\t(void)reopen_logs();\n \t\tif( dbf && get_file_size( debugf ) > maxlog ) {\n \t\t\tpstring name;\n@@ -709,8 +714,6 @@\n \t\t\t\t(void)rename(name, debugf);\n \t\t\t}\n \t\t}\n-\n-\t\tunbecome_root();\n \t}\n \n \t/*\n\nModified: branches/SAMBA_3_0/source/smbd/process.c\n===================================================================\n--- branches/SAMBA_3_0/source/smbd/process.c\t2007-04-14 00:53:38 UTC (rev 22212)\n+++ branches/SAMBA_3_0/source/smbd/process.c\t2007-04-14 06:40:47 UTC (rev 22213)\n@@ -1406,6 +1406,13 @@\n   \n \tupdate_monitored_printq_cache();\n   \n+\t/*\n+\t * Now we are root, check if the log files need pruning.\n+\t * Force a log file check.\n+\t */\n+\tforce_check_log_size();\n+\tcheck_log_size();\n+\n \t/* Send any queued printer notify message to interested smbd's. */\n \n \tprint_notify_send_messages(0);\n\n"}