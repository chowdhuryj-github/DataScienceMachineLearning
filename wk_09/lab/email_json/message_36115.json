{"category": "ham", "to_address": "samba-cvs@samba.org", "from_address": "tridge@samba.org", "subject": "Rev 347: send a message to clients when an IP has been released in\n\thttp://samba.org/~tridge/ctdb", "body": "------------------------------------------------------------\nrevno: 347\nrevision-id: tridge@samba.org-20070525140530-wueocj9ci5qpi3cf\nparent: tridge@samba.org-20070525120745-40ik47s270sgbx07\ncommitter: Andrew Tridgell \nbranch nick: tridge\ntimestamp: Sat 2007-05-26 00:05:30 +1000\nmessage:\n  send a message to clients when an IP has been released\nmodified:\n  common/ctdb_recoverd.c         recoverd.c-20070503213540-bvxuyd9jm1f7ig90-1\n  include/ctdb.h                 ctdb.h-20061117234101-o3qt14umlg9en8z0-11\n  takeover/ctdb_takeover.c       ctdb_takeover.c-20070525071636-a5n1ihghjtppy08r-2\n=== modified file 'common/ctdb_recoverd.c'\n--- a/common/ctdb_recoverd.c\t2007-05-25 07:04:13 +0000\n+++ b/common/ctdb_recoverd.c\t2007-05-25 14:05:30 +0000\n@@ -557,7 +557,8 @@\n \t\treturn -1;\n \t}\n \n-\t/* send a message to all clients telling them that the cluster has been reconfigured */\n+\t/* send a message to all clients telling them that the cluster \n+\t   has been reconfigured */\n \tctdb_send_message(ctdb, CTDB_BROADCAST_ALL, CTDB_SRVID_RECONFIGURE, tdb_null);\n \n \tDEBUG(0, (__location__ \" Recovery complete\\n\"));\n\n=== modified file 'include/ctdb.h'\n--- a/include/ctdb.h\t2007-05-23 04:50:41 +0000\n+++ b/include/ctdb.h\t2007-05-25 14:05:30 +0000\n@@ -67,6 +67,11 @@\n  */\n #define CTDB_SRVID_RECONFIGURE 0xF200000000000000LL\n \n+/* \n+   a message handler ID meaning that an IP address has been released\n+ */\n+#define CTDB_SRVID_RELEASE_IP 0xF300000000000000LL\n+\n struct event_context;\n \n /*\n\n=== modified file 'takeover/ctdb_takeover.c'\n--- a/takeover/ctdb_takeover.c\t2007-05-25 11:27:26 +0000\n+++ b/takeover/ctdb_takeover.c\t2007-05-25 14:05:30 +0000\n@@ -108,19 +108,30 @@\n {\n \tstruct sockaddr_in *sin = (struct sockaddr_in *)indata.dptr;\n \tchar *cmdstr;\n+\tTDB_DATA data;\n+\tchar *ip = inet_ntoa(sin->sin_addr);\n \n \t/* stop any previous arps */\n \ttalloc_free(ctdb->takeover.last_ctx);\n \tctdb->takeover.last_ctx = NULL;\n \n \tcmdstr = talloc_asprintf(ctdb, \"ip addr del %s/32 dev %s 2> /dev/null\",\n-\t\t\t\t inet_ntoa(sin->sin_addr), ctdb->takeover.interface);\n+\t\t\t\t ip, ctdb->takeover.interface);\n \t\t\n \tDEBUG(0,(\"Releasing IP : %s\\n\", cmdstr));\n \tsystem(cmdstr);\n \n \ttalloc_free(cmdstr);\n \n+\t/* send a message to all clients of this node telling them\n+\t   that the cluster has been reconfigured and they should\n+\t   release any sockets on this IP */\n+\tdata.dptr = (uint8_t *)ip;\n+\tdata.dsize = strlen(ip)+1;\n+\n+\tctdb_send_message(ctdb, ctdb->vnn, CTDB_SRVID_RELEASE_IP, data);\n+\n+\n \treturn 0;\n }\n \n\n"}