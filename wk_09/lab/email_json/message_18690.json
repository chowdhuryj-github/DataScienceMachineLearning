{"category": "ham", "to_address": "samba-cvs@samba.org", "from_address": "tridge@samba.org", "subject": "Rev 213: report number of clients in ping in\n\thttp://samba.org/~tridge/ctdb", "body": "------------------------------------------------------------\nrevno: 213\nrevision-id: tridge@samba.org-20070428131521-53ws6e7u06s1llsm\nparent: tridge@samba.org-20070428110259-azfdeu63sz5zb2xw\ncommitter: Andrew Tridgell \nbranch nick: tridge\ntimestamp: Sat 2007-04-28 15:15:21 +0200\nmessage:\n  report number of clients in ping\nmodified:\n  common/ctdb_client.c           ctdb_client.c-20070411010216-3kd8v37k61steeya-1\n  common/ctdb_control.c          ctdb_control.c-20070426122724-j6gkpiofhbwdin63-1\n  common/ctdb_daemon.c           ctdb_daemon.c-20070409200331-3el1kqgdb9m4ib0g-1\n  include/ctdb_private.h         ctdb_private.h-20061117234101-o3qt14umlg9en8z0-13\n  tools/ctdb_control.c           ctdb_control.c-20070426122705-9ehj1l5lu2gn9kuj-1\n=== modified file 'common/ctdb_client.c'\n--- a/common/ctdb_client.c\t2007-04-28 11:02:59 +0000\n+++ b/common/ctdb_client.c\t2007-04-28 13:15:21 +0000\n@@ -897,7 +897,7 @@\n }\n \n /*\n-  ping a node\n+  ping a node, return number of clients connected\n  */\n int ctdb_ping(struct ctdb_context *ctdb, uint32_t destnode)\n {\n@@ -907,10 +907,10 @@\n \n \tZERO_STRUCT(data);\n \tret = ctdb_control(ctdb, destnode, 0, CTDB_CONTROL_PING, data, NULL, NULL, &res);\n-\tif (ret != 0 || res != 0) {\n+\tif (ret != 0) {\n \t\treturn -1;\n \t}\n-\treturn 0;\n+\treturn res;\n }\n \n /*\n\n=== modified file 'common/ctdb_control.c'\n--- a/common/ctdb_control.c\t2007-04-28 10:40:26 +0000\n+++ b/common/ctdb_control.c\t2007-04-28 13:15:21 +0000\n@@ -176,7 +176,7 @@\n \n \tcase CTDB_CONTROL_PING:\n \t\tCHECK_CONTROL_DATA_SIZE(0);\n-\t\treturn 0;\n+\t\treturn ctdb->num_clients;\n \n \tcase CTDB_CONTROL_GETDBPATH: {\n \t\tuint32_t db_id;\n\n=== modified file 'common/ctdb_daemon.c'\n--- a/common/ctdb_daemon.c\t2007-04-28 11:02:59 +0000\n+++ b/common/ctdb_daemon.c\t2007-04-28 13:15:21 +0000\n@@ -232,6 +232,7 @@\n */\n static int ctdb_client_destructor(struct ctdb_client *client)\n {\n+\tclient->ctdb->num_clients--;\n \tclose(client->fd);\n \tclient->fd = -1;\n \treturn 0;\n@@ -547,6 +548,7 @@\n \tclient = talloc_zero(ctdb, struct ctdb_client);\n \tclient->ctdb = ctdb;\n \tclient->fd = fd;\n+\tctdb->num_clients++;\n \n \tclient->queue = ctdb_queue_setup(ctdb, client, fd, CTDB_DS_ALIGNMENT, \n \t\t\t\t\t ctdb_daemon_read_cb, client);\n\n=== modified file 'include/ctdb_private.h'\n--- a/include/ctdb_private.h\t2007-04-28 10:40:26 +0000\n+++ b/include/ctdb_private.h\t2007-04-28 13:15:21 +0000\n@@ -195,6 +195,7 @@\n \tstruct ctdb_daemon_data daemon;\n \tstruct ctdb_status status;\n \tstruct ctdb_vnn_map *vnn_map;\n+\tuint32_t num_clients;\n };\n \n struct ctdb_db_context {\n\n=== modified file 'tools/ctdb_control.c'\n--- a/tools/ctdb_control.c\t2007-04-28 10:42:42 +0000\n+++ b/tools/ctdb_control.c\t2007-04-28 13:15:21 +0000\n@@ -261,11 +261,11 @@\n \tfor (i=0;inum_nodes;i++) {\n \t\tstruct timeval tv = timeval_current();\n \t\tret = ctdb_ping(ctdb, i);\n-\t\tif (ret != 0) {\n+\t\tif (ret == -1) {\n \t\t\tprintf(\"Unable to get ping response from node %u\\n\", i);\n \t\t} else {\n-\t\t\tprintf(\"response from %u time=%.6f sec\\n\", \n-\t\t\t       i, timeval_elapsed(&tv));\n+\t\t\tprintf(\"response from %u time=%.6f sec  (%d clients)\\n\", \n+\t\t\t       i, timeval_elapsed(&tv), ret);\n \t\t}\n \t}\n \treturn 0;\n\n"}