{"category": "ham", "to_address": "samba-cvs@samba.org", "from_address": "abartlet@samba.org", "subject": "svn commit: samba r22966 - in\n\tbranches/SAMBA_4_0/source/auth/gensec: .", "body": "Author: abartlet\nDate: 2007-05-17 05:44:51 +0000 (Thu, 17 May 2007)\nNew Revision: 22966\n\nWebSVN: http://websvn.samba.org/cgi-bin/viewcvs.cgi?view=rev&root=samba&rev=22966\n\nLog:\nMake sure to return LOGON_FAILURE if the user's kerberos password is\nincorrect.\n\nAndrew Bartlett\n\nModified:\n   branches/SAMBA_4_0/source/auth/gensec/gensec_gssapi.c\n   branches/SAMBA_4_0/source/auth/gensec/gensec_krb5.c\n   branches/SAMBA_4_0/source/auth/gensec/spnego.c\n\n\nChangeset:\nModified: branches/SAMBA_4_0/source/auth/gensec/gensec_gssapi.c\n===================================================================\n--- branches/SAMBA_4_0/source/auth/gensec/gensec_gssapi.c\t2007-05-17 03:42:28 UTC (rev 22965)\n+++ branches/SAMBA_4_0/source/auth/gensec/gensec_gssapi.c\t2007-05-17 05:44:51 UTC (rev 22966)\n@@ -347,6 +347,8 @@\n \tswitch (ret) {\n \tcase 0:\n \t\tbreak;\n+\tcase KRB5KDC_ERR_PREAUTH_FAILED:\n+\t\treturn NT_STATUS_LOGON_FAILURE;\n \tcase KRB5_KDC_UNREACH:\n \t\tDEBUG(3, (\"Cannot reach a KDC we require to contact %s\\n\", principal));\n \t\treturn NT_STATUS_INVALID_PARAMETER; /* Make SPNEGO ignore us, we can't go any further here */\n\nModified: branches/SAMBA_4_0/source/auth/gensec/gensec_krb5.c\n===================================================================\n--- branches/SAMBA_4_0/source/auth/gensec/gensec_krb5.c\t2007-05-17 03:42:28 UTC (rev 22965)\n+++ branches/SAMBA_4_0/source/auth/gensec/gensec_krb5.c\t2007-05-17 05:44:51 UTC (rev 22966)\n@@ -244,16 +244,23 @@\n \tgensec_krb5_state = gensec_security->private_data;\n \tgensec_krb5_state->state_position = GENSEC_KRB5_CLIENT_START;\n \n+\tprincipal = gensec_get_target_principal(gensec_security);\n+\n \tret = cli_credentials_get_ccache(gensec_get_credentials(gensec_security), &ccache_container);\n-\tif (ret) {\n-\t\tDEBUG(1,(\"gensec_krb5_start: cli_credentials_get_ccache failed: %s\\n\", \n-\t\t\t error_message(ret)));\n+\tswitch (ret) {\n+\tcase 0:\n+\t\tbreak;\n+\tcase KRB5KDC_ERR_PREAUTH_FAILED:\n+\t\treturn NT_STATUS_LOGON_FAILURE;\n+\tcase KRB5_KDC_UNREACH:\n+\t\tDEBUG(3, (\"Cannot reach a KDC we require to contact %s\\n\", principal));\n+\t\treturn NT_STATUS_INVALID_PARAMETER; /* Make SPNEGO ignore us, we can't go any further here */\n+\tdefault:\n+\t\tDEBUG(1, (\"gensec_krb5_start: Aquiring initiator credentails failed: %s\\n\", error_message(ret)));\n \t\treturn NT_STATUS_UNSUCCESSFUL;\n \t}\n-\n \tin_data.length = 0;\n \t\n-\tprincipal = gensec_get_target_principal(gensec_security);\n \tif (principal && lp_client_use_spnego_principal()) {\n \t\tkrb5_principal target_principal;\n \t\tret = krb5_parse_name(gensec_krb5_state->smb_krb5_context->krb5_context, principal,\n\nModified: branches/SAMBA_4_0/source/auth/gensec/spnego.c\n===================================================================\n--- branches/SAMBA_4_0/source/auth/gensec/spnego.c\t2007-05-17 03:42:28 UTC (rev 22965)\n+++ branches/SAMBA_4_0/source/auth/gensec/spnego.c\t2007-05-17 05:44:51 UTC (rev 22966)\n@@ -528,7 +528,7 @@\n \t * support the first time.  Lets keep this code to\n \t * reality */\n \n-\treturn NT_STATUS_INVALID_PARAMETER;\n+\treturn nt_status;\n }\n \n /** create a negTokenInit \n\n"}