{"category": "ham", "to_address": "samba-cvs@samba.org", "from_address": "tridge@samba.org", "subject": "Rev 371: call the event script on recovery too in\n\thttp://samba.org/~tridge/ctdb", "body": "------------------------------------------------------------\nrevno: 371\nrevision-id: tridge@samba.org-20070529025524-2xj1fw64ggc9iw9u\nparent: tridge@samba.org-20070529024925-0rcoxtaqxwzinus1\ncommitter: Andrew Tridgell \nbranch nick: tridge\ntimestamp: Tue 2007-05-29 12:55:24 +1000\nmessage:\n  call the event script on recovery too\nmodified:\n  common/ctdb_recover.c          ctdb_recover.c-20070503002147-admmfgt1oj6gexfo-1\n  include/ctdb_private.h         ctdb_private.h-20061117234101-o3qt14umlg9en8z0-13\n  takeover/ctdb_takeover.c       ctdb_takeover.c-20070525071636-a5n1ihghjtppy08r-2\n  takeover/system.c              system.c-20070525071636-a5n1ihghjtppy08r-3\n=== modified file 'common/ctdb_recover.c'\n--- a/common/ctdb_recover.c\t2007-05-25 07:04:13 +0000\n+++ b/common/ctdb_recover.c\t2007-05-29 02:55:24 +0000\n@@ -447,6 +447,7 @@\n \t\treturn -1;\n \t}\n \tctdb->recovery_mode = recmode;\n+\tctdb_event_script(ctdb, \"recovered\");\n \treturn 0;\n }\n \n\n=== modified file 'include/ctdb_private.h'\n--- a/include/ctdb_private.h\t2007-05-29 02:49:25 +0000\n+++ b/include/ctdb_private.h\t2007-05-29 02:55:24 +0000\n@@ -945,6 +945,6 @@\n int32_t ctdb_control_startup(struct ctdb_context *ctdb, uint32_t vnn);\n \n void ctdb_takeover_client_destructor_hook(struct ctdb_client *client);\n-\n+int ctdb_event_script(struct ctdb_context *ctdb, const char *fmt, ...);\n \n #endif\n\n=== modified file 'takeover/ctdb_takeover.c'\n--- a/takeover/ctdb_takeover.c\t2007-05-29 02:49:25 +0000\n+++ b/takeover/ctdb_takeover.c\t2007-05-29 02:55:24 +0000\n@@ -93,26 +93,6 @@\n \n \n /*\n-  run the event script\n- */\n-static int ctdb_event_script(struct ctdb_context *ctdb, const char *fmt, ...)\n-{\n-\tva_list ap;\n-\tchar *cmdstr;\n-\tint ret;\n-\n-\tva_start(ap, fmt);\n-\tcmdstr = talloc_vasprintf(ctdb, fmt, ap);\n-\tva_end(ap);\n-\tCTDB_NO_MEMORY(ctdb, cmdstr);\n-\n-\tret = system(cmdstr);\n-\ttalloc_free(cmdstr);\n-\n-\treturn ret;\n-}\n-\n-/*\n   take over an ip address\n  */\n int32_t ctdb_control_takeover_ip(struct ctdb_context *ctdb, TDB_DATA indata)\n\n=== modified file 'takeover/system.c'\n--- a/takeover/system.c\t2007-05-29 02:49:25 +0000\n+++ b/takeover/system.c\t2007-05-29 02:55:24 +0000\n@@ -257,3 +257,28 @@\n \treturn ret == 0;\n }\n \n+/*\n+  run the event script\n+ */\n+int ctdb_event_script(struct ctdb_context *ctdb, const char *fmt, ...)\n+{\n+\tva_list ap;\n+\tchar *options, *cmdstr;\n+\tint ret;\n+\n+\tva_start(ap, fmt);\n+\toptions  = talloc_vasprintf(ctdb, fmt, ap);\n+\tva_end(ap);\n+\tCTDB_NO_MEMORY(ctdb, options);\n+\n+\tcmdstr = talloc_asprintf(ctdb, \"%s %s\", ctdb->takeover.event_script, options);\n+\tCTDB_NO_MEMORY(ctdb, cmdstr);\n+\n+\tret = system(cmdstr);\n+\n+\ttalloc_free(cmdstr);\n+\ttalloc_free(options);\n+\n+\treturn ret;\n+}\n+\n\n"}