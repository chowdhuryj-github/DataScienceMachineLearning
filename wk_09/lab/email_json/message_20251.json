{"category": "ham", "to_address": "\"Gerald (Jerry) Carter\" <jerry@samba.org>", "from_address": "Johann Hanne <jhml@gmx.net>", "subject": "Re: \"valid users = domain_user\" without specifying domain", "body": "On Monday 30 April 2007 00:37, Gerald (Jerry) Carter wrote:\n> Johann Hanne wrote:\n> > Hi,\n> >\n> > I've got a long time configuration wish where I was never sure if it's\n> > actually doable. Maybe somebody can give me some hint...\n> >\n> > My samba configuration is rather simple: It's a Windows ADS domain member\n> > with a www share that's mainly accessed by Windows users:\n> > ---\n> > [global]\n> >\n> > netbios name = MYSERVER\n> > workgroup = MYDOMAIN\n> > realm = MYDOMAIN.DE\n> > security = ADS\n> >\n> > idmap domains = MYDOMAIN\n> >\n> > idmap config MYDOMAIN:default = yes\n> > idmap config MYDOMAIN:backend = ad\n> > idmap config MYDOMAIN:range = 500 - 999\n> > idmap config MYDOMAIN:schema_mode = rfc2307\n> >\n> > winbind uid = 500 - 999\n> > winbind gid = 500 - 999\n> > winbind use default domain = yes\n> > --\n> >\n> > So far, everything is working fine, but the share configuration is not\n> > how I'd like:\n> > --\n> > [www]\n> >   comment = Web\n> >   path = /var/www\n> >   valid users = MYDOMAIN/user1 MYDOMAIN/user2 MYDOMAIN/user3\n> >   ; does NOT work:\n> >   ;valid users = user1 user2 user3\n> >   ; what I'd like to put in is:\n> >   ;valid users = +apache\n> > --\n> >\n> > My problem is that I have to specify the domain (\"MYDOMAIN/\")\n> > in front of each  user, otherwise it won't work (Permission denied).\n>\n> I'm pretty sure this behavior is described in the release notes for\n> the 3.0.23 release series.  It is by deisgn.  DOMAION\\group1 and\n> (local) group1 have different SIDs.\nYes, I've read the release notes, but maybe I'm misunderstanding something. I \nthought that \"valid users = +apache\" is the same as \"valid users = \n+MACHINE\\apache\" and that MACHINE is the literal string \"MACHINE\"?\n\n> > Shouldn't this be a configuration that works? user1,\n> > user2 and user3 are actually winbind/nss mapped users, so why\n> > do I have to specify the domain name here?\n>\n> Just make MACHINE\\Apache and add domain users to that.\nI really tried everything I could think of. And I've also added all possible \ncombinations (even those which don't make sense to me), currently I have:\n\n/etc/group:\n--\napache::81:user1,MYDOMAIN\\user1\nMYSERVER\\apache::82:user1,MYDOMAIN\\user1\nMACHINE\\apache::83:user1,MYDOMAIN\\user1\n--\n\nsmb.conf share configuration:\n--\n[www]\n  comment = Web\n  path = /var/www\n  valid users = +MACHINE\\apache +MYSERVER\\apache +apache\n--\n\nAnd I still get permission denied for user1. A debug level 100 log looks like \nthis:\n--\n...\nProcessing section \"[www]\"\n...\ndoing parameter valid users = +MACHINE\\apache +INTRANET02\\apache +apache\n...\nmaking a connection to 'normal' service www\n\nstring_to_sid: Sid +MACHINE\\apache does not start with 'S-'.\nlookup_name: MACHINE\\apache => MACHINE (domain), apache (name)\nmap_name_to_wellknown_sid: looking up apache\npush_sec_ctx(0, 0) : sec_ctx_stack_ndx = 1\npush_conn_ctx(0) : conn_ctx_stack_ndx = 0\nsetting sec ctx (0, 0) - sec_ctx_stack_ndx = 1\nNT user token: (NULL)\nUNIX token of user 0\nPrimary group is 0 and contains 0 supplementary groups\npop_sec_ctx (0, 0) - sec_ctx_stack_ndx = 0\n\nstring_to_sid: Sid +MYSERVER\\apache does not start with 'S-'.\nlookup_name: MYSERVER\\apache => MYSERVER (domain), apache (name)\npush_sec_ctx(0, 0) : sec_ctx_stack_ndx = 1\npush_conn_ctx(0) : conn_ctx_stack_ndx = 0\nsetting sec ctx (0, 0) - sec_ctx_stack_ndx = 1\nNT user token: (NULL)\nUNIX token of user 0\nPrimary group is 0 and contains 0 supplementary groups\npop_sec_ctx (0, 0) - sec_ctx_stack_ndx = 0\nlookup_name MYSERVER\\apache failed\n\nstring_to_sid: Sid +apache does not start with 'S-'.\nlookup_name: MYSERVER\\apache => MYSERVER (domain), apache (name)\npush_sec_ctx(0, 0) : sec_ctx_stack_ndx = 1\npush_conn_ctx(0) : conn_ctx_stack_ndx = 0\nsetting sec ctx (0, 0) - sec_ctx_stack_ndx = 1\nNT user token: (NULL)\nUNIX token of user 0\nPrimary group is 0 and contains 0 supplementary groups\npop_sec_ctx (0, 0) - sec_ctx_stack_ndx = 0\nlookup_name: Unix Group\\apache => Unix Group (domain), apache (name)\n\nUser MYDOMAIN\\user1 not in 'valid users'\nuser 'MYDOMAIN\\user1' (from session setup) not permitted to access this share \n(www)\n--\n\nSo what's wrong with my configuration?\n\nCheers, Johann\n\n"}