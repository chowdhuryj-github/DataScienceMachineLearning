{"category": "ham", "to_address": "samba-cvs@samba.org", "from_address": "metze@samba.org", "subject": "svn commit: samba r22464 - in branches/SAMBA_3_0/source/rpc_client:\n\t.", "body": "Author: metze\nDate: 2007-04-22 17:00:58 +0000 (Sun, 22 Apr 2007)\nNew Revision: 22464\n\nWebSVN: http://websvn.samba.org/cgi-bin/viewcvs.cgi?view=rev&root=samba&rev=22464\n\nLog:\nremove double code and use a function\n\nmetze\nModified:\n   branches/SAMBA_3_0/source/rpc_client/cli_samr.c\n\n\nChangeset:\nModified: branches/SAMBA_3_0/source/rpc_client/cli_samr.c\n===================================================================\n--- branches/SAMBA_3_0/source/rpc_client/cli_samr.c\t2007-04-22 16:45:03 UTC (rev 22463)\n+++ branches/SAMBA_3_0/source/rpc_client/cli_samr.c\t2007-04-22 17:00:58 UTC (rev 22464)\n@@ -1193,11 +1193,6 @@\n \t\t\t\t    const char *newpassword, \n \t\t\t\t    const char *oldpassword )\n {\n-\tprs_struct qbuf, rbuf;\n-\tSAMR_Q_CHGPASSWD_USER q;\n-\tSAMR_R_CHGPASSWD_USER r;\n-\tNTSTATUS result = NT_STATUS_UNSUCCESSFUL;\n-\n \tuchar new_nt_password[516];\n \tuchar new_lm_password[516];\n \tuchar old_nt_hash[16];\n@@ -1208,13 +1203,8 @@\n \tuchar new_nt_hash[16];\n \tuchar new_lanman_hash[16];\n \n-\tchar *srv_name_slash = talloc_asprintf(mem_ctx, \"\\\\\\\\%s\", cli->cli->desthost);\n-\n \tDEBUG(10,(\"rpccli_samr_chgpasswd_user\\n\"));\n \n-\tZERO_STRUCT(q);\n-\tZERO_STRUCT(r);\n-\n \t/* Calculate the MD4 hash (NT compatible) of the password */\n \tE_md4hash(oldpassword, old_nt_hash);\n \tE_md4hash(newpassword, new_nt_hash);\n@@ -1241,30 +1231,11 @@\n \tSamOEMhash( new_nt_password, old_nt_hash, 516);\n \tE_old_pw_hash( new_nt_hash, old_nt_hash, old_nt_hash_enc);\n \n-\t/* Marshall data and send request */\n-\n-\tinit_samr_q_chgpasswd_user(&q, srv_name_slash, username, \n-\t\t\t\t   new_nt_password, \n-\t\t\t\t   old_nt_hash_enc, \n-\t\t\t\t   new_lm_password,\n-\t\t\t\t   old_lanman_hash_enc);\n-\n-\tCLI_DO_RPC(cli, mem_ctx, PI_SAMR, SAMR_CHGPASSWD_USER,\n-\t\tq, r,\n-\t\tqbuf, rbuf,\n-\t\tsamr_io_q_chgpasswd_user,\n-\t\tsamr_io_r_chgpasswd_user,\n-\t\tNT_STATUS_UNSUCCESSFUL); \n-\n-\t/* Return output parameters */\n-\n-\tif (!NT_STATUS_IS_OK(result = r.status)) {\n-\t\tgoto done;\n-\t}\n-\n- done:\n-\n-\treturn result;\n+\treturn rpccli_samr_chng_pswd_auth_crap(cli, mem_ctx, username,\n+\t\t\t\t\t       data_blob_const(new_nt_password,sizeof(new_nt_password)),\n+\t\t\t\t\t       data_blob_const(old_nt_hash_enc,sizeof(old_nt_hash_enc)),\n+\t\t\t\t\t       data_blob_const(new_lm_password,sizeof(new_lm_password)),\n+\t\t\t\t\t       data_blob_const(old_lanman_hash_enc,sizeof(old_lanman_hash_enc)));\n }\n \n /* User change passwd with auth crap */\n\n"}