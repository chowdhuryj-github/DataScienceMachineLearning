{"category": "ham", "to_address": "samba-cvs@samba.org", "from_address": "tridge@samba.org", "subject": "Rev 555: more careful checking of lengths in\n\thttp://samba.org/~tridge/ctdb", "body": "------------------------------------------------------------\nrevno: 555\nrevision-id: tridge@samba.org-20070704062209-pw3hnhxw7ambmvcf\nparent: tridge@samba.org-20070704045133-umv584idgrsbj03e\ncommitter: Andrew Tridgell \nbranch nick: tridge\ntimestamp: Wed 2007-07-04 16:22:09 +1000\nmessage:\n  more careful checking of lengths\nmodified:\n  takeover/system.c              system.c-20070525071636-a5n1ihghjtppy08r-3\n=== modified file 'takeover/system.c'\n--- a/takeover/system.c\t2007-07-04 03:53:22 +0000\n+++ b/takeover/system.c\t2007-07-04 06:22:09 +0000\n@@ -484,7 +484,7 @@\n \t\tevent_loop_once(ev);\n \n \t\tret = recv(s, pkt, RCVPKTSIZE, MSG_TRUNC);\n-\t\tif (ret<40) {\n+\t\tif (ret < sizeof(*eth)+sizeof(*ip)) {\n \t\t\tcontinue;\n \t\t}\n \n@@ -496,7 +496,7 @@\n \t\t}\n \t\n \t\t/* IP */\n-\t\tip = (struct iphdr *)&pkt[14];\n+\t\tip = (struct iphdr *)(eth+1);\n \t\t/* We only want IPv4 packets */\n \t\tif (ip->version != 4) {\n \t\t\tcontinue;\n@@ -519,8 +519,15 @@\n \t\t\tcontinue;\n \t\t}\n \n+\t\t/* make sure its not a short packet */\n+\t\tif (offsetof(struct tcphdr, ack_seq) + 4 + \n+\t\t    (ip->ihl*4) + sizeof(*eth) > ret) {\n+\t\t\tcontinue;\n+\t\t}\n+\n \t\t/* TCP */\n-\t\ttcp = (struct tcphdr *)&pkt[14+ip->ihl*4];\n+\t\ttcp = (struct tcphdr *)((ip->ihl*4) + (char *)ip);\n+\t\t\n \t\t/* We only want replies from the port we tickled */\n \t\tif (tcp->source != dst->sin_port) {\n \t\t\tcontinue;\n\n"}