{"category": "ham", "to_address": "samba-cvs@samba.org", "from_address": "obnox@samba.org", "subject": "svn commit: samba r23435 - in\n\tbranches/SAMBA_3_0_26/source/registry: .", "body": "Author: obnox\nDate: 2007-06-12 14:05:35 +0000 (Tue, 12 Jun 2007)\nNew Revision: 23435\n\nWebSVN: http://websvn.samba.org/cgi-bin/viewcvs.cgi?view=rev&root=samba&rev=23435\n\nLog:\nMerge r19777 from 3_0:\n\nMake regsubkey_ctr_addkey return WERROR.\n\nMichael\n\n\nModified:\n   branches/SAMBA_3_0_26/source/registry/reg_objects.c\n\n\nChangeset:\nModified: branches/SAMBA_3_0_26/source/registry/reg_objects.c\n===================================================================\n--- branches/SAMBA_3_0_26/source/registry/reg_objects.c\t2007-06-12 12:35:24 UTC (rev 23434)\n+++ branches/SAMBA_3_0_26/source/registry/reg_objects.c\t2007-06-12 14:05:35 UTC (rev 23435)\n@@ -41,35 +41,37 @@\n  Add a new key to the array\n  **********************************************************************/\n \n-int regsubkey_ctr_addkey( REGSUBKEY_CTR *ctr, const char *keyname )\n+WERROR regsubkey_ctr_addkey( REGSUBKEY_CTR *ctr, const char *keyname )\n {\n-\tif ( !keyname )\n-\t\treturn ctr->num_subkeys;\n+\tchar **newkeys;\n \n+\tif ( !keyname ) {\n+\t\treturn WERR_OK;\n+\t}\n+\n \t/* make sure the keyname is not already there */\n \n-\tif ( regsubkey_ctr_key_exists( ctr, keyname ) )\n-\t\treturn ctr->num_subkeys;\n-\t\t\n-\t/* allocate a space for the char* in the array */\n-\t\t\n-\tif (ctr->subkeys == NULL) {\n-\t\tctr->subkeys = TALLOC_P(ctr, char *);\n-\t} else {\n-\t\tctr->subkeys = TALLOC_REALLOC_ARRAY(ctr, ctr->subkeys, char *, ctr->num_subkeys+1);\n+\tif ( regsubkey_ctr_key_exists( ctr, keyname ) ) {\n+\t\treturn WERR_OK;\n \t}\n \n-\tif (!ctr->subkeys) {\n-\t\tctr->num_subkeys = 0;\n-\t\treturn 0;\n+\tif (!(newkeys = TALLOC_REALLOC_ARRAY(ctr, ctr->subkeys, char *,\n+\t\t\t\t\t     ctr->num_subkeys+1))) {\n+\t\treturn WERR_NOMEM;\n \t}\n \n-\t/* allocate the string and save it in the array */\n-\t\n-\tctr->subkeys[ctr->num_subkeys] = talloc_strdup( ctr, keyname );\n+\tctr->subkeys = newkeys;\n+\n+\tif (!(ctr->subkeys[ctr->num_subkeys] = talloc_strdup(ctr->subkeys,\n+\t\t\t\t\t\t\t     keyname ))) {\n+\t\t/*\n+\t\t * Don't shrink the new array again, this wastes a pointer\n+\t\t */\n+\t\treturn WERR_NOMEM;\n+\t}\n \tctr->num_subkeys++;\n-\t\n-\treturn ctr->num_subkeys;\n+\n+\treturn WERR_OK;\n }\n  \n  /***********************************************************************\n\n"}