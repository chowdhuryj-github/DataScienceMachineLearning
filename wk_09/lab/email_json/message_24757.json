{"category": "ham", "to_address": "samba-cvs@samba.org", "from_address": "metze@samba.org", "subject": "svn commit: samba r22748 - in branches/SAMBA_4_0/source: auth\n\tlib/messaging libcli scripting/ejs winbind wrepl_server", "body": "Author: metze\nDate: 2007-05-07 15:19:53 +0000 (Mon, 07 May 2007)\nNew Revision: 22748\n\nWebSVN: http://websvn.samba.org/cgi-bin/viewcvs.cgi?view=rev&root=samba&rev=22748\n\nLog:\nfix memleaks by passing an mem_ctx to\nirpc_servers_byname()\n\nmetze\nModified:\n   branches/SAMBA_4_0/source/auth/auth_winbind.c\n   branches/SAMBA_4_0/source/lib/messaging/irpc.h\n   branches/SAMBA_4_0/source/lib/messaging/messaging.c\n   branches/SAMBA_4_0/source/libcli/finddcs.c\n   branches/SAMBA_4_0/source/scripting/ejs/smbcalls_rpc.c\n   branches/SAMBA_4_0/source/winbind/wb_dom_info.c\n   branches/SAMBA_4_0/source/wrepl_server/wrepl_apply_records.c\n   branches/SAMBA_4_0/source/wrepl_server/wrepl_scavenging.c\n\n\nChangeset:\nModified: branches/SAMBA_4_0/source/auth/auth_winbind.c\n===================================================================\n--- branches/SAMBA_4_0/source/auth/auth_winbind.c\t2007-05-07 15:07:49 UTC (rev 22747)\n+++ branches/SAMBA_4_0/source/auth/auth_winbind.c\t2007-05-07 15:19:53 UTC (rev 22748)\n@@ -162,7 +162,10 @@\n \tconst struct auth_usersupplied_info *user_info_new;\n \tstruct netr_IdentityInfo *identity_info;\n \n-\twinbind_servers = irpc_servers_byname(ctx->auth_ctx->msg_ctx, \"winbind_server\");\n+\ts = talloc(mem_ctx, struct winbind_check_password_state);\n+\tNT_STATUS_HAVE_NO_MEMORY(s);\n+\n+\twinbind_servers = irpc_servers_byname(ctx->auth_ctx->msg_ctx, s, \"winbind_server\");\n \tif ((winbind_servers == NULL) || (winbind_servers[0].id == 0)) {\n \t\tDEBUG(0, (\"Winbind authentication for [%s]\\\\[%s] failed, \" \n \t\t\t  \"no winbind_server running!\\n\",\n@@ -170,9 +173,6 @@\n \t\treturn NT_STATUS_NO_LOGON_SERVERS;\n \t}\n \n-\ts = talloc(mem_ctx, struct winbind_check_password_state);\n-\tNT_STATUS_HAVE_NO_MEMORY(s);\n-\n \tif (user_info->flags & USER_INFO_INTERACTIVE_LOGON) {\n \t\tstruct netr_PasswordInfo *password_info;\n \n\nModified: branches/SAMBA_4_0/source/lib/messaging/irpc.h\n===================================================================\n--- branches/SAMBA_4_0/source/lib/messaging/irpc.h\t2007-05-07 15:07:49 UTC (rev 22747)\n+++ branches/SAMBA_4_0/source/lib/messaging/irpc.h\t2007-05-07 15:19:53 UTC (rev 22748)\n@@ -117,7 +117,7 @@\n \t\t   int callnum, void *r, TALLOC_CTX *ctx);\n \n NTSTATUS irpc_add_name(struct messaging_context *msg_ctx, const char *name);\n-struct server_id *irpc_servers_byname(struct messaging_context *msg_ctx, const char *name);\n+struct server_id *irpc_servers_byname(struct messaging_context *msg_ctx, TALLOC_CTX *mem_ctx, const char *name);\n void irpc_remove_name(struct messaging_context *msg_ctx, const char *name);\n NTSTATUS irpc_send_reply(struct irpc_message *m, NTSTATUS status);\n \n\nModified: branches/SAMBA_4_0/source/lib/messaging/messaging.c\n===================================================================\n--- branches/SAMBA_4_0/source/lib/messaging/messaging.c\t2007-05-07 15:07:49 UTC (rev 22747)\n+++ branches/SAMBA_4_0/source/lib/messaging/messaging.c\t2007-05-07 15:19:53 UTC (rev 22748)\n@@ -961,7 +961,8 @@\n /*\n   return a list of server ids for a server name\n */\n-struct server_id *irpc_servers_byname(struct messaging_context *msg_ctx, \n+struct server_id *irpc_servers_byname(struct messaging_context *msg_ctx,\n+\t\t\t\t      TALLOC_CTX *mem_ctx,\n \t\t\t\t      const char *name)\n {\n \tstruct tdb_wrap *t;\n@@ -985,7 +986,7 @@\n \t\treturn NULL;\n \t}\n \tcount = rec.dsize / sizeof(struct server_id);\n-\tret = talloc_array(msg_ctx, struct server_id, count+1);\n+\tret = talloc_array(mem_ctx, struct server_id, count+1);\n \tif (ret == NULL) {\n \t\ttdb_unlock_bystring(t->tdb, name);\n \t\ttalloc_free(t);\n\nModified: branches/SAMBA_4_0/source/libcli/finddcs.c\n===================================================================\n--- branches/SAMBA_4_0/source/libcli/finddcs.c\t2007-05-07 15:07:49 UTC (rev 22747)\n+++ branches/SAMBA_4_0/source/libcli/finddcs.c\t2007-05-07 15:19:53 UTC (rev 22748)\n@@ -133,7 +133,7 @@\n \t\treturn;\n \t}\n \n-\tnbt_servers = irpc_servers_byname(state->msg_ctx, \"nbt_server\");\n+\tnbt_servers = irpc_servers_byname(state->msg_ctx, state, \"nbt_server\");\n \tif ((nbt_servers == NULL) || (nbt_servers[0].id == 0)) {\n \t\tfallback_node_status(state);\n \t\treturn;\n\nModified: branches/SAMBA_4_0/source/scripting/ejs/smbcalls_rpc.c\n===================================================================\n--- branches/SAMBA_4_0/source/scripting/ejs/smbcalls_rpc.c\t2007-05-07 15:07:49 UTC (rev 22747)\n+++ branches/SAMBA_4_0/source/scripting/ejs/smbcalls_rpc.c\t2007-05-07 15:19:53 UTC (rev 22748)\n@@ -88,7 +88,7 @@\n \t\treturn -1;\n \t}\n \n-\tp->dest_ids = irpc_servers_byname(p->msg_ctx, p->server_name);\n+\tp->dest_ids = irpc_servers_byname(p->msg_ctx, p, p->server_name);\n \tif (p->dest_ids == NULL || p->dest_ids[0].id == 0) {\n \t\ttalloc_free(p);\n \t\tstatus = NT_STATUS_OBJECT_NAME_NOT_FOUND;\n\nModified: branches/SAMBA_4_0/source/winbind/wb_dom_info.c\n===================================================================\n--- branches/SAMBA_4_0/source/winbind/wb_dom_info.c\t2007-05-07 15:07:49 UTC (rev 22747)\n+++ branches/SAMBA_4_0/source/winbind/wb_dom_info.c\t2007-05-07 15:19:53 UTC (rev 22748)\n@@ -96,7 +96,7 @@\n \tif (!composite_is_ok(state->ctx)) return;\n \n \tnbt_servers = irpc_servers_byname(state->service->task->msg_ctx,\n-\t\t\t\t\t  \"nbt_server\");\n+\t\t\t\t\t  state, \"nbt_server\");\n \tif ((nbt_servers == NULL) || (nbt_servers[0].id == 0)) {\n \t\tcomposite_error(state->ctx, NT_STATUS_NO_LOGON_SERVERS);\n \t\treturn;\n\nModified: branches/SAMBA_4_0/source/wrepl_server/wrepl_apply_records.c\n===================================================================\n--- branches/SAMBA_4_0/source/wrepl_server/wrepl_apply_records.c\t2007-05-07 15:07:49 UTC (rev 22747)\n+++ branches/SAMBA_4_0/source/wrepl_server/wrepl_apply_records.c\t2007-05-07 15:19:53 UTC (rev 22748)\n@@ -911,7 +911,7 @@\n \tDEBUG(4,(\"late release demand record %s\\n\",\n \t\t nbt_name_string(state, &state->replica.name)));\n \n-\tnbt_servers = irpc_servers_byname(state->msg_ctx, \"nbt_server\");\n+\tnbt_servers = irpc_servers_byname(state->msg_ctx, state, \"nbt_server\");\n \tif ((nbt_servers == NULL) || (nbt_servers[0].id == 0)) {\n \t\treturn NT_STATUS_INTERNAL_ERROR;\n \t}\n@@ -1051,7 +1051,7 @@\n \ttalloc_steal(state, replica->owner);\n \ttalloc_steal(state, replica->addresses);\n \n-\tnbt_servers = irpc_servers_byname(state->msg_ctx, \"nbt_server\");\n+\tnbt_servers = irpc_servers_byname(state->msg_ctx, state, \"nbt_server\");\n \tif ((nbt_servers == NULL) || (nbt_servers[0].id == 0)) {\n \t\treturn NT_STATUS_INTERNAL_ERROR;\n \t}\n@@ -1113,7 +1113,7 @@\n \tDEBUG(4,(\"release demand record %s\\n\",\n \t\t nbt_name_string(mem_ctx, &replica->name)));\n \n-\tnbt_servers = irpc_servers_byname(partner->service->task->msg_ctx, \"nbt_server\");\n+\tnbt_servers = irpc_servers_byname(partner->service->task->msg_ctx, mem_ctx, \"nbt_server\");\n \tif ((nbt_servers == NULL) || (nbt_servers[0].id == 0)) {\n \t\treturn NT_STATUS_INTERNAL_ERROR;\n \t}\n\nModified: branches/SAMBA_4_0/source/wrepl_server/wrepl_scavenging.c\n===================================================================\n--- branches/SAMBA_4_0/source/wrepl_server/wrepl_scavenging.c\t2007-05-07 15:07:49 UTC (rev 22747)\n+++ branches/SAMBA_4_0/source/wrepl_server/wrepl_scavenging.c\t2007-05-07 15:19:53 UTC (rev 22748)\n@@ -390,7 +390,7 @@\n \tstruct verify_state *s;\n \tstruct server_id *nbt_servers;\n \n-\tnbt_servers = irpc_servers_byname(service->task->msg_ctx, \"nbt_server\");\n+\tnbt_servers = irpc_servers_byname(service->task->msg_ctx, tmp_mem, \"nbt_server\");\n \tif ((nbt_servers == NULL) || (nbt_servers[0].id == 0)) {\n \t\treturn NT_STATUS_INTERNAL_ERROR;\n \t}\n\n"}