{"category": "ham", "to_address": "Ed Plese <ed@edplese.com>", "from_address": "James Peach <jpeach@samba.org>", "subject": "Re: [PATCH] Shadow Copy Improvements", "body": "\nOn 26/04/2007, at 10:44 AM, Ed Plese wrote:\n\n> Attached is a set of 3 patches that add fixes and improvements to the\n> existing shadow_copy VFS module.  I had previously sent a patch for  \n> a new\n> shadow_copy_zfs module with customizations specific to ZFS on  \n> Solaris but\n> these patches instead add generic improvements that should work  \n> with most\n> snapshot methods.\n>\n> I'd like give a big thanks to Alison Winters for contributing many  \n> of the\n> ideas for this patch as well as code and testing.\n\nThankyou both, this is a nice patch. I have some comments below ...\n\n> The defaults for all of the new smb.conf parameters are set to values\n> that preserve backwards compatibility with the current module.\n>\n> The patches are:\n>\n> 1-dirent-fix.patch\n>   This fixes the module to work on systems that define struct  \n> dirent with\n>   d_name[1].  Solaris is an example of such a system and it causes the\n>   share to appear to be completely empty.\n\nThis looks OK. I would prefer that you pad out the dirent structures  \nto guarantee a safe alignment, 8 or 16 bytes.\n\n> 2-sort.patch\n>   With the existing shadow_copy module the shadow copies are  \n> displayed in\n>   the Windows GUI in the order the server obtains them from readdir \n> (3).\n>   On some systems and filesystems readdir(3) does not return files  \n> in any\n>   particular order which leads to the list in the GUI being  \n> unsorted and\n>   difficult to use.  This patch allows the list to be sorted based on\n>   a \"sort\" parameter specified for the module.  Allowed values are  \n> \"asc\"\n>   or \"desc\".  When not specified the current unsorted behavior is  \n> maintained.\n\nThis looks fine too, though I think we should sort by default.\n\n> 3-paths.patch\n\nThis needs a copyright attribution.\n\n>   This patch allows for various components of the snapshot paths to be\n>   easily customized.  Currently this must be done by creating  \n> scripts that\n>   will create the appropriate symbolic links every time a snapshot  \n> is taken\n>   and consequently clean up all of the symbolic links whenever a  \n> snapshot\n>   is deleted.  With this patch the path components are specified in  \n> the\n>   smb.conf file using the new parameters \"path\", \"subpath\",  \n> \"format\", and\n>   \"localtime\".  The defaults for all of the new parameters maintain  \n> the\n>   current behavior of the module.\n>\n\nIn shadow_copy_opendir(), you are still using shadow_copy_match_name  \nto filter out shadow directories. It looks like this won't work  \ncorrectly with if you specify the format parameter.\n\nYou should be able to cache the prefix created in  \nshadow_copy_file_to_snapshot_path since it's quite expensive to  \ncreate. Attaching this to handle->data should be sufficient.\n\n>   path - Specifies the path to the directory that contains the  \n> snapshots.\n>\n>   format - This is the format of the snapshot names in str[fp]time  \n> notation\n>       except that $ characters are used in place of % characters.\n\nHmmm. We already use %$FOO to expand environment variables. Is it  \npossible for this to get unexpected results?\n\n>   subpath - The subdirectory under the snapshot that contains all  \n> of the\n>       files for this shadow copy.\n\nCan you elaborate on the need for both a \"path\" and a \"subpath\"  \nparameter? Why are they both necessary?\n\n>   localtime (boolean) - Treat the snapshot names as being in localtime\n>       instead of the default of GMT.\n>\n>   These probably aren't the clearest explanations of the parameters  \n> but the\n>   examples below should help to clear up any confusion.\n>\n> Some limitations include:\n>\n> * shadow copy does not work correctly when mapping a drive to a\n>   subdirectory of a share\n\nCould you add a comment noting this. A future enhancement might be to  \ncheck that the share is the root of a mounted filesystem when the  \nmodule loads.\n\n> * snapshot names are limited to expressions that can be expressed  \n> with the\n>   str[fp]time(3) functions and variable substitutions in smb.conf\n>\n> Example uses:\n>\n> Use with @GMT- directories or symbolic links in the share:\n>\n> [homes]\n>    public = no\n>    writable = yes\n>    printable = no\n>    vfs object = shadow_copy\n>\n>\n> A single large filesystem mounted at /home that contains all of the  \n> home\n> directories.  The snapshots reside in /snapshots/home.\n>\n> [homes]\n>    path = /home/%U\n>    public = no\n>    writable = yes\n>    printable = no\n>    vfs object = shadow_copy\n>    shadow_copy: path = /snapshots/home\n>    shadow_copy: subpath = %U\n>    shadow_copy: format = $Y.$m.$d-$H.$M.$S\n>    shadow_copy: sort = desc\n>    shadow_copy: localtime = yes\n>\n>\n> A separate ZFS filesystem for each home directory.\n>\n> [homes]\n>    path = /home/%U\n>    public = no\n>    writable = yes\n>    printable = no\n>    vfs object = shadow_copy\n>    shadow_copy: path = /home/%U/.zfs/snapshot\n>    shadow_copy: format = $Y.$m.$d-$H.$M.$S\n>    shadow_copy: sort = desc\n>    shadow_copy: localtime = yes\n\nAs per the limitations noted above, these configs won't work  \ncorrectly, no?\n\n>\n>\n> Comments and feedback are welcome!\n>\n> Thanks,\n>\n> Ed Plese\n> <1-dirent-fix.patch>\n> <2-sort.patch>\n> <3-paths.patch>\n\n--\nJames Peach | jpeach@samba.org\n\n\n"}