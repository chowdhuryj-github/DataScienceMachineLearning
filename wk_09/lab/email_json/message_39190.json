{"category": "ham", "to_address": "samba-technical@lists.samba.org", "from_address": "Steve Langasek <vorlon@debian.org>", "subject": "Re: [PATCH 5/10] Debian patch: yet another (obscure?) smbmount\n\tpatch...", "body": "On Wed, May 30, 2007 at 10:48:03PM +0200, Christian Perrier wrote:\n> The attached patch is currently used in Debian.\n\n> Again, this is a patch against a part of the code that is, IIRC,\n> in low maintenance mode.\n\n> I don't even have a clear idea of what the patch is meant for but\n> that's mostly because I lack the needed skills.\n\n> So, just in case you can do something with it....\n\nThis patch is the stopgap that was implemented immediately prior to the\nsarge release in response to the security issue with the kernel ignoring\nuid,gid mount options when the server supported unix capabilities.  The\ncorresponding changelog entry was:\n\n samba (3.0.14a-4) unstable; urgency=high\n\n   [...]\n   * Patch smbmount to strip CAP_UNIX out of the capabilities passed to\n     the kernel when uid, gid, dmask, or fmask options have been\n     specified; this keeps the mount permissions from changing out from\n     under the user when upgrading to a server (or to a kernel) that \n     supports unix extensions.  Closes: #310982.\n   [...]\n\nThis issue has since been resolved in the kernel.  The patch should not be\nincluded upstream in Samba, and should be dropped from the Debian packages\nas well just as soon as someone has time for testing it (or, y'know, as soon\nas we stop shipping mount.smbfs altogether).\n\n-- \nSteve Langasek                   Give me a lever long enough and a Free OS\nDebian Developer                   to set it on, and I can move the world.\nvorlon@debian.org                                   http://www.debian.org/\n\n> Goal: respect requests for uid-flattening mount options by disabling Unix permissions handling in the kernel driver\n> \n> Fixes: ?\n> \n> Status wrt upstream: If pertinent, should probably be forwarded\n> \n> Note: Part of no-longer maintained smbfs stuff?\n> \n> Index: samba-3.0.25a/source/client/smbmount.c\n> ===================================================================\n> --- samba-3.0.25a.orig/source/client/smbmount.c\t2007-05-26 07:46:33.884647544 +0200\n> +++ samba-3.0.25a/source/client/smbmount.c\t2007-05-26 07:46:34.272650637 +0200\n> @@ -213,6 +213,10 @@\n>    \t\tc->capabilities &= ~CAP_STATUS32;\n>  \t\tc->force_dos_errors = True;\n>  \t}\n> +\t/* For now, respect requests for uid-flattening mount options\n> +\t   by disabling Unix permissions handling in the kernel driver */\n> +\tif (mount_uid || mount_gid || mount_fmask || mount_dmask)\n> +\t\tc->capabilities &= ~CAP_UNIX;\n>  \n>  \tif (!NT_STATUS_IS_OK(cli_session_setup(c, username, \n>  \t\t\t\t\t       password, strlen(password),\n\n"}