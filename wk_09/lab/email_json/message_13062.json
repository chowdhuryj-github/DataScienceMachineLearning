{"category": "ham", "to_address": "samba-cvs@samba.org", "from_address": "jerry@samba.org", "subject": "svn commit: samba r22473 - in branches: SAMBA_3_0/source/nsswitch\n\tSAMBA_3_0_25/source/nsswitch SAMBA_3_0_25/source/passdb\n\tSAMBA_3_0_RELEASE/source/nsswitch", "body": "Author: jerry\nDate: 2007-04-23 06:10:22 +0000 (Mon, 23 Apr 2007)\nNew Revision: 22473\n\nWebSVN: http://websvn.samba.org/cgi-bin/viewcvs.cgi?view=rev&root=samba&rev=22473\n\nLog:\nCorrect fix for setting a default compat tdb idmap backend.\nPrevious code would always fill in \"idmap backend = tdb\"\neven if you defined idmap domains.  My fault.  I should\nhave tested the original patch more before committing.\n\n\n\nModified:\n   branches/SAMBA_3_0/source/nsswitch/idmap.c\n   branches/SAMBA_3_0_25/source/nsswitch/idmap.c\n   branches/SAMBA_3_0_25/source/passdb/pdb_ldap.c\n   branches/SAMBA_3_0_RELEASE/source/nsswitch/idmap.c\n\n\nChangeset:\nModified: branches/SAMBA_3_0/source/nsswitch/idmap.c\n===================================================================\n--- branches/SAMBA_3_0/source/nsswitch/idmap.c\t2007-04-23 00:43:47 UTC (rev 22472)\n+++ branches/SAMBA_3_0/source/nsswitch/idmap.c\t2007-04-23 06:10:22 UTC (rev 22473)\n@@ -289,40 +289,42 @@\n \n \tdom_list = lp_idmap_domains();\n \t\n-\tif ( dom_list && lp_idmap_backend() ) {\n-\t\tDEBUG(0, (\"WARNING: idmap backend and idmap domains are \"\n-\t\t\t  \"mutually excusive!\\n\"));\n-\t\tDEBUGADD(0,(\"idmap backend option will be IGNORED!\\n\"));\n-\t} else if ( lp_idmap_backend() ) {\n-\t\tconst char **compat_list = lp_idmap_backend();\n+\tif ( lp_idmap_backend() ) {\n+       \t\tconst char **compat_list = lp_idmap_backend();\n \t\tchar *p = NULL;\n \t\tconst char *q = NULL;\t\t\n \n-\t\tcompat = 1;\n+\t\tif ( dom_list ) {\t\t\t\n+\t\t\tDEBUG(0, (\"WARNING: idmap backend and idmap domains are \"\n+\t\t\t\t  \"mutually excusive!\\n\"));\n+\t\t\tDEBUGADD(0,(\"idmap backend option will be IGNORED!\\n\"));\n+\t\t} else {\n+\t\t\tcompat = 1;\n \n-\t\tif ( (compat_backend = talloc_strdup( idmap_ctx, *compat_list )) == NULL ) {\n-\t\t\tret = NT_STATUS_NO_MEMORY;\n-\t\t\tgoto done;\t\t\t\n-\t\t}\n+\t\t\tif ( (compat_backend = talloc_strdup( idmap_ctx, *compat_list )) == NULL ) {\n+\t\t\t\tret = NT_STATUS_NO_MEMORY;\n+\t\t\t\tgoto done;\n+\t\t\t}\n \t\t\n-\t\t/* strip any leading idmap_ prefix of */\n-\t\tif (strncmp(*compat_list, \"idmap_\", 6) == 0 ) {\n-\t\t\tq = *compat_list += 6;\n-\t\t\tDEBUG(0, (\"WARNING: idmap backend uses obsolete and \"\n-\t\t\t\t  \"deprecated 'idmap_' prefix.\\n\"\n-\t\t\t\t  \"Please replace 'idmap_%s' by '%s' in %s\\n\", \n-\t\t\t\t  q, q, dyn_CONFIGFILE));\n-\t\t\tcompat_backend = talloc_strdup( idmap_ctx, q);\n-\t\t} else {\n-\t\t\tcompat_backend = talloc_strdup( idmap_ctx, *compat_list);\n-\t\t}\n+\t\t\t/* strip any leading idmap_ prefix of */\n+\t\t\tif (strncmp(*compat_list, \"idmap_\", 6) == 0 ) {\n+\t\t\t\tq = *compat_list += 6;\n+\t\t\t\tDEBUG(0, (\"WARNING: idmap backend uses obsolete and \"\n+\t\t\t\t\t  \"deprecated 'idmap_' prefix.\\n\"\n+\t\t\t\t\t  \"Please replace 'idmap_%s' by '%s' in %s\\n\", \n+\t\t\t\t\t  q, q, dyn_CONFIGFILE));\n+\t\t\t\tcompat_backend = talloc_strdup( idmap_ctx, q);\n+\t\t\t} else {\n+\t\t\t\tcompat_backend = talloc_strdup( idmap_ctx, *compat_list);\n+\t\t\t}\n \t\t\t\n-\t\t/* separate the backend and module arguements */\n-\t\tif ((p = strchr(compat_backend, ':')) != NULL) {\n-\t\t\t*p = '\\0';\t\t\t\n-\t\t\tcompat_params = p + 1;\n-\t\t}\n-\t} else {\n+\t\t\t/* separate the backend and module arguements */\n+\t\t\tif ((p = strchr(compat_backend, ':')) != NULL) {\n+\t\t\t\t*p = '\\0';\t\t\t\n+\t\t\t\tcompat_params = p + 1;\n+\t\t\t}\n+\t\t}\t\t\n+\t} else if ( !dom_list ) {\n \t\t/* Back compatible: without idmap domains and explicit\n \t\t   idmap backend.  Taking default idmap backend: tdb */\n \t\t\n@@ -331,7 +333,6 @@\n \t\tcompat_params = compat_backend;\n \t}\n \n-\n \tif ( ! dom_list) {\n \t\tdom_list = idmap_default_domain;\n \t}\n\nModified: branches/SAMBA_3_0_25/source/nsswitch/idmap.c\n===================================================================\n--- branches/SAMBA_3_0_25/source/nsswitch/idmap.c\t2007-04-23 00:43:47 UTC (rev 22472)\n+++ branches/SAMBA_3_0_25/source/nsswitch/idmap.c\t2007-04-23 06:10:22 UTC (rev 22473)\n@@ -289,40 +289,42 @@\n \n \tdom_list = lp_idmap_domains();\n \t\n-\tif ( dom_list && lp_idmap_backend() ) {\n-\t\tDEBUG(0, (\"WARNING: idmap backend and idmap domains are \"\n-\t\t\t  \"mutually excusive!\\n\"));\n-\t\tDEBUGADD(0,(\"idmap backend option will be IGNORED!\\n\"));\n-\t} else if ( lp_idmap_backend() ) {\n-\t\tconst char **compat_list = lp_idmap_backend();\n+\tif ( lp_idmap_backend() ) {\n+       \t\tconst char **compat_list = lp_idmap_backend();\n \t\tchar *p = NULL;\n \t\tconst char *q = NULL;\t\t\n \n-\t\tcompat = 1;\n+\t\tif ( dom_list ) {\t\t\t\n+\t\t\tDEBUG(0, (\"WARNING: idmap backend and idmap domains are \"\n+\t\t\t\t  \"mutually excusive!\\n\"));\n+\t\t\tDEBUGADD(0,(\"idmap backend option will be IGNORED!\\n\"));\n+\t\t} else {\n+\t\t\tcompat = 1;\n \n-\t\tif ( (compat_backend = talloc_strdup( idmap_ctx, *compat_list )) == NULL ) {\n-\t\t\tret = NT_STATUS_NO_MEMORY;\n-\t\t\tgoto done;\t\t\t\n-\t\t}\n+\t\t\tif ( (compat_backend = talloc_strdup( idmap_ctx, *compat_list )) == NULL ) {\n+\t\t\t\tret = NT_STATUS_NO_MEMORY;\n+\t\t\t\tgoto done;\n+\t\t\t}\n \t\t\n-\t\t/* strip any leading idmap_ prefix of */\n-\t\tif (strncmp(*compat_list, \"idmap_\", 6) == 0 ) {\n-\t\t\tq = *compat_list += 6;\n-\t\t\tDEBUG(0, (\"WARNING: idmap backend uses obsolete and \"\n-\t\t\t\t  \"deprecated 'idmap_' prefix.\\n\"\n-\t\t\t\t  \"Please replace 'idmap_%s' by '%s' in %s\\n\", \n-\t\t\t\t  q, q, dyn_CONFIGFILE));\n-\t\t\tcompat_backend = talloc_strdup( idmap_ctx, q);\n-\t\t} else {\n-\t\t\tcompat_backend = talloc_strdup( idmap_ctx, *compat_list);\n-\t\t}\n+\t\t\t/* strip any leading idmap_ prefix of */\n+\t\t\tif (strncmp(*compat_list, \"idmap_\", 6) == 0 ) {\n+\t\t\t\tq = *compat_list += 6;\n+\t\t\t\tDEBUG(0, (\"WARNING: idmap backend uses obsolete and \"\n+\t\t\t\t\t  \"deprecated 'idmap_' prefix.\\n\"\n+\t\t\t\t\t  \"Please replace 'idmap_%s' by '%s' in %s\\n\", \n+\t\t\t\t\t  q, q, dyn_CONFIGFILE));\n+\t\t\t\tcompat_backend = talloc_strdup( idmap_ctx, q);\n+\t\t\t} else {\n+\t\t\t\tcompat_backend = talloc_strdup( idmap_ctx, *compat_list);\n+\t\t\t}\n \t\t\t\n-\t\t/* separate the backend and module arguements */\n-\t\tif ((p = strchr(compat_backend, ':')) != NULL) {\n-\t\t\t*p = '\\0';\t\t\t\n-\t\t\tcompat_params = p + 1;\n-\t\t}\n-\t} else {\n+\t\t\t/* separate the backend and module arguements */\n+\t\t\tif ((p = strchr(compat_backend, ':')) != NULL) {\n+\t\t\t\t*p = '\\0';\t\t\t\n+\t\t\t\tcompat_params = p + 1;\n+\t\t\t}\n+\t\t}\t\t\n+\t} else if ( !dom_list ) {\n \t\t/* Back compatible: without idmap domains and explicit\n \t\t   idmap backend.  Taking default idmap backend: tdb */\n \t\t\n@@ -331,7 +333,6 @@\n \t\tcompat_params = compat_backend;\n \t}\n \n-\n \tif ( ! dom_list) {\n \t\tdom_list = idmap_default_domain;\n \t}\n\nModified: branches/SAMBA_3_0_25/source/passdb/pdb_ldap.c\n===================================================================\n--- branches/SAMBA_3_0_25/source/passdb/pdb_ldap.c\t2007-04-23 00:43:47 UTC (rev 22472)\n+++ branches/SAMBA_3_0_25/source/passdb/pdb_ldap.c\t2007-04-23 06:10:22 UTC (rev 22473)\n@@ -455,7 +455,11 @@\n \t\t\ttemp))\n \t\treturn (time_t) 0;\n \n-\tstrptime(temp, \"%Y%m%d%H%M%SZ\", &tm);\n+\tif ( !strptime(temp, \"%Y%m%d%H%M%SZ\", &tm)) {\n+\t\tDEBUG(2,(\"ldapsam_get_entry_timestamp: strptime failed on: %s\\n\",\n+\t\t\t(char*)temp));\n+\t\treturn (time_t) 0;\n+\t}\n \ttzset();\n \treturn timegm(&tm);\n }\n\nModified: branches/SAMBA_3_0_RELEASE/source/nsswitch/idmap.c\n===================================================================\n--- branches/SAMBA_3_0_RELEASE/source/nsswitch/idmap.c\t2007-04-23 00:43:47 UTC (rev 22472)\n+++ branches/SAMBA_3_0_RELEASE/source/nsswitch/idmap.c\t2007-04-23 06:10:22 UTC (rev 22473)\n@@ -289,40 +289,42 @@\n \n \tdom_list = lp_idmap_domains();\n \t\n-\tif ( dom_list && lp_idmap_backend() ) {\n-\t\tDEBUG(0, (\"WARNING: idmap backend and idmap domains are \"\n-\t\t\t  \"mutually excusive!\\n\"));\n-\t\tDEBUGADD(0,(\"idmap backend option will be IGNORED!\\n\"));\n-\t} else if ( lp_idmap_backend() ) {\n-\t\tconst char **compat_list = lp_idmap_backend();\n+\tif ( lp_idmap_backend() ) {\n+       \t\tconst char **compat_list = lp_idmap_backend();\n \t\tchar *p = NULL;\n \t\tconst char *q = NULL;\t\t\n \n-\t\tcompat = 1;\n+\t\tif ( dom_list ) {\t\t\t\n+\t\t\tDEBUG(0, (\"WARNING: idmap backend and idmap domains are \"\n+\t\t\t\t  \"mutually excusive!\\n\"));\n+\t\t\tDEBUGADD(0,(\"idmap backend option will be IGNORED!\\n\"));\n+\t\t} else {\n+\t\t\tcompat = 1;\n \n-\t\tif ( (compat_backend = talloc_strdup( idmap_ctx, *compat_list )) == NULL ) {\n-\t\t\tret = NT_STATUS_NO_MEMORY;\n-\t\t\tgoto done;\t\t\t\n-\t\t}\n+\t\t\tif ( (compat_backend = talloc_strdup( idmap_ctx, *compat_list )) == NULL ) {\n+\t\t\t\tret = NT_STATUS_NO_MEMORY;\n+\t\t\t\tgoto done;\n+\t\t\t}\n \t\t\n-\t\t/* strip any leading idmap_ prefix of */\n-\t\tif (strncmp(*compat_list, \"idmap_\", 6) == 0 ) {\n-\t\t\tq = *compat_list += 6;\n-\t\t\tDEBUG(0, (\"WARNING: idmap backend uses obsolete and \"\n-\t\t\t\t  \"deprecated 'idmap_' prefix.\\n\"\n-\t\t\t\t  \"Please replace 'idmap_%s' by '%s' in %s\\n\", \n-\t\t\t\t  q, q, dyn_CONFIGFILE));\n-\t\t\tcompat_backend = talloc_strdup( idmap_ctx, q);\n-\t\t} else {\n-\t\t\tcompat_backend = talloc_strdup( idmap_ctx, *compat_list);\n-\t\t}\n+\t\t\t/* strip any leading idmap_ prefix of */\n+\t\t\tif (strncmp(*compat_list, \"idmap_\", 6) == 0 ) {\n+\t\t\t\tq = *compat_list += 6;\n+\t\t\t\tDEBUG(0, (\"WARNING: idmap backend uses obsolete and \"\n+\t\t\t\t\t  \"deprecated 'idmap_' prefix.\\n\"\n+\t\t\t\t\t  \"Please replace 'idmap_%s' by '%s' in %s\\n\", \n+\t\t\t\t\t  q, q, dyn_CONFIGFILE));\n+\t\t\t\tcompat_backend = talloc_strdup( idmap_ctx, q);\n+\t\t\t} else {\n+\t\t\t\tcompat_backend = talloc_strdup( idmap_ctx, *compat_list);\n+\t\t\t}\n \t\t\t\n-\t\t/* separate the backend and module arguements */\n-\t\tif ((p = strchr(compat_backend, ':')) != NULL) {\n-\t\t\t*p = '\\0';\t\t\t\n-\t\t\tcompat_params = p + 1;\n-\t\t}\n-\t} else {\n+\t\t\t/* separate the backend and module arguements */\n+\t\t\tif ((p = strchr(compat_backend, ':')) != NULL) {\n+\t\t\t\t*p = '\\0';\t\t\t\n+\t\t\t\tcompat_params = p + 1;\n+\t\t\t}\n+\t\t}\t\t\n+\t} else if ( !dom_list ) {\n \t\t/* Back compatible: without idmap domains and explicit\n \t\t   idmap backend.  Taking default idmap backend: tdb */\n \t\t\n@@ -331,7 +333,6 @@\n \t\tcompat_params = compat_backend;\n \t}\n \n-\n \tif ( ! dom_list) {\n \t\tdom_list = idmap_default_domain;\n \t}\n\n"}