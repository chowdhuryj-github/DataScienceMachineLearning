{"category": "ham", "to_address": "samba-cvs@samba.org", "from_address": "abartlet@samba.org", "subject": "svn commit: samba r23177 - in branches/SAMBA_4_0/source:\n\tlib/ldb/tools script scripting/ejs scripting/libjs setup", "body": "Author: abartlet\nDate: 2007-05-29 01:20:47 +0000 (Tue, 29 May 2007)\nNew Revision: 23177\n\nWebSVN: http://websvn.samba.org/cgi-bin/viewcvs.cgi?view=rev&root=samba&rev=23177\n\nLog:\nAdd in a new provision-backend script.  This helps set up the OpenLDAP or Fedora DS backend. \n\nThis required a new mkdir() call in ejs.\n\nWe can now provision just the schema for ad2oLschema to operate on\n(with provision_schema(), without performing the whole provision, just\nto wipe it again (adjustments to 'make test' to come soon).\n\nAndrew Bartlett\n\nAdded:\n   branches/SAMBA_4_0/source/setup/fedorads-partitions.ldif\n   branches/SAMBA_4_0/source/setup/fedorads.inf\n   branches/SAMBA_4_0/source/setup/provision-backend\n   branches/SAMBA_4_0/source/setup/slapd.conf\nModified:\n   branches/SAMBA_4_0/source/lib/ldb/tools/ad2oLschema.c\n   branches/SAMBA_4_0/source/script/installmisc.sh\n   branches/SAMBA_4_0/source/scripting/ejs/smbcalls_sys.c\n   branches/SAMBA_4_0/source/scripting/libjs/provision.js\n\n\nChangeset:\nModified: branches/SAMBA_4_0/source/lib/ldb/tools/ad2oLschema.c\n===================================================================\n--- branches/SAMBA_4_0/source/lib/ldb/tools/ad2oLschema.c\t2007-05-29 00:34:31 UTC (rev 23176)\n+++ branches/SAMBA_4_0/source/lib/ldb/tools/ad2oLschema.c\t2007-05-29 01:20:47 UTC (rev 23177)\n@@ -195,9 +195,11 @@\n static struct ldb_dn *find_schema_dn(struct ldb_context *ldb, TALLOC_CTX *mem_ctx) \n {\n \tconst char *rootdse_attrs[] = {\"schemaNamingContext\", NULL};\n+\tconst char *no_attrs[] = { NULL };\n \tstruct ldb_dn *schemadn;\n \tstruct ldb_dn *basedn = ldb_dn_new(mem_ctx, ldb, NULL);\n \tstruct ldb_result *rootdse_res;\n+\tstruct ldb_result *schema_res;\n \tint ldb_ret;\n \tif (!basedn) {\n \t\treturn NULL;\n@@ -206,8 +208,25 @@\n \t/* Search for rootdse */\n \tldb_ret = ldb_search(ldb, basedn, LDB_SCOPE_BASE, NULL, rootdse_attrs, &rootdse_res);\n \tif (ldb_ret != LDB_SUCCESS) {\n-\t\tprintf(\"Search failed: %s\\n\", ldb_errstring(ldb));\n-\t\treturn NULL;\n+\t\tldb_ret = ldb_search(ldb, basedn, LDB_SCOPE_SUBTREE, \n+\t\t\t\t \"(&(objectClass=dMD)(cn=Schema))\", \n+\t\t\t\t no_attrs, &schema_res);\n+\t\tif (ldb_ret) {\n+\t\t\tprintf(\"cn=Schema Search failed: %s\\n\", ldb_errstring(ldb));\n+\t\t\treturn NULL;\n+\t\t}\n+\n+\t\ttalloc_steal(mem_ctx, schema_res);\n+\n+\t\tif (schema_res->count != 1) {\n+\t\t\tprintf(\"Failed to find rootDSE\");\n+\t\t\treturn NULL;\n+\t\t}\n+\t\t\n+\t\tschemadn = talloc_steal(mem_ctx, schema_res->msgs[0]->dn);\n+\t\ttalloc_free(schema_res);\n+\t\treturn schemadn;\n+\t\t\n \t}\n \t\n \ttalloc_steal(mem_ctx, rootdse_res);\n\nModified: branches/SAMBA_4_0/source/script/installmisc.sh\n===================================================================\n--- branches/SAMBA_4_0/source/script/installmisc.sh\t2007-05-29 00:34:31 UTC (rev 23176)\n+++ branches/SAMBA_4_0/source/script/installmisc.sh\t2007-05-29 01:20:47 UTC (rev 23177)\n@@ -14,6 +14,8 @@\n \n echo \"Installing setup templates\"\n mkdir -p $SETUPDIR || exit 1\n+cp setup/schema-map-* $SETUPDIR || exit 1\n+cp setup/*.inf $SETUPDIR || exit 1\n cp setup/*.ldif $SETUPDIR || exit 1\n cp setup/*.zone $SETUPDIR || exit 1\n cp setup/*.conf $SETUPDIR || exit 1\n\nModified: branches/SAMBA_4_0/source/scripting/ejs/smbcalls_sys.c\n===================================================================\n--- branches/SAMBA_4_0/source/scripting/ejs/smbcalls_sys.c\t2007-05-29 00:34:31 UTC (rev 23176)\n+++ branches/SAMBA_4_0/source/scripting/ejs/smbcalls_sys.c\t2007-05-29 01:20:47 UTC (rev 23177)\n@@ -305,7 +305,34 @@\n \treturn 0;\n }\n \n+/*\n+  mkdir()\n+  usage:\n+     ok = sys.mkdir(dirname, mode);\n+*/\n+static int ejs_sys_mkdir(MprVarHandle eid, int argc, struct MprVar **argv)\n+{\n+\tBOOL ret;\n+\tchar *name;\n+\tif (argc != 2) {\n+\t\tejsSetErrorMsg(eid, \"sys_mkdir invalid arguments, need mkdir(dirname, mode)\");\n+\t\treturn -1;\n+\t}\n+\tif (!mprVarIsString(argv[0]->type)) {\n+\t\tejsSetErrorMsg(eid, \"sys_mkdir dirname not a string\");\n+\t\treturn -1;\n+\t}\n+\tif (!mprVarIsNumber(argv[1]->type)) {\n+\t\tejsSetErrorMsg(eid, \"sys_mkdir mode not a number\");\n+\t\treturn -1;\n+\t}\n+\tmprVarToString(&name, 0, NULL, argv[0]);\n+\tret = mkdir(name, mprVarToNumber(argv[1]));\n+\tmpr_Return(eid, mprCreateBoolVar(ret == 0));\n+\treturn 0;\n+}\n \n+\n /*\n   return fields of a stat() call\n */\n@@ -438,6 +465,7 @@\n \tmprSetCFunction(obj, \"ntgmtime\", ejs_sys_ntgmtime);\n \tmprSetCFunction(obj, \"ldaptime\", ejs_sys_ldaptime);\n \tmprSetCFunction(obj, \"httptime\", ejs_sys_httptime);\n+\tmprSetCFunction(obj, \"mkdir\", ejs_sys_mkdir);\n \tmprSetStringCFunction(obj, \"unlink\", ejs_sys_unlink);\n \tmprSetStringCFunction(obj, \"file_load\", ejs_sys_file_load);\n \tmprSetStringCFunction(obj, \"file_save\", ejs_sys_file_save);\n\nModified: branches/SAMBA_4_0/source/scripting/libjs/provision.js\n===================================================================\n--- branches/SAMBA_4_0/source/scripting/libjs/provision.js\t2007-05-29 00:34:31 UTC (rev 23176)\n+++ branches/SAMBA_4_0/source/scripting/libjs/provision.js\t2007-05-29 01:20:47 UTC (rev 23177)\n@@ -388,6 +388,7 @@\n \tpaths.ldap_basedn_ldif = lp.get(\"private dir\") + \"/\" + subobj.DNSDOMAIN + \".ldif\";\n \tpaths.ldap_config_basedn_ldif = lp.get(\"private dir\") + \"/\" + subobj.DNSDOMAIN + \"-config.ldif\";\n \tpaths.ldap_schema_basedn_ldif = lp.get(\"private dir\") + \"/\" + subobj.DNSDOMAIN + \"-schema.ldif\";\n+\tpaths.ldapdir = lp.get(\"private dir\") + \"/ldap\";\n \treturn paths;\n }\n \n@@ -446,10 +447,11 @@\n \tvar rdns = split(\",\", subobj.DOMAINDN);\n \tsubobj.RDN_DC = substr(rdns[0], strlen(\"DC=\"));\n \n-\tsubobj.SAM_LDB\t\t= paths.samdb;\n-\tsubobj.SECRETS_LDB\t= paths.secrets;\n+\tsubobj.SAM_LDB\t\t= \"tdb://\" + paths.samdb;\n \tsubobj.SECRETS_KEYTAB\t= paths.keytab;\n \n+\tsubobj.LDAPDIR = paths.ldapdir;\n+\n \treturn true;\n }\n \n@@ -703,6 +705,53 @@\n \treturn true;\n }\n \n+/*\n+  provision just the schema into a temporary ldb, so we can run ad2oLschema on it\n+*/\n+function provision_schema(subobj, message, tmp_schema_path, paths)\n+{\n+\tvar lp = loadparm_init();\n+\tvar sys = sys_init();\n+\tvar info = new Object();\n+\n+\tvar ok = provision_fix_subobj(subobj, message, paths);\n+\tassert(ok);\n+\n+\tinfo.subobj = subobj;\n+\tinfo.message = message;\n+\n+\tmessage(\"Setting up sam.ldb partitions\\n\");\n+\n+\t/* This will erase anything in the tmp db */\n+\tvar samdb = open_ldb(info, tmp_schema_path, true);\n+\n+\tmessage(\"Adding schema container (permitted to fail)\\n\");\n+\tvar add_ok = setup_add_ldif(\"provision_schema_basedn.ldif\", info, samdb, true);\n+\tmessage(\"Modifying schema container\\n\");\n+\tvar modify_ok = setup_ldb_modify(\"provision_schema_basedn_modify.ldif\", info, samdb);\n+\tif (!modify_ok) {\n+\t\tif (!add_ok) {\n+\t\t\tmessage(\"Failed to both add and modify schema dn: + samdb.errstring() + \"\\n\");\n+\t\t\tmessage(\"Perhaps you need to run the provision script with the --ldap-base-dn option, and add this record to the backend manually\\n\"); \n+\t\t\tassert(modify_ok);\n+\t\t}\n+\t\tmessage(\"Failed to modify the schema container: \" + samdb.errstring() + \"\\n\");\n+\t\tassert(modify_ok);\n+\t}\n+\n+\tmessage(\"Setting up sam.ldb Samba4 schema\\n\");\n+\tsetup_add_ldif(\"schema_samba4.ldif\", info, samdb, false);\n+\tmessage(\"Setting up sam.ldb AD schema\\n\");\n+\tsetup_add_ldif(\"schema.ldif\", info, samdb, false);\n+\n+\tvar commit_ok = samdb.transaction_commit();\n+\tif (!commit_ok) {\n+\t\tinfo.message(\"samdb commit failed: \" + samdb.errstring() + \"\\n\");\n+\t\tassert(commit_ok);\n+\t}\n+\tsamdb.close();\n+}\n+\n /* Write out a DNS zone file, from the info in the current database */\n function provision_dns(subobj, message, paths, session_info, credentials)\n {\n@@ -787,6 +836,7 @@\n \tsubobj.KRBTGTPASS   = randpass(12);\n \tsubobj.MACHINEPASS  = randpass(12);\n \tsubobj.ADMINPASS    = randpass(12);\n+\tsubobj.LDAPMANAGERPASS     = randpass(12);\n \tsubobj.DEFAULTSITE  = \"Default-First-Site-Name\";\n \tsubobj.NEWGUID      = randguid;\n \tsubobj.NTTIME       = nttime;\n\nAdded: branches/SAMBA_4_0/source/setup/fedorads-partitions.ldif\n===================================================================\n--- branches/SAMBA_4_0/source/setup/fedorads-partitions.ldif\t2007-05-29 00:34:31 UTC (rev 23176)\n+++ branches/SAMBA_4_0/source/setup/fedorads-partitions.ldif\t2007-05-29 01:20:47 UTC (rev 23177)\n@@ -0,0 +1,28 @@\n+dn: cn=\\\"${CONFIGDN}\\\",cn=mapping tree,cn=config\n+objectclass: top\n+objectclass: extensibleObject\n+objectclass: nsMappingTree\n+nsslapd-state: backend\n+nsslapd-backend: configData\n+cn: ${CONFIGDN}\n+\n+dn: cn=configData,cn=ldbm database,cn=plugins,cn=config\n+objectclass: extensibleObject\n+objectclass: nsBackendInstance\n+nsslapd-suffix: ${CONFIGDN}\n+cn: configData\n+\n+dn: cn=\\\"${SCHEMADN}\\\",cn=mapping tree,cn=config\n+objectclass: top\n+objectclass: extensibleObject\n+objectclass: nsMappingTree\n+nsslapd-state: backend\n+nsslapd-backend: schemaData\n+cn: ${SCHEMADN}\n+\n+dn: cn=schemaData,cn=ldbm database,cn=plugins,cn=config\n+objectclass: extensibleObject\n+objectclass: nsBackendInstance\n+nsslapd-suffix: ${SCHEMADN}\n+cn: schemaData\n+\n\nAdded: branches/SAMBA_4_0/source/setup/fedorads.inf\n===================================================================\n--- branches/SAMBA_4_0/source/setup/fedorads.inf\t2007-05-29 00:34:31 UTC (rev 23176)\n+++ branches/SAMBA_4_0/source/setup/fedorads.inf\t2007-05-29 01:20:47 UTC (rev 23177)\n@@ -0,0 +1,26 @@\n+[General]\n+SuiteSpotUserID = ${ROOT}\n+FullMachineName=   ${HOSTNAME}.${DNSDOMAIN}\n+ServerRoot=   ${LDAPDIR}\n+\n+[slapd]\n+ldapifilepath=${LDAPDIR}/ldapi\n+Suffix= ${DOMAINDN}\n+RootDN= cn=Manager,${DOMAINDN}\n+RootDNPwd= ${LDAPMANAGERPASS}\n+ServerIdentifier= samba4\n+\n+inst_dir= ${LDAPDIR}/slapd-samba4\n+config_dir= ${LDAPDIR}/slapd-samba4\n+schema_dir= ${LDAPDIR}/slapd-samba4/schema\n+lock_dir= ${LDAPDIR}/slapd-samba4/lock\n+log_dir= ${LDAPDIR}/slapd-samba4/logs\n+run_dir= ${LDAPDIR}/slapd-samba4/logs\n+db_dir= ${LDAPDIR}/slapd-samba4/db\n+bak_dir= ${LDAPDIR}/slapd-samba4/bak\n+tmp_dir= ${LDAPDIR}/slapd-samba4/tmp\n+ldif_dir= ${LDAPDIR}/slapd-samba4/ldif\n+cert_dir= ${LDAPDIR}/slapd-samba4\n+\n+start_server= 0\n+install_full_schema= 0\n\\ No newline at end of file\n\nAdded: branches/SAMBA_4_0/source/setup/provision-backend\n===================================================================\n--- branches/SAMBA_4_0/source/setup/provision-backend\t2007-05-29 00:34:31 UTC (rev 23176)\n+++ branches/SAMBA_4_0/source/setup/provision-backend\t2007-05-29 01:20:47 UTC (rev 23177)\n@@ -0,0 +1,114 @@\n+#!/bin/sh\n+exec smbscript \"$0\" ${1+\"$@\"}\n+/*\n+\tprovision a Samba4 server\n+\tCopyright Andrew Tridgell 2005\n+\tReleased under the GNU GPL v2 or later\n+*/\n+\n+options = GetOptions(ARGV,\n+\t\t\"POPT_AUTOHELP\",\n+\t\t\"POPT_COMMON_SAMBA\",\n+\t\t\"POPT_COMMON_VERSION\",\n+\t\t\"POPT_COMMON_CREDENTIALS\",\n+\t\t'realm=s',\n+\t\t'host-name=s',\n+\t\t'ldap-manager-pass=s',\n+\t\t'root=s',\n+\t\t'quiet',\n+\t\t'ldap-backend-type=s');\n+\n+if (options == undefined) {\n+   println(\"Failed to parse options\");\n+   return -1;\n+}\n+\n+sys = sys_init();\n+\n+libinclude(\"base.js\");\n+libinclude(\"provision.js\");\n+\n+/*\n+  print a message if quiet is not set\n+*/\n+function message()\n+{\n+\tif (options[\"quiet\"] == undefined) {\n+\t\tprint(vsprintf(arguments));\n+\t}\n+}\n+\n+/*\n+ show some help\n+*/\n+function ShowHelp()\n+{\n+\tprint(\"\n+Samba4 provisioning\n+\n+provision [options]\n+ --realm\tREALM\t\tset realm\n+ --host-name\tHOSTNAME\tset hostname\n+ --ldap-manager-pass\tPASSWORD\tchoose LDAP Manager password (otherwise random)\n+ --root         USERNAME\tchoose 'root' unix username\n+ --quiet\t\t\tBe quiet\n+ --ldap-backend-type LDAPSERVER     Select either \\\"openldap\\\" or \\\"fedora-ds\\\" as a target to configure\n+ --ldap-module= MODULE          LDB mapping module to use for the LDAP backend\n+You must provide at least a realm and ldap-backend-type\n+\n+\");\n+\texit(1);\n+}\n+\n+if (options['host-name'] == undefined) {\n+\toptions['host-name'] = hostname();\n+}\n+\n+/*\n+   main program\n+*/\n+if (options[\"realm\"] == undefined ||\n+    options[\"ldap-backend-type\"] == undefined ||\n+    options[\"host-name\"] == undefined) {\n+\tShowHelp();\n+}\n+\n+/* cope with an initially blank smb.conf */\n+var lp = loadparm_init();\n+lp.set(\"realm\", options.realm);\n+lp.reload();\n+\n+var subobj = provision_guess();\n+for (r in options) {\n+\tvar key = strupper(join(\"\", split(\"-\", r)));\n+\tsubobj[key] = options[r];\n+}\n+\n+var ldapbackend = (options[\"ldap-backend-type\"] != undefined);\n+\n+var paths = provision_default_paths(subobj);\n+provision_fix_subobj(subobj, message, paths);\n+message(\"Provisioning LDAP backend for %s in realm %s into %s\\n\", subobj.HOSTNAME, subobj.REALM, subobj.LDAPDIR);\n+message(\"Using LDAP Manager password: %s\\n\", subobj.LDAPMANAGERPASS);\n+\n+var tmp_schema_ldb = subobj.LDAPDIR + \"/schema-tmp.ldb\";\n+sys.mkdir(subobj.LDAPDIR, 0700);\n+\n+provision_schema(subobj, message, tmp_schema_ldb, paths);\n+\n+var mapping;\n+var ext;\n+if (options[\"ldap-backend-type\"] == \"fedora-ds\") {\n+\tmapping = \"schema-map-fedora-ds-1.0\";\n+\text = \"ldif\";\n+\tsetup_file(\"fedorads.inf\", message, subobj.LDAPDIR + \"/fedorads.inf\", subobj);\n+\tsetup_file(\"fedorads-partitions.ldif\", message, subobj.LDAPDIR + \"/fedorads-partitions.ldif\", subobj);\n+} else if (options[\"ldap-backend-type\"] == \"openldap\") {\n+\tmapping = \"schema-map-openldap-2.3\";\n+\text = \"schema\";\n+\tsetup_file(\"slapd.conf\", message, subobj.LDAPDIR + \"/slapd.conf\", subobj);\n+}\n+message(\"ad2oLschema --option=convert:target=\" + options[\"ldap-backend-type\"] + \" -I \" + lp.get(\"setup directory\") + \"/\" + mapping + \" -H tdb://\" + tmp_schema_ldb + \" -O \" + subobj.LDAPDIR + \"/backend-schema.\" + ext + \"\\n\");\n+\n+message(\"All OK\\n\");\n+return 0;\n\n\nProperty changes on: branches/SAMBA_4_0/source/setup/provision-backend\n___________________________________________________________________\nName: svn:executable\n   + *\n\nAdded: branches/SAMBA_4_0/source/setup/slapd.conf\n===================================================================\n--- branches/SAMBA_4_0/source/setup/slapd.conf\t2007-05-29 00:34:31 UTC (rev 23176)\n+++ branches/SAMBA_4_0/source/setup/slapd.conf\t2007-05-29 01:20:47 UTC (rev 23177)\n@@ -0,0 +1,73 @@\n+loglevel 0\n+\n+include ${LDAPDIR}/backend-schema.schema\n+\n+pidfile\t\t${LDAPDIR}/slapd.pid\n+argsfile\t${LDAPDIR}/slapd.args\n+sasl-realm ${DNSDOMAIN}\n+access to * by * write\n+\n+allow update_anon\n+\n+authz-regexp\n+          uid=([^,]*),cn=${DNSDOMAIN},cn=digest-md5,cn=auth\n+          ldap:///${DOMAINDN}??sub?(samAccountName=\\$1)\n+\n+authz-regexp\n+          uid=([^,]*),cn=([^,]*),cn=digest-md5,cn=auth\n+          ldap:///${DOMAINDN}??sub?(samAccountName=\\$1)\n+\n+include $modconf\n+\n+defaultsearchbase \\\"${DOMAINDN}\\\"\n+\n+backend\t\tbdb\n+database        bdb\n+suffix\t\t\\\"cn=Schema,cn=Configuration,${DOMAINDN}\\\"\n+directory\t${LDAPDIR}/db/schema\n+index           objectClass eq\n+index           samAccountName eq\n+index name eq\n+index objectCategory eq\n+index lDAPDisplayName eq\n+index subClassOf eq\n+\n+database        bdb\n+suffix\t\t\\\"cn=Configuration,${DOMAINDN}\\\"\n+directory\t${LDAPDIR}/db/config\n+index           objectClass eq\n+index           samAccountName eq\n+index name eq\n+index objectSid eq\n+index objectCategory eq\n+index nCName eq pres\n+index subClassOf eq\n+index dnsRoot eq\n+index nETBIOSName eq pres\n+\n+database        bdb\n+suffix\t\t\\\"${DOMAINDN}\\\"\n+rootdn          \\\"cn=Manager,${DOMAINDN}\\\"\n+rootpw          ${LDAPMANAGERPASS}\n+directory\t${LDAPDIR}/db/user\n+index           objectClass eq\n+index           samAccountName eq\n+index name eq\n+index objectSid eq\n+index objectCategory eq\n+index member eq\n+index uidNumber eq\n+index gidNumber eq\n+index unixName eq\n+index privilege eq\n+index nCName eq pres\n+index lDAPDisplayName eq\n+index subClassOf eq\n+index dnsRoot eq\n+index nETBIOSName eq pres\n+\n+#syncprov is stable in OpenLDAP 2.3, and available in 2.2.  \n+#We only need this for the contextCSN attribute anyway....\n+overlay syncprov\n+syncprov-checkpoint 100 10\n+syncprov-sessionlog 100\n\n"}