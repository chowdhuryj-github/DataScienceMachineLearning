{"category": "ham", "to_address": "samba-cvs@samba.org", "from_address": "tridge@samba.org", "subject": "Rev 485: get parents idea of recmode and recmaster when deciding if\n\twe should do a takeover run in http://samba.org/~tridge/ctdb", "body": "------------------------------------------------------------\nrevno: 485\nrevision-id: tridge@samba.org-20070606115654-7fqbek6uoxforwen\nparent: tridge@samba.org-20070606113436-6bo9s8zewul2xwjk\ncommitter: Andrew Tridgell \nbranch nick: tridge\ntimestamp: Wed 2007-06-06 21:56:54 +1000\nmessage:\n  get parents idea of recmode and recmaster when deciding if we should do a takeover run\nmodified:\n  common/ctdb_recoverd.c         recoverd.c-20070503213540-bvxuyd9jm1f7ig90-1\n=== modified file 'common/ctdb_recoverd.c'\n--- a/common/ctdb_recoverd.c\t2007-06-06 11:27:09 +0000\n+++ b/common/ctdb_recoverd.c\t2007-06-06 11:56:54 +0000\n@@ -996,8 +996,17 @@\n \t}\n \n \tnodemap->nodes[i].flags = c->flags;\n+\n+\tret = ctdb_ctrl_getrecmaster(ctdb, CONTROL_TIMEOUT(), \n+\t\t\t\t     CTDB_CURRENT_NODE, &ctdb->recovery_master);\n+\n+\tif (ret == 0) {\n+\t\tret = ctdb_ctrl_getrecmode(ctdb, CONTROL_TIMEOUT(), \n+\t\t\t\t\t   CTDB_CURRENT_NODE, &ctdb->recovery_mode);\n+\t}\n \t\n-\tif (ctdb->recovery_master == ctdb->vnn &&\n+\tif (ret == 0 &&\n+\t    ctdb->recovery_master == ctdb->vnn &&\n \t    ctdb->recovery_mode == CTDB_RECOVERY_NORMAL &&\n \t    ctdb->takeover.enabled) {\n \t\tret = ctdb_takeover_run(ctdb, nodemap);\n\n"}