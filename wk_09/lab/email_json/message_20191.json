{"category": "ham", "to_address": "samba-cvs@samba.org", "from_address": "jelmer@samba.org", "subject": "svn commit: samba r22605 - in branches/SAMBA_4_0: . source/selftest", "body": "Author: jelmer\nDate: 2007-04-30 12:48:42 +0000 (Mon, 30 Apr 2007)\nNew Revision: 22605\n\nWebSVN: http://websvn.samba.org/cgi-bin/viewcvs.cgi?view=rev&root=samba&rev=22605\n\nLog:\nSet up all required environments before starting tests.\nModified:\n   branches/SAMBA_4_0/\n   branches/SAMBA_4_0/source/selftest/selftest.pl\n\n\nChangeset:\n\nProperty changes on: branches/SAMBA_4_0\n___________________________________________________________________\nName: bzr:merge\n...skipped...\n\nModified: branches/SAMBA_4_0/source/selftest/selftest.pl\n===================================================================\n--- branches/SAMBA_4_0/source/selftest/selftest.pl\t2007-04-30 12:11:45 UTC (rev 22604)\n+++ branches/SAMBA_4_0/source/selftest/selftest.pl\t2007-04-30 12:48:42 UTC (rev 22605)\n@@ -134,6 +134,7 @@\n my $opt_analyse_cmd = undef;\n my $opt_resetup_env = undef;\n my $opt_bindir = undef;\n+my $opt_no_lazy_setup = undef;\n \n my $srcdir = \".\";\n my $builddir = \".\";\n@@ -454,6 +455,7 @@\n \t\t'testenv' => \\$opt_testenv,\n \t\t'ldap:s' => \\$ldap,\n \t\t'analyse-cmd=s' => \\$opt_analyse_cmd,\n+\t\t'no-lazy-setup' => \\$opt_no_lazy_setup,\n \t\t'resetup-environment' => \\$opt_resetup_env,\n \t\t'bindir:s' => \\$opt_bindir,\n \t    );\n@@ -647,6 +649,7 @@\n my $testsdir = \"$srcdir/selftest\";\n $ENV{CONFIGURATION} = \"--configfile=$conffile\";\n \n+my %required_envs = ();\n \n if ($opt_quick) {\n \topen(IN, \"$testsdir/tests_quick.sh|\");\n@@ -661,8 +664,10 @@\n \t\t$env =~ s/\\n//g;\n \t\tmy $cmdline = ;\n \t\t$cmdline =~ s/\\n//g;\n-\t\tpush (@todo, [$name, $env, $cmdline]) \n-\t\t\tif (not defined($tests) or $name =~ /$tests/);\n+\t\tif (not defined($tests) or $name =~ /$tests/) {\n+\t\t\t$required_envs{$env} = 1;\n+\t\t\tpush (@todo, [$name, $env, $cmdline]);\n+\t\t}\n \t} else {\n \t\tprint;\n \t}\n@@ -777,6 +782,10 @@\n \t$msg_ops = $plain_msg_ops;\n }\n \n+if ($opt_no_lazy_setup) {\n+\tsetup_env($_) foreach (keys %required_envs);\n+}\n+\n if ($opt_testenv) {\n \tmy $testenv_name = $ENV{SELFTEST_TESTENV};\n \t$testenv_name = \"dc\" unless defined($testenv_name);\n\n"}