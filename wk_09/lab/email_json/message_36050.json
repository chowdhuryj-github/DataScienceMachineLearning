{"category": "ham", "to_address": "samba-cvs@samba.org", "from_address": "tridge@samba.org", "subject": "Rev 343: paraoid check for empty db on attach in\n\thttp://samba.org/~tridge/ctdb", "body": "------------------------------------------------------------\nrevno: 343\nrevision-id: tridge@samba.org-20070525084849-chpdtiih9av0o5ji\nparent: tridge@samba.org-20070525071650-qvhjv520xjvzhubs\ncommitter: Andrew Tridgell \nbranch nick: tridge\ntimestamp: Fri 2007-05-25 18:48:49 +1000\nmessage:\n  paraoid check for empty db on attach\nmodified:\n  common/ctdb_ltdb.c             ctdb_ltdb.c-20061128065342-to93h6eejj5kon81-2\n=== modified file 'common/ctdb_ltdb.c'\n--- a/common/ctdb_ltdb.c\t2007-05-19 03:45:24 +0000\n+++ b/common/ctdb_ltdb.c\t2007-05-25 08:48:49 +0000\n@@ -318,6 +318,20 @@\n \n \n /*\n+  paraoid check to see if the db is empty\n+ */\n+static void ctdb_check_db_empty(struct ctdb_db_context *ctdb_db)\n+{\n+\tstruct tdb_context *tdb = ctdb_db->ltdb->tdb;\n+\tint count = tdb_traverse_read(tdb, NULL, NULL);\n+\tif (count != 0) {\n+\t\tDEBUG(0,(__location__ \" tdb '%s' not empty on attach! aborting\\n\",\n+\t\t\t ctdb_db->db_path));\n+\t\tctdb_fatal(ctdb_db->ctdb, \"database not empty on attach\");\n+\t}\n+}\n+\n+/*\n   a client has asked to attach a new database\n  */\n int32_t ctdb_control_db_attach(struct ctdb_context *ctdb, TDB_DATA indata,\n@@ -384,6 +398,8 @@\n \t\treturn -1;\n \t}\n \n+\tctdb_check_db_empty(ctdb_db);\n+\n \tDLIST_ADD(ctdb->db_list, ctdb_db);\n \n \t/* \n\n"}