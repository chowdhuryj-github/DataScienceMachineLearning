{"category": "ham", "to_address": "samba-cvs@samba.org", "from_address": "jra@samba.org", "subject": "svn commit: samba r23589 - in branches: SAMBA_3_0/source/smbd\n\tSAMBA_3_0_25/source/smbd SAMBA_3_0_26/source/smbd", "body": "Author: jra\nDate: 2007-06-22 17:19:08 +0000 (Fri, 22 Jun 2007)\nNew Revision: 23589\n\nWebSVN: http://websvn.samba.org/cgi-bin/viewcvs.cgi?view=rev&root=samba&rev=23589\n\nLog:\nEnsure we will always release any timeout handler\non fsp close or removal of oplock. Mulitple removals\nare safe.\nJeremy.\n\nModified:\n   branches/SAMBA_3_0/source/smbd/files.c\n   branches/SAMBA_3_0/source/smbd/oplock.c\n   branches/SAMBA_3_0_25/source/smbd/files.c\n   branches/SAMBA_3_0_25/source/smbd/oplock.c\n   branches/SAMBA_3_0_26/source/smbd/files.c\n   branches/SAMBA_3_0_26/source/smbd/oplock.c\n\n\nChangeset:\nModified: branches/SAMBA_3_0/source/smbd/files.c\n===================================================================\n--- branches/SAMBA_3_0/source/smbd/files.c\t2007-06-22 14:54:39 UTC (rev 23588)\n+++ branches/SAMBA_3_0/source/smbd/files.c\t2007-06-22 17:19:08 UTC (rev 23589)\n@@ -439,6 +439,9 @@\n \t\tTALLOC_FREE(fsp->notify);\n \t}\n \n+\t/* Ensure this event will never fire. */\n+\tTALLOC_FREE(fsp->oplock_timeout);\n+\n \tbitmap_clear(file_bmap, fsp->fnum - FILE_HANDLE_OFFSET);\n \tfiles_used--;\n \n\nModified: branches/SAMBA_3_0/source/smbd/oplock.c\n===================================================================\n--- branches/SAMBA_3_0/source/smbd/oplock.c\t2007-06-22 14:54:39 UTC (rev 23588)\n+++ branches/SAMBA_3_0/source/smbd/oplock.c\t2007-06-22 17:19:08 UTC (rev 23589)\n@@ -152,6 +152,8 @@\n \tfsp->sent_oplock_break = NO_BREAK_SENT;\n \t\n \tflush_write_cache(fsp, OPLOCK_RELEASE_FLUSH);\n+\n+\tTALLOC_FREE(fsp->oplock_timeout);\n }\n \n /****************************************************************************\n@@ -341,12 +343,8 @@\n {\n \tfiles_struct *fsp = (files_struct *)private_data;\n \n-\t/* Ensure we always remove this event. */\n-\tif (fsp->oplock_timeout != NULL) {\n-\t\t/* Remove the timed event handler. */\n-\t\tTALLOC_FREE(fsp->oplock_timeout);\n-\t\tfsp->oplock_timeout = NULL;\n-\t}\n+\t/* Remove the timed event handler. */\n+\tTALLOC_FREE(fsp->oplock_timeout);\n \tDEBUG(0, (\"Oplock break failed for file %s -- replying anyway\\n\", fsp->fsp_name));\n \tglobal_client_failed_oplock_break = True;\n \tremove_oplock(fsp);\n\nModified: branches/SAMBA_3_0_25/source/smbd/files.c\n===================================================================\n--- branches/SAMBA_3_0_25/source/smbd/files.c\t2007-06-22 14:54:39 UTC (rev 23588)\n+++ branches/SAMBA_3_0_25/source/smbd/files.c\t2007-06-22 17:19:08 UTC (rev 23589)\n@@ -444,6 +444,9 @@\n \t\tTALLOC_FREE(fsp->notify);\n \t}\n \n+\t/* Ensure this event will never fire. */\n+\tTALLOC_FREE(fsp->oplock_timeout);\n+\n \tbitmap_clear(file_bmap, fsp->fnum - FILE_HANDLE_OFFSET);\n \tfiles_used--;\n \n\nModified: branches/SAMBA_3_0_25/source/smbd/oplock.c\n===================================================================\n--- branches/SAMBA_3_0_25/source/smbd/oplock.c\t2007-06-22 14:54:39 UTC (rev 23588)\n+++ branches/SAMBA_3_0_25/source/smbd/oplock.c\t2007-06-22 17:19:08 UTC (rev 23589)\n@@ -153,6 +153,8 @@\n \tfsp->sent_oplock_break = NO_BREAK_SENT;\n \t\n \tflush_write_cache(fsp, OPLOCK_RELEASE_FLUSH);\n+\n+\tTALLOC_FREE(fsp->oplock_timeout);\n }\n \n /****************************************************************************\n@@ -349,12 +351,8 @@\n {\n \tfiles_struct *fsp = (files_struct *)private_data;\n \n-\t/* Ensure we always remove this event. */\n-\tif (fsp->oplock_timeout != NULL) {\n-\t\t/* Remove the timed event handler. */\n-\t\tTALLOC_FREE(fsp->oplock_timeout);\n-\t\tfsp->oplock_timeout = NULL;\n-\t}\n+\t/* Remove the timed event handler. */\n+\tTALLOC_FREE(fsp->oplock_timeout);\n \tDEBUG(0, (\"Oplock break failed for file %s -- replying anyway\\n\", fsp->fsp_name));\n \tglobal_client_failed_oplock_break = True;\n \tremove_oplock(fsp);\n\nModified: branches/SAMBA_3_0_26/source/smbd/files.c\n===================================================================\n--- branches/SAMBA_3_0_26/source/smbd/files.c\t2007-06-22 14:54:39 UTC (rev 23588)\n+++ branches/SAMBA_3_0_26/source/smbd/files.c\t2007-06-22 17:19:08 UTC (rev 23589)\n@@ -439,6 +439,9 @@\n \t\tTALLOC_FREE(fsp->notify);\n \t}\n \n+\t/* Ensure this event will never fire. */\n+\tTALLOC_FREE(fsp->oplock_timeout);\n+\n \tbitmap_clear(file_bmap, fsp->fnum - FILE_HANDLE_OFFSET);\n \tfiles_used--;\n \n\nModified: branches/SAMBA_3_0_26/source/smbd/oplock.c\n===================================================================\n--- branches/SAMBA_3_0_26/source/smbd/oplock.c\t2007-06-22 14:54:39 UTC (rev 23588)\n+++ branches/SAMBA_3_0_26/source/smbd/oplock.c\t2007-06-22 17:19:08 UTC (rev 23589)\n@@ -152,6 +152,8 @@\n \tfsp->sent_oplock_break = NO_BREAK_SENT;\n \t\n \tflush_write_cache(fsp, OPLOCK_RELEASE_FLUSH);\n+\n+\tTALLOC_FREE(fsp->oplock_timeout);\n }\n \n /****************************************************************************\n@@ -341,12 +343,8 @@\n {\n \tfiles_struct *fsp = (files_struct *)private_data;\n \n-\t/* Ensure we always remove this event. */\n-\tif (fsp->oplock_timeout != NULL) {\n-\t\t/* Remove the timed event handler. */\n-\t\tTALLOC_FREE(fsp->oplock_timeout);\n-\t\tfsp->oplock_timeout = NULL;\n-\t}\n+\t/* Remove the timed event handler. */\n+\tTALLOC_FREE(fsp->oplock_timeout);\n \tDEBUG(0, (\"Oplock break failed for file %s -- replying anyway\\n\", fsp->fsp_name));\n \tglobal_client_failed_oplock_break = True;\n \tremove_oplock(fsp);\n\n"}