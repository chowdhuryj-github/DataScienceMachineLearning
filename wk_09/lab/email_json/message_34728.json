{"category": "ham", "to_address": "samba-cvs@samba.org", "from_address": "tridge@samba.org", "subject": "svn commit: samba r23090 - in\n\tbranches/SAMBA_4_0/source/torture/rpc: .", "body": "Author: tridge\nDate: 2007-05-23 07:44:51 +0000 (Wed, 23 May 2007)\nNew Revision: 23090\n\nWebSVN: http://websvn.samba.org/cgi-bin/viewcvs.cgi?view=rev&root=samba&rev=23090\n\nLog:\n\na test showing two netlogon pipes open at once, using the LogonEx ops\n\nModified:\n   branches/SAMBA_4_0/source/torture/rpc/rpc.c\n   branches/SAMBA_4_0/source/torture/rpc/schannel.c\n\n\nChangeset:\nModified: branches/SAMBA_4_0/source/torture/rpc/rpc.c\n===================================================================\n--- branches/SAMBA_4_0/source/torture/rpc/rpc.c\t2007-05-23 02:41:31 UTC (rev 23089)\n+++ branches/SAMBA_4_0/source/torture/rpc/rpc.c\t2007-05-23 07:44:51 UTC (rev 23090)\n@@ -183,6 +183,7 @@\n \ttorture_suite_add_simple_test(suite, \"SAMLOGON\", torture_rpc_samlogon);\n \ttorture_suite_add_simple_test(suite, \"SAMSYNC\", torture_rpc_samsync);\n \ttorture_suite_add_simple_test(suite, \"SCHANNEL\", torture_rpc_schannel);\n+\ttorture_suite_add_simple_test(suite, \"SCHANNEL2\", torture_rpc_schannel2);\n \ttorture_suite_add_simple_test(suite, \"SRVSVC\", torture_rpc_srvsvc);\n \ttorture_suite_add_simple_test(suite, \"SVCCTL\", torture_rpc_svcctl);\n \ttorture_suite_add_simple_test(suite, \"EPMAPPER\", torture_rpc_epmapper);\n\nModified: branches/SAMBA_4_0/source/torture/rpc/schannel.c\n===================================================================\n--- branches/SAMBA_4_0/source/torture/rpc/schannel.c\t2007-05-23 02:41:31 UTC (rev 23089)\n+++ branches/SAMBA_4_0/source/torture/rpc/schannel.c\t2007-05-23 07:44:51 UTC (rev 23090)\n@@ -30,6 +30,7 @@\n #include \"auth/gensec/schannel_proto.h\"\n #include \"libcli/auth/libcli_auth.h\"\n #include \"libcli/security/security.h\"\n+#include \"system/filesys.h\"\n \n #define TEST_MACHINE_NAME \"schannel\"\n \n@@ -446,6 +447,8 @@\n \treturn False;\t\n }\n \n+\n+\n /*\n   a schannel test suite\n  */\n@@ -485,3 +488,95 @@\n \n \treturn ret;\n }\n+\n+/*\n+  test two schannel connections\n+ */\n+BOOL torture_rpc_schannel2(struct torture_context *torture)\n+{\n+\tBOOL ret = True;\n+\tTALLOC_CTX *mem_ctx = talloc_new(torture);\n+\tstruct test_join *join_ctx;\n+\tNTSTATUS status;\n+\tconst char *binding = lp_parm_string(-1, \"torture\", \"binding\");\n+\tstruct dcerpc_binding *b;\n+\tstruct dcerpc_pipe *p1 = NULL, *p2 = NULL;\n+\tstruct cli_credentials *credentials1, *credentials2;\n+\tuint16_t acct_flags = ACB_WSTRUST;\n+\tuint32_t dcerpc_flags = DCERPC_SCHANNEL | DCERPC_SIGN;\n+\tTALLOC_CTX *test_ctx = talloc_named(mem_ctx, 0, \"test_schannel2 context\");\n+\n+\tjoin_ctx = torture_join_domain(talloc_asprintf(mem_ctx, \"%s2\", TEST_MACHINE_NAME), \n+\t\t\t\t       acct_flags, &credentials1);\n+\tif (!join_ctx) {\n+\t\tprintf(\"Failed to join domain with acct_flags=0x%x\\n\", acct_flags);\n+\t\ttalloc_free(test_ctx);\n+\t\treturn False;\n+\t}\n+\n+\tcredentials2 = talloc_memdup(mem_ctx, credentials1, sizeof(*credentials1));\n+\tcredentials1->netlogon_creds = NULL;\n+\tcredentials2->netlogon_creds = NULL;\n+\n+\tstatus = dcerpc_parse_binding(test_ctx, binding, &b);\n+\tif (!NT_STATUS_IS_OK(status)) {\n+\t\tprintf(\"Bad binding string %s\\n\", binding);\n+\t\tgoto failed;\n+\t}\n+\n+\tb->flags &= ~DCERPC_AUTH_OPTIONS;\n+\tb->flags |= dcerpc_flags;\n+\n+\tprintf(\"Opening first connection\\n\");\n+\tstatus = dcerpc_pipe_connect_b(test_ctx, &p1, b, &dcerpc_table_netlogon,\n+\t\t\t\t       credentials1, NULL);\n+\tif (!NT_STATUS_IS_OK(status)) {\n+\t\tprintf(\"Failed to connect with schannel: %s\\n\", nt_errstr(status));\n+\t\tgoto failed;\n+\t}\n+\n+\tprintf(\"Opening second connection\\n\");\n+\tstatus = dcerpc_pipe_connect_b(test_ctx, &p2, b, &dcerpc_table_netlogon,\n+\t\t\t\t       credentials2, NULL);\n+\tif (!NT_STATUS_IS_OK(status)) {\n+\t\tprintf(\"Failed to connect with schannel: %s\\n\", nt_errstr(status));\n+\t\tgoto failed;\n+\t}\n+\n+\tcredentials1->netlogon_creds = NULL;\n+\tcredentials2->netlogon_creds = NULL;\n+\n+\tprintf(\"Testing logon on pipe1\\n\");\n+\tif (!test_netlogon_ex_ops(p1, test_ctx, credentials1, NULL)) {\n+\t\tprintf(\"Failed to process schannel secured NETLOGON ops\\n\");\n+\t\tret = False;\n+\t}\n+\n+\tprintf(\"Testing logon on pipe2\\n\");\n+\tif (!test_netlogon_ex_ops(p2, test_ctx, credentials2, NULL)) {\n+\t\tprintf(\"Failed to process schannel secured NETLOGON ops\\n\");\n+\t\tret = False;\n+\t}\n+\n+\tprintf(\"Again on pipe1\\n\");\n+\tif (!test_netlogon_ex_ops(p1, test_ctx, credentials1, NULL)) {\n+\t\tprintf(\"Failed to process schannel secured NETLOGON ops\\n\");\n+\t\tret = False;\n+\t}\n+\n+\tprintf(\"Again on pipe2\\n\");\n+\tif (!test_netlogon_ex_ops(p2, test_ctx, credentials2, NULL)) {\n+\t\tprintf(\"Failed to process schannel secured NETLOGON ops\\n\");\n+\t\tret = False;\n+\t}\n+\n+\ttorture_leave_domain(join_ctx);\n+\ttalloc_free(test_ctx);\n+\treturn ret;\n+\n+failed:\n+\ttorture_leave_domain(join_ctx);\n+\ttalloc_free(test_ctx);\n+\treturn False;\t\n+}\n+\n\n"}