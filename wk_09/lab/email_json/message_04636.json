{"category": "ham", "to_address": "samba-cvs@samba.org", "from_address": "Michael Adam <ma@sernet.de>", "subject": "Rev 5355: Initial step towards activation of registry globals in\n\tloadparm.c in http://samba.sernet.de/ma/bzr/SAMBA_3_0-registry.bzr/", "body": "At http://samba.sernet.de/ma/bzr/SAMBA_3_0-registry.bzr/\n\n------------------------------------------------------------\nrevno: 5355\nrevision-id: ma@sernet.de-20070413160033-9f9bd35f13e4cf77\nparent: ma@sernet.de-20070413155735-bcd3cd2c2e57f281\ncommitter: Michael Adam \nbranch nick: SAMBA_3_0-registry.bzr\ntimestamp: Fri 2007-04-13 18:00:33 +0200\nmessage:\n  Initial step towards activation of registry globals in loadparm.c\n  via special semantics of \"include = registry\". It compiles but\n  it is not yet functional. Wanted to get into bzr before leaving for\n  the weekend. \n  \n  The patch to Makefile.in is especially ugly. This is why:\n  \n  It is impossible to just add the registry objects and all dependent\n  stuff to PARAM_OBJ, since virtually every target binary has its own\n  subset of the dependent objects already in its _OBJ list. So for\n  each target, the _OBJ list has to be adapted individually. What I\n  did is rename PARAM_OBJ to PARAM_OBJ1, use this for smbd (which has\n  all the registry and dependent stuff anyways) and define PARAM_OBJ\n  as PARAM_OBJ1 plus REG_API_OBJ (the objects currently needed for the\n  registry api needed for KEY_SMBCONF). Most of the build targets that\n  use PARAM_OBJ, had to be adapted slightly.\n  \n  This way, I hope to have kept the patch as small as possible,\n  and make a future adaption for a refactoring of the registry\n  api to minimize the linker deps more drastically easy. \n  \n  The plan is to further isolate the tdb-layer of the registry \n  and untangle it from the printing and eventlog code.\n  \n  (I have to admit that I have intermingled some slight reformattings\n  with my additions - some line breaks.)\nmodified:\n  source/Makefile.in             Makefile.in-20060530022626-b16dac2328ebe703\n  source/param/loadparm.c        loadparm.c-20060530022627-1efa1edb3eb0e897\n=== modified file 'source/Makefile.in'\n--- a/source/Makefile.in\t2007-04-12 14:14:00 +0000\n+++ b/source/Makefile.in\t2007-04-13 16:00:33 +0000\n@@ -281,7 +281,9 @@\n # Be sure to include them into your application\n POPT_LIB_OBJ = lib/popt_common.o\n \n-PARAM_OBJ = dynconfig.o param/loadparm.o param/params.o lib/sharesec.o\n+PARAM_OBJ1 = dynconfig.o param/loadparm.o param/params.o lib/sharesec.o \n+\n+PARAM_OBJ = $(PARAM_OBJ1) $(REG_API_OBJ)\n \n KRBCLIENT_OBJ = libads/kerberos.o libads/ads_status.o\n \n@@ -413,10 +415,15 @@\n \n PROFILE_OBJ = profile/profile.o\n PROFILES_OBJ = utils/profiles.o \\\n-               $(REGFIO_OBJ) $(REGOBJS_OBJ) $(ERRORMAP_OBJ) \\\n+               $(REGFIO_OBJ) \\\n+\t       $(ERRORMAP_OBJ) \\\n \t       $(RPC_PARSE_OBJ1) $(PARAM_OBJ) $(LIBSAMBA_OBJ) \\\n                $(DOSERR_OBJ) $(LIB_OBJ) $(LIB_DUMMY_OBJ) \\\n-               $(POPT_LIB_OBJ) $(SECRETS_OBJ)\n+               $(POPT_LIB_OBJ) $(SECRETS_OBJ) \\\n+\t       $(REG_API_ADD_OBJ)\n+\n+# removed from PROFILES_OBJ upon adding REG_API_OBJ to PARAM_OBJ:\n+#\t       $(REGOBJS_OBJ) \\\n \n OPLOCK_OBJ = smbd/oplock.o smbd/oplock_irix.o smbd/oplock_linux.o\n \n@@ -494,7 +501,7 @@\n \t       $(AFS_SETTOKEN_OBJ) smbd/aio.o smbd/statvfs.o \\\n \t       smbd/dmapi.o $(MANGLE_OBJ) @VFS_STATIC@\n \n-SMBD_OBJ_BASE = $(PARAM_OBJ) $(SMBD_OBJ_SRV) $(LIBSMB_OBJ) \\\n+SMBD_OBJ_BASE = $(PARAM_OBJ1) $(SMBD_OBJ_SRV) $(LIBSMB_OBJ) \\\n \t\t$(RPC_SERVER_OBJ) $(RPC_PARSE_OBJ) $(SECRETS_OBJ) \\\n \t\t$(LOCKING_OBJ) $(PASSDB_OBJ) $(PRINTING_OBJ) $(PROFILE_OBJ) \\\n \t\t$(LIB_OBJ) $(PRINTBACKEND_OBJ) $(OPLOCK_OBJ) \\\n@@ -526,8 +533,11 @@\n             nmbd/nmbd_subnetdb.o nmbd/nmbd_winsproxy.o nmbd/nmbd_winsserver.o \\\n             nmbd/nmbd_workgroupdb.o nmbd/nmbd_synclists.o\n \n+NMBD_OBJ2 = $(REG_API_ADD_OBJ)\n+\n NMBD_OBJ = $(NMBD_OBJ1) $(PARAM_OBJ) $(LIBSMB_OBJ) $(KRBCLIENT_OBJ) \\\n-           $(PROFILE_OBJ) $(LIB_NONSMBD_OBJ) $(SECRETS_OBJ) $(POPT_LIB_OBJ)\n+           $(PROFILE_OBJ) $(LIB_NONSMBD_OBJ) $(SECRETS_OBJ) $(POPT_LIB_OBJ) \\\n+\t   $(NMBD_OBJ2)\n \n SWAT_OBJ1 = web/cgi.o web/diagnose.o web/startstop.o web/statuspage.o \\\n            web/swat.o web/neg_lang.o\n@@ -542,36 +552,45 @@\n \t     $(LOCKING_OBJ) $(PARAM_OBJ) \\\n              $(PROFILE_OBJ) $(LIB_NONSMBD_OBJ) $(POPT_LIB_OBJ) \\\n \t     $(SECRETS_OBJ) $(LIBSAMBA_OBJ) $(ERRORMAP_OBJ) $(RPC_PARSE_OBJ1) \\\n-             $(DOSERR_OBJ)\n+             $(DOSERR_OBJ) \\\n+\t     $(REG_API_ADD_OBJ)\n \n SMBCONTROL_OBJ = utils/smbcontrol.o $(LOCKING_OBJ) $(PARAM_OBJ) \\\n \t$(PROFILE_OBJ) $(LIB_NONSMBD_OBJ) $(POPT_LIB_OBJ) \\\n \t$(SECRETS_OBJ) $(LIBSAMBA_OBJ) $(RPC_PARSE_OBJ1) $(DOSERR_OBJ) \\\n-\t$(PRINTBASE_OBJ) $(ERRORMAP_OBJ)\n+\t$(PRINTBASE_OBJ) $(ERRORMAP_OBJ) \\\n+\t$(REG_API_ADD_OBJ)\n \n SMBTREE_OBJ = utils/smbtree.o $(PARAM_OBJ) \\\n              $(PROFILE_OBJ) $(LIB_NONSMBD_OBJ) $(LIBSMB_OBJ) \\\n \t     $(KRBCLIENT_OBJ) $(POPT_LIB_OBJ) $(SECRETS_OBJ) \\\n-             rpc_client/cli_pipe.o $(RPC_PARSE_OBJ2) \\\n+             rpc_client/cli_pipe.o \\\n              $(RPC_CLIENT_OBJ1) \\\n \t     $(PASSDB_OBJ) $(SMBLDAP_OBJ) $(LDB_OBJ) $(GROUPDB_OBJ) \\\n-             $(LIBMSRPC_GEN_OBJ)\n+             $(LIBMSRPC_GEN_OBJ) \\\n+\t     $(REG_API_ADD_OBJ2)\n+\n+# removed from SMBTREE_OBJ upon adding REG_API_OBJ to PARAM_OBJ:\n+#\t     $(RPC_PARSE_OBJ2) \\\n \n TESTPARM_OBJ = utils/testparm.o \\\n                $(PARAM_OBJ) $(LIB_NONSMBD_OBJ) $(POPT_LIB_OBJ) \\\n-\t       $(SECRETS_OBJ) $(LIBSAMBA_OBJ) $(RPC_PARSE_OBJ1) $(DOSERR_OBJ)\n+\t       $(SECRETS_OBJ) $(LIBSAMBA_OBJ) $(RPC_PARSE_OBJ1) $(DOSERR_OBJ) \\\n+\t       $(REG_API_ADD_OBJ) $(ERRORMAP_OBJ)\n \n PASSWD_UTIL_OBJ = utils/passwd_util.o\n \n SMBPASSWD_OBJ = utils/smbpasswd.o $(PASSWD_UTIL_OBJ) $(PASSCHANGE_OBJ) \\\n \t\t$(PARAM_OBJ) $(SECRETS_OBJ) $(LIBSMB_OBJ) $(PASSDB_OBJ) \\\n \t\t$(GROUPDB_OBJ) $(LIB_NONSMBD_OBJ) $(KRBCLIENT_OBJ) \\\n-\t\t$(POPT_LIB_OBJ) $(SMBLDAP_OBJ) $(RPC_PARSE_OBJ) $(LIBMSRPC_GEN_OBJ) $(LIBMSRPC_OBJ) $(LDB_OBJ)\n+\t\t$(POPT_LIB_OBJ) $(SMBLDAP_OBJ) $(RPC_PARSE_OBJ) \\\n+\t\t$(LIBMSRPC_GEN_OBJ) $(LIBMSRPC_OBJ) $(LDB_OBJ)\n \n PDBEDIT_OBJ = utils/pdbedit.o $(PASSWD_UTIL_OBJ) $(PARAM_OBJ) $(PASSDB_OBJ) \\\n \t\t$(LIBSAMBA_OBJ) $(LIB_NONSMBD_OBJ) $(GROUPDB_OBJ) \\\n \t\t$(SECRETS_OBJ) $(POPT_LIB_OBJ) $(SMBLDAP_OBJ) libsmb/asn1.o \\\n-\t\t$(RPC_PARSE_OBJ1) $(DOSERR_OBJ) $(LDB_OBJ) libsmb/errormap.o\n+\t\t$(RPC_PARSE_OBJ1) $(DOSERR_OBJ) $(LDB_OBJ) $(ERRORMAP_OBJ) \\\n+\t\t$(REG_API_ADD_OBJ2)\n \n SMBGET_OBJ = utils/smbget.o $(POPT_LIB_OBJ) $(LIBSMBCLIENT_OBJ)\n \n@@ -600,7 +619,8 @@\n \t\t   $(PARAM_OBJ) $(LIB_NONSMBD_OBJ) \\\n \t  \t   $(LIBSMB_OBJ) $(KRBCLIENT_OBJ) \\\n \t\t   $(LIBMSRPC_OBJ) $(LIBMSRPC_GEN_OBJ) $(RPC_PARSE_OBJ) \\\n-\t\t   $(SECRETS_OBJ) $(PASSDB_OBJ) $(SMBLDAP_OBJ) $(GROUPDB_OBJ) $(LDB_OBJ)\n+\t\t   $(SECRETS_OBJ) $(PASSDB_OBJ) $(SMBLDAP_OBJ) \\\n+\t\t   $(GROUPDB_OBJ) $(LDB_OBJ)\n \n CAC_OBJ = $(LIBSMBCLIENT_OBJ) \\\n \t\t\t libmsrpc/libmsrpc.o libmsrpc/libmsrpc_internal.o \\\n@@ -621,19 +641,57 @@\n \n CLIENT_OBJ1 = client/client.o client/clitar.o rpc_client/cli_pipe.o \\\n \t      $(RPC_CLIENT_OBJ1) \\\n-\t      $(RPC_PARSE_OBJ2)\n+\t      \n+# removed from CLIENT_OBJ1 upon adding REG_API_OBJ to PARAM_OBJ:\n+#\t      $(RPC_PARSE_OBJ2)\n \n CLIENT_OBJ = $(CLIENT_OBJ1) $(PARAM_OBJ) $(LIBSMB_OBJ) \\\n \t     $(LIB_NONSMBD_OBJ) $(KRBCLIENT_OBJ) $(LIBMSRPC_GEN_OBJ) \\\n              $(READLINE_OBJ) $(POPT_LIB_OBJ) $(SECRETS_OBJ) \\\n              $(PASSDB_OBJ) $(SMBLDAP_OBJ) $(GROUPDB_OBJ) $(LDB_OBJ) \\\n-\t     $(DISPLAY_SEC_OBJ)\n+\t     $(DISPLAY_SEC_OBJ) \\\n+\t     $(REG_API_ADD_OBJ2)\n \n TOOL_OBJ = client/smbctool.o client/clitar.o $(PARAM_OBJ) $(LIBSMB_OBJ) \\\n \t     $(LIB_NONSMBD_OBJ) $(KRBCLIENT_OBJ) \\\n              $(READLINE_OBJ) $(POPT_LIB_OBJ) $(SECRETS_OBJ) \\\n \t     $(DISPLAY_SEC_OBJ)\n \n+REG_API_OBJ = registry/reg_api.o \\\n+\t      registry/reg_frontend_hilvl.o \\\n+\t      registry/reg_smbconf.o \\\n+\t      registry/reg_db.o \\\n+\t      registry/reg_util.o \\\n+\t      \\\n+\t      registry/reg_cachehook.o \\\n+\t      registry/reg_eventlog.o \\\n+\t      registry/reg_perfcount.o \\\n+\t      registry/reg_dynamic.o \\\n+\t      \\\n+\t      lib/util_nttoken.o\n+\n+REG_API_ADD_OBJ_UTOPIA = lib/privileges_basic.o\n+\n+REG_API_ADD_OBJ1 = \\\n+\t\t   $(PASSDB_OBJ) \\\n+\t\t   $(SMBLDAP_OBJ) \\\n+\t\t   $(GROUPDB_OBJ)\n+\n+REG_API_ADD_OBJ2 = \\\n+\t\t   $(RPC_PARSE_OBJ)\n+\n+REG_API_ADD_OBJ = \\\n+\t\t  $(REG_API_ADD_OBJ1) \\\n+\t\t  $(REG_API_ADD_OBJ2)\n+\n+\n+#\t      passdb/pdb_interface.o \\\n+#\t      passdb/passdb.o \\\n+#\t      passdb/pdb_get_set.o\n+#\t      $(REGOBJS_OBJ) \\\n+#\t      lib/util_reg.o \n+\n+\n NET_OBJ1 = utils/net.o utils/net_ads.o utils/net_domain.o utils/net_help.o \\\n \t   utils/net_rap.o utils/net_rpc.o utils/net_rpc_samsync.o \\\n \t   utils/net_rpc_join.o utils/net_time.o utils/net_lookup.o \\\n@@ -645,19 +703,6 @@\n \t   $(PASSWD_UTIL_OBJ) utils/net_dns.o utils/net_ads_gpo.o \\\n \t   utils/net_conf.o\n \n-NET_REG_OBJ = registry/reg_api.o \\\n-\t      registry/reg_frontend_hilvl.o \\\n-\t      registry/reg_smbconf.o \\\n-\t      registry/reg_db.o \\\n-\t      registry/reg_util.o \\\n-\t      \\\n-\t      registry/reg_cachehook.o \\\n-\t      registry/reg_eventlog.o \\\n-\t      registry/reg_perfcount.o \\\n-\t      registry/reg_dynamic.o \\\n-\t      \\\n-\t      lib/util_nttoken.o\n-  \n NET_OBJ = $(NET_OBJ1) $(PARAM_OBJ) $(SECRETS_OBJ) $(LIBSMB_OBJ) \\\n \t  $(RPC_PARSE_OBJ) $(PASSDB_OBJ) $(GROUPDB_OBJ) \\\n \t  $(KRBCLIENT_OBJ) $(LIB_NONSMBD_OBJ) $(LIBADDNS_OBJ0) \\\n@@ -665,11 +710,11 @@\n \t  $(LIBADS_OBJ) $(LIBADS_SERVER_OBJ) $(POPT_LIB_OBJ) \\\n \t  $(SMBLDAP_OBJ) $(DCUTIL_OBJ) $(SERVER_MUTEX_OBJ) \\\n \t  $(AFS_OBJ) $(AFS_SETTOKEN_OBJ) $(REGFIO_OBJ) $(READLINE_OBJ) \\\n-\t  $(LDB_OBJ) $(LIBGPO_OBJ) $(INIPARSER_OBJ) $(DISPLAY_SEC_OBJ) \\\n-\t  $(NET_REG_OBJ)\n+\t  $(LDB_OBJ) $(LIBGPO_OBJ) $(INIPARSER_OBJ) $(DISPLAY_SEC_OBJ) \n \n CUPS_OBJ = client/smbspool.o $(PARAM_OBJ) $(LIBSMB_OBJ) \\\n-\t  $(LIB_NONSMBD_OBJ) $(KRBCLIENT_OBJ) $(SECRETS_OBJ)\n+\t  $(LIB_NONSMBD_OBJ) $(KRBCLIENT_OBJ) $(SECRETS_OBJ) \\\n+\t  $(REG_API_ADD_OBJ)\n \n MOUNT_OBJ = client/smbmount.o \\\n              $(PARAM_OBJ) $(LIBSMB_OBJ) $(KRBCLIENT_OBJ) $(LIB_NONSMBD_OBJ) $(SECRETS_OBJ)\n@@ -682,30 +727,40 @@\n \n CIFS_UMOUNT_OBJ = client/umount.cifs.o\n \n-NMBLOOKUP_OBJ = utils/nmblookup.o $(PARAM_OBJ) $(LIBNMB_OBJ) $(RPC_PARSE_OBJ1) $(DOSERR_OBJ) \\\n-               $(LIB_NONSMBD_OBJ) $(POPT_LIB_OBJ) $(SECRETS_OBJ) $(LIBSAMBA_OBJ)\n+NMBLOOKUP_OBJ = utils/nmblookup.o $(PARAM_OBJ) $(LIBNMB_OBJ) \\\n+\t\t$(RPC_PARSE_OBJ1) \\\n+\t\t$(DOSERR_OBJ) \\\n+                $(LIB_NONSMBD_OBJ) $(POPT_LIB_OBJ) $(SECRETS_OBJ) \\\n+\t\t$(LIBSAMBA_OBJ) \\\n+\t\t$(REG_API_ADD_OBJ) $(ERRORMAP_OBJ)\n \n SMBTORTURE_OBJ1 = torture/torture.o torture/nbio.o torture/scanner.o torture/utable.o \\\n \t\ttorture/denytest.o torture/mangle_test.o\n \n SMBTORTURE_OBJ = $(SMBTORTURE_OBJ1) $(PARAM_OBJ) \\\n-\t$(LIBSMB_OBJ) $(KRBCLIENT_OBJ) $(LIB_NONSMBD_OBJ) $(SECRETS_OBJ)\n+\t$(LIBSMB_OBJ) $(KRBCLIENT_OBJ) $(LIB_NONSMBD_OBJ) $(SECRETS_OBJ) \\\n+\t$(REG_API_ADD_OBJ)\n \n MASKTEST_OBJ = torture/masktest.o $(PARAM_OBJ) $(LIBSMB_OBJ) $(KRBCLIENT_OBJ) \\\n-                 $(LIB_NONSMBD_OBJ) $(SECRETS_OBJ)\n+                 $(LIB_NONSMBD_OBJ) $(SECRETS_OBJ) \\\n+\t\t $(REG_API_ADD_OBJ)\n \n MSGTEST_OBJ = torture/msgtest.o $(PARAM_OBJ) $(LIBSMB_OBJ) $(KRBCLIENT_OBJ) \\\n-                 $(LIB_NONSMBD_OBJ) $(SECRETS_OBJ)\n+                 $(LIB_NONSMBD_OBJ) $(SECRETS_OBJ) \\\n+\t\t $(REG_API_ADD_OBJ)\n \n LOCKTEST_OBJ = torture/locktest.o $(PARAM_OBJ) $(LOCKING_OBJ) $(KRBCLIENT_OBJ) \\\n-               $(LIBSMB_OBJ) $(LIB_NONSMBD_OBJ) $(SECRETS_OBJ)\n+               $(LIBSMB_OBJ) $(LIB_NONSMBD_OBJ) $(SECRETS_OBJ) \\\n+\t       $(REG_API_ADD_OBJ)\n \n NSSTEST_OBJ = torture/nsstest.o $(PARAM_OBJ) $(LIBSMB_OBJ) $(KRBCLIENT_OBJ) \\\n-                 $(LIB_NONSMBD_OBJ) $(SECRETS_OBJ)\n+                 $(LIB_NONSMBD_OBJ) $(SECRETS_OBJ) \\\n+\t\t $(REG_API_ADD_OBJ)\n \n PDBTEST_OBJ = torture/pdbtest.o $(PARAM_OBJ) $(LIBSMB_OBJ) $(KRBCLIENT_OBJ) \\\n \t\t$(LIB_NONSMBD_OBJ) $(SECRETS_OBJ) $(PASSDB_OBJ) $(GROUPDB_OBJ) \\\n-\t\t$(SMBLDAP_OBJ) $(POPT_LIB_OBJ) $(LDB_OBJ)\n+\t\t$(SMBLDAP_OBJ) $(POPT_LIB_OBJ) $(LDB_OBJ) \\\n+\t\t$(REG_API_ADD_OBJ2)\n \n \n VFSTEST_OBJ = torture/cmd_vfs.o torture/vfstest.o $(SMBD_OBJ_BASE) $(READLINE_OBJ)\n@@ -715,7 +770,8 @@\n LOG2PCAP_OBJ = utils/log2pcaphex.o\n \n LOCKTEST2_OBJ = torture/locktest2.o $(PARAM_OBJ) $(LOCKING_OBJ) $(LIBSMB_OBJ) \\\n-\t\t$(KRBCLIENT_OBJ) $(LIB_NONSMBD_OBJ) $(SECRETS_OBJ)\n+\t\t$(KRBCLIENT_OBJ) $(LIB_NONSMBD_OBJ) $(SECRETS_OBJ) \\\n+\t\t$(REG_API_ADD_OBJ)\n \n SMBCACLS_OBJ = utils/smbcacls.o $(PARAM_OBJ) $(LIBSMB_OBJ) \\\n \t\t\t   $(KRBCLIENT_OBJ) $(LIB_NONSMBD_OBJ) $(RPC_PARSE_OBJ) \\\n@@ -730,19 +786,30 @@\n \n EVTLOGADM_OBJ0\t= utils/eventlogadm.o\n \n-EVTLOGADM_OBJ\t= $(EVTLOGADM_OBJ0) $(PARAM_OBJ) $(LIB_NONSMBD_OBJ) $(REGOBJS_OBJ) \\\n+EVTLOGADM_OBJ\t= $(EVTLOGADM_OBJ0) $(PARAM_OBJ) $(LIB_NONSMBD_OBJ) \\\n \t\t$(ERRORMAP_OBJ) $(RPC_PARSE_OBJ1) $(LIBSAMBA_OBJ) $(DOSERR_OBJ) \\\n \t\t$(SECRETS_OBJ) \\\n-\t        registry/reg_eventlog.o rpc_server/srv_eventlog_lib.o registry/reg_util.o \\\n-\t\tregistry/reg_db.o\n+\t\trpc_server/srv_eventlog_lib.o \\\n+\t\t$(REG_API_ADD_OBJ)\n+\n+# removed from EVENTLOGADM_OBJ upon adding REG_API_OBJ to PARAM_OBJ:\n+#\t\t  $(REGOBJS_OBJ) \\\n+#\t        registry/reg_eventlog.o \\\n+#\t\tregistry/reg_util.o \\\n+#\t\tregistry/reg_db.o\n \n SHARESEC_OBJ0 = utils/sharesec.o\n-SHARESEC_OBJ  = $(SHARESEC_OBJ0) $(PARAM_OBJ) $(LIB_NONSMBD_OBJ) $(REGOBJS_OBJ) \\\n+SHARESEC_OBJ  = $(SHARESEC_OBJ0) $(PARAM_OBJ) $(LIB_NONSMBD_OBJ) \\\n \t\t$(ERRORMAP_OBJ) $(RPC_PARSE_OBJ1) $(LIBSAMBA_OBJ) $(DOSERR_OBJ) \\\n-                $(POPT_LIB_OBJ) $(SECRETS_OBJ)\n+                $(POPT_LIB_OBJ) $(SECRETS_OBJ) \\\n+\t\t$(REG_API_ADD_OBJ)\n+\n+# removed from SHARESEC_OBJ upon adding REG_API_OBJ to PARAM_OBJ:\n+#\t\t$(REGOBJS_OBJ) \\\n \n TALLOCTORT_OBJ = lib/talloc/testsuite.o $(PARAM_OBJ) $(LIB_NONSMBD_OBJ) \\\n-                 $(RPC_PARSE_OBJ1) $(DOSERR_OBJ) $(LIBSAMBA_OBJ) $(SECRETS_OBJ)\n+                 $(RPC_PARSE_OBJ1) $(DOSERR_OBJ) $(LIBSAMBA_OBJ) $(SECRETS_OBJ) \\\n+\t\t $(REG_API_ADD_OBJ) $(ERRORMAP_OBJ)\n \n REPLACETORT_OBJ = lib/replace/test/testsuite.o lib/replace/test/os2_delete.o \\\n \t\t$(LIBREPLACE_OBJ)\n@@ -750,7 +817,8 @@\n NDRDUMP_OBJ = librpc/tools/ndrdump.o \\\n \t\t\t  $(PARAM_OBJ) $(LIBNDR_OBJ) $(LIBNDR_GEN_OBJ) \\\n \t\t\t  $(LIBSAMBA_OBJ) $(LIB_NONSMBD_OBJ) $(POPT_LIB_OBJ) \\\n-\t\t\t  $(RPC_PARSE_OBJ1) $(DOSERR_OBJ) $(SECRETS_OBJ)\n+\t\t\t  $(RPC_PARSE_OBJ1) $(DOSERR_OBJ) $(SECRETS_OBJ) \\\n+\t\t\t  $(REG_API_ADD_OBJ) $(ERRORMAP_OBJ)\n \n RPCTORTURE_OBJ = torture/rpctorture.o \\\n              rpcclient/display.o \\\n@@ -760,12 +828,18 @@\n              rpcclient/cmd_srvsvc.o \\\n              rpcclient/cmd_netlogon.o \\\n              $(PARAM_OBJ) $(LIBSMB_OBJ) $(LIB_NONSMBD_OBJ) $(KRBCLIENT_OBJ) \\\n-             $(RPC_CLIENT_OBJ) $(RPC_PARSE_OBJ) $(PASSDB_GET_SET_OBJ) $(SECRETS_OBJ)\n+             $(RPC_CLIENT_OBJ) \\\n+\t     $(PASSDB_GET_SET_OBJ) $(SECRETS_OBJ) \\\n+\t     $(REG_API_ADD_OBJ)\n+\n+# removed from RPCTORTURE_OBJ upon adding REG_API_OBJ to PARAM_OBJ:\n+#\t     $(RPC_PARSE_OBJ) \\\n \n DEBUG2HTML_OBJ = utils/debug2html.o utils/debugparse.o\n \n SMBFILTER_OBJ = utils/smbfilter.o $(PARAM_OBJ) $(LIBSMB_OBJ) $(SECRETS_OBJ) \\\n-                 $(LIB_NONSMBD_OBJ) $(KRBCLIENT_OBJ)\n+                 $(LIB_NONSMBD_OBJ) $(KRBCLIENT_OBJ) \\\n+\t\t $(REG_API_ADD_OBJ)\n \n PROTO_OBJ = $(SMBD_OBJ_MAIN) $(LIBNDR_OBJ) $(RPCCLIENT_NDR_OBJ) \\\n \t\t\t$(LIBNDR_GEN_OBJ) $(SMBD_OBJ_SRV) $(NMBD_OBJ1) $(LIBSMB_OBJ) \\\n@@ -832,7 +906,9 @@\n \t\t$(LIBADS_SERVER_OBJ) $(SERVER_MUTEX_OBJ) $(LDB_OBJ)\n \n WBINFO_OBJ = nsswitch/wbinfo.o $(LIBSAMBA_OBJ) $(PARAM_OBJ) $(LIB_NONSMBD_OBJ) \\\n-\t\t$(SECRETS_OBJ) $(POPT_LIB_OBJ) $(AFS_SETTOKEN_OBJ) $(RPC_PARSE_OBJ1) $(DOSERR_OBJ)\n+\t     $(SECRETS_OBJ) $(POPT_LIB_OBJ) $(AFS_SETTOKEN_OBJ) \\\n+\t     $(RPC_PARSE_OBJ1) $(DOSERR_OBJ) \\\n+\t     $(REG_API_ADD_OBJ) $(ERRORMAP_OBJ)\n \n WINBIND_NSS_OBJ = $(WBCOMMON_OBJ) $(LIBREPLACE_OBJ) $(SOCKET_WRAPPER_OBJ) @WINBIND_NSS_EXTRA_OBJS@\n \n@@ -900,8 +976,14 @@\n \t\tlibsmb/asn1.o libsmb/spnego.o libsmb/clikrb5.o libads/kerberos.o \\\n \t\tlibads/kerberos_verify.o $(SECRETS_OBJ) $(SERVER_MUTEX_OBJ) \\\n \t\tlibads/authdata.o $(RPC_PARSE_OBJ1) $(PASSDB_OBJ) $(GROUPDB_OBJ) \\\n-\t\t$(SMBLDAP_OBJ) $(DOSERR_OBJ) rpc_parse/parse_net.o $(LIBNMB_OBJ) \\\n-\t\t$(LDB_OBJ) libsmb/errormap.o\n+\t\t$(SMBLDAP_OBJ) $(DOSERR_OBJ) \\\n+\t\t$(LIBNMB_OBJ) \\\n+\t\t$(LDB_OBJ) $(ERRORMAP_OBJ) \\\n+\t\t$(PARAM_OBJ) \\\n+\t\t$(REG_API_ADD_OBJ2)\n+\n+# removed from NTLM_AUTH_OBJ upon adding REG_API_OBJ to PARAM_OBJ:\n+#\t\trpc_parse/parse_net.o \\\n \n ######################################################################\n # now the rules...\n@@ -1640,11 +1722,11 @@\n \t@echo Linking $@\n \t@$(CC) $(FLAGS) -o $@ $(LDFLAGS) $(WBINFO_OBJ) $(DYNEXP) $(LIBS) $(LDAP_LIBS) @POPTLIBS@\n \n-bin/ntlm_auth@EXEEXT@: proto_exists $(NTLM_AUTH_OBJ) $(PARAM_OBJ) $(LIB_NONSMBD_OBJ) \\\n+bin/ntlm_auth@EXEEXT@: proto_exists $(NTLM_AUTH_OBJ) $(LIB_NONSMBD_OBJ) \\\n \t\t@BUILD_POPT@ bin/.dummy\n \t@echo Linking $@\n \t@$(CC) $(FLAGS) -o $@ $(LDFLAGS) $(DYNEXP) $(NTLM_AUTH_OBJ) \\\n-\t\t$(PARAM_OBJ) $(LIB_NONSMBD_OBJ) $(LIBS) \\\n+\t\t$(LIB_NONSMBD_OBJ) $(LIBS) \\\n \t\t@POPTLIBS@ $(KRB5LIBS) $(LDAP_LIBS) $(NSCD_LIBS)\n \n bin/pam_smbpass.@SHLIBEXT@: $(PAM_SMBPASS_OBJ)\n\n=== modified file 'source/param/loadparm.c'\n--- a/source/param/loadparm.c\t2007-03-27 22:14:31 +0000\n+++ b/source/param/loadparm.c\t2007-04-13 16:00:33 +0000\n@@ -72,6 +72,14 @@\n #define HOMES_NAME \"homes\"\n #endif\n \n+/* the special value for the include parameter\n+ * to be interpreted not as a file name but to\n+ * trigger loading of the global smb.conf options\n+ * from registry. */\n+#ifndef INCLUDE_REGISTRY_NAME\n+#define INCLUDE_REGISTRY_NAME \"registry\"\n+#endif\n+\n /* some helpful bits */\n #define LP_SNUM_OK(i) (((i) >= 0) && ((i) < iNumServices) && (ServicePtrs != NULL) && ServicePtrs[(i)]->valid)\n #define VALID(i) (ServicePtrs != NULL && ServicePtrs[i]->valid)\n@@ -3167,6 +3175,60 @@\n \treturn set_netbios_aliases((const char **)Globals.szNetbiosAliases);\n }\n \n+static BOOL process_registry_globals(BOOL (*pfunc)(const char *, const char *))\n+{\n+\tBOOL ret = False;\n+\tTALLOC_CTX *ctx = NULL;\n+\tchar *regpath = NULL;\n+\tWERROR werr = WERR_OK;\n+\tstruct registry_key *key = NULL;\n+\tstruct registry_value *valvalue = NULL;\n+\tchar *valname = NULL;\n+\tuint32 idx = 0;\n+\tNT_USER_TOKEN *token;\n+\n+\tctx = talloc_init(\"process_registry_globals\");\n+\tif (!ctx) {\n+\t\tsmb_panic(\"Failed to create talloc context!\");\n+\t}\n+\n+\t/* It might not bee to clean to have the initialization here.\n+\t * If the registry is already initialized, it does not do\n+\t * any harm. */\n+\tif (!registry_init_regdb()) {\n+\t\tDEBUG(1, (\"Error initializing the registry.\\n\"));\n+\t\tgoto done;\n+\t}\n+\n+\tif (!(token = registry_create_admin_token(ctx))) {\n+\t\tDEBUG(1, (\"Error creating admin token\\n\"));\n+\t\tgoto done;\n+\t}\n+\n+\tregpath = talloc_asprintf(ctx,\"%s\\\\%s\", KEY_SMBCONF, GLOBAL_NAME);\n+\twerr = reg_open_path(ctx, regpath, REG_KEY_READ, token, &key);\n+\tif (!W_ERROR_IS_OK(werr)) {\n+\t\tDEBUG(1, (\"Registry smbconf global section does not exist.\\n\"));\n+\t\tDEBUGADD(1, (\"Error opening registry path '%s\\\\%s: %s\\n\",\n+\t\t\t     KEY_SMBCONF, GLOBAL_NAME, dos_errstr(werr)));\n+\t\tgoto done;\n+\t}\n+\n+\tfor (idx = 0;\n+\t     W_ERROR_IS_OK(werr = reg_enumvalue(ctx, key, idx, &valname,\n+\t\t\t     \t\t\t&valvalue));\n+\t     idx++)\n+\t{\n+\t\tDEBUG(1, (\"got global registry parameter '%s'\\n\", valname));\n+\t}\n+\n+\tret = pfunc(\"registry shares\", \"yes\");\n+\n+done:\n+\ttalloc_destroy(ctx);\n+\treturn ret;\n+}\n+\n /***************************************************************************\n  Handle the include operation.\n ***************************************************************************/\n@@ -3176,6 +3238,10 @@\n \tpstring fname;\n \tpstrcpy(fname, pszParmValue);\n \n+\tif (strequal(fname, INCLUDE_REGISTRY_NAME)) {\n+\t\treturn process_registry_globals(do_parameter);\n+\t}\n+\n \tstandard_sub_basic(get_current_username(), current_user_info.domain,\n \t\t\t   fname,sizeof(fname));\n \n\n"}