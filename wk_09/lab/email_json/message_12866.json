{"category": "ham", "to_address": "samba-cvs@samba.org", "from_address": "Jelmer Vernooij <jelmer@samba.org>", "subject": "Rev 11978: Merge upstream in\n\tfile:///home/jelmer/bzr.samba/SAMBA_4_0/", "body": "At file:///home/jelmer/bzr.samba/SAMBA_4_0/\n\n------------------------------------------------------------\nrevno: 11978\nrevision-id: jelmer@samba.org-20070422144758-6tv2j8v9d801i8wi\nparent: jelmer@samba.org-20070422144538-3ykcd0nnz71zguiu\nparent: svn-v2:22455@0c0555d6-39d7-0310-84fc-f1cc0bd64818-branches%2fSAMBA_4_0\ncommitter: Jelmer Vernooij \nbranch nick: SAMBA_4_0\ntimestamp: Sun 2007-04-22 16:47:58 +0200\nmessage:\n  Merge upstream\nmodified:\n  source/build/smb_build/input.pm svn-v2:3690@0c0555d6-39d7-0310-84fc-f1cc0bd64818-branches%2fSAMBA_4_0-source%2fbuild%2fsmb_build%2finput.pm\n  source/build/smb_build/output.pm svn-v2:3690@0c0555d6-39d7-0310-84fc-f1cc0bd64818-branches%2fSAMBA_4_0-source%2fbuild%2fsmb_build%2foutput.pm\n  source/heimdal_build/asn1_deps.pl svn-v2:8985@0c0555d6-39d7-0310-84fc-f1cc0bd64818-branches%2fSAMBA_4_0-source%2fheimdal_build%2fasn1_deps.pl\n  source/heimdal_build/config.mk svn-v2:7322@0c0555d6-39d7-0310-84fc-f1cc0bd64818-branches%2fSAMBA_4_0-source%2fheimdal_build%2fconfig.mk\n    ------------------------------------------------------------\n    revno: 11975.1.2\n    merged: svn-v2:22455@0c0555d6-39d7-0310-84fc-f1cc0bd64818-branches%2fSAMBA_4_0\n    parent: svn-v2:22454@0c0555d6-39d7-0310-84fc-f1cc0bd64818-branches%2fSAMBA_4_0\n    committer: metze\n    timestamp: Sun 2007-04-22 11:40:11 +0000\n    message:\n      split dependecies array for compiling and linking and use better names:-)\n      \n      calculate the CFLAGS only based on the public dependencies when recursing\n      \n      metze \n    ------------------------------------------------------------\n    revno: 11975.1.1\n    merged: svn-v2:22454@0c0555d6-39d7-0310-84fc-f1cc0bd64818-branches%2fSAMBA_4_0\n    parent: svn-v2:22453@0c0555d6-39d7-0310-84fc-f1cc0bd64818-branches%2fSAMBA_4_0\n    committer: metze\n    timestamp: Sun 2007-04-22 11:28:12 +0000\n    message:\n      - let asn1_deps.pl calculate the dependencies depending on the IMPORT line in the asn1 file\n      - fix some heimdal dependencies\n      \n      metze\n=== modified file 'source/build/smb_build/input.pm'\n--- a/source/build/smb_build/input.pm\t2006-11-06 20:17:25 +0000\n+++ b/source/build/smb_build/input.pm\t2007-04-22 11:40:11 +0000\n@@ -162,10 +162,10 @@\n \t}\n }\n \n-sub calc_unique_deps($$$$$$)\n+sub calc_unique_deps($$$$$$$$)\n {\n-\tsub calc_unique_deps($$$$$$);\n-\tmy ($name, $INPUT, $deps, $udeps, $withlibs, $busy) = @_;\n+\tsub calc_unique_deps($$$$$$$$);\n+\tmy ($name, $INPUT, $deps, $udeps, $withlibs, $forward, $pubonly, $busy) = @_;\n \n \tforeach my $n (@$deps) {\n \t\tdie(\"Dependency unknown: $n\") unless (defined($INPUT->{$n}));\n@@ -173,17 +173,19 @@\n \t\tnext if (grep /^$n$/, @$udeps);\n \t\tmy $dep = $INPUT->{$n};\n \n+\t\tpush (@{$udeps}, $dep->{NAME}) if $forward;\n+\n  \t\tif (defined ($dep->{OUTPUT_TYPE}) && \n \t\t\t($withlibs or \n \t\t\t(@{$dep->{OUTPUT_TYPE}}[0] eq \"INTEGRATED\") or \n \t\t\t(@{$dep->{OUTPUT_TYPE}}[0] eq \"STATIC_LIBRARY\"))) {\n \t\t\t\tpush (@$busy, $dep->{NAME});\n-\t\t\t        calc_unique_deps($dep->{NAME}, $INPUT, $dep->{PUBLIC_DEPENDENCIES}, $udeps, $withlibs, $busy);\n-\t\t\t        calc_unique_deps($dep->{NAME}, $INPUT, $dep->{PRIVATE_DEPENDENCIES}, $udeps, $withlibs, $busy);\n+\t\t\t        calc_unique_deps($dep->{NAME}, $INPUT, $dep->{PUBLIC_DEPENDENCIES}, $udeps, $withlibs, $forward, $pubonly, $busy);\n+\t\t\t        calc_unique_deps($dep->{NAME}, $INPUT, $dep->{PRIVATE_DEPENDENCIES}, $udeps, $withlibs, $forward, $pubonly, $busy) unless $pubonly;\n \t\t\t\tpop (@$busy);\n \t        }\n \n-\t\tunshift (@{$udeps}, $dep->{NAME});\n+\t\tunshift (@{$udeps}, $dep->{NAME}) unless $forward;\n \t}\n }\n \n@@ -242,15 +244,21 @@\n \t}\n \n \tforeach my $part (values %$INPUT) {\n-\t\t$part->{UNIQUE_DEPENDENCIES} = [];\n-\t\tcalc_unique_deps($part->{NAME}, $INPUT, $part->{PUBLIC_DEPENDENCIES}, $part->{UNIQUE_DEPENDENCIES}, 0, []);\n-\t\tcalc_unique_deps($part->{NAME}, $INPUT, $part->{PRIVATE_DEPENDENCIES}, $part->{UNIQUE_DEPENDENCIES}, 0, []);\n+\t\t$part->{UNIQUE_DEPENDENCIES_LINK} = [];\n+\t\tcalc_unique_deps($part->{NAME}, $INPUT, $part->{PUBLIC_DEPENDENCIES}, $part->{UNIQUE_DEPENDENCIES_LINK}, 0, 0, 0, []);\n+\t\tcalc_unique_deps($part->{NAME}, $INPUT, $part->{PRIVATE_DEPENDENCIES}, $part->{UNIQUE_DEPENDENCIES_LINK}, 0, 0, 0, []);\n+\t}\n+\n+\tforeach my $part (values %$INPUT) {\n+\t\t$part->{UNIQUE_DEPENDENCIES_COMPILE} = [];\n+\t\tcalc_unique_deps($part->{NAME}, $INPUT, $part->{PUBLIC_DEPENDENCIES}, $part->{UNIQUE_DEPENDENCIES_COMPILE}, 1, 1, 1, []);\n+\t\tcalc_unique_deps($part->{NAME}, $INPUT, $part->{PRIVATE_DEPENDENCIES}, $part->{UNIQUE_DEPENDENCIES_COMPILE}, 1, 1, 1, []);\n \t}\n \n \tforeach my $part (values %$INPUT) {\n \t\t$part->{UNIQUE_DEPENDENCIES_ALL} = [];\n-\t\tcalc_unique_deps($part->{NAME}, $INPUT, $part->{PUBLIC_DEPENDENCIES}, $part->{UNIQUE_DEPENDENCIES_ALL}, 1, []);\n-\t\tcalc_unique_deps($part->{NAME}, $INPUT, $part->{PRIVATE_DEPENDENCIES}, $part->{UNIQUE_DEPENDENCIES_ALL}, 1, []);\n+\t\tcalc_unique_deps($part->{NAME}, $INPUT, $part->{PUBLIC_DEPENDENCIES}, $part->{UNIQUE_DEPENDENCIES_ALL}, 1, 0, 0, []);\n+\t\tcalc_unique_deps($part->{NAME}, $INPUT, $part->{PRIVATE_DEPENDENCIES}, $part->{UNIQUE_DEPENDENCIES_ALL}, 1, 0, 0, []);\n \t}\n \n \treturn $INPUT;\n\n=== modified file 'source/build/smb_build/output.pm'\n--- a/source/build/smb_build/output.pm\t2007-04-02 17:14:43 +0000\n+++ b/source/build/smb_build/output.pm\t2007-04-22 11:40:11 +0000\n@@ -148,7 +148,7 @@\n \t\tmerge_array(\\$part->{FINAL_CFLAGS}, $part->{CPPFLAGS});\n \t\tmerge_array(\\$part->{FINAL_CFLAGS}, $part->{CFLAGS});\n \n-\t\tforeach (reverse @{$part->{UNIQUE_DEPENDENCIES_ALL}}) {\n+\t\tforeach (@{$part->{UNIQUE_DEPENDENCIES_COMPILE}}) {\n \t\t\tmy $elem = $depend->{$_};\n \t\t\tnext if $elem == $part;\n \n@@ -157,7 +157,7 @@\n \t\t}\n \n \t\t# Always import the link options of the unique dependencies\n-\t\tforeach (@{$part->{UNIQUE_DEPENDENCIES}}) {\n+\t\tforeach (@{$part->{UNIQUE_DEPENDENCIES_LINK}}) {\n \t\t\tmy $elem = $depend->{$_};\n \t\t\tnext if $elem == $part;\n \n\n=== modified file 'source/heimdal_build/asn1_deps.pl'\n--- a/source/heimdal_build/asn1_deps.pl\t2007-04-21 23:12:45 +0000\n+++ b/source/heimdal_build/asn1_deps.pl\t2007-04-22 11:28:12 +0000\n@@ -1,6 +1,7 @@\n #!/usr/bin/perl\n # Generate make dependency rules for asn1 files\n # Jelmer Vernooij  2005\n+# Stefan Metzmacher  2007\n # GPL\n \n use File::Basename;\n@@ -15,6 +16,10 @@\n my @c_files = ();\n my $o_file;\n my @o_files = ();\n+my $import;\n+my @imports = ();\n+my $dep;\n+my @deps = ();\n \n $basename = basename($file);\n if (not defined $options) {\n@@ -28,8 +33,10 @@\n print \"\\t\\@\\$(builddir)/heimdal_build/asn1_compile_wrapper.sh \\$(srcdir) \\$(builddir) $dirname bin/asn1_compile $file $prefix $options\\n\\n\";\n \n open(IN,$file) or die(\"Can't open $file: $!\");\n-foreach() {\n-\tif (/^([\\w]+[\\w\\-]+)(\\s+OBJECT IDENTIFIER)?\\s*::=/) {\n+my @lines = ;\n+close(IN);\n+foreach my $line (@lines) {\n+\tif ($line =~ /^([\\w]+[\\w\\-]+)(\\s+OBJECT IDENTIFIER)?\\s*::=/) {\n \t\tmy $output = $1;\n \t\t$output =~ s/-/_/g;\n \t\t$c_file = \"$dirname/asn1_$output.c\";\n@@ -41,9 +48,41 @@\n \t\tpush @x_files, $x_file;\n \t\tpush @c_files, $c_file;\n \t\tpush @o_files, $o_file;\n-\t}\n-}\n-close(IN);\n+\t} elsif ($line =~ /^(\\s*IMPORT)([\\w\\,\\s])*(\\s+FROM\\s+)([\\w]+[\\w\\-]+);/) {\n+\t\t$import = $line;\n+\t\tchomp $import;\n+\t\tpush @imports, $import;\n+\t\t$import = undef;\n+\t} elsif ($line =~ /^(\\s*IMPORT).*/) {\n+\t\t$import = $line;\n+\t\tchomp $import;\n+\t} elsif (defined($import) and ($line =~ /;/)) {\n+\t\t$import .= $line;\n+\t\tchomp $import;\n+\t\tpush @imports, $import;\n+\t\t$import = undef;\n+\t} elsif (defined($import)) {\n+\t\t$import .= $line;\n+\t\tchomp $import;\n+\t}\n+}\n+\n+foreach $import (@imports) {\n+\tnext unless ($import =~ /^(\\s*IMPORT)([\\w\\,\\s])*(\\s+FROM\\s+)([\\w]+[\\w\\-]+);/);\n+\n+\tmy @froms = split (/\\s+FROM\\s+/, $import);\n+\tforeach my $from (@froms) {\n+\t\tnext if ($from =~ /^(\\s*IMPORT).*/);\n+\t\tif ($from =~ /^(\\w+)/) {\n+\t\t\tmy $f = $1;\n+\t\t\t$dep = 'HEIMDAL_'.uc($f).'_ASN1';\n+\t\t\tpush @deps, $dep;\n+\t\t}\n+\t}\n+}\n+\n+unshift @deps, \"HEIMDAL_HEIM_ASN1\" unless grep /HEIMDAL_HEIM_ASN1/, @deps;\n+my $depstr = join(' ', @deps);\n \n print '[SUBSYSTEM::HEIMDAL_'.uc($prefix).']'.\"\\n\";\n print \"CFLAGS = -Iheimdal_build -Iheimdal/lib/roken -I$dirname\\n\";\n@@ -51,7 +90,7 @@\n foreach $o_file (@o_files) {\n     print \"\\\\\\n\\t$o_file\";\n }\n-print \"\\nPRIVATE_DEPENDENCIES = HEIMDAL_ASN1\\n\\n\";\n+print \"\\nPUBLIC_DEPENDENCIES = $depstr\\n\\n\";\n \n print \"clean:: \\n\";\n print \"\\t\\@echo \\\"Deleting ASN1 output files generated from $file\\\"\\n\";\n\n=== modified file 'source/heimdal_build/config.mk'\n--- a/source/heimdal_build/config.mk\t2007-04-22 00:21:14 +0000\n+++ b/source/heimdal_build/config.mk\t2007-04-22 11:28:12 +0000\n@@ -17,7 +17,8 @@\n \t../heimdal/kdc/windc.o \\\n \t../heimdal/kdc/kx509.o \\\n \t../heimdal/lib/asn1/asn1_KRB5SignedPath.o\n-PRIVATE_DEPENDENCIES = HEIMDAL_ROKEN HEIMDAL_KRB5 HEIMDAL_HDB HEIMDAL_ASN1 HEIMDAL_DES HEIMDAL_DIGEST_ASN1 HEIMDAL_KX509_ASN1 HEIMDAL_NTLM\n+PRIVATE_DEPENDENCIES = HEIMDAL_ROKEN HEIMDAL_KRB5 HEIMDAL_HDB HEIMDAL_HEIM_ASN1 HEIMDAL_DIGEST_ASN1 HEIMDAL_KX509_ASN1\n+PUBLIC_DEPENDENCIES = HEIMDAL_NTLM HEIMDAL_DES\n # End SUBSYSTEM HEIMDAL_KDC\n #######################\n \n@@ -47,14 +48,14 @@\n \t../heimdal/lib/hdb/mkey.o \\\n \t../heimdal/lib/hdb/ndbm.o \\\n \t../heimdal/lib/hdb/hdb_err.o\n-PRIVATE_DEPENDENCIES = HDB_LDB HEIMDAL_HDB_KEYS HEIMDAL_ROKEN HEIMDAL_HDB_ASN1\n+PRIVATE_DEPENDENCIES = HDB_LDB HEIMDAL_KRB5 HEIMDAL_HDB_KEYS HEIMDAL_ROKEN HEIMDAL_DES HEIMDAL_COM_ERR HEIMDAL_HDB_ASN1\n # End SUBSYSTEM HEIMDAL_HDB\n #######################\n \n #######################\n # Start SUBSYSTEM HEIMDAL_GSSAPI\n [SUBSYSTEM::HEIMDAL_GSSAPI]\n-CFLAGS = -Iheimdal_build -Iheimdal/lib/gssapi/gssapi -Iheimdal/lib/gssapi/spnego -Iheimdal/lib/gssapi/krb5 -Iheimdal/lib/gssapi/mech\n+CFLAGS = -Iheimdal_build -Iheimdal/lib/gssapi -Iheimdal/lib/gssapi/gssapi -Iheimdal/lib/gssapi/spnego -Iheimdal/lib/gssapi/krb5 -Iheimdal/lib/gssapi/mech\n OBJ_FILES = \\\n \t../heimdal/lib/gssapi/mech/gss_krb5.o \\\n \t../heimdal/lib/gssapi/mech/gss_mech_switch.o \\\n@@ -163,7 +164,7 @@\n \t../heimdal/lib/gssapi/krb5/accept_sec_context.o \\\n \t../heimdal/lib/gssapi/krb5/set_sec_context_option.o \\\n \t../heimdal/lib/gssapi/krb5/process_context_token.o\n-PRIVATE_DEPENDENCIES = HEIMDAL_DES HEIMDAL_ASN1 HEIMDAL_SPNEGO_ASN1\n+PRIVATE_DEPENDENCIES = HEIMDAL_DES HEIMDAL_HEIM_ASN1 HEIMDAL_SPNEGO_ASN1\n PUBLIC_DEPENDENCIES = HEIMDAL_ROKEN HEIMDAL_KRB5\n # End SUBSYSTEM HEIMDAL_GSSAPI\n #######################\n@@ -172,8 +173,8 @@\n # Start SUBSYSTEM HEIMDAL_KRB5\n [SUBSYSTEM::HEIMDAL_KRB5]\n CFLAGS = -Iheimdal_build -Iheimdal/lib/krb5 \n-PRIVATE_DEPENDENCIES = HEIMDAL_ROKEN HEIMDAL_DES HEIMDAL_PKINIT_ASN1\n-PUBLIC_DEPENDENCIES = HEIMDAL_KRB5_ASN1 HEIMDAL_GLUE HEIMDAL_HX509\n+PRIVATE_DEPENDENCIES = HEIMDAL_ROKEN HEIMDAL_PKINIT_ASN1\n+PUBLIC_DEPENDENCIES = HEIMDAL_KRB5_ASN1 HEIMDAL_GLUE HEIMDAL_HX509 HEIMDAL_DES\n OBJ_FILES = \\\n \t../heimdal/lib/krb5/acache.o \\\n \t../heimdal/lib/krb5/add_et_list.o \\\n@@ -264,8 +265,8 @@\n #######################\n \n #######################\n-# Start SUBSYSTEM HEIMDAL_ASN1\n-[SUBSYSTEM::HEIMDAL_ASN1]\n+# Start SUBSYSTEM HEIMDAL_HEIM_ASN1\n+[SUBSYSTEM::HEIMDAL_HEIM_ASN1]\n CFLAGS = -Iheimdal_build -Iheimdal/lib/asn1\n OBJ_FILES = \\\n \t../heimdal/lib/asn1/der_get.o \\\n@@ -297,7 +298,7 @@\n \n [SUBSYSTEM::HEIMDAL_DES]\n CFLAGS = -Iheimdal_build -Iheimdal/lib/des \n-PRIVATE_DEPENDENCIES = HEIMDAL_ROKEN HEIMDAL_ASN1 HEIMDAL_DES_IMATH HEIMDAL_RFC2459_ASN1\n+PRIVATE_DEPENDENCIES = HEIMDAL_ROKEN HEIMDAL_HEIM_ASN1 HEIMDAL_DES_IMATH HEIMDAL_RFC2459_ASN1\n OBJ_FILES = \\\n \t../heimdal/lib/des/aes.o \\\n \t../heimdal/lib/des/bn.o \\\n@@ -333,7 +334,7 @@\n CFLAGS = -Iheimdal_build -Iheimdal/lib/hx509 \n PRIVATE_DEPENDENCIES = \\\n \tHEIMDAL_ROKEN HEIMDAL_COM_ERR \\\n-\tHEIMDAL_ASN1 HEIMDAL_DES \\\n+\tHEIMDAL_HEIM_ASN1 HEIMDAL_DES \\\n \tHEIMDAL_CMS_ASN1 HEIMDAL_RFC2459_ASN1 \\\n \tHEIMDAL_OCSP_ASN1 HEIMDAL_PKCS8_ASN1 \\\n \tHEIMDAL_PKCS9_ASN1 HEIMDAL_PKCS12_ASN1\n\n"}