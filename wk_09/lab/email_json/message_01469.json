{"category": "ham", "to_address": "samba-cvs@samba.org", "from_address": "tridge@samba.org", "subject": "Rev 84: fix the queueing for partially connected tcp sockets in\n\thttp://samba.org/~tridge/ctdb", "body": "------------------------------------------------------------\nrevno: 84\nrevision-id: tridge@samba.org-20070410104831-d956235aa1d7329f\nparent: tridge@samba.org-20070410094029-2b9561032c749c8a\ncommitter: Andrew Tridgell \nbranch nick: tridge\ntimestamp: Tue 2007-04-10 20:48:31 +1000\nmessage:\n  fix the queueing for partially connected tcp sockets\nmodified:\n  tcp/ctdb_tcp.h                 ctdb_tcp.h-20061127103747-l8xeniwiapbydehq-3\n  tcp/tcp_connect.c              tcp_connect.c-20061128004937-x70q1cu5xzg5g2tm-1\n  tcp/tcp_init.c                 tcp_init.c-20061128004937-x70q1cu5xzg5g2tm-2\n=== modified file 'tcp/ctdb_tcp.h'\n--- a/tcp/ctdb_tcp.h\t2007-04-10 09:33:21 +0000\n+++ b/tcp/ctdb_tcp.h\t2007-04-10 10:48:31 +0000\n@@ -48,5 +48,6 @@\n void ctdb_tcp_node_connect(struct event_context *ev, struct timed_event *te, \n \t\t\t   struct timeval t, void *private);\n void ctdb_tcp_read_cb(uint8_t *data, size_t cnt, void *args);\n+void ctdb_tcp_tnode_cb(uint8_t *data, size_t cnt, void *private);\n \n #define CTDB_TCP_ALIGNMENT 8\n\n=== modified file 'tcp/tcp_connect.c'\n--- a/tcp/tcp_connect.c\t2007-04-10 09:40:29 +0000\n+++ b/tcp/tcp_connect.c\t2007-04-10 10:48:31 +0000\n@@ -37,7 +37,7 @@\n /*\n   called when a complete packet has come in - should not happen on this socket\n  */\n-static void ctdb_tcp_tnode_cb(uint8_t *data, size_t cnt, void *private)\n+void ctdb_tcp_tnode_cb(uint8_t *data, size_t cnt, void *private)\n {\n \tstruct ctdb_node *node = talloc_get_type(private, struct ctdb_node);\n \tstruct ctdb_tcp_node *tnode = talloc_get_type(node->private, \n@@ -80,8 +80,7 @@\n \t\n         setsockopt(tnode->fd,IPPROTO_TCP,TCP_NODELAY,(char *)&one,sizeof(one));\n \n-\ttnode->queue = ctdb_queue_setup(node->ctdb, node, tnode->fd, CTDB_TCP_ALIGNMENT,\n-\t\t\t\t\tctdb_tcp_tnode_cb, node);\n+\tctdb_queue_set_fd(tnode->queue, tnode->fd);\n \n \t/* tell the ctdb layer we are connected */\n \tnode->ctdb->upcalls->node_connected(node);\n\n=== modified file 'tcp/tcp_init.c'\n--- a/tcp/tcp_init.c\t2007-04-10 09:40:29 +0000\n+++ b/tcp/tcp_init.c\t2007-04-10 10:48:31 +0000\n@@ -67,6 +67,10 @@\n \n \ttnode->fd = -1;\n \tnode->private = tnode;\n+\n+\ttnode->queue = ctdb_queue_setup(node->ctdb, node, tnode->fd, CTDB_TCP_ALIGNMENT,\n+\t\t\t\t\tctdb_tcp_tnode_cb, node);\n+\t\n \treturn 0;\n }\n \n\n"}