{"category": "ham", "to_address": "samba-cvs@samba.org", "from_address": "vlendec@samba.org", "subject": "svn commit: samba r23486 - in branches: SAMBA_3_0/source/locking\n\tSAMBA_3_0/source/smbd SAMBA_3_0_26/source/locking\n\tSAMBA_3_0_26/source/smbd", "body": "Author: vlendec\nDate: 2007-06-14 12:03:46 +0000 (Thu, 14 Jun 2007)\nNew Revision: 23486\n\nWebSVN: http://websvn.samba.org/cgi-bin/viewcvs.cgi?view=rev&root=samba&rev=23486\n\nLog:\nOk, this time with a hopefully successful make test in the right place:\nRemove two local variables\n\nModified:\n   branches/SAMBA_3_0/source/locking/locking.c\n   branches/SAMBA_3_0/source/smbd/reply.c\n   branches/SAMBA_3_0_26/source/locking/locking.c\n   branches/SAMBA_3_0_26/source/smbd/reply.c\n\n\nChangeset:\nModified: branches/SAMBA_3_0/source/locking/locking.c\n===================================================================\n--- branches/SAMBA_3_0/source/locking/locking.c\t2007-06-14 11:29:35 UTC (rev 23485)\n+++ branches/SAMBA_3_0/source/locking/locking.c\t2007-06-14 12:03:46 UTC (rev 23486)\n@@ -844,10 +844,6 @@\n \tchar *frm = NULL;\n \tint i;\n \n-\tif (!lck) {\n-\t\treturn False;\n-\t}\n-\n \tDEBUG(10, (\"rename_share_filename: servicepath %s newname %s\\n\",\n \t\tservicepath, newname));\n \n\nModified: branches/SAMBA_3_0/source/smbd/reply.c\n===================================================================\n--- branches/SAMBA_3_0/source/smbd/reply.c\t2007-06-14 11:29:35 UTC (rev 23485)\n+++ branches/SAMBA_3_0/source/smbd/reply.c\t2007-06-14 12:03:46 UTC (rev 23486)\n@@ -4168,13 +4168,15 @@\n  asynchronously.\n ****************************************************************************/\n \n-static void rename_open_files(connection_struct *conn, struct share_mode_lock *lck,\n-\t\t\t      struct file_id id, const char *newname)\n+static void rename_open_files(connection_struct *conn,\n+\t\t\t      struct share_mode_lock *lck,\n+\t\t\t      const char *newname)\n {\n \tfiles_struct *fsp;\n \tBOOL did_rename = False;\n \n-\tfor(fsp = file_find_di_first(id); fsp; fsp = file_find_di_next(fsp)) {\n+\tfor(fsp = file_find_di_first(lck->id); fsp;\n+\t    fsp = file_find_di_next(fsp)) {\n \t\t/* fsp_name is a relative path under the fsp. To change this for other\n \t\t   sharepaths we need to manipulate relative paths. */\n \t\t/* TODO - create the absolute path and manipulate the newname\n@@ -4191,7 +4193,7 @@\n \n \tif (!did_rename) {\n \t\tDEBUG(10,(\"rename_open_files: no open files on file_id %s for %s\\n\",\n-\t\t\t  file_id_static_string(&id), newname ));\n+\t\t\t  file_id_static_string(&lck->id), newname ));\n \t}\n \n \t/* Send messages to all smbd's (not ourself) that the name has changed. */\n@@ -4237,7 +4239,6 @@\n \tSMB_STRUCT_STAT sbuf;\n \tpstring newname_last_component;\n \tNTSTATUS status = NT_STATUS_OK;\n-\tBOOL dest_exists;\n \tstruct share_mode_lock *lck = NULL;\n \n \tZERO_STRUCT(sbuf);\n@@ -4306,9 +4307,7 @@\n \t\treturn NT_STATUS_OK;\n \t}\n \n-\tdest_exists = vfs_object_exist(conn,newname,NULL);\n-\n-\tif(!replace_if_exists && dest_exists) {\n+\tif(!replace_if_exists && vfs_object_exist(conn, newname, NULL)) {\n \t\tDEBUG(3,(\"rename_internals_fsp: dest exists doing rename %s -> %s\\n\",\n \t\t\tfsp->fsp_name,newname));\n \t\treturn NT_STATUS_OBJECT_NAME_COLLISION;\n@@ -4341,13 +4340,20 @@\n \n \tlck = get_share_mode_lock(NULL, fsp->file_id, NULL, NULL);\n \n+\t/*\n+\t * We have the file open ourselves, so not being able to get the\n+\t * corresponding share mode lock is a fatal error.\n+\t */\n+\n+\tSMB_ASSERT(lck != NULL);\n+\n \tif(SMB_VFS_RENAME(conn,fsp->fsp_name, newname) == 0) {\n \t\tuint32 create_options = fsp->fh->private_options;\n \n \t\tDEBUG(3,(\"rename_internals_fsp: succeeded doing rename on %s -> %s\\n\",\n \t\t\tfsp->fsp_name,newname));\n \n-\t\trename_open_files(conn, lck, fsp->file_id, newname);\n+\t\trename_open_files(conn, lck, newname);\n \n \t\t/*\n \t\t * A rename acts as a new file create w.r.t. allowing an initial delete\n@@ -4455,7 +4461,6 @@\n \tconst char *dname;\n \tlong offset = 0;\n \tpstring destname;\n-\tstruct file_id id;\n \n \t*directory = *mask = 0;\n \n@@ -4605,8 +4610,6 @@\n \t\t * don't do the rename, just return success.\n \t\t */\n \n-\t\tid = file_id_sbuf(&sbuf1);\n-\n \t\tif (strcsequal(directory, newname)) {\n \t\t\tDEBUG(3, (\"rename_internals: identical names in \"\n \t\t\t\t  \"rename %s - returning success\\n\",\n@@ -4624,12 +4627,19 @@\n \t\t\treturn NT_STATUS_SHARING_VIOLATION;\n \t\t}\n \n-\t\tlck = get_share_mode_lock(NULL, id, NULL, NULL);\n+\t\tlck = get_share_mode_lock(NULL, file_id_sbuf(&sbuf1),\n+\t\t\t\t\t  NULL, NULL);\n \n \t\tif(SMB_VFS_RENAME(conn,directory, newname) == 0) {\n \t\t\tDEBUG(3,(\"rename_internals: succeeded doing rename \"\n \t\t\t\t \"on %s -> %s\\n\", directory, newname));\n-\t\t\trename_open_files(conn, lck, id, newname);\n+\t\t\tif (lck != NULL) {\n+\t\t\t\t/*\n+\t\t\t\t * Only in this case there are open files at\n+\t\t\t\t * all.\n+\t\t\t\t */\n+\t\t\t\trename_open_files(conn, lck, newname);\n+\t\t\t}\n \t\t\tTALLOC_FREE(lck);\n \t\t\tnotify_rename(conn, S_ISDIR(sbuf1.st_mode),\n \t\t\t\t      directory, newname);\n@@ -4740,8 +4750,6 @@\n \t\t\treturn status;\n \t\t}\n \n-\t\tid = file_id_sbuf(&sbuf1);\n-\n \t\tif (strcsequal(fname,destname)) {\n \t\t\tDEBUG(3,(\"rename_internals: identical names \"\n \t\t\t\t \"in wildcard rename %s - success\\n\",\n@@ -4761,10 +4769,17 @@\n \t\t\treturn NT_STATUS_SHARING_VIOLATION;\n \t\t}\n \n-\t\tlck = get_share_mode_lock(NULL, id, NULL, NULL);\n+\t\tlck = get_share_mode_lock(NULL, file_id_sbuf(&sbuf1), NULL,\n+\t\t\t\t\t  NULL);\n \n \t\tif (!SMB_VFS_RENAME(conn,fname,destname)) {\n-\t\t\trename_open_files(conn, lck, id, newname);\n+\t\t\tif (lck != NULL) {\n+\t\t\t\t/*\n+\t\t\t\t * Only in this case there are open files at\n+\t\t\t\t * all.\n+\t\t\t\t */\n+\t\t\t\trename_open_files(conn, lck, newname);\n+\t\t\t}\n \t\t\tcount++;\n \t\t\tstatus = NT_STATUS_OK;\n \t\t}\n\nModified: branches/SAMBA_3_0_26/source/locking/locking.c\n===================================================================\n--- branches/SAMBA_3_0_26/source/locking/locking.c\t2007-06-14 11:29:35 UTC (rev 23485)\n+++ branches/SAMBA_3_0_26/source/locking/locking.c\t2007-06-14 12:03:46 UTC (rev 23486)\n@@ -844,10 +844,6 @@\n \tchar *frm = NULL;\n \tint i;\n \n-\tif (!lck) {\n-\t\treturn False;\n-\t}\n-\n \tDEBUG(10, (\"rename_share_filename: servicepath %s newname %s\\n\",\n \t\tservicepath, newname));\n \n\nModified: branches/SAMBA_3_0_26/source/smbd/reply.c\n===================================================================\n--- branches/SAMBA_3_0_26/source/smbd/reply.c\t2007-06-14 11:29:35 UTC (rev 23485)\n+++ branches/SAMBA_3_0_26/source/smbd/reply.c\t2007-06-14 12:03:46 UTC (rev 23486)\n@@ -4166,13 +4166,15 @@\n  asynchronously.\n ****************************************************************************/\n \n-static void rename_open_files(connection_struct *conn, struct share_mode_lock *lck,\n-\t\t\t      struct file_id id, const char *newname)\n+static void rename_open_files(connection_struct *conn,\n+\t\t\t      struct share_mode_lock *lck,\n+\t\t\t      const char *newname)\n {\n \tfiles_struct *fsp;\n \tBOOL did_rename = False;\n \n-\tfor(fsp = file_find_di_first(id); fsp; fsp = file_find_di_next(fsp)) {\n+\tfor(fsp = file_find_di_first(lck->id); fsp;\n+\t    fsp = file_find_di_next(fsp)) {\n \t\t/* fsp_name is a relative path under the fsp. To change this for other\n \t\t   sharepaths we need to manipulate relative paths. */\n \t\t/* TODO - create the absolute path and manipulate the newname\n@@ -4189,7 +4191,7 @@\n \n \tif (!did_rename) {\n \t\tDEBUG(10,(\"rename_open_files: no open files on file_id %s for %s\\n\",\n-\t\t\t  file_id_static_string(&id), newname ));\n+\t\t\t  file_id_static_string(&lck->id), newname ));\n \t}\n \n \t/* Send messages to all smbd's (not ourself) that the name has changed. */\n@@ -4235,7 +4237,6 @@\n \tSMB_STRUCT_STAT sbuf;\n \tpstring newname_last_component;\n \tNTSTATUS status = NT_STATUS_OK;\n-\tBOOL dest_exists;\n \tstruct share_mode_lock *lck = NULL;\n \n \tZERO_STRUCT(sbuf);\n@@ -4304,9 +4305,7 @@\n \t\treturn NT_STATUS_OK;\n \t}\n \n-\tdest_exists = vfs_object_exist(conn,newname,NULL);\n-\n-\tif(!replace_if_exists && dest_exists) {\n+\tif(!replace_if_exists && vfs_object_exist(conn, newname, NULL)) {\n \t\tDEBUG(3,(\"rename_internals_fsp: dest exists doing rename %s -> %s\\n\",\n \t\t\tfsp->fsp_name,newname));\n \t\treturn NT_STATUS_OBJECT_NAME_COLLISION;\n@@ -4339,13 +4338,20 @@\n \n \tlck = get_share_mode_lock(NULL, fsp->file_id, NULL, NULL);\n \n+\t/*\n+\t * We have the file open ourselves, so not being able to get the\n+\t * corresponding share mode lock is a fatal error.\n+\t */\n+\n+\tSMB_ASSERT(lck != NULL);\n+\n \tif(SMB_VFS_RENAME(conn,fsp->fsp_name, newname) == 0) {\n \t\tuint32 create_options = fsp->fh->private_options;\n \n \t\tDEBUG(3,(\"rename_internals_fsp: succeeded doing rename on %s -> %s\\n\",\n \t\t\tfsp->fsp_name,newname));\n \n-\t\trename_open_files(conn, lck, fsp->file_id, newname);\n+\t\trename_open_files(conn, lck, newname);\n \n \t\t/*\n \t\t * A rename acts as a new file create w.r.t. allowing an initial delete\n@@ -4453,7 +4459,6 @@\n \tconst char *dname;\n \tlong offset = 0;\n \tpstring destname;\n-\tstruct file_id id;\n \n \t*directory = *mask = 0;\n \n@@ -4603,8 +4608,6 @@\n \t\t * don't do the rename, just return success.\n \t\t */\n \n-\t\tid = file_id_sbuf(&sbuf1);\n-\n \t\tif (strcsequal(directory, newname)) {\n \t\t\tDEBUG(3, (\"rename_internals: identical names in \"\n \t\t\t\t  \"rename %s - returning success\\n\",\n@@ -4622,12 +4625,19 @@\n \t\t\treturn NT_STATUS_SHARING_VIOLATION;\n \t\t}\n \n-\t\tlck = get_share_mode_lock(NULL, id, NULL, NULL);\n+\t\tlck = get_share_mode_lock(NULL, file_id_sbuf(&sbuf1),\n+\t\t\t\t\t  NULL, NULL);\n \n \t\tif(SMB_VFS_RENAME(conn,directory, newname) == 0) {\n \t\t\tDEBUG(3,(\"rename_internals: succeeded doing rename \"\n \t\t\t\t \"on %s -> %s\\n\", directory, newname));\n-\t\t\trename_open_files(conn, lck, id, newname);\n+\t\t\tif (lck != NULL) {\n+\t\t\t\t/*\n+\t\t\t\t * Only in this case there are open files at\n+\t\t\t\t * all.\n+\t\t\t\t */\n+\t\t\t\trename_open_files(conn, lck, newname);\n+\t\t\t}\n \t\t\tTALLOC_FREE(lck);\n \t\t\tnotify_rename(conn, S_ISDIR(sbuf1.st_mode),\n \t\t\t\t      directory, newname);\n@@ -4738,8 +4748,6 @@\n \t\t\treturn status;\n \t\t}\n \n-\t\tid = file_id_sbuf(&sbuf1);\n-\n \t\tif (strcsequal(fname,destname)) {\n \t\t\tDEBUG(3,(\"rename_internals: identical names \"\n \t\t\t\t \"in wildcard rename %s - success\\n\",\n@@ -4759,10 +4767,17 @@\n \t\t\treturn NT_STATUS_SHARING_VIOLATION;\n \t\t}\n \n-\t\tlck = get_share_mode_lock(NULL, id, NULL, NULL);\n+\t\tlck = get_share_mode_lock(NULL, file_id_sbuf(&sbuf1), NULL,\n+\t\t\t\t\t  NULL);\n \n \t\tif (!SMB_VFS_RENAME(conn,fname,destname)) {\n-\t\t\trename_open_files(conn, lck, id, newname);\n+\t\t\tif (lck != NULL) {\n+\t\t\t\t/*\n+\t\t\t\t * Only in this case there are open files at\n+\t\t\t\t * all.\n+\t\t\t\t */\n+\t\t\t\trename_open_files(conn, lck, newname);\n+\t\t\t}\n \t\t\tcount++;\n \t\t\tstatus = NT_STATUS_OK;\n \t\t}\n\n"}