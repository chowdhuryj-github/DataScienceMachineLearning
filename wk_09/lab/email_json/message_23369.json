{"category": "ham", "to_address": "samba-cvs@samba.org", "from_address": "tridge@samba.org", "subject": "Rev 254: added a dumpmemory control,\n\tused to find memory leaks in http://samba.org/~tridge/ctdb", "body": "------------------------------------------------------------\nrevno: 254\nrevision-id: tridge@samba.org-20070505010310-wlknjyla4cqkbdld\nparent: tridge@samba.org-20070504223335-oai3wi0jsmp8ywwp\ncommitter: Andrew Tridgell \nbranch nick: tridge\ntimestamp: Sat 2007-05-05 11:03:10 +1000\nmessage:\n  added a dumpmemory control, used to find memory leaks\nmodified:\n  common/ctdb_control.c          ctdb_control.c-20070426122724-j6gkpiofhbwdin63-1\n  include/ctdb_private.h         ctdb_private.h-20061117234101-o3qt14umlg9en8z0-13\n  tools/ctdb_control.c           ctdb_control.c-20070426122705-9ehj1l5lu2gn9kuj-1\n=== modified file 'common/ctdb_control.c'\n--- a/common/ctdb_control.c\t2007-05-04 22:33:35 +0000\n+++ b/common/ctdb_control.c\t2007-05-05 01:03:10 +0000\n@@ -164,6 +164,12 @@\n \t\treturn 0;\n \t}\n \n+\tcase CTDB_CONTROL_DUMP_MEMORY: {\n+\t\tCHECK_CONTROL_DATA_SIZE(0);\n+\t\ttalloc_report_full(ctdb, stdout);\n+\t\treturn 0;\n+\t}\n+\n \tcase CTDB_CONTROL_STATUS_RESET: {\n \t\tCHECK_CONTROL_DATA_SIZE(0);\n \t\tZERO_STRUCT(ctdb->status);\n\n=== modified file 'include/ctdb_private.h'\n--- a/include/ctdb_private.h\t2007-05-04 22:33:35 +0000\n+++ b/include/ctdb_private.h\t2007-05-05 01:03:10 +0000\n@@ -306,6 +306,7 @@\n \t\t    CTDB_CONTROL_ENABLE_SEQNUM,\n \t\t    CTDB_CONTROL_UPDATE_SEQNUM,\n \t\t    CTDB_CONTROL_SET_SEQNUM_FREQUENCY,\n+\t\t    CTDB_CONTROL_DUMP_MEMORY,\n };\n \n \n\n=== modified file 'tools/ctdb_control.c'\n--- a/tools/ctdb_control.c\t2007-05-04 22:33:35 +0000\n+++ b/tools/ctdb_control.c\t2007-05-05 01:03:10 +0000\n@@ -935,6 +935,28 @@\n }\n \n /*\n+  dump memory usage\n+ */\n+static int control_dumpmemory(struct ctdb_context *ctdb, int argc, const char **argv)\n+{\n+\n+\tuint32_t vnn;\n+\tif (argc < 1) {\n+\t\tusage();\n+\t}\n+\tif (strcmp(argv[0], \"all\") == 0) {\n+\t\tvnn = CTDB_BROADCAST_VNN;\n+\t} else {\n+\t\tvnn = strtoul(argv[0], NULL, 0);\n+\t}\n+\n+\tctdb_control(ctdb, vnn, 0, CTDB_CONTROL_DUMP_MEMORY,\n+\t\t     CTDB_CTRL_FLAG_NOREPLY, tdb_null, NULL, NULL, NULL, NULL);\n+\n+\treturn 0;\n+}\n+\n+/*\n   main program\n */\n int main(int argc, const char *argv[])\n@@ -976,6 +998,7 @@\n \t\t{ \"recover\", control_recover },\n \t\t{ \"writerecord\", control_writerecord },\n \t\t{ \"attach\", control_attach },\n+\t\t{ \"dumpmemory\", control_dumpmemory },\n \t};\n \n \tpc = poptGetContext(argv[0], argc, argv, popt_options, POPT_CONTEXT_KEEP_FIRST);\n\n"}