{"category": "ham", "to_address": "samba-cvs@samba.org", "from_address": "tridge@samba.org", "subject": "Rev 107: - fix includes to work in both samba4 and ctdb standalone\n\tin http://samba.org/~tridge/ctdb", "body": "------------------------------------------------------------\nrevno: 107\nrevision-id: tridge@samba.org-20070416002144-34daa28d0f1d01db\nparent: tridge@samba.org-20070415232910-a604c82b6945e169\ncommitter: Andrew Tridgell \nbranch nick: tridge\ntimestamp: Mon 2007-04-16 10:21:44 +1000\nmessage:\n  - fix includes to work in both samba4 and ctdb standalone\n  - when we do a store_unlock the lock record becomes unlocked, so we\n    must destroy it (or we leak memory)\nmodified:\n  common/ctdb_call.c             ctdb_call.c-20061128065342-to93h6eejj5kon81-1\n  common/ctdb_client.c           ctdb_client.c-20070411010216-3kd8v37k61steeya-1\n  common/ctdb_io.c               ctdb_io.c-20070409200335-dzfc7f3rra5rcf60-1\n  common/ctdb_message.c          ctdb_message.c-20070208224107-9dnio7x7z33prrmt-1\n  common/ctdb_util.c             ctdb_util.c-20061128065342-to93h6eejj5kon81-3\n=== modified file 'common/ctdb_call.c'\n--- a/common/ctdb_call.c\t2007-04-13 10:38:24 +0000\n+++ b/common/ctdb_call.c\t2007-04-16 00:21:44 +0000\n@@ -796,10 +796,13 @@\n \tret = ctdb_ltdb_fetch(rec->ctdb_db, rec->key, &header, NULL, NULL);\n \tif (ret) {\n \t\tctdb_set_error(rec->ctdb_db->ctdb, \"Fetch of locally held record failed\");\n+\t\ttalloc_free(rec);\n \t\treturn ret;\n \t}\n \n \tret = ctdb_ltdb_store(rec->ctdb_db, rec->key, &header, data);\n \t\t\n+\ttalloc_free(rec);\n+\n \treturn ret;\n }\n\n=== modified file 'common/ctdb_client.c'\n--- a/common/ctdb_client.c\t2007-04-14 21:41:35 +0000\n+++ b/common/ctdb_client.c\t2007-04-16 00:21:44 +0000\n@@ -656,6 +656,7 @@\n \tstate = ctdb_client_store_unlock_send(rec, rec, data);\n \tres = ctdb_client_store_unlock_recv(state, rec);\n \n+\ttalloc_free(rec);\n+\n \treturn res;\n-\n }\n\n=== modified file 'common/ctdb_io.c'\n--- a/common/ctdb_io.c\t2007-04-13 10:38:24 +0000\n+++ b/common/ctdb_io.c\t2007-04-16 00:21:44 +0000\n@@ -28,7 +28,7 @@\n #include \"system/network.h\"\n #include \"system/filesys.h\"\n #include \"../include/ctdb_private.h\"\n-#include \"ctdb.h\"\n+#include \"../include/ctdb.h\"\n \n /* structures for packet queueing - see common/ctdb_io.c */\n struct ctdb_partial {\n\n=== modified file 'common/ctdb_message.c'\n--- a/common/ctdb_message.c\t2007-04-13 10:38:24 +0000\n+++ b/common/ctdb_message.c\t2007-04-16 00:21:44 +0000\n@@ -27,7 +27,7 @@\n #include \"system/network.h\"\n #include \"system/filesys.h\"\n #include \"../include/ctdb_private.h\"\n-\n+#include \"lib/util/dlinklist.h\"\n \n /*\n   this dispatches the messages to the registered ctdb message handler\n\n=== modified file 'common/ctdb_util.c'\n--- a/common/ctdb_util.c\t2006-12-18 05:01:11 +0000\n+++ b/common/ctdb_util.c\t2007-04-16 00:21:44 +0000\n@@ -20,9 +20,10 @@\n \n #include \"includes.h\"\n #include \"lib/events/events.h\"\n+#include \"lib/tdb/include/tdb.h\"\n #include \"system/network.h\"\n #include \"system/filesys.h\"\n-#include \"ctdb_private.h\"\n+#include \"../include/ctdb_private.h\"\n \n /*\n   return error string for last error\n\n"}