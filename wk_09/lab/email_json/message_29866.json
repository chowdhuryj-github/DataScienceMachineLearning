{"category": "ham", "to_address": "samba-cvs@samba.org", "from_address": "abartlet@samba.org", "subject": "svn commit: samba r22874 - in branches/SAMBA_4_0/source: ntvfs/ipc\n\ttorture/raw", "body": "Author: abartlet\nDate: 2007-05-15 01:21:20 +0000 (Tue, 15 May 2007)\nNew Revision: 22874\n\nWebSVN: http://websvn.samba.org/cgi-bin/viewcvs.cgi?view=rev&root=samba&rev=22874\n\nLog:\nExpand the RPC-QFILEINFO-IPC test, and add a server implementation to match.\n\nThis should help with Vista joins.\n\nAndrew Bartlett\n\nModified:\n   branches/SAMBA_4_0/source/ntvfs/ipc/vfs_ipc.c\n   branches/SAMBA_4_0/source/torture/raw/qfileinfo.c\n\n\nChangeset:\nModified: branches/SAMBA_4_0/source/ntvfs/ipc/vfs_ipc.c\n===================================================================\n--- branches/SAMBA_4_0/source/ntvfs/ipc/vfs_ipc.c\t2007-05-15 00:10:18 UTC (rev 22873)\n+++ branches/SAMBA_4_0/source/ntvfs/ipc/vfs_ipc.c\t2007-05-15 01:21:20 UTC (rev 22874)\n@@ -149,7 +149,14 @@\n static NTSTATUS ipc_qpathinfo(struct ntvfs_module_context *ntvfs,\n \t\t\t      struct ntvfs_request *req, union smb_fileinfo *info)\n {\n-\treturn NT_STATUS_ACCESS_DENIED;\n+\tswitch (info->generic.level) {\n+\tcase  RAW_FILEINFO_GENERIC:\n+\t\treturn NT_STATUS_INVALID_DEVICE_REQUEST;\n+\tcase RAW_FILEINFO_GETATTR:\n+\t\treturn NT_STATUS_ACCESS_DENIED;\n+\tdefault:\n+\t\treturn ntvfs_map_qpathinfo(ntvfs, req, info);\n+\t}\n }\n \n /*\n@@ -602,6 +609,39 @@\n static NTSTATUS ipc_qfileinfo(struct ntvfs_module_context *ntvfs,\n \t\t\t      struct ntvfs_request *req, union smb_fileinfo *info)\n {\n+\tstruct ipc_private *private = ntvfs->private_data;\n+\tswitch (info->generic.level) {\n+\tcase RAW_FILEINFO_GENERIC: \n+\t{\n+\t\tstruct pipe_state *p;\n+\t\tp = pipe_state_find(private, info->generic.in.file.ntvfs);\n+\t\tif (!p) {\n+\t\t\treturn NT_STATUS_INVALID_HANDLE;\n+\t\t}\n+\t\tZERO_STRUCT(info->generic.out);\n+\t\tinfo->generic.out.attrib = FILE_ATTRIBUTE_NORMAL;\n+\t\tinfo->generic.out.fname.s = strrchr(p->pipe_name, '\\\\');\n+\t\tinfo->generic.out.alloc_size = 4096;\n+\t\tinfo->generic.out.nlink = 1;\n+\t\t/* What the heck?  Match Win2k3: IPC$ pipes are delete pending */\n+\t\tinfo->generic.out.delete_pending = 1;\n+\t\treturn NT_STATUS_OK;\n+\t}\n+\tcase RAW_FILEINFO_ALT_NAME_INFO:\n+\tcase RAW_FILEINFO_ALT_NAME_INFORMATION:\n+\tcase RAW_FILEINFO_STREAM_INFO:\n+\tcase RAW_FILEINFO_STREAM_INFORMATION:\n+\tcase RAW_FILEINFO_COMPRESSION_INFO:\n+\tcase RAW_FILEINFO_COMPRESSION_INFORMATION:\n+\tcase RAW_FILEINFO_NETWORK_OPEN_INFORMATION:\n+\tcase RAW_FILEINFO_ATTRIBUTE_TAG_INFORMATION:\n+\t\treturn NT_STATUS_INVALID_PARAMETER;\n+\tcase  RAW_FILEINFO_ALL_EAS:\n+\t\treturn NT_STATUS_ACCESS_DENIED;\n+\tdefault:\n+\t\treturn ntvfs_map_qfileinfo(ntvfs, req, info);\n+\t}\n+\t\n \treturn NT_STATUS_ACCESS_DENIED;\n }\n \n\nModified: branches/SAMBA_4_0/source/torture/raw/qfileinfo.c\n===================================================================\n--- branches/SAMBA_4_0/source/torture/raw/qfileinfo.c\t2007-05-15 00:10:18 UTC (rev 22873)\n+++ branches/SAMBA_4_0/source/torture/raw/qfileinfo.c\t2007-05-15 01:21:20 UTC (rev 22874)\n@@ -732,6 +732,24 @@\n \t\t  \"ALL_INFO\",      all_info,      directory);\n \tVAL_CHECK(\"STANDARD_INFO\", standard_info, nlink, \n \t\t  \"ALL_INFO\",      all_info,      nlink);\n+\ts1 = fnum_find(\"BASIC_INFO\");\n+\tif (s1 && is_ipc) {\n+\t\tif (s1->basic_info.out.attrib != FILE_ATTRIBUTE_NORMAL) {\n+\t\t\tprintf(\"(%d) attrib basic_info/nlink incorrect - %d should be %d\\n\", __LINE__, s1->basic_info.out.attrib, FILE_ATTRIBUTE_NORMAL);\n+\t\t\tret = False;\n+\t\t}\n+\t}\n+\ts1 = fnum_find(\"STANDARD_INFO\");\n+\tif (s1 && is_ipc) {\n+\t\tif (s1->standard_info.out.nlink != 1) {\n+\t\t\tprintf(\"(%d) nlinks standard_info/nlink incorrect - %d should be 1\\n\", __LINE__, s1->standard_info.out.nlink);\n+\t\t\tret = False;\n+\t\t}\n+\t\tif (s1->standard_info.out.delete_pending != 1) {\n+\t\t\tprintf(\"(%d) nlinks standard_info/delete_pending incorrect - %d should be 1\\n\", __LINE__, s1->standard_info.out.delete_pending);\n+\t\t\tret = False;\n+\t\t}\n+\t}\n \tVAL_CHECK(\"EA_INFO\",       ea_info,       ea_size, \n \t\t  \"ALL_INFO\",      all_info,      ea_size);\n \tif (!is_ipc) {\n\n"}