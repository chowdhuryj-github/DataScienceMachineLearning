{"category": "ham", "to_address": "samba-cvs@samba.org", "from_address": "metze@samba.org", "subject": "svn commit: samba r22759 - in branches/SAMBA_3_0/source/lib/talloc:\n\t.", "body": "Author: metze\nDate: 2007-05-08 11:12:11 +0000 (Tue, 08 May 2007)\nNew Revision: 22759\n\nWebSVN: http://websvn.samba.org/cgi-bin/viewcvs.cgi?view=rev&root=samba&rev=22759\n\nLog:\nsync lib/talloc with samba4\n\nmetze\nModified:\n   branches/SAMBA_3_0/source/lib/talloc/Makefile.in\n   branches/SAMBA_3_0/source/lib/talloc/configure.ac\n   branches/SAMBA_3_0/source/lib/talloc/libtalloc.m4\n   branches/SAMBA_3_0/source/lib/talloc/talloc.3.xml\n   branches/SAMBA_3_0/source/lib/talloc/talloc.c\n   branches/SAMBA_3_0/source/lib/talloc/talloc.pc.in\n   branches/SAMBA_3_0/source/lib/talloc/talloc_guide.txt\n   branches/SAMBA_3_0/source/lib/talloc/testsuite.c\n\n\nChangeset:\nModified: branches/SAMBA_3_0/source/lib/talloc/Makefile.in\n===================================================================\n--- branches/SAMBA_3_0/source/lib/talloc/Makefile.in\t2007-05-08 09:54:01 UTC (rev 22758)\n+++ branches/SAMBA_3_0/source/lib/talloc/Makefile.in\t2007-05-08 11:12:11 UTC (rev 22759)\n@@ -12,12 +12,12 @@\n XSLTPROC = @XSLTPROC@\n INSTALLCMD = @INSTALL@\n CC = @CC@\n-CFLAGS = @CFLAGS@ -DHAVE_CONFIG_H= -I. -I@srcdir@ -I@libreplacedir@\n+CFLAGS = @CFLAGS@ -DHAVE_CONFIG_H= -I. -I@srcdir@\n EXTRA_TARGETS = @DOC_TARGET@\n \n .SUFFIXES: .c .o .3 .3.xml .xml .html\n \n-LIBOBJ = @TALLOCOBJ@ @LIBREPLACEOBJ@\n+LIBOBJ = @TALLOC_OBJ@ @LIBREPLACEOBJ@\n \n all: showflags libtalloc.a testsuite $(EXTRA_TARGETS)\n \n@@ -34,13 +34,14 @@\n \t@-ranlib $@\n \n install: all \n-\t${INSTALLCMD} -d ${libdir}\n-\t${INSTALLCMD} -m 755 libtalloc.a $(libdir)\n-\t${INSTALLCMD} -d ${includedir}\n-\t${INSTALLCMD} -m 644 $(srcdir)/talloc.h $(includedir)\n-\t${INSTALLCMD} -m 644 talloc.pc $(libdir)/pkgconfig\n-\tif [ -f talloc.3 ];then ${INSTALLCMD} -d ${mandir}/man3; fi\n-\tif [ -f talloc.3 ];then ${INSTALLCMD} -m 644 talloc.3 $(mandir)/man3; fi\n+\t${INSTALLCMD} -d $(DESTDIR)$(libdir)\n+\t${INSTALLCMD} -d $(DESTDIR)$(libdir)/pkgconfig\n+\t${INSTALLCMD} -m 755 libtalloc.a $(DESTDIR)$(libdir)\n+\t${INSTALLCMD} -d $(DESTDIR)${includedir}\n+\t${INSTALLCMD} -m 644 $(srcdir)/talloc.h $(DESTDIR)$(includedir)\n+\t${INSTALLCMD} -m 644 talloc.pc $(DESTDIR)$(libdir)/pkgconfig\n+\tif [ -f talloc.3 ];then ${INSTALLCMD} -d $(DESTDIR)$(mandir)/man3; fi\n+\tif [ -f talloc.3 ];then ${INSTALLCMD} -m 644 talloc.3 $(DESTDIR)$(mandir)/man3; fi\n \n doc: talloc.3 talloc.3.html\n \n\nModified: branches/SAMBA_3_0/source/lib/talloc/configure.ac\n===================================================================\n--- branches/SAMBA_3_0/source/lib/talloc/configure.ac\t2007-05-08 09:54:01 UTC (rev 22758)\n+++ branches/SAMBA_3_0/source/lib/talloc/configure.ac\t2007-05-08 11:12:11 UTC (rev 22759)\n@@ -1,5 +1,5 @@\n AC_PREREQ(2.50)\n-AC_INIT(talloc.h)\n+AC_INIT(talloc, 1.0)\n AC_CONFIG_SRCDIR([talloc.c])\n AC_SUBST(datarootdir)\n AC_CONFIG_HEADER(config.h)\n\nModified: branches/SAMBA_3_0/source/lib/talloc/libtalloc.m4\n===================================================================\n--- branches/SAMBA_3_0/source/lib/talloc/libtalloc.m4\t2007-05-08 09:54:01 UTC (rev 22758)\n+++ branches/SAMBA_3_0/source/lib/talloc/libtalloc.m4\t2007-05-08 11:12:11 UTC (rev 22759)\n@@ -12,9 +12,15 @@\n if test x\"$tallocdir\" = \"x\"; then\n    AC_MSG_ERROR([cannot find talloc source in $tallocpaths])\n fi\n-TALLOCOBJ=\"talloc.o\"\n-AC_SUBST(TALLOCOBJ)\n+TALLOC_OBJ=\"talloc.o\"\n+AC_SUBST(TALLOC_OBJ)\n \n+TALLOC_CFLAGS=\"-I$tallocdir\"\n+AC_SUBST(TALLOC_CFLAGS)\n+\n+TALLOC_LIBS=\"\"\n+AC_SUBST(TALLOC_LIBS)\n+\n AC_CHECK_SIZEOF(size_t,cross)\n AC_CHECK_SIZEOF(void *,cross)\n \n\nModified: branches/SAMBA_3_0/source/lib/talloc/talloc.3.xml\n===================================================================\n--- branches/SAMBA_3_0/source/lib/talloc/talloc.3.xml\t2007-05-08 09:54:01 UTC (rev 22758)\n+++ branches/SAMBA_3_0/source/lib/talloc/talloc.3.xml\t2007-05-08 11:12:11 UTC (rev 22759)\n@@ -583,11 +583,27 @@\n         \ntalloc_set_name_const(ptr, ptr)\n\n+    char *talloc_append_string(const void *t, char *orig, const char *append);\n+        \n+\t  The talloc_append_string() function appends the given formatted\n+\t  string to the given string.\n+        \n+        \n+\t  This function sets the name of the new pointer to the new\n+\t  string. This is equivalent to:\n+        \n+        talloc_set_name_const(ptr, ptr)\n+    \nchar *talloc_vasprintf(const void *t, const char *fmt, va_list ap);\n\n \t  The talloc_vasprintf() function is the talloc equivalent of the C\n \t  library function vasprintf(3).\n         \n+        \n+\t  This function sets the name of the new pointer to the new\n+\t  string. This is equivalent to:\n+        \n+        talloc_set_name_const(ptr, ptr)\n\nchar *talloc_asprintf(const void *t, const char *fmt, ...);\n\n@@ -605,6 +621,11 @@\n \t  The talloc_asprintf_append() function appends the given formatted\n \t  string to the given string.\n         \n+        \n+\t  This function sets the name of the new pointer to the new\n+\t  string. This is equivalent to:\n+        \n+        talloc_set_name_const(ptr, ptr)\n\n(type *)talloc_array(const void *ctx, type, uint_t count);\n\n\nModified: branches/SAMBA_3_0/source/lib/talloc/talloc.c\n===================================================================\n--- branches/SAMBA_3_0/source/lib/talloc/talloc.c\t2007-05-08 09:54:01 UTC (rev 22758)\n+++ branches/SAMBA_3_0/source/lib/talloc/talloc.c\t2007-05-08 11:12:11 UTC (rev 22759)\n@@ -1137,6 +1137,8 @@\n \t/* append the string with the trailing \\0 */\n \tmemcpy(&ret[olen], append, alenz);\n \n+\t_talloc_set_name_const(ret, ret);\n+\n \treturn ret;\n }\n \n\nModified: branches/SAMBA_3_0/source/lib/talloc/talloc.pc.in\n===================================================================\n--- branches/SAMBA_3_0/source/lib/talloc/talloc.pc.in\t2007-05-08 09:54:01 UTC (rev 22758)\n+++ branches/SAMBA_3_0/source/lib/talloc/talloc.pc.in\t2007-05-08 11:12:11 UTC (rev 22759)\n@@ -5,7 +5,7 @@\n \n Name: talloc \n Description: A hierarchical pool based memory system with destructors\n-Version: 4.0\n+Version: @PACKAGE_VERSION@\n Libs: -L${libdir} -ltalloc\n Cflags: -I${includedir} \n URL: http://talloc.samba.org/\n\nModified: branches/SAMBA_3_0/source/lib/talloc/talloc_guide.txt\n===================================================================\n--- branches/SAMBA_3_0/source/lib/talloc/talloc_guide.txt\t2007-05-08 09:54:01 UTC (rev 22758)\n+++ branches/SAMBA_3_0/source/lib/talloc/talloc_guide.txt\t2007-05-08 11:12:11 UTC (rev 22759)\n@@ -12,7 +12,7 @@\n Samba4 talloc has been ported back to Samba3, so this guide applies to both.\n \n The new talloc is a hierarchical, reference counted memory pool system\n-with destructors. Quite a mounthful really, but not too bad once you\n+with destructors. Quite a mouthful really, but not too bad once you\n get used to it.\n \n Perhaps the biggest change from Samba3 is that there is no distinction\n@@ -533,21 +533,34 @@\n string. This is equivalent to:\n    talloc_set_name_const(ptr, ptr)\n \n+=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-\n+char *talloc_append_string(const void *t, char *orig, const char *append);\n \n+The talloc_append_string() function appends the given formatted\n+string to the given string.\n+\n+This function sets the name of the new pointer to the new\n+string. This is equivalent to:\n+   talloc_set_name_const(ptr, ptr)\n+\n =-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-\n char *talloc_vasprintf(const void *t, const char *fmt, va_list ap);\n \n The talloc_vasprintf() function is the talloc equivalent of the C\n library function vasprintf()\n \n+This functions sets the name of the new pointer to the new\n+string. This is equivalent to:\n+   talloc_set_name_const(ptr, ptr)\n \n+\n =-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-\n char *talloc_asprintf(const void *t, const char *fmt, ...);\n \n The talloc_asprintf() function is the talloc equivalent of the C\n library function asprintf()\n \n-This functions sets the name of the new pointer to the passed\n+This functions sets the name of the new pointer to the new\n string. This is equivalent to:\n    talloc_set_name_const(ptr, ptr)\n \n@@ -558,7 +571,11 @@\n The talloc_asprintf_append() function appends the given formatted \n string to the given string. \n \n+This functions sets the name of the new pointer to the new\n+string. This is equivalent to:\n+   talloc_set_name_const(ptr, ptr)\n \n+\n =-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-\n (type *)talloc_array(const void *ctx, type, uint_t count);\n \n\nModified: branches/SAMBA_3_0/source/lib/talloc/testsuite.c\n===================================================================\n--- branches/SAMBA_3_0/source/lib/talloc/testsuite.c\t2007-05-08 09:54:01 UTC (rev 22758)\n+++ branches/SAMBA_3_0/source/lib/talloc/testsuite.c\t2007-05-08 11:12:11 UTC (rev 22759)\n@@ -993,7 +993,7 @@\n \ts4 = talloc_array_ptrtype(top, s4, 10);location4 = __location__;\n \n \tif (talloc_get_size(s4) != (sizeof(struct struct1 **) * 10)) {\n-\t\tprintf(\"failure: TALLOC PTRTYPE [\\n\"\n+\t\tprintf(\"failure: ptrtype [\\n\"\n \t\t      \"talloc_array_ptrtype() allocated the wrong size \"\n \t\t       \"%lu (should be %lu)\\n]\\n\",\n \t\t\t   (unsigned long)talloc_get_size(s4),\n@@ -1010,6 +1010,45 @@\n \treturn true;\n }\n \n+static int _test_talloc_free_in_destructor(void **ptr)\n+{\n+\ttalloc_free(*ptr);\n+\treturn 0;\n+}\n+\n+static bool test_talloc_free_in_destructor(void)\n+{\n+\tvoid *level0;\n+\tvoid *level1;\n+\tvoid *level2;\n+\tvoid *level3;\n+\tvoid *level4;\n+\tvoid **level5;\n+\n+\tprintf(\"test: free_in_destructor [\\nTALLOC FREE IN DESTRUCTOR\\n]\\n\");\n+\n+\tlevel0 = talloc_new(NULL);\n+\tlevel1 = talloc_new(level0);\n+\tlevel2 = talloc_new(level1);\n+\tlevel3 = talloc_new(level2);\n+\tlevel4 = talloc_new(level3);\n+\tlevel5 = talloc(level4, void *);\n+\n+\t*level5 = level3;\n+\t(void)talloc_reference(level0, level3);\n+\t(void)talloc_reference(level3, level3);\n+\t(void)talloc_reference(level5, level3);\n+\n+\ttalloc_set_destructor(level5, _test_talloc_free_in_destructor);\n+\n+\ttalloc_free(level1);\n+\n+\ttalloc_free(level0);\n+\n+\tprintf(\"success: free_in_destructor\\n\");\n+\treturn true;\n+}\n+\n static bool test_autofree(void)\n {\n #if _SAMBA_BUILD_ < 4\n@@ -1055,6 +1094,7 @@\n \tret &= test_loop();\n \tret &= test_free_parent_deny_child(); \n \tret &= test_talloc_ptrtype();\n+\tret &= test_talloc_free_in_destructor();\n \n \tif (ret) {\n \t\tret &= test_speed();\n\n"}