{"category": "ham", "to_address": "samba-cvs@samba.org", "from_address": "jelmer@samba.org", "subject": "svn commit: samba r22137 - in branches/SAMBA_4_0: .\n\tsource/script/tests", "body": "Author: jelmer\nDate: 2007-04-09 12:15:56 +0000 (Mon, 09 Apr 2007)\nNew Revision: 22137\n\nWebSVN: http://websvn.samba.org/cgi-bin/viewcvs.cgi?view=rev&root=samba&rev=22137\n\nLog:\nActually use client.conf, defer more code as far as possible.\nModified:\n   branches/SAMBA_4_0/\n   branches/SAMBA_4_0/source/script/tests/mktestdc.sh\n   branches/SAMBA_4_0/source/script/tests/selftest.pl\n\n\nChangeset:\n\nProperty changes on: branches/SAMBA_4_0\n___________________________________________________________________\nName: bzr:merge\n...skipped...\n\nModified: branches/SAMBA_4_0/source/script/tests/mktestdc.sh\n===================================================================\n--- branches/SAMBA_4_0/source/script/tests/mktestdc.sh\t2007-04-09 12:06:42 UTC (rev 22136)\n+++ branches/SAMBA_4_0/source/script/tests/mktestdc.sh\t2007-04-09 12:15:56 UTC (rev 22137)\n@@ -83,7 +83,6 @@\n \tserver max protocol = SMB2\n \tnotify:inotify = false\n \tldb:nosync = true\n-\n \tsystem:anonymous = true\n #We don't want to pass our self-tests if the PAC code is wrong\n \tgensec:require_pac = true\n@@ -273,8 +272,6 @@\n \n echo \"KRB5_CONFIG=$KRB5_CONFIG\"\n echo \"PREFIX_ABS=$PREFIX_ABS\"\n-echo \"CONFIGURATION=$CONFIGURATION\"\n-echo \"CONFFILE=$CONFFILE\"\n echo \"SLAPD_CONF=$SLAPD_CONF\"\n echo \"PIDDIR=$PIDDIR\"\n echo \"AUTH=$AUTH\"\n@@ -290,7 +287,9 @@\n echo \"SRCDIR=$SRCDIR\"\n echo \"PREFIX=$PREFIX\"\n echo \"LDAPDIR=$LDAPDIR\"\n+echo \"CONFFILE=$CONFFILE\"\n echo \"PROVISION_OPTIONS=$PROVISION_OPTIONS\"\n echo \"PROVISION_ACI=$PROVISION_ACI\"\n echo \"WINBINDD_SOCKET_DIR=$WINBINDD_SOCKET_DIR\"\n echo \"NCALRPCDIR=$NCALRPCDIR\"\n+echo \"CONFIGURATION=$CONFIGURATION\"\n\nModified: branches/SAMBA_4_0/source/script/tests/selftest.pl\n===================================================================\n--- branches/SAMBA_4_0/source/script/tests/selftest.pl\t2007-04-09 12:06:42 UTC (rev 22136)\n+++ branches/SAMBA_4_0/source/script/tests/selftest.pl\t2007-04-09 12:15:56 UTC (rev 22137)\n@@ -427,15 +427,6 @@\n \tclose(SKIP);\n }\n \n-my $testenv_vars = $target->setup_env(\"dc\", \"$prefix/dc\", $socket_wrapper_dir);\n-\n-SocketWrapper::set_default_iface(6);\n-\n-foreach (\"PASSWORD\", \"DOMAIN\", \"SERVER\", \"CONFIGURATION\", \n-\t      \"USERNAME\", \"NETBIOSNAME\") {\n-\t$ENV{$_} = $testenv_vars->{$_};\n-}\n-\n my $interfaces = join(',', (\"127.0.0.6/8\", \n \t\t                 \"127.0.0.7/8\",\n \t\t\t\t\t\t \"127.0.0.8/8\",\n@@ -443,33 +434,36 @@\n \t\t\t\t\t\t \"127.0.0.10/8\",\n \t\t\t\t\t\t \"127.0.0.11/8\"));\n \n+my $testenv_vars = $target->setup_env(\"dc\", \"$prefix/dc\", $socket_wrapper_dir);\n \n-\n my $conffile = \"$prefix/client.conf\";\n+my $abs_srcdir = cwd();\n open(CF, \">$conffile\");\n print CF \"[global]\\n\";\n if (defined($ENV{VALGRIND})) {\n-\tprint CF \"iconv:native = true\\n\";\n+\tprint CF \"\\ticonv:native = true\\n\";\n } else {\n-\tprint CF \"iconv:native = false\\n\";\n+\tprint CF \"\\ticonv:native = false\\n\";\n }\n-print CF \"\n+print CF \n+\"\tnetbios name = localtest\n+\tnetbios aliases = localhost\n \tworkgroup = $testenv_vars->{DOMAIN}\n \trealm = $testenv_vars->{REALM}\n+\tpid directory = $testenv_vars->{PIDDIR}\n \tncalrpc dir = $testenv_vars->{NCALRPCDIR}\n-\tjs include = $srcdir/scripting/libjs\n+\tjs include = $abs_srcdir/scripting/libjs\n \twinbindd socket directory = $testenv_vars->{WINBINDD_SOCKET_DIR}\n \tname resolve order = bcast\n \tinterfaces = 127.0.0.1/8\n-\tpanic action = $srcdir/script/gdb_backtrace \\%PID\\% \\%PROG\\%\n+\tpanic action = $abs_srcdir/script/gdb_backtrace \\%PID\\% \\%PROG\\%\n \tmax xmit = 32K\n \tnotify:inotify = false\n \tldb:nosync = true\n \tsystem:anonymous = true\n #We don't want to pass our self-tests if the PAC code is wrong\n-\ttorture:basedir = st\n+\ttorture:basedir = ./st\n \tgensec:require_pac = true\n-\tpid directory = $testenv_vars->{PIDDIR}\n \";\n close(CF);\n \n@@ -486,9 +480,14 @@\n $ENV{TORTURE_OPTIONS} = join(' ', @torture_options);\n print \"OPTIONS $ENV{TORTURE_OPTIONS}\\n\";\n \n+foreach (\"PASSWORD\", \"DOMAIN\", \"SERVER\", \"USERNAME\", \"NETBIOSNAME\") {\n+\t$ENV{$_} = $testenv_vars->{$_};\n+}\n+\n my @todo = ();\n \n my $testsdir = \"$srcdir/script/tests\";\n+$ENV{CONFIGURATION} = \"--configfile=$conffile\";\n \n if ($opt_quick) {\n \topen(IN, \"$testsdir/tests_quick.sh|\");\n@@ -520,6 +519,8 @@\n \n $ENV{KRB5_CONFIG} = $testenv_vars->{KRB5_CONFIG};\n \n+SocketWrapper::set_default_iface(6);\n+\n if ($opt_testenv) {\n \t$ENV{PIDDIR} = $testenv_vars->{PIDDIR};\n \tmy $term = ($ENV{TERM} or \"xterm\");\n\n"}