{"category": "ham", "to_address": "samba-cvs@samba.org", "from_address": "gd@samba.org", "subject": "svn commit: samba r23587 - in branches: SAMBA_3_0/source/libsmb\n\tSAMBA_3_0_26/source/libsmb", "body": "Author: gd\nDate: 2007-06-22 14:50:15 +0000 (Fri, 22 Jun 2007)\nNew Revision: 23587\n\nWebSVN: http://websvn.samba.org/cgi-bin/viewcvs.cgi?view=rev&root=samba&rev=23587\n\nLog:\nCleanup redundant code in the krb5 renew function.\n\nGuenther\n\nModified:\n   branches/SAMBA_3_0/source/libsmb/clikrb5.c\n   branches/SAMBA_3_0_26/source/libsmb/clikrb5.c\n\n\nChangeset:\nModified: branches/SAMBA_3_0/source/libsmb/clikrb5.c\n===================================================================\n--- branches/SAMBA_3_0/source/libsmb/clikrb5.c\t2007-06-22 14:43:42 UTC (rev 23586)\n+++ branches/SAMBA_3_0/source/libsmb/clikrb5.c\t2007-06-22 14:50:15 UTC (rev 23587)\n@@ -1159,22 +1159,22 @@\n \t\tgoto done;\n \t}\n \n+\tif (client_string) {\n+\t\tret = smb_krb5_parse_name(context, client_string, &client);\n+\t\tif (ret) {\n+\t\t\tgoto done;\n+\t\t}\n+\t} else {\n+\t\tret = krb5_cc_get_principal(context, ccache, &client);\n+\t\tif (ret) {\n+\t\t\tgoto done;\n+\t\t}\n+\t}\n+\n #ifdef HAVE_KRB5_GET_RENEWED_CREDS\t/* MIT */\n \t{\n \t\tkrb5_creds creds;\n-\t\n-\t\tif (client_string) {\n-\t\t\tret = smb_krb5_parse_name(context, client_string, &client);\n-\t\t\tif (ret) {\n-\t\t\t\tgoto done;\n-\t\t\t}\n-\t\t} else {\n-\t\t\tret = krb5_cc_get_principal(context, ccache, &client);\n-\t\t\tif (ret) {\n-\t\t\t\tgoto done;\n-\t\t\t}\n-\t\t}\n-\t\n+\n \t\tret = krb5_get_renewed_creds(context, &creds, client, ccache, CONST_DISCARD(char *, service_string));\n \t\tif (ret) {\n \t\t\tDEBUG(10,(\"smb_krb5_renew_ticket: krb5_get_kdc_cred failed: %s\\n\", error_message(ret)));\n@@ -1204,16 +1204,9 @@\n \n \t\tmemset(&creds_in, 0, sizeof(creds_in));\n \n-\t\tif (client_string) {\n-\t\t\tret = smb_krb5_parse_name(context, client_string, &creds_in.client);\n-\t\t\tif (ret) {\n-\t\t\t\tgoto done;\n-\t\t\t}\n-\t\t} else {\n-\t\t\tret = krb5_cc_get_principal(context, ccache, &creds_in.client);\n-\t\t\tif (ret) {\n-\t\t\t\tgoto done;\n-\t\t\t}\n+\t\tret = krb5_copy_principal(context, client, &creds_in.client);\n+\t\tif (ret) {\n+\t\t\tgoto done;\n \t\t}\n \n \t\tif (service_string) {\n\nModified: branches/SAMBA_3_0_26/source/libsmb/clikrb5.c\n===================================================================\n--- branches/SAMBA_3_0_26/source/libsmb/clikrb5.c\t2007-06-22 14:43:42 UTC (rev 23586)\n+++ branches/SAMBA_3_0_26/source/libsmb/clikrb5.c\t2007-06-22 14:50:15 UTC (rev 23587)\n@@ -1159,22 +1159,22 @@\n \t\tgoto done;\n \t}\n \n+\tif (client_string) {\n+\t\tret = smb_krb5_parse_name(context, client_string, &client);\n+\t\tif (ret) {\n+\t\t\tgoto done;\n+\t\t}\n+\t} else {\n+\t\tret = krb5_cc_get_principal(context, ccache, &client);\n+\t\tif (ret) {\n+\t\t\tgoto done;\n+\t\t}\n+\t}\n+\n #ifdef HAVE_KRB5_GET_RENEWED_CREDS\t/* MIT */\n \t{\n \t\tkrb5_creds creds;\n-\t\n-\t\tif (client_string) {\n-\t\t\tret = smb_krb5_parse_name(context, client_string, &client);\n-\t\t\tif (ret) {\n-\t\t\t\tgoto done;\n-\t\t\t}\n-\t\t} else {\n-\t\t\tret = krb5_cc_get_principal(context, ccache, &client);\n-\t\t\tif (ret) {\n-\t\t\t\tgoto done;\n-\t\t\t}\n-\t\t}\n-\t\n+\n \t\tret = krb5_get_renewed_creds(context, &creds, client, ccache, CONST_DISCARD(char *, service_string));\n \t\tif (ret) {\n \t\t\tDEBUG(10,(\"smb_krb5_renew_ticket: krb5_get_kdc_cred failed: %s\\n\", error_message(ret)));\n@@ -1204,16 +1204,9 @@\n \n \t\tmemset(&creds_in, 0, sizeof(creds_in));\n \n-\t\tif (client_string) {\n-\t\t\tret = smb_krb5_parse_name(context, client_string, &creds_in.client);\n-\t\t\tif (ret) {\n-\t\t\t\tgoto done;\n-\t\t\t}\n-\t\t} else {\n-\t\t\tret = krb5_cc_get_principal(context, ccache, &creds_in.client);\n-\t\t\tif (ret) {\n-\t\t\t\tgoto done;\n-\t\t\t}\n+\t\tret = krb5_copy_principal(context, client, &creds_in.client);\n+\t\tif (ret) {\n+\t\t\tgoto done;\n \t\t}\n \n \t\tif (service_string) {\n\n"}