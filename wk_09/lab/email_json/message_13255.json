{"category": "ham", "to_address": "samba-cvs@samba.org", "from_address": "metze@samba.org", "subject": "svn commit: samba r22485 - in branches/SAMBA_4_0/source/librpc/rpc:\n\t.", "body": "Author: metze\nDate: 2007-04-23 10:39:20 +0000 (Mon, 23 Apr 2007)\nNew Revision: 22485\n\nWebSVN: http://websvn.samba.org/cgi-bin/viewcvs.cgi?view=rev&root=samba&rev=22485\n\nLog:\ndon't crash when the main dcerpc code haven't setup\ntransport.recv_data yet\n\nalso return always a usefull error\n\nmetze\nModified:\n   branches/SAMBA_4_0/source/librpc/rpc/dcerpc_smb.c\n   branches/SAMBA_4_0/source/librpc/rpc/dcerpc_smb2.c\n   branches/SAMBA_4_0/source/librpc/rpc/dcerpc_sock.c\n\n\nChangeset:\nModified: branches/SAMBA_4_0/source/librpc/rpc/dcerpc_smb.c\n===================================================================\n--- branches/SAMBA_4_0/source/librpc/rpc/dcerpc_smb.c\t2007-04-23 10:04:15 UTC (rev 22484)\n+++ branches/SAMBA_4_0/source/librpc/rpc/dcerpc_smb.c\t2007-04-23 10:39:20 UTC (rev 22485)\n@@ -39,7 +39,17 @@\n */\n static void pipe_dead(struct dcerpc_connection *c, NTSTATUS status)\n {\n-\tc->transport.recv_data(c, NULL, status);\n+\tif (NT_STATUS_EQUAL(NT_STATUS_UNSUCCESSFUL, status)) {\n+\t\tstatus = NT_STATUS_UNEXPECTED_NETWORK_ERROR;\n+\t}\n+\n+\tif (NT_STATUS_EQUAL(NT_STATUS_OK, status)) {\n+\t\tstatus = NT_STATUS_END_OF_FILE;\n+\t}\n+\n+\tif (c->transport.recv_data) {\n+\t\tc->transport.recv_data(c, NULL, status);\n+\t}\n }\n \n \n\nModified: branches/SAMBA_4_0/source/librpc/rpc/dcerpc_smb2.c\n===================================================================\n--- branches/SAMBA_4_0/source/librpc/rpc/dcerpc_smb2.c\t2007-04-23 10:04:15 UTC (rev 22484)\n+++ branches/SAMBA_4_0/source/librpc/rpc/dcerpc_smb2.c\t2007-04-23 10:39:20 UTC (rev 22485)\n@@ -41,7 +41,17 @@\n */\n static void pipe_dead(struct dcerpc_connection *c, NTSTATUS status)\n {\n-\tc->transport.recv_data(c, NULL, status);\n+\tif (NT_STATUS_EQUAL(NT_STATUS_UNSUCCESSFUL, status)) {\n+\t\tstatus = NT_STATUS_UNEXPECTED_NETWORK_ERROR;\n+\t}\n+\n+\tif (NT_STATUS_EQUAL(NT_STATUS_OK, status)) {\n+\t\tstatus = NT_STATUS_END_OF_FILE;\n+\t}\n+\n+\tif (c->transport.recv_data) {\n+\t\tc->transport.recv_data(c, NULL, status);\n+\t}\n }\n \n \n\nModified: branches/SAMBA_4_0/source/librpc/rpc/dcerpc_sock.c\n===================================================================\n--- branches/SAMBA_4_0/source/librpc/rpc/dcerpc_sock.c\t2007-04-23 10:04:15 UTC (rev 22484)\n+++ branches/SAMBA_4_0/source/librpc/rpc/dcerpc_sock.c\t2007-04-23 10:39:20 UTC (rev 22485)\n@@ -76,7 +76,7 @@\n \t\tstatus = NT_STATUS_END_OF_FILE;\n \t}\n \n-\tif (!NT_STATUS_IS_OK(status)) {\n+\tif (p->transport.recv_data) {\n \t\tp->transport.recv_data(p, NULL, status);\n \t}\n }\n\n"}