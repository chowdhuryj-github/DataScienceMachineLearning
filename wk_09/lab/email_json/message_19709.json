{"category": "ham", "to_address": "samba-cvs@samba.org", "from_address": "abartlet@samba.org", "subject": "svn commit: samba r22582 - in branches/SAMBA_4_0/source: auth\n\tlibrpc/idl winbind", "body": "Author: abartlet\nDate: 2007-04-29 21:40:48 +0000 (Sun, 29 Apr 2007)\nNew Revision: 22582\n\nWebSVN: http://websvn.samba.org/cgi-bin/viewcvs.cgi?view=rev&root=samba&rev=22582\n\nLog:\nCleanups towards making winbind work again.  We still have a long way to go, as this has bitrotted over the past months.\n\nThis change in particular catches winbind up with the next\ncomposite_create() function.\n\nWe also needed to remove an unused flags field, and fill in the lm\nresponse.\n\nAndrew Bartlett\n\nModified:\n   branches/SAMBA_4_0/source/auth/auth_winbind.c\n   branches/SAMBA_4_0/source/librpc/idl/winbind.idl\n   branches/SAMBA_4_0/source/winbind/wb_connect_lsa.c\n   branches/SAMBA_4_0/source/winbind/wb_connect_sam.c\n   branches/SAMBA_4_0/source/winbind/wb_dom_info.c\n   branches/SAMBA_4_0/source/winbind/wb_init_domain.c\n   branches/SAMBA_4_0/source/winbind/wb_pam_auth.c\n   branches/SAMBA_4_0/source/winbind/wb_sam_logon.c\n\n\nChangeset:\nModified: branches/SAMBA_4_0/source/auth/auth_winbind.c\n===================================================================\n--- branches/SAMBA_4_0/source/auth/auth_winbind.c\t2007-04-29 21:40:17 UTC (rev 22581)\n+++ branches/SAMBA_4_0/source/auth/auth_winbind.c\t2007-04-29 21:40:48 UTC (rev 22582)\n@@ -210,8 +210,8 @@\n \t\tnetwork_info->nt.length = user_info->password.response.nt.length;\n \t\tnetwork_info->nt.data\t= user_info->password.response.nt.data;\n \n-\t\tnetwork_info->nt.length = user_info->password.response.lanman.length;\n-\t\tnetwork_info->nt.data\t= user_info->password.response.lanman.data;\n+\t\tnetwork_info->lm.length = user_info->password.response.lanman.length;\n+\t\tnetwork_info->lm.data\t= user_info->password.response.lanman.data;\n \n \t\tidentity_info = &network_info->identity_info;\n \t\ts->req.in.logon_level\t= 2;\n@@ -226,6 +226,9 @@\n \tidentity_info->workstation.string\t= user_info->workstation_name;\n \n \ts->req.in.validation_level\t= 3;\n+\n+\tNDR_PRINT_IN_DEBUG(winbind_SamLogon, &s->req);\n+\n \tstatus = IRPC_CALL(ctx->auth_ctx->msg_ctx, winbind_servers[0],\n \t\t\t   winbind, WINBIND_SAMLOGON,\n \t\t\t   &s->req, s);\n\nModified: branches/SAMBA_4_0/source/librpc/idl/winbind.idl\n===================================================================\n--- branches/SAMBA_4_0/source/librpc/idl/winbind.idl\t2007-04-29 21:40:17 UTC (rev 22581)\n+++ branches/SAMBA_4_0/source/librpc/idl/winbind.idl\t2007-04-29 21:40:48 UTC (rev 22582)\n@@ -33,7 +33,6 @@\n \t\t[in]  [switch_is(logon_level)] netr_LogonLevel logon,\n \t\t[in]  uint16 validation_level,\n \t\t[out] [switch_is(validation_level)] netr_Validation validation,\n-\t\t[out] uint8 authoritative,\n-\t\t[in,out] uint32 flags\n+\t\t[out] uint8 authoritative\n \t);\n }\n\nModified: branches/SAMBA_4_0/source/winbind/wb_connect_lsa.c\n===================================================================\n--- branches/SAMBA_4_0/source/winbind/wb_connect_lsa.c\t2007-04-29 21:40:17 UTC (rev 22581)\n+++ branches/SAMBA_4_0/source/winbind/wb_connect_lsa.c\t2007-04-29 21:40:48 UTC (rev 22582)\n@@ -55,11 +55,8 @@\n \tstruct composite_context *result, *ctx;\n \tstruct init_lsa_state *state;\n \n-\tresult = talloc(mem_ctx, struct composite_context);\n+\tresult = composite_create(mem_ctx, tree->session->transport->socket->event.ctx);\n \tif (result == NULL) goto failed;\n-\tresult->state = COMPOSITE_STATE_IN_PROGRESS;\n-\tresult->async.fn = NULL;\n-\tresult->event_ctx = tree->session->transport->socket->event.ctx;\n \n \tstate = talloc(result, struct init_lsa_state);\n \tif (state == NULL) goto failed;\n@@ -237,11 +234,8 @@\n \tstruct composite_context *result, *ctx;\n \tstruct connect_lsa_state *state;\n \n-\tresult = talloc(mem_ctx, struct composite_context);\n+\tresult = composite_create(mem_ctx, tree->session->transport->socket->event.ctx);\n \tif (result == NULL) goto failed;\n-\tresult->state = COMPOSITE_STATE_IN_PROGRESS;\n-\tresult->async.fn = NULL;\n-\tresult->event_ctx = tree->session->transport->socket->event.ctx;\n \n \tstate = talloc(result, struct connect_lsa_state);\n \tif (state == NULL) goto failed;\n\nModified: branches/SAMBA_4_0/source/winbind/wb_connect_sam.c\n===================================================================\n--- branches/SAMBA_4_0/source/winbind/wb_connect_sam.c\t2007-04-29 21:40:17 UTC (rev 22581)\n+++ branches/SAMBA_4_0/source/winbind/wb_connect_sam.c\t2007-04-29 21:40:48 UTC (rev 22582)\n@@ -61,11 +61,8 @@\n \tstruct composite_context *result, *ctx;\n \tstruct connect_samr_state *state;\n \n-\tresult = talloc(mem_ctx, struct composite_context);\n+\tresult = composite_create(mem_ctx, tree->session->transport->socket->event.ctx);\n \tif (result == NULL) goto failed;\n-\tresult->state = COMPOSITE_STATE_IN_PROGRESS;\n-\tresult->async.fn = NULL;\n-\tresult->event_ctx = tree->session->transport->socket->event.ctx;\n \n \tstate = talloc(result, struct connect_samr_state);\n \tif (state == NULL) goto failed;\n\nModified: branches/SAMBA_4_0/source/winbind/wb_dom_info.c\n===================================================================\n--- branches/SAMBA_4_0/source/winbind/wb_dom_info.c\t2007-04-29 21:40:17 UTC (rev 22581)\n+++ branches/SAMBA_4_0/source/winbind/wb_dom_info.c\t2007-04-29 21:40:48 UTC (rev 22582)\n@@ -50,11 +50,8 @@\n \tstruct get_dom_info_state *state;\n \tstruct nbt_name name;\n \n-\tresult = talloc(mem_ctx, struct composite_context);\n+\tresult = composite_create(mem_ctx, service->task->event_ctx);\n \tif (result == NULL) goto failed;\n-\tresult->state = COMPOSITE_STATE_IN_PROGRESS;\n-\tresult->async.fn = NULL;\n-\tresult->event_ctx = service->task->event_ctx;\n \n \tstate = talloc(result, struct get_dom_info_state);\n \tif (state == NULL) goto failed;\n\nModified: branches/SAMBA_4_0/source/winbind/wb_init_domain.c\n===================================================================\n--- branches/SAMBA_4_0/source/winbind/wb_init_domain.c\t2007-04-29 21:40:17 UTC (rev 22581)\n+++ branches/SAMBA_4_0/source/winbind/wb_init_domain.c\t2007-04-29 21:40:48 UTC (rev 22582)\n@@ -85,11 +85,8 @@\n \tstruct composite_context *result, *ctx;\n \tstruct init_domain_state *state;\n \n-\tresult = talloc(mem_ctx, struct composite_context);\n+\tresult = composite_create(mem_ctx, service->task->event_ctx);\n \tif (result == NULL) goto failed;\n-\tresult->state = COMPOSITE_STATE_IN_PROGRESS;\n-\tresult->async.fn = NULL;\n-\tresult->event_ctx = service->task->event_ctx;\n \n \tstate = talloc_zero(result, struct init_domain_state);\n \tif (state == NULL) goto failed;\n\nModified: branches/SAMBA_4_0/source/winbind/wb_pam_auth.c\n===================================================================\n--- branches/SAMBA_4_0/source/winbind/wb_pam_auth.c\t2007-04-29 21:40:17 UTC (rev 22581)\n+++ branches/SAMBA_4_0/source/winbind/wb_pam_auth.c\t2007-04-29 21:40:48 UTC (rev 22582)\n@@ -267,6 +267,8 @@\n \tcomposite_done(state->ctx);\n }\n \n+/* Having received a NTLM authentication reply, parse out the useful\n+ * reply data for the caller */\n NTSTATUS wb_cmd_pam_auth_crap_recv(struct composite_context *c,\n \t\t\t\t   TALLOC_CTX *mem_ctx,\n \t\t\t\t   DATA_BLOB *info3,\n@@ -288,25 +290,8 @@\n \treturn status;\n }\n \n-NTSTATUS wb_cmd_pam_auth_crap(TALLOC_CTX *mem_ctx,\n-\t\t\t      struct wbsrv_service *service,\n-\t\t\t      uint32_t logon_parameters,\n-\t\t\t      const char *domain, const char *user,\n-\t\t\t      const char *workstation,\n-\t\t\t      DATA_BLOB chal, DATA_BLOB nt_resp,\n-\t\t\t      DATA_BLOB lm_resp,\n-\t\t\t      DATA_BLOB *info3,\n-\t\t\t      struct netr_UserSessionKey *user_session_key,\n-\t\t\t      struct netr_LMSessionKey *lm_key,\n-\t\t\t      char **unix_username)\n-{\n-\tstruct composite_context *c =\n-\t\twb_cmd_pam_auth_crap_send(mem_ctx, service, logon_parameters, \n-\t\t\t\t\t  domain, user, workstation,\n-\t\t\t\t\t  chal, nt_resp, lm_resp);\n-\treturn wb_cmd_pam_auth_crap_recv(c, mem_ctx, info3, user_session_key,\n-\t\t\t\t\t lm_key, unix_username);\n-}\n+/* Handle plaintext authentication, by encrypting the password and\n+ * then sending via the NTLM calls */\n \n struct composite_context *wb_cmd_pam_auth_send(TALLOC_CTX *mem_ctx,\n \t\t\t\t\t       struct wbsrv_service *service,\n@@ -371,18 +356,9 @@\n \n NTSTATUS wb_cmd_pam_auth_recv(struct composite_context *c)\n {\n-\tstruct pam_auth_crap_state *state =\n-\t\ttalloc_get_type(c->private_data, struct pam_auth_crap_state);\n-\tNTSTATUS status = composite_wait(c);\n-\ttalloc_free(state);\n-\treturn status;\n+       struct pam_auth_crap_state *state =\n+               talloc_get_type(c->private_data, struct pam_auth_crap_state);\n+       NTSTATUS status = composite_wait(c);\n+       talloc_free(state);\n+       return status;\n }\n-\n-NTSTATUS wb_cmd_pam_auth(TALLOC_CTX *mem_ctx, struct wbsrv_service *service,\n-\t\t\t const char *domain, const char *user,\n-\t\t\t const char *password)\n-{\n-\tstruct composite_context *c =\n-\t\twb_cmd_pam_auth_send(mem_ctx, service, domain, user, password);\n-\treturn wb_cmd_pam_auth_recv(c);\n-}\n\nModified: branches/SAMBA_4_0/source/winbind/wb_sam_logon.c\n===================================================================\n--- branches/SAMBA_4_0/source/winbind/wb_sam_logon.c\t2007-04-29 21:40:17 UTC (rev 22581)\n+++ branches/SAMBA_4_0/source/winbind/wb_sam_logon.c\t2007-04-29 21:40:48 UTC (rev 22582)\n@@ -160,7 +160,6 @@\n \t\ttalloc_steal(mem_ctx, s->r_mem_ctx);\n \t\treq->out.validation\t= s->r.out.validation;\n \t\treq->out.authoritative\t= 1;\n-\t\treq->out.flags\t\t= 0;\n \t}\n \n \ttalloc_free(s);\n\n"}