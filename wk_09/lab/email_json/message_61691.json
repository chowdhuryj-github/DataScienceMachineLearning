{"category": "ham", "to_address": "samba-cvs@samba.org", "from_address": "abartlet@samba.org", "subject": "svn commit: samba r23693 - in branches/SAMBA_4_0/source/selftest: .", "body": "Author: abartlet\nDate: 2007-07-04 00:34:16 +0000 (Wed, 04 Jul 2007)\nNew Revision: 23693\n\nWebSVN: http://websvn.samba.org/cgi-bin/viewcvs.cgi?view=rev&root=samba&rev=23693\n\nLog:\nGive the process a chance to write out it's coverage data, before we\nblast a kill -9 at it.\n\nAndrew Bartlett\n\nModified:\n   branches/SAMBA_4_0/source/selftest/Samba4.pm\n\n\nChangeset:\nModified: branches/SAMBA_4_0/source/selftest/Samba4.pm\n===================================================================\n--- branches/SAMBA_4_0/source/selftest/Samba4.pm\t2007-07-03 23:48:02 UTC (rev 23692)\n+++ branches/SAMBA_4_0/source/selftest/Samba4.pm\t2007-07-04 00:34:16 UTC (rev 23693)\n@@ -514,19 +514,34 @@\n sub teardown_env($$)\n {\n \tmy ($self, $envvars) = @_;\n+\tmy $pid;\n \n \tclose(DATA);\n \n-\tsleep(2);\n-\n-\tmy $failed = $? >> 8;\n-\n \tif (-f \"$envvars->{PIDDIR}/smbd.pid\" ) {\n \t\topen(IN, \"<$envvars->{PIDDIR}/smbd.pid\") or die(\"unable to open smbd pid file\");\n-\t\tkill 9, ;\n+\t\t$pid = ;\n \t\tclose(IN);\n+\n+\t\t# Give the process 20 seconds to exit.  gcov needs\n+\t\t# this time to write out the covarge data\n+\t\tmy $count = 0;\n+\t\tuntil (kill(0, $pid) == 0) {\n+\t\t    # if no process sucessfully signalled, then we are done\n+\t\t    sleep(1);\n+\t\t    $count++;\n+\t\t    last if $count > 20;\n+\t\t}\n+\t\t\n+\t\t# If it is still around, kill it\n+\t\tif ($count > 20) {\n+\t\t    print \"smbd process $pid took more than $count seconds to exit, killing\\n\";\n+\t\t    kill 9, $pid;\n+\t\t}\n \t}\n \n+\tmy $failed = $? >> 8;\n+\n \t$self->slapd_stop($envvars) if ($self->{ldap});\n \n \tprint $self->getlog_env($envvars);\n\n"}