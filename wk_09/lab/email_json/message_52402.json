{"category": "ham", "to_address": "samba-cvs@samba.org", "from_address": "obnox@samba.org", "subject": "svn commit: samba r23578 - in branches: SAMBA_3_0/source/registry\n\tSAMBA_3_0_26/source/registry", "body": "Author: obnox\nDate: 2007-06-21 22:18:42 +0000 (Thu, 21 Jun 2007)\nNew Revision: 23578\n\nWebSVN: http://websvn.samba.org/cgi-bin/viewcvs.cgi?view=rev&root=samba&rev=23578\n\nLog:\nWhen calling DeleteKey for a key that has subkey(s), Windows\nreturns WERR_ACCESS_DENIED. This adapts reg_deletekey to behave \nthe same way. \n\nMichael\n\n\nModified:\n   branches/SAMBA_3_0/source/registry/reg_api.c\n   branches/SAMBA_3_0_26/source/registry/reg_api.c\n\n\nChangeset:\nModified: branches/SAMBA_3_0/source/registry/reg_api.c\n===================================================================\n--- branches/SAMBA_3_0/source/registry/reg_api.c\t2007-06-21 22:10:41 UTC (rev 23577)\n+++ branches/SAMBA_3_0/source/registry/reg_api.c\t2007-06-21 22:18:42 UTC (rev 23578)\n@@ -386,6 +386,7 @@\n \tTALLOC_CTX *mem_ctx;\n \tchar *name, *end;\n \tint num_subkeys;\n+\tstruct registry_key *tmp_key;\n \n \tif (!(mem_ctx = talloc_init(\"reg_createkey\"))) return WERR_NOMEM;\n \n@@ -394,18 +395,30 @@\n \t\tgoto error;\n \t}\n \n+\t/* check if the key has subkeys */\n+\terr = reg_openkey(mem_ctx, parent, name, REG_KEY_READ, &tmp_key);\n+\tif (!W_ERROR_IS_OK(err)) {\n+\t\tgoto error;\n+\t}\n+\tif (!W_ERROR_IS_OK(err = fill_subkey_cache(tmp_key))) {\n+\t\tgoto error;\n+\t}\n+\tif (tmp_key->subkeys->num_subkeys > 0) {\n+\t\terr = WERR_ACCESS_DENIED;\n+\t\tgoto error;\n+\t}\n+\n+\t/* no subkeys - proceed with delete */\n \tif ((end = strrchr(name, '\\\\')) != NULL) {\n-\t\tstruct registry_key *tmp;\n-\n \t\t*end = '\\0';\n \n \t\terr = reg_openkey(mem_ctx, parent, name,\n-\t\t\t\t  SEC_RIGHTS_CREATE_SUBKEY, &tmp);\n+\t\t\t\t  SEC_RIGHTS_CREATE_SUBKEY, &tmp_key);\n \t\tif (!W_ERROR_IS_OK(err)) {\n \t\t\tgoto error;\n \t\t}\n \n-\t\tparent = tmp;\n+\t\tparent = tmp_key;\n \t\tname = end+1;\n \t}\n \n\nModified: branches/SAMBA_3_0_26/source/registry/reg_api.c\n===================================================================\n--- branches/SAMBA_3_0_26/source/registry/reg_api.c\t2007-06-21 22:10:41 UTC (rev 23577)\n+++ branches/SAMBA_3_0_26/source/registry/reg_api.c\t2007-06-21 22:18:42 UTC (rev 23578)\n@@ -386,6 +386,7 @@\n \tTALLOC_CTX *mem_ctx;\n \tchar *name, *end;\n \tint num_subkeys;\n+\tstruct registry_key *tmp_key;\n \n \tif (!(mem_ctx = talloc_init(\"reg_createkey\"))) return WERR_NOMEM;\n \n@@ -394,18 +395,30 @@\n \t\tgoto error;\n \t}\n \n+\t/* check if the key has subkeys */\n+\terr = reg_openkey(mem_ctx, parent, name, REG_KEY_READ, &tmp_key);\n+\tif (!W_ERROR_IS_OK(err)) {\n+\t\tgoto error;\n+\t}\n+\tif (!W_ERROR_IS_OK(err = fill_subkey_cache(tmp_key))) {\n+\t\tgoto error;\n+\t}\n+\tif (tmp_key->subkeys->num_subkeys > 0) {\n+\t\terr = WERR_ACCESS_DENIED;\n+\t\tgoto error;\n+\t}\n+\n+\t/* no subkeys - proceed with delete */\n \tif ((end = strrchr(name, '\\\\')) != NULL) {\n-\t\tstruct registry_key *tmp;\n-\n \t\t*end = '\\0';\n \n \t\terr = reg_openkey(mem_ctx, parent, name,\n-\t\t\t\t  SEC_RIGHTS_CREATE_SUBKEY, &tmp);\n+\t\t\t\t  SEC_RIGHTS_CREATE_SUBKEY, &tmp_key);\n \t\tif (!W_ERROR_IS_OK(err)) {\n \t\t\tgoto error;\n \t\t}\n \n-\t\tparent = tmp;\n+\t\tparent = tmp_key;\n \t\tname = end+1;\n \t}\n \n\n"}