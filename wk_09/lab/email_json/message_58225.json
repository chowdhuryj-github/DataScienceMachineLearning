{"category": "ham", "to_address": "samba-cvs@samba.org", "from_address": "obnox@samba.org", "subject": "svn commit: samba r23656 - in branches: SAMBA_3_0/source/param\n\tSAMBA_3_0/source/utils SAMBA_3_0_26/source/param\n\tSAMBA_3_0_26/source/utils", "body": "Author: obnox\nDate: 2007-06-29 12:30:41 +0000 (Fri, 29 Jun 2007)\nNew Revision: 23656\n\nWebSVN: http://websvn.samba.org/cgi-bin/viewcvs.cgi?view=rev&root=samba&rev=23656\n\nLog:\nAdd initial checking of the validity of a paramter\ngiven to \"net conf setparm\". Add a utility function\nlp_parameter_valid() for this to loadparm.c.\n\nMichael\n\n\nModified:\n   branches/SAMBA_3_0/source/param/loadparm.c\n   branches/SAMBA_3_0/source/utils/net_conf.c\n   branches/SAMBA_3_0_26/source/param/loadparm.c\n   branches/SAMBA_3_0_26/source/utils/net_conf.c\n\n\nChangeset:\nModified: branches/SAMBA_3_0/source/param/loadparm.c\n===================================================================\n--- branches/SAMBA_3_0/source/param/loadparm.c\t2007-06-29 12:15:41 UTC (rev 23655)\n+++ branches/SAMBA_3_0/source/param/loadparm.c\t2007-06-29 12:30:41 UTC (rev 23656)\n@@ -2776,7 +2776,19 @@\n \treturn (True);\n }\n \n+\n /***************************************************************************\n+ Check whether the given parameter name is valid.\n+ Parametric options (names containing a colon) are considered valid.\n+***************************************************************************/\n+\n+BOOL lp_parameter_valid(const char *pszParmName)\n+{\n+\treturn ((map_parameter(pszParmName) != -1) ||\n+\t\t(strchr(pszParmName, ':') != NULL));\n+}\n+\n+/***************************************************************************\n  Map a parameter's string representation to something we can use. \n  Returns False if the parameter string is not recognised, else TRUE.\n ***************************************************************************/\n\nModified: branches/SAMBA_3_0/source/utils/net_conf.c\n===================================================================\n--- branches/SAMBA_3_0/source/utils/net_conf.c\t2007-06-29 12:15:41 UTC (rev 23655)\n+++ branches/SAMBA_3_0/source/utils/net_conf.c\t2007-06-29 12:30:41 UTC (rev 23656)\n@@ -167,9 +167,23 @@\n \telse {\n \t\td_fprintf(stderr, \"Only value types DWORD and SZ are\"\n \t\t\t  \"currently implemented for setting values.\\n\");\n+\t\twerr = WERR_INVALID_PARAM;\n \t\tgoto done;\n \t}\n \n+\tif (!lp_parameter_valid(valname)) {\n+\t\td_fprintf(stderr, \"Invalid parameter '%s' given.\\n\", valname);\n+\t\twerr = WERR_INVALID_PARAM;\n+\t\tgoto done;\n+\t}\n+\n+\tif (registry_smbconf_valname_forbidden(valname)) {\n+\t\td_fprintf(stderr, \"Parameter '%s' not allowed in registry.\\n\", \n+\t\t\t  valname);\n+\t\twerr = WERR_INVALID_PARAM;\n+\t\tgoto done;\n+\t}\n+\n \twerr = reg_setvalue(key, valname, &val);\n \tif (!W_ERROR_IS_OK(werr)) {\n \t\td_fprintf(stderr,\n\nModified: branches/SAMBA_3_0_26/source/param/loadparm.c\n===================================================================\n--- branches/SAMBA_3_0_26/source/param/loadparm.c\t2007-06-29 12:15:41 UTC (rev 23655)\n+++ branches/SAMBA_3_0_26/source/param/loadparm.c\t2007-06-29 12:30:41 UTC (rev 23656)\n@@ -2777,7 +2777,19 @@\n \treturn (True);\n }\n \n+\n /***************************************************************************\n+ Check whether the given parameter name is valid.\n+ Parametric options (names containing a colon) are considered valid.\n+***************************************************************************/\n+\n+BOOL lp_parameter_valid(const char *pszParmName)\n+{\n+\treturn ((map_parameter(pszParmName) != -1) ||\n+\t\t(strchr(pszParmName, ':') != NULL));\n+}\n+\n+/***************************************************************************\n  Map a parameter's string representation to something we can use. \n  Returns False if the parameter string is not recognised, else TRUE.\n ***************************************************************************/\n\nModified: branches/SAMBA_3_0_26/source/utils/net_conf.c\n===================================================================\n--- branches/SAMBA_3_0_26/source/utils/net_conf.c\t2007-06-29 12:15:41 UTC (rev 23655)\n+++ branches/SAMBA_3_0_26/source/utils/net_conf.c\t2007-06-29 12:30:41 UTC (rev 23656)\n@@ -167,9 +167,23 @@\n \telse {\n \t\td_fprintf(stderr, \"Only value types DWORD and SZ are\"\n \t\t\t  \"currently implemented for setting values.\\n\");\n+\t\twerr = WERR_INVALID_PARAM;\n \t\tgoto done;\n \t}\n \n+\tif (!lp_parameter_valid(valname)) {\n+\t\td_fprintf(stderr, \"Invalid parameter '%s' given.\\n\", valname);\n+\t\twerr = WERR_INVALID_PARAM;\n+\t\tgoto done;\n+\t}\n+\n+\tif (registry_smbconf_valname_forbidden(valname)) {\n+\t\td_fprintf(stderr, \"Parameter '%s' not allowed in registry.\\n\", \n+\t\t\t  valname);\n+\t\twerr = WERR_INVALID_PARAM;\n+\t\tgoto done;\n+\t}\n+\n \twerr = reg_setvalue(key, valname, &val);\n \tif (!W_ERROR_IS_OK(werr)) {\n \t\td_fprintf(stderr,\n\n"}