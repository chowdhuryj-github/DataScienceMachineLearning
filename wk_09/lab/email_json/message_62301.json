{"category": "ham", "to_address": "samba-cvs@samba.org", "from_address": "lmuelle@samba.org", "subject": "svn commit: samba r23707 - in branches: SAMBA_3_0/source/nsswitch\n\tSAMBA_3_0_26/source/nsswitch", "body": "Author: lmuelle\nDate: 2007-07-04 19:52:51 +0000 (Wed, 04 Jul 2007)\nNew Revision: 23707\n\nWebSVN: http://websvn.samba.org/cgi-bin/viewcvs.cgi?view=rev&root=samba&rev=23707\n\nLog:\n- Move the asprintf() call to create the key even in\n  get_conf_item_string() to the later if statement.\n- Also move the key definition to the later if statement in\n  get_conf_item_string() and get_conf_item_int().\n\nModified:\n   branches/SAMBA_3_0/source/nsswitch/pam_winbind.c\n   branches/SAMBA_3_0_26/source/nsswitch/pam_winbind.c\n\n\nChangeset:\nModified: branches/SAMBA_3_0/source/nsswitch/pam_winbind.c\n===================================================================\n--- branches/SAMBA_3_0/source/nsswitch/pam_winbind.c\t2007-07-04 16:17:48 UTC (rev 23706)\n+++ branches/SAMBA_3_0/source/nsswitch/pam_winbind.c\t2007-07-04 19:52:51 UTC (rev 23707)\n@@ -1491,24 +1491,12 @@\n {\n \tint i = 0;\n \tconst char *parm_opt = NULL;\n-\tchar *key = NULL;\n \n \tif (!(ctrl & config_flag)) {\n \t\tgoto out;\n \t}\n \n \t/* let the pam opt take precedence over the pam_winbind.conf option */\n-\n-\tif (d != NULL) {\n-\n-\t\tif (!asprintf(&key, \"global:%s\", item)) {\n-\t\t\tgoto out;\n-\t\t}\n-\n-\t\tparm_opt = iniparser_getstr(d, key);\n-\t\tSAFE_FREE(key);\n-\t}\n-\n \tfor ( i=0; i<argc; i++ ) {\n \n \t\tif ((strncmp(argv[i], item, strlen(item)) == 0)) {\n@@ -1524,6 +1512,15 @@\n \t}\n \n \tif (d != NULL) {\n+\t\tchar *key = NULL;\n+\n+\t\tif (!asprintf(&key, \"global:%s\", item)) {\n+\t\t\tgoto out;\n+\t\t}\n+\n+\t\tparm_opt = iniparser_getstr(d, key);\n+\t\tSAFE_FREE(key);\n+\n \t\t_pam_log_debug(pamh, ctrl, LOG_INFO, \"CONFIG file: %s '%s'\\n\", item, parm_opt);\n \t}\n out:\n@@ -1537,8 +1534,7 @@\n \t\t\t      dictionary *d,\n \t\t\t      const char *item)\n {\n-\tint parm_opt = -1, i = 0;\n-\tchar *key = NULL;\n+\tint i, parm_opt = -1;\n \n \t/* let the pam opt take precedence over the pam_winbind.conf option */\n \tfor (i = 0; i < argc; i++) {\n@@ -1561,6 +1557,8 @@\n \t}\n \n \tif (d != NULL) {\n+\t\tchar *key = NULL;\n+\n \t\tif (!asprintf(&key, \"global:%s\", item)) {\n \t\t\tgoto out;\n \t\t}\n\nModified: branches/SAMBA_3_0_26/source/nsswitch/pam_winbind.c\n===================================================================\n--- branches/SAMBA_3_0_26/source/nsswitch/pam_winbind.c\t2007-07-04 16:17:48 UTC (rev 23706)\n+++ branches/SAMBA_3_0_26/source/nsswitch/pam_winbind.c\t2007-07-04 19:52:51 UTC (rev 23707)\n@@ -1491,24 +1491,12 @@\n {\n \tint i = 0;\n \tconst char *parm_opt = NULL;\n-\tchar *key = NULL;\n \n \tif (!(ctrl & config_flag)) {\n \t\tgoto out;\n \t}\n \n \t/* let the pam opt take precedence over the pam_winbind.conf option */\n-\n-\tif (d != NULL) {\n-\n-\t\tif (!asprintf(&key, \"global:%s\", item)) {\n-\t\t\tgoto out;\n-\t\t}\n-\n-\t\tparm_opt = iniparser_getstr(d, key);\n-\t\tSAFE_FREE(key);\n-\t}\n-\n \tfor ( i=0; i<argc; i++ ) {\n \n \t\tif ((strncmp(argv[i], item, strlen(item)) == 0)) {\n@@ -1524,6 +1512,15 @@\n \t}\n \n \tif (d != NULL) {\n+\t\tchar *key = NULL;\n+\n+\t\tif (!asprintf(&key, \"global:%s\", item)) {\n+\t\t\tgoto out;\n+\t\t}\n+\n+\t\tparm_opt = iniparser_getstr(d, key);\n+\t\tSAFE_FREE(key);\n+\n \t\t_pam_log_debug(pamh, ctrl, LOG_INFO, \"CONFIG file: %s '%s'\\n\", item, parm_opt);\n \t}\n out:\n@@ -1537,8 +1534,7 @@\n \t\t\t      dictionary *d,\n \t\t\t      const char *item)\n {\n-\tint parm_opt = -1, i = 0;\n-\tchar *key = NULL;\n+\tint i, parm_opt = -1;\n \n \t/* let the pam opt take precedence over the pam_winbind.conf option */\n \tfor (i = 0; i < argc; i++) {\n@@ -1561,6 +1557,8 @@\n \t}\n \n \tif (d != NULL) {\n+\t\tchar *key = NULL;\n+\n \t\tif (!asprintf(&key, \"global:%s\", item)) {\n \t\t\tgoto out;\n \t\t}\n\n"}