{"category": "ham", "to_address": "samba-cvs@samba.org", "from_address": "abartlet@samba.org", "subject": "svn commit: samba r23680 - in branches/SAMBA_4_0/source: auth\n\tauth/ntlmssp param rpc_server/netlogon scripting/ejs selftest\n\tsmb_server/smb", "body": "Author: abartlet\nDate: 2007-07-03 08:05:55 +0000 (Tue, 03 Jul 2007)\nNew Revision: 23680\n\nWebSVN: http://websvn.samba.org/cgi-bin/viewcvs.cgi?view=rev&root=samba&rev=23680\n\nLog:\nMake it easier to setup a domain member server - the 'server role'\nwill now control the auth methods, but an override is still available,\nex:\n\nauth methods:domain controller = \n\nAndrew Bartlett\n\nModified:\n   branches/SAMBA_4_0/source/auth/auth.c\n   branches/SAMBA_4_0/source/auth/auth_simple.c\n   branches/SAMBA_4_0/source/auth/ntlmssp/ntlmssp_server.c\n   branches/SAMBA_4_0/source/param/loadparm.c\n   branches/SAMBA_4_0/source/rpc_server/netlogon/dcerpc_netlogon.c\n   branches/SAMBA_4_0/source/scripting/ejs/smbcalls_auth.c\n   branches/SAMBA_4_0/source/selftest/Samba4.pm\n   branches/SAMBA_4_0/source/smb_server/smb/negprot.c\n   branches/SAMBA_4_0/source/smb_server/smb/sesssetup.c\n\n\nChangeset:\nModified: branches/SAMBA_4_0/source/auth/auth.c\n===================================================================\n--- branches/SAMBA_4_0/source/auth/auth.c\t2007-07-03 08:01:34 UTC (rev 23679)\n+++ branches/SAMBA_4_0/source/auth/auth.c\t2007-07-03 08:05:55 UTC (rev 23680)\n@@ -348,11 +348,12 @@\n \n /***************************************************************************\n  Make a auth_info struct for the auth subsystem\n+ - Allow the caller to specify the methods to use\n ***************************************************************************/\n-NTSTATUS auth_context_create(TALLOC_CTX *mem_ctx, const char **methods, \n-\t\t\t     struct event_context *ev,\n-\t\t\t     struct messaging_context *msg,\n-\t\t\t     struct auth_context **auth_ctx)\n+NTSTATUS auth_context_create_methods(TALLOC_CTX *mem_ctx, const char **methods, \n+\t\t\t\t     struct event_context *ev,\n+\t\t\t\t     struct messaging_context *msg,\n+\t\t\t\t     struct auth_context **auth_ctx)\n {\n \tint i;\n \tstruct auth_context *ctx;\n@@ -406,7 +407,31 @@\n \n \treturn NT_STATUS_OK;\n }\n+/***************************************************************************\n+ Make a auth_info struct for the auth subsystem\n+ - Uses default auth_methods, depending on server role and smb.conf settings\n+***************************************************************************/\n+NTSTATUS auth_context_create(TALLOC_CTX *mem_ctx, \n+\t\t\t     struct event_context *ev,\n+\t\t\t     struct messaging_context *msg,\n+\t\t\t     struct auth_context **auth_ctx)\n+{\n+\tconst char **auth_methods = NULL;\n+\tswitch (lp_server_role()) {\n+\tcase ROLE_STANDALONE:\n+\t\tauth_methods = lp_parm_string_list(-1, \"auth methods\", \"standalone\", NULL);\n+\t\tbreak;\n+\tcase ROLE_DOMAIN_MEMBER:\n+\t\tauth_methods = lp_parm_string_list(-1, \"auth methods\", \"member server\", NULL);\n+\t\tbreak;\n+\tcase ROLE_DOMAIN_CONTROLLER:\n+\t\tauth_methods = lp_parm_string_list(-1, \"auth methods\", \"domain controller\", NULL);\n+\t\tbreak;\n+\t}\n+\treturn auth_context_create_methods(mem_ctx, auth_methods, ev, msg, auth_ctx);\n+}\n \n+\n /* the list of currently registered AUTH backends */\n static struct auth_backend {\n \tconst struct auth_operations *ops;\n\nModified: branches/SAMBA_4_0/source/auth/auth_simple.c\n===================================================================\n--- branches/SAMBA_4_0/source/auth/auth_simple.c\t2007-07-03 08:01:34 UTC (rev 23679)\n+++ branches/SAMBA_4_0/source/auth/auth_simple.c\t2007-07-03 08:05:55 UTC (rev 23680)\n@@ -48,7 +48,7 @@\n \t\treturn NT_STATUS_NO_MEMORY;\n \t}\n \n-\tnt_status = auth_context_create(tmp_ctx, lp_auth_methods(),\n+\tnt_status = auth_context_create(tmp_ctx, \n \t\t\t\t\tev, msg,\n \t\t\t\t\t&auth_context);\n \tif (!NT_STATUS_IS_OK(nt_status)) {\n\nModified: branches/SAMBA_4_0/source/auth/ntlmssp/ntlmssp_server.c\n===================================================================\n--- branches/SAMBA_4_0/source/auth/ntlmssp/ntlmssp_server.c\t2007-07-03 08:01:34 UTC (rev 23679)\n+++ branches/SAMBA_4_0/source/auth/ntlmssp/ntlmssp_server.c\t2007-07-03 08:05:55 UTC (rev 23680)\n@@ -835,7 +835,7 @@\n \t\tgensec_ntlmssp_state->neg_flags |= NTLMSSP_NEGOTIATE_SEAL;\n \t}\n \n-\tnt_status = auth_context_create(gensec_ntlmssp_state, lp_auth_methods(), \n+\tnt_status = auth_context_create(gensec_ntlmssp_state, \n \t\t\t\t\tgensec_security->event_ctx,\n \t\t\t\t\tgensec_security->msg_ctx,\n \t\t\t\t\t&gensec_ntlmssp_state->auth_context);\n\nModified: branches/SAMBA_4_0/source/param/loadparm.c\n===================================================================\n--- branches/SAMBA_4_0/source/param/loadparm.c\t2007-07-03 08:01:34 UTC (rev 23679)\n+++ branches/SAMBA_4_0/source/param/loadparm.c\t2007-07-03 08:05:55 UTC (rev 23680)\n@@ -398,7 +398,6 @@\n \t{\"Security Options\", P_SEP, P_SEPARATOR},\n \t\n \t{\"security\", P_ENUM, P_GLOBAL, &Globals.security, NULL, enum_security, FLAG_BASIC | FLAG_ADVANCED | FLAG_WIZARD | FLAG_DEVELOPER},\n-\t{\"auth methods\", P_LIST, P_GLOBAL, &Globals.AuthMethods, NULL, NULL, FLAG_BASIC | FLAG_ADVANCED | FLAG_WIZARD | FLAG_DEVELOPER},\n \t{\"encrypt passwords\", P_BOOL, P_GLOBAL, &Globals.bEncryptPasswords, NULL, NULL, FLAG_BASIC | FLAG_ADVANCED | FLAG_WIZARD | FLAG_DEVELOPER},\n \t{\"null passwords\", P_BOOL, P_GLOBAL, &Globals.bNullPasswords, NULL, NULL, FLAG_ADVANCED | FLAG_DEVELOPER},\n \t{\"obey pam restrictions\", P_BOOL, P_GLOBAL, &Globals.bObeyPamRestrictions, NULL, NULL, FLAG_ADVANCED | FLAG_DEVELOPER},\n@@ -609,7 +608,9 @@\n \tdo_parameter(\"dcerpc endpoint servers\", \"epmapper srvsvc wkssvc rpcecho samr netlogon lsarpc spoolss drsuapi winreg dssetup unixinfo\", NULL);\n \tdo_parameter(\"server services\", \"smb rpc nbt wrepl ldap cldap web kdc drepl winbind\", NULL);\n \tdo_parameter(\"ntptr providor\", \"simple_ldb\", NULL);\n-\tdo_parameter(\"auth methods\", \"anonymous sam_ignoredomain\", NULL);\n+\tdo_parameter(\"auth methods:domain controller\", \"anonymous sam_ignoredomain\", NULL);\n+\tdo_parameter(\"auth methods:member server\", \"anonymous sam winbind\", NULL);\n+\tdo_parameter(\"auth methods:standalone\", \"anonymous sam_ignoredomain\", NULL);\n \tdo_parameter(\"private dir\", dyn_PRIVATE_DIR, NULL);\n \tdo_parameter(\"sam database\", \"sam.ldb\", NULL);\n \tdo_parameter(\"secrets database\", \"secrets.ldb\", NULL);\n\nModified: branches/SAMBA_4_0/source/rpc_server/netlogon/dcerpc_netlogon.c\n===================================================================\n--- branches/SAMBA_4_0/source/rpc_server/netlogon/dcerpc_netlogon.c\t2007-07-03 08:01:34 UTC (rev 23679)\n+++ branches/SAMBA_4_0/source/rpc_server/netlogon/dcerpc_netlogon.c\t2007-07-03 08:05:55 UTC (rev 23680)\n@@ -431,7 +431,7 @@\n \t\t}\n \n \t\t/* TODO: we need to deny anonymous access here */\n-\t\tnt_status = auth_context_create(mem_ctx, lp_auth_methods(),\n+\t\tnt_status = auth_context_create(mem_ctx, \n \t\t\t\t\t\tdce_call->event_ctx, dce_call->msg_ctx,\n \t\t\t\t\t\t&auth_context);\n \t\tNT_STATUS_NOT_OK_RETURN(nt_status);\n@@ -457,7 +457,7 @@\n \tcase 6:\n \n \t\t/* TODO: we need to deny anonymous access here */\n-\t\tnt_status = auth_context_create(mem_ctx, lp_auth_methods(),\n+\t\tnt_status = auth_context_create(mem_ctx, \n \t\t\t\t\t\tdce_call->event_ctx, dce_call->msg_ctx,\n \t\t\t\t\t\t&auth_context);\n \t\tNT_STATUS_NOT_OK_RETURN(nt_status);\n\nModified: branches/SAMBA_4_0/source/scripting/ejs/smbcalls_auth.c\n===================================================================\n--- branches/SAMBA_4_0/source/scripting/ejs/smbcalls_auth.c\t2007-07-03 08:01:34 UTC (rev 23679)\n+++ branches/SAMBA_4_0/source/scripting/ejs/smbcalls_auth.c\t2007-07-03 08:05:55 UTC (rev 23680)\n@@ -56,7 +56,7 @@\n \t\tmsg = messaging_client_init(tmp_ctx, ev);\n \t}\n \n-\tnt_status = auth_context_create(tmp_ctx, auth_types, ev, msg, &auth_context);\n+\tnt_status = auth_context_create_methods(tmp_ctx, auth_types, ev, msg, &auth_context);\n \tif (!NT_STATUS_IS_OK(nt_status)) {\n \t\tmprSetPropertyValue(auth, \"result\", mprCreateBoolVar(False));\n \t\tmprSetPropertyValue(auth, \"report\", mprString(\"Auth System Failure\"));\n\nModified: branches/SAMBA_4_0/source/selftest/Samba4.pm\n===================================================================\n--- branches/SAMBA_4_0/source/selftest/Samba4.pm\t2007-07-03 08:01:34 UTC (rev 23679)\n+++ branches/SAMBA_4_0/source/selftest/Samba4.pm\t2007-07-03 08:05:55 UTC (rev 23680)\n@@ -276,8 +276,6 @@\n \tmkdir($_, 0777) foreach ($privatedir, $etcdir, $piddir, $ncalrpcdir, $lockdir, \n \t\t$tmpdir);\n \n-\tmy $auth_methods = \"anonymous sam_ignoredomain\";\n-\t$auth_methods = \"anonymous sam winbind\" if $server_role eq \"member server\";\n \n \tmy $localdomain = $domain;\n \t$localdomain = $netbiosname if $server_role eq \"member server\";\n@@ -304,7 +302,6 @@\n \tpanic action = $srcdir/script/gdb_backtrace \\%PID% \\%PROG%\n \twins support = yes\n \tserver role = $server_role\n-\tauth methods = $auth_methods\n \tmax xmit = 32K\n \tserver max protocol = SMB2\n \tnotify:inotify = false\n\nModified: branches/SAMBA_4_0/source/smb_server/smb/negprot.c\n===================================================================\n--- branches/SAMBA_4_0/source/smb_server/smb/negprot.c\t2007-07-03 08:01:34 UTC (rev 23679)\n+++ branches/SAMBA_4_0/source/smb_server/smb/negprot.c\t2007-07-03 08:05:55 UTC (rev 23680)\n@@ -44,7 +44,7 @@\n \n \tDEBUG(10, (\"get challenge: creating negprot_global_auth_context\\n\"));\n \n-\tnt_status = auth_context_create(smb_conn, lp_auth_methods(), \n+\tnt_status = auth_context_create(smb_conn, \n \t\t\t\t\tsmb_conn->connection->event.ctx,\n \t\t\t\t\tsmb_conn->connection->msg_ctx,\n \t\t\t\t\t&smb_conn->negotiate.auth_context);\n\nModified: branches/SAMBA_4_0/source/smb_server/smb/sesssetup.c\n===================================================================\n--- branches/SAMBA_4_0/source/smb_server/smb/sesssetup.c\t2007-07-03 08:01:34 UTC (rev 23679)\n+++ branches/SAMBA_4_0/source/smb_server/smb/sesssetup.c\t2007-07-03 08:05:55 UTC (rev 23680)\n@@ -243,7 +243,7 @@\n \t\t}\n \n \t\t/* TODO: should we use just \"anonymous\" here? */\n-\t\tstatus = auth_context_create(req, lp_auth_methods(), \n+\t\tstatus = auth_context_create(req, \n \t\t\t\t\t     req->smb_conn->connection->event.ctx,\n \t\t\t\t\t     req->smb_conn->connection->msg_ctx,\n \t\t\t\t\t     &auth_context);\n\n"}