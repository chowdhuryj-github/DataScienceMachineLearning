{"category": "ham", "to_address": "samba-cvs@samba.org", "from_address": "tridge@samba.org", "subject": "Rev 493: there are now far too many controls for the controls\n\tstatistics fields to be useful in http://samba.org/~tridge/ctdb", "body": "------------------------------------------------------------\nrevno: 493\nrevision-id: tridge@samba.org-20070607080738-9hj4i5vn18ur2987\nparent: tridge@samba.org-20070607080525-14g625qx3h5rvs40\ncommitter: Andrew Tridgell \nbranch nick: tridge\ntimestamp: Thu 2007-06-07 18:07:38 +1000\nmessage:\n  there are now far too many controls for the controls statistics fields to be useful\nmodified:\n  common/ctdb_control.c          ctdb_control.c-20070426122724-j6gkpiofhbwdin63-1\n  include/ctdb_private.h         ctdb_private.h-20061117234101-o3qt14umlg9en8z0-13\n  tools/ctdb_control.c           ctdb_control.c-20070426122705-9ehj1l5lu2gn9kuj-1\n=== modified file 'common/ctdb_control.c'\n--- a/common/ctdb_control.c\t2007-06-07 08:05:25 +0000\n+++ b/common/ctdb_control.c\t2007-06-07 08:07:38 +0000\n@@ -52,7 +52,6 @@\n \tswitch (opcode) {\n \tcase CTDB_CONTROL_PROCESS_EXISTS: {\n \t\tCHECK_CONTROL_DATA_SIZE(sizeof(pid_t));\n-\t\tctdb->statistics.controls.process_exists++;\n \t\treturn kill(*(pid_t *)indata.dptr, 0);\n \t}\n \n@@ -71,7 +70,6 @@\n \n \tcase CTDB_CONTROL_STATISTICS: {\n \t\tCHECK_CONTROL_DATA_SIZE(0);\n-\t\tctdb->statistics.controls.statistics++;\n \t\tctdb->statistics.memory_used = talloc_total_size(ctdb);\n \t\tctdb->statistics.frozen = (ctdb->freeze_mode == CTDB_FREEZE_FROZEN);\n \t\tctdb->statistics.recovering = (ctdb->recovery_mode == CTDB_RECOVERY_ACTIVE);\n@@ -147,7 +145,6 @@\n \n \tcase CTDB_CONTROL_PING:\n \t\tCHECK_CONTROL_DATA_SIZE(0);\n-\t\tctdb->statistics.controls.ping++;\n \t\treturn ctdb->statistics.num_clients;\n \n \tcase CTDB_CONTROL_GET_DBNAME: {\n@@ -177,45 +174,36 @@\n \t}\n \n \tcase CTDB_CONTROL_DB_ATTACH:\n-\t\tctdb->statistics.controls.attach++;\n \t\treturn ctdb_control_db_attach(ctdb, indata, outdata);\n \n \tcase CTDB_CONTROL_SET_CALL: {\n \t\tstruct ctdb_control_set_call *sc = \n \t\t\t(struct ctdb_control_set_call *)indata.dptr;\n-\t\tctdb->statistics.controls.set_call++;\n \t\tCHECK_CONTROL_DATA_SIZE(sizeof(struct ctdb_control_set_call));\n \t\treturn ctdb_daemon_set_call(ctdb, sc->db_id, sc->fn, sc->id);\n \t}\n \n \tcase CTDB_CONTROL_TRAVERSE_START:\n \t\tCHECK_CONTROL_DATA_SIZE(sizeof(struct ctdb_traverse_start));\n-\t\tctdb->statistics.controls.traverse_start++;\n \t\treturn ctdb_control_traverse_start(ctdb, indata, outdata, srcnode);\n \n \tcase CTDB_CONTROL_TRAVERSE_ALL:\n-\t\tctdb->statistics.controls.traverse_all++;\n \t\treturn ctdb_control_traverse_all(ctdb, indata, outdata);\n \n \tcase CTDB_CONTROL_TRAVERSE_DATA:\n-\t\tctdb->statistics.controls.traverse_data++;\n \t\treturn ctdb_control_traverse_data(ctdb, indata, outdata);\n \n \tcase CTDB_CONTROL_REGISTER_SRVID:\n-\t\tctdb->statistics.controls.register_srvid++;\n \t\treturn daemon_register_message_handler(ctdb, client_id, srvid);\n \n \tcase CTDB_CONTROL_DEREGISTER_SRVID:\n-\t\tctdb->statistics.controls.deregister_srvid++;\n \t\treturn daemon_deregister_message_handler(ctdb, client_id, srvid);\n \n \tcase CTDB_CONTROL_ENABLE_SEQNUM:\n-\t\tctdb->statistics.controls.enable_seqnum++;\n \t\tCHECK_CONTROL_DATA_SIZE(sizeof(uint32_t));\n \t\treturn ctdb_ltdb_enable_seqnum(ctdb, *(uint32_t *)indata.dptr);\n \n \tcase CTDB_CONTROL_UPDATE_SEQNUM:\n-\t\tctdb->statistics.controls.update_seqnum++;\n \t\tCHECK_CONTROL_DATA_SIZE(sizeof(uint32_t));\t\t\n \t\treturn ctdb_ltdb_update_seqnum(ctdb, *(uint32_t *)indata.dptr, srcnode);\n \n\n=== modified file 'include/ctdb_private.h'\n--- a/include/ctdb_private.h\t2007-06-07 08:05:25 +0000\n+++ b/include/ctdb_private.h\t2007-06-07 08:07:38 +0000\n@@ -211,22 +211,6 @@\n \t\tuint32_t req_control;\n \t} client;\n \tstruct {\n-\t\tuint32_t statistics;\n-\t\tuint32_t get_config;\n-\t\tuint32_t ping;\n-\t\tuint32_t attach;\n-\t\tuint32_t set_call;\n-\t\tuint32_t process_exists;\n-\t\tuint32_t traverse_start;\n-\t\tuint32_t traverse_all;\n-\t\tuint32_t traverse_data;\n-\t\tuint32_t update_seqnum;\n-\t\tuint32_t enable_seqnum;\n-\t\tuint32_t set_seqnum_frequency;\n-\t\tuint32_t register_srvid;\n-\t\tuint32_t deregister_srvid;\n-\t} controls;\n-\tstruct {\n \t\tuint32_t call;\n \t\tuint32_t control;\n \t\tuint32_t traverse;\n\n=== modified file 'tools/ctdb_control.c'\n--- a/tools/ctdb_control.c\t2007-06-07 06:48:31 +0000\n+++ b/tools/ctdb_control.c\t2007-06-07 08:07:38 +0000\n@@ -96,19 +96,6 @@\n \t\tSTATISTICS_FIELD(client.req_call),\n \t\tSTATISTICS_FIELD(client.req_message),\n \t\tSTATISTICS_FIELD(client.req_control),\n-\t\tSTATISTICS_FIELD(controls.statistics),\n-\t\tSTATISTICS_FIELD(controls.get_config),\n-\t\tSTATISTICS_FIELD(controls.ping),\n-\t\tSTATISTICS_FIELD(controls.attach),\n-\t\tSTATISTICS_FIELD(controls.set_call),\n-\t\tSTATISTICS_FIELD(controls.process_exists),\n-\t\tSTATISTICS_FIELD(controls.traverse_start),\n-\t\tSTATISTICS_FIELD(controls.traverse_all),\n-\t\tSTATISTICS_FIELD(controls.traverse_data),\n-\t\tSTATISTICS_FIELD(controls.update_seqnum),\n-\t\tSTATISTICS_FIELD(controls.enable_seqnum),\n-\t\tSTATISTICS_FIELD(controls.register_srvid),\n-\t\tSTATISTICS_FIELD(controls.deregister_srvid),\n \t\tSTATISTICS_FIELD(timeouts.call),\n \t\tSTATISTICS_FIELD(timeouts.control),\n \t\tSTATISTICS_FIELD(timeouts.traverse),\n\n"}