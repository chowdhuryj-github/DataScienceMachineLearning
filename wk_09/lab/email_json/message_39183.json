{"category": "ham", "to_address": "samba-technical@lists.samba.org", "from_address": "Steve Langasek <vorlon@debian.org>", "subject": "Re: [PATCH 1/10] Debian patch: Make sure nmbd still responds to\n\tSIGTERM if it has no interfaces to listen on", "body": "On Wed, May 30, 2007 at 09:57:16PM +0200, Christian Perrier wrote:\n> The attached patch is currently used in Debian.\n\n> >From what I can understand, it was meant to fix our #168079 bug: \n> http://bugs.debian.org/168079.\n\n> In indeed have no clue whether the reported behaviour still happens\n> with 3.0.2x a the issue was reported against pre-3.0 versions..:-)\n\nLooks pretty clear to me that it's still an issue, since it still applies\ncleanly and this is the right scope where the signal handler *should* be\nrestored...\n\n-- \nSteve Langasek                   Give me a lever long enough and a Free OS\nDebian Developer                   to set it on, and I can move the world.\nvorlon@debian.org                                   http://www.debian.org/\n\n\n> Goal: Make sure nmbd still responds to SIGTERM if it has no interfaces to\n>       listen on\n> \n> Fixes: #168079\n> \n> Status wrt upstream: No apparent reason for not being forwarded upstream\n> \n> Author: Stave Langasek \n> \n> Note: To be confirmed by Steve\n> \n> Index: samba-3.0.25a/source/nmbd/nmbd_subnetdb.c\n> ===================================================================\n> --- samba-3.0.25a.orig/source/nmbd/nmbd_subnetdb.c\t2007-05-26 07:45:40.136219349 +0200\n> +++ samba-3.0.25a/source/nmbd/nmbd_subnetdb.c\t2007-05-26 07:46:31.104625382 +0200\n> @@ -185,12 +185,16 @@\n>  \tstruct in_addr unicast_ip, ipzero;\n>  \n>  \tif(num_interfaces == 0) {\n> +\t\tvoid (*old_handler)(int);\n> +\n>  \t\tDEBUG(0,(\"create_subnets: No local interfaces !\\n\"));\n>  \t\tDEBUG(0,(\"create_subnets: Waiting for an interface to appear ...\\n\"));\n> +\t\told_handler = CatchSignal( SIGTERM, SIGNAL_CAST SIG_DFL );\n>  \t\twhile (iface_count() == 0) {\n>  \t\t\tsleep(5);\n>  \t\t\tload_interfaces();\n>  \t\t}\n> +\t\tCatchSignal( SIGTERM, SIGNAL_CAST old_handler );\n>  \t}\n>  \n>  \tnum_interfaces = iface_count();\n\n"}