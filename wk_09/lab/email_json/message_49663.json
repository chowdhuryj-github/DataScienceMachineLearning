{"category": "ham", "to_address": "samba-cvs@samba.org", "from_address": "tridge@samba.org", "subject": "Rev 548: run smbstatus every 10 minutes to scrub databases in\n\thttp://samba.org/~tridge/ctdb", "body": "------------------------------------------------------------\nrevno: 548\nrevision-id: tridge@samba.org-20070617171508-dshksshlnzdh2qfs\nparent: tridge@samba.org-20070617171050-2zkpq4tu68qqryfo\ncommitter: Andrew Tridgell \nbranch nick: tridge\ntimestamp: Mon 2007-06-18 03:15:08 +1000\nmessage:\n  run smbstatus every 10 minutes to scrub databases\nmodified:\n  config/events.d/50.samba       samba-20070601105340-vlcvnp6euoj3zdwy-3\n=== modified file 'config/events.d/50.samba'\n--- a/config/events.d/50.samba\t2007-06-17 17:10:50 +0000\n+++ b/config/events.d/50.samba\t2007-06-17 17:15:08 +0000\n@@ -11,6 +11,20 @@\n \n [ \"$CTDB_MANAGES_SAMBA\" = \"yes\" ] || exit 0\n \n+# set default samba cleanup period - in minutes\n+[ -z \"$SAMBA_CLEANUP_PERIOD\" ] && {\n+    SAMBA_CLEANUP_PERIOD=10\n+}\n+\n+###########################\n+# periodic cleanup function\n+periodic_cleanup() {\n+    # running smbstatus scrubs any dead entries from the connections\n+    # and sessionid database\n+    echo \"`date` Running periodic cleanup of samba databases\"\n+    smbstatus -n > /dev/null 2>&1\n+}\n+\n case $cmd in \n      startup)\n \t# create the state directory for samba\n@@ -63,8 +77,9 @@\n \t[ -f /etc/ctdb/state/samba/periodic_cleanup ] || {\n \t\ttouch /etc/ctdb/state/samba/periodic_cleanup\n \t}\n-\t[ `/usr/bin/find /etc/ctdb/state/samba/periodic_cleanup -mmin +1 | wc -l` -eq 1 ] && {\n+\t[ `/usr/bin/find /etc/ctdb/state/samba/periodic_cleanup -mmin +$SAMBA_CLEANUP_PERIOD | wc -l` -eq 1 ] && {\n \t\t# Cleanup the databases\n+\t    \tperiodic_cleanup\n \t\ttouch /etc/ctdb/state/samba/periodic_cleanup\n \t}\n \n\n"}