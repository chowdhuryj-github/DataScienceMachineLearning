{"category": "ham", "to_address": "samba-cvs@samba.org", "from_address": "obnox@samba.org", "subject": "svn commit: samba r23468 - in branches: SAMBA_3_0/source/registry\n\tSAMBA_3_0_26/source/registry", "body": "Author: obnox\nDate: 2007-06-13 13:15:16 +0000 (Wed, 13 Jun 2007)\nNew Revision: 23468\n\nWebSVN: http://websvn.samba.org/cgi-bin/viewcvs.cgi?view=rev&root=samba&rev=23468\n\nLog:\nOpen registry.tdb with sequence number.\nAdd a function to retrieve the registry db sequence number.\n\nThis is in preparation of loadparm integration of registry global\nsmb.conf options: this will allow to detect changes in order to trigger reload.\n\nMichael\n\n\nModified:\n   branches/SAMBA_3_0/source/registry/reg_db.c\n   branches/SAMBA_3_0_26/source/registry/reg_db.c\n\n\nChangeset:\nModified: branches/SAMBA_3_0/source/registry/reg_db.c\n===================================================================\n--- branches/SAMBA_3_0/source/registry/reg_db.c\t2007-06-13 12:52:36 UTC (rev 23467)\n+++ branches/SAMBA_3_0/source/registry/reg_db.c\t2007-06-13 13:15:16 UTC (rev 23468)\n@@ -31,6 +31,8 @@\n #define VALUE_PREFIX\t\"SAMBA_REGVAL\"\n #define SECDESC_PREFIX  \"SAMBA_SECDESC\"\n \n+#define REG_TDB_FLAGS TDB_SEQNUM\n+\n /* List the deepest path into the registry.  All part components will be created.*/\n \n /* If you want to have a part of the path controlled by the tdb and part by\n@@ -236,9 +238,9 @@\n \tif ( tdb_reg )\n \t\treturn True;\n \n-\tif ( !(tdb_reg = tdb_open_log(lock_path(\"registry.tdb\"), 0, TDB_DEFAULT, O_RDWR, 0600)) )\n+\tif ( !(tdb_reg = tdb_open_log(lock_path(\"registry.tdb\"), 0, REG_TDB_FLAGS, O_RDWR, 0600)) )\n \t{\n-\t\ttdb_reg = tdb_open_log(lock_path(\"registry.tdb\"), 0, TDB_DEFAULT, O_RDWR|O_CREAT, 0600);\n+\t\ttdb_reg = tdb_open_log(lock_path(\"registry.tdb\"), 0, REG_TDB_FLAGS, O_RDWR|O_CREAT, 0600);\n \t\tif ( !tdb_reg ) {\n \t\t\tDEBUG(0,(\"regdb_init: Failed to open registry %s (%s)\\n\",\n \t\t\t\tlock_path(\"registry.tdb\"), strerror(errno) ));\n@@ -283,7 +285,7 @@\n \t\n \tbecome_root();\n \n-\ttdb_reg = tdb_open_log(lock_path(\"registry.tdb\"), 0, TDB_DEFAULT, O_RDWR, 0600);\n+\ttdb_reg = tdb_open_log(lock_path(\"registry.tdb\"), 0, REG_TDB_FLAGS, O_RDWR, 0600);\n \tif ( !tdb_reg ) {\n \t\tresult = ntstatus_to_werror( map_nt_error_from_unix( errno ) );\n \t\tDEBUG(0,(\"regdb_open: Failed to open %s! (%s)\\n\", \n@@ -321,6 +323,16 @@\n }\n \n /***********************************************************************\n+ return the tdb sequence number of the registry tdb.\n+ this is an indicator for the content of the registry\n+ having changed. it will change upon regdb_init, too, though.\n+ ***********************************************************************/\n+int regdb_get_seqnum(void)\n+{\n+\treturn tdb_get_seqnum(tdb_reg);\n+}\n+\n+/***********************************************************************\n  Add subkey strings to the registry tdb under a defined key\n  fmt is the same format as tdb_pack except this function only supports\n  fstrings\n\nModified: branches/SAMBA_3_0_26/source/registry/reg_db.c\n===================================================================\n--- branches/SAMBA_3_0_26/source/registry/reg_db.c\t2007-06-13 12:52:36 UTC (rev 23467)\n+++ branches/SAMBA_3_0_26/source/registry/reg_db.c\t2007-06-13 13:15:16 UTC (rev 23468)\n@@ -31,6 +31,8 @@\n #define VALUE_PREFIX\t\"SAMBA_REGVAL\"\n #define SECDESC_PREFIX  \"SAMBA_SECDESC\"\n \n+#define REG_TDB_FLAGS TDB_SEQNUM\n+\n /* List the deepest path into the registry.  All part components will be created.*/\n \n /* If you want to have a part of the path controlled by the tdb and part by\n@@ -236,9 +238,9 @@\n \tif ( tdb_reg )\n \t\treturn True;\n \n-\tif ( !(tdb_reg = tdb_open_log(lock_path(\"registry.tdb\"), 0, TDB_DEFAULT, O_RDWR, 0600)) )\n+\tif ( !(tdb_reg = tdb_open_log(lock_path(\"registry.tdb\"), 0, REG_TDB_FLAGS, O_RDWR, 0600)) )\n \t{\n-\t\ttdb_reg = tdb_open_log(lock_path(\"registry.tdb\"), 0, TDB_DEFAULT, O_RDWR|O_CREAT, 0600);\n+\t\ttdb_reg = tdb_open_log(lock_path(\"registry.tdb\"), 0, REG_TDB_FLAGS, O_RDWR|O_CREAT, 0600);\n \t\tif ( !tdb_reg ) {\n \t\t\tDEBUG(0,(\"regdb_init: Failed to open registry %s (%s)\\n\",\n \t\t\t\tlock_path(\"registry.tdb\"), strerror(errno) ));\n@@ -283,7 +285,7 @@\n \t\n \tbecome_root();\n \n-\ttdb_reg = tdb_open_log(lock_path(\"registry.tdb\"), 0, TDB_DEFAULT, O_RDWR, 0600);\n+\ttdb_reg = tdb_open_log(lock_path(\"registry.tdb\"), 0, REG_TDB_FLAGS, O_RDWR, 0600);\n \tif ( !tdb_reg ) {\n \t\tresult = ntstatus_to_werror( map_nt_error_from_unix( errno ) );\n \t\tDEBUG(0,(\"regdb_open: Failed to open %s! (%s)\\n\", \n@@ -321,6 +323,16 @@\n }\n \n /***********************************************************************\n+ return the tdb sequence number of the registry tdb.\n+ this is an indicator for the content of the registry\n+ having changed. it will change upon regdb_init, too, though.\n+ ***********************************************************************/\n+int regdb_get_seqnum(void)\n+{\n+\treturn tdb_get_seqnum(tdb_reg);\n+}\n+\n+/***********************************************************************\n  Add subkey strings to the registry tdb under a defined key\n  fmt is the same format as tdb_pack except this function only supports\n  fstrings\n\n"}