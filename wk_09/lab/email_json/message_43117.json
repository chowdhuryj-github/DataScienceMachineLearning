{"category": "ham", "to_address": "samba-technical@lists.samba.org", "from_address": "James Peach <jpeach@samba.org>", "subject": "[PATCH 2/2] Remove support for automatically generated prototype\n\theaders. ", "body": "as per subject.\n---\nsource/Makefile.in        |   57 +--------------\nsource/script/mkproto.awk |  174  \n---------------------------------------------\nsource/script/mkproto.sh  |   43 -----------\n3 files changed, 4 insertions(+), 270 deletions(-)\ndelete mode 100644 source/script/mkproto.awk\ndelete mode 100755 source/script/mkproto.sh\n\ndiff --git a/source/Makefile.in b/source/Makefile.in\nindex f39c568..cf95682 100644\n--- a/source/Makefile.in\n+++ b/source/Makefile.in\n@@ -1947,69 +1947,20 @@ proto_exists: include/proto.h include/ \nbuild_env.h \\\ndelheaders:\n\t@echo Removing prototype headers\n-\t@rm -f include/proto.h include/build_env.h \\\n-\t\tnsswitch/winbindd_proto.h web/swat_proto.h \\\n-\t\tclient/client_proto.h utils/net_proto.h \\\n-\t\tsmbd/build_options.c utils/ntlm_auth_proto.h \\\n-\t\tutils/passwd_proto.h\n-\n-MKPROTO_SH = $(srcdir)/script/mkproto.sh\n-\n-include/proto.h: smbd/build_options.c\n-\t@echo Building include/proto.h\n-\t@cd $(srcdir) && $(SHELL) $(MKPROTO_SH) $(AWK) \\\n-\t  -h _PROTO_H_ $(builddir)/include/proto.h \\\n-\t  $(PROTO_OBJ)\n+\t@rm -f include/build_env.h smbd/build_options.c\ninclude/build_env.h: script/build_env.sh\n\t@echo Building include/build_env.h\n\t@$(SHELL) $(srcdir)/script/build_env.sh $(srcdir) $(builddir) $(CC) \\\n\t  > $(builddir)/include/build_env.h\n-nsswitch/winbindd_proto.h:\n-\t@cd $(srcdir) && $(SHELL) $(MKPROTO_SH) $(AWK) \\\n-\t  -h _WINBINDD_PROTO_H_ $(builddir)/nsswitch/winbindd_proto.h \\\n-\t  $(WINBINDD_OBJ1)\n-\n-web/swat_proto.h:\n-\t@cd $(srcdir) && $(SHELL) $(MKPROTO_SH) $(AWK) \\\n-\t  -h _SWAT_PROTO_H_ $(builddir)/web/swat_proto.h \\\n-\t  $(SWAT_OBJ1)\n-\n-client/client_proto.h:\n-\t@cd $(srcdir) && $(SHELL) $(MKPROTO_SH) $(AWK) \\\n-\t  -h _CLIENT_PROTO_H_ $(builddir)/client/client_proto.h \\\n-\t  $(CLIENT_OBJ1)\n-\n-utils/net_proto.h:\n-\t@cd $(srcdir) && $(SHELL) $(MKPROTO_SH) $(AWK) \\\n-\t  -h _NET_PROTO_H_ $(builddir)/utils/net_proto.h \\\n-\t  $(NET_OBJ1)\n-\n-utils/passwd_proto.h:\n-\t@cd $(srcdir) && $(SHELL) $(MKPROTO_SH) $(AWK) \\\n-\t  -h _PASSWD_PROTO_H_ $(builddir)/utils/passwd_proto.h \\\n-\t  $(PASSWD_UTIL_OBJ)\n-\n-utils/ntlm_auth_proto.h:\n-\t@cd $(srcdir) && $(SHELL) $(MKPROTO_SH) $(AWK) \\\n-\t  -h _NTLM_AUTH_PROTO_H_ $(builddir)/utils/ntlm_auth_proto.h \\\n-\t  $(NTLM_AUTH_OBJ1)\n-\n# \"make headers\" or \"make proto\" calls a subshell because we need to\n# make sure these commands are executed in sequence even for a\n# parallel make.\nheaders:\n-\t$(MAKE) delheaders; \\\n-\t$(MAKE) smbd/build_options.c; \\\n-\t$(MAKE) include/proto.h; \\\n-\t$(MAKE) include/build_env.h; \\\n-\t$(MAKE) nsswitch/winbindd_proto.h; \\\n-\t$(MAKE) web/swat_proto.h; \\\n-\t$(MAKE) client/client_proto.h; \\\n-\t$(MAKE) utils/ntlm_auth_proto.h; \\\n-\t$(MAKE) utils/net_proto.h; \\\n-\t$(MAKE) utils/passwd_proto.h;\n+\t$(MAKE) delheaders\n+\t$(MAKE) smbd/build_options.c\n+\t$(MAKE) include/build_env.h\nproto: headers\ndiff --git a/source/script/mkproto.awk b/source/script/mkproto.awk\ndeleted file mode 100644\nindex 65a10c8..0000000\n--- a/source/script/mkproto.awk\n+++ /dev/null\n@@ -1,174 +0,0 @@\n-BEGIN {\n-  inheader=0;\n-#  use_ldap_define = 0;\n-  current_file=\"\";\n-  if (headername==\"\") {\n-    headername=\"_PROTO_H_\";\n-  }\n-\n-  print \"#ifndef\",headername\n-  print \"#define\",headername\n-  print \"\"\n-  print \"/* This file is automatically generated with \\\"make proto \n\\\". DO NOT EDIT */\"\n-  print \"\"\n-}\n-\n-END {\n-  print \"\"\n-  print \"#endif /* \",headername,\" */\"\n-}\n-\n-{\n-  if (FILENAME!=current_file) {\n-#    if (use_ldap_define)\n-#    {\n-#      print \"#endif /* USE_LDAP */\"\n-#      use_ldap_define = 0;\n-#    }\n-    print \"\"\n-    print \"/* The following definitions come from\",FILENAME,\" */\"\n-    print \"\"\n-    current_file=FILENAME\n-  }\n-  if (inheader) {\n-    if (match($0,\"[)][ \\t]*$\")) {\n-      inheader = 0;\n-      printf \"%s;\\n\",$0;\n-    } else {\n-      printf \"%s\\n\",$0;\n-    }\n-    next;\n-  }\n-}\n-\n-# we handle the loadparm.c fns separately\n-\n-/^FN_LOCAL_BOOL/ {\n-  split($0,a,\"[,()]\")\n-  printf \"BOOL %s(int );\\n\", a[2]\n-}\n-\n-/^FN_LOCAL_PARM_BOOL/ {\n-  split($0,a,\"[,()]\")\n-  printf \"BOOL %s(const struct share_params *p );\\n\", a[2]\n-}\n-\n-/^FN_LOCAL_PARM_INTEGER/ {\n-  split($0,a,\"[,()]\")\n-  printf \"int %s(const struct share_params *p );\\n\", a[2]\n-}\n-\n-/^FN_LOCAL_LIST/ {\n-  split($0,a,\"[,()]\")\n-  printf \"const char **%s(int );\\n\", a[2]\n-}\n-\n-/^FN_LOCAL_STRING/ {\n-  split($0,a,\"[,()]\")\n-  printf \"char *%s(int );\\n\", a[2]\n-}\n-\n-/^FN_LOCAL_PARM_STRING/ {\n-  split($0,a,\"[,()]\")\n-  printf \"char *%s(const struct share_params *p );\\n\", a[2]\n-}\n-\n-/^FN_LOCAL_CONST_STRING/ {\n-  split($0,a,\"[,()]\")\n-  printf \"const char *%s(int );\\n\", a[2]\n-}\n-\n-/^FN_LOCAL_INT/ {\n-  split($0,a,\"[,()]\")\n-  printf \"int %s(int );\\n\", a[2]\n-}\n-\n-/^FN_LOCAL_CHAR/ {\n-  split($0,a,\"[,()]\")\n-  printf \"char %s(const struct share_params *p );\\n\", a[2]\n-}\n-\n-/^FN_GLOBAL_BOOL/ {\n-  split($0,a,\"[,()]\")\n-  printf \"BOOL %s(void);\\n\", a[2]\n-}\n-\n-/^FN_GLOBAL_LIST/ {\n-  split($0,a,\"[,()]\")\n-  printf \"const char **%s(void);\\n\", a[2]\n-}\n-\n-/^FN_GLOBAL_STRING/ {\n-  split($0,a,\"[,()]\")\n-  printf \"char *%s(void);\\n\", a[2]\n-}\n-\n-/^FN_GLOBAL_CONST_STRING/ {\n-  split($0,a,\"[,()]\")\n-  printf \"const char *%s(void);\\n\", a[2]\n-}\n-\n-/^FN_GLOBAL_INT/ {\n-  split($0,a,\"[,()]\")\n-  printf \"int %s(void);\\n\", a[2]\n-}\n-\n-/^static|^extern/ || !/^[a-zA-Z]/ || /[;]/ {\n-  next;\n-}\n-\n-#\n-# We have to split up the start\n-# matching as we now have so many start\n-# types that it can cause some versions\n-# of nawk/awk to choke and fail on\n-# the full match. JRA.\n-#\n-\n-{\n-  gotstart = 0;\n-  if( $0 ~ /^const|^connection_struct|^pipes_struct|^smb_np_struct| \n^file_fd_struct|^files_struct|^connection_struct|^uid_t|^gid_t| \n^unsigned|^mode_t|^DIR|^user|^int|^pid_t|^ino_t|^off_t|^double/ ) {\n-    gotstart = 1;\n-  }\n-\n-  if( $0 ~ /^vuser_key|^UNISTR2|^LOCAL_GRP|^DOMAIN_GRP| \n^SMB_STRUCT_DIRENT|^SEC_ACL|^SEC_DESC|^SEC_DESC_BUF|^DOM_SID| \n^RPC_HND_NODE|^BYTE/ ) {\n-    gotstart = 1;\n-  }\n-\n-  if( $0 ~ /^ADS_STRUCT|^ADS_STATUS|^DATA_BLOB|^ASN1_DATA| \n^TDB_CONTEXT|^TDB_DATA|^smb_ucs2_t|^TALLOC_CTX|^hash_element| \n^NT_DEVICEMODE|^enum.*\\(|^NT_USER_TOKEN|^SAM_ACCOUNT|^NTTIME/ ) {\n-    gotstart = 1;\n-  }\n-\n-  if( $0 ~ /^smb_iconv_t|^long|^char|^uint|^NTSTATUS|^WERROR| \n^CLI_POLICY_HND|^struct|^BOOL|^void|^time|^smb_shm_offset_t| \n^shm_offset_t|^FILE|^XFILE|^SMB_OFF_T|^size_t|^ssize_t|^SMB_BIG_UINT| \n^SMB_BIG_INT/ ) {\n-    gotstart = 1;\n-  }\n-\n-  if( $0 ~ /^SAM_ACCT_INFO_NODE|^SMB_ACL_T|^ADS_MODLIST|^PyObject| \n^SORTED_TREE|^REGISTRY_HOOK|^REGISTRY_VALUE|^REGVAL_CTR|^DEVICEMODE| \n^PAC_DATA|^NET_USER_INFO_3|^smb_event_id_t/ ) {\n-    gotstart = 1;\n-  }\n-\n-  if( $0 ~ /^WINBINDD_PW|^WINBINDD_GR|^NT_PRINTER_INFO_LEVEL_2| \n^LOGIN_CACHE|^krb5_error_code|^LDAP|^u32|^LUID_ATTR|^NSS_STATUS/ ) {\n-    gotstart = 1;\n-  }\n-\n-  if( $0 ~ /^NODE_STATUS_STRUCT|SMB_STRUCT_DIR|ELOG_TDB| \ncodepoint_t/ ) {\n-    gotstart = 1;\n-  }\n-\n-  if(!gotstart) {\n-    next;\n-  }\n-}\n-\n-\n-/[(].*[)][ \\t]*$/ {\n-    printf \"%s;\\n\",$0;\n-    next;\n-}\n-\n-/[(]/ {\n-  inheader=1;\n-  printf \"%s\\n\",$0;\n-  next;\n-}\n-\ndiff --git a/source/script/mkproto.sh b/source/script/mkproto.sh\ndeleted file mode 100755\nindex e46e73e..0000000\n--- a/source/script/mkproto.sh\n+++ /dev/null\n@@ -1,43 +0,0 @@\n-#! /bin/sh\n-\n-LANG=C; export LANG\n-LC_ALL=C; export LC_ALL\n-LC_COLLATE=C; export LC_COLLATE\n-\n-if [ $# -lt 3 ]\n-then\n-  echo \"Usage: $0 awk [-h headerdefine] outputheader proto_obj\"\n-  exit 1\n-fi\n-\n-awk=\"$1\"\n-shift\n-\n-if [ x\"$1\" = x-h ]\n-then\n-  headeropt=\"-v headername=$2\"\n-  shift; shift;\n-else\n-  headeropt=\"\"\n-fi\n-\n-header=\"$1\"\n-shift\n-headertmp=\"$header.$$.tmp~\"\n-\n-proto_src=\"`echo $@ | tr ' ' '\\n' | sed -e 's/\\.o/\\.c/g' | sort |  \nuniq | egrep -v 'tdb/|wrapped|modules/getdate'`\"\n-\n-echo creating $header\n-\n-mkdir -p `dirname $header`\n-\n-${awk} $headeropt \\\n-  -f script/mkproto.awk $proto_src > $headertmp\n-\n-if cmp -s $header $headertmp 2>/dev/null\n-then\n-  echo \"$header unchanged\"\n-  rm $headertmp\n-else\n-  mv $headertmp $header\n-fi\n--\n1.5.2.1\n\n\n--\nJames Peach | jpeach@samba.org\n\n\n"}