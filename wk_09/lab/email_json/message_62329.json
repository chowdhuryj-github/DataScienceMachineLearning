{"category": "ham", "to_address": "samba-cvs@samba.org", "from_address": "lmuelle@samba.org", "subject": "svn commit: samba r23708 - in branches: SAMBA_3_0/source/nsswitch\n\tSAMBA_3_0_26/source/nsswitch", "body": "Author: lmuelle\nDate: 2007-07-04 20:25:29 +0000 (Wed, 04 Jul 2007)\nNew Revision: 23708\n\nWebSVN: http://websvn.samba.org/cgi-bin/viewcvs.cgi?view=rev&root=samba&rev=23708\n\nLog:\n- Add define for WINBIND_WARN_PWD_EXPIRE.\n- Add parameter config_flag to get_config_item_int() and do the same\n  check as in get_conf_item_string.\n\nModified:\n   branches/SAMBA_3_0/source/nsswitch/pam_winbind.c\n   branches/SAMBA_3_0/source/nsswitch/pam_winbind.h\n   branches/SAMBA_3_0_26/source/nsswitch/pam_winbind.c\n   branches/SAMBA_3_0_26/source/nsswitch/pam_winbind.h\n\n\nChangeset:\nModified: branches/SAMBA_3_0/source/nsswitch/pam_winbind.c\n===================================================================\n--- branches/SAMBA_3_0/source/nsswitch/pam_winbind.c\t2007-07-04 19:52:51 UTC (rev 23707)\n+++ branches/SAMBA_3_0/source/nsswitch/pam_winbind.c\t2007-07-04 20:25:29 UTC (rev 23708)\n@@ -264,6 +264,10 @@\n \t\tctrl |= WINBIND_TRY_FIRST_PASS_ARG;\n \t}\n \n+\tif (iniparser_getint(d, \"global:warn_pwd_expire\", 0)) {\n+\t\tctrl |= WINBIND_WARN_PWD_EXPIRE;\n+\t}\n+\n config_from_pam:\n \t/* step through arguments */\n \tfor (i=argc,v=argv; i-- > 0; ++v) {\n@@ -1532,10 +1536,15 @@\n \t\t\t      const char **argv,\n \t\t\t      int ctrl,\n \t\t\t      dictionary *d,\n-\t\t\t      const char *item)\n+\t\t\t      const char *item,\n+\t\t\t      int config_flag)\n {\n \tint i, parm_opt = -1;\n \n+\tif (!(ctrl & config_flag)) {\n+\t\tgoto out;\n+\t}\n+\n \t/* let the pam opt take precedence over the pam_winbind.conf option */\n \tfor (i = 0; i < argc; i++) {\n \n@@ -1597,7 +1606,7 @@\n {\n \tint ret;\n \tret = get_config_item_int(pamh, argc, argv, ctrl, d,\n-\t\t\t\t  \"warn_pwd_expire\");\n+\t\t\t\t  \"warn_pwd_expire\", WINBIND_WARN_PWD_EXPIRE);\n \t/* no or broken setting */\n \tif (ret <= 0) {\n \t\treturn DEFAULT_DAYS_TO_WARN_BEFORE_PWD_EXPIRES;\n\nModified: branches/SAMBA_3_0/source/nsswitch/pam_winbind.h\n===================================================================\n--- branches/SAMBA_3_0/source/nsswitch/pam_winbind.h\t2007-07-04 19:52:51 UTC (rev 23707)\n+++ branches/SAMBA_3_0/source/nsswitch/pam_winbind.h\t2007-07-04 20:25:29 UTC (rev 23708)\n@@ -95,6 +95,7 @@\n #define WINBIND_CONFIG_FILE (1<<10)\n #define WINBIND_SILENT (1<<11)\n #define WINBIND_DEBUG_STATE (1<<12)\n+#define WINBIND_WARN_PWD_EXPIRE (1<<13)\n \n /*\n  * here is the string to inform the user that the new passwords they\n\nModified: branches/SAMBA_3_0_26/source/nsswitch/pam_winbind.c\n===================================================================\n--- branches/SAMBA_3_0_26/source/nsswitch/pam_winbind.c\t2007-07-04 19:52:51 UTC (rev 23707)\n+++ branches/SAMBA_3_0_26/source/nsswitch/pam_winbind.c\t2007-07-04 20:25:29 UTC (rev 23708)\n@@ -264,6 +264,10 @@\n \t\tctrl |= WINBIND_TRY_FIRST_PASS_ARG;\n \t}\n \n+\tif (iniparser_getint(d, \"global:warn_pwd_expire\", 0)) {\n+\t\tctrl |= WINBIND_WARN_PWD_EXPIRE;\n+\t}\n+\n config_from_pam:\n \t/* step through arguments */\n \tfor (i=argc,v=argv; i-- > 0; ++v) {\n@@ -1532,10 +1536,15 @@\n \t\t\t      const char **argv,\n \t\t\t      int ctrl,\n \t\t\t      dictionary *d,\n-\t\t\t      const char *item)\n+\t\t\t      const char *item,\n+\t\t\t      int config_flag)\n {\n \tint i, parm_opt = -1;\n \n+\tif (!(ctrl & config_flag)) {\n+\t\tgoto out;\n+\t}\n+\n \t/* let the pam opt take precedence over the pam_winbind.conf option */\n \tfor (i = 0; i < argc; i++) {\n \n@@ -1597,7 +1606,7 @@\n {\n \tint ret;\n \tret = get_config_item_int(pamh, argc, argv, ctrl, d,\n-\t\t\t\t  \"warn_pwd_expire\");\n+\t\t\t\t  \"warn_pwd_expire\", WINBIND_WARN_PWD_EXPIRE);\n \t/* no or broken setting */\n \tif (ret <= 0) {\n \t\treturn DEFAULT_DAYS_TO_WARN_BEFORE_PWD_EXPIRES;\n\nModified: branches/SAMBA_3_0_26/source/nsswitch/pam_winbind.h\n===================================================================\n--- branches/SAMBA_3_0_26/source/nsswitch/pam_winbind.h\t2007-07-04 19:52:51 UTC (rev 23707)\n+++ branches/SAMBA_3_0_26/source/nsswitch/pam_winbind.h\t2007-07-04 20:25:29 UTC (rev 23708)\n@@ -95,6 +95,7 @@\n #define WINBIND_CONFIG_FILE (1<<10)\n #define WINBIND_SILENT (1<<11)\n #define WINBIND_DEBUG_STATE (1<<12)\n+#define WINBIND_WARN_PWD_EXPIRE (1<<13)\n \n /*\n  * here is the string to inform the user that the new passwords they\n\n"}