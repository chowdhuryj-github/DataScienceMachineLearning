{"category": "ham", "to_address": "samba-cvs@samba.org", "from_address": "tridge@samba.org", "subject": "Rev 155: merged the db_dir changes from volker. Changed them\n\tslightly, in http://samba.org/~tridge/ctdb", "body": "------------------------------------------------------------\nrevno: 155\nrevision-id: tridge@samba.org-20070418231425-4902f5acfc663227\nparent: tridge@samba.org-20070418091229-02a734be8c7a9e5f\nparent: vl@samba.org-20070418143622-v1bwf47yj5whztz0\ncommitter: Andrew Tridgell \nbranch nick: tridge\ntimestamp: Thu 2007-04-19 09:14:25 +1000\nmessage:\n  merged the db_dir changes from volker. Changed them slightly,\n  to make the --dbdir option available to all ctdb tools, not just\n  the daemon\nmodified:\n  common/cmdline.c               cmdline.c-20070416041216-w1zvz91bkdsgjckw-1\n  common/ctdb.c                  ctdb.c-20061127094323-t50f58d65iaao5of-2\n  common/ctdb_ltdb.c             ctdb_ltdb.c-20061128065342-to93h6eejj5kon81-2\n  include/ctdb.h                 ctdb.h-20061117234101-o3qt14umlg9en8z0-11\n  include/ctdb_private.h         ctdb_private.h-20061117234101-o3qt14umlg9en8z0-13\n    ------------------------------------------------------------\n    merged: vl@samba.org-20070418143622-v1bwf47yj5whztz0\n    parent: tridge@samba.org-20070418091229-02a734be8c7a9e5f\n    committer: Volker Lendecke \n    branch nick: vl-ctdb\n    timestamp: Wed 2007-04-18 16:36:22 +0200\n    message:\n      Add --dbdir to ctdbd. Necessary for shared operation between ctdbd and smbd.\n=== modified file 'common/cmdline.c'\n--- a/common/cmdline.c\t2007-04-17 12:16:50 +0000\n+++ b/common/cmdline.c\t2007-04-18 23:14:25 +0000\n@@ -31,11 +31,13 @@\n \tconst char *transport;\n \tconst char *myaddress;\n \tint self_connect;\n+\tconst char *db_dir;\n } ctdb_cmdline = {\n \t.nlist = NULL,\n \t.transport = \"tcp\",\n \t.myaddress = NULL,\n \t.self_connect = 0,\n+\t.db_dir = \".\"\n };\n \n \n@@ -45,6 +47,7 @@\n \t{ \"transport\", 0, POPT_ARG_STRING, &ctdb_cmdline.transport, 0, \"protocol transport\", NULL },\n \t{ \"self-connect\", 0, POPT_ARG_NONE, &ctdb_cmdline.self_connect, 0, \"enable self connect\", \"boolean\" },\n \t{ \"debug\", 'd', POPT_ARG_INT, &LogLevel, 0, \"debug level\"},\n+\t{ \"dbdir\", 0, POPT_ARG_STRING, &ctdb_cmdline.db_dir, 0, \"directory for the tdb files\", NULL },\n \t{ NULL }\n };\n \n@@ -93,5 +96,11 @@\n \t\texit(1);\n \t}\n \n+\tret = ctdb_set_tdb_dir(ctdb, ctdb_cmdline.db_dir);\n+\tif (ret == -1) {\n+\t\tprintf(\"ctdb_set_tdb_dir failed - %s\\n\", ctdb_errstr(ctdb));\n+\t\texit(1);\n+\t}\n+\n \treturn ctdb;\n }\n\n=== modified file 'common/ctdb.c'\n--- a/common/ctdb.c\t2007-04-18 02:39:03 +0000\n+++ b/common/ctdb.c\t2007-04-18 23:14:25 +0000\n@@ -74,6 +74,18 @@\n }\n \n /*\n+  set the directory for the local databases\n+*/\n+int ctdb_set_tdb_dir(struct ctdb_context *ctdb, const char *dir)\n+{\n+\tctdb->db_directory = talloc_strdup(ctdb, dir);\n+\tif (ctdb->db_directory == NULL) {\n+\t\treturn -1;\n+\t}\n+\treturn 0;\n+}\n+\n+/*\n   add a node to the list of active nodes\n */\n static int ctdb_add_node(struct ctdb_context *ctdb, char *nstr)\n\n=== modified file 'common/ctdb_ltdb.c'\n--- a/common/ctdb_ltdb.c\t2007-04-18 05:27:26 +0000\n+++ b/common/ctdb_ltdb.c\t2007-04-18 14:36:22 +0000\n@@ -84,7 +84,7 @@\n \n \t/* add the node id to the database name, so when we run on loopback\n \t   we don't conflict in the local filesystem */\n-\tname = talloc_asprintf(ctdb_db, \"%s.%u\", name, ctdb_get_vnn(ctdb));\n+\tname = talloc_asprintf(ctdb_db, \"%s/%s\", ctdb->db_directory, name);\n \n \t/* when we have a separate daemon this will need to be a real\n \t   file, not a TDB_INTERNAL, so the parent can access it to\n\n=== modified file 'include/ctdb.h'\n--- a/include/ctdb.h\t2007-04-18 02:39:03 +0000\n+++ b/include/ctdb.h\t2007-04-18 23:14:25 +0000\n@@ -72,6 +72,11 @@\n int ctdb_set_transport(struct ctdb_context *ctdb, const char *transport);\n \n /*\n+  set the directory for the local databases\n+*/\n+int ctdb_set_tdb_dir(struct ctdb_context *ctdb, const char *dir);\n+\n+/*\n   set some flags\n */\n void ctdb_set_flags(struct ctdb_context *ctdb, unsigned flags);\n\n=== modified file 'include/ctdb_private.h'\n--- a/include/ctdb_private.h\t2007-04-18 08:43:34 +0000\n+++ b/include/ctdb_private.h\t2007-04-18 23:14:25 +0000\n@@ -119,6 +119,7 @@\n \tstruct event_context *ev;\n \tstruct ctdb_address address;\n \tconst char *name;\n+\tconst char *db_directory;\n \tuint32_t vnn; /* our own vnn */\n \tuint32_t num_nodes;\n \tuint32_t num_connected;\n@@ -460,4 +461,6 @@\n \t\t\t\t\t\t     struct ctdb_call *call, \n \t\t\t\t\t\t     struct ctdb_ltdb_header *header);\n \n+void ctdb_request_finished(struct ctdb_context *ctdb, struct ctdb_req_header *hdr);\n+\n #endif\n\n"}