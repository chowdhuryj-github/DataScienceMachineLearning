{"category": "ham", "to_address": "samba-cvs@samba.org", "from_address": "vlendec@samba.org", "subject": "svn commit: samba r23228 - in branches: SAMBA_3_0/source/modules\n\tSAMBA_3_0_26/source/modules", "body": "Author: vlendec\nDate: 2007-05-29 19:54:26 +0000 (Tue, 29 May 2007)\nNew Revision: 23228\n\nWebSVN: http://websvn.samba.org/cgi-bin/viewcvs.cgi?view=rev&root=samba&rev=23228\n\nLog:\nMerge cleanup to the gpfs module from Tridge. Also potentially disable\ngpfs share modes in special situations. This might be split up in\nseveral modules later.\n\nModified:\n   branches/SAMBA_3_0/source/modules/gpfs.c\n   branches/SAMBA_3_0_26/source/modules/gpfs.c\n\n\nChangeset:\nModified: branches/SAMBA_3_0/source/modules/gpfs.c\n===================================================================\n--- branches/SAMBA_3_0/source/modules/gpfs.c\t2007-05-29 19:48:34 UTC (rev 23227)\n+++ branches/SAMBA_3_0/source/modules/gpfs.c\t2007-05-29 19:54:26 UTC (rev 23228)\n@@ -25,6 +25,7 @@\n #include \"gpfs_gpl.h\"\n \n static void *libgpfs_handle = NULL;\n+static BOOL gpfs_share_modes;\n \n static int (*gpfs_set_share_fn)(int fd, unsigned int allow, unsigned int deny);\n static int (*gpfs_set_lease_fn)(int fd, unsigned int leaseType);\n@@ -39,6 +40,10 @@\n \tunsigned int deny = GPFS_DENY_NONE;\n \tint result;\n \n+\tif (!gpfs_share_modes) {\n+\t\treturn True;\n+\t}\n+\n \tif (gpfs_set_share_fn == NULL) {\n \t\treturn False;\n \t}\n@@ -84,6 +89,10 @@\n {\n \tint gpfs_type = GPFS_LEASE_NONE;\n \n+\tif (!gpfs_share_modes) {\n+\t\treturn True;\n+\t}\n+\n \tif (gpfs_set_lease_fn == NULL) {\n \t\terrno = EINVAL;\n \t\treturn -1;\n@@ -138,15 +147,7 @@\n \tif (gpfs_set_share_fn == NULL) {\n \t\tDEBUG(3, (\"libgpfs_gpl.so does not contain the symbol \"\n \t\t\t  \"'gpfs_set_share'\\n\"));\n-\t\tsys_dlclose(libgpfs_handle);\n-\n-\t\t/* leave libgpfs_handle != NULL around, no point\n-\t\t   in trying twice */\n-\t\tgpfs_set_share_fn = NULL;\n-\t\tgpfs_set_lease_fn = NULL;\n-\t\tgpfs_getacl_fn = NULL;\n-\t\tgpfs_putacl_fn = NULL;\n-\t\treturn;\n+\t\tgoto failed;\n \t}\n \n \tgpfs_set_lease_fn = sys_dlsym(libgpfs_handle, \"gpfs_set_lease\");\n@@ -155,45 +156,39 @@\n \t\t\t  \"'gpfs_set_lease'\\n\"));\n \t\tsys_dlclose(libgpfs_handle);\n \n-\t\t/* leave libgpfs_handle != NULL around, no point\n-\t\t   in trying twice */\n-\t\tgpfs_set_share_fn = NULL;\n-\t\tgpfs_set_lease_fn = NULL;\n-\t\tgpfs_getacl_fn = NULL;\n-\t\tgpfs_putacl_fn = NULL;\n-\t\treturn;\n+\t\tgoto failed;\n \t}\n \n \tgpfs_getacl_fn = sys_dlsym(libgpfs_handle, \"gpfs_getacl\");\n \tif (gpfs_getacl_fn == NULL) {\n \t\tDEBUG(3, (\"libgpfs_gpl.so does not contain the symbol \"\n \t\t\t  \"'gpfs_getacl'\\n\"));\n-\t\tsys_dlclose(libgpfs_handle);\n-\n-\t\t/* leave libgpfs_handle != NULL around, no point\n-\t\t   in trying twice */\n-\t\tgpfs_set_share_fn = NULL;\n-\t\tgpfs_set_lease_fn = NULL;\n-\t\tgpfs_getacl_fn = NULL;\n-\t\tgpfs_putacl_fn = NULL;\n-\t\treturn;\n+\t\tgoto failed;\n \t}\n \n \tgpfs_putacl_fn = sys_dlsym(libgpfs_handle, \"gpfs_putacl\");\n \tif (gpfs_putacl_fn == NULL) {\n \t\tDEBUG(3, (\"libgpfs_gpl.so does not contain the symbol \"\n \t\t\t  \"'gpfs_putacl'\\n\"));\n-\t\tsys_dlclose(libgpfs_handle);\n+\t\tgoto failed;\n+\t}\n \n-\t\t/* leave libgpfs_handle != NULL around, no point\n-\t\t   in trying twice */\n-\t\tgpfs_set_share_fn = NULL;\n-\t\tgpfs_set_lease_fn = NULL;\n-\t\tgpfs_getacl_fn = NULL;\n-\t\tgpfs_putacl_fn = NULL;\n-\t\treturn;\n+\tif (lp_parm_bool(-1, \"gpfs\", \"sharemodes\", True)) {\n+\t\tgpfs_share_modes = True;\n+\t} else {\n+\t\tgpfs_share_modes = False;\n \t}\n \n+\treturn;\n+\n+failed:\n+\tsys_dlclose(libgpfs_handle);\n+\t/* leave libgpfs_handle != NULL around, no point\n+\t   in trying twice */\n+\tgpfs_set_share_fn = NULL;\n+\tgpfs_set_lease_fn = NULL;\n+\tgpfs_getacl_fn = NULL;\n+\tgpfs_putacl_fn = NULL;\n }\n \n #else\n\nModified: branches/SAMBA_3_0_26/source/modules/gpfs.c\n===================================================================\n--- branches/SAMBA_3_0_26/source/modules/gpfs.c\t2007-05-29 19:48:34 UTC (rev 23227)\n+++ branches/SAMBA_3_0_26/source/modules/gpfs.c\t2007-05-29 19:54:26 UTC (rev 23228)\n@@ -25,6 +25,7 @@\n #include \"gpfs_gpl.h\"\n \n static void *libgpfs_handle = NULL;\n+static BOOL gpfs_share_modes;\n \n static int (*gpfs_set_share_fn)(int fd, unsigned int allow, unsigned int deny);\n static int (*gpfs_set_lease_fn)(int fd, unsigned int leaseType);\n@@ -39,6 +40,10 @@\n \tunsigned int deny = GPFS_DENY_NONE;\n \tint result;\n \n+\tif (!gpfs_share_modes) {\n+\t\treturn True;\n+\t}\n+\n \tif (gpfs_set_share_fn == NULL) {\n \t\treturn False;\n \t}\n@@ -84,6 +89,10 @@\n {\n \tint gpfs_type = GPFS_LEASE_NONE;\n \n+\tif (!gpfs_share_modes) {\n+\t\treturn True;\n+\t}\n+\n \tif (gpfs_set_lease_fn == NULL) {\n \t\terrno = EINVAL;\n \t\treturn -1;\n@@ -138,15 +147,7 @@\n \tif (gpfs_set_share_fn == NULL) {\n \t\tDEBUG(3, (\"libgpfs_gpl.so does not contain the symbol \"\n \t\t\t  \"'gpfs_set_share'\\n\"));\n-\t\tsys_dlclose(libgpfs_handle);\n-\n-\t\t/* leave libgpfs_handle != NULL around, no point\n-\t\t   in trying twice */\n-\t\tgpfs_set_share_fn = NULL;\n-\t\tgpfs_set_lease_fn = NULL;\n-\t\tgpfs_getacl_fn = NULL;\n-\t\tgpfs_putacl_fn = NULL;\n-\t\treturn;\n+\t\tgoto failed;\n \t}\n \n \tgpfs_set_lease_fn = sys_dlsym(libgpfs_handle, \"gpfs_set_lease\");\n@@ -155,45 +156,39 @@\n \t\t\t  \"'gpfs_set_lease'\\n\"));\n \t\tsys_dlclose(libgpfs_handle);\n \n-\t\t/* leave libgpfs_handle != NULL around, no point\n-\t\t   in trying twice */\n-\t\tgpfs_set_share_fn = NULL;\n-\t\tgpfs_set_lease_fn = NULL;\n-\t\tgpfs_getacl_fn = NULL;\n-\t\tgpfs_putacl_fn = NULL;\n-\t\treturn;\n+\t\tgoto failed;\n \t}\n \n \tgpfs_getacl_fn = sys_dlsym(libgpfs_handle, \"gpfs_getacl\");\n \tif (gpfs_getacl_fn == NULL) {\n \t\tDEBUG(3, (\"libgpfs_gpl.so does not contain the symbol \"\n \t\t\t  \"'gpfs_getacl'\\n\"));\n-\t\tsys_dlclose(libgpfs_handle);\n-\n-\t\t/* leave libgpfs_handle != NULL around, no point\n-\t\t   in trying twice */\n-\t\tgpfs_set_share_fn = NULL;\n-\t\tgpfs_set_lease_fn = NULL;\n-\t\tgpfs_getacl_fn = NULL;\n-\t\tgpfs_putacl_fn = NULL;\n-\t\treturn;\n+\t\tgoto failed;\n \t}\n \n \tgpfs_putacl_fn = sys_dlsym(libgpfs_handle, \"gpfs_putacl\");\n \tif (gpfs_putacl_fn == NULL) {\n \t\tDEBUG(3, (\"libgpfs_gpl.so does not contain the symbol \"\n \t\t\t  \"'gpfs_putacl'\\n\"));\n-\t\tsys_dlclose(libgpfs_handle);\n+\t\tgoto failed;\n+\t}\n \n-\t\t/* leave libgpfs_handle != NULL around, no point\n-\t\t   in trying twice */\n-\t\tgpfs_set_share_fn = NULL;\n-\t\tgpfs_set_lease_fn = NULL;\n-\t\tgpfs_getacl_fn = NULL;\n-\t\tgpfs_putacl_fn = NULL;\n-\t\treturn;\n+\tif (lp_parm_bool(-1, \"gpfs\", \"sharemodes\", True)) {\n+\t\tgpfs_share_modes = True;\n+\t} else {\n+\t\tgpfs_share_modes = False;\n \t}\n \n+\treturn;\n+\n+failed:\n+\tsys_dlclose(libgpfs_handle);\n+\t/* leave libgpfs_handle != NULL around, no point\n+\t   in trying twice */\n+\tgpfs_set_share_fn = NULL;\n+\tgpfs_set_lease_fn = NULL;\n+\tgpfs_getacl_fn = NULL;\n+\tgpfs_putacl_fn = NULL;\n }\n \n #else\n\n"}