{"category": "ham", "to_address": "samba-cvs@samba.org", "from_address": "tridge@samba.org", "subject": "Rev 451: merged from ronnie in http://samba.org/~tridge/ctdb", "body": "------------------------------------------------------------\nrevno: 451\nrevision-id: tridge@samba.org-20070604033427-lmkyet1lja4tn7oz\nparent: tridge@samba.org-20070603121148-m0aa9lmi03v67ys8\nparent: sahlberg@ronnie-20070604032607-vw1k1pwe21lrhh1z\ncommitter: Andrew Tridgell \nbranch nick: tridge\ntimestamp: Mon 2007-06-04 13:34:27 +1000\nmessage:\n  merged from ronnie\nmodified:\n  common/ctdb_recover.c          ctdb_recover.c-20070503002147-admmfgt1oj6gexfo-1\n  include/ctdb.h                 ctdb.h-20061117234101-o3qt14umlg9en8z0-11\n  include/ctdb_private.h         ctdb_private.h-20061117234101-o3qt14umlg9en8z0-13\n  tools/ctdb_control.c           ctdb_control.c-20070426122705-9ehj1l5lu2gn9kuj-1\n    ------------------------------------------------------------\n    revno: 432.1.15\n    merged: sahlberg@ronnie-20070604032607-vw1k1pwe21lrhh1z\n    parent: sahlberg@ronnie-20070604014836-izop6kwcq59tt8uh\n    committer: Ronnie Sahlberg \n    branch nick: ctdb\n    timestamp: Mon 2007-06-04 13:26:07 +1000\n    message:\n      add the ip address to the nodemap structure we pull from a server and \n      display the physical address of a node when we do a ctdb status\n    ------------------------------------------------------------\n    revno: 432.1.14\n    merged: sahlberg@ronnie-20070604014836-izop6kwcq59tt8uh\n    parent: sahlberg@ronnie-20070603113045-6ayhg8s3iinomj3n\n    parent: tridge@samba.org-20070603121148-m0aa9lmi03v67ys8\n    committer: Ronnie Sahlberg \n    branch nick: ctdb\n    timestamp: Mon 2007-06-04 11:48:36 +1000\n    message:\n      merge from tridge\n    ------------------------------------------------------------\n    revno: 432.1.13\n    merged: sahlberg@ronnie-20070603113045-6ayhg8s3iinomj3n\n    parent: sahlberg@ronnie-20070603095051-58zzq6mxi86c40zq\n    parent: tridge@samba.org-20070603105424-u3l4oixhczc2triy\n    committer: Ronnie Sahlberg \n    branch nick: ctdb\n    timestamp: Sun 2007-06-03 21:30:45 +1000\n    message:\n      merge from tridge\n=== modified file 'common/ctdb_recover.c'\n--- a/common/ctdb_recover.c\t2007-06-03 00:29:14 +0000\n+++ b/common/ctdb_recover.c\t2007-06-04 03:26:07 +0000\n@@ -162,6 +162,7 @@\n \tnode_map = (struct ctdb_node_map *)outdata->dptr;\n \tnode_map->num = num_nodes;\n \tfor (i=0; inodes[i]->address.address, &node_map->nodes[i].sin.sin_addr);\n \t\tnode_map->nodes[i].vnn   = ctdb->nodes[i]->vnn;\n \t\tnode_map->nodes[i].flags = ctdb->nodes[i]->flags;\n \t}\n\n=== modified file 'include/ctdb.h'\n--- a/include/ctdb.h\t2007-06-02 03:31:36 +0000\n+++ b/include/ctdb.h\t2007-06-04 03:26:07 +0000\n@@ -243,17 +243,8 @@\n \tTALLOC_CTX *mem_ctx, struct ctdb_dbid_map **dbmap);\n \n \n-/* table that contains a list of all nodes a ctdb knows about and their \n-   status\n- */\n-struct ctdb_node_and_flags {\n-\tuint32_t vnn;\n-\tuint32_t flags;\n-};\n-struct ctdb_node_map {\n-\tuint32_t num;\n-\tstruct ctdb_node_and_flags nodes[1];\n-};\n+struct ctdb_node_map;\n+\n int ctdb_ctrl_getnodemap(struct ctdb_context *ctdb, \n \t\t    struct timeval timeout, uint32_t destnode, \n \t\t    TALLOC_CTX *mem_ctx, struct ctdb_node_map **nodemap);\n\n=== modified file 'include/ctdb_private.h'\n--- a/include/ctdb_private.h\t2007-06-02 03:31:36 +0000\n+++ b/include/ctdb_private.h\t2007-06-04 03:26:07 +0000\n@@ -869,6 +869,21 @@\n \tuint32_t dmaster;\n };\n \n+/* table that contains a list of all nodes a ctdb knows about and their \n+   status\n+ */\n+struct ctdb_node_and_flags {\n+\tuint32_t vnn;\n+\tuint32_t flags;\n+\tstruct sockaddr_in sin;\n+\n+};\n+\n+struct ctdb_node_map {\n+\tuint32_t num;\n+\tstruct ctdb_node_and_flags nodes[1];\n+};\n+\n int32_t ctdb_control_traverse_start(struct ctdb_context *ctdb, TDB_DATA indata, \n \t\t\t\t    TDB_DATA *outdata, uint32_t srcnode);\n int32_t ctdb_control_traverse_all(struct ctdb_context *ctdb, TDB_DATA data, TDB_DATA *outdata);\n\n=== modified file 'tools/ctdb_control.c'\n--- a/tools/ctdb_control.c\t2007-06-03 09:50:51 +0000\n+++ b/tools/ctdb_control.c\t2007-06-04 03:26:07 +0000\n@@ -292,7 +292,8 @@\n \tif(options.machinereadable){\n \t\tprintf(\":Node:Status:\\n\");\n \t\tfor(i=0;inum;i++){\n-\t\t\tprintf(\":%d:%d:\\n\", nodemap->nodes[i].vnn,\n+\t\t\tprintf(\":%d:%s:%d:\\n\", nodemap->nodes[i].vnn,\n+\t\t\t\tinet_ntoa(nodemap->nodes[i].sin.sin_addr),\n \t\t\t\t!!nodemap->nodes[i].flags&NODE_FLAGS_CONNECTED);\n \t\t}\n \t\treturn 0;\n@@ -300,7 +301,8 @@\n \n \tprintf(\"Number of nodes:%d\\n\", nodemap->num);\n \tfor(i=0;inum;i++){\n-\t\tprintf(\"vnn:%d %s%s\\n\", nodemap->nodes[i].vnn,\n+\t\tprintf(\"vnn:%d %16s %s%s\\n\", nodemap->nodes[i].vnn,\n+\t\t\tinet_ntoa(nodemap->nodes[i].sin.sin_addr),\n \t\t\tnodemap->nodes[i].flags&NODE_FLAGS_CONNECTED?\n \t\t\t\t\"CONNECTED\":\"UNAVAILABLE\",\n \t\t\tnodemap->nodes[i].vnn == myvnn?\" (THIS NODE)\":\"\");\n\n"}