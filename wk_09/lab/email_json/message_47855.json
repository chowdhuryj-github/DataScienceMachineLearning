{"category": "ham", "to_address": "samba-cvs@samba.org", "from_address": "Jelmer Vernooij <jelmer@samba.org>", "subject": "Rev 11191: Use temporary locations rather than hard-coded ones. in\n\tfile:///home/jelmer/bzr.samba-old/4.0-regwrite/", "body": "At file:///home/jelmer/bzr.samba-old/4.0-regwrite/\n\n------------------------------------------------------------\nrevno: 11191\nrevision-id: jelmer@samba.org-20070613001344-qkqechdlu867mozv\nparent: jelmer@samba.org-20070612234637-779h4pffu0ybx829\ncommitter: Jelmer Vernooij \nbranch nick: 4.0-regwrite\ntimestamp: Wed 2007-06-13 02:13:44 +0200\nmessage:\n  Use temporary locations rather than hard-coded ones.\nmodified:\n  source/lib/registry/tests/hive.c hive.c-20070612151642-hsxkm8j4r69ej3px-1\n  source/torture/util.c          svn-v2:16518@0c0555d6-39d7-0310-84fc-f1cc0bd64818-branches%2fSAMBA_4_0-source%2ftorture%2futil.c\n=== modified file 'source/lib/registry/tests/hive.c'\n--- a/source/lib/registry/tests/hive.c\t2007-06-12 23:11:37 +0000\n+++ b/source/lib/registry/tests/hive.c\t2007-06-13 00:13:44 +0000\n@@ -25,6 +25,10 @@\n #include \"lib/cmdline/popt_common.h\"\n #include \"torture/torture.h\"\n #include \"librpc/gen_ndr/winreg.h\"\n+#include \"system/filesys.h\"\n+\n+NTSTATUS torture_temp_dir(TALLOC_CTX *mem_ctx, const char *prefix, \n+\t\t\t\t\t\t\t\t   const char **tempdir);\n \n static bool test_del_nonexistant_key(struct torture_context *tctx,\n \t\t\t\t\t\t\t\t\t const void *test_data)\n@@ -93,8 +97,16 @@\n {\n \tstruct hive_key *key;\n \tWERROR error;\n-\n-\terror = reg_create_directory(tctx, \"bla\", &key);\n+\tconst char *dirname;\n+\tNTSTATUS status;\n+\n+\tstatus = torture_temp_dir(tctx, \"hive-dir\", &dirname);\n+\tif (!NT_STATUS_IS_OK(status))\n+\t\treturn false;\n+\n+\trmdir(dirname);\n+\n+\terror = reg_create_directory(tctx, dirname, &key);\n \tif (!W_ERROR_IS_OK(error)) {\n \t\tfprintf(stderr, \"Unable to initialize dir hive\\n\");\n \t\treturn false;\n@@ -109,8 +121,16 @@\n {\n \tstruct hive_key *key;\n \tWERROR error;\n-\n-\terror = reg_open_ldb_file(tctx, \"bla-ldb\", NULL, NULL, &key);\n+\tconst char *dirname;\n+\tNTSTATUS status;\n+\n+\tstatus = torture_temp_dir(tctx, \"hive-ldb\", &dirname);\n+\tif (!NT_STATUS_IS_OK(status))\n+\t\treturn false;\n+\n+\trmdir(dirname);\n+\n+\terror = reg_open_ldb_file(tctx, dirname, NULL, NULL, &key);\n \tif (!W_ERROR_IS_OK(error)) {\n \t\tfprintf(stderr, \"Unable to initialize ldb hive\\n\");\n \t\treturn false;\n@@ -125,8 +145,16 @@\n {\n \tstruct hive_key *key;\n \tWERROR error;\n-\n-\terror = reg_create_regf_file(tctx, \"bla-regf\", 5, &key);\n+\tconst char *dirname;\n+\tNTSTATUS status;\n+\n+\tstatus = torture_temp_dir(tctx, \"hive-dir\", &dirname);\n+\tif (!NT_STATUS_IS_OK(status))\n+\t\treturn false;\n+\n+\trmdir(dirname);\n+\n+\terror = reg_create_regf_file(tctx, dirname, 5, &key);\n \tif (!W_ERROR_IS_OK(error)) {\n \t\tfprintf(stderr, \"Unable to create new regf file\\n\");\n \t\treturn false;\n\n=== modified file 'source/torture/util.c'\n--- a/source/torture/util.c\t2007-04-17 00:30:01 +0000\n+++ b/source/torture/util.c\t2007-06-13 00:13:44 +0000\n@@ -29,16 +29,22 @@\n  create a temporary directory.\n */\n _PUBLIC_ NTSTATUS torture_temp_dir(TALLOC_CTX *mem_ctx, const char *prefix, \n-\t\t\t\t\t\t\t\t   char **tempdir)\n+\t\t\t\t\t\t\t\t   const char **tempdir)\n {\n \tconst char *basedir = lp_parm_string(-1, \"torture\", \"basedir\");\n-\tif (basedir == NULL) basedir = \".\";\n-\t*tempdir = talloc_asprintf(mem_ctx, \"%s/%s.XXXXXX\", \n+\tchar *path;\n+\n+\tif (basedir == NULL) \n+\t\tbasedir = \".\";\n+\n+\tpath = talloc_asprintf(mem_ctx, \"%s/%s.XXXXXX\", \n \t\t\t\t\t\t\t   basedir, prefix);\n \n-\tif (mkdtemp(*tempdir) == NULL)\n+\tif (mkdtemp(path) == NULL)\n \t\treturn NT_STATUS_UNSUCCESSFUL;\n \n+\t*tempdir = path;\n+\n \treturn NT_STATUS_OK;\n }\n \n\n"}