{"category": "ham", "to_address": "samba-cvs@samba.org", "from_address": "tridge@samba.org", "subject": "svn commit: samba r22960 - in branches/SAMBA_4_0/source/lib/socket:\n\t.", "body": "Author: tridge\nDate: 2007-05-17 02:19:28 +0000 (Thu, 17 May 2007)\nNew Revision: 22960\n\nWebSVN: http://websvn.samba.org/cgi-bin/viewcvs.cgi?view=rev&root=samba&rev=22960\n\nLog:\n\nadded a SOCKET_FLAG_NOCLOSE to allow us to tell the socket layer that\nwe will handle the close of the socket\n\nModified:\n   branches/SAMBA_4_0/source/lib/socket/socket.c\n   branches/SAMBA_4_0/source/lib/socket/socket.h\n\n\nChangeset:\nModified: branches/SAMBA_4_0/source/lib/socket/socket.c\n===================================================================\n--- branches/SAMBA_4_0/source/lib/socket/socket.c\t2007-05-17 02:18:29 UTC (rev 22959)\n+++ branches/SAMBA_4_0/source/lib/socket/socket.c\t2007-05-17 02:19:28 UTC (rev 22960)\n@@ -30,7 +30,8 @@\n */\n static int socket_destructor(struct socket_context *sock)\n {\n-\tif (sock->ops->fn_close) {\n+\tif (sock->ops->fn_close && \n+\t    !(sock->flags & SOCKET_FLAG_NOCLOSE)) {\n \t\tsock->ops->fn_close(sock);\n \t}\n \treturn 0;\n@@ -547,3 +548,10 @@\n \ttalloc_free(options_list);\n }\n \n+/*\n+  set some flags on a socket \n+ */\n+void socket_set_flags(struct socket_context *sock, unsigned flags)\n+{\n+\tsock->flags |= flags;\n+}\n\nModified: branches/SAMBA_4_0/source/lib/socket/socket.h\n===================================================================\n--- branches/SAMBA_4_0/source/lib/socket/socket.h\t2007-05-17 02:18:29 UTC (rev 22959)\n+++ branches/SAMBA_4_0/source/lib/socket/socket.h\t2007-05-17 02:19:28 UTC (rev 22960)\n@@ -109,7 +109,9 @@\n \t\t\t\t\t     * is encrypting data.\n \t\t\t\t\t     * This modifies the\n \t\t\t\t\t     * TESTNONBLOCK case */\n+#define SOCKET_FLAG_NOCLOSE      0x00000010 /* don't auto-close on free */\n \n+\n struct socket_context {\n \tenum socket_type type;\n \tenum socket_state state;\n@@ -196,5 +198,6 @@\n \t\t\t      struct socket_context **result,\n \t\t\t      uint16_t *port);\n void set_socket_options(int fd, const char *options);\n+void socket_set_flags(struct socket_context *socket, unsigned flags);\n \n #endif /* _SAMBA_SOCKET_H */\n\n"}