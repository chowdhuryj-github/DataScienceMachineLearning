{"category": "ham", "to_address": "samba-cvs@samba.org", "from_address": "tridge@samba.org", "subject": "Rev 442: don't start nfs services unless the relevant directories\n\tare available in http://samba.org/~tridge/ctdb", "body": "------------------------------------------------------------\nrevno: 442\nrevision-id: tridge@samba.org-20070603043927-duv31mw1amr5hkfs\nparent: tridge@samba.org-20070603032107-p22c1plg1zp468ov\ncommitter: Andrew Tridgell \nbranch nick: tridge\ntimestamp: Sun 2007-06-03 14:39:27 +1000\nmessage:\n  don't start nfs services unless the relevant directories are available\nmodified:\n  config/events.d/nfs            nfs-20070601141008-hy3h4qgbk1jd2jci-1\n  config/events.d/nfslock        nfslock-20070601105340-vlcvnp6euoj3zdwy-2\n  config/events.d/samba          samba-20070601105340-vlcvnp6euoj3zdwy-3\n=== modified file 'config/events.d/nfs'\n--- a/config/events.d/nfs\t2007-06-02 08:51:05 +0000\n+++ b/config/events.d/nfs\t2007-06-03 04:39:27 +0000\n@@ -13,6 +13,11 @@\n case $cmd in \n      startup)\n \tmkdir -p /etc/ctdb/state/nfs\n+\n+\t# wait for all nfs exported directories to become available\n+\tnfs_dirs=`cut -d' ' -f1 /etc/exports`\n+\tctdb_wait_directories \"NFS\" $nfs_dirs\n+\n \tservice nfs start\n \t;;\n \n\n=== modified file 'config/events.d/nfslock'\n--- a/config/events.d/nfslock\t2007-06-02 06:44:15 +0000\n+++ b/config/events.d/nfslock\t2007-06-03 04:39:27 +0000\n@@ -7,12 +7,16 @@\n [ -z $CTDB_MANAGES_NFS ] && exit 0\n [ $CTDB_MANAGES_NFS != \"yes\" ] && exit 0\n \n+[ -z \"$STATD_SHARED_DIRECTORY\" ] && exit 0\n+\n cmd=\"$1\"\n shift\n \n case $cmd in \n      startup)\n \t/bin/mkdir -p /etc/ctdb/state/statd/ip\n+\tctdb_wait_directories \"nfslock\" \"$STATD_SHARED_DIRECTORY\"\n+\n \tservice nfslock start\n \t;;\n \n\n=== modified file 'config/events.d/samba'\n--- a/config/events.d/samba\t2007-06-02 08:51:05 +0000\n+++ b/config/events.d/samba\t2007-06-03 04:39:27 +0000\n@@ -13,6 +13,10 @@\n \n case $cmd in \n      startup)\n+\t# wait for all shared directories to become available\n+\tsmb_dirs=`testparm -st 2> /dev/null | egrep '^\\s*path = '  | cut -d= -f2`\n+\tctdb_wait_directories \"Samba\" $smb_dirs\t\n+\n \t# start Samba service\n \tservice smb start\n \tservice winbind start\n@@ -20,10 +24,6 @@\n \t# wait for the Samba tcp ports to become available\n \tsmb_ports=`testparm -stv 2> /dev/null | egrep '\\s*smb ports =' | cut -d= -f2`\n \tctdb_wait_tcp_ports \"Samba\" $smb_ports\n-\n-\t# wait for all shared directories to become available\n-\tsmb_dirs=`testparm -st 2> /dev/null | egrep '^\\s*path = '  | cut -d= -f2`\n-\tctdb_wait_directories \"Samba\" $smb_dirs\t\n \t;;\n \t\n      takeip)\n\n"}