{"category": "ham", "to_address": "samba-cvs@samba.org", "from_address": "jerry@samba.org", "subject": "svn commit: samba r23130 - in branches/SAMBA_3_0_RELEASE: .\n\tsource/include source/libsmb", "body": "Author: jerry\nDate: 2007-05-25 04:02:25 +0000 (Fri, 25 May 2007)\nNew Revision: 23130\n\nWebSVN: http://websvn.samba.org/cgi-bin/viewcvs.cgi?view=rev&root=samba&rev=23130\n\nLog:\nmerge Derrell's change from SAMBA_3_0_25 svn r23120\nModified:\n   branches/SAMBA_3_0_RELEASE/WHATSNEW.txt\n   branches/SAMBA_3_0_RELEASE/source/include/nterr.h\n   branches/SAMBA_3_0_RELEASE/source/libsmb/clierror.c\n   branches/SAMBA_3_0_RELEASE/source/libsmb/clitrans.c\n\n\nChangeset:\nModified: branches/SAMBA_3_0_RELEASE/WHATSNEW.txt\n===================================================================\n--- branches/SAMBA_3_0_RELEASE/WHATSNEW.txt\t2007-05-24 23:38:46 UTC (rev 23129)\n+++ branches/SAMBA_3_0_RELEASE/WHATSNEW.txt\t2007-05-25 04:02:25 UTC (rev 23130)\n@@ -98,8 +98,10 @@\n     * BUG 4599: Fix failure when setting attributes.\n     * BUG 4634: Type of the size parameter to getpeername in\n       libsmbclient code was wrong.\n+    * Fix libsmbclient interaction with links on Vista and properly\n+      detect non-NTSTATUS errors.\n+    \n \n-\n o   Jim McDonough \n     * BUG 4630: Fix special case of unix_to_nt_time() for TIME_T_MAX\n       and the output from http_timestring().\n\nModified: branches/SAMBA_3_0_RELEASE/source/include/nterr.h\n===================================================================\n--- branches/SAMBA_3_0_RELEASE/source/include/nterr.h\t2007-05-24 23:38:46 UTC (rev 23129)\n+++ branches/SAMBA_3_0_RELEASE/source/include/nterr.h\t2007-05-25 04:02:25 UTC (rev 23130)\n@@ -30,6 +30,9 @@\n #define STATUS_NO_MORE_FILES              NT_STATUS(0x80000006)\n #define NT_STATUS_NO_MORE_ENTRIES         NT_STATUS(0x8000001a)\n \n+/* Vista Status codes. */\n+#define STATUS_INACCESSIBLE_SYSTEM_SHORTCUT         NT_STATUS(0x8000002d)\n+\n #define STATUS_MORE_ENTRIES               NT_STATUS(0x0105)\n #define STATUS_SOME_UNMAPPED              NT_STATUS(0x0107)\n #define ERROR_INVALID_PARAMETER\t\t  NT_STATUS(0x0057)\n\nModified: branches/SAMBA_3_0_RELEASE/source/libsmb/clierror.c\n===================================================================\n--- branches/SAMBA_3_0_RELEASE/source/libsmb/clierror.c\t2007-05-24 23:38:46 UTC (rev 23129)\n+++ branches/SAMBA_3_0_RELEASE/source/libsmb/clierror.c\t2007-05-25 04:02:25 UTC (rev 23130)\n@@ -380,6 +380,15 @@\n \t\treturn cli_errno_from_nt(status);\n         }\n \n+        /*\n+         * Yuck!  A special case for this Vista error.  Since its high-order\n+         * byte isn't 0xc0, it doesn't match cli_is_nt_error() above.\n+         */\n+        status = cli_nt_error(cli);\n+        if (NT_STATUS_V(status) == NT_STATUS_V(STATUS_INACCESSIBLE_SYSTEM_SHORTCUT)) {\n+            return EACCES;\n+        }\n+\n \t/* for other cases */\n \treturn EINVAL;\n }\n\nModified: branches/SAMBA_3_0_RELEASE/source/libsmb/clitrans.c\n===================================================================\n--- branches/SAMBA_3_0_RELEASE/source/libsmb/clitrans.c\t2007-05-24 23:38:46 UTC (rev 23129)\n+++ branches/SAMBA_3_0_RELEASE/source/libsmb/clitrans.c\t2007-05-25 04:02:25 UTC (rev 23130)\n@@ -197,7 +197,9 @@\n \t */\n \tstatus = cli_nt_error(cli);\n \t\n-\tif (NT_STATUS_IS_ERR(status) || NT_STATUS_EQUAL(status,STATUS_NO_MORE_FILES)) {\n+\tif (NT_STATUS_IS_ERR(status) ||\n+            NT_STATUS_EQUAL(status,STATUS_NO_MORE_FILES) ||\n+            NT_STATUS_EQUAL(status,STATUS_INACCESSIBLE_SYSTEM_SHORTCUT)) {\n \t\tgoto out;\n \t}\n \n\n"}