{"category": "ham", "to_address": "Volker Lendecke <Volker.Lendecke@SerNet.DE>", "from_address": "Jeremy Allison <jra@samba.org>", "subject": "Re: Use delete_on_close for reply_unlink?", "body": "On Tue, Jun 12, 2007 at 04:22:29PM +0200, Volker Lendecke wrote:\n> Hi, Jeremy!\n> \n> The attached patch removes a little race condition for\n> people with real kernel oplock support, and reduces some\n> code paths. It changes reply_unlink to open_file_ntcreate,\n> set_delete_on_close and close_file.\n> \n> The race condition happens if we break the oplock in\n> can_delete via open_file_ntcreate, we close the file,\n> someone else gets a batch oplock and we try to unlink.\n> \n> It reduces code paths by calling SMB_VFS_UNLINK in 2 fewer\n> places.\n> \n> Same would apply to rename_internal, but this seems a bit\n> more involved.\n> \n> What do you think?\n\nLooks really good to me ! Nice work. I'm assuming it\npasses all the torture tests - if it does please commit\nin 3.0.26 and 3.0 (I don't think Jerry will want this\nin 3.0.25b today :-).\n\nCheers,\n\n\tJeremy.\n\n"}