{"category": "ham", "to_address": "samba-cvs@samba.org", "from_address": "jerry@samba.org", "subject": "svn commit: samba r22726 - in branches: SAMBA_3_0/source/nsswitch\n\tSAMBA_3_0_26/source/nsswitch", "body": "Author: jerry\nDate: 2007-05-06 21:36:20 +0000 (Sun, 06 May 2007)\nNew Revision: 22726\n\nWebSVN: http://websvn.samba.org/cgi-bin/viewcvs.cgi?view=rev&root=samba&rev=22726\n\nLog:\nWhen performing an offline logon for a user in a trusted domain,\ntake care not to expire the name2sid cache entry just because\nthat child does not know that the primary domain is offline.\n\n\nModified:\n   branches/SAMBA_3_0/source/nsswitch/winbindd_cache.c\n   branches/SAMBA_3_0_26/source/nsswitch/winbindd_cache.c\n\n\nChangeset:\nModified: branches/SAMBA_3_0/source/nsswitch/winbindd_cache.c\n===================================================================\n--- branches/SAMBA_3_0/source/nsswitch/winbindd_cache.c\t2007-05-06 21:34:24 UTC (rev 22725)\n+++ branches/SAMBA_3_0/source/nsswitch/winbindd_cache.c\t2007-05-06 21:36:20 UTC (rev 22726)\n@@ -2448,6 +2448,7 @@\n \tstruct cache_entry *centry = NULL;\n \tNTSTATUS status;\n \tfstring uname;\n+\tBOOL original_online_state;\t\n \n \tdomain = find_lookup_domain_from_name(domain_name);\n \tif (domain == NULL) {\n@@ -2463,7 +2464,14 @@\n \tfstrcpy(uname, name);\n \tstrupper_m(uname);\n \t\n+\t/* If we are doing a cached logon, temporarily set the domain\n+\t   offline so the cache won't expire the entry */\n+\t\n+\toriginal_online_state = domain->online;\n+\tdomain->online = False;\n \tcentry = wcache_fetch(cache, domain, \"NS/%s/%s\", domain_name, uname);\n+\tdomain->online = original_online_state;\n+\t\n \tif (centry == NULL) {\n \t\treturn False;\n \t}\n\nModified: branches/SAMBA_3_0_26/source/nsswitch/winbindd_cache.c\n===================================================================\n--- branches/SAMBA_3_0_26/source/nsswitch/winbindd_cache.c\t2007-05-06 21:34:24 UTC (rev 22725)\n+++ branches/SAMBA_3_0_26/source/nsswitch/winbindd_cache.c\t2007-05-06 21:36:20 UTC (rev 22726)\n@@ -2426,6 +2426,7 @@\n \tstruct cache_entry *centry = NULL;\n \tNTSTATUS status;\n \tfstring uname;\n+\tBOOL original_online_state;\t\n \n \tdomain = find_lookup_domain_from_name(domain_name);\n \tif (domain == NULL) {\n@@ -2441,7 +2442,14 @@\n \tfstrcpy(uname, name);\n \tstrupper_m(uname);\n \t\n+\t/* If we are doing a cached logon, temporarily set the domain\n+\t   offline so the cache won't expire the entry */\n+\t\n+\toriginal_online_state = domain->online;\n+\tdomain->online = False;\n \tcentry = wcache_fetch(cache, domain, \"NS/%s/%s\", domain_name, uname);\n+\tdomain->online = original_online_state;\n+\t\n \tif (centry == NULL) {\n \t\treturn False;\n \t}\n\n"}