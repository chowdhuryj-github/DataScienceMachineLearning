{"category": "ham", "to_address": "samba-cvs@samba.org", "from_address": "gd@samba.org", "subject": "svn commit: samba r22666 - in branches/SAMBA_3_0/source: libads\n\tnsswitch", "body": "Author: gd\nDate: 2007-05-04 10:21:39 +0000 (Fri, 04 May 2007)\nNew Revision: 22666\n\nWebSVN: http://websvn.samba.org/cgi-bin/viewcvs.cgi?view=rev&root=samba&rev=22666\n\nLog:\nExpand kerberos_kinit_password_ext() to return NTSTATUS codes and make\nwinbindd's kerberized pam_auth use that.\n\nGuenther\n\nModified:\n   branches/SAMBA_3_0/source/libads/kerberos.c\n   branches/SAMBA_3_0/source/nsswitch/winbindd_cred_cache.c\n   branches/SAMBA_3_0/source/nsswitch/winbindd_pam.c\n\n\nChangeset:\nModified: branches/SAMBA_3_0/source/libads/kerberos.c\n===================================================================\n--- branches/SAMBA_3_0/source/libads/kerberos.c\t2007-05-04 10:02:47 UTC (rev 22665)\n+++ branches/SAMBA_3_0/source/libads/kerberos.c\t2007-05-04 10:21:39 UTC (rev 22666)\n@@ -189,7 +189,8 @@\n \t\t\t\tconst char *cache_name,\n \t\t\t\tBOOL request_pac,\n \t\t\t\tBOOL add_netbios_addr,\n-\t\t\t\ttime_t renewable_time)\n+\t\t\t\ttime_t renewable_time,\n+\t\t\t\tNTSTATUS *ntstatus)\n {\n \tkrb5_context ctx = NULL;\n \tkrb5_error_code code = 0;\n@@ -267,6 +268,29 @@\n \t\t*renew_till_time = (time_t) my_creds.times.renew_till;\n \t}\n  out:\n+\tif (ntstatus) {\n+\n+\t\tNTSTATUS status;\n+\n+\t\t/* fast path */\n+\t\tif (code == 0) {\n+\t\t\t*ntstatus = NT_STATUS_OK;\n+\t\t\tgoto cleanup;\n+\t\t}\n+\n+\t\t/* try to get ntstatus code out of krb5_error when we have it\n+\t\t * inside the krb5_get_init_creds_opt - gd */\n+\n+\t\tif (opt && smb_krb5_get_ntstatus_from_krb5_error_init_creds_opt(ctx, opt, &status)) {\n+\t\t\t*ntstatus = status;\n+\t\t\tgoto cleanup;\n+\t\t}\n+\n+\t\t/* fall back to self-made-mapping */\n+\t\t*ntstatus = krb5_to_nt_status(code);\n+\t}\n+\n+ cleanup:\n \tkrb5_free_cred_contents(ctx, &my_creds);\n \tif (me) {\n \t\tkrb5_free_principal(ctx, me);\n@@ -321,7 +345,8 @@\n \t}\n \t\n \tret = kerberos_kinit_password_ext(s, ads->auth.password, ads->auth.time_offset,\n-\t\t\t&ads->auth.tgt_expire, NULL, NULL, False, False, ads->auth.renewable);\n+\t\t\t&ads->auth.tgt_expire, NULL, NULL, False, False, ads->auth.renewable, \n+\t\t\tNULL);\n \n \tif (ret) {\n \t\tDEBUG(0,(\"kerberos_kinit_password %s failed: %s\\n\", \n@@ -580,7 +605,8 @@\n \t\t\t\t\t   cache_name,\n \t\t\t\t\t   False,\n \t\t\t\t\t   False,\n-\t\t\t\t\t   0);\n+\t\t\t\t\t   0,\n+\t\t\t\t\t   NULL);\n }\n \n /************************************************************************\n\nModified: branches/SAMBA_3_0/source/nsswitch/winbindd_cred_cache.c\n===================================================================\n--- branches/SAMBA_3_0/source/nsswitch/winbindd_cred_cache.c\t2007-05-04 10:02:47 UTC (rev 22665)\n+++ branches/SAMBA_3_0/source/nsswitch/winbindd_cred_cache.c\t2007-05-04 10:21:39 UTC (rev 22666)\n@@ -111,7 +111,8 @@\n \t\t\t\t\t\t  entry->ccname,\n \t\t\t\t\t\t  False, /* no PAC required anymore */\n \t\t\t\t\t\t  True,\n-\t\t\t\t\t\t  WINBINDD_PAM_AUTH_KRB5_RENEW_TIME);\n+\t\t\t\t\t\t  WINBINDD_PAM_AUTH_KRB5_RENEW_TIME,\n+\t\t\t\t\t\t  NULL);\n \t\tgain_root_privilege();\n \n \t\tif (ret) {\n@@ -224,7 +225,8 @@\n \t\t\t\t\t\tentry->ccname,\n \t\t\t\t\t\tFalse, /* no PAC required anymore */\n \t\t\t\t\t\tTrue,\n-\t\t\t\t\t\tWINBINDD_PAM_AUTH_KRB5_RENEW_TIME);\n+\t\t\t\t\t\tWINBINDD_PAM_AUTH_KRB5_RENEW_TIME,\n+\t\t\t\t\t\tNULL);\n \t\tgain_root_privilege();\n \n \t\tif (ret) {\n\nModified: branches/SAMBA_3_0/source/nsswitch/winbindd_pam.c\n===================================================================\n--- branches/SAMBA_3_0/source/nsswitch/winbindd_pam.c\t2007-05-04 10:02:47 UTC (rev 22665)\n+++ branches/SAMBA_3_0/source/nsswitch/winbindd_pam.c\t2007-05-04 10:21:39 UTC (rev 22666)\n@@ -564,12 +564,12 @@\n \t\t\t\t\t       cc, \n \t\t\t\t\t       True,\n \t\t\t\t\t       True,\n-\t\t\t\t\t       WINBINDD_PAM_AUTH_KRB5_RENEW_TIME);\n+\t\t\t\t\t       WINBINDD_PAM_AUTH_KRB5_RENEW_TIME,\n+\t\t\t\t\t       &result);\n \n \tif (krb5_ret) {\n \t\tDEBUG(1,(\"winbindd_raw_kerberos_login: kinit failed for '%s' with: %s (%d)\\n\", \n \t\t\tprincipal_s, error_message(krb5_ret), krb5_ret));\n-\t\tresult = krb5_to_nt_status(krb5_ret);\n \t\tgoto failed;\n \t}\n \n\n"}