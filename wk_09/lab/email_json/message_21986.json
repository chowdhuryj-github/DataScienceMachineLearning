{"category": "ham", "to_address": "samba-cvs@samba.org", "from_address": "tridge@samba.org", "subject": "Rev 241: don't zero beyond packet header unnecessarily in\n\thttp://samba.org/~tridge/ctdb", "body": "------------------------------------------------------------\nrevno: 241\nrevision-id: tridge@samba.org-20070503034427-cafju1wds7214w62\nparent: tridge@samba.org-20070503021603-p9q4auw135pzf905\ncommitter: Andrew Tridgell \nbranch nick: tridge\ntimestamp: Thu 2007-05-03 13:44:27 +1000\nmessage:\n  don't zero beyond packet header unnecessarily\nmodified:\n  common/ctdb_daemon.c           ctdb_daemon.c-20070409200331-3el1kqgdb9m4ib0g-1\n=== modified file 'common/ctdb_daemon.c'\n--- a/common/ctdb_daemon.c\t2007-05-02 19:51:46 +0000\n+++ b/common/ctdb_daemon.c\t2007-05-03 03:44:27 +0000\n@@ -727,7 +727,9 @@\n {\n \tint size;\n \tstruct ctdb_req_header *hdr;\n-\tsize = ((length+1)+(CTDB_DS_ALIGNMENT-1)) & ~(CTDB_DS_ALIGNMENT-1);\n+\n+\tlength = MAX(length, slength);\n+\tsize = (length+(CTDB_DS_ALIGNMENT-1)) & ~(CTDB_DS_ALIGNMENT-1);\n \n \thdr = (struct ctdb_req_header *)talloc_size(mem_ctx, size);\n \tif (hdr == NULL) {\n@@ -736,9 +738,9 @@\n \t\treturn NULL;\n \t}\n \ttalloc_set_name_const(hdr, type);\n-\tmemset(hdr, 0, size);\n+\tmemset(hdr, 0, slength);\n+\thdr->length       = length;\n \thdr->operation    = operation;\n-\thdr->length       = size;\n \thdr->ctdb_magic   = CTDB_MAGIC;\n \thdr->ctdb_version = CTDB_VERSION;\n \thdr->srcnode      = ctdb->vnn;\n@@ -761,7 +763,10 @@\n {\n \tint size;\n \tstruct ctdb_req_header *hdr;\n-\tsize = ((length+1)+(CTDB_DS_ALIGNMENT-1)) & ~(CTDB_DS_ALIGNMENT-1);\n+\n+\tlength = MAX(length, slength);\n+\tsize = (length+(CTDB_DS_ALIGNMENT-1)) & ~(CTDB_DS_ALIGNMENT-1);\n+\n \thdr = (struct ctdb_req_header *)ctdb->methods->allocate_pkt(mem_ctx, size);\n \tif (hdr == NULL) {\n \t\tDEBUG(0,(\"Unable to allocate transport packet for operation %u of length %u\\n\",\n@@ -769,9 +774,9 @@\n \t\treturn NULL;\n \t}\n \ttalloc_set_name_const(hdr, type);\n-\tmemset(hdr, 0, size);\n+\tmemset(hdr, 0, slength);\n+\thdr->length       = length;\n \thdr->operation    = operation;\n-\thdr->length       = size;\n \thdr->ctdb_magic   = CTDB_MAGIC;\n \thdr->ctdb_version = CTDB_VERSION;\n \thdr->generation   = ctdb->vnn_map->generation;\n\n"}