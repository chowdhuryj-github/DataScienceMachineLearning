{"category": "ham", "to_address": "samba-cvs@samba.org", "from_address": "metze@samba.org", "subject": "svn commit: samba r22749 - in branches/SAMBA_4_0/source/libcli/nbt:\n\t.", "body": "Author: metze\nDate: 2007-05-07 15:27:50 +0000 (Mon, 07 May 2007)\nNew Revision: 22749\n\nWebSVN: http://websvn.samba.org/cgi-bin/viewcvs.cgi?view=rev&root=samba&rev=22749\n\nLog:\nfix memory leak of nbt_name_request structure which are used to send replies\nand never have an async callback that could free it.\n\nwe only had the memory leak in the error path the\nstandard path was ok.\n\nmetze\nModified:\n   branches/SAMBA_4_0/source/libcli/nbt/nbtsocket.c\n\n\nChangeset:\nModified: branches/SAMBA_4_0/source/libcli/nbt/nbtsocket.c\n===================================================================\n--- branches/SAMBA_4_0/source/libcli/nbt/nbtsocket.c\t2007-05-07 15:19:53 UTC (rev 22748)\n+++ branches/SAMBA_4_0/source/libcli/nbt/nbtsocket.c\t2007-05-07 15:27:50 UTC (rev 22749)\n@@ -45,6 +45,7 @@\n \t\treq->name_trn_id = 0;\n \t}\n \tif (req->te) {\n+\t\ttalloc_free(req->te);\n \t\treq->te = NULL;\n \t}\n \tif (req->nbtsock->send_queue == NULL) {\n@@ -102,6 +103,8 @@\n \ttalloc_free(tmp_ctx);\n \tif (req->async.fn) {\n \t\treq->async.fn(req);\n+\t} else if (req->is_reply) {\n+\t\ttalloc_free(req);\n \t}\n \treturn;\n }\n@@ -140,6 +143,8 @@\n \t}\n \tif (req->async.fn) {\n \t\treq->async.fn(req);\n+\t} else if (req->is_reply) {\n+\t\ttalloc_free(req);\n \t}\n }\n \n@@ -462,9 +467,7 @@\n \t\tif (event_loop_once(req->nbtsock->event_ctx) != 0) {\n \t\t\treq->state = NBT_REQUEST_ERROR;\n \t\t\treq->status = NT_STATUS_UNEXPECTED_NETWORK_ERROR;\n-\t\t\tif (req->async.fn) {\n-\t\t\t\treq->async.fn(req);\n-\t\t\t}\n+\t\t\tbreak;\n \t\t}\n \t}\n \treturn req->status;\n\n"}