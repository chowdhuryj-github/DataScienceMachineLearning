{"category": "ham", "to_address": "samba-cvs@samba.org", "from_address": "abartlet@samba.org", "subject": "svn commit: samba r22187 - in branches/SAMBA_4_0:\n\tsource/auth/credentials source/script/tests testprogs/blackbox", "body": "Author: abartlet\nDate: 2007-04-12 10:25:01 +0000 (Thu, 12 Apr 2007)\nNew Revision: 22187\n\nWebSVN: http://websvn.samba.org/cgi-bin/viewcvs.cgi?view=rev&root=samba&rev=22187\n\nLog:\nTest kerberos logins in the smbclient blackbox tests, including with a\nmachine account.\n\nAndrew Bartlett\n\nModified:\n   branches/SAMBA_4_0/source/auth/credentials/credentials_krb5.c\n   branches/SAMBA_4_0/source/script/tests/mktestdc.sh\n   branches/SAMBA_4_0/source/script/tests/test_blackbox.sh\n   branches/SAMBA_4_0/testprogs/blackbox/test_smbclient.sh\n\n\nChangeset:\nModified: branches/SAMBA_4_0/source/auth/credentials/credentials_krb5.c\n===================================================================\n--- branches/SAMBA_4_0/source/auth/credentials/credentials_krb5.c\t2007-04-12 10:19:02 UTC (rev 22186)\n+++ branches/SAMBA_4_0/source/auth/credentials/credentials_krb5.c\t2007-04-12 10:25:01 UTC (rev 22187)\n@@ -248,6 +248,10 @@\n {\n \tkrb5_error_code ret;\n \t\n+\tif (cred->machine_account_pending) {\n+\t\tcli_credentials_set_machine_account(cred);\n+\t}\n+\n \tif (cred->ccache_obtained >= (MAX(cred->principal_obtained, \n \t\t\t\t\t  cred->username_obtained))) {\n \t\t*ccc = cred->ccache;\n\nModified: branches/SAMBA_4_0/source/script/tests/mktestdc.sh\n===================================================================\n--- branches/SAMBA_4_0/source/script/tests/mktestdc.sh\t2007-04-12 10:19:02 UTC (rev 22186)\n+++ branches/SAMBA_4_0/source/script/tests/mktestdc.sh\t2007-04-12 10:25:01 UTC (rev 22187)\n@@ -210,6 +210,11 @@\n   admin_server = 127.0.0.1:88\n   default_domain = $DNSNAME\n  }\n+ $DNSNAME = {\n+  kdc = 127.0.0.1:88\n+  admin_server = 127.0.0.1:88\n+  default_domain = $DNSNAME\n+ }\n  $DOMAIN = {\n   kdc = 127.0.0.1:88\n   admin_server = 127.0.0.1:88\n\nModified: branches/SAMBA_4_0/source/script/tests/test_blackbox.sh\n===================================================================\n--- branches/SAMBA_4_0/source/script/tests/test_blackbox.sh\t2007-04-12 10:19:02 UTC (rev 22186)\n+++ branches/SAMBA_4_0/source/script/tests/test_blackbox.sh\t2007-04-12 10:25:01 UTC (rev 22187)\n@@ -16,5 +16,5 @@\n incdir=`dirname $0`\n . $incdir/test_functions.sh\n \n-plantest \"blackbox.smbclient\" dc $incdir/../../../testprogs/blackbox/test_smbclient.sh \"\\$SERVER\" \"\\$USERNAME\" \"\\$PASSWORD\" \"\\$DOMAIN\" \"$PREFIX\" \"$ADDARGS\"\n-plantest \"blackbox.cifsdd\" dc $incdir/../../../testprogs/blackbox/test_cifsdd.sh \"\\$SERVER\" \"\\$USERNAME\" \"\\$PASSWORD\" \"\\$DOMAIN\" \"$ADDARGS\"\n+plantest \"blackbox.smbclient\" dc $incdir/../../../testprogs/blackbox/test_smbclient.sh \"\\$NETBIOSNAME\" \"\\$USERNAME\" \"\\$PASSWORD\" \"\\$DOMAIN\" \"$PREFIX\" \"$ADDARGS\"\n+plantest \"blackbox.cifsdd\" dc $incdir/../../../testprogs/blackbox/test_cifsdd.sh \"\\$NETBIOSNAME\" \"\\$USERNAME\" \"\\$PASSWORD\" \"\\$DOMAIN\" \"$ADDARGS\"\n\nModified: branches/SAMBA_4_0/testprogs/blackbox/test_smbclient.sh\n===================================================================\n--- branches/SAMBA_4_0/testprogs/blackbox/test_smbclient.sh\t2007-04-12 10:19:02 UTC (rev 22186)\n+++ branches/SAMBA_4_0/testprogs/blackbox/test_smbclient.sh\t2007-04-12 10:25:01 UTC (rev 22187)\n@@ -96,8 +96,10 @@\n echo ls | runcmd \"List directory with LANMAN1\" -m LANMAN1 || failed=`expr $failed + 1`\n echo ls | runcmd \"List directory with LANMAN2\" -m LANMAN2 || failed=`expr $failed + 1`\n \n-echo ls | testit \"Test login with --machine-pass\" $VALGRIND bin/smbclient $CONFIGURATION //$SERVER/tmp --machine-pass  || failed=`expr $failed + 1`\n+echo ls | testit \"Test login with --machine-pass without kerberos\" $VALGRIND bin/smbclient $CONFIGURATION //$SERVER/tmp --machine-pass -k no || failed=`expr $failed + 1`\n \n+echo ls | testit \"Test login with --machine-pass and kerberos\" $VALGRIND bin/smbclient $CONFIGURATION //$SERVER/tmp --machine-pass -k yes || failed=`expr $failed + 1`\n+\n (\n     echo \"password=$PASSWORD\"\n     echo \"username=$USERNAME\"\n\n"}