{"category": "ham", "to_address": "samba-cvs@samba.org", "from_address": "tridge@samba.org", "subject": "svn commit: samba r22634 - in branches/SAMBA_4_0/source/lib/events:\n\t.", "body": "Author: tridge\nDate: 2007-05-01 21:29:42 +0000 (Tue, 01 May 2007)\nNew Revision: 22634\n\nWebSVN: http://websvn.samba.org/cgi-bin/viewcvs.cgi?view=rev&root=samba&rev=22634\n\nLog:\n\nmake the events system much less dependent on the samba4 build system\n\nModified:\n   branches/SAMBA_4_0/source/lib/events/config.mk\n   branches/SAMBA_4_0/source/lib/events/events.c\n   branches/SAMBA_4_0/source/lib/events/events_aio.c\n   branches/SAMBA_4_0/source/lib/events/events_epoll.c\n   branches/SAMBA_4_0/source/lib/events/events_internal.h\n   branches/SAMBA_4_0/source/lib/events/events_select.c\n   branches/SAMBA_4_0/source/lib/events/events_signal.c\n   branches/SAMBA_4_0/source/lib/events/events_standard.c\n\n\nChangeset:\nModified: branches/SAMBA_4_0/source/lib/events/config.mk\n===================================================================\n--- branches/SAMBA_4_0/source/lib/events/config.mk\t2007-05-01 21:22:55 UTC (rev 22633)\n+++ branches/SAMBA_4_0/source/lib/events/config.mk\t2007-05-01 21:29:42 UTC (rev 22634)\n@@ -3,28 +3,28 @@\n OBJ_FILES = events_aio.o\n PRIVATE_DEPENDENCIES = LIBAIO_LINUX\n SUBSYSTEM = LIBEVENTS\n-INIT_FUNCTION = events_aio_init\n+INIT_FUNCTION = s4_events_aio_init\n ##############################\n \n ##############################\n [MODULE::EVENTS_EPOLL]\n OBJ_FILES = events_epoll.o\n SUBSYSTEM = LIBEVENTS\n-INIT_FUNCTION = events_epoll_init\n+INIT_FUNCTION = s4_events_epoll_init\n ##############################\n \n ##############################\n [MODULE::EVENTS_SELECT]\n OBJ_FILES = events_select.o\n SUBSYSTEM = LIBEVENTS\n-INIT_FUNCTION = events_select_init\n+INIT_FUNCTION = s4_events_select_init\n ##############################\n \n ##############################\n [MODULE::EVENTS_STANDARD]\n OBJ_FILES = events_standard.o\n SUBSYSTEM = LIBEVENTS\n-INIT_FUNCTION = events_standard_init\n+INIT_FUNCTION = s4_events_standard_init\n ##############################\n \n \n\nModified: branches/SAMBA_4_0/source/lib/events/events.c\n===================================================================\n--- branches/SAMBA_4_0/source/lib/events/events.c\t2007-05-01 21:22:55 UTC (rev 22633)\n+++ branches/SAMBA_4_0/source/lib/events/events.c\t2007-05-01 21:29:42 UTC (rev 22634)\n@@ -58,7 +58,9 @@\n #include \"lib/events/events.h\"\n #include \"lib/events/events_internal.h\"\n #include \"lib/util/dlinklist.h\"\n+#if _SAMBA_BUILD_\n #include \"build.h\"\n+#endif\n \n struct event_ops_list {\n \tstruct event_ops_list *next, *prev;\n@@ -72,15 +74,15 @@\n /*\n   register an events backend\n */\n-NTSTATUS event_register_backend(const char *name, const struct event_ops *ops)\n+bool event_register_backend(const char *name, const struct event_ops *ops)\n {\n \tstruct event_ops_list *e;\n \te = talloc(talloc_autofree_context(), struct event_ops_list);\n-\tNT_STATUS_HAVE_NO_MEMORY(e);\n+\tif (e == NULL) return False;\n \te->name = name;\n \te->ops = ops;\n \tDLIST_ADD(event_backends, e);\n-\treturn NT_STATUS_OK;\n+\treturn True;\n }\n \n /*\n@@ -88,12 +90,17 @@\n */\n static void event_backend_init(void)\n {\n+#if _SAMBA_BUILD_\n \tinit_module_fn static_init[] = STATIC_LIBEVENTS_MODULES;\n \tinit_module_fn *shared_init;\n \tif (event_backends) return;\n \tshared_init = load_samba_modules(NULL, \"LIBEVENTS\");\n \trun_init_functions(static_init);\n \trun_init_functions(shared_init);\n+#else\n+\tbool events_standard_init(void);\n+\tevents_standard_init();\n+#endif\n }\n \n /*\n\nModified: branches/SAMBA_4_0/source/lib/events/events_aio.c\n===================================================================\n--- branches/SAMBA_4_0/source/lib/events/events_aio.c\t2007-05-01 21:22:55 UTC (rev 22633)\n+++ branches/SAMBA_4_0/source/lib/events/events_aio.c\t2007-05-01 21:29:42 UTC (rev 22634)\n@@ -165,9 +165,9 @@\n \n static void epoll_change_event(struct aio_event_context *aio_ev, struct fd_event *fde)\n {\n-\tBOOL got_error = (fde->additional_flags & EPOLL_ADDITIONAL_FD_FLAG_GOT_ERROR);\n-\tBOOL want_read = (fde->flags & EVENT_FD_READ);\n-\tBOOL want_write= (fde->flags & EVENT_FD_WRITE);\n+\tbool got_error = (fde->additional_flags & EPOLL_ADDITIONAL_FD_FLAG_GOT_ERROR);\n+\tbool want_read = (fde->flags & EVENT_FD_READ);\n+\tbool want_write= (fde->flags & EVENT_FD_WRITE);\n \n \tif (aio_ev->epoll_fd == -1) return;\n \n@@ -512,7 +512,17 @@\n \t.loop_wait\t= aio_event_loop_wait,\n };\n \n-NTSTATUS events_aio_init(void)\n+bool events_aio_init(void)\n {\n \treturn event_register_backend(\"aio\", &aio_event_ops);\n }\n+\n+#if _SAMBA_BUILD_\n+NTSTATUS s4_events_aio_init(void)\n+{\n+\tif (!events_aio_init()) {\n+\t\treturn NT_STATUS_INTERNAL_ERROR;\n+\t}\n+\treturn NT_STATUS_OK;\n+}\n+#endif\n\nModified: branches/SAMBA_4_0/source/lib/events/events_epoll.c\n===================================================================\n--- branches/SAMBA_4_0/source/lib/events/events_epoll.c\t2007-05-01 21:22:55 UTC (rev 22633)\n+++ branches/SAMBA_4_0/source/lib/events/events_epoll.c\t2007-05-01 21:29:42 UTC (rev 22634)\n@@ -165,9 +165,9 @@\n \n static void epoll_change_event(struct epoll_event_context *epoll_ev, struct fd_event *fde)\n {\n-\tBOOL got_error = (fde->additional_flags & EPOLL_ADDITIONAL_FD_FLAG_GOT_ERROR);\n-\tBOOL want_read = (fde->flags & EVENT_FD_READ);\n-\tBOOL want_write= (fde->flags & EVENT_FD_WRITE);\n+\tbool got_error = (fde->additional_flags & EPOLL_ADDITIONAL_FD_FLAG_GOT_ERROR);\n+\tbool want_read = (fde->flags & EVENT_FD_READ);\n+\tbool want_write= (fde->flags & EVENT_FD_WRITE);\n \n \tif (epoll_ev->epoll_fd == -1) return;\n \n@@ -413,7 +413,17 @@\n \t.loop_wait\t= epoll_event_loop_wait,\n };\n \n-NTSTATUS events_epoll_init(void)\n+bool events_epoll_init(void)\n {\n \treturn event_register_backend(\"epoll\", &epoll_event_ops);\n }\n+\n+#if _SAMBA_BUILD_\n+NTSTATUS s4_events_epoll_init(void)\n+{\n+\tif (!events_epoll_init()) {\n+\t\treturn NT_STATUS_INTERNAL_ERROR;\n+\t}\n+\treturn NT_STATUS_OK;\n+}\n+#endif\n\nModified: branches/SAMBA_4_0/source/lib/events/events_internal.h\n===================================================================\n--- branches/SAMBA_4_0/source/lib/events/events_internal.h\t2007-05-01 21:22:55 UTC (rev 22633)\n+++ branches/SAMBA_4_0/source/lib/events/events_internal.h\t2007-05-01 21:29:42 UTC (rev 22634)\n@@ -113,7 +113,7 @@\n };\n \n \n-NTSTATUS event_register_backend(const char *name, const struct event_ops *ops);\n+bool event_register_backend(const char *name, const struct event_ops *ops);\n \n struct timed_event *common_event_add_timed(struct event_context *, TALLOC_CTX *,\n \t\t\t\t\t   struct timeval, event_timed_handler_t, void *);\n\nModified: branches/SAMBA_4_0/source/lib/events/events_select.c\n===================================================================\n--- branches/SAMBA_4_0/source/lib/events/events_select.c\t2007-05-01 21:22:55 UTC (rev 22633)\n+++ branches/SAMBA_4_0/source/lib/events/events_select.c\t2007-05-01 21:29:42 UTC (rev 22634)\n@@ -291,7 +291,17 @@\n \t.loop_wait\t= select_event_loop_wait,\n };\n \n-NTSTATUS events_select_init(void)\n+bool events_select_init(void)\n {\n \treturn event_register_backend(\"select\", &select_event_ops);\n }\n+\n+#if _SAMBA_BUILD_\n+NTSTATUS s4_events_select_init(void)\n+{\n+\tif (!events_select_init()) {\n+\t\treturn NT_STATUS_INTERNAL_ERROR;\n+\t}\n+\treturn NT_STATUS_OK;\n+}\n+#endif\n\nModified: branches/SAMBA_4_0/source/lib/events/events_signal.c\n===================================================================\n--- branches/SAMBA_4_0/source/lib/events/events_signal.c\t2007-05-01 21:22:55 UTC (rev 22633)\n+++ branches/SAMBA_4_0/source/lib/events/events_signal.c\t2007-05-01 21:29:42 UTC (rev 22634)\n@@ -23,6 +23,7 @@\n #include \"includes.h\"\n #include \"system/filesys.h\"\n #include \"system/select.h\"\n+#include \"system/wait.h\"\n #include \"lib/util/dlinklist.h\"\n #include \"lib/events/events.h\"\n #include \"lib/events/events_internal.h\"\n\nModified: branches/SAMBA_4_0/source/lib/events/events_standard.c\n===================================================================\n--- branches/SAMBA_4_0/source/lib/events/events_standard.c\t2007-05-01 21:22:55 UTC (rev 22633)\n+++ branches/SAMBA_4_0/source/lib/events/events_standard.c\t2007-05-01 21:29:42 UTC (rev 22634)\n@@ -180,9 +180,9 @@\n \n static void epoll_change_event(struct std_event_context *std_ev, struct fd_event *fde)\n {\n-\tBOOL got_error = (fde->additional_flags & EPOLL_ADDITIONAL_FD_FLAG_GOT_ERROR);\n-\tBOOL want_read = (fde->flags & EVENT_FD_READ);\n-\tBOOL want_write= (fde->flags & EVENT_FD_WRITE);\n+\tbool got_error = (fde->additional_flags & EPOLL_ADDITIONAL_FD_FLAG_GOT_ERROR);\n+\tbool want_read = (fde->flags & EVENT_FD_READ);\n+\tbool want_write= (fde->flags & EVENT_FD_WRITE);\n \n \tif (std_ev->epoll_fd == -1) return;\n \n@@ -549,7 +549,17 @@\n };\n \n \n-NTSTATUS events_standard_init(void)\n+bool events_standard_init(void)\n {\n \treturn event_register_backend(\"standard\", &std_event_ops);\n }\n+\n+#if _SAMBA_BUILD_\n+NTSTATUS s4_events_standard_init(void)\n+{\n+\tif (!events_standard_init()) {\n+\t\treturn NT_STATUS_INTERNAL_ERROR;\n+\t}\n+\treturn NT_STATUS_OK;\n+}\n+#endif\n\n"}