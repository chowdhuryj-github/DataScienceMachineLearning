{"category": "ham", "to_address": "samba-cvs@samba.org", "from_address": "tridge@samba.org", "subject": "Rev 132: we should not lock in a normal ctdb_call(),\n\tas we want them to run concurrently in http://samba.org/~tridge/ctdb", "body": "------------------------------------------------------------\nrevno: 132\nrevision-id: tridge@samba.org-20070417063453-11bf89e87ab63211\nparent: tridge@samba.org-20070417062032-cf77c470b80c77d1\ncommitter: Andrew Tridgell \nbranch nick: tridge\ntimestamp: Tue 2007-04-17 16:34:53 +1000\nmessage:\n  we should not lock in a normal ctdb_call(), as we want them to run concurrently\nmodified:\n  common/ctdb_client.c           ctdb_client.c-20070411010216-3kd8v37k61steeya-1\n=== modified file 'common/ctdb_client.c'\n--- a/common/ctdb_client.c\t2007-04-17 06:20:32 +0000\n+++ b/common/ctdb_client.c\t2007-04-17 06:34:53 +0000\n@@ -245,22 +245,14 @@\n \t\tux_socket_connect(ctdb);\n \t}\n \n-\tret = ctdb_ltdb_lock(ctdb_db, call->key);\n-\tif (ret != 0) {\n-\t\tprintf(\"failed to lock ltdb record\\n\");\n-\t\treturn NULL;\n-\t}\n-\n \tret = ctdb_ltdb_fetch(ctdb_db, call->key, &header, ctdb_db, &data);\n \tif (ret != 0) {\n-\t\tctdb_ltdb_unlock(ctdb_db, call->key);\n \t\treturn NULL;\n \t}\n \n #if 0\n \tif (header.dmaster == ctdb->vnn && !(ctdb->flags & CTDB_FLAG_SELF_CONNECT)) {\n \t\tstate = ctdb_call_local_send(ctdb_db, call, &header, &data);\n-\t\tctdb_ltdb_unlock(ctdb_db, call->key);\n \t\treturn state;\n \t}\n #endif\n@@ -268,7 +260,6 @@\n \tstate = talloc_zero(ctdb_db, struct ctdb_call_state);\n \tif (state == NULL) {\n \t\tprintf(\"failed to allocate state\\n\");\n-\t\tctdb_ltdb_unlock(ctdb_db, call->key);\n \t\treturn NULL;\n \t}\n \n@@ -278,7 +269,6 @@\n \tstate->c = ctdbd_allocate_pkt(ctdb, len);\n \tif (state->c == NULL) {\n \t\tprintf(\"failed to allocate packet\\n\");\n-\t\tctdb_ltdb_unlock(ctdb_db, call->key);\n \t\treturn NULL;\n \t}\n \ttalloc_set_name_const(state->c, \"ctdbd req_call packet\");\n@@ -318,7 +308,6 @@\n \t\t\tctdb_call_timeout, state);\n */\n \n-\tctdb_ltdb_unlock(ctdb_db, call->key);\n \treturn state;\n }\n \n\n"}