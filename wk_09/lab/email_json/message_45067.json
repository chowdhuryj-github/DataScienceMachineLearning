{"category": "ham", "to_address": "Jeremy Allison <jra@samba.org>", "from_address": "James Peach <jpeach@samba.org>", "subject": "Re: [PATCH 1/4] Make sure groups[0] is the effective gid on FreeBSD.", "body": "On Jun 8, 2007, at 9:48 AM, Jeremy Allison wrote:\n\n> On Fri, Jun 08, 2007 at 09:01:44AM -0700, James Peach wrote:\n>>\n>> There's 2 related issues in this patch set. The first is the BSD- \n>> style\n>> changes for setgroups, the second is the Darwin-specific changes to\n>> the order of credential operations.\n>\n> If it's Darwin specific then I want it split into a Darwin-specific\n> change.\n>\n>> The current code intertwines these two parts in two places,\n>> set_sec_ctx() and pop_sec_ctx(). I felt that splitting the credential\n>> switch into a separate function made this a lot clearer. There is\n>> exactly one place where the credential is switched and the credential\n>> switching code is not mixed with the security context stack  \n>> management\n>> code. The result is credential switching code that is easier to read,\n>> audit and log.\n>\n> Sez you. The existing code works, and works well on all\n> but one class of broken systems (*BSD).\n\nYes sez me :)\n\nI think that it's a mistake to separate the set of system calls used  \nto alter your credentials, because switching to a credential is a  \nlogically single operation that should pass or fail as a whole. In  \nSAMBA_4_0, the credential switch is done in a single function,  \nset_unix_security(). This seems to me to be the right way to do it.\n\n> Please do not modify existing working code, just fix\n> the specific problem. Don't get creative here.\n>\n>> Yep, I have a tree with a similar patch, but the Darwin initgroups\n>> wrapper needs to be passed the UID you are switching to.  \n>> Additionally,\n>> for Darwin the order of operations in the credential switch is\n>> important. This means that I can't hide all of this behind\n>> sys_setgroups().\n>\n> That's a Darwin bug (IMHO). Their credentials system is now\n> non-POSIX and now non-standard.\n>\n> When are they planning to fix that ?\n>\n>> I would be very happy to split apply_unix_token into a separate  \n>> Darwin\n>> implementation, if you would prefer that better. Perhaps it is poorly\n>> named, maybe it should be:\n>>\n>> \tBOOL switch_to_credential(const UNIX_USER_TOKEN *ut)\n>\n> No, I want the change I asked for - a modified\n> sys_setgroups that works for *BSD.\n\nI originally had this, but I didn't like how this interacted with  \nHAVE_SETGROUPS and HAVE_BROKEN_SETGROUPS. I thought it best to  \nmaintain the existing convention that the sys_* wrappers should call  \nthe thing they wrap as precisely as possibly.\n\nI'll work up a patch containing just the modified sys_setgroups and  \npost that before committing anything.\n\n--\nJames Peach | jpeach@samba.org\n\n"}