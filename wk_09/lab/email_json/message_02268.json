{"category": "ham", "to_address": "Jeremy Allison <jra@samba.org>", "from_address": "Jeremy Allison <jra@samba.org>", "subject": "Re: tdb_transaction_cancel", "body": "On Tue, Apr 10, 2007 at 09:52:47PM -0700, Jeremy Allison wrote:\n> On Wed, Apr 11, 2007 at 01:41:49PM +1000, tridge@samba.org wrote:\n> > \n> > Volker, this seems to have been broken by r21303 in Samba3. Can you\n> > remember why you removed the \n> >    tdb->locked[h].count = 0;\n> > line in that commit? Without that line the tdb still thinks the tdb is\n> > locked after a transaction cancel.\n> > \n> > I know the code has to change, as lockrecs is now dynamic, but I think\n> > we need something equivalent there. Perhaps we can just deleting the\n> > list? You are not allowed to start a transaction when locks are held,\n> > so we should be able to wipe the lock list when the transaction is\n> > cancelled.\n> \n> I think you're correct. Here's a patch - let me know what\n> you think.\n> \n> Jeremy.\n\n> Index: tdb/common/transaction.c\n> ===================================================================\n> --- tdb/common/transaction.c\t(revision 22131)\n> +++ tdb/common/transaction.c\t(working copy)\n> @@ -523,6 +523,8 @@\n>  \t\t\t\t   F_UNLCK,F_SETLKW, 0, 1);\n>  \t\t}\n>  \t\ttdb->num_locks = 0;\n> +\t\ttdb->num_lockrecs = 0;\n> +\t\tSAFE_FREE(tdb->lockrecs);\n>  \t}\n>  \n>  \t/* restore the normal io methods */\n\n\nJerry,\n\n\tFYI: Fixing this is a show-stopper for 3.0.25\nas the tdb transaction code is now used in the printing,\nsecrets, registry and share tdb's.\n\nJeremy.\n\n"}