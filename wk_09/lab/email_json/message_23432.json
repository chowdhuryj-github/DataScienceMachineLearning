{"category": "ham", "to_address": "samba-cvs@samba.org", "from_address": "tridge@samba.org", "subject": "Rev 255: show number of connected clients in status output in\n\thttp://samba.org/~tridge/ctdb", "body": "------------------------------------------------------------\nrevno: 255\nrevision-id: tridge@samba.org-20070505040946-iji1cxsyb8ail7bk\nparent: tridge@samba.org-20070505010310-wlknjyla4cqkbdld\ncommitter: Andrew Tridgell \nbranch nick: tridge\ntimestamp: Sat 2007-05-05 14:09:46 +1000\nmessage:\n  show number of connected clients in status output\nmodified:\n  common/ctdb_control.c          ctdb_control.c-20070426122724-j6gkpiofhbwdin63-1\n  common/ctdb_daemon.c           ctdb_daemon.c-20070409200331-3el1kqgdb9m4ib0g-1\n  include/ctdb_private.h         ctdb_private.h-20061117234101-o3qt14umlg9en8z0-13\n  tools/ctdb_control.c           ctdb_control.c-20070426122705-9ehj1l5lu2gn9kuj-1\n=== modified file 'common/ctdb_control.c'\n--- a/common/ctdb_control.c\t2007-05-05 01:03:10 +0000\n+++ b/common/ctdb_control.c\t2007-05-05 04:09:46 +0000\n@@ -359,7 +359,7 @@\n \tcase CTDB_CONTROL_PING:\n \t\tCHECK_CONTROL_DATA_SIZE(0);\n \t\tctdb->status.controls.ping++;\n-\t\treturn ctdb->num_clients;\n+\t\treturn ctdb->status.num_clients;\n \n \tcase CTDB_CONTROL_GET_DBNAME: {\n \t\tuint32_t db_id;\n\n=== modified file 'common/ctdb_daemon.c'\n--- a/common/ctdb_daemon.c\t2007-05-04 01:41:29 +0000\n+++ b/common/ctdb_daemon.c\t2007-05-05 04:09:46 +0000\n@@ -248,7 +248,7 @@\n static int ctdb_client_destructor(struct ctdb_client *client)\n {\n \tctdb_reqid_remove(client->ctdb, client->client_id);\n-\tclient->ctdb->num_clients--;\n+\tclient->ctdb->status.num_clients--;\n \tclose(client->fd);\n \tclient->fd = -1;\n \treturn 0;\n@@ -559,7 +559,7 @@\n \tclient->ctdb = ctdb;\n \tclient->fd = fd;\n \tclient->client_id = ctdb_reqid_new(ctdb, client);\n-\tctdb->num_clients++;\n+\tctdb->status.num_clients++;\n \n \tclient->queue = ctdb_queue_setup(ctdb, client, fd, CTDB_DS_ALIGNMENT, \n \t\t\t\t\t ctdb_daemon_read_cb, client);\n\n=== modified file 'include/ctdb_private.h'\n--- a/include/ctdb_private.h\t2007-05-05 01:03:10 +0000\n+++ b/include/ctdb_private.h\t2007-05-05 04:09:46 +0000\n@@ -131,6 +131,7 @@\n   ctdb status information\n  */\n struct ctdb_status {\n+\tuint32_t num_clients;\n \tuint32_t client_packets_sent;\n \tuint32_t client_packets_recv;\n \tuint32_t node_packets_sent;\n\n=== modified file 'tools/ctdb_control.c'\n--- a/tools/ctdb_control.c\t2007-05-05 01:03:10 +0000\n+++ b/tools/ctdb_control.c\t2007-05-05 04:09:46 +0000\n@@ -97,6 +97,7 @@\n \t\tuint32_t offset;\n \t} fields[] = {\n #define STATUS_FIELD(n) { #n, offsetof(struct ctdb_status, n) }\n+\t\tSTATUS_FIELD(num_clients),\n \t\tSTATUS_FIELD(client_packets_sent),\n \t\tSTATUS_FIELD(client_packets_recv),\n \t\tSTATUS_FIELD(node_packets_sent),\n\n"}