{"category": "ham", "to_address": "samba-cvs@samba.org", "from_address": "obnox@samba.org", "subject": "svn commit: samba r22777 - in branches: SAMBA_3_0/source\n\tSAMBA_3_0/source/modules SAMBA_3_0_25/source\n\tSAMBA_3_0_25/source/modules SAMBA_3_0_26/source\n\tSAMBA_3_0_26/source/modules", "body": "Author: obnox\nDate: 2007-05-10 13:31:15 +0000 (Thu, 10 May 2007)\nNew Revision: 22777\n\nWebSVN: http://websvn.samba.org/cgi-bin/viewcvs.cgi?view=rev&root=samba&rev=22777\n\nLog:\nFix for [Bug 4543] - POSIX ACL support on FreeBSD.\n\nThis adds vfs_posixacl to the list of static modules and\nmakes use of HAVE_ACL_GET_PERM_NP.\n\nThis is just a quick fix. FreeBSD acl support is still\nhardcoded in configure.in, but actually this could be\ndetected in a unified test for freebsd, linux, *,\nas suggested in the bugreport. This has still to be\nchecked and elaborated.\n\nMichael\n\n\nModified:\n   branches/SAMBA_3_0/source/configure.in\n   branches/SAMBA_3_0/source/modules/vfs_posixacl.c\n   branches/SAMBA_3_0_25/source/configure.in\n   branches/SAMBA_3_0_25/source/modules/vfs_posixacl.c\n   branches/SAMBA_3_0_26/source/configure.in\n   branches/SAMBA_3_0_26/source/modules/vfs_posixacl.c\n\n\nChangeset:\nModified: branches/SAMBA_3_0/source/configure.in\n===================================================================\n--- branches/SAMBA_3_0/source/configure.in\t2007-05-10 12:41:20 UTC (rev 22776)\n+++ branches/SAMBA_3_0/source/configure.in\t2007-05-10 13:31:15 UTC (rev 22777)\n@@ -5303,6 +5303,7 @@\n \t\tAC_MSG_RESULT(Using FreeBSD posix ACLs)\n \t\tAC_DEFINE(HAVE_POSIX_ACLS,1,[Whether FreeBSD POSIX ACLs are available])\n \t\tAC_DEFINE(HAVE_ACL_GET_PERM_NP,1,[Whether acl_get_perm_np() is available])\n+\t\tdefault_static_modules=\"$default_static_modules vfs_posixacl\"\n \t\t;;\n \t*linux*)\n \t\tAC_CHECK_LIB(attr,getxattr,[ACL_LIBS=\"$ACL_LIBS -lattr\"])\n\nModified: branches/SAMBA_3_0/source/modules/vfs_posixacl.c\n===================================================================\n--- branches/SAMBA_3_0/source/modules/vfs_posixacl.c\t2007-05-10 12:41:20 UTC (rev 22776)\n+++ branches/SAMBA_3_0/source/modules/vfs_posixacl.c\t2007-05-10 13:31:15 UTC (rev 22777)\n@@ -200,9 +200,15 @@\n \t\treturn False;\n \t}\n \tace->a_perm = 0;\n+#ifdef HAVE_ACL_GET_PERM_NP\n+\tace->a_perm |= (acl_get_perm_np(permset, ACL_READ) ? SMB_ACL_READ : 0);\n+\tace->a_perm |= (acl_get_perm_np(permset, ACL_WRITE) ? SMB_ACL_WRITE : 0);\n+\tace->a_perm |= (acl_get_perm_np(permset, ACL_EXECUTE) ? SMB_ACL_EXECUTE : 0);\n+#else\n \tace->a_perm |= (acl_get_perm(permset, ACL_READ) ? SMB_ACL_READ : 0);\n \tace->a_perm |= (acl_get_perm(permset, ACL_WRITE) ? SMB_ACL_WRITE : 0);\n \tace->a_perm |= (acl_get_perm(permset, ACL_EXECUTE) ? SMB_ACL_EXECUTE : 0);\n+#endif\n \treturn True;\n }\n \n\nModified: branches/SAMBA_3_0_25/source/configure.in\n===================================================================\n--- branches/SAMBA_3_0_25/source/configure.in\t2007-05-10 12:41:20 UTC (rev 22776)\n+++ branches/SAMBA_3_0_25/source/configure.in\t2007-05-10 13:31:15 UTC (rev 22777)\n@@ -5140,6 +5140,7 @@\n \t\tAC_MSG_RESULT(Using FreeBSD posix ACLs)\n \t\tAC_DEFINE(HAVE_POSIX_ACLS,1,[Whether FreeBSD POSIX ACLs are available])\n \t\tAC_DEFINE(HAVE_ACL_GET_PERM_NP,1,[Whether acl_get_perm_np() is available])\n+\t\tdefault_static_modules=\"$default_static_modules vfs_posixacl\"\n \t\t;;\n \t*linux*)\n \t\tAC_CHECK_LIB(attr,getxattr,[ACL_LIBS=\"$ACL_LIBS -lattr\"])\n\nModified: branches/SAMBA_3_0_25/source/modules/vfs_posixacl.c\n===================================================================\n--- branches/SAMBA_3_0_25/source/modules/vfs_posixacl.c\t2007-05-10 12:41:20 UTC (rev 22776)\n+++ branches/SAMBA_3_0_25/source/modules/vfs_posixacl.c\t2007-05-10 13:31:15 UTC (rev 22777)\n@@ -200,9 +200,15 @@\n \t\treturn False;\n \t}\n \tace->a_perm = 0;\n+#ifdef HAVE_ACL_GET_PERM_NP\n+\tace->a_perm |= (acl_get_perm_np(permset, ACL_READ) ? SMB_ACL_READ : 0);\n+\tace->a_perm |= (acl_get_perm_np(permset, ACL_WRITE) ? SMB_ACL_WRITE : 0);\n+\tace->a_perm |= (acl_get_perm_np(permset, ACL_EXECUTE) ? SMB_ACL_EXECUTE : 0);\n+#else\n \tace->a_perm |= (acl_get_perm(permset, ACL_READ) ? SMB_ACL_READ : 0);\n \tace->a_perm |= (acl_get_perm(permset, ACL_WRITE) ? SMB_ACL_WRITE : 0);\n \tace->a_perm |= (acl_get_perm(permset, ACL_EXECUTE) ? SMB_ACL_EXECUTE : 0);\n+#endif\n \treturn True;\n }\n \n\nModified: branches/SAMBA_3_0_26/source/configure.in\n===================================================================\n--- branches/SAMBA_3_0_26/source/configure.in\t2007-05-10 12:41:20 UTC (rev 22776)\n+++ branches/SAMBA_3_0_26/source/configure.in\t2007-05-10 13:31:15 UTC (rev 22777)\n@@ -5140,6 +5140,7 @@\n \t\tAC_MSG_RESULT(Using FreeBSD posix ACLs)\n \t\tAC_DEFINE(HAVE_POSIX_ACLS,1,[Whether FreeBSD POSIX ACLs are available])\n \t\tAC_DEFINE(HAVE_ACL_GET_PERM_NP,1,[Whether acl_get_perm_np() is available])\n+\t\tdefault_static_modules=\"$default_static_modules vfs_posixacl\"\n \t\t;;\n \t*linux*)\n \t\tAC_CHECK_LIB(attr,getxattr,[ACL_LIBS=\"$ACL_LIBS -lattr\"])\n\nModified: branches/SAMBA_3_0_26/source/modules/vfs_posixacl.c\n===================================================================\n--- branches/SAMBA_3_0_26/source/modules/vfs_posixacl.c\t2007-05-10 12:41:20 UTC (rev 22776)\n+++ branches/SAMBA_3_0_26/source/modules/vfs_posixacl.c\t2007-05-10 13:31:15 UTC (rev 22777)\n@@ -200,9 +200,15 @@\n \t\treturn False;\n \t}\n \tace->a_perm = 0;\n+#ifdef HAVE_ACL_GET_PERM_NP\n+\tace->a_perm |= (acl_get_perm_np(permset, ACL_READ) ? SMB_ACL_READ : 0);\n+\tace->a_perm |= (acl_get_perm_np(permset, ACL_WRITE) ? SMB_ACL_WRITE : 0);\n+\tace->a_perm |= (acl_get_perm_np(permset, ACL_EXECUTE) ? SMB_ACL_EXECUTE : 0);\n+#else\n \tace->a_perm |= (acl_get_perm(permset, ACL_READ) ? SMB_ACL_READ : 0);\n \tace->a_perm |= (acl_get_perm(permset, ACL_WRITE) ? SMB_ACL_WRITE : 0);\n \tace->a_perm |= (acl_get_perm(permset, ACL_EXECUTE) ? SMB_ACL_EXECUTE : 0);\n+#endif\n \treturn True;\n }\n \n\n"}