{"category": "ham", "to_address": "samba-cvs@samba.org", "from_address": "tridge@samba.org", "subject": "Rev 601: when we get mappings back from a idmap script. store it\n\tinto the permanent db in http://samba.org/~tridge/3_0-ctdb", "body": "------------------------------------------------------------\nrevno: 601\nrevision-id: tridge@samba.org-20070618231102-yosa0a9c5s1bna3r\nparent: tridge@samba.org-20070617210000-tq41u51ojd7f7erk\ncommitter: Andrew Tridgell \nbranch nick: s3-ctdb-tridge\ntimestamp: Tue 2007-06-19 09:11:02 +1000\nmessage:\n  when we get mappings back from a idmap script. store it into the permanent db\nmodified:\n  source/nsswitch/idmap_tdb2.c   idmap_tdb2.c-20070531053925-e5x7av5etjs83rk0-1\n=== modified file 'source/nsswitch/idmap_tdb2.c'\n--- a/source/nsswitch/idmap_tdb2.c\t2007-06-14 21:35:12 +0000\n+++ b/source/nsswitch/idmap_tdb2.c\t2007-06-18 23:11:02 +0000\n@@ -602,6 +602,14 @@\n \t\tDEBUG(10,(\"Record %s not found\\n\", keystr));\n \t\tif (idmap_tdb2_state.idmap_script) {\n \t\t\tret = idmap_tdb2_script(ctx, map, \"IDTOSID %s\", keystr);\n+\t\t\t/* store it on shared storage */\n+\t\t\tif (NT_STATUS_IS_OK(ret)) {\n+\t\t\t\tfstring sidstr;\n+\t\t\t\tif (sid_to_string(sidstr, map->sid)) {\n+\t\t\t\t\ttdb2_store_bystring(keystr, string_term_tdb_data(sidstr), \n+\t\t\t\t\t\t\t    TDB_REPLACE);\n+\t\t\t\t}\n+\t\t\t}\n \t\t} else {\n \t\t\tret = NT_STATUS_NONE_MAPPED;\n \t\t}\n@@ -649,6 +657,14 @@\n \t\tDEBUG(10,(__location__ \" Record %s not found\\n\", keystr));\n \t\tif (idmap_tdb2_state.idmap_script) {\n \t\t\tret = idmap_tdb2_script(ctx, map, \"SIDTOID %s\", keystr);\n+\t\t\t/* store it on shared storage */\n+\t\t\tif (NT_STATUS_IS_OK(ret)) {\n+\t\t\t\tfstring idstr;\n+\t\t\t\tsnprintf(idstr, sizeof(idstr), \"%cID %lu\", \n+\t\t\t\t\t map->xid.type == ID_TYPE_UID?'U':'G',\n+\t\t\t\t\t (unsigned long)map->xid.id);\n+\t\t\t\ttdb2_store_bystring(keystr, string_term_tdb_data(idstr), TDB_REPLACE);\n+\t\t\t}\n \t\t} else {\n \t\t\tret = NT_STATUS_NONE_MAPPED;\n \t\t}\n\n"}