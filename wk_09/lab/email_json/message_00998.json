{"category": "ham", "to_address": "samba-cvs@samba.org", "from_address": "jra@samba.org", "subject": "svn commit: samba r22145 - in branches: SAMBA_3_0/source/smbd\n\tSAMBA_3_0_25/source/smbd", "body": "Author: jra\nDate: 2007-04-09 21:01:46 +0000 (Mon, 09 Apr 2007)\nNew Revision: 22145\n\nWebSVN: http://websvn.samba.org/cgi-bin/viewcvs.cgi?view=rev&root=samba&rev=22145\n\nLog:\nFix bug #4494 - reported by Kevin Jamieson .\nIf returning a mapped UNIX error from sendfile, don't call chain_reply.\nJeremy.\n\nModified:\n   branches/SAMBA_3_0/source/smbd/process.c\n   branches/SAMBA_3_0/source/smbd/reply.c\n   branches/SAMBA_3_0_25/source/smbd/process.c\n   branches/SAMBA_3_0_25/source/smbd/reply.c\n\n\nChangeset:\nModified: branches/SAMBA_3_0/source/smbd/process.c\n===================================================================\n--- branches/SAMBA_3_0/source/smbd/process.c\t2007-04-09 18:56:26 UTC (rev 22144)\n+++ branches/SAMBA_3_0/source/smbd/process.c\t2007-04-09 21:01:46 UTC (rev 22145)\n@@ -1161,8 +1161,8 @@\n \tchar outbuf_saved[smb_wct];\n \tint outsize = smb_len(outbuf) + 4;\n \n-\t/* maybe its not chained */\n-\tif (smb_com2 == 0xFF) {\n+\t/* Maybe its not chained, or it's an error packet. */\n+\tif (smb_com2 == 0xFF || SVAL(outbuf,smb_rcls) != 0) {\n \t\tSCVAL(outbuf,smb_vwv0,0xFF);\n \t\treturn outsize;\n \t}\n\nModified: branches/SAMBA_3_0/source/smbd/reply.c\n===================================================================\n--- branches/SAMBA_3_0/source/smbd/reply.c\t2007-04-09 18:56:26 UTC (rev 22144)\n+++ branches/SAMBA_3_0/source/smbd/reply.c\t2007-04-09 21:01:46 UTC (rev 22145)\n@@ -2706,8 +2706,10 @@\n \t}\n \n \tnread = send_file_readX(conn, inbuf, outbuf, length, bufsize, fsp, startpos, smb_maxcnt);\n-\tif (nread != -1)\n+\t/* Only call chain_reply if not an error. */\n+\tif (nread != -1 && SVAL(outbuf,smb_rcls) == 0) {\n \t\tnread = chain_reply(inbuf,outbuf,length,bufsize);\n+\t}\n \n \tEND_PROFILE(SMBreadX);\n \treturn nread;\n\nModified: branches/SAMBA_3_0_25/source/smbd/process.c\n===================================================================\n--- branches/SAMBA_3_0_25/source/smbd/process.c\t2007-04-09 18:56:26 UTC (rev 22144)\n+++ branches/SAMBA_3_0_25/source/smbd/process.c\t2007-04-09 21:01:46 UTC (rev 22145)\n@@ -1153,8 +1153,8 @@\n \tchar outbuf_saved[smb_wct];\n \tint outsize = smb_len(outbuf) + 4;\n \n-\t/* maybe its not chained */\n-\tif (smb_com2 == 0xFF) {\n+\t/* Maybe its not chained, or it's an error packet. */\n+\tif (smb_com2 == 0xFF || SVAL(outbuf,smb_rcls) != 0) {\n \t\tSCVAL(outbuf,smb_vwv0,0xFF);\n \t\treturn outsize;\n \t}\n\nModified: branches/SAMBA_3_0_25/source/smbd/reply.c\n===================================================================\n--- branches/SAMBA_3_0_25/source/smbd/reply.c\t2007-04-09 18:56:26 UTC (rev 22144)\n+++ branches/SAMBA_3_0_25/source/smbd/reply.c\t2007-04-09 21:01:46 UTC (rev 22145)\n@@ -2705,8 +2705,10 @@\n \t}\n \n \tnread = send_file_readX(conn, inbuf, outbuf, length, bufsize, fsp, startpos, smb_maxcnt);\n-\tif (nread != -1)\n+\t/* Only call chain_reply if not an error. */\n+\tif (nread != -1 && SVAL(outbuf,smb_rcls) == 0) {\n \t\tnread = chain_reply(inbuf,outbuf,length,bufsize);\n+\t}\n \n \tEND_PROFILE(SMBreadX);\n \treturn nread;\n\n"}