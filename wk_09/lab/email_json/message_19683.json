{"category": "ham", "to_address": "samba-cvs@samba.org", "from_address": "tridge@samba.org", "subject": "Rev 222: saner logfile code in http://samba.org/~tridge/ctdb", "body": "------------------------------------------------------------\nrevno: 222\nrevision-id: tridge@samba.org-20070429204223-p3irof22u7mgolo6\nparent: tridge@samba.org-20070429141940-kxbij0fq3pj33qvn\ncommitter: Andrew Tridgell \nbranch nick: tridge\ntimestamp: Sun 2007-04-29 22:42:23 +0200\nmessage:\n  saner logfile code\n  testing of ctdbd\nmodified:\n  Makefile.in                    makefile.in-20061117234101-o3qt14umlg9en8z0-1\n  common/cmdline.c               cmdline.c-20070416041216-w1zvz91bkdsgjckw-1\n  common/ctdb.c                  ctdb.c-20061127094323-t50f58d65iaao5of-2\n  direct/ctdbd.c                 ctdbd.c-20070411085044-dqmhr6mfeexnyt4m-1\n  direct/ctdbd.sh                ctdbd.sh-20070411085038-phusiewluwzyqjpc-2\n  include/ctdb.h                 ctdb.h-20061117234101-o3qt14umlg9en8z0-11\n  include/ctdb_private.h         ctdb_private.h-20061117234101-o3qt14umlg9en8z0-13\n  tests/run_tests.sh             run_tests.sh-20070428085745-ec2w6vybjf07vtvg-1\n=== modified file 'Makefile.in'\n--- a/Makefile.in\t2007-04-28 15:13:02 +0000\n+++ b/Makefile.in\t2007-04-29 20:42:23 +0000\n@@ -7,6 +7,7 @@\n includedir = @includedir@\n libdir = @libdir@\n bindir = @bindir@\n+localstatedir = @localstatedir@\n VPATH = @srcdir@:@tdbdir@:@tallocdir@:@libreplacedir@\n srcdir = @srcdir@\n builddir = @builddir@\n@@ -14,7 +15,7 @@\n \n CFLAGS=-g -I$(srcdir)/include -Iinclude -Ilib/util -I$(srcdir) \\\n        -I@tallocdir@ -I@tdbdir@/include -I@libreplacedir@ \\\n-\t-DLIBDIR=\\\"$(libdir)\\\" -DSHLIBEXT=\\\"@SHLIBEXT@\\\" -DUSE_MMAP=1 @CFLAGS@\n+\t-DVARDIR=\\\"$(localstatedir)\\\" -DUSE_MMAP=1 @CFLAGS@\n \n LIB_FLAGS=@LDFLAGS@ -Llib @LIBS@ -lpopt @INFINIBAND_LIBS@\n \n\n=== modified file 'common/cmdline.c'\n--- a/common/cmdline.c\t2007-04-27 08:43:52 +0000\n+++ b/common/cmdline.c\t2007-04-29 20:42:23 +0000\n@@ -36,6 +36,7 @@\n \tint self_connect;\n \tconst char *db_dir;\n \tint torture;\n+\tconst char *logfile;\n } ctdb_cmdline = {\n \t.nlist = NULL,\n \t.transport = \"tcp\",\n@@ -43,7 +44,8 @@\n \t.socketname = CTDB_PATH,\n \t.self_connect = 0,\n \t.db_dir = NULL,\n-\t.torture = 0\n+\t.torture = 0,\n+\t.logfile = NULL\n };\n \n \n@@ -56,6 +58,7 @@\n \t{ \"debug\", 'd', POPT_ARG_INT, &LogLevel, 0, \"debug level\"},\n \t{ \"dbdir\", 0, POPT_ARG_STRING, &ctdb_cmdline.db_dir, 0, \"directory for the tdb files\", NULL },\n \t{ \"torture\", 0, POPT_ARG_NONE, &ctdb_cmdline.torture, 0, \"enable nastiness in library\", NULL },\n+\t{ \"logfile\", 0, POPT_ARG_STRING, &ctdb_cmdline.logfile, 0, \"log file location\", \"filename\" },\n \t{ NULL }\n };\n \n@@ -80,6 +83,12 @@\n \t\texit(1);\n \t}\n \n+\tret = ctdb_set_logfile(ctdb, ctdb_cmdline.logfile);\n+\tif (ret == -1) {\n+\t\tprintf(\"ctdb_set_logfile failed - %s\\n\", ctdb_errstr(ctdb));\n+\t\texit(1);\n+\t}\n+\n \tif (ctdb_cmdline.self_connect) {\n \t\tctdb_set_flags(ctdb, CTDB_FLAG_SELF_CONNECT);\n \t}\n\n=== modified file 'common/ctdb.c'\n--- a/common/ctdb.c\t2007-04-28 16:18:33 +0000\n+++ b/common/ctdb.c\t2007-04-29 20:42:23 +0000\n@@ -35,6 +35,27 @@\n \treturn 0;\n }\n \n+/*\n+  choose the logfile location\n+*/\n+int ctdb_set_logfile(struct ctdb_context *ctdb, const char *logfile)\n+{\n+\tctdb->logfile = talloc_strdup(ctdb, logfile);\n+\tif (ctdb->logfile != NULL) {\n+\t\tint fd;\n+\t\tclose(1);\n+\t\tfd = open(ctdb->logfile, O_WRONLY|O_APPEND|O_CREAT, 0666);\n+\t\tif (fd == -1) {\n+\t\t\tabort();\n+\t\t}\n+\t\tif (fd != 1) {\n+\t\t\tdup2(fd, 1);\n+\t\t\tclose(fd);\n+\t\t}\n+\t}\n+\treturn 0;\n+}\n+\n \n /*\n   set some ctdb flags\n\n=== modified file 'direct/ctdbd.c'\n--- a/direct/ctdbd.c\t2007-04-29 14:19:40 +0000\n+++ b/direct/ctdbd.c\t2007-04-29 20:42:23 +0000\n@@ -24,6 +24,7 @@\n #include \"popt.h\"\n #include \"system/wait.h\"\n #include \"cmdline.h\"\n+#include \"../include/ctdb_private.h\"\n \n static void block_signal(int signum)\n {\n@@ -83,6 +84,13 @@\n \n \tctdb = ctdb_cmdline_init(ev);\n \n+\t/* useful default logfile */\n+\tif (ctdb->logfile == NULL) {\n+\t\tchar *name = talloc_asprintf(ctdb, \"%s/log.ctdb.%u\", VARDIR, ctdb->vnn);\n+\t\tctdb_set_logfile(ctdb, name);\n+\t\ttalloc_free(name);\n+\t}\n+\n \t/* attach to the list of databases */\n \ts = talloc_strdup(ctdb, db_list);\n \tfor (tok=strtok(s, \", \"); tok; tok=strtok(NULL, \", \")) {\n\n=== modified file 'direct/ctdbd.sh'\n--- a/direct/ctdbd.sh\t2007-04-19 00:24:11 +0000\n+++ b/direct/ctdbd.sh\t2007-04-29 20:42:23 +0000\n@@ -3,6 +3,28 @@\n killall -q ctdbd\n \n echo \"Starting 2 ctdb daemons\"\n-bin/ctdbd --nlist direct/nodes.txt --listen 127.0.0.2:9001 &\n-bin/ctdbd --nlist direct/nodes.txt --listen 127.0.0.1:9001 &\n+bin/ctdbd --nlist direct/nodes.txt --listen 127.0.0.2:9001\n+bin/ctdbd --nlist direct/nodes.txt --listen 127.0.0.1:9001\n+\n+echo \"Testing ping\"\n+bin/ctdb_control ping || exit 1\n+\n+echo \"Testing status\"\n+bin/ctdb_control status all || exit 1\n+\n+echo \"Testing statusreset\"\n+bin/ctdb_control statusreset all || exit 1\n+\n+echo \"Testing debug\"\n+bin/ctdb_control debug all 5 || exit 1\n+bin/ctdb_control debuglevel || exit 1\n+bin/ctdb_control debug all 0 || exit 1\n+bin/ctdb_control debuglevel || exit 1\n+\n+echo \"Testing map calls\"\n+bin/ctdb_control getvnnmap 0 || exit 1\n+bin/ctdb_control getdbmap 0 || exit 1\n+\n+killall -q ctdbd\n+\n \n\n=== modified file 'include/ctdb.h'\n--- a/include/ctdb.h\t2007-04-29 14:19:40 +0000\n+++ b/include/ctdb.h\t2007-04-29 20:42:23 +0000\n@@ -259,4 +259,6 @@\n \n int ctdb_status_reset(struct ctdb_context *ctdb, uint32_t destnode);\n \n+int ctdb_set_logfile(struct ctdb_context *ctdb, const char *logfile);\n+\n #endif\n\n=== modified file 'include/ctdb_private.h'\n--- a/include/ctdb_private.h\t2007-04-29 14:19:40 +0000\n+++ b/include/ctdb_private.h\t2007-04-29 20:42:23 +0000\n@@ -176,6 +176,7 @@\n \tconst char *name;\n \tconst char *db_directory;\n \tconst char *transport;\n+\tconst char *logfile;\n \tuint32_t vnn; /* our own vnn */\n \tuint32_t num_nodes;\n \tuint32_t num_connected;\n\n=== modified file 'tests/run_tests.sh'\n--- a/tests/run_tests.sh\t2007-04-28 16:18:33 +0000\n+++ b/tests/run_tests.sh\t2007-04-29 20:42:23 +0000\n@@ -3,6 +3,7 @@\n tests/fetch.sh 4 || exit 1\n tests/bench.sh 4 || exit 1\n tests/test.sh || exit 1\n+direct/ctdbd.sh || exit 1\n \n echo \"All OK\"\n exit 0\n\n"}