{"category": "ham", "to_address": "samba-cvs@samba.org", "from_address": "tridge@samba.org", "subject": "Rev 402: close sockets when we exec scripts in\n\thttp://samba.org/~tridge/ctdb", "body": "------------------------------------------------------------\nrevno: 402\nrevision-id: tridge@samba.org-20070530054325-s8i707ydww0omcor\nparent: tridge@samba.org-20070530044614-e6rt2yb1v1345p34\ncommitter: Andrew Tridgell \nbranch nick: tridge\ntimestamp: Wed 2007-05-30 15:43:25 +1000\nmessage:\n  close sockets when we exec scripts\nmodified:\n  common/ctdb_client.c           ctdb_client.c-20070411010216-3kd8v37k61steeya-1\n  common/ctdb_daemon.c           ctdb_daemon.c-20070409200331-3el1kqgdb9m4ib0g-1\n  common/ctdb_util.c             ctdb_util.c-20061128065342-to93h6eejj5kon81-3\n  include/ctdb_private.h         ctdb_private.h-20061117234101-o3qt14umlg9en8z0-13\n  tcp/tcp_connect.c              tcp_connect.c-20061128004937-x70q1cu5xzg5g2tm-1\n=== modified file 'common/ctdb_client.c'\n--- a/common/ctdb_client.c\t2007-05-29 03:58:41 +0000\n+++ b/common/ctdb_client.c\t2007-05-30 05:43:25 +0000\n@@ -174,6 +174,9 @@\n \tif (ctdb->daemon.sd == -1) {\n \t\treturn -1;\n \t}\n+\n+\tset_nonblocking(ctdb->daemon.sd);\n+\tset_close_on_exec(ctdb->daemon.sd);\n \t\n \tif (connect(ctdb->daemon.sd, (struct sockaddr *)&addr, sizeof(addr)) == -1) {\n \t\tclose(ctdb->daemon.sd);\n\n=== modified file 'common/ctdb_daemon.c'\n--- a/common/ctdb_daemon.c\t2007-05-30 04:35:22 +0000\n+++ b/common/ctdb_daemon.c\t2007-05-30 05:43:25 +0000\n@@ -101,13 +101,6 @@\n }\n \n \n-static void set_non_blocking(int fd)\n-{\n-\tunsigned v;\n-\tv = fcntl(fd, F_GETFL, 0);\n-        fcntl(fd, F_SETFL, v | O_NONBLOCK);\n-}\n-\n static void block_signal(int signum)\n {\n \tstruct sigaction act;\n@@ -585,7 +578,9 @@\n \tif (fd == -1) {\n \t\treturn;\n \t}\n-\tset_non_blocking(fd);\n+\n+\tset_nonblocking(fd);\n+\tset_close_on_exec(fd);\n \n \tclient = talloc_zero(ctdb, struct ctdb_client);\n \tclient->ctdb = ctdb;\n@@ -634,6 +629,9 @@\n \t\treturn -1;\n \t}\n \n+\tset_nonblocking(ctdb->daemon.sd);\n+\tset_close_on_exec(ctdb->daemon.sd);\n+\n #if 0\n \t/* AIX doesn't like this :( */\n \tif (fchown(ctdb->daemon.sd, geteuid(), getegid()) != 0 ||\n@@ -643,7 +641,7 @@\n \t}\n #endif\n \n-\tset_non_blocking(ctdb->daemon.sd);\n+\tset_nonblocking(ctdb->daemon.sd);\n \n \tmemset(&addr, 0, sizeof(addr));\n \taddr.sun_family = AF_UNIX;\n\n=== modified file 'common/ctdb_util.c'\n--- a/common/ctdb_util.c\t2007-05-29 05:15:00 +0000\n+++ b/common/ctdb_util.c\t2007-05-30 05:43:25 +0000\n@@ -217,3 +217,18 @@\n \t}\n #endif\n }\n+\n+void set_nonblocking(int fd)\n+{\n+\tunsigned v;\n+\tv = fcntl(fd, F_GETFL, 0);\n+        fcntl(fd, F_SETFL, v | O_NONBLOCK);\n+}\n+\n+void set_close_on_exec(int fd)\n+{\n+\tunsigned v;\n+\tv = fcntl(fd, F_GETFD, 0);\n+        fcntl(fd, F_SETFD, v | FD_CLOEXEC);\n+}\n+\n\n=== modified file 'include/ctdb_private.h'\n--- a/include/ctdb_private.h\t2007-05-30 03:26:50 +0000\n+++ b/include/ctdb_private.h\t2007-05-30 05:43:25 +0000\n@@ -955,6 +955,8 @@\n \t\t\t       const char *fmt, ...) PRINTF_ATTRIBUTE(3,4);\n void ctdb_release_all_ips(struct ctdb_context *ctdb);\n \n+void set_nonblocking(int fd);\n+void set_close_on_exec(int fd);\n \n \n #endif\n\n=== modified file 'tcp/tcp_connect.c'\n--- a/tcp/tcp_connect.c\t2007-05-25 12:07:45 +0000\n+++ b/tcp/tcp_connect.c\t2007-05-30 05:43:25 +0000\n@@ -26,14 +26,6 @@\n #include \"../include/ctdb_private.h\"\n #include \"ctdb_tcp.h\"\n \n-static void set_nonblocking(int fd)\n-{\n-\tunsigned v;\n-\tv = fcntl(fd, F_GETFL, 0);\n-        fcntl(fd, F_SETFL, v | O_NONBLOCK);\n-}\n-\n-\n /*\n   called when a complete packet has come in - should not happen on this socket\n  */\n@@ -134,6 +126,7 @@\n \ttnode->fd = socket(PF_INET, SOCK_STREAM, IPPROTO_TCP);\n \n \tset_nonblocking(tnode->fd);\n+\tset_close_on_exec(tnode->fd);\n \n \tZERO_STRUCT(sock_out);\n #ifdef HAVE_SOCK_SIN_LEN\n@@ -213,6 +206,7 @@\n \tin->ctdb = ctdb;\n \n \tset_nonblocking(in->fd);\n+\tset_close_on_exec(in->fd);\n \n         setsockopt(in->fd,SOL_SOCKET,SO_KEEPALIVE,(char *)&one,sizeof(one));\n \n@@ -322,6 +316,8 @@\n \t\treturn -1;\n \t}\n \n+\tset_close_on_exec(ctcp->listen_fd);\n+\n         setsockopt(ctcp->listen_fd,SOL_SOCKET,SO_REUSEADDR,(char *)&one,sizeof(one));\n \n \t/* we can either auto-bind to the first available address, or we can\n\n"}