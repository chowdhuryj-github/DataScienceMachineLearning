{"category": "ham", "to_address": "samba-cvs@samba.org", "from_address": "gd@samba.org", "subject": "svn commit: samba r23129 - in branches/SAMBA_4_0/source: librpc/idl\n\trpc_server/netlogon torture/rpc", "body": "Author: gd\nDate: 2007-05-24 23:38:46 +0000 (Thu, 24 May 2007)\nNew Revision: 23129\n\nWebSVN: http://websvn.samba.org/cgi-bin/viewcvs.cgi?view=rev&root=samba&rev=23129\n\nLog:\nMerge from 3_0:\n\n* netr_DsRGetDCName_flags, netr_DsRGetDCNameInfo_AddressType and netr_DsR_DcFlags\n* the mask in netr_DsRGetDCNameEx2 turns out to be samr_AcctFlags\n\nGuenther\n\nModified:\n   branches/SAMBA_4_0/source/librpc/idl/netlogon.idl\n   branches/SAMBA_4_0/source/rpc_server/netlogon/dcerpc_netlogon.c\n   branches/SAMBA_4_0/source/torture/rpc/netlogon.c\n\n\nChangeset:\nModified: branches/SAMBA_4_0/source/librpc/idl/netlogon.idl\n===================================================================\n--- branches/SAMBA_4_0/source/librpc/idl/netlogon.idl\t2007-05-24 23:17:24 UTC (rev 23128)\n+++ branches/SAMBA_4_0/source/librpc/idl/netlogon.idl\t2007-05-24 23:38:46 UTC (rev 23129)\n@@ -4,7 +4,7 @@\n   who contributed!\n */\n \n-import \"lsa.idl\", \"samr.idl\", \"security.idl\";\n+import \"lsa.idl\", \"samr.idl\", \"security.idl\", \"nbt.idl\";\n \n #include \"idl_types.h\"\n \n@@ -906,15 +906,59 @@\n \tWERROR netr_NETRENUMERATETRUSTEDDOMAINS() ;\n \n \t/*****************/\n-\t/* Function 0x14 */\t\t\n+\t/* Function 0x14 */\n+\n+\t/* two unkown bits still: DS_IP_VERSION_AGNOSTIC and\n+\t * DS_TRY_NEXTCLOSEST_SITE - Guenther */\n+\n+\ttypedef [bitmap32bit] bitmap {\n+\t\tDS_FORCE_REDISCOVERY\t\t= 0x00000001,\n+\t\tDS_DIRECTORY_SERVICE_REQUIRED\t= 0x00000010,\n+\t\tDS_DIRECTORY_SERVICE_PREFERRED\t= 0x00000020,\n+\t\tDS_GC_SERVER_REQUIRED\t\t= 0x00000040,\n+\t\tDS_PDC_REQUIRED\t\t\t= 0x00000080,\n+\t\tDS_BACKGROUND_ONLY\t\t= 0x00000100,\n+\t\tDS_IP_REQUIRED\t\t\t= 0x00000200,\n+\t\tDS_KDC_REQUIRED\t\t\t= 0x00000400,\n+\t\tDS_TIMESERV_REQUIRED\t\t= 0x00000800,\n+\t\tDS_WRITABLE_REQUIRED\t\t= 0x00001000,\n+\t\tDS_GOOD_TIMESERV_PREFERRED\t= 0x00002000,\n+\t\tDS_AVOID_SELF\t\t\t= 0x00004000,\n+\t\tDS_ONLY_LDAP_NEEDED\t\t= 0x00008000,\n+\t\tDS_IS_FLAT_NAME\t\t\t= 0x00010000,\n+\t\tDS_IS_DNS_NAME\t\t\t= 0x00020000,\n+\t\tDS_RETURN_DNS_NAME\t\t= 0x40000000,\n+\t\tDS_RETURN_FLAT_NAME\t\t= 0x80000000\n+\t} netr_DsRGetDCName_flags;\n+\n+\ttypedef [v1_enum] enum {\n+\t\tDS_ADDRESS_TYPE_INET\t\t= 1,\n+\t\tDS_ADDRESS_TYPE_NETBIOS\t\t= 2\n+\t} netr_DsRGetDCNameInfo_AddressType;\n+\n+\ttypedef [bitmap32bit] bitmap {\n+\t\tDS_SERVER_PDC\t\t = NBT_SERVER_PDC,\n+\t\tDS_SERVER_GC\t\t = NBT_SERVER_GC,\n+\t\tDS_SERVER_LDAP\t\t = NBT_SERVER_LDAP,\n+\t\tDS_SERVER_DS\t\t = NBT_SERVER_DS,\n+\t\tDS_SERVER_KDC\t\t = NBT_SERVER_KDC,\n+\t\tDS_SERVER_TIMESERV\t = NBT_SERVER_TIMESERV,\n+\t\tDS_SERVER_CLOSEST\t = NBT_SERVER_CLOSEST,\n+\t\tDS_SERVER_WRITABLE\t = NBT_SERVER_WRITABLE,\n+\t\tDS_SERVER_GOOD_TIMESERV\t = NBT_SERVER_GOOD_TIMESERV,\n+\t\tDS_DNS_CONTROLLER\t = 0x20000000,\n+\t\tDS_DNS_DOMAIN\t\t = 0x40000000,\n+\t\tDS_DNS_FOREST\t\t = 0x80000000\n+\t} netr_DsR_DcFlags;\n+\n \ttypedef struct {\n \t\t[string,charset(UTF16)] uint16 *dc_unc;\n \t\t[string,charset(UTF16)] uint16 *dc_address;\n-\t\tint32 dc_address_type;\n+\t\tnetr_DsRGetDCNameInfo_AddressType dc_address_type;\n \t\tGUID domain_guid;\n \t\t[string,charset(UTF16)] uint16 *domain_name;\n \t\t[string,charset(UTF16)] uint16 *forest_name;\n-\t\tuint32 dc_flags;\n+\t\tnetr_DsR_DcFlags dc_flags;\n \t\t[string,charset(UTF16)] uint16 *dc_site_name;\n \t\t[string,charset(UTF16)] uint16 *client_site_name;\n \t} netr_DsRGetDCNameInfo;\n@@ -924,7 +968,7 @@\n \t\t[in] [string,charset(UTF16)] uint16 *domain_name,\n \t\t[in] GUID *domain_guid,\n \t\t[in] GUID *site_guid,\n-\t\t[in] uint32 flags,\n+\t\t[in] netr_DsRGetDCName_flags flags,\n \t\t[out] netr_DsRGetDCNameInfo *info\n \t\t);\n \n@@ -968,7 +1012,7 @@\n \t\t[in] [string,charset(UTF16)] uint16 *domain_name,\n \t\t[in] GUID *domain_guid,\n \t\t[in] [string,charset(UTF16)] uint16 *site_name,\n-\t\t[in] uint32 flags,\n+\t\t[in] netr_DsRGetDCName_flags flags,\n \t\t[out] netr_DsRGetDCNameInfo *info\n \t\t);\n \n@@ -1079,11 +1123,11 @@\n \tWERROR netr_DsRGetDCNameEx2(\n \t\t[in] [string,charset(UTF16)] uint16 *server_unc,\n \t\t[in] [string,charset(UTF16)] uint16 *client_account,\n-\t\t[in] uint32 mask,\n+\t\t[in] samr_AcctFlags mask,\n \t\t[in] [string,charset(UTF16)] uint16 *domain_name,\n \t\t[in] GUID *domain_guid,\n \t\t[in] [string,charset(UTF16)] uint16 *site_name,\n-\t\t[in] uint32 flags,\n+\t\t[in] netr_DsRGetDCName_flags flags,\n \t\t[out] netr_DsRGetDCNameInfo *info\n \t\t);\n \n\nModified: branches/SAMBA_4_0/source/rpc_server/netlogon/dcerpc_netlogon.c\n===================================================================\n--- branches/SAMBA_4_0/source/rpc_server/netlogon/dcerpc_netlogon.c\t2007-05-24 23:17:24 UTC (rev 23128)\n+++ branches/SAMBA_4_0/source/rpc_server/netlogon/dcerpc_netlogon.c\t2007-05-24 23:38:46 UTC (rev 23129)\n@@ -1010,11 +1010,21 @@\n \tW_ERROR_HAVE_NO_MEMORY(r->out.info->dc_unc);\n \tr->out.info->dc_address\t\t= talloc_strdup(mem_ctx, \"\\\\\\\\0.0.0.0\");\n \tW_ERROR_HAVE_NO_MEMORY(r->out.info->dc_address);\n-\tr->out.info->dc_address_type\t= 1;\n+\tr->out.info->dc_address_type\t= DS_ADDRESS_TYPE_INET;\n \tr->out.info->domain_guid\t= samdb_result_guid(res[0], \"objectGUID\");\n \tr->out.info->domain_name\t= samdb_result_string(res[0], \"dnsDomain\", NULL);\n \tr->out.info->forest_name\t= samdb_result_string(res[0], \"dnsDomain\", NULL);\n-\tr->out.info->dc_flags\t\t= 0xE00001FD;\n+\tr->out.info->dc_flags\t\t= DS_DNS_FOREST |\n+\t\t\t\t\t  DS_DNS_DOMAIN |\n+\t\t\t\t\t  DS_DNS_CONTROLLER |\n+\t\t\t\t\t  DS_SERVER_WRITABLE |\n+\t\t\t\t\t  DS_SERVER_CLOSEST |\n+\t\t\t\t\t  DS_SERVER_TIMESERV |\n+\t\t\t\t\t  DS_SERVER_KDC |\n+\t\t\t\t\t  DS_SERVER_DS |\n+\t\t\t\t\t  DS_SERVER_LDAP |\n+\t\t\t\t\t  DS_SERVER_GC |\n+\t\t\t\t\t  DS_SERVER_PDC;\n \tr->out.info->dc_site_name\t= talloc_strdup(mem_ctx, \"Default-First-Site-Name\");\n \tW_ERROR_HAVE_NO_MEMORY(r->out.info->dc_site_name);\n \tr->out.info->client_site_name\t= talloc_strdup(mem_ctx, \"Default-First-Site-Name\");\n\nModified: branches/SAMBA_4_0/source/torture/rpc/netlogon.c\n===================================================================\n--- branches/SAMBA_4_0/source/torture/rpc/netlogon.c\t2007-05-24 23:17:24 UTC (rev 23128)\n+++ branches/SAMBA_4_0/source/torture/rpc/netlogon.c\t2007-05-24 23:38:46 UTC (rev 23129)\n@@ -1224,7 +1224,7 @@\n \tr.in.domain_name\t= talloc_asprintf(mem_ctx, \"%s\", lp_realm());\n \tr.in.domain_guid\t= NULL;\n \tr.in.site_guid\t        = NULL;\n-\tr.in.flags\t\t= 0x40000000;\n+\tr.in.flags\t\t= DS_RETURN_DNS_NAME;\n \n \tprintf(\"Testing netr_DsRGetDCName\\n\");\n \n@@ -1255,7 +1255,7 @@\n \tr.in.domain_name\t= talloc_asprintf(mem_ctx, \"%s\", lp_realm());\n \tr.in.domain_guid\t= NULL;\n \tr.in.site_name\t        = NULL;\n-\tr.in.flags\t\t= 0x40000000;\n+\tr.in.flags\t\t= DS_RETURN_DNS_NAME;\n \n \tprintf(\"Testing netr_DsRGetDCNameEx\\n\");\n \n@@ -1288,7 +1288,7 @@\n \tr.in.domain_name\t= talloc_asprintf(mem_ctx, \"%s\", lp_realm());\n \tr.in.domain_guid\t= NULL;\n \tr.in.site_name\t\t= NULL;\n-\tr.in.flags\t\t= 0x40000000;\n+\tr.in.flags\t\t= DS_RETURN_DNS_NAME;\n \n \tprintf(\"Testing netr_DsRGetDCNameEx2 without client account\\n\");\n \n@@ -1301,8 +1301,8 @@\n \n \tprintf(\"Testing netr_DsRGetDCNameEx2 with client acount\\n\");\n \tr.in.client_account\t= TEST_MACHINE_NAME\"$\";\n-\tr.in.mask\t\t= 0x00002000;\n-\tr.in.flags\t\t= 0x80000000;\n+\tr.in.mask\t\t= ACB_SVRTRUST;\n+\tr.in.flags\t\t= DS_RETURN_FLAT_NAME;\n \n \tstatus = dcerpc_netr_DsRGetDCNameEx2(p, mem_ctx, &r);\n \tif (!NT_STATUS_IS_OK(status) || !W_ERROR_IS_OK(r.out.result)) {\n\n"}