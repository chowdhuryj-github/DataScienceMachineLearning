{"category": "ham", "to_address": "samba-cvs@samba.org", "from_address": "Jelmer Vernooij <jelmer@samba.org>", "subject": "Rev 11879: Don't add wins configuration, shares ldb,\n\tetc for member servers. in file:///home/jelmer/bzr.samba/SAMBA_4_0/", "body": "At file:///home/jelmer/bzr.samba/SAMBA_4_0/\n\n------------------------------------------------------------\nrevno: 11879\nrevision-id: jelmer@samba.org-20070416231308-z66suic84m4moolu\nparent: jelmer@samba.org-20070416223513-66z48onzdyaegs8w\ncommitter: Jelmer Vernooij \nbranch nick: SAMBA_4_0\ntimestamp: Tue 2007-04-17 01:13:08 +0200\nmessage:\n  Don't add wins configuration, shares ldb, etc for member servers. \n  Remove shares testing code here (will readd in a slightly different fashion later).\nremoved:\n  source/script/tests/mktestdc.sh.share_ldb svn-v2:21909@0c0555d6-39d7-0310-84fc-f1cc0bd64818-branches%2fSAMBA_4_0-source%2fscript%2ftests%2fmktestdc.sh.share_ldb\nmodified:\n  source/script/tests/Samba4.pm  svn-v2:21707@0c0555d6-39d7-0310-84fc-f1cc0bd64818-branches%2fSAMBA_4_0-source%2fscript%2ftests%2fSamba4.pm\n=== removed file 'source/script/tests/mktestdc.sh.share_ldb'\n--- a/source/script/tests/mktestdc.sh.share_ldb\t2007-03-21 15:57:07 +0000\n+++ b/source/script/tests/mktestdc.sh.share_ldb\t1970-01-01 00:00:00 +0000\n@@ -1,5 +0,0 @@\n-#!/bin/sh\n-\n-SHARE_BACKEND=\"ldb\"\n-\n-. `dirname $0`/mktestsetup.sh\n\n=== modified file 'source/script/tests/Samba4.pm'\n--- a/source/script/tests/Samba4.pm\t2007-04-16 22:35:13 +0000\n+++ b/source/script/tests/Samba4.pm\t2007-04-16 23:13:08 +0000\n@@ -135,11 +135,34 @@\n \tsystem(\"bin/nmblookup $testenv_vars->{CONFIGURATION} -U $testenv_vars->{SERVER} $testenv_vars->{NETBIOSNAME}\");\n }\n \n+sub write_ldb_file($$$)\n+{\n+\tmy ($self, $file, $ldif) = @_;\n+\n+\topen(LDIF, \"|$self->{bindir}/ldbadd -H $file >/dev/null\");\n+\tprint LDIF $ldif;\n+\treturn close(LDIF);\n+}\n+\n+sub add_wins_config($$)\n+{\n+\tmy ($self, $privatedir) = @_;\n+\n+\treturn $self->write_ldb_file(\"$privatedir/wins_config.ldb\", \"\n+dn: name=TORTURE_6,CN=PARTNERS\n+objectClass: wreplPartner\n+name: TORTURE_6\n+address: 127.0.0.6\n+pullInterval: 0\n+pushChangeCount: 0\n+type: 0x3\n+\");\n+}\n+\n sub provision($$$$$$)\n {\n \tmy ($self, $prefix, $server_role, $domain, $netbiosname, $ldap) = @_;\n \n-\tmy $share_backend = \"classic\";\n \tmy $smbd_loglevel = 1;\n \tmy $username = \"administrator\";\n \tmy $realm = \"SAMBA.EXAMPLE.COM\";\n@@ -182,7 +205,6 @@\n \tpid directory = $piddir\n \tncalrpc dir = $ncalrpcdir\n \tlock dir = $lockdir\n-\tshare backend = $share_backend\n \tsetup directory = $self->{setupdir}\n \tjs include = $srcdir/scripting/libjs\n \twinbindd socket directory = $winbindd_socket_dir\n@@ -228,87 +250,6 @@\n \";\n \tclose(CONFFILE);\n \n-\t## Override default share.ldb file\n-\tunlink(\"$privatedir/share.ldb\");\n-\topen(LDIF, \">$privatedir/share.ldif\");\n-\tprint LDIF \"\n-### Shares basedn\n-dn: \\@INDEXLIST\n-\\@IDXATTR: name\n-\n-dn: \\@ATTRIBUTES\n-cn: CASE_INSENSITIVE\n-dc: CASE_INSENSITIVE\n-name: CASE_INSENSITIVE\n-dn: CASE_INSENSITIVE\n-objectClass: CASE_INSENSITIVE\n-\n-dn: CN=Shares\n-objectClass: top\n-objectClass: organizationalUnit\n-cn: Shares\n-\n-### Default IPC\\$ Share\n-dn: CN=IPC\\$,CN=Shares\n-objectClass: top\n-objectClass: share\n-cn: IPC\\$\n-name: IPC\\$\n-type: IPC\n-path: /tmp\n-comment: Remote IPC\n-max-connections: -1\n-available: True\n-readonly: True\n-browseable: False\n-ntvfs-handler: default\n-\n-### Default ADMIN\\$ Share\n-dn: CN=ADMIN\\$,CN=Shares\n-objectClass: top\n-objectClass: share\n-cn: ADMIN\\$\n-name: ADMIN\\$\n-type: DISK\n-path: /tmp\n-comment: Remote Admin\n-max-connections: -1\n-available: True\n-readonly: True\n-browseable: False\n-ntvfs-handler: default\n-\n-dn: CN=tmp,CN=Shares\n-objectClass: top\n-objectClass: share\n-cn: tmp\n-name: tmp\n-type: DISK\n-path: $tmpdir\n-comment: Temp Dir for Tests\n-readonly: False\n-ntvfs-handler: posix\n-posix-sharedelay: 100000\n-posix-eadb: $lockdir/eadb.tdb\n-\n-dn: CN=cifs,CN=Shares\n-objectClass: top\n-objectClass: share\n-cn: cifs\n-name: cifs\n-type: DISK\n-readonly: False\n-ntvfs-handler: cifs\n-cifs-server: $server\n-cifs-user: $username\n-cifs-password: $password\n-cifs-domain: $domain\n-cifs-share: tmp\n-\";\n-\tclose(LDIF);\n-\n-\tsystem(\"$self->{bindir}/ldbadd -H $privatedir/share.ldb < $privatedir/share.ldif >/dev/null\") == 0 or die(\"Unable to add share ldif\");\n-\n \tdie (\"Unable to create key blobs\") if\n \t\t(system(\"TLSDIR=$tlsdir $RealBin/mk-keyblobs.sh\") != 0);\n \n@@ -390,20 +331,6 @@\n \t\tpush (@provision_options, \"--ldap-module=nsuniqueid\");\n \t}\n \n-\topen(LDIF, \">$privatedir/wins_config.ldif\");\n-\tprint LDIF \"\n-dn: name=TORTURE_6,CN=PARTNERS\n-objectClass: wreplPartner\n-name: TORTURE_6\n-address: 127.0.0.6\n-pullInterval: 0\n-pushChangeCount: 0\n-type: 0x3\n-\";\n-\tclose(LDIF);\n-\n-\tsystem(\"$self->{bindir}/ldbadd -H $privatedir/wins_config.ldb < $privatedir/wins_config.ldif >/dev/null\") == 0 or die(\"Unable to add wins configuration\");\n-\n \treturn {\n \t\tKRB5_CONFIG => $krb5_config,\n \t\tPIDDIR => $piddir,\n@@ -425,7 +352,7 @@\n sub provision_member($$$)\n {\n \tmy ($self, $prefix, $dcvars) = @_;\n-\tprint \"PROVISIONING...\";\n+\tprint \"PROVISIONING MEMBER...\";\n \n \tmy $ret = $self->provision($prefix, \"member server\", \"SAMBADOMAIN\", \n \t\t\"localmember\", \n@@ -445,12 +372,15 @@\n {\n \tmy ($self, $prefix) = @_;\n \n-\tprint \"PROVISIONING...\";\n+\tprint \"PROVISIONING DC...\";\n \tmy $ret = $self->provision($prefix, \"domain controller\", \"SAMBADOMAIN\", \n \t\t\"localtest\", \n \t\tundef  # LDAP\n \t);\n \n+\t$self->add_wins_config(\"$prefix/private\") or \n+\t\tdie(\"Unable to add wins configuration\");\n+\n \t$ret->{SMBD_TEST_FIFO} = \"$prefix/smbd_test.fifo\";\n \t$ret->{SMBD_TEST_LOG} = \"$prefix/smbd_test.log\";\n \treturn $ret;\n\n"}