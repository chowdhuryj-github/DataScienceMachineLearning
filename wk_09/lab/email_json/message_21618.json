{"category": "ham", "to_address": "samba-cvs@samba.org", "from_address": "psomogyi@gamax.hu", "subject": "Rev 93: ctdb/ib fork bugfix in http://samba.org/~tridge/psomogyi/", "body": "------------------------------------------------------------\nrevno: 93\nrevision-id: psomogyi@gamax.hu-20070502152756-cgv2olqgrryuhpvq\nparent: psomogyi@gamax.hu-20070502151948-im6i33gzv36dnqyl\ncommitter: Peter Somogyi \nbranch nick: ctdb\ntimestamp: Wed 2007-05-02 17:27:56 +0200\nmessage:\n  ctdb/ib fork bugfix\n  - added ibv_fork_init not to have exotic errors after forks (even if ib is not used at all in children)\nmodified:\n  ib/ibwrapper.c                 ibwrapper.c-20061204130028-0125b4f5a72f4b11\n=== modified file 'ib/ibwrapper.c'\n--- a/ib/ibwrapper.c\t2007-05-02 15:19:48 +0000\n+++ b/ib/ibwrapper.c\t2007-05-02 15:27:56 +0000\n@@ -534,13 +534,14 @@\n \n \tcase RDMA_CM_EVENT_DISCONNECTED:\n \t\tDEBUG(11, (\"RDMA_CM_EVENT_DISCONNECTED\\n\"));\n-\t\tif ((rc=rdma_ack_cm_event(event)))\n-\t\t\tDEBUG(0, (\"disc/rdma_ack_cm_event failed with %d\\n\", rc));\n-\t\tevent = NULL; /* don't ack more */\n-\n \t\tif (cma_id!=pctx->cm_id) {\n-\t\t\tDEBUG(0, (\"client DISCONNECT event cm_id=%p\\n\", cma_id));\n+\t\t\tDEBUG(1, (\"client DISCONNECT event cm_id=%p\\n\", cma_id));\n \t\t\tconn = talloc_get_type(cma_id->context, struct ibw_conn);\n+\n+\t\t\tif ((rc=rdma_ack_cm_event(event)))\n+\t\t\t\tDEBUG(0, (\"disc/rdma_ack_cm_event failed with %d\\n\", rc));\n+\t\t\tevent = NULL; /* don't ack it any more */\n+\n \t\t\tconn->state = IBWC_DISCONNECTED;\n \t\t\tpctx->connstate_func(NULL, conn);\n \t\t}\n@@ -945,6 +946,13 @@\n \n \tDEBUG(10, (\"ibw_init(ctx_userdata: %p, ectx: %p)\\n\", ctx_userdata, ectx));\n \n+\trc = ibv_fork_init();\n+\tif (rc) {\n+\t\tsprintf(ibw_lasterr,\n+\t\t\t\"FATAL ERROR: ibv_fork_init returned with %d\\n\", rc);\n+\t\tgoto error;\n+\t}\n+\n \t/* initialize basic data structures */\n \tmemset(ibw_lasterr, 0, IBW_LASTERR_BUFSIZE);\n \n@@ -965,13 +973,13 @@\n \n \t/* process attributes */\n \tif (ibw_process_init_attrs(attr, nattr, &pctx->opts))\n-\t\tgoto cleanup;\n+\t\tgoto error;\n \n \t/* init cm */\n \tpctx->cm_channel = rdma_create_event_channel();\n \tif (!pctx->cm_channel) {\n \t\tsprintf(ibw_lasterr, \"rdma_create_event_channel error %d\\n\", errno);\n-\t\tgoto cleanup;\n+\t\tgoto error;\n \t}\n \n \tpctx->cm_channel_event = event_add_fd(pctx->ectx, pctx,\n@@ -985,7 +993,7 @@\n \tif (rc) {\n \t\trc = errno;\n \t\tsprintf(ibw_lasterr, \"rdma_create_id error %d\\n\", rc);\n-\t\tgoto cleanup;\n+\t\tgoto error;\n \t}\n \tDEBUG(10, (\"created cm_id %p\\n\", pctx->cm_id));\n \n@@ -993,7 +1001,7 @@\n \n \treturn ctx;\n \t/* don't put code here */\n-cleanup:\n+error:\n \tDEBUG(0, (ibw_lasterr));\n \n \tif (ctx)\n\n"}