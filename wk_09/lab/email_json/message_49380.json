{"category": "ham", "to_address": "samba-cvs@samba.org", "from_address": "tridge@samba.org", "subject": "Rev 544: - wait for winbind on samba start in\n\thttp://samba.org/~tridge/ctdb", "body": "------------------------------------------------------------\nrevno: 544\nrevision-id: tridge@samba.org-20070617015742-vstv17rrkkpahaij\nparent: tridge@samba.org-20070612094454-jtmr17z42ko4x7bn\ncommitter: Andrew Tridgell \nbranch nick: tridge\ntimestamp: Sun 2007-06-17 11:57:42 +1000\nmessage:\n  - wait for winbind on samba start\n  - use $PATH for ctdb status\nmodified:\n  config/events.d/50.samba       samba-20070601105340-vlcvnp6euoj3zdwy-3\n  config/functions               functions-20070601105405-gajwirydr5a9zd6x-1\n=== modified file 'config/events.d/50.samba'\n--- a/config/events.d/50.samba\t2007-06-11 03:56:50 +0000\n+++ b/config/events.d/50.samba\t2007-06-17 01:57:42 +0000\n@@ -30,6 +30,9 @@\n \t# wait for the Samba tcp ports to become available\n \tsmb_ports=`testparm -sv 2> /dev/null | egrep '\\s*smb ports =' | cut -d= -f2`\n \tctdb_wait_tcp_ports \"Samba\" $smb_ports\n+\n+\t# wait for winbind to be ready\n+\tctdb_wait_command \"winbind\" \"wbinfo -p\"\n \t;;\n \t\n      takeip)\n\n=== modified file 'config/functions'\n--- a/config/functions\t2007-06-06 02:08:42 +0000\n+++ b/config/functions\t2007-06-17 01:57:42 +0000\n@@ -26,6 +26,28 @@\n   fi\n }\n \n+\n+######################################################\n+# wait for a command to return a zero exit status\n+# usage: ctdb_wait_command SERVICE_NAME \n+######################################################\n+ctdb_wait_command() {\n+  service_name=\"$1\"\n+  wait_cmd=\"$2\"\n+  [ -z \"$wait_cmd\" ] && return;\n+  all_ok=0\n+  echo \"`/bin/date` Waiting for service $service_name to start\"\n+  while [ $all_ok -eq 0 ]; do\n+\t  $wait_cmd > /dev/null 2>&1 && all_ok=1\n+\t  ctdb status > /dev/null 2>&1 || {\n+  \t\techo \"ctdb daemon has died. Exiting wait for $service_name\"\n+\t\texit 1\n+\t  }\n+  done\n+  echo \"`/bin/date` Local service $service_name is up\"\n+}\n+\n+\n ######################################################\n # wait for a set of tcp ports\n # usage: ctdb_wait_tcp_ports SERVICE_NAME \n@@ -50,7 +72,7 @@\n \t      fi\n \t  done\n \t  [ $all_ok -eq 1 ] || sleep 1\n-\t  /usr/bin/ctdb status > /dev/null 2>&1 || {\n+\t  ctdb status > /dev/null 2>&1 || {\n   \t\techo \"ctdb daemon has died. Exiting tcp wait $service_name\"\n \t\texit 1\n \t  }\n@@ -77,7 +99,7 @@\n   \t      [ -d $d ] || all_ok=0\n \t  done\n \t  [ $all_ok -eq 1 ] || sleep 1\n-\t  /usr/bin/ctdb status > /dev/null 2>&1 || {\n+\t  ctdb status > /dev/null 2>&1 || {\n   \t\techo \"ctdb daemon has died. Exiting directory wait for $service_name\"\n \t\texit 1\n \t  }\n\n"}