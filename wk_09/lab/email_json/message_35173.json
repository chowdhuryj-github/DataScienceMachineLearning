{"category": "ham", "to_address": "samba-cvs@samba.org", "from_address": "jra@samba.org", "subject": "svn commit: samba r23106 - in branches: SAMBA_3_0/source/smbd\n\tSAMBA_3_0_26/source/smbd", "body": "Author: jra\nDate: 2007-05-24 00:13:24 +0000 (Thu, 24 May 2007)\nNew Revision: 23106\n\nWebSVN: http://websvn.samba.org/cgi-bin/viewcvs.cgi?view=rev&root=samba&rev=23106\n\nLog:\nUse lchown for symlinks.\nJeremy.\n\nModified:\n   branches/SAMBA_3_0/source/smbd/trans2.c\n   branches/SAMBA_3_0_26/source/smbd/trans2.c\n\n\nChangeset:\nModified: branches/SAMBA_3_0/source/smbd/trans2.c\n===================================================================\n--- branches/SAMBA_3_0/source/smbd/trans2.c\t2007-05-23 23:55:12 UTC (rev 23105)\n+++ branches/SAMBA_3_0/source/smbd/trans2.c\t2007-05-24 00:13:24 UTC (rev 23106)\n@@ -5268,9 +5268,18 @@\n \t */\n \n \tif ((set_owner != (uid_t)SMB_UID_NO_CHANGE) && (psbuf->st_uid != set_owner)) {\n-\t\tDEBUG(10,(\"smb_set_file_unix_basic: SMB_SET_FILE_UNIX_BASIC changing owner %u for file %s\\n\",\n+\t\tint ret;\n+\n+\t\tDEBUG(10,(\"smb_set_file_unix_basic: SMB_SET_FILE_UNIX_BASIC changing owner %u for path %s\\n\",\n \t\t\t(unsigned int)set_owner, fname ));\n-\t\tif (SMB_VFS_CHOWN(conn, fname, set_owner, (gid_t)-1) != 0) {\n+\n+\t\tif (S_ISLNK(psbuf->st_mode)) {\n+\t\t\tret = SMB_VFS_LCHOWN(conn, fname, set_owner, (gid_t)-1);\n+\t\t} else {\n+\t\t\tret = SMB_VFS_CHOWN(conn, fname, set_owner, (gid_t)-1);\n+\t\t}\n+\n+\t\tif (ret != 0) {\n \t\t\tstatus = map_nt_error_from_unix(errno);\n \t\t\tif (delete_on_fail) {\n \t\t\t\tSMB_VFS_UNLINK(conn,fname);\n\nModified: branches/SAMBA_3_0_26/source/smbd/trans2.c\n===================================================================\n--- branches/SAMBA_3_0_26/source/smbd/trans2.c\t2007-05-23 23:55:12 UTC (rev 23105)\n+++ branches/SAMBA_3_0_26/source/smbd/trans2.c\t2007-05-24 00:13:24 UTC (rev 23106)\n@@ -5214,9 +5214,18 @@\n \t */\n \n \tif ((set_owner != (uid_t)SMB_UID_NO_CHANGE) && (psbuf->st_uid != set_owner)) {\n-\t\tDEBUG(10,(\"smb_set_file_unix_basic: SMB_SET_FILE_UNIX_BASIC changing owner %u for file %s\\n\",\n+\t\tint ret;\n+\n+\t\tDEBUG(10,(\"smb_set_file_unix_basic: SMB_SET_FILE_UNIX_BASIC changing owner %u for path %s\\n\",\n \t\t\t(unsigned int)set_owner, fname ));\n-\t\tif (SMB_VFS_CHOWN(conn, fname, set_owner, (gid_t)-1) != 0) {\n+\n+\t\tif (S_ISLNK(psbuf->st_mode)) {\n+\t\t\tret = SMB_VFS_LCHOWN(conn, fname, set_owner, (gid_t)-1);\n+\t\t} else {\n+\t\t\tret = SMB_VFS_CHOWN(conn, fname, set_owner, (gid_t)-1);\n+\t\t}\n+\n+\t\tif (ret != 0) {\n \t\t\tstatus = map_nt_error_from_unix(errno);\n \t\t\tif (delete_on_fail) {\n \t\t\t\tSMB_VFS_UNLINK(conn,fname);\n\n"}