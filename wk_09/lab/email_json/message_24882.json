{"category": "ham", "to_address": "samba-cvs@samba.org", "from_address": "jra@samba.org", "subject": "svn commit: samba r22754 - in branches: SAMBA_3_0/source/lib\n\tSAMBA_3_0_25/source/lib SAMBA_3_0_26/source/lib", "body": "Author: jra\nDate: 2007-05-07 19:27:46 +0000 (Mon, 07 May 2007)\nNew Revision: 22754\n\nWebSVN: http://websvn.samba.org/cgi-bin/viewcvs.cgi?view=rev&root=samba&rev=22754\n\nLog:\nWhen processing a string, ensure we don't write one past\nthe terminating NULL if we've already processed the null\nin iconv. Jerry, once I get confirmation from Thomas Bork\nthis needs to be in 3.0.25 final. Tests fine with valgrind\nhere.\nJeremy.\n\nModified:\n   branches/SAMBA_3_0/source/lib/charcnv.c\n   branches/SAMBA_3_0_25/source/lib/charcnv.c\n   branches/SAMBA_3_0_26/source/lib/charcnv.c\n\n\nChangeset:\nModified: branches/SAMBA_3_0/source/lib/charcnv.c\n===================================================================\n--- branches/SAMBA_3_0/source/lib/charcnv.c\t2007-05-07 16:15:59 UTC (rev 22753)\n+++ branches/SAMBA_3_0/source/lib/charcnv.c\t2007-05-07 19:27:46 UTC (rev 22754)\n@@ -972,13 +972,18 @@\n \n \tret = convert_string(CH_DOS, CH_UNIX, src, src_len, dest, dest_len, True);\n \tif (ret == (size_t)-1) {\n+\t\tret = 0;\n \t\tdest_len = 0;\n \t}\n \n-\tif (dest_len)\n-\t\tdest[MIN(ret, dest_len-1)] = 0;\n-\telse \n+\tif (dest_len && ret) {\n+\t\t/* Did we already process the terminating zero ? */\n+\t\tif (dest[MIN(ret-1, dest_len-1)] != 0) {\n+\t\t\tdest[MIN(ret, dest_len-1)] = 0;\n+\t\t}\n+\t} else  {\n \t\tdest[0] = 0;\n+\t}\n \n \treturn src_len;\n }\n@@ -1219,10 +1224,14 @@\n \tif (src_len == (size_t)-1)\n \t\tsrc_len = ret*2;\n \t\t\n-\tif (dest_len)\n-\t\tdest[MIN(ret, dest_len-1)] = 0;\n-\telse \n+\tif (dest_len && ret) {\n+\t\t/* Did we already process the terminating zero ? */\n+\t\tif (dest[MIN(ret-1, dest_len-1)] != 0) {\n+\t\t\tdest[MIN(ret, dest_len-1)] = 0;\n+\t\t}\n+\t} else {\n \t\tdest[0] = 0;\n+\t}\n \n \treturn src_len;\n }\n\nModified: branches/SAMBA_3_0_25/source/lib/charcnv.c\n===================================================================\n--- branches/SAMBA_3_0_25/source/lib/charcnv.c\t2007-05-07 16:15:59 UTC (rev 22753)\n+++ branches/SAMBA_3_0_25/source/lib/charcnv.c\t2007-05-07 19:27:46 UTC (rev 22754)\n@@ -972,13 +972,18 @@\n \n \tret = convert_string(CH_DOS, CH_UNIX, src, src_len, dest, dest_len, True);\n \tif (ret == (size_t)-1) {\n+\t\tret = 0;\n \t\tdest_len = 0;\n \t}\n \n-\tif (dest_len)\n-\t\tdest[MIN(ret, dest_len-1)] = 0;\n-\telse \n+\tif (dest_len && ret) {\n+\t\t/* Did we already process the terminating zero ? */\n+\t\tif (dest[MIN(ret-1, dest_len-1)] != 0) {\n+\t\t\tdest[MIN(ret, dest_len-1)] = 0;\n+\t\t}\n+\t} else  {\n \t\tdest[0] = 0;\n+\t}\n \n \treturn src_len;\n }\n@@ -1219,10 +1224,14 @@\n \tif (src_len == (size_t)-1)\n \t\tsrc_len = ret*2;\n \t\t\n-\tif (dest_len)\n-\t\tdest[MIN(ret, dest_len-1)] = 0;\n-\telse \n+\tif (dest_len && ret) {\n+\t\t/* Did we already process the terminating zero ? */\n+\t\tif (dest[MIN(ret-1, dest_len-1)] != 0) {\n+\t\t\tdest[MIN(ret, dest_len-1)] = 0;\n+\t\t}\n+\t} else {\n \t\tdest[0] = 0;\n+\t}\n \n \treturn src_len;\n }\n\nModified: branches/SAMBA_3_0_26/source/lib/charcnv.c\n===================================================================\n--- branches/SAMBA_3_0_26/source/lib/charcnv.c\t2007-05-07 16:15:59 UTC (rev 22753)\n+++ branches/SAMBA_3_0_26/source/lib/charcnv.c\t2007-05-07 19:27:46 UTC (rev 22754)\n@@ -972,13 +972,18 @@\n \n \tret = convert_string(CH_DOS, CH_UNIX, src, src_len, dest, dest_len, True);\n \tif (ret == (size_t)-1) {\n+\t\tret = 0;\n \t\tdest_len = 0;\n \t}\n \n-\tif (dest_len)\n-\t\tdest[MIN(ret, dest_len-1)] = 0;\n-\telse \n+\tif (dest_len && ret) {\n+\t\t/* Did we already process the terminating zero ? */\n+\t\tif (dest[MIN(ret-1, dest_len-1)] != 0) {\n+\t\t\tdest[MIN(ret, dest_len-1)] = 0;\n+\t\t}\n+\t} else  {\n \t\tdest[0] = 0;\n+\t}\n \n \treturn src_len;\n }\n@@ -1219,10 +1224,14 @@\n \tif (src_len == (size_t)-1)\n \t\tsrc_len = ret*2;\n \t\t\n-\tif (dest_len)\n-\t\tdest[MIN(ret, dest_len-1)] = 0;\n-\telse \n+\tif (dest_len && ret) {\n+\t\t/* Did we already process the terminating zero ? */\n+\t\tif (dest[MIN(ret-1, dest_len-1)] != 0) {\n+\t\t\tdest[MIN(ret, dest_len-1)] = 0;\n+\t\t}\n+\t} else {\n \t\tdest[0] = 0;\n+\t}\n \n \treturn src_len;\n }\n\n"}