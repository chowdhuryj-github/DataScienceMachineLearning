{"category": "ham", "to_address": "samba-cvs@samba.org", "from_address": "jerry@samba.org", "subject": "svn commit: samba r22649 - in branches/SAMBA_3_0_25/source: include\n\tsmbd", "body": "Author: jerry\nDate: 2007-05-03 16:57:54 +0000 (Thu, 03 May 2007)\nNew Revision: 22649\n\nWebSVN: http://websvn.samba.org/cgi-bin/viewcvs.cgi?view=rev&root=samba&rev=22649\n\nLog:\nrevert the objectID changes (for now) and leave these for 3.0.26\nModified:\n   branches/SAMBA_3_0_25/source/include/ntioctl.h\n   branches/SAMBA_3_0_25/source/smbd/nttrans.c\n   branches/SAMBA_3_0_25/source/smbd/trans2.c\n\n\nChangeset:\nModified: branches/SAMBA_3_0_25/source/include/ntioctl.h\n===================================================================\n--- branches/SAMBA_3_0_25/source/include/ntioctl.h\t2007-05-03 16:14:22 UTC (rev 22648)\n+++ branches/SAMBA_3_0_25/source/include/ntioctl.h\t2007-05-03 16:57:54 UTC (rev 22649)\n@@ -47,7 +47,7 @@\n #define FSCTL_SET_REPARSE_POINT      0x000900A4\n #define FSCTL_GET_REPARSE_POINT      0x000900A8\n #define FSCTL_DELETE_REPARSE_POINT   0x000900AC\n-#define FSCTL_CREATE_OR_GET_OBJECT_ID 0x000900C0\n+#define FSCTL_0x000900C0\t     0x000900C0\n #define FSCTL_SET_SPARSE             0x000900C4\n #define FSCTL_SET_ZERO_DATA          0x000900C8\n #define FSCTL_SET_ENCRYPTION         0x000900D7\n\nModified: branches/SAMBA_3_0_25/source/smbd/nttrans.c\n===================================================================\n--- branches/SAMBA_3_0_25/source/smbd/nttrans.c\t2007-05-03 16:14:22 UTC (rev 22648)\n+++ branches/SAMBA_3_0_25/source/smbd/nttrans.c\t2007-05-03 16:57:54 UTC (rev 22649)\n@@ -2279,29 +2279,15 @@\n \t\t\t\t0);\n \t\treturn -1;\n \t\n-\tcase FSCTL_CREATE_OR_GET_OBJECT_ID:\n-\t{\n-\t\tunsigned char objid[16];\n-\n-\t\t/* This should return the object-id on this file.\n- \t\t * I think I'll make this be the inode+dev. JRA.\n+\tcase FSCTL_0x000900C0:\n+\t\t/* pretend this succeeded - don't know what this really is\n+\t\t   but works ok like this --metze\n \t\t */\n \n-\t\tDEBUG(10,(\"FSCTL_CREATE_OR_GET_OBJECT_ID: called on FID[0x%04X]\\n\",fidnum));\n-\n-\t\tdata_count = 64;\n-\t\tpdata = nttrans_realloc(ppdata, data_count);\n-\t\tif (pdata == NULL) {\n-\t\t\treturn ERROR_NT(NT_STATUS_NO_MEMORY);\n-\t\t}\t\t\n-\t\tSINO_T_VAL(pdata,0,fsp->inode);\n-\t\tSDEV_T_VAL(pdata,8,fsp->dev);\n-\t\tmemcpy(pdata+16,create_volume_objectid(conn,objid),16);\n-\t\tSINO_T_VAL(pdata,32,fsp->inode);\n-\t\tSDEV_T_VAL(pdata,40,fsp->dev);\n-\t\tsend_nt_replies(outbuf, bufsize, NT_STATUS_OK, NULL, 0, pdata, data_count);\n+\t\tDEBUG(10,(\"FSCTL_0x000900C0: called on FID[0x%04X](but not implemented)\\n\",fidnum));\n+\t\tsend_nt_replies(outbuf, bufsize, NT_STATUS_OK, NULL, 0, NULL,\n+\t\t\t\t0);\n \t\treturn -1;\n-\t}\n \n \tcase FSCTL_GET_REPARSE_POINT:\n \t\t/* pretend this fail - my winXP does it like this\n@@ -2309,7 +2295,9 @@\n \t\t */\n \n \t\tDEBUG(10,(\"FSCTL_GET_REPARSE_POINT: called on FID[0x%04X](but not implemented)\\n\",fidnum));\n-\t\treturn ERROR_NT(NT_STATUS_NOT_A_REPARSE_POINT);\n+\t\tsend_nt_replies(outbuf, bufsize, NT_STATUS_NOT_A_REPARSE_POINT,\n+\t\t\t\tNULL, 0, NULL, 0);\n+\t\treturn -1;\n \n \tcase FSCTL_SET_REPARSE_POINT:\n \t\t/* pretend this fail - I'm assuming this because of the FSCTL_GET_REPARSE_POINT case.\n@@ -2317,7 +2305,9 @@\n \t\t */\n \n \t\tDEBUG(10,(\"FSCTL_SET_REPARSE_POINT: called on FID[0x%04X](but not implemented)\\n\",fidnum));\n-\t\treturn ERROR_NT(NT_STATUS_NOT_A_REPARSE_POINT);\n+\t\tsend_nt_replies(outbuf, bufsize, NT_STATUS_NOT_A_REPARSE_POINT,\n+\t\t\t\tNULL, 0, NULL, 0);\n+\t\treturn -1;\n \t\t\t\n \tcase FSCTL_GET_SHADOW_COPY_DATA: /* don't know if this name is right...*/\n \t{\n\nModified: branches/SAMBA_3_0_25/source/smbd/trans2.c\n===================================================================\n--- branches/SAMBA_3_0_25/source/smbd/trans2.c\t2007-05-03 16:14:22 UTC (rev 22648)\n+++ branches/SAMBA_3_0_25/source/smbd/trans2.c\t2007-05-03 16:57:54 UTC (rev 22649)\n@@ -2219,12 +2219,6 @@\n \treturn(-1);\n }\n \n-unsigned char *create_volume_objectid(connection_struct *conn, unsigned char objid[16])\n-{\n-\tE_md4hash(lp_servicename(SNUM(conn)),objid);\n-\treturn objid;\n-}\n-\n /****************************************************************************\n  Reply to a TRANS2_QFSINFO (query filesystem info).\n ****************************************************************************/\n@@ -2332,8 +2326,6 @@\n \n \t\t\tSIVAL(pdata,0,FILE_CASE_PRESERVED_NAMES|FILE_CASE_SENSITIVE_SEARCH|\n \t\t\t\t(lp_nt_acl_support(SNUM(conn)) ? FILE_PERSISTENT_ACLS : 0)|\n-\t\t\t\tFILE_SUPPORTS_OBJECT_IDS|\n-\t\t\t\tFILE_UNICODE_ON_DISK|\n \t\t\t\tquota_flag); /* FS ATTRIBUTES */\n \n \t\t\tSIVAL(pdata,4,255); /* Max filename component length */\n@@ -2515,12 +2507,8 @@\n \t\t}\n #endif /* HAVE_SYS_QUOTAS */\n \t\tcase SMB_FS_OBJECTID_INFORMATION:\n-\t\t{\n-\t\t\tunsigned char objid[16];\n-\t\t\tmemcpy(pdata,create_volume_objectid(conn, objid),16);\n \t\t\tdata_len = 64;\n \t\t\tbreak;\n-\t\t}\n \n \t\t/*\n \t\t * Query the version and capabilities of the CIFS UNIX extensions\n@@ -3154,68 +3142,6 @@\n }\n \n /****************************************************************************\n- Reply to a TRANSACT2_QFILEINFO on a PIPE !\n-****************************************************************************/\n-\n-static int call_trans2qpipeinfo(connection_struct *conn, char *inbuf, char *outbuf, int length, int bufsize,\n-\t\t\t\t\tunsigned int tran_call,\n-\t\t\t\t\tchar **pparams, int total_params, char **ppdata, int total_data,\n-\t\t\t\t\tunsigned int max_data_bytes)\n-{\n-\tchar *params = *pparams;\n-\tchar *pdata = *ppdata;\n-\tunsigned int data_size = 0;\n-\tunsigned int param_size = 2;\n-\tuint16 info_level;\n-\tsmb_np_struct *p_pipe = NULL;\n-\n-\tif (!params) {\n-\t\treturn ERROR_NT(NT_STATUS_INVALID_PARAMETER);\n-\t}\n-\n-\tif (total_params < 4) {\n-\t\treturn ERROR_NT(NT_STATUS_INVALID_PARAMETER);\n-\t}\n-\n-\tp_pipe = get_rpc_pipe_p(params,0);\n-\tif (p_pipe == NULL) {\n-\t\treturn ERROR_NT(NT_STATUS_INVALID_HANDLE);\n-\t}\n-\n-\tinfo_level = SVAL(params,2);\n-\n-\t*pparams = (char *)SMB_REALLOC(*pparams,2);\n-\tif (*pparams == NULL) {\n-\t\treturn ERROR_NT(NT_STATUS_NO_MEMORY);\n-\t}\n-\tparams = *pparams;\n-\tSSVAL(params,0,0);\n-\tdata_size = max_data_bytes + DIR_ENTRY_SAFETY_MARGIN;\n-\t*ppdata = (char *)SMB_REALLOC(*ppdata, data_size); \n-\tif (*ppdata == NULL ) {\n-\t\treturn ERROR_NT(NT_STATUS_NO_MEMORY);\n-\t}\n-\tpdata = *ppdata;\n-\n-\tswitch (info_level) {\n-\t\tcase SMB_FILE_STANDARD_INFORMATION:\n-\t\t\tmemset(pdata,24,0);\n-\t\t\tSOFF_T(pdata,0,4096LL);\n-\t\t\tSIVAL(pdata,16,1);\n-\t\t\tSIVAL(pdata,20,1);\n-\t\t\tdata_size = 24;\n-\t\t\tbreak;\n-\n-\t\tdefault:\n-\t\t\treturn ERROR_NT(NT_STATUS_INVALID_LEVEL);\n-\t}\n-\n-\tsend_trans2_replies(outbuf, bufsize, params, param_size, *ppdata, data_size, max_data_bytes);\n-\n-\treturn(-1);\n-}\n-\n-/****************************************************************************\n  Reply to a TRANS2_QFILEPATHINFO or TRANSACT2_QFILEINFO (query file info by\n  file name or file id).\n ****************************************************************************/\n@@ -3260,20 +3186,6 @@\n \t\t\treturn ERROR_NT(NT_STATUS_INVALID_PARAMETER);\n \t\t}\n \n-\t\tif (IS_IPC(conn)) {\n-\t\t\treturn call_trans2qpipeinfo(conn,\n-\t\t\t\t\t\t\tinbuf,\n-\t\t\t\t\t\t\toutbuf,\n-\t\t\t\t\t\t\tlength,\n-\t\t\t\t\t\t\tbufsize,\n-\t\t\t\t\t\t\ttran_call,\n-\t\t\t\t\t\t\tpparams,\n-\t\t\t\t\t\t\ttotal_params,\n-\t\t\t\t\t\t\tppdata,\n-\t\t\t\t\t\t\ttotal_data,\n-\t\t\t\t\t\t\tmax_data_bytes);\n-\t\t}\n-\n \t\tfsp = file_fsp(params,0);\n \t\tinfo_level = SVAL(params,2);\n \n@@ -6562,8 +6474,7 @@\n \t}\n \n \tif (IS_IPC(conn) && (tran_call != TRANSACT2_OPEN)\n-            && (tran_call != TRANSACT2_GET_DFS_REFERRAL)\n-            && (tran_call != TRANSACT2_QFILEINFO)) {\n+            && (tran_call != TRANSACT2_GET_DFS_REFERRAL)) {\n \t\tEND_PROFILE(SMBtrans2);\n \t\treturn ERROR_DOS(ERRSRV,ERRaccess);\n \t}\n\n"}