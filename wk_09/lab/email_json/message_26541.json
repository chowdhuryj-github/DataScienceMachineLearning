{"category": "ham", "to_address": "samba-cvs@samba.org", "from_address": "tridge@samba.org", "subject": "Rev 267: moved the vnn_map initialisation out of the cmdline code\n\tin http://samba.org/~tridge/ctdb", "body": "------------------------------------------------------------\nrevno: 267\nrevision-id: tridge@samba.org-20070509215546-6s0mhsloyilervjf\nparent: tridge@samba.org-20070509214318-io4xhj2e6k91eosm\ncommitter: Andrew Tridgell \nbranch nick: tridge\ntimestamp: Thu 2007-05-10 07:55:46 +1000\nmessage:\n  moved the vnn_map initialisation out of the cmdline code\nmodified:\n  common/cmdline.c               cmdline.c-20070416041216-w1zvz91bkdsgjckw-1\n  common/ctdb.c                  ctdb.c-20061127094323-t50f58d65iaao5of-2\n  common/ctdb_daemon.c           ctdb_daemon.c-20070409200331-3el1kqgdb9m4ib0g-1\n=== modified file 'common/cmdline.c'\n--- a/common/cmdline.c\t2007-05-08 23:59:23 +0000\n+++ b/common/cmdline.c\t2007-05-09 21:55:46 +0000\n@@ -89,7 +89,7 @@\n struct ctdb_context *ctdb_cmdline_init(struct event_context *ev)\n {\n \tstruct ctdb_context *ctdb;\n-\tint i, ret;\n+\tint ret;\n \n \tif (ctdb_cmdline.nlist == NULL) {\n \t\tprintf(\"You must provide a node list with --nlist\\n\");\n@@ -156,26 +156,6 @@\n \t\t}\n \t}\n \n-\t/* initialize the vnn mapping table */\n-/*\n-XXX we currently initialize it to the maximum number of nodes to \n-XXX make it behave the same way as previously.  \n-XXX Once we have recovery working we should initialize this always to \n-XXX generation==0 (==invalid) and let the recovery tool populate this \n-XXX table for the daemons. \n-*/\n-\tctdb->vnn_map = talloc_zero_size(ctdb, offsetof(struct ctdb_vnn_map, map) + 4*ctdb->num_nodes);\n-\tif (ctdb->vnn_map == NULL) {\n-\t\tDEBUG(0,(__location__ \" Unable to allocate vnn_map structure\\n\"));\n-\t\texit(1);\n-\t}\n-\tctdb->vnn_map->generation = 1;\n-\tctdb->vnn_map->size = ctdb->num_nodes;\n-\tfor(i=0;ivnn_map->size;i++){\n-\t\tctdb->vnn_map->map[i] = i%ctdb->num_nodes;\n-\t}\n-\n-\n \treturn ctdb;\n }\n \n\n=== modified file 'common/ctdb.c'\n--- a/common/ctdb.c\t2007-05-06 19:02:48 +0000\n+++ b/common/ctdb.c\t2007-05-09 21:55:46 +0000\n@@ -152,6 +152,25 @@\n \t\t\treturn -1;\n \t\t}\n \t}\n+\n+\t/* initialize the vnn mapping table now that we have num_nodes setup */\n+/*\n+XXX we currently initialize it to the maximum number of nodes to \n+XXX make it behave the same way as previously.  \n+XXX Once we have recovery working we should initialize this always to \n+XXX generation==0 (==invalid) and let the recovery tool populate this \n+XXX table for the daemons. \n+*/\n+\tctdb->vnn_map = talloc_zero_size(ctdb, offsetof(struct ctdb_vnn_map, map) + 4*ctdb->num_nodes);\n+\tif (ctdb->vnn_map == NULL) {\n+\t\tDEBUG(0,(__location__ \" Unable to allocate vnn_map structure\\n\"));\n+\t\texit(1);\n+\t}\n+\tctdb->vnn_map->generation = 1;\n+\tctdb->vnn_map->size = ctdb->num_nodes;\n+\tfor(i=0;ivnn_map->size;i++){\n+\t\tctdb->vnn_map->map[i] = i%ctdb->num_nodes;\n+\t}\n \t\n \ttalloc_free(lines);\n \treturn 0;\n\n=== modified file 'common/ctdb_daemon.c'\n--- a/common/ctdb_daemon.c\t2007-05-09 21:43:18 +0000\n+++ b/common/ctdb_daemon.c\t2007-05-09 21:55:46 +0000\n@@ -721,7 +721,6 @@\n \t\n \tclose(fd[1]);\n \n-\n \tctdb->ev = event_context_init(NULL);\n \tfde = event_add_fd(ctdb->ev, ctdb, fd[0], EVENT_FD_READ|EVENT_FD_AUTOCLOSE, ctdb_read_from_parent, &fd[0]);\n \tfde = event_add_fd(ctdb->ev, ctdb, ctdb->daemon.sd, EVENT_FD_READ|EVENT_FD_AUTOCLOSE, ctdb_accept_client, ctdb);\n\n"}