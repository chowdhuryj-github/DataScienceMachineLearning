{"category": "ham", "to_address": "samba-cvs@samba.org", "from_address": "obnox@samba.org", "subject": "svn commit: samba r23414 - in branches/SAMBA_3_0_26/source: .", "body": "Author: obnox\nDate: 2007-06-11 10:28:23 +0000 (Mon, 11 Jun 2007)\nNew Revision: 23414\n\nWebSVN: http://websvn.samba.org/cgi-bin/viewcvs.cgi?view=rev&root=samba&rev=23414\n\nLog:\nMerge r23387  and r23389 from 3_0:\n\n1. Unify Posix ACL detection (Linux, FreeBSD, ...)\n2. Turn ACL support detection on by default.\n3. Disable ACL support for darwin.\n\nThis should finally fix Bug #4543.\n\nMichael\n\n\nModified:\n   branches/SAMBA_3_0_26/source/configure.in\n\n\nChangeset:\nModified: branches/SAMBA_3_0_26/source/configure.in\n===================================================================\n--- branches/SAMBA_3_0_26/source/configure.in\t2007-06-11 09:50:18 UTC (rev 23413)\n+++ branches/SAMBA_3_0_26/source/configure.in\t2007-06-11 10:28:23 UTC (rev 23414)\n@@ -5247,55 +5247,71 @@\n \n AC_MSG_CHECKING(whether to support ACLs)\n AC_ARG_WITH(acl-support,\n-[  --with-acl-support      Include ACL support (default=no)],\n+[  --with-acl-support      Include ACL support (default=auto)],\n [ case \"$withval\" in\n-  yes)\n+\tyes|no)\n+\t\twith_acl_support=\"$withval\"\n+\t\t;;\n+  esac ])\n \n+if test x\"$with_acl_support\" = x ; then\n+\twith_acl_support=\"auto\"\n+fi\n+\n+AC_MSG_RESULT($with_acl_support)\n+\n+if test x\"$with_acl_support\" = x\"no\"; then\n+\tAC_MSG_RESULT(Disabling ACL support)\n+\tAC_DEFINE(HAVE_NO_ACLS,1,[Whether no ACLs support should be built in])\n+else\n+\tAC_MSG_NOTICE(checking whether ACL support is available:)\n \tcase \"$host_os\" in\n \t*sysv5*)\n-\t\tAC_MSG_RESULT(Using UnixWare ACLs)\n+\t\tAC_MSG_NOTICE(Using UnixWare ACLs)\n \t\tAC_DEFINE(HAVE_UNIXWARE_ACLS,1,[Whether UnixWare ACLs are available])\n \t\tdefault_static_modules=\"$default_static_modules vfs_solarisacl\"\n \t\t;;\n \t*solaris*)\n-\t\tAC_MSG_RESULT(Using solaris ACLs)\n+\t\tAC_MSG_NOTICE(Using solaris ACLs)\n \t\tAC_DEFINE(HAVE_SOLARIS_ACLS,1,[Whether solaris ACLs are available])\n \t\tACL_LIBS=\"$ACL_LIBS -lsec\"\n \t\tdefault_static_modules=\"$default_static_modules vfs_solarisacl\"\n \t\t;;\n \t*hpux*)\n-\t\tAC_MSG_RESULT(Using HPUX ACLs)\n+\t\tAC_MSG_NOTICE(Using HPUX ACLs)\n \t\tAC_DEFINE(HAVE_HPUX_ACLS,1,[Whether HPUX ACLs are available])\n \t\tdefault_static_modules=\"$default_static_modules vfs_hpuxacl\"\n \t\t;;\n \t*irix*)\n-\t\tAC_MSG_RESULT(Using IRIX ACLs)\n+\t\tAC_MSG_NOTICE(Using IRIX ACLs)\n \t\tAC_DEFINE(HAVE_IRIX_ACLS,1,[Whether IRIX ACLs are available])\n \t\tdefault_static_modules=\"$default_static_modules vfs_irixacl\"\n \t\t;;\n \t*aix*)\n-\t\tAC_MSG_RESULT(Using AIX ACLs)\n+\t\tAC_MSG_NOTICE(Using AIX ACLs)\n \t\tAC_DEFINE(HAVE_AIX_ACLS,1,[Whether AIX ACLs are available])\n \t\tdefault_static_modules=\"$default_static_modules vfs_aixacl\"\n \t\t;;\n \t*osf*)\n-\t\tAC_MSG_RESULT(Using Tru64 ACLs)\n+\t\tAC_MSG_NOTICE(Using Tru64 ACLs)\n \t\tAC_DEFINE(HAVE_TRU64_ACLS,1,[Whether Tru64 ACLs are available])\n \t\tACL_LIBS=\"$ACL_LIBS -lpacl\"\n \t\tdefault_static_modules=\"$default_static_modules vfs_tru64acl\"\n \t\t;;\n-\t*freebsd[[5-9]]*)\n-\t\tAC_MSG_RESULT(Using FreeBSD posix ACLs)\n-\t\tAC_DEFINE(HAVE_POSIX_ACLS,1,[Whether FreeBSD POSIX ACLs are available])\n-\t\tAC_DEFINE(HAVE_ACL_GET_PERM_NP,1,[Whether acl_get_perm_np() is available])\n-\t\tdefault_static_modules=\"$default_static_modules vfs_posixacl\"\n+\t*darwin*)\n+\t\tAC_MSG_NOTICE(ACLs on Darwin currently not supported)\n+\t\tAC_DEFINE(HAVE_NO_ACLS,1,[Whether no ACLs support is available])\n \t\t;;\n-\t*linux*)\n-\t\tAC_CHECK_LIB(attr,getxattr,[ACL_LIBS=\"$ACL_LIBS -lattr\"])\n-       \t\tAC_CHECK_LIB(acl,acl_get_file,[ACL_LIBS=\"$ACL_LIBS -lacl\"])\n-\t\tAC_CACHE_CHECK([for ACL support],samba_cv_HAVE_POSIX_ACLS,[\n+\t*)\n+\t\tAC_CHECK_LIB(acl,acl_get_file,[ACL_LIBS=\"$ACL_LIBS -lacl\"])\n+\t\tcase \"$host_os\" in\n+\t\t*linux*)\n+\t\t\tAC_CHECK_LIB(attr,getxattr,[ACL_LIBS=\"$ACL_LIBS -lattr\"])\n+\t\t\t;;\n+\t\tesac\n+\t\tAC_CACHE_CHECK([for POSIX ACL support],samba_cv_HAVE_POSIX_ACLS,[\n \t\t\tacl_LIBS=$LIBS\n-\t\t\tLIBS=\"$LIBS -lacl\"\n+\t\t\tLIBS=\"$LIBS $ACL_LIBS\"\n \t\t\tAC_TRY_LINK([\n \t\t\t\t#include \n \t\t\t\t#include \n@@ -5310,11 +5326,11 @@\n \t\t\tLIBS=$acl_LIBS\n \t\t])\n \t\tif test x\"$samba_cv_HAVE_POSIX_ACLS\" = x\"yes\"; then\n-\t\t\tAC_MSG_RESULT(Using posix ACLs)\n+\t\t\tAC_MSG_NOTICE(Using posix ACLs)\n \t\t\tAC_DEFINE(HAVE_POSIX_ACLS,1,[Whether POSIX ACLs are available])\n \t\t\tAC_CACHE_CHECK([for acl_get_perm_np],samba_cv_HAVE_ACL_GET_PERM_NP,[\n \t\t\t\tacl_LIBS=$LIBS\n-\t\t\t\tLIBS=\"$LIBS -lacl\"\n+\t\t\t\tLIBS=\"$LIBS $ACL_LIBS\"\n \t\t\t\tAC_TRY_LINK([\n \t\t\t\t\t#include \n \t\t\t\t\t#include \n@@ -5330,64 +5346,17 @@\n \t\t\tif test x\"$samba_cv_HAVE_ACL_GET_PERM_NP\" = x\"yes\"; then\n \t\t\t\tAC_DEFINE(HAVE_ACL_GET_PERM_NP,1,[Whether acl_get_perm_np() is available])\n \t\t\tfi\n+   \t\t\tdefault_static_modules=\"$default_static_modules vfs_posixacl\"\n+\t\telse\n+\t\t\tAC_MSG_NOTICE(ACL support is not avaliable)\n+\t\t\tAC_DEFINE(HAVE_NO_ACLS,1,[Whether no ACLs support is available])\n \t\tfi\n-            ;;\n-         *)\n-\t\tAC_CHECK_LIB(acl,acl_get_file,[ACL_LIBS=\"$ACL_LIBS -lacl\"])\n-\t\tAC_CACHE_CHECK([for ACL support],samba_cv_HAVE_POSIX_ACLS,[\n-\t\t\tacl_LIBS=$LIBS\n-\t\t\tLIBS=\"$LIBS -lacl\"\n-\t\t\tAC_TRY_LINK([\n-\t\t\t\t#include \n-\t\t\t\t#include \n-\t\t\t],[\n-\t\t\t\tacl_t acl;\n-\t\t\t\tint entry_id;\n-\t\t\t\tacl_entry_t *entry_p;\n-\t\t\t\treturn acl_get_entry( acl, entry_id, entry_p);\n-\t\t\t],\n-\t\t\t[samba_cv_HAVE_POSIX_ACLS=yes],\n-\t\t\t[samba_cv_HAVE_POSIX_ACLS=no])\n-\t\t\tLIBS=$acl_LIBS\n-\t\t])\n-\t\tif test x\"$samba_cv_HAVE_POSIX_ACLS\" = x\"yes\"; then\n-\t\t\tAC_MSG_RESULT(Using posix ACLs)\n-\t\t\tAC_DEFINE(HAVE_POSIX_ACLS,1,[Whether POSIX ACLs are available])\n-\t\t\tAC_CACHE_CHECK([for acl_get_perm_np],samba_cv_HAVE_ACL_GET_PERM_NP,[\n-\t\t\t\tacl_LIBS=$LIBS\n-\t\t\t\tLIBS=\"$LIBS -lacl\"\n-\t\t\t\tAC_TRY_LINK([\n-\t\t\t\t\t#include \n-\t\t\t\t\t#include \n-\t\t\t\t],[\n-\t\t\t\t\tacl_permset_t permset_d;\n-\t\t\t\t\tacl_perm_t perm;\n-\t\t\t\t\treturn acl_get_perm_np( permset_d, perm);\n-\t\t\t\t],\n-\t\t\t\t[samba_cv_HAVE_ACL_GET_PERM_NP=yes],\n-\t\t\t\t[samba_cv_HAVE_ACL_GET_PERM_NP=no])\n-\t\t\t\tLIBS=$acl_LIBS\n-\t\t\t])\n-\t\t\tif test x\"$samba_cv_HAVE_ACL_GET_PERM_NP\" = x\"yes\"; then\n-\t\t\t\tAC_DEFINE(HAVE_ACL_GET_PERM_NP,1,[Whether acl_get_perm_np() is available])\n-\t\t\tfi\n-\t\tfi\n-            ;;\n+\t\t;;\n         esac\n-        ;;\n-  *)\n-    AC_MSG_RESULT(no)\n-    AC_DEFINE(HAVE_NO_ACLS,1,[Whether no ACLs support is available])\n-    ;;\n-  esac ],\n-  AC_DEFINE(HAVE_NO_ACLS,1,[Whether no ACLs support should be built in])\n-  AC_MSG_RESULT(no)\n-)\n+fi # with_acl_support\n \n-if test x\"$samba_cv_HAVE_POSIX_ACLS\" = x\"yes\"; then\n-   default_static_modules=\"$default_static_modules vfs_posixacl\"\n-fi\n \n+\n #################################################\n # check for AIO support\n \n\n"}