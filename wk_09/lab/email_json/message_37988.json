{"category": "ham", "to_address": "samba-cvs@samba.org", "from_address": "tridge@samba.org", "subject": "Rev 376: clean shutdown in ctdb - release all our IPs in\n\thttp://samba.org/~tridge/ctdb", "body": "------------------------------------------------------------\nrevno: 376\nrevision-id: tridge@samba.org-20070529033359-zvutvg5816i8pp2f\nparent: tridge@samba.org-20070529032137-pfsv1azm496c6mg0\ncommitter: Andrew Tridgell \nbranch nick: tridge\ntimestamp: Tue 2007-05-29 13:33:59 +1000\nmessage:\n  clean shutdown in ctdb - release all our IPs\nmodified:\n  common/ctdb_control.c          ctdb_control.c-20070426122724-j6gkpiofhbwdin63-1\n  include/ctdb_private.h         ctdb_private.h-20061117234101-o3qt14umlg9en8z0-13\n  takeover/ctdb_takeover.c       ctdb_takeover.c-20070525071636-a5n1ihghjtppy08r-2\n  tools/events                   events-20070529030121-04fjh63cxfh8v1pj-1\n=== modified file 'common/ctdb_control.c'\n--- a/common/ctdb_control.c\t2007-05-29 02:16:59 +0000\n+++ b/common/ctdb_control.c\t2007-05-29 03:33:59 +0000\n@@ -250,7 +250,10 @@\n \t\treturn ctdb->monitoring_mode;\n \n \tcase CTDB_CONTROL_SHUTDOWN:\n-\t\texit(10);\n+\t\tctdb_release_all_ips(ctdb);\n+\t\tctdb_event_script(ctdb, \"shutdown\");\n+\t\tDEBUG(0,(\"shutting down\\n\"));\n+\t\texit(0);\n \n \tcase CTDB_CONTROL_MAX_RSN: \n \t\tCHECK_CONTROL_DATA_SIZE(sizeof(uint32_t));\n\n=== modified file 'include/ctdb_private.h'\n--- a/include/ctdb_private.h\t2007-05-29 02:55:24 +0000\n+++ b/include/ctdb_private.h\t2007-05-29 03:33:59 +0000\n@@ -946,5 +946,6 @@\n \n void ctdb_takeover_client_destructor_hook(struct ctdb_client *client);\n int ctdb_event_script(struct ctdb_context *ctdb, const char *fmt, ...);\n+void ctdb_release_all_ips(struct ctdb_context *ctdb);\n \n #endif\n\n=== modified file 'takeover/ctdb_takeover.c'\n--- a/takeover/ctdb_takeover.c\t2007-05-29 02:55:24 +0000\n+++ b/takeover/ctdb_takeover.c\t2007-05-29 03:33:59 +0000\n@@ -526,3 +526,26 @@\n \t\ttalloc_free(tcp);\n \t}\n }\n+\n+\n+/*\n+  release all IPs on shutdown\n+ */\n+void ctdb_release_all_ips(struct ctdb_context *ctdb)\n+{\n+\tint i;\n+\n+\tif (!ctdb->takeover.enabled) {\n+\t\treturn;\n+\t}\n+\n+\tfor (i=0;inum_nodes;i++) {\n+\t\tstruct ctdb_node *node = ctdb->nodes[i];\n+\t\tif (ctdb_sys_have_ip(node->public_address)) {\n+\t\t\tctdb_event_script(ctdb, \"releaseip %s %s %u\",\n+\t\t\t\t\t  ctdb->takeover.interface, \n+\t\t\t\t\t  node->public_address,\n+\t\t\t\t\t  node->public_netmask_bits);\n+\t\t}\n+\t}\n+}\n\n=== modified file 'tools/events'\n--- a/tools/events\t2007-05-29 03:21:37 +0000\n+++ b/tools/events\t2007-05-29 03:33:59 +0000\n@@ -30,6 +30,7 @@\n \t;;\n \n      recovered)\n+     shutdown)\n         # restart any services as necessary, like NFS\n \texit 0\n \t;;\n\n"}