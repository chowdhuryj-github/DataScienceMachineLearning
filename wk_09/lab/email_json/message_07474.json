{"category": "ham", "to_address": "samba-cvs@samba.org", "from_address": "tridge@samba.org", "subject": "Rev 133: when we get a lmaster request,\n\tskip updating the header when we are also the new dmaster in\n\thttp://samba.org/~tridge/ctdb", "body": "------------------------------------------------------------\nrevno: 133\nrevision-id: tridge@samba.org-20070417063528-1d3fb576e31269f0\nparent: tridge@samba.org-20070417063453-11bf89e87ab63211\ncommitter: Andrew Tridgell \nbranch nick: tridge\ntimestamp: Tue 2007-04-17 16:35:28 +1000\nmessage:\n  when we get a lmaster request, skip updating the header when we are also the new dmaster\nmodified:\n  common/ctdb_call.c             ctdb_call.c-20061128065342-to93h6eejj5kon81-1\n=== modified file 'common/ctdb_call.c'\n--- a/common/ctdb_call.c\t2007-04-17 06:20:32 +0000\n+++ b/common/ctdb_call.c\t2007-04-17 06:35:28 +0000\n@@ -266,23 +266,27 @@\n \t\treturn;\n \t}\n \t\n-\t/* fetch the current record */\n-\tret = ctdb_ltdb_fetch(ctdb_db, key, &header, hdr, &data2);\n-\tif (ret != 0) {\n-\t\tctdb_fatal(ctdb, \"ctdb_req_dmaster failed to fetch record\");\n-\t\treturn;\n-\t}\n-\n-\t/* its a protocol error if the sending node is not the current dmaster */\n-\tif (header.dmaster != hdr->srcnode) {\n-\t\tctdb_fatal(ctdb, \"dmaster request from non-master\");\n-\t\treturn;\n-\t}\n-\n-\theader.dmaster = c->dmaster;\n-\tif (ctdb_ltdb_store(ctdb_db, key, &header, data) != 0) {\n-\t\tctdb_fatal(ctdb, \"ctdb_req_dmaster unable to update dmaster\");\n-\t\treturn;\n+\t/* if the new dmaster and the lmaster are the same node, then\n+\t   we don't need to update the record header now */\n+\tif (c->dmaster != ctdb->vnn) {\n+\t\t/* fetch the current record */\n+\t\tret = ctdb_ltdb_fetch(ctdb_db, key, &header, hdr, &data2);\n+\t\tif (ret != 0) {\n+\t\t\tctdb_fatal(ctdb, \"ctdb_req_dmaster failed to fetch record\");\n+\t\t\treturn;\n+\t\t}\n+\t\t\n+\t\t/* its a protocol error if the sending node is not the current dmaster */\n+\t\tif (header.dmaster != hdr->srcnode) {\n+\t\t\tctdb_fatal(ctdb, \"dmaster request from non-master\");\n+\t\t\treturn;\n+\t\t}\n+\n+\t\theader.dmaster = c->dmaster;\n+\t\tif (ctdb_ltdb_store(ctdb_db, key, &header, data) != 0) {\n+\t\t\tctdb_fatal(ctdb, \"ctdb_req_dmaster unable to update dmaster\");\n+\t\t\treturn;\n+\t\t}\n \t}\n \n \t/* send the CTDB_REPLY_DMASTER */\n\n"}