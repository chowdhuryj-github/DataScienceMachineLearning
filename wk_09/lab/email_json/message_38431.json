{"category": "ham", "to_address": "samba-cvs@samba.org", "from_address": "vlendec@samba.org", "subject": "svn commit: samba r23225 - in branches/SAMBA_3_0/source/nsswitch: .", "body": "Author: vlendec\nDate: 2007-05-29 19:31:57 +0000 (Tue, 29 May 2007)\nNew Revision: 23225\n\nWebSVN: http://websvn.samba.org/cgi-bin/viewcvs.cgi?view=rev&root=samba&rev=23225\n\nLog:\nAttached find a patch that makes use of NetSamLogonEx in\nwinbind. With this and W2k3 DCs around it is possible to use\nmore than one winbind on the same machine account, because\nNetSamLogonEx does not use the credentials chain.\n\nI added the flag domain->can_do_samlogon_ex because this\nonly works against W2k3 and with schannel. The theory is to\ntry if we're AD and have schannel, and fall back to\nNetSamLogon if this fails. can_do_samlogon_ex is thus a\nprotection against multiple failures.\n\nOnly checking into 3_0, this needs more review before going\ninto a production release.\n\nFeel free to comment :-)\n\n\nModified:\n   branches/SAMBA_3_0/source/nsswitch/winbindd.h\n   branches/SAMBA_3_0/source/nsswitch/winbindd_cm.c\n   branches/SAMBA_3_0/source/nsswitch/winbindd_pam.c\n\n\nChangeset:\nModified: branches/SAMBA_3_0/source/nsswitch/winbindd.h\n===================================================================\n--- branches/SAMBA_3_0/source/nsswitch/winbindd.h\t2007-05-29 19:09:38 UTC (rev 23224)\n+++ branches/SAMBA_3_0/source/nsswitch/winbindd.h\t2007-05-29 19:31:57 UTC (rev 23225)\n@@ -169,6 +169,14 @@\n \ttime_t startup_time;\t\t       /* When we set \"startup\" true. */\n \tBOOL startup;                          /* are we in the first 30 seconds after startup_time ? */\n \n+\tBOOL can_do_samlogon_ex; /* Due to the lack of finer control what type\n+\t\t\t\t  * of DC we have, let us try to do a\n+\t\t\t\t  * credential-chain less samlogon_ex call\n+\t\t\t\t  * with AD and schannel. If this fails with\n+\t\t\t\t  * DCERPC_FAULT_OP_RNG_ERROR, then set this\n+\t\t\t\t  * to False. This variable is around so that\n+\t\t\t\t  * we don't have to try _ex every time. */\n+\n \t/* Lookup methods for this domain (LDAP or RPC) */\n \tstruct winbindd_methods *methods;\n \n\nModified: branches/SAMBA_3_0/source/nsswitch/winbindd_cm.c\n===================================================================\n--- branches/SAMBA_3_0/source/nsswitch/winbindd_cm.c\t2007-05-29 19:09:38 UTC (rev 23224)\n+++ branches/SAMBA_3_0/source/nsswitch/winbindd_cm.c\t2007-05-29 19:31:57 UTC (rev 23225)\n@@ -2201,6 +2201,12 @@\n  no_schannel:\n \tif ((lp_client_schannel() == False) ||\n \t\t\t((neg_flags & NETLOGON_NEG_SCHANNEL) == 0)) {\n+\n+\t\t/*\n+\t\t * NetSamLogonEx only works for schannel\n+\t\t */\n+\t\tdomain->can_do_samlogon_ex = False;\n+\n \t\t/* We're done - just keep the existing connection to NETLOGON\n \t\t * open */\n \t\tconn->netlogon_pipe = netlogon_pipe;\n@@ -2232,6 +2238,11 @@\n \t\treturn !NT_STATUS_IS_OK(result) ? result : NT_STATUS_PIPE_NOT_AVAILABLE;\n \t}\n \n+\t/*\n+\t * Try NetSamLogonEx for AD domains\n+\t */\n+\tdomain->can_do_samlogon_ex = domain->active_directory;\n+\t\n \t*cli = conn->netlogon_pipe;\n \treturn NT_STATUS_OK;\n }\n\nModified: branches/SAMBA_3_0/source/nsswitch/winbindd_pam.c\n===================================================================\n--- branches/SAMBA_3_0/source/nsswitch/winbindd_pam.c\t2007-05-29 19:09:38 UTC (rev 23224)\n+++ branches/SAMBA_3_0/source/nsswitch/winbindd_pam.c\t2007-05-29 19:31:57 UTC (rev 23225)\n@@ -1200,6 +1200,17 @@\n \t/* check authentication loop */\n \n \tdo {\n+\t\tNTSTATUS (*logon_fn)(struct rpc_pipe_client\n+\t\t\t\t     *cli, TALLOC_CTX *mem_ctx,\n+\t\t\t\t     uint32 logon_parameters,\n+\t\t\t\t     const char *server,\n+\t\t\t\t     const char *username,\n+\t\t\t\t     const char *domain,\n+\t\t\t\t     const char *workstation, \n+\t\t\t\t     const uint8 chal[8], \n+\t\t\t\t     DATA_BLOB lm_response,\n+\t\t\t\t     DATA_BLOB nt_response,\n+\t\t\t\t     NET_USER_INFO_3 *info3);\n \n \t\tZERO_STRUCTP(my_info3);\n \t\tretry = False;\n@@ -1211,7 +1222,11 @@\n \t\t\tgoto done;\n \t\t}\n \n-\t\tresult = rpccli_netlogon_sam_network_logon(netlogon_pipe,\n+\t\tlogon_fn = contact_domain->can_do_samlogon_ex\n+\t\t\t? rpccli_netlogon_sam_network_logon_ex\n+\t\t\t: rpccli_netlogon_sam_network_logon;\n+\n+\t\tresult = logon_fn(netlogon_pipe,\n \t\t\t\t\t\t\t   state->mem_ctx,\n \t\t\t\t\t\t\t   0,\n \t\t\t\t\t\t\t   contact_domain->dcname, /* server name */\n@@ -1222,6 +1237,16 @@\n \t\t\t\t\t\t\t   lm_resp,\n \t\t\t\t\t\t\t   nt_resp,\n \t\t\t\t\t\t\t   my_info3);\n+\n+\t\tif ((NT_STATUS_V(result) == DCERPC_FAULT_OP_RNG_ERROR)\n+\t\t    && contact_domain->can_do_samlogon_ex) {\n+\t\t\tDEBUG(3, (\"Got a DC that can not do NetSamLogonEx, \"\n+\t\t\t\t  \"retrying with NetSamLogon\\n\"));\n+\t\t\tcontact_domain->can_do_samlogon_ex = False;\n+\t\t\tretry = True;\n+\t\t\tcontinue;\n+\t\t}\n+\t\t\t\n \t\tattempts += 1;\n \n \t\t/* We have to try a second time as cm_connect_netlogon\n@@ -1807,6 +1832,18 @@\n \t}\n \n \tdo {\n+\t\tNTSTATUS (*logon_fn)(struct rpc_pipe_client\n+\t\t\t\t     *cli, TALLOC_CTX *mem_ctx,\n+\t\t\t\t     uint32 logon_parameters,\n+\t\t\t\t     const char *server,\n+\t\t\t\t     const char *username,\n+\t\t\t\t     const char *domain,\n+\t\t\t\t     const char *workstation, \n+\t\t\t\t     const uint8 chal[8], \n+\t\t\t\t     DATA_BLOB lm_response,\n+\t\t\t\t     DATA_BLOB nt_response,\n+\t\t\t\t     NET_USER_INFO_3 *info3);\n+\n \t\tZERO_STRUCT(info3);\n \t\tretry = False;\n \n@@ -1819,7 +1856,11 @@\n \t\t\tgoto done;\n \t\t}\n \n-\t\tresult = rpccli_netlogon_sam_network_logon(netlogon_pipe,\n+\t\tlogon_fn = contact_domain->can_do_samlogon_ex\n+\t\t\t? rpccli_netlogon_sam_network_logon_ex\n+\t\t\t: rpccli_netlogon_sam_network_logon;\n+\n+\t\tresult = logon_fn(netlogon_pipe,\n \t\t\t\t\t\t\t   state->mem_ctx,\n \t\t\t\t\t\t\t   state->request.data.auth_crap.logon_parameters,\n \t\t\t\t\t\t\t   contact_domain->dcname,\n@@ -1832,6 +1873,15 @@\n \t\t\t\t\t\t\t   nt_resp,\n \t\t\t\t\t\t\t   &info3);\n \n+\t\tif ((NT_STATUS_V(result) == DCERPC_FAULT_OP_RNG_ERROR)\n+\t\t    && contact_domain->can_do_samlogon_ex) {\n+\t\t\tDEBUG(3, (\"Got a DC that can not do NetSamLogonEx, \"\n+\t\t\t\t  \"retrying with NetSamLogon\\n\"));\n+\t\t\tcontact_domain->can_do_samlogon_ex = False;\n+\t\t\tretry = True;\n+\t\t\tcontinue;\n+\t\t}\n+\t\t\t\n \t\tattempts += 1;\n \n \t\t/* We have to try a second time as cm_connect_netlogon\n\n"}