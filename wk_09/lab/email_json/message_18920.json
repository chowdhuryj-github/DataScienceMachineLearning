{"category": "ham", "to_address": "samba-cvs@samba.org", "from_address": "vlendec@samba.org", "subject": "svn commit: samba r22561 - in branches/SAMBA_3_0/source: rpc_server\n\tsmbd", "body": "Author: vlendec\nDate: 2007-04-28 18:16:33 +0000 (Sat, 28 Apr 2007)\nNew Revision: 22561\n\nWebSVN: http://websvn.samba.org/cgi-bin/viewcvs.cgi?view=rev&root=samba&rev=22561\n\nLog:\nFix a memleak in lanman.c: Nobody would free the session_list.\n\nVolker\n\nModified:\n   branches/SAMBA_3_0/source/rpc_server/srv_srvsvc_nt.c\n   branches/SAMBA_3_0/source/smbd/lanman.c\n   branches/SAMBA_3_0/source/smbd/session.c\n\n\nChangeset:\nModified: branches/SAMBA_3_0/source/rpc_server/srv_srvsvc_nt.c\n===================================================================\n--- branches/SAMBA_3_0/source/rpc_server/srv_srvsvc_nt.c\t2007-04-28 16:56:35 UTC (rev 22560)\n+++ branches/SAMBA_3_0/source/rpc_server/srv_srvsvc_nt.c\t2007-04-28 18:16:33 UTC (rev 22561)\n@@ -769,13 +769,12 @@\n {\n \tstruct sessionid *session_list;\n \tuint32 num_entries = 0;\n-\t(*stot) = list_sessions(&session_list);\n+\t(*stot) = list_sessions(p->mem_ctx, &session_list);\n \n \tif (ss0 == NULL) {\n \t\tif (snum) {\n \t\t\t(*snum) = 0;\n \t\t}\n-\t\tSAFE_FREE(session_list);\n \t\treturn;\n \t}\n \n@@ -799,7 +798,6 @@\n \t\tss0->array = NULL;\n \t\tss0->count = 0;\n \t}\n-\tSAFE_FREE(session_list);\n }\n \n /*******************************************************************\n@@ -859,7 +857,7 @@\n \t\treturn;\n \t}\n \n-\t(*stot) = list_sessions(&session_list);\n+\t(*stot) = list_sessions(p->mem_ctx, &session_list);\n \n \tss1->array = TALLOC_ARRAY(p->mem_ctx, struct srvsvc_NetSessInfo1, *stot);\n \t\n@@ -900,8 +898,6 @@\n \tif ((*snum) >= (*stot)) {\n \t\t(*snum) = 0;\n \t}\n-\n-\tSAFE_FREE(session_list);\n }\n \n /*******************************************************************\n@@ -1222,7 +1218,7 @@\n \t\tmemmove(machine, &machine[1], strlen(machine));\n \t}\n \n-\tnum_sessions = list_sessions(&session_list);\n+\tnum_sessions = list_sessions(p->mem_ctx, &session_list);\n \n \tDEBUG(5,(\"_srv_net_sess_del: %d\\n\", __LINE__));\n \n@@ -1248,10 +1244,7 @@\n \n \tDEBUG(5,(\"_srv_net_sess_del: %d\\n\", __LINE__));\n \n-\n done:\n-\tSAFE_FREE(session_list);\n-\n \treturn status;\n }\n \n\nModified: branches/SAMBA_3_0/source/smbd/lanman.c\n===================================================================\n--- branches/SAMBA_3_0/source/smbd/lanman.c\t2007-04-28 16:56:35 UTC (rev 22560)\n+++ branches/SAMBA_3_0/source/smbd/lanman.c\t2007-04-28 18:16:33 UTC (rev 22561)\n@@ -4213,7 +4213,7 @@\n \t\treturn False;\n \t}\n \n-\tnum_sessions = list_sessions(&session_list);\n+\tnum_sessions = list_sessions(tmp_talloc_ctx(), &session_list);\n \n \tif (mdrcnt > 0) {\n \t\t*rdata = SMB_REALLOC_LIMIT(*rdata,mdrcnt);\n\nModified: branches/SAMBA_3_0/source/smbd/session.c\n===================================================================\n--- branches/SAMBA_3_0/source/smbd/session.c\t2007-04-28 16:56:35 UTC (rev 22560)\n+++ branches/SAMBA_3_0/source/smbd/session.c\t2007-04-28 18:16:33 UTC (rev 22561)\n@@ -218,6 +218,7 @@\n ********************************************************************/\n \n struct session_list {\n+\tTALLOC_CTX *mem_ctx;\n \tint count;\n \tstruct sessionid *sessions;\n };\n@@ -230,7 +231,9 @@\n \n \ti = sesslist->count;\n \t\n-\tsesslist->sessions = SMB_REALLOC_ARRAY(sesslist->sessions, struct sessionid, i+1);\n+\tsesslist->sessions = TALLOC_REALLOC_ARRAY(\n+\t\tsesslist->mem_ctx, sesslist->sessions, struct sessionid, i+1);\n+\n \tif (!sesslist->sessions) {\n \t\tsesslist->count = 0;\n \t\treturn -1;\n@@ -248,10 +251,11 @@\n /********************************************************************\n ********************************************************************/\n \n-int list_sessions(struct sessionid **session_list)\n+int list_sessions(TALLOC_CTX *mem_ctx, struct sessionid **session_list)\n {\n \tstruct session_list sesslist;\n \n+\tsesslist.mem_ctx = mem_ctx;\n \tsesslist.count = 0;\n \tsesslist.sessions = NULL;\n \t\n\n"}