{"category": "ham", "to_address": "samba-cvs@samba.org", "from_address": "abartlet@samba.org", "subject": "svn commit: samba r23366 - in branches/SAMBA_4_0_RELEASE/source:\n\trpc_server/samr torture/rpc", "body": "Author: abartlet\nDate: 2007-06-06 12:52:48 +0000 (Wed, 06 Jun 2007)\nNew Revision: 23366\n\nWebSVN: http://websvn.samba.org/cgi-bin/viewcvs.cgi?view=rev&root=samba&rev=23366\n\nLog:\nMerge from SAMBA_4_0:\n\nTry to make Windows Vista join again.  On my new test environment, it\nwants to check for an existing domain join account, and fails.  This\ntest shows that we need to return NT_STATUS_NONE_MAPPED when nothing\nmatches.  (not yet tested if this helps vista).\n\n\nModified:\n   branches/SAMBA_4_0_RELEASE/source/rpc_server/samr/dcesrv_samr.c\n   branches/SAMBA_4_0_RELEASE/source/torture/rpc/samr.c\n\n\nChangeset:\nModified: branches/SAMBA_4_0_RELEASE/source/rpc_server/samr/dcesrv_samr.c\n===================================================================\n--- branches/SAMBA_4_0_RELEASE/source/rpc_server/samr/dcesrv_samr.c\t2007-06-06 12:51:45 UTC (rev 23365)\n+++ branches/SAMBA_4_0_RELEASE/source/rpc_server/samr/dcesrv_samr.c\t2007-06-06 12:52:48 UTC (rev 23366)\n@@ -1783,7 +1783,7 @@\n {\n \tstruct dcesrv_handle *h;\n \tstruct samr_domain_state *d_state;\n-\tint i;\n+\tint i, num_mapped;\n \tNTSTATUS status = NT_STATUS_OK;\n \tconst char * const attrs[] = { \"sAMAccountType\", \"objectSid\", NULL };\n \tint count;\n@@ -1807,6 +1807,8 @@\n \tr->out.rids.count = r->in.num_names;\n \tr->out.types.count = r->in.num_names;\n \n+\tnum_mapped = 0;\n+\n \tfor (i=0;iin.num_names;i++) {\n \t\tstruct ldb_message **res;\n \t\tstruct dom_sid *sid;\n@@ -1844,9 +1846,12 @@\n \n \t\tr->out.rids.ids[i] = sid->sub_auths[sid->num_auths-1];\n \t\tr->out.types.ids[i] = rtype;\n+\t\tnum_mapped++;\n \t}\n \t\n-\n+\tif (num_mapped == 0) {\n+\t\treturn NT_STATUS_NONE_MAPPED;\n+\t}\n \treturn status;\n }\n \n\nModified: branches/SAMBA_4_0_RELEASE/source/torture/rpc/samr.c\n===================================================================\n--- branches/SAMBA_4_0_RELEASE/source/torture/rpc/samr.c\t2007-06-06 12:51:45 UTC (rev 23365)\n+++ branches/SAMBA_4_0_RELEASE/source/torture/rpc/samr.c\t2007-06-06 12:52:48 UTC (rev 23366)\n@@ -922,17 +922,43 @@\n \tstatus = dcerpc_samr_LookupNames(p, mem_ctx, &n);\n \tif (!NT_STATUS_EQUAL(status, STATUS_SOME_UNMAPPED)) {\n \t\tprintf(\"LookupNames[2] failed - %s\\n\", nt_errstr(status));\t\t\n+\t\tif (NT_STATUS_IS_OK(status)) {\n+\t\t\treturn NT_STATUS_UNSUCCESSFUL;\n+\t\t}\n \t\treturn status;\n \t}\n \n-\tinit_lsa_String(&sname[1], \"xxNONAMExx\");\n \tn.in.num_names = 0;\n \tstatus = dcerpc_samr_LookupNames(p, mem_ctx, &n);\n \tif (!NT_STATUS_IS_OK(status)) {\n \t\tprintf(\"LookupNames[0] failed - %s\\n\", nt_errstr(status));\t\t\n+\t\treturn status;\n \t}\n \n-\treturn status;\n+\tinit_lsa_String(&sname[0], \"xxNONAMExx\");\n+\tn.in.num_names = 1;\n+\tstatus = dcerpc_samr_LookupNames(p, mem_ctx, &n);\n+\tif (!NT_STATUS_EQUAL(status, NT_STATUS_NONE_MAPPED)) {\n+\t\tprintf(\"LookupNames[1 bad name] failed - %s\\n\", nt_errstr(status));\t\t\n+\t\tif (NT_STATUS_IS_OK(status)) {\n+\t\t\treturn NT_STATUS_UNSUCCESSFUL;\n+\t\t}\n+\t\treturn status;\n+\t}\n+\n+\tinit_lsa_String(&sname[0], \"xxNONAMExx\");\n+\tinit_lsa_String(&sname[1], \"xxNONAME2xx\");\n+\tn.in.num_names = 2;\n+\tstatus = dcerpc_samr_LookupNames(p, mem_ctx, &n);\n+\tif (!NT_STATUS_EQUAL(status, NT_STATUS_NONE_MAPPED)) {\n+\t\tprintf(\"LookupNames[2 bad names] failed - %s\\n\", nt_errstr(status));\t\t\n+\t\tif (NT_STATUS_IS_OK(status)) {\n+\t\t\treturn NT_STATUS_UNSUCCESSFUL;\n+\t\t}\n+\t\treturn status;\n+\t}\n+\n+\treturn NT_STATUS_OK;\n }\n \n static NTSTATUS test_OpenUser_byname(struct dcerpc_pipe *p, TALLOC_CTX *mem_ctx, \n\n"}