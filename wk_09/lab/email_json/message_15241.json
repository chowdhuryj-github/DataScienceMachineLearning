{"category": "ham", "to_address": "samba-cvs@samba.org", "from_address": "jerry@samba.org", "subject": "svn commit: samba r22510 - in branches/SAMBA_3_0_RELEASE: . source\n\tsource/groupdb source/lib source/libgpo source/passdb\n\tsource/rpc_server source/smbd", "body": "Author: jerry\nDate: 2007-04-25 09:36:47 +0000 (Wed, 25 Apr 2007)\nNew Revision: 22510\n\nWebSVN: http://websvn.samba.org/cgi-bin/viewcvs.cgi?view=rev&root=samba&rev=22510\n\nLog:\npull patches from SAMBA_3_0_25 and update release notes for 3.0.25rc3\nModified:\n   branches/SAMBA_3_0_RELEASE/WHATSNEW.txt\n   branches/SAMBA_3_0_RELEASE/source/Makefile.in\n   branches/SAMBA_3_0_RELEASE/source/VERSION\n   branches/SAMBA_3_0_RELEASE/source/groupdb/mapping_tdb.c\n   branches/SAMBA_3_0_RELEASE/source/lib/util_sid.c\n   branches/SAMBA_3_0_RELEASE/source/libgpo/gpo_fetch.c\n   branches/SAMBA_3_0_RELEASE/source/passdb/pdb_ldap.c\n   branches/SAMBA_3_0_RELEASE/source/rpc_server/srv_samr_nt.c\n   branches/SAMBA_3_0_RELEASE/source/smbd/posix_acls.c\n   branches/SAMBA_3_0_RELEASE/source/smbd/reply.c\n   branches/SAMBA_3_0_RELEASE/source/smbd/trans2.c\n\n\nChangeset:\nModified: branches/SAMBA_3_0_RELEASE/WHATSNEW.txt\n===================================================================\n--- branches/SAMBA_3_0_RELEASE/WHATSNEW.txt\t2007-04-25 09:32:03 UTC (rev 22509)\n+++ branches/SAMBA_3_0_RELEASE/WHATSNEW.txt\t2007-04-25 09:36:47 UTC (rev 22510)\n@@ -1,9 +1,9 @@\n                    =================================\n-                   Release Notes for Samba 3.0.25rc2\n-                               Apr 22, 2007\n+                   Release Notes for Samba 3.0.25rc3\n+                               Apr 25, 2007\n                    =================================\n \n-This is the second release candidate of the Samba 3.0.25 code base \n+This is the third release candidate of the Samba 3.0.25 code base \n and is provided for testing only.  An RC release means that we are \n close to the final release but the code may still have a few \n remaining minor bugs.  This release is *not* intended for production \n@@ -27,7 +27,7 @@\n     by side on the Same server.\n   o Improved compatibility with Windows Vista clients including \n     improved read performance with Linux servers.\n-  o Man pages for VFS plug-ins.\n+  o Man pages for IdMap and VFS plug-ins.\n \n \n Off-line Logons and AD Site Support\n@@ -42,16 +42,12 @@\n New IdMap Interface for Winbindd\n ================================\n \n-The 3.0.25 release of Samba will include a rewritten IdMap interface\n-for winbindd which replaces the \"idmap backend\" parameter.  The\n-initial design document may be found at\n+The 3.0.25 release of Samba includes a rewritten IdMap interface\n+for winbindd which replaces the \"idmap backend\" parameter.  Please \n+refer to the \"idmap domains\" description in the smb.conf(5) man \n+page for more details.\n \n-\thttp://www.samba.org/~idra/samba3_newidmap.pdf\n \n-Please refer to the \"idmap domains\" description in the smb.conf(5)\n-man page for more details.\n-\n-\n Dynamic DNS Updates\n ===================\n \n@@ -95,13 +91,61 @@\n Changes\n #######\n \n-Changes since 3.0.25pre2\n-------------------------\n+Changes since 3.0.25rc2\n+-----------------------\n \n commits\n -------\n \n o   Jeremy Allison \n+    * Allow Well-Known and Local Groups to be stored in POSIX ACLs\n+      as long as there is a SID/gid mapping entry available.\n+    * Fix memory corruption bug in the CIFS POSIX open/mkdir.\n+    * BUG 4536: Correctly delete symlinks pointing to a directory.\n+\n+\n+o   Gerald (Jerry) Carter \n+    * Ensure winbindd honors the \"idmap domains\" option and not \n+      default to idmap_tdb.\n+    * Fix memory corruption caused by calling free() on talloc()'d\n+      memory when adding and removing users from local groups.\n+\n+\n+o   Guenther Deschner \n+    * Memory allocation error checks in libgpo.\n+\n+\n+o   Jim McDonough \n+    * Fix crate_user() access checks when setting the \"User Cannot \n+      Change Password\" flag.\n+\n+\n+o   Simo Sorce \n+    * Fix linking flags used when creating shared libraries.\n+\n+\n+\n+Release Notes for older release follow:\n+\n+      --------------------------------------------------\n+\n+                   =================================\n+                   Release Notes for Samba 3.0.25rc2\n+                               Apr 22, 2007\n+                   =================================\n+\n+\n+######################################################################\n+Changes\n+#######\n+\n+Changes since 3.0.25rc1\n+-----------------------\n+\n+commits\n+-------\n+\n+o   Jeremy Allison \n     * BUG 4494: Make sure to fail immediately if sendfile fails and\n       don't continue on to call chain_reply() (based on report from\n       Kevin Jamieson).\n\nModified: branches/SAMBA_3_0_RELEASE/source/Makefile.in\n===================================================================\n--- branches/SAMBA_3_0_RELEASE/source/Makefile.in\t2007-04-25 09:32:03 UTC (rev 22509)\n+++ branches/SAMBA_3_0_RELEASE/source/Makefile.in\t2007-04-25 09:36:47 UTC (rev 22510)\n@@ -23,10 +23,10 @@\n CFLAGS=@CFLAGS@\n CPPFLAGS=-DHAVE_CONFIG_H @CPPFLAGS@\n EXEEXT=@EXEEXT@\n-LDFLAGS=@PIE_LDFLAGS@ @LDFLAGS@\n AR=@AR@\n LDSHFLAGS=@LDSHFLAGS@ @LDFLAGS@\n WINBIND_NSS_LDSHFLAGS=@WINBIND_NSS_LDSHFLAGS@ @LDFLAGS@\n+LDFLAGS=@PIE_LDFLAGS@ @LDFLAGS@\n AWK=@AWK@\n PICFLAG=@PICFLAG@\n DYNEXP=@DYNEXP@\n@@ -1144,7 +1144,7 @@\n \n bin/libaddns.@SHLIBEXT@: proto_exists $(LIBADDNS_OBJ)\n \t@echo Linking libaddns shared library $@\n-\t@$(SHLD) $(LDSHFLAGS) -o $@ $(LIBADDNS_OBJ) $(LDFLAGS) $(LIBS) \\\n+\t@$(SHLD) $(LDSHFLAGS) -o $@ $(LIBADDNS_OBJ) $(LIBS) \\\n \t\t$(KRB5LIBS) $(UUID_LIBS)\\\n \t\t@SONAMEFLAG@`basename $@`.$(LIBADDNS_MAJOR)\n \n@@ -1154,7 +1154,7 @@\n \n bin/libsmbclient.@SHLIBEXT@: proto_exists $(LIBSMBCLIENT_OBJ)\n \t@echo Linking libsmbclient shared library $@\n-\t@$(SHLD) $(LDSHFLAGS) -o $@ $(LIBSMBCLIENT_OBJ) $(LDFLAGS) $(LIBS) \\\n+\t@$(SHLD) $(LDSHFLAGS) -o $@ $(LIBSMBCLIENT_OBJ) $(LIBS) \\\n \t\t$(KRB5LIBS) $(LDAP_LIBS) $(NSCD_LIBS) \\\n \t\t@SONAMEFLAG@`basename $@`.$(LIBSMBCLIENT_MAJOR)\n \n@@ -1164,7 +1164,7 @@\n \n bin/libsmbsharemodes.@SHLIBEXT@: proto_exists $(LIBSMBSHAREMODES_OBJ)\n \t@echo Linking libsmbsharemodes shared library $@\n-\t@$(SHLD) $(LDSHFLAGS) -o $@ $(LIBSMBSHAREMODES_OBJ) $(LDFLAGS) $(LIBS) \\\n+\t@$(SHLD) $(LDSHFLAGS) -o $@ $(LIBSMBSHAREMODES_OBJ) $(LIBS) \\\n \t\t$(KRB5LIBS) $(LDAP_LIBS) \\\n \t\t@SONAMEFLAG@`basename $@`.$(LIBSMBSHAREMODES_MAJOR)\n \n@@ -1174,7 +1174,7 @@\n \n bin/libmsrpc.@SHLIBEXT@: proto_exists $(CAC_OBJ)\n \t@echo Linking libmsrpc shared library $@\n-\t@$(SHLD) $(LDSHFLAGS) -o $@ $(CAC_OBJ) $(LDFLAGS) $(LIBS) \\\n+\t@$(SHLD) $(LDSHFLAGS) -o $@ $(CAC_OBJ) $(LIBS) \\\n \t@SONAMEFLAG@`basename $@`.$(LIBMSRPC_MAJOR)\n \n bin/libmsrpc.a: proto_exists $(CAC_OBJ)\n\nModified: branches/SAMBA_3_0_RELEASE/source/VERSION\n===================================================================\n--- branches/SAMBA_3_0_RELEASE/source/VERSION\t2007-04-25 09:32:03 UTC (rev 22509)\n+++ branches/SAMBA_3_0_RELEASE/source/VERSION\t2007-04-25 09:36:47 UTC (rev 22510)\n@@ -56,7 +56,7 @@\n # e.g. SAMBA_VERSION_RC_RELEASE=1                      #\n #  ->  \"3.0.0rc1\"                                      #\n ########################################################\n-SAMBA_VERSION_RC_RELEASE=2\n+SAMBA_VERSION_RC_RELEASE=3\n \n ########################################################\n # To mark SVN snapshots this should be set to 'yes'    #\n\nModified: branches/SAMBA_3_0_RELEASE/source/groupdb/mapping_tdb.c\n===================================================================\n--- branches/SAMBA_3_0_RELEASE/source/groupdb/mapping_tdb.c\t2007-04-25 09:32:03 UTC (rev 22509)\n+++ branches/SAMBA_3_0_RELEASE/source/groupdb/mapping_tdb.c\t2007-04-25 09:36:47 UTC (rev 22510)\n@@ -466,11 +466,11 @@\n \n \tfor (i=0; iaces[i];\n \n \t\t/*\n-\t\t * Ignore non-mappable SIDs (NT Authority, BUILTIN etc).\n-\t\t */\n-\n-\t\tif (non_mappable_sid(&psa->trustee)) {\n-\t\t\tfstring str;\n-\t\t\tDEBUG(10,(\"create_canon_ace_lists: ignoring non-mappable SID %s\\n\",\n-\t\t\t\tsid_to_string(str, &psa->trustee) ));\n-\t\t\tcontinue;\n-\t\t}\n-\n-\t\t/*\n \t\t * Create a cannon_ace entry representing this NT DACL ACE.\n \t\t */\n \n@@ -1417,6 +1406,16 @@\n \t\t} else {\n \t\t\tfstring str;\n \n+\t\t\t/*\n+\t\t\t * Silently ignore map failures in non-mappable SIDs (NT Authority, BUILTIN etc).\n+\t\t\t */\n+\n+\t\t\tif (non_mappable_sid(&psa->trustee)) {\n+\t\t\t\tDEBUG(10,(\"create_canon_ace_lists: ignoring non-mappable SID %s\\n\",\n+\t\t\t\t\tsid_to_string(str, &psa->trustee) ));\n+\t\t\t\tcontinue;\n+\t\t\t}\n+\n \t\t\tfree_canon_ace_list(file_ace);\n \t\t\tfree_canon_ace_list(dir_ace);\n \t\t\tDEBUG(0,(\"create_canon_ace_lists: unable to map SID %s to uid or gid.\\n\",\n\nModified: branches/SAMBA_3_0_RELEASE/source/smbd/reply.c\n===================================================================\n--- branches/SAMBA_3_0_RELEASE/source/smbd/reply.c\t2007-04-25 09:32:03 UTC (rev 22509)\n+++ branches/SAMBA_3_0_RELEASE/source/smbd/reply.c\t2007-04-25 09:36:47 UTC (rev 22510)\n@@ -3866,7 +3866,23 @@\n \tint ret;\n \tSMB_STRUCT_STAT st;\n \n-\tret = SMB_VFS_RMDIR(conn,directory);\n+\t/* Might be a symlink. */\n+\tif(SMB_VFS_LSTAT(conn, directory, &st) != 0) {\n+\t\treturn map_nt_error_from_unix(errno);\n+\t}\n+\n+\tif (S_ISLNK(st.st_mode)) {\n+\t\t/* Is what it points to a directory ? */\n+\t\tif(SMB_VFS_STAT(conn, directory, &st) != 0) {\n+\t\t\treturn map_nt_error_from_unix(errno);\n+\t\t}\n+\t\tif (!(S_ISDIR(st.st_mode))) {\n+\t\t\treturn NT_STATUS_NOT_A_DIRECTORY;\n+\t\t}\n+\t\tret = SMB_VFS_UNLINK(conn,directory);\n+\t} else {\n+\t\tret = SMB_VFS_RMDIR(conn,directory);\n+\t}\n \tif (ret == 0) {\n \t\tnotify_fname(conn, NOTIFY_ACTION_REMOVED,\n \t\t\t     FILE_NOTIFY_CHANGE_DIR_NAME,\n\nModified: branches/SAMBA_3_0_RELEASE/source/smbd/trans2.c\n===================================================================\n--- branches/SAMBA_3_0_RELEASE/source/smbd/trans2.c\t2007-04-25 09:32:03 UTC (rev 22509)\n+++ branches/SAMBA_3_0_RELEASE/source/smbd/trans2.c\t2007-04-25 09:36:47 UTC (rev 22510)\n@@ -3717,7 +3717,7 @@\n \t\t\t\tSIVAL(pdata,0,0); /* ??? */\n \t\t\t\tSIVAL(pdata,4,byte_len); /* Byte length of unicode string ::$DATA */\n \t\t\t\tSOFF_T(pdata,8,file_size);\n-\t\t\t\tSIVAL(pdata,16,allocation_size);\n+\t\t\t\tSOFF_T(pdata,16,allocation_size);\n \t\t\t\tSIVAL(pdata,20,0); /* ??? */\n \t\t\t\tdata_size = 24 + byte_len;\n \t\t\t}\n@@ -3738,7 +3738,7 @@\n \t\t\tput_long_date_timespec(pdata+8,atime_ts);\n \t\t\tput_long_date_timespec(pdata+16,mtime_ts); /* write time */\n \t\t\tput_long_date_timespec(pdata+24,mtime_ts); /* change time */\n-\t\t\tSIVAL(pdata,32,allocation_size);\n+\t\t\tSOFF_T(pdata,32,allocation_size);\n \t\t\tSOFF_T(pdata,40,file_size);\n \t\t\tSIVAL(pdata,48,mode);\n \t\t\tSIVAL(pdata,52,0); /* ??? */\n@@ -5295,6 +5295,7 @@\n \t\t*pdata_return_size = 0;\n \t\treturn NT_STATUS_NO_MEMORY;\n \t}\n+\tpdata = *ppdata;\n \n \tSSVAL(pdata,0,NO_OPLOCK_RETURN);\n \tSSVAL(pdata,2,0); /* No fnum. */\n@@ -5471,6 +5472,7 @@\n \t\t*pdata_return_size = 0;\n \t\treturn NT_STATUS_NO_MEMORY;\n \t}\n+\tpdata = *ppdata;\n \n \tif (extended_oplock_granted) {\n \t\tif (flags & REQUEST_BATCH_OPLOCK) {\n\n"}