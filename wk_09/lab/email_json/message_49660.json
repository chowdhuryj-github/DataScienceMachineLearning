{"category": "ham", "to_address": "samba-cvs@samba.org", "from_address": "tridge@samba.org", "subject": "Rev 547: merge from ronnie in http://samba.org/~tridge/ctdb", "body": "------------------------------------------------------------\nrevno: 547\nrevision-id: tridge@samba.org-20070617171050-2zkpq4tu68qqryfo\nparent: tridge@samba.org-20070617133144-nympluy3k8uuqbf5\nparent: sahlberg@ronnie-20070617163429-lkw74mopo7vg3l7l\ncommitter: Andrew Tridgell \nbranch nick: tridge\ntimestamp: Mon 2007-06-18 03:10:50 +1000\nmessage:\n  merge from ronnie\nmodified:\n  config/events.d/50.samba       samba-20070601105340-vlcvnp6euoj3zdwy-3\n    ------------------------------------------------------------\n    revno: 432.1.80\n    merged: sahlberg@ronnie-20070617163429-lkw74mopo7vg3l7l\n    parent: sahlberg@ronnie-20070617011342-z2cukqaalg61vyrt\n    committer: Ronnie Sahlberg \n    branch nick: ctdb\n    timestamp: Mon 2007-06-18 02:34:29 +1000\n    message:\n      add a mechanism to the samba event script to do periodic cleanup of the \n      databases once every 60 minutes\n=== modified file 'config/events.d/50.samba'\n--- a/config/events.d/50.samba\t2007-06-17 02:05:29 +0000\n+++ b/config/events.d/50.samba\t2007-06-17 17:10:50 +0000\n@@ -13,6 +13,9 @@\n \n case $cmd in \n      startup)\n+\t# create the state directory for samba\n+\t/bin/mkdir -p /etc/ctdb/state/samba\n+\n \t# wait for all shared directories to become available\n \tsmb_dirs=`testparm -s 2> /dev/null | egrep '^\\s*path = '  | cut -d= -f2`\n \tctdb_wait_directories \"Samba\" $smb_dirs\t\n@@ -55,6 +58,16 @@\n \t;;\n \n      monitor)\n+\t# Create a dummy file to track when we need to do periodic cleanup\n+\t# of samba databases\n+\t[ -f /etc/ctdb/state/samba/periodic_cleanup ] || {\n+\t\ttouch /etc/ctdb/state/samba/periodic_cleanup\n+\t}\n+\t[ `/usr/bin/find /etc/ctdb/state/samba/periodic_cleanup -mmin +1 | wc -l` -eq 1 ] && {\n+\t\t# Cleanup the databases\n+\t\ttouch /etc/ctdb/state/samba/periodic_cleanup\n+\t}\n+\n \ttestparm -s 2>&1 | egrep '^WARNING|^ERROR|^Unknown' && {\n \t    echo \"`date` ERROR: testparm shows smb.conf is not clean\"\n \t    exit 1\n\n"}