{"category": "ham", "to_address": "samba-cvs@samba.org", "from_address": "tridge@samba.org", "subject": "Rev 198: merge vnn_map code from ronnie in\n\thttp://samba.org/~tridge/ctdb", "body": "------------------------------------------------------------\nrevno: 198\nrevision-id: tridge@samba.org-20070427090103-i8wupn3xkdt3f7wy\nparent: tridge@samba.org-20070426212926-5pgrco1jswx21t63\nparent: sahlberg@ronnie-20070427084352-a68b95ed2ab8e2d6\ncommitter: Andrew Tridgell \nbranch nick: tridge\ntimestamp: Fri 2007-04-27 11:01:03 +0200\nmessage:\n  merge vnn_map code from ronnie\nmodified:\n  common/cmdline.c               cmdline.c-20070416041216-w1zvz91bkdsgjckw-1\n  common/ctdb_daemon.c           ctdb_daemon.c-20070409200331-3el1kqgdb9m4ib0g-1\n  common/ctdb_ltdb.c             ctdb_ltdb.c-20061128065342-to93h6eejj5kon81-2\n  include/ctdb_private.h         ctdb_private.h-20061117234101-o3qt14umlg9en8z0-13\n    ------------------------------------------------------------\n    revno: 197.1.1\n    merged: sahlberg@ronnie-20070427084352-a68b95ed2ab8e2d6\n    parent: tridge@samba.org-20070426212926-5pgrco1jswx21t63\n    committer: Ronnie Sahlberg \n    branch nick: ctdb\n    timestamp: Fri 2007-04-27 18:43:52 +1000\n    message:\n      add a mapping table from a hash value to a lmaster vnn number\n      \n      update ctdb_lmaster() return the lmaster based on this tables contents\n      \n      \n      initialize the vnn table based on number of nodes for now.\n      later when recovery is implemented the recovery process will populate \n      this mapping table.\n=== modified file 'common/cmdline.c'\n--- a/common/cmdline.c\t2007-04-26 17:27:07 +0000\n+++ b/common/cmdline.c\t2007-04-27 08:43:52 +0000\n@@ -66,7 +66,7 @@\n struct ctdb_context *ctdb_cmdline_init(struct event_context *ev)\n {\n \tstruct ctdb_context *ctdb;\n-\tint ret;\n+\tint i, ret;\n \n \tif (ctdb_cmdline.nlist == NULL || ctdb_cmdline.myaddress == NULL) {\n \t\tprintf(\"You must provide a node list with --nlist and an address with --listen\\n\");\n@@ -120,6 +120,31 @@\n \t\texit(1);\n \t}\n \n+\t/* initialize the vnn mapping table */\n+/*\n+XXX we currently initialize it to the maximum number of nodes to \n+XXX make it behave the same way as previously.  \n+XXX Once we have recovery working we should initialize this always to \n+XXX generation==0 (==invalid) and let the recovery tool populate this \n+XXX table for the daemons. \n+*/\n+\tctdb->vnn_map = talloc_zero(ctdb, struct ctdb_vnn_map);\n+\tif (ctdb->vnn_map == NULL) {\n+\t\tDEBUG(0,(__location__ \" Unable to allocate vnn_map structure\\n\"));\n+\t\texit(1);\n+\t}\n+\tctdb->vnn_map->generation = 1;\n+\tctdb->vnn_map->size = 1024;\n+\tctdb->vnn_map->map = talloc_array(ctdb->vnn_map, uint32_t, ctdb->vnn_map->size);\n+\tif (ctdb->vnn_map->map == NULL) {\n+\t\tDEBUG(0,(__location__ \" Unable to allocate vnn_map->map structure\\n\"));\n+\t\texit(1);\n+\t}\n+\tfor(i=0;ivnn_map->size;i++){\n+\t\tctdb->vnn_map->map[i] = i%ctdb->num_nodes;\n+\t}\n+\n+\n \treturn ctdb;\n }\n \n\n=== modified file 'common/ctdb_daemon.c'\n--- a/common/ctdb_daemon.c\t2007-04-26 21:10:35 +0000\n+++ b/common/ctdb_daemon.c\t2007-04-27 08:43:52 +0000\n@@ -678,6 +678,7 @@\n \t\n \tclose(fd[1]);\n \n+\n \tctdb->ev = event_context_init(NULL);\n \tfde = event_add_fd(ctdb->ev, ctdb, fd[0], EVENT_FD_READ, ctdb_read_from_parent, &fd[0]);\n \tfde = event_add_fd(ctdb->ev, ctdb, ctdb->daemon.sd, EVENT_FD_READ, ctdb_accept_client, ctdb);\n\n=== modified file 'common/ctdb_ltdb.c'\n--- a/common/ctdb_ltdb.c\t2007-04-26 21:10:35 +0000\n+++ b/common/ctdb_ltdb.c\t2007-04-27 08:43:52 +0000\n@@ -124,7 +124,12 @@\n */\n uint32_t ctdb_lmaster(struct ctdb_context *ctdb, const TDB_DATA *key)\n {\n-\treturn ctdb_hash(key) % ctdb->num_nodes;\n+\tuint32_t idx, lmaster;\n+\n+\tidx = ctdb_hash(key) % ctdb->vnn_map->size;\n+\tlmaster = ctdb->vnn_map->map[idx];\n+\n+\treturn lmaster;\n }\n \n \n\n=== modified file 'include/ctdb_private.h'\n--- a/include/ctdb_private.h\t2007-04-26 21:10:35 +0000\n+++ b/include/ctdb_private.h\t2007-04-27 08:43:52 +0000\n@@ -157,6 +157,14 @@\n \tdouble max_lockwait_latency;\n };\n \n+/* table that contains the mapping between a hash value and lmaster\n+ */\n+struct ctdb_vnn_map {\n+\tuint32_t generation;\n+\tuint32_t size;\n+\tuint32_t *map;\n+};\n+\n /* main state of the ctdb daemon */\n struct ctdb_context {\n \tstruct event_context *ev;\n@@ -181,6 +189,7 @@\n \tstruct ctdb_message_list *message_list;\n \tstruct ctdb_daemon_data daemon;\n \tstruct ctdb_status status;\n+\tstruct ctdb_vnn_map *vnn_map;\n };\n \n struct ctdb_db_context {\n\n"}