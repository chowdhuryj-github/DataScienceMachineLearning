{"category": "ham", "to_address": "samba-cvs@samba.org", "from_address": "jerry@samba.org", "subject": "svn commit: samba r22720 - in branches: SAMBA_3_0/source/nsswitch\n\tSAMBA_3_0_26/source/nsswitch", "body": "Author: jerry\nDate: 2007-05-06 21:26:01 +0000 (Sun, 06 May 2007)\nNew Revision: 22720\n\nWebSVN: http://websvn.samba.org/cgi-bin/viewcvs.cgi?view=rev&root=samba&rev=22720\n\nLog:\nFixes for offline auth when using krb5_auth = yes in pam_winbind.\nAssume that \"NO_DOMAIN_CONTROLLERS_FOUND\" means that the domain \nis offline.\n\n\nModified:\n   branches/SAMBA_3_0/source/nsswitch/winbindd_pam.c\n   branches/SAMBA_3_0_26/source/nsswitch/winbindd_pam.c\n\n\nChangeset:\nModified: branches/SAMBA_3_0/source/nsswitch/winbindd_pam.c\n===================================================================\n--- branches/SAMBA_3_0/source/nsswitch/winbindd_pam.c\t2007-05-06 21:23:40 UTC (rev 22719)\n+++ branches/SAMBA_3_0/source/nsswitch/winbindd_pam.c\t2007-05-06 21:26:01 UTC (rev 22720)\n@@ -1390,7 +1390,8 @@\n \t\t    NT_STATUS_EQUAL(result, NT_STATUS_IO_TIMEOUT) ||\n \t\t    NT_STATUS_EQUAL(result, NT_STATUS_DOMAIN_CONTROLLER_NOT_FOUND)) {\n \t\t\tDEBUG(10,(\"winbindd_dual_pam_auth_kerberos setting domain to offline\\n\"));\n-\t\t\tdomain->online = False;\n+\t\t\tset_domain_offline( domain );\n+\t\t\tgoto cached_logon;\t\t\t\n \t\t}\n \n \t\t/* there are quite some NT_STATUS errors where there is no\n@@ -1430,14 +1431,24 @@\n \t\t\t\tinfo3->user_flgs |= LOGON_KRB5_FAIL_CLOCK_SKEW;\t\t\t\t\n \t\t\t}\n \t\t\tgoto process_result;\n-\t\t} else {\n-\t\t\tDEBUG(10,(\"winbindd_dual_pam_auth_samlogon failed: %s\\n\", nt_errstr(result)));\n+\t\t} \n+\n+       \t\tDEBUG(10,(\"winbindd_dual_pam_auth_samlogon failed: %s\\n\", \n+\t\t\t  nt_errstr(result)));\n+\n+\t\tif (NT_STATUS_EQUAL(result, NT_STATUS_NO_LOGON_SERVERS) ||\n+\t\t    NT_STATUS_EQUAL(result, NT_STATUS_IO_TIMEOUT) ||\n+\t\t    NT_STATUS_EQUAL(result, NT_STATUS_DOMAIN_CONTROLLER_NOT_FOUND)) \n+\t\t{\n+\t\t\tDEBUG(10,(\"winbindd_dual_pam_auth_samlogon setting domain to offline\\n\"));\n+\t\t\tset_domain_offline( domain );\n+\t\t\tgoto cached_logon;\t\t\t\n+\t\t}\n+\n \t\t\tif (domain->online) {\n \t\t\t\t/* We're still online - fail. */\n \t\t\t\tgoto done;\n \t\t\t}\n-\t\t\t/* Else drop through and see if we can check offline.... */\n-\t\t}\n \t}\n \n cached_logon:\n@@ -1472,9 +1483,16 @@\n \t\tnetsamlogon_cache_store(name_user, info3);\n \t\twcache_invalidate_samlogon(find_domain_from_name(name_domain), info3);\n \n-\t\t/* save name_to_sid info as early as possible */\n-\t\tsid_compose(&user_sid, &info3->dom_sid.sid, info3->user_rid);\n-\t\tcache_name2sid(domain, name_domain, name_user, SID_NAME_USER, &user_sid);\n+\t\t/* save name_to_sid info as early as possible (only if\n+\t\t   this is our primary domain so we don't invalidate\n+\t\t   the cache entry by storing the seq_num for the wrong\n+\t\t   domain). */\n+\t\tif ( domain->primary ) {\t\t\t\n+\t\t\tsid_compose(&user_sid, &info3->dom_sid.sid, \n+\t\t\t\t    info3->user_rid);\n+\t\t\tcache_name2sid(domain, name_domain, name_user, \n+\t\t\t\t       SID_NAME_USER, &user_sid);\n+\t\t}\n \t\t\n \t\t/* Check if the user is in the right group */\n \n\nModified: branches/SAMBA_3_0_26/source/nsswitch/winbindd_pam.c\n===================================================================\n--- branches/SAMBA_3_0_26/source/nsswitch/winbindd_pam.c\t2007-05-06 21:23:40 UTC (rev 22719)\n+++ branches/SAMBA_3_0_26/source/nsswitch/winbindd_pam.c\t2007-05-06 21:26:01 UTC (rev 22720)\n@@ -1390,7 +1390,8 @@\n \t\t    NT_STATUS_EQUAL(result, NT_STATUS_IO_TIMEOUT) ||\n \t\t    NT_STATUS_EQUAL(result, NT_STATUS_DOMAIN_CONTROLLER_NOT_FOUND)) {\n \t\t\tDEBUG(10,(\"winbindd_dual_pam_auth_kerberos setting domain to offline\\n\"));\n-\t\t\tdomain->online = False;\n+\t\t\tset_domain_offline( domain );\n+\t\t\tgoto cached_logon;\t\t\t\n \t\t}\n \n \t\t/* there are quite some NT_STATUS errors where there is no\n@@ -1430,14 +1431,24 @@\n \t\t\t\tinfo3->user_flgs |= LOGON_KRB5_FAIL_CLOCK_SKEW;\t\t\t\t\n \t\t\t}\n \t\t\tgoto process_result;\n-\t\t} else {\n-\t\t\tDEBUG(10,(\"winbindd_dual_pam_auth_samlogon failed: %s\\n\", nt_errstr(result)));\n+\t\t} \n+\n+       \t\tDEBUG(10,(\"winbindd_dual_pam_auth_samlogon failed: %s\\n\", \n+\t\t\t  nt_errstr(result)));\n+\n+\t\tif (NT_STATUS_EQUAL(result, NT_STATUS_NO_LOGON_SERVERS) ||\n+\t\t    NT_STATUS_EQUAL(result, NT_STATUS_IO_TIMEOUT) ||\n+\t\t    NT_STATUS_EQUAL(result, NT_STATUS_DOMAIN_CONTROLLER_NOT_FOUND)) \n+\t\t{\n+\t\t\tDEBUG(10,(\"winbindd_dual_pam_auth_samlogon setting domain to offline\\n\"));\n+\t\t\tset_domain_offline( domain );\n+\t\t\tgoto cached_logon;\t\t\t\n+\t\t}\n+\n \t\t\tif (domain->online) {\n \t\t\t\t/* We're still online - fail. */\n \t\t\t\tgoto done;\n \t\t\t}\n-\t\t\t/* Else drop through and see if we can check offline.... */\n-\t\t}\n \t}\n \n cached_logon:\n@@ -1472,9 +1483,16 @@\n \t\tnetsamlogon_cache_store(name_user, info3);\n \t\twcache_invalidate_samlogon(find_domain_from_name(name_domain), info3);\n \n-\t\t/* save name_to_sid info as early as possible */\n-\t\tsid_compose(&user_sid, &info3->dom_sid.sid, info3->user_rid);\n-\t\tcache_name2sid(domain, name_domain, name_user, SID_NAME_USER, &user_sid);\n+\t\t/* save name_to_sid info as early as possible (only if\n+\t\t   this is our primary domain so we don't invalidate\n+\t\t   the cache entry by storing the seq_num for the wrong\n+\t\t   domain). */\n+\t\tif ( domain->primary ) {\t\t\t\n+\t\t\tsid_compose(&user_sid, &info3->dom_sid.sid, \n+\t\t\t\t    info3->user_rid);\n+\t\t\tcache_name2sid(domain, name_domain, name_user, \n+\t\t\t\t       SID_NAME_USER, &user_sid);\n+\t\t}\n \t\t\n \t\t/* Check if the user is in the right group */\n \n\n"}