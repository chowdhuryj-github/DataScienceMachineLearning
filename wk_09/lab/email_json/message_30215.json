{"category": "ham", "to_address": "samba-cvs@samba.org", "from_address": "gd@samba.org", "subject": "svn commit: samba r22903 - in branches: SAMBA_3_0/source/nsswitch\n\tSAMBA_3_0_26/source/nsswitch", "body": "Author: gd\nDate: 2007-05-15 13:46:26 +0000 (Tue, 15 May 2007)\nNew Revision: 22903\n\nWebSVN: http://websvn.samba.org/cgi-bin/viewcvs.cgi?view=rev&root=samba&rev=22903\n\nLog:\nNow that we have the on-disc trustdomaincache with type flags we can better\ndecide whether it's worth to register a krb5 ticket gain handler while users\nlogon offline.\n\nGuenther\n\nModified:\n   branches/SAMBA_3_0/source/nsswitch/winbindd_pam.c\n   branches/SAMBA_3_0_26/source/nsswitch/winbindd_pam.c\n\n\nChangeset:\nModified: branches/SAMBA_3_0/source/nsswitch/winbindd_pam.c\n===================================================================\n--- branches/SAMBA_3_0/source/nsswitch/winbindd_pam.c\t2007-05-15 13:44:11 UTC (rev 22902)\n+++ branches/SAMBA_3_0/source/nsswitch/winbindd_pam.c\t2007-05-15 13:46:26 UTC (rev 22903)\n@@ -784,6 +784,9 @@\n \tNET_USER_INFO_3 *my_info3;\n \ttime_t kickoff_time, must_change_time;\n \tBOOL password_good = False;\n+#ifdef HAVE_KRB5\n+\tstruct winbindd_tdc_domain *tdc_domain = NULL;\n+#endif\n \n \t*info3 = NULL;\n \n@@ -894,9 +897,9 @@\n \t\t}\n \t\n #ifdef HAVE_KRB5\n-\t\t/* FIXME: what else points out that the remote domain is AD ? */\n-\t\tif (!strequal(domain->name, domain->alt_name) &&\n-\t\t    (state->request.flags & WBFLAG_PAM_KRB5)) {\n+\t\tif ((state->request.flags & WBFLAG_PAM_KRB5) &&\n+\t\t    ((tdc_domain = wcache_tdc_fetch_domain(state->mem_ctx, name_domain)) != NULL) &&\n+\t\t    (tdc_domain->trust_type & DS_DOMAIN_TRUST_TYPE_UPLEVEL)) {\n \n \t\t\tuid_t uid = -1;\n \t\t\tconst char *cc = NULL;\n\nModified: branches/SAMBA_3_0_26/source/nsswitch/winbindd_pam.c\n===================================================================\n--- branches/SAMBA_3_0_26/source/nsswitch/winbindd_pam.c\t2007-05-15 13:44:11 UTC (rev 22902)\n+++ branches/SAMBA_3_0_26/source/nsswitch/winbindd_pam.c\t2007-05-15 13:46:26 UTC (rev 22903)\n@@ -812,6 +812,9 @@\n \tNET_USER_INFO_3 *my_info3;\n \ttime_t kickoff_time, must_change_time;\n \tBOOL password_good = False;\n+#ifdef HAVE_KRB5\n+\tstruct winbindd_tdc_domain *tdc_domain = NULL;\n+#endif\n \n \t*info3 = NULL;\n \n@@ -922,9 +925,9 @@\n \t\t}\n \t\n #ifdef HAVE_KRB5\n-\t\t/* FIXME: what else points out that the remote domain is AD ? */\n-\t\tif (!strequal(domain->name, domain->alt_name) &&\n-\t\t    (state->request.flags & WBFLAG_PAM_KRB5)) {\n+\t\tif ((state->request.flags & WBFLAG_PAM_KRB5) &&\n+\t\t    ((tdc_domain = wcache_tdc_fetch_domain(state->mem_ctx, name_domain)) != NULL) &&\n+\t\t    (tdc_domain->trust_type & DS_DOMAIN_TRUST_TYPE_UPLEVEL)) {\n \n \t\t\tuid_t uid = -1;\n \t\t\tconst char *cc = NULL;\n\n"}