{"category": "ham", "to_address": "samba-cvs@samba.org", "from_address": "vlendec@samba.org", "subject": "svn commit: samba r23661 - in branches: SAMBA_3_0/source/rpc_server\n\tSAMBA_3_0_26/source/rpc_server", "body": "Author: vlendec\nDate: 2007-06-29 17:40:37 +0000 (Fri, 29 Jun 2007)\nNew Revision: 23661\n\nWebSVN: http://websvn.samba.org/cgi-bin/viewcvs.cgi?view=rev&root=samba&rev=23661\n\nLog:\nAnother static pstring\nModified:\n   branches/SAMBA_3_0/source/rpc_server/srv_ntsvcs_nt.c\n   branches/SAMBA_3_0_26/source/rpc_server/srv_ntsvcs_nt.c\n\n\nChangeset:\nModified: branches/SAMBA_3_0/source/rpc_server/srv_ntsvcs_nt.c\n===================================================================\n--- branches/SAMBA_3_0/source/rpc_server/srv_ntsvcs_nt.c\t2007-06-29 17:27:59 UTC (rev 23660)\n+++ branches/SAMBA_3_0/source/rpc_server/srv_ntsvcs_nt.c\t2007-06-29 17:40:37 UTC (rev 23661)\n@@ -27,13 +27,9 @@\n /********************************************************************\n ********************************************************************/\n \n-static char* get_device_path( const char *device )\n+static char* get_device_path(TALLOC_CTX *mem_ctx, const char *device )\n {\n-\tstatic pstring path;\n-\n-\tpstr_sprintf( path, \"ROOT\\\\Legacy_%s\\\\0000\", device );\n-\n-\treturn path;\n+\treturn talloc_asprintf(mem_ctx, \"ROOT\\\\Legacy_%s\\\\0000\", device);\n }\n \n /********************************************************************\n@@ -52,16 +48,21 @@\n WERROR _ntsvcs_get_device_list_size( pipes_struct *p, NTSVCS_Q_GET_DEVICE_LIST_SIZE *q_u, NTSVCS_R_GET_DEVICE_LIST_SIZE *r_u )\n {\n \tfstring device;\n-\tconst char *devicepath;\n+\tchar *devicepath;\n \n \tif ( !q_u->devicename )\n \t\treturn WERR_ACCESS_DENIED;\n \n \trpcstr_pull(device, q_u->devicename->buffer, sizeof(device), q_u->devicename->uni_str_len*2, 0);\n-\tdevicepath = get_device_path( device );\n \n+\tif (!(devicepath = get_device_path(p->mem_ctx, device))) {\n+\t\treturn WERR_NOMEM;\n+\t}\n+\n \tr_u->size = strlen(devicepath) + 2;\n \n+\tTALLOC_FREE(devicepath);\n+\n \treturn WERR_OK;\n }\n \n@@ -72,17 +73,21 @@\n WERROR _ntsvcs_get_device_list( pipes_struct *p, NTSVCS_Q_GET_DEVICE_LIST *q_u, NTSVCS_R_GET_DEVICE_LIST *r_u )\n {\n \tfstring device;\n-\tconst char *devicepath;\n+\tchar *devicepath;\n \n \tif ( !q_u->devicename )\n \t\treturn WERR_ACCESS_DENIED;\n \n \trpcstr_pull(device, q_u->devicename->buffer, sizeof(device), q_u->devicename->uni_str_len*2, 0);\n-\tdevicepath = get_device_path( device );\n \n+\tif (!(devicepath = get_device_path(p->mem_ctx, device))) {\n+\t\treturn WERR_NOMEM;\n+\t}\n+\n \t/* This has to be DOUBLE NULL terminated */\n \n \tinit_unistr2( &r_u->devicepath, devicepath, UNI_STR_DBLTERMINATE );\n+\tTALLOC_FREE(devicepath);\n \tr_u->needed = r_u->devicepath.uni_str_len;\n \n \treturn WERR_OK;\n\nModified: branches/SAMBA_3_0_26/source/rpc_server/srv_ntsvcs_nt.c\n===================================================================\n--- branches/SAMBA_3_0_26/source/rpc_server/srv_ntsvcs_nt.c\t2007-06-29 17:27:59 UTC (rev 23660)\n+++ branches/SAMBA_3_0_26/source/rpc_server/srv_ntsvcs_nt.c\t2007-06-29 17:40:37 UTC (rev 23661)\n@@ -27,13 +27,9 @@\n /********************************************************************\n ********************************************************************/\n \n-static char* get_device_path( const char *device )\n+static char* get_device_path(TALLOC_CTX *mem_ctx, const char *device )\n {\n-\tstatic pstring path;\n-\n-\tpstr_sprintf( path, \"ROOT\\\\Legacy_%s\\\\0000\", device );\n-\n-\treturn path;\n+\treturn talloc_asprintf(mem_ctx, \"ROOT\\\\Legacy_%s\\\\0000\", device);\n }\n \n /********************************************************************\n@@ -52,16 +48,21 @@\n WERROR _ntsvcs_get_device_list_size( pipes_struct *p, NTSVCS_Q_GET_DEVICE_LIST_SIZE *q_u, NTSVCS_R_GET_DEVICE_LIST_SIZE *r_u )\n {\n \tfstring device;\n-\tconst char *devicepath;\n+\tchar *devicepath;\n \n \tif ( !q_u->devicename )\n \t\treturn WERR_ACCESS_DENIED;\n \n \trpcstr_pull(device, q_u->devicename->buffer, sizeof(device), q_u->devicename->uni_str_len*2, 0);\n-\tdevicepath = get_device_path( device );\n \n+\tif (!(devicepath = get_device_path(p->mem_ctx, device))) {\n+\t\treturn WERR_NOMEM;\n+\t}\n+\n \tr_u->size = strlen(devicepath) + 2;\n \n+\tTALLOC_FREE(devicepath);\n+\n \treturn WERR_OK;\n }\n \n@@ -72,17 +73,21 @@\n WERROR _ntsvcs_get_device_list( pipes_struct *p, NTSVCS_Q_GET_DEVICE_LIST *q_u, NTSVCS_R_GET_DEVICE_LIST *r_u )\n {\n \tfstring device;\n-\tconst char *devicepath;\n+\tchar *devicepath;\n \n \tif ( !q_u->devicename )\n \t\treturn WERR_ACCESS_DENIED;\n \n \trpcstr_pull(device, q_u->devicename->buffer, sizeof(device), q_u->devicename->uni_str_len*2, 0);\n-\tdevicepath = get_device_path( device );\n \n+\tif (!(devicepath = get_device_path(p->mem_ctx, device))) {\n+\t\treturn WERR_NOMEM;\n+\t}\n+\n \t/* This has to be DOUBLE NULL terminated */\n \n \tinit_unistr2( &r_u->devicepath, devicepath, UNI_STR_DBLTERMINATE );\n+\tTALLOC_FREE(devicepath);\n \tr_u->needed = r_u->devicepath.uni_str_len;\n \n \treturn WERR_OK;\n\n"}