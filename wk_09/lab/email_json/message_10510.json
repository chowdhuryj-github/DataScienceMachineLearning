{"category": "ham", "to_address": "samba-cvs@samba.org", "from_address": "herb@samba.org", "subject": "svn commit: samba r22395 - in branches: SAMBA_3_0/source/profile\n\tSAMBA_3_0/source/smbd SAMBA_3_0_25/source/profile\n\tSAMBA_3_0_25/source/smbd", "body": "Author: herb\nDate: 2007-04-20 01:52:44 +0000 (Fri, 20 Apr 2007)\nNew Revision: 22395\n\nWebSVN: http://websvn.samba.org/cgi-bin/viewcvs.cgi?view=rev&root=samba&rev=22395\n\nLog:\nallow profiling level to be set on startup\n\nModified:\n   branches/SAMBA_3_0/source/profile/profile.c\n   branches/SAMBA_3_0/source/smbd/server.c\n   branches/SAMBA_3_0_25/source/profile/profile.c\n   branches/SAMBA_3_0_25/source/smbd/server.c\n\n\nChangeset:\nModified: branches/SAMBA_3_0/source/profile/profile.c\n===================================================================\n--- branches/SAMBA_3_0/source/profile/profile.c\t2007-04-19 23:47:55 UTC (rev 22394)\n+++ branches/SAMBA_3_0/source/profile/profile.c\t2007-04-20 01:52:44 UTC (rev 22395)\n@@ -42,14 +42,10 @@\n BOOL do_profile_times = False;\n \n /****************************************************************************\n-receive a set profile level message\n+Set a profiling level.\n ****************************************************************************/\n-void profile_message(int msg_type, struct process_id src,\n-\t\t     void *buf, size_t len, void *private_data)\n+void set_profile_level(int level, struct process_id src)\n {\n-        int level;\n-\n-\tmemcpy(&level, buf, sizeof(int));\n #ifdef WITH_PROFILE\n \tswitch (level) {\n \tcase 0:\t\t/* turn off profiling */\n@@ -95,6 +91,17 @@\n }\n \n /****************************************************************************\n+receive a set profile level message\n+****************************************************************************/\n+void profile_message(int msg_type, struct process_id src, void *buf, size_t len, void *private_data)\n+{\n+        int level;\n+\n+\tmemcpy(&level, buf, sizeof(int));\n+\tset_profile_level(level, src);\n+}\n+\n+/****************************************************************************\n receive a request profile level message\n ****************************************************************************/\n void reqprofile_message(int msg_type, struct process_id src,\n\nModified: branches/SAMBA_3_0/source/smbd/server.c\n===================================================================\n--- branches/SAMBA_3_0/source/smbd/server.c\t2007-04-19 23:47:55 UTC (rev 22394)\n+++ branches/SAMBA_3_0/source/smbd/server.c\t2007-04-20 01:52:44 UTC (rev 22395)\n@@ -863,6 +863,7 @@\n \tstatic BOOL no_process_group = False;\n \tstatic BOOL log_stdout = False;\n \tstatic char *ports = NULL;\n+\tstatic char *profile_level = NULL;\n \tint opt;\n \tpoptContext pc;\n \n@@ -875,6 +876,7 @@\n \t{\"log-stdout\", 'S', POPT_ARG_VAL, &log_stdout, True, \"Log to stdout\" },\n \t{\"build-options\", 'b', POPT_ARG_NONE, NULL, 'b', \"Print build options\" },\n \t{\"port\", 'p', POPT_ARG_STRING, &ports, 0, \"Listen on the specified ports\"},\n+\t{\"profiling-level\", 'P', POPT_ARG_STRING, &profile_level, 0, \"Set profiling level\",\"PROFILE_LEVEL\"},\n \tPOPT_COMMON_SAMBA\n \tPOPT_COMMON_DYNCONFIG\n \tPOPT_TABLEEND\n@@ -997,6 +999,14 @@\n \t\tDEBUG(0,(\"ERROR: failed to setup profiling\\n\"));\n \t\treturn -1;\n \t}\n+\tif (profile_level != NULL) {\n+\t\tint pl = atoi(profile_level);\n+\t\tstruct process_id src;\n+\n+\t\tDEBUG(1, (\"setting profiling level: %s\\n\",profile_level));\n+\t\tsrc.pid = getpid();\n+\t\tset_profile_level(pl, src);\n+\t}\n #endif\n \n \tDEBUG(3,( \"loaded services\\n\"));\n\nModified: branches/SAMBA_3_0_25/source/profile/profile.c\n===================================================================\n--- branches/SAMBA_3_0_25/source/profile/profile.c\t2007-04-19 23:47:55 UTC (rev 22394)\n+++ branches/SAMBA_3_0_25/source/profile/profile.c\t2007-04-20 01:52:44 UTC (rev 22395)\n@@ -42,13 +42,10 @@\n BOOL do_profile_times = False;\n \n /****************************************************************************\n-receive a set profile level message\n+Set a profiling level.\n ****************************************************************************/\n-void profile_message(int msg_type, struct process_id src, void *buf, size_t len, void *private_data)\n+void set_profile_level(int level, struct process_id src)\n {\n-        int level;\n-\n-\tmemcpy(&level, buf, sizeof(int));\n #ifdef WITH_PROFILE\n \tswitch (level) {\n \tcase 0:\t\t/* turn off profiling */\n@@ -94,6 +91,17 @@\n }\n \n /****************************************************************************\n+receive a set profile level message\n+****************************************************************************/\n+void profile_message(int msg_type, struct process_id src, void *buf, size_t len, void *private_data)\n+{\n+        int level;\n+\n+\tmemcpy(&level, buf, sizeof(int));\n+\tset_profile_level(level, src);\n+}\n+\n+/****************************************************************************\n receive a request profile level message\n ****************************************************************************/\n void reqprofile_message(int msg_type, struct process_id src,\n\nModified: branches/SAMBA_3_0_25/source/smbd/server.c\n===================================================================\n--- branches/SAMBA_3_0_25/source/smbd/server.c\t2007-04-19 23:47:55 UTC (rev 22394)\n+++ branches/SAMBA_3_0_25/source/smbd/server.c\t2007-04-20 01:52:44 UTC (rev 22395)\n@@ -833,6 +833,7 @@\n \tstatic BOOL no_process_group = False;\n \tstatic BOOL log_stdout = False;\n \tstatic char *ports = NULL;\n+\tstatic char *profile_level = NULL;\n \tint opt;\n \tpoptContext pc;\n \n@@ -845,6 +846,7 @@\n \t{\"log-stdout\", 'S', POPT_ARG_VAL, &log_stdout, True, \"Log to stdout\" },\n \t{\"build-options\", 'b', POPT_ARG_NONE, NULL, 'b', \"Print build options\" },\n \t{\"port\", 'p', POPT_ARG_STRING, &ports, 0, \"Listen on the specified ports\"},\n+\t{\"profiling-level\", 'P', POPT_ARG_STRING, &profile_level, 0, \"Set profiling level\",\"PROFILE_LEVEL\"},\n \tPOPT_COMMON_SAMBA\n \tPOPT_COMMON_DYNCONFIG\n \tPOPT_TABLEEND\n@@ -967,6 +969,14 @@\n \t\tDEBUG(0,(\"ERROR: failed to setup profiling\\n\"));\n \t\treturn -1;\n \t}\n+\tif (profile_level != NULL) {\n+\t\tint pl = atoi(profile_level);\n+\t\tstruct process_id src;\n+\n+\t\tDEBUG(1, (\"setting profiling level: %s\\n\",profile_level));\n+\t\tsrc.pid = getpid();\n+\t\tset_profile_level(pl, src);\n+\t}\n #endif\n \n \tDEBUG(3,( \"loaded services\\n\"));\n\n"}