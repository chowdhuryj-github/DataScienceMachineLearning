{"category": "ham", "to_address": "samba-cvs@samba.org", "from_address": "vlendec@samba.org", "subject": "svn commit: samba r23241 - in branches: SAMBA_3_0/source/smbd\n\tSAMBA_3_0_26/source/smbd", "body": "Author: vlendec\nDate: 2007-05-30 13:41:38 +0000 (Wed, 30 May 2007)\nNew Revision: 23241\n\nWebSVN: http://websvn.samba.org/cgi-bin/viewcvs.cgi?view=rev&root=samba&rev=23241\n\nLog:\nIn preparation for the cluster messaging import the parent smbd needs to\nrespond to events.c style events.\n\nModified:\n   branches/SAMBA_3_0/source/smbd/server.c\n   branches/SAMBA_3_0_26/source/smbd/server.c\n\n\nChangeset:\nModified: branches/SAMBA_3_0/source/smbd/server.c\n===================================================================\n--- branches/SAMBA_3_0/source/smbd/server.c\t2007-05-30 10:24:40 UTC (rev 23240)\n+++ branches/SAMBA_3_0/source/smbd/server.c\t2007-05-30 13:41:38 UTC (rev 23241)\n@@ -386,7 +386,8 @@\n \t   for each incoming connection */\n \tDEBUG(2,(\"waiting for a connection\\n\"));\n \twhile (1) {\n-\t\tfd_set lfds;\n+\t\tstruct timeval now;\n+\t\tfd_set r_fds, w_fds;\n \t\tint num;\n \t\t\n \t\t/* Free up temporary memory from the main smbd. */\n@@ -404,13 +405,21 @@\n \t\t\t}\n \t\t}\n \n-\t\tmemcpy((char *)&lfds, (char *)&listen_set, \n+\t\tmemcpy((char *)&r_fds, (char *)&listen_set, \n \t\t       sizeof(listen_set));\n+\t\tFD_ZERO(&w_fds);\n+\t\tGetTimeOfDay(&now);\n \n-\t\tnum = sys_select(maxfd+1,&lfds,NULL,NULL,\n+\t\tevent_add_to_select_args(smbd_event_context(), &now,\n+\t\t\t\t\t &r_fds, &w_fds, &idle_timeout,\n+\t\t\t\t\t &maxfd);\n+\n+\t\tnum = sys_select(maxfd+1,&r_fds,&w_fds,NULL,\n \t\t\t\t timeval_is_zero(&idle_timeout) ?\n \t\t\t\t NULL : &idle_timeout);\n \t\t\n+\t\trun_events(smbd_event_context(), num, &r_fds, &w_fds);\n+\n \t\tif (num == -1 && errno == EINTR) {\n \t\t\tif (got_sig_term) {\n \t\t\t\texit_server_cleanly(NULL);\n@@ -427,6 +436,10 @@\n \t\t\tcontinue;\n \t\t}\n \n+#if 0\n+\t\tDeactivated for now, this needs to become a timed event\n+\t\tvl\n+\n \t\t/* If the idle timeout fired and we don't have any connected\n \t\t * users, exit gracefully. We should be running under a process\n \t\t * controller that will restart us if necessry.\n@@ -434,6 +447,7 @@\n \t\tif (num == 0 && count_all_current_connections() == 0) {\n \t\t\texit_server_cleanly(\"idle timeout\");\n \t\t}\n+#endif\n \n \t\t/* check if we need to reload services */\n \t\tcheck_reload(time(NULL));\n@@ -447,11 +461,11 @@\n \n \t\t\ts = -1;\n \t\t\tfor(i = 0; i < num_sockets; i++) {\n-\t\t\t\tif(FD_ISSET(fd_listenset[i],&lfds)) {\n+\t\t\t\tif(FD_ISSET(fd_listenset[i],&r_fds)) {\n \t\t\t\t\ts = fd_listenset[i];\n \t\t\t\t\t/* Clear this so we don't look\n \t\t\t\t\t   at it again. */\n-\t\t\t\t\tFD_CLR(fd_listenset[i],&lfds);\n+\t\t\t\t\tFD_CLR(fd_listenset[i],&r_fds);\n \t\t\t\t\tbreak;\n \t\t\t\t}\n \t\t\t}\n\nModified: branches/SAMBA_3_0_26/source/smbd/server.c\n===================================================================\n--- branches/SAMBA_3_0_26/source/smbd/server.c\t2007-05-30 10:24:40 UTC (rev 23240)\n+++ branches/SAMBA_3_0_26/source/smbd/server.c\t2007-05-30 13:41:38 UTC (rev 23241)\n@@ -482,7 +482,8 @@\n \t   for each incoming connection */\n \tDEBUG(2,(\"waiting for a connection\\n\"));\n \twhile (1) {\n-\t\tfd_set lfds;\n+\t\tstruct timeval now, idle_timeout;\n+\t\tfd_set r_fds, w_fds;\n \t\tint num;\n \t\t\n \t\t/* Free up temporary memory from the main smbd. */\n@@ -500,11 +501,23 @@\n \t\t\t}\n \t\t}\n \n-\t\tmemcpy((char *)&lfds, (char *)&listen_set, \n+\t\tidle_timeout = timeval_zero();\n+\n+\t\tmemcpy((char *)&r_fds, (char *)&listen_set, \n \t\t       sizeof(listen_set));\n-\t\t\n-\t\tnum = sys_select(maxfd+1,&lfds,NULL,NULL,NULL);\n-\t\t\n+\t\tFD_ZERO(&w_fds);\n+\t\tGetTimeOfDay(&now);\n+\n+\t\tevent_add_to_select_args(smbd_event_context(), &now,\n+\t\t\t\t\t &r_fds, &w_fds, &idle_timeout,\n+\t\t\t\t\t &maxfd);\n+\n+\t\tnum = sys_select(maxfd+1,&r_fds,&w_fds,NULL,\n+\t\t\t\t timeval_is_zero(&idle_timeout) ?\n+\t\t\t\t NULL : &idle_timeout);\n+\n+\t\trun_events(smbd_event_context(), num, &r_fds, &w_fds);\n+\n \t\tif (num == -1 && errno == EINTR) {\n \t\t\tif (got_sig_term) {\n \t\t\t\texit_server_cleanly(NULL);\n@@ -533,11 +546,11 @@\n \n \t\t\ts = -1;\n \t\t\tfor(i = 0; i < num_sockets; i++) {\n-\t\t\t\tif(FD_ISSET(fd_listenset[i],&lfds)) {\n+\t\t\t\tif(FD_ISSET(fd_listenset[i],&r_fds)) {\n \t\t\t\t\ts = fd_listenset[i];\n \t\t\t\t\t/* Clear this so we don't look\n \t\t\t\t\t   at it again. */\n-\t\t\t\t\tFD_CLR(fd_listenset[i],&lfds);\n+\t\t\t\t\tFD_CLR(fd_listenset[i],&r_fds);\n \t\t\t\t\tbreak;\n \t\t\t\t}\n \t\t\t}\n\n"}