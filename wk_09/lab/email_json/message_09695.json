{"category": "ham", "to_address": "samba-cvs@samba.org", "from_address": "tridge@samba.org", "subject": "Rev 166: fixed a bug found by volker - initialse the record on disk\n\twhen initialised in memory in http://samba.org/~tridge/ctdb", "body": "------------------------------------------------------------\nrevno: 166\nrevision-id: tridge@samba.org-20070419083149-bc28d74eb9e5df7b\nparent: tridge@samba.org-20070419074327-cdc474844a1e1d90\ncommitter: Andrew Tridgell \nbranch nick: tridge\ntimestamp: Thu 2007-04-19 18:31:49 +1000\nmessage:\n  fixed a bug found by volker - initialse the record on disk when initialised in memory\nmodified:\n  common/ctdb_ltdb.c             ctdb_ltdb.c-20061128065342-to93h6eejj5kon81-2\n=== modified file 'common/ctdb_ltdb.c'\n--- a/common/ctdb_ltdb.c\t2007-04-19 07:43:27 +0000\n+++ b/common/ctdb_ltdb.c\t2007-04-19 08:31:49 +0000\n@@ -156,13 +156,15 @@\n \n \trec = tdb_fetch(ctdb_db->ltdb->tdb, key);\n \tif (rec.dsize < sizeof(*header)) {\n+\t\tTDB_DATA d2;\n \t\t/* return an initial header */\n-\t\tfree(rec.dptr);\n+\t\tif (rec.dptr) free(rec.dptr);\n \t\tltdb_initial_header(ctdb_db, key, header);\n+\t\tZERO_STRUCT(d2);\n \t\tif (data) {\n-\t\t\tdata->dptr = NULL;\n-\t\t\tdata->dsize = 0;\n+\t\t\t*data = d2;\n \t\t}\n+\t\tctdb_ltdb_store(ctdb_db, key, header, d2);\n \t\treturn 0;\n \t}\n \n\n"}