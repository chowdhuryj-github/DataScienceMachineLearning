{"category": "ham", "to_address": "samba-cvs@samba.org", "from_address": "tridge@samba.org", "subject": "Rev 439: fixed a race condition in the handling of the recovery\n\tlock in http://samba.org/~tridge/ctdb", "body": "------------------------------------------------------------\nrevno: 439\nrevision-id: tridge@samba.org-20070603002914-oycc73iztdrrq6g9\nparent: tridge@samba.org-20070602094506-384lkqipi0x10k6c\ncommitter: Andrew Tridgell \nbranch nick: tridge\ntimestamp: Sun 2007-06-03 10:29:14 +1000\nmessage:\n  fixed a race condition in the handling of the recovery lock\nmodified:\n  common/ctdb_call.c             ctdb_call.c-20061128065342-to93h6eejj5kon81-1\n  common/ctdb_recover.c          ctdb_recover.c-20070503002147-admmfgt1oj6gexfo-1\n  common/ctdb_recoverd.c         recoverd.c-20070503213540-bvxuyd9jm1f7ig90-1\n=== modified file 'common/ctdb_call.c'\n--- a/common/ctdb_call.c\t2007-05-31 03:50:53 +0000\n+++ b/common/ctdb_call.c\t2007-06-03 00:29:14 +0000\n@@ -394,8 +394,9 @@\n \n \t/* its a protocol error if the sending node is not the current dmaster */\n \tif (header.dmaster != hdr->srcnode) {\n-\t\tDEBUG(0,(\"vnn %u dmaster request non-master %u dmaster=%u key %08x\\n\",\n-\t\t\t ctdb->vnn, hdr->srcnode, header.dmaster, ctdb_hash(&key)));\n+\t\tDEBUG(0,(\"vnn %u dmaster request non-master %u dmaster=%u key %08x dbid 0x%08x\\n\",\n+\t\t\t ctdb->vnn, hdr->srcnode, header.dmaster, ctdb_hash(&key),\n+\t\t\t ctdb_db->db_id));\n \t\tctdb_fatal(ctdb, \"ctdb_req_dmaster from non-master\");\n \t\treturn;\n \t}\n\n=== modified file 'common/ctdb_recover.c'\n--- a/common/ctdb_recover.c\t2007-06-02 03:16:11 +0000\n+++ b/common/ctdb_recover.c\t2007-06-03 00:29:14 +0000\n@@ -487,8 +487,8 @@\n \t/* we should not be able to get the lock on the nodes list, as it should be\n \t   held by the recovery master */\n \tif (ctdb_recovery_lock(ctdb, false)) {\n-\t\tDEBUG(0,(\"ERROR: node list not locked when recovering!\\n\"));\n-\t\tctdb_fatal(ctdb, \"node list not locked - make sure it is on shared storage\");\n+\t\tDEBUG(0,(\"ERROR: recovery lock file %s not locked when recovering!\\n\",\n+\t\t\t ctdb->recovery_lock_file));\n \t\treturn -1;\n \t}\t\n \n\n=== modified file 'common/ctdb_recoverd.c'\n--- a/common/ctdb_recoverd.c\t2007-06-02 01:36:42 +0000\n+++ b/common/ctdb_recoverd.c\t2007-06-03 00:29:14 +0000\n@@ -614,7 +614,8 @@\n \t}\n \n \t/* release the recmaster lock */\n-\tif (ctdb->recovery_lock_fd != -1) {\n+\tif (em->vnn != ctdb_get_vnn(ctdb) &&\n+\t    ctdb->recovery_lock_fd != -1) {\n \t\tclose(ctdb->recovery_lock_fd);\n \t\tctdb->recovery_lock_fd = -1;\n \t}\n\n"}