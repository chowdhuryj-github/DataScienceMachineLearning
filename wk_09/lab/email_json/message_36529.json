{"category": "ham", "to_address": "samba-cvs@samba.org", "from_address": "tridge@samba.org", "subject": "Rev 349: moved system specific ip code to system.c in\n\thttp://samba.org/~tridge/ctdb", "body": "------------------------------------------------------------\nrevno: 349\nrevision-id: tridge@samba.org-20070526040108-o5vdpfl6tel9ojku\nparent: tridge@samba.org-20070525142107-hy0e96coiupti95g\ncommitter: Andrew Tridgell \nbranch nick: tridge\ntimestamp: Sat 2007-05-26 14:01:08 +1000\nmessage:\n  moved system specific ip code to system.c\nmodified:\n  common/ctdb_recoverd.c         recoverd.c-20070503213540-bvxuyd9jm1f7ig90-1\n  include/ctdb_private.h         ctdb_private.h-20061117234101-o3qt14umlg9en8z0-13\n  takeover/ctdb_takeover.c       ctdb_takeover.c-20070525071636-a5n1ihghjtppy08r-2\n  takeover/system.c              system.c-20070525071636-a5n1ihghjtppy08r-3\n=== modified file 'common/ctdb_recoverd.c'\n--- a/common/ctdb_recoverd.c\t2007-05-25 14:05:30 +0000\n+++ b/common/ctdb_recoverd.c\t2007-05-26 04:01:08 +0000\n@@ -666,9 +666,10 @@\n \t\treturn;\n \t}\n \n-\t/* wait for one second to collect all responses */\n+\t/* wait for a few seconds to collect all responses */\n \ttimed_out = 0;\n-\tevent_add_timed(ctdb->ev, mem_ctx, CONTROL_TIMEOUT(), timeout_func, ctdb);\n+\tevent_add_timed(ctdb->ev, mem_ctx, timeval_current_ofs(3, 0), \n+\t\t\ttimeout_func, ctdb);\n \twhile (!timed_out) {\n \t\tevent_loop_once(ctdb->ev);\n \t}\n\n=== modified file 'include/ctdb_private.h'\n--- a/include/ctdb_private.h\t2007-05-25 11:27:26 +0000\n+++ b/include/ctdb_private.h\t2007-05-26 04:01:08 +0000\n@@ -894,6 +894,8 @@\n \n /* from takeover/system.c */\n int ctdb_sys_send_arp(const struct sockaddr_in *saddr, const char *iface);\n+int ctdb_sys_take_ip(const char *ip, const char *interface);\n+int ctdb_sys_release_ip(const char *ip, const char *interface);\n \n int ctdb_set_public_addresses(struct ctdb_context *ctdb, const char *alist);\n \n\n=== modified file 'takeover/ctdb_takeover.c'\n--- a/takeover/ctdb_takeover.c\t2007-05-25 14:21:07 +0000\n+++ b/takeover/ctdb_takeover.c\t2007-05-26 04:01:08 +0000\n@@ -73,16 +73,16 @@\n {\n \tint ret;\n \tstruct sockaddr_in *sin = (struct sockaddr_in *)indata.dptr;\n-\tchar *cmdstr;\n \tstruct ctdb_takeover_arp *arp;\n-\n-\tcmdstr = talloc_asprintf(ctdb, \"ip addr add %s/32 dev %s 2> /dev/null\",\n-\t\t\t\t inet_ntoa(sin->sin_addr), ctdb->takeover.interface);\n-\tCTDB_NO_MEMORY(ctdb, cmdstr);\n-\n-\tDEBUG(0,(\"Taking over IP : %s\\n\", cmdstr));\n-\tsystem(cmdstr);\n-\ttalloc_free(cmdstr);\n+\tchar *ip = inet_ntoa(sin->sin_addr);\n+\n+\tDEBUG(0,(\"Takover of IP %s on interface %s\\n\", ip, ctdb->takeover.interface));\n+\tret = ctdb_sys_take_ip(ip, ctdb->takeover.interface);\n+\tif (ret != 0) {\n+\t\tDEBUG(0,(__location__ \" Failed to takeover IP %s on interface %s\\n\",\n+\t\t\t ip, ctdb->takeover.interface));\n+\t\treturn -1;\n+\t}\n \n \tif (!ctdb->takeover.last_ctx) {\n \t\tctdb->takeover.last_ctx = talloc_new(ctdb);\n@@ -107,21 +107,22 @@\n int32_t ctdb_control_release_ip(struct ctdb_context *ctdb, TDB_DATA indata)\n {\n \tstruct sockaddr_in *sin = (struct sockaddr_in *)indata.dptr;\n-\tchar *cmdstr;\n \tTDB_DATA data;\n \tchar *ip = inet_ntoa(sin->sin_addr);\n+\tint ret;\n+\n+\tDEBUG(0,(\"Release of IP %s on interface %s\\n\", ip, ctdb->takeover.interface));\n \n \t/* stop any previous arps */\n \ttalloc_free(ctdb->takeover.last_ctx);\n \tctdb->takeover.last_ctx = NULL;\n \n-\tcmdstr = talloc_asprintf(ctdb, \"ip addr del %s/32 dev %s 2> /dev/null\",\n-\t\t\t\t ip, ctdb->takeover.interface);\n-\t\t\n-\tDEBUG(0,(\"Releasing IP : %s\\n\", cmdstr));\n-\tsystem(cmdstr);\n-\n-\ttalloc_free(cmdstr);\n+\tret = ctdb_sys_release_ip(ip, ctdb->takeover.interface);\n+\tif (ret != 0) {\n+\t\tDEBUG(0,(__location__ \" Failed to release IP %s on interface %s\\n\",\n+\t\t\t ip, ctdb->takeover.interface));\n+\t\treturn -1;\n+\t}\n \n \t/* send a message to all clients of this node telling them\n \t   that the cluster has been reconfigured and they should\n\n=== modified file 'takeover/system.c'\n--- a/takeover/system.c\t2007-05-25 07:16:50 +0000\n+++ b/takeover/system.c\t2007-05-26 04:01:08 +0000\n@@ -126,3 +126,35 @@\n \tclose(s);\n \treturn 0;\n }\n+\n+/*\n+  takeover an IP on an interface\n+ */\n+int ctdb_sys_take_ip(const char *ip, const char *interface)\n+{\n+\tchar *cmdstr;\n+\tcmdstr = talloc_asprintf(NULL, \"/sbin/ip addr add %s/32 dev %s 2> /dev/null\",\n+\t\t\t\t ip, interface);\n+\tif (cmdstr == NULL) {\n+\t\treturn -1;\n+\t}\n+\tsystem(cmdstr);\n+\ttalloc_free(cmdstr);\n+\treturn 0;\n+}\n+\n+/*\n+  release an IP on an interface\n+ */\n+int ctdb_sys_release_ip(const char *ip, const char *interface)\n+{\n+\tchar *cmdstr;\n+\tcmdstr = talloc_asprintf(NULL, \"/sbin/ip addr del %s/32 dev %s 2> /dev/null\",\n+\t\t\t\t ip, interface);\n+\tif (cmdstr == NULL) {\n+\t\treturn -1;\n+\t}\n+\tsystem(cmdstr);\n+\ttalloc_free(cmdstr);\n+\treturn 0;\n+}\n\n"}