{"category": "ham", "to_address": "samba-cvs@samba.org", "from_address": "abartlet@samba.org", "subject": "svn commit: samba r22161 - in\n\tbranches/SAMBA_4_0/source/script/tests: .", "body": "Author: abartlet\nDate: 2007-04-11 03:45:39 +0000 (Wed, 11 Apr 2007)\nNew Revision: 22161\n\nWebSVN: http://websvn.samba.org/cgi-bin/viewcvs.cgi?view=rev&root=samba&rev=22161\n\nLog:\nClarify exactly where the socket_wrapper should be handled (early),\nand ensure that $prefix exists before it tries to create $prefix/w.\n\nThis should fix the build farm.  Perhaps we should have a rm -rf\n$prefix at the start of this script, as that would have found the\nproblem, but I want to be careful about that...\n\nAndrew Bartlett\n\nModified:\n   branches/SAMBA_4_0/source/script/tests/Samba3.pm\n   branches/SAMBA_4_0/source/script/tests/Samba4.pm\n   branches/SAMBA_4_0/source/script/tests/selftest.pl\n\n\nChangeset:\nModified: branches/SAMBA_4_0/source/script/tests/Samba3.pm\n===================================================================\n--- branches/SAMBA_4_0/source/script/tests/Samba3.pm\t2007-04-11 01:32:38 UTC (rev 22160)\n+++ branches/SAMBA_4_0/source/script/tests/Samba3.pm\t2007-04-11 03:45:39 UTC (rev 22161)\n@@ -16,14 +16,11 @@\n \treturn $self;\n }\n \n-sub check_or_start($$$$) \n+sub check_or_start($$$) \n {\n-\tmy ($self, $env_vars, $socket_wrapper_dir, $max_time) = @_;\n+\tmy ($self, $env_vars, $max_time) = @_;\n \treturn 0 if ( -p $env_vars->{SMBD_TEST_FIFO});\n \n-\twarn(\"Not using socket wrapper, but also not running as root. Will not be able to listen on proper ports\") unless\n-\t\tdefined($socket_wrapper_dir) or $< == 0;\n-\n \tunlink($env_vars->{SMBD_TEST_FIFO});\n \tPOSIX::mkfifo($env_vars->{SMBD_TEST_FIFO}, 0700);\n \tunlink($env_vars->{SMBD_TEST_LOG});\n@@ -49,7 +46,6 @@\n \t\t\texit 1;\n \t\t}\n \t\tunlink($env_vars->{SMBD_TEST_FIFO});\n-\t\tunlink(<$socket_wrapper_dir/*>) if (defined($socket_wrapper_dir) and -d $socket_wrapper_dir);\n \t\tmy $exit = $? >> 8;\n \t\tif ( $ret == 0 ) {\n \t\t\tprint \"smbd exits with status $exit\\n\";\n@@ -121,9 +117,9 @@\n \treturn $failed;\n }\n \n-sub setup_env($$$)\n+sub setup_env($$)\n {\n-\tmy ($self, $name, $socket_wrapper_dir) = @_;\n+\tmy ($self, $name) = @_;\n }\n \n 1;\n\nModified: branches/SAMBA_4_0/source/script/tests/Samba4.pm\n===================================================================\n--- branches/SAMBA_4_0/source/script/tests/Samba4.pm\t2007-04-11 01:32:38 UTC (rev 22160)\n+++ branches/SAMBA_4_0/source/script/tests/Samba4.pm\t2007-04-11 03:45:39 UTC (rev 22161)\n@@ -58,9 +58,9 @@\n \t}\n }\n \n-sub check_or_start($$$$) \n+sub check_or_start($$$) \n {\n-\tmy ($self, $env_vars, $socket_wrapper_dir, $max_time) = @_;\n+\tmy ($self, $env_vars, $max_time) = @_;\n \treturn 0 if ( -p $env_vars->{SMBD_TEST_FIFO});\n \n \t# Start slapd before smbd\n@@ -99,7 +99,6 @@\n \t\t\texit 1;\n \t\t}\n \t\tunlink($env_vars->{SMBD_TEST_FIFO});\n-\t\tunlink(<$socket_wrapper_dir/*>) if (defined($socket_wrapper_dir) and -d $socket_wrapper_dir);\n \t\tmy $exit = $? >> 8;\n \t\tif ( $ret == 0 ) {\n \t\t\tprint \"smbd exits with status $exit\\n\";\n@@ -181,24 +180,24 @@\n \treturn $failed;\n }\n \n-sub setup_env($$$$)\n+sub setup_env($$$)\n {\n-\tmy ($self, $envname, $path, $socket_wrapper_dir) = @_;\n+\tmy ($self, $envname, $path) = @_;\n \t\n \tif ($envname eq \"dc\") {\n-\t\treturn $self->setup_dc(\"$path/dc\", $socket_wrapper_dir);\n+\t\treturn $self->setup_dc(\"$path/dc\");\n \t} else {\n \t\tdie(\"Samba4 can't provide environment $envname\");\n \t}\n }\n \n-sub setup_dc($$$)\n+sub setup_dc($$)\n {\n-\tmy ($self, $path, $socket_wrapper_dir) = @_;\n+\tmy ($self, $path) = @_;\n \n \tmy $env = $self->provision($path);\n \n-\t$self->check_or_start($env, $socket_wrapper_dir, \n+\t$self->check_or_start($env, \n \t\t($ENV{SMBD_MAX_TIME} or 5400));\n \n \t$self->wait_for_start($env);\n\nModified: branches/SAMBA_4_0/source/script/tests/selftest.pl\n===================================================================\n--- branches/SAMBA_4_0/source/script/tests/selftest.pl\t2007-04-11 01:32:38 UTC (rev 22160)\n+++ branches/SAMBA_4_0/source/script/tests/selftest.pl\t2007-04-11 03:45:39 UTC (rev 22161)\n@@ -371,6 +371,9 @@\n $ENV{PREFIX} = $prefix;\n $ENV{SRCDIR} = $srcdir;\n \n+#Ensure we have the test prefix around\n+mkdir $prefix unless -d $prefix;\n+\n my $tls_enabled = not $opt_quick;\n my $from_build_farm = (defined($ENV{RUN_FROM_BUILD_FARM}) and \n                       ($ENV{RUN_FROM_BUILD_FARM} eq \"yes\"));\n@@ -543,7 +546,7 @@\n \t} elsif ($envname eq \"none\") {\n \t\t$testenv_vars = {};\n \t} else {\n-\t\t$testenv_vars = $target->setup_env($envname, $prefix, $socket_wrapper_dir);\n+\t\t$testenv_vars = $target->setup_env($envname, $prefix);\n \t}\n \twrite_clientconf($conffile, $testenv_vars);\n \tforeach (\"PASSWORD\", \"DOMAIN\", \"SERVER\", \"USERNAME\", \"NETBIOSNAME\", \n\n"}