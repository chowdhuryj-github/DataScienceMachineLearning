{"category": "ham", "to_address": "samba-cvs@samba.org", "from_address": "tridge@samba.org", "subject": "Rev 364: when handing over an IP to another node,\n\talso tell them of any tcp connections we were handling,\n\tso they can send tickle acks for those connections in\n\thttp://samba.org/~tridge/ctdb", "body": "------------------------------------------------------------\nrevno: 364\nrevision-id: tridge@samba.org-20070527145110-4dwpd6btx287elvc\nparent: tridge@samba.org-20070527143440-4hr0qbiyrynndwos\ncommitter: Andrew Tridgell \nbranch nick: tridge\ntimestamp: Mon 2007-05-28 00:51:10 +1000\nmessage:\n  when handing over an IP to another node, also tell them of any tcp connections we were handling, so they can send tickle acks for those connections\nmodified:\n  takeover/ctdb_takeover.c       ctdb_takeover.c-20070525071636-a5n1ihghjtppy08r-2\n=== modified file 'takeover/ctdb_takeover.c'\n--- a/takeover/ctdb_takeover.c\t2007-05-27 14:34:40 +0000\n+++ b/takeover/ctdb_takeover.c\t2007-05-27 14:51:10 +0000\n@@ -68,7 +68,7 @@\n \t}\n \n \tfor (tcp=arp->tcp_list;tcp;tcp=tcp->next) {\n-\t\tDEBUG(0,(\"sending tcp tickle ack for %u->%s:%u\\n\",\n+\t\tDEBUG(2,(\"sending tcp tickle ack for %u->%s:%u\\n\",\n \t\t\t (unsigned)ntohs(tcp->daddr.sin_port), \n \t\t\t inet_ntoa(tcp->saddr.sin_addr),\n \t\t\t (unsigned)ntohs(tcp->saddr.sin_port)));\n@@ -152,6 +152,7 @@\n \tTDB_DATA data;\n \tchar *ip = inet_ntoa(sin->sin_addr);\n \tint ret;\n+\tstruct ctdb_tcp_list *tcp;\n \n \tif (!ctdb_sys_have_ip(ip)) {\n \t\treturn 0;\n@@ -178,6 +179,26 @@\n \n \tctdb_daemon_send_message(ctdb, ctdb->vnn, CTDB_SRVID_RELEASE_IP, data);\n \n+\t/* tell other nodes about any tcp connections we were holding with this IP */\n+\tfor (tcp=ctdb->tcp_list;tcp;tcp=tcp->next) {\n+\t\tif (tcp->vnn == ctdb->vnn && \n+\t\t    sin->sin_addr.s_addr == tcp->daddr.sin_addr.s_addr) {\n+\t\t\tstruct ctdb_control_tcp_vnn t;\n+\n+\t\t\tt.vnn  = ctdb->vnn;\n+\t\t\tt.src  = tcp->saddr;\n+\t\t\tt.dest = tcp->daddr;\n+\n+\t\t\tdata.dptr = (uint8_t *)&t\n+\t\t\tdata.dsize = sizeof(t);\n+\n+\t\t\tctdb_daemon_send_control(ctdb, CTDB_BROADCAST_VNNMAP, 0, \n+\t\t\t\t\t\t CTDB_CONTROL_TCP_ADD,\n+\t\t\t\t\t\t 0, CTDB_CTRL_FLAG_NOREPLY, data, NULL, NULL);\n+\t\t}\n+\t}\n+\n+\n \treturn 0;\n }\n \n\n"}