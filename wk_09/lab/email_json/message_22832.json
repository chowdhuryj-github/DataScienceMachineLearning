{"category": "ham", "to_address": "samba-cvs@samba.org", "from_address": "gd@samba.org", "subject": "svn commit: samba r22663 - in branches/SAMBA_3_0/source/libads: .", "body": "Author: gd\nDate: 2007-05-04 09:46:17 +0000 (Fri, 04 May 2007)\nNew Revision: 22663\n\nWebSVN: http://websvn.samba.org/cgi-bin/viewcvs.cgi?view=rev&root=samba&rev=22663\n\nLog:\nRestructure kerberos_kinit_password_ext() error path.\n\nGuenther\n\nModified:\n   branches/SAMBA_3_0/source/libads/kerberos.c\n\n\nChangeset:\nModified: branches/SAMBA_3_0/source/libads/kerberos.c\n===================================================================\n--- branches/SAMBA_3_0/source/libads/kerberos.c\t2007-05-04 09:35:01 UTC (rev 22662)\n+++ branches/SAMBA_3_0/source/libads/kerberos.c\t2007-05-04 09:46:17 UTC (rev 22663)\n@@ -73,14 +73,16 @@\n \tkrb5_context ctx = NULL;\n \tkrb5_error_code code = 0;\n \tkrb5_ccache cc = NULL;\n-\tkrb5_principal me;\n+\tkrb5_principal me = NULL;\n \tkrb5_creds my_creds;\n \tkrb5_get_init_creds_opt *opt = NULL;\n \tsmb_krb5_addresses *addr = NULL;\n \n+\tZERO_STRUCT(my_creds);\n+\n \tinitialize_krb5_error_table();\n \tif ((code = krb5_init_context(&ctx)))\n-\t\treturn code;\n+\t\tgoto out;\n \n \tif (time_offset != 0) {\n \t\tkrb5_set_real_time(ctx, time(NULL) + time_offset, 0);\n@@ -91,21 +93,15 @@\n \t\t\tgetenv(\"KRB5_CONFIG\")));\n \n \tif ((code = krb5_cc_resolve(ctx, cache_name ? cache_name : krb5_cc_default_name(ctx), &cc))) {\n-\t\tkrb5_free_context(ctx);\n-\t\treturn code;\n+\t\tgoto out;\n \t}\n \t\n \tif ((code = smb_krb5_parse_name(ctx, principal, &me))) {\n-\t\tkrb5_cc_close(ctx, cc);\n-\t\tkrb5_free_context(ctx);\t\n-\t\treturn code;\n+\t\tgoto out;\n \t}\n \n-\tcode = smb_krb5_get_init_creds_opt_alloc(ctx, &opt);\n-\tif (code) {\n-\t\tkrb5_cc_close(ctx, cc);\n-\t\tkrb5_free_context(ctx);\t\n-\t\treturn code;\n+\tif ((code = smb_krb5_get_init_creds_opt_alloc(ctx, &opt))) {\n+\t\tgoto out;\n \t}\n \n \tkrb5_get_init_creds_opt_set_renew_life(opt, renewable_time);\n@@ -117,55 +113,29 @@\n \n #ifdef HAVE_KRB5_GET_INIT_CREDS_OPT_SET_PAC_REQUEST\n \tif (request_pac) {\n-\t\tcode = krb5_get_init_creds_opt_set_pac_request(ctx, opt, (krb5_boolean)request_pac);\n-\t\tif (code) {\n-\t\t\tkrb5_cc_close(ctx, cc);\n-\t\t\tkrb5_free_principal(ctx, me);\n-\t\t\tkrb5_free_context(ctx);\n-\t\t\treturn code;\n+\t\tif ((code = krb5_get_init_creds_opt_set_pac_request(ctx, opt, (krb5_boolean)request_pac))) {\n+\t\t\tgoto out;\n \t\t}\n \t}\n #endif\n \tif (add_netbios_addr) {\n-\t\tcode = smb_krb5_gen_netbios_krb5_address(&addr);\n-\t\tif (code) {\n-\t\t\tkrb5_cc_close(ctx, cc);\n-\t\t\tkrb5_free_principal(ctx, me);\n-\t\t\tkrb5_free_context(ctx);\t\t\n-\t\t\treturn code;\t\n+\t\tif ((code = smb_krb5_gen_netbios_krb5_address(&addr))) {\n+\t\t\tgoto out;\n \t\t}\n \t\tkrb5_get_init_creds_opt_set_address_list(opt, addr->addrs);\n \t}\n \n \tif ((code = krb5_get_init_creds_password(ctx, &my_creds, me, CONST_DISCARD(char *,password), \n-\t\t\t\t\t\t kerb_prompter, NULL, 0, NULL, opt)))\n-\t{\n-\t\tsmb_krb5_get_init_creds_opt_free(ctx, opt);\n-\t\tsmb_krb5_free_addresses(ctx, addr);\n-\t\tkrb5_cc_close(ctx, cc);\n-\t\tkrb5_free_principal(ctx, me);\n-\t\tkrb5_free_context(ctx);\n-\t\treturn code;\n+\t\t\t\t\t\t kerb_prompter, NULL, 0, NULL, opt))) {\n+\t\tgoto out;\n \t}\n \n-\tsmb_krb5_get_init_creds_opt_free(ctx, opt);\n-\n \tif ((code = krb5_cc_initialize(ctx, cc, me))) {\n-\t\tsmb_krb5_free_addresses(ctx, addr);\n-\t\tkrb5_free_cred_contents(ctx, &my_creds);\n-\t\tkrb5_cc_close(ctx, cc);\n-\t\tkrb5_free_principal(ctx, me);\n-\t\tkrb5_free_context(ctx);\t\t\n-\t\treturn code;\n+\t\tgoto out;\n \t}\n \t\n \tif ((code = krb5_cc_store_cred(ctx, cc, &my_creds))) {\n-\t\tkrb5_cc_close(ctx, cc);\n-\t\tsmb_krb5_free_addresses(ctx, addr);\n-\t\tkrb5_free_cred_contents(ctx, &my_creds);\n-\t\tkrb5_free_principal(ctx, me);\n-\t\tkrb5_free_context(ctx);\t\t\n-\t\treturn code;\n+\t\tgoto out;\n \t}\n \n \tif (expire_time) {\n@@ -175,14 +145,24 @@\n \tif (renew_till_time) {\n \t\t*renew_till_time = (time_t) my_creds.times.renew_till;\n \t}\n-\n-\tkrb5_cc_close(ctx, cc);\n-\tsmb_krb5_free_addresses(ctx, addr);\n+ out:\n \tkrb5_free_cred_contents(ctx, &my_creds);\n-\tkrb5_free_principal(ctx, me);\n-\tkrb5_free_context(ctx);\t\t\n-\t\n-\treturn 0;\n+\tif (me) {\n+\t\tkrb5_free_principal(ctx, me);\n+\t}\n+\tif (addr) {\n+\t\tsmb_krb5_free_addresses(ctx, addr);\n+\t}\n+ \tif (opt) {\n+\t\tsmb_krb5_get_init_creds_opt_free(ctx, opt);\n+\t}\n+\tif (cc) {\n+\t\tkrb5_cc_close(ctx, cc);\n+\t}\n+\tif (ctx) {\n+\t\tkrb5_free_context(ctx);\n+\t}\n+\treturn code;\n }\n \n \n\n"}