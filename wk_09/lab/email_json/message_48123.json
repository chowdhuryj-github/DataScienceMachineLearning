{"category": "ham", "to_address": "samba-cvs@samba.org", "from_address": "jpeach@samba.org", "subject": "svn commit: samba r23502 - in branches/SAMBA_3_0/source/smbd: .", "body": "Author: jpeach\nDate: 2007-06-14 18:48:51 +0000 (Thu, 14 Jun 2007)\nNew Revision: 23502\n\nWebSVN: http://websvn.samba.org/cgi-bin/viewcvs.cgi?view=rev&root=samba&rev=23502\n\nLog:\n    Restore exit-on-idle.  Small refactoring for clarity. Exit if\n    we are idle and we timed out waiting for something to do.\n\nModified:\n   branches/SAMBA_3_0/source/smbd/server.c\n\n\nChangeset:\nModified: branches/SAMBA_3_0/source/smbd/server.c\n===================================================================\n--- branches/SAMBA_3_0/source/smbd/server.c\t2007-06-14 15:50:47 UTC (rev 23501)\n+++ branches/SAMBA_3_0/source/smbd/server.c\t2007-06-14 18:48:51 UTC (rev 23502)\n@@ -316,6 +316,16 @@\n }\n \n /****************************************************************************\n+ Are we idle enough that we could safely exit?\n+****************************************************************************/\n+\n+static BOOL smbd_is_idle(void)\n+{\n+\t/* Currently we define \"idle\" as having no client connections. */\n+\treturn count_all_current_connections() == 0;\n+}\n+\n+/****************************************************************************\n  Open the socket communication.\n ****************************************************************************/\n \n@@ -414,10 +424,22 @@\n \t\t\t\t\t &r_fds, &w_fds, &idle_timeout,\n \t\t\t\t\t &maxfd);\n \n-\t\tnum = sys_select(maxfd+1,&r_fds,&w_fds,NULL,\n-\t\t\t\t timeval_is_zero(&idle_timeout) ?\n-\t\t\t\t NULL : &idle_timeout);\n-\t\t\n+\t\tif (timeval_is_zero(&idle_timeout)) {\n+\t\t\tnum = sys_select(maxfd + 1, &r_fds, &w_fds,\n+\t\t\t\t\tNULL, NULL);\n+\t\t} else {\n+\t\t\tnum = sys_select(maxfd + 1, &r_fds, &w_fds,\n+\t\t\t\t\tNULL, &idle_timeout);\n+\n+\t\t\t/* If the idle timeout fired and we are idle, exit\n+\t\t\t * gracefully. We expect to be running under a process\n+\t\t\t * controller that will restart us if necessry.\n+\t\t\t */\n+\t\t\tif (num == 0 && smbd_is_idle()) {\n+\t\t\t\texit_server_cleanly(\"idle timeout\");\n+\t\t\t}\n+\t\t}\n+\n \t\tif (num == -1 && errno == EINTR) {\n \t\t\tif (got_sig_term) {\n \t\t\t\texit_server_cleanly(NULL);\n@@ -438,19 +460,6 @@\n \t\t\tcontinue;\n \t\t}\n \n-#if 0\n-\t\tDeactivated for now, this needs to become a timed event\n-\t\tvl\n-\n-\t\t/* If the idle timeout fired and we don't have any connected\n-\t\t * users, exit gracefully. We should be running under a process\n-\t\t * controller that will restart us if necessry.\n-\t\t */\n-\t\tif (num == 0 && count_all_current_connections() == 0) {\n-\t\t\texit_server_cleanly(\"idle timeout\");\n-\t\t}\n-#endif\n-\n \t\t/* check if we need to reload services */\n \t\tcheck_reload(time(NULL));\n \n\n"}