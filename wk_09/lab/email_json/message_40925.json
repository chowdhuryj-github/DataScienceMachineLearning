{"category": "ham", "to_address": "samba-cvs@samba.org", "from_address": "tridge@samba.org", "subject": "Rev 434: add an easy way to setup ctdb to start/stop samba in\n\thttp://samba.org/~tridge/ctdb", "body": "------------------------------------------------------------\nrevno: 434\nrevision-id: tridge@samba.org-20070602085105-lqk6s1tvj4fgn26b\nparent: tridge@samba.org-20070602080816-xkcs5l60md7prakr\ncommitter: Andrew Tridgell \nbranch nick: tridge\ntimestamp: Sat 2007-06-02 18:51:05 +1000\nmessage:\n  add an easy way to setup ctdb to start/stop samba\nmodified:\n  packaging/ctdb.init            ctdb.init-20070527204758-biuh7znabuwan3zn-6\n  tools/ctdb.sysconfig           ctdb.sysconfig-20070527204758-biuh7znabuwan3zn-7\n  tools/events.d/nfs             nfs-20070601141008-hy3h4qgbk1jd2jci-1\n  tools/events.d/samba           samba-20070601105340-vlcvnp6euoj3zdwy-3\n  tools/functions                functions-20070601105405-gajwirydr5a9zd6x-1\n=== modified file 'packaging/ctdb.init'\n--- a/packaging/ctdb.init\t2007-06-02 01:36:42 +0000\n+++ b/packaging/ctdb.init\t2007-06-02 08:51:05 +0000\n@@ -119,13 +119,17 @@\n   \trestart\n \t;;\n   status)\n-  \trhstatus\n+  \tstatus\n \t;;\n   condrestart)\n   \tctdb status > /dev/null && restart || :\n \t;;\n+  cron)\n+\t# used from cron to auto-restart ctdb\n+  \tctdb status > /dev/null || start\n+\t;;\n   *)\n-\techo $\"Usage: $0 {start|stop|restart|status|condrestart}\"\n+\techo $\"Usage: $0 {start|stop|restart|status|cron|condrestart}\"\n \texit 1\n esac\n \n\n=== modified file 'tools/ctdb.sysconfig'\n--- a/tools/ctdb.sysconfig\t2007-06-02 06:33:17 +0000\n+++ b/tools/ctdb.sysconfig\t2007-06-02 08:51:05 +0000\n@@ -5,6 +5,20 @@\n # there is no default\n # CTDB_RECOVERY_LOCK=\"/some/place/on/shared/storage\"\n \n+# should ctdb do IP takeover? If it should, then specify a file\n+# containing the list of public IP addresses that ctdb will manage\n+# Note that these IPs must be different from those in $NODES above\n+# there is no default\n+# PUBLIC_ADDRESSES=/etc/ctdb/public_addresses\n+\n+# when doing IP takeover you also must specify what network interface\n+# to use for the public addresses\n+# there is no default\n+# PUBLIC_INTERFACE=eth0\n+\n+# should ctdb manage starting/stopping the Samba service for you?\n+# default is to not manage Samba\n+# CTDB_MANAGES_SAMBA=yes\n \n # the NODES file must be specified or ctdb won't start\n # it should contain a list of IPs that ctdb will use\n@@ -29,17 +43,6 @@\n # defaults to tcp\n # TRANSPORT=\"tcp\"\n \n-# should ctdb do IP takeover? If it should, then specify a file\n-# containing the list of public IP addresses that ctdb will manage\n-# Note that these IPs must be different from those in $NODES above\n-# there is no default\n-# PUBLIC_ADDRESSES=/etc/ctdb/public_addresses\n-\n-# when doing IP takeover you also must specify what network interface\n-# to use for the public addresses\n-# there is no default\n-# PUBLIC_INTERFACE=eth0\n-\n # where to log messages\n # the default is /var/log/log.ctdb\n # LOGFILE=/var/log/log.ctdb\n\n=== modified file 'tools/events.d/nfs'\n--- a/tools/events.d/nfs\t2007-06-02 06:44:15 +0000\n+++ b/tools/events.d/nfs\t2007-06-02 08:51:05 +0000\n@@ -33,8 +33,8 @@\n         # restart NFS to ensure that all TCP connections to the released ip\n \t# are closed\n \t[ -f /etc/ctdb/state/nfs/restart ] && {\n-\t\t( /sbin/service nfs status > /dev/null 2>&1 && \n-                      /sbin/service nfs restart > /dev/null 2>&1 ) &\n+\t\t( service nfs status > /dev/null 2>&1 && \n+                      service nfs restart > /dev/null 2>&1 ) &\n \t} > /dev/null 2>&1\n \t/bin/rm -f /etc/ctdb/state/nfs/restart\n \t;;\n\n=== modified file 'tools/events.d/samba'\n--- a/tools/events.d/samba\t2007-06-01 14:10:22 +0000\n+++ b/tools/events.d/samba\t2007-06-02 08:51:05 +0000\n@@ -9,8 +9,14 @@\n cmd=\"$1\"\n shift\n \n+[ \"$CTDB_MANAGES_SAMBA\" = \"yes\" ] || exit 0\n+\n case $cmd in \n      startup)\n+\t# start Samba service\n+\tservice smb start\n+\tservice winbind start\n+\n \t# wait for the Samba tcp ports to become available\n \tsmb_ports=`testparm -stv 2> /dev/null | egrep '\\s*smb ports =' | cut -d= -f2`\n \tctdb_wait_tcp_ports \"Samba\" $smb_ports\n@@ -35,7 +41,8 @@\n \n      shutdown)\n \t# shutdown Samba when ctdb goes down\n-\tkillall -q smbd nmbd winbindd\n+\tservice smb stop\n+\tservice winbind stop\n \t;;\n esac\n \n\n=== modified file 'tools/functions'\n--- a/tools/functions\t2007-06-01 13:25:33 +0000\n+++ b/tools/functions\t2007-06-02 08:51:05 +0000\n@@ -2,6 +2,20 @@\n \n \n ######################################################\n+# simulate /sbin/service on platforms that don't have it\n+service() { \n+  service_name=\"$1\"\n+  op=\"$2\"\n+  if [ -x /sbin/service ]; then\n+      /sbin/service \"$service_name\" \"$op\"\n+  elif [ -x /etc/init.d/$service_name ]; then\n+      /etc/init.d/$service_name \"$op\"\n+  elif [ -x /etc/rc.d/init.d/$service_name ]; then\n+      /etc/init.d/$service_name \"$op\"\n+  fi\n+}\n+\n+######################################################\n # wait for a set of tcp ports\n # usage: ctdb_wait_tcp_ports SERICE_NAME \n ######################################################\n\n"}