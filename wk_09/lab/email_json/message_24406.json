{"category": "ham", "to_address": "samba-cvs@samba.org", "from_address": "derrell@samba.org", "subject": "svn commit: samba r22733 - in branches/SAMBA_3_0_26/source: include\n\tlibsmb", "body": "Author: derrell\nDate: 2007-05-07 03:16:54 +0000 (Mon, 07 May 2007)\nNew Revision: 22733\n\nWebSVN: http://websvn.samba.org/cgi-bin/viewcvs.cgi?view=rev&root=samba&rev=22733\n\nLog:\nNOTE: the 3.0.26 branch does not currently fully compile due to a winbind\nerror, and I don't currently have access to Vista to verify this branch's\ncode.  Due to differences between this branch and the SAMBA_3_0, this patch is\nvery slightly different than what I used in SAMBA_3_0 in order to match this\nbranch's code better.  Hopefully I didn't screw anything up in the changes...\n\n- Testing of libsmbclient against Vista revealed what is likely a bug in\n  Vista.  Vista provides a plethora of kludges to simulate older versions of\n  Windows.  The kludges are in the form of shortcuts (or more likely symbolic\n  links, but I don't know enough about Vista to determine that definitively)\n  and in most cases, attempts to access them get back an \"access denied\"\n  error.  On one particular folder, however, \"/Users/All Users\", it\n  returns an unknown (to ethereal and the Samba3 code) NT status code:\n  0x8000002d.  Although this code does not have a high byte of 0xc0 indicating\n  that it is an error, it appears to be an alternate form of \"access denied\".\n\n  Without this patch, libsmbclient times out on an attempt to enumerate that\n  folder rather than returning an error to the caller.  This patch corrects\n  that problem.\n\n\nModified:\n   branches/SAMBA_3_0_26/source/include/nterr.h\n   branches/SAMBA_3_0_26/source/libsmb/clierror.c\n   branches/SAMBA_3_0_26/source/libsmb/clitrans.c\n\n\nChangeset:\nModified: branches/SAMBA_3_0_26/source/include/nterr.h\n===================================================================\n--- branches/SAMBA_3_0_26/source/include/nterr.h\t2007-05-07 03:07:39 UTC (rev 22732)\n+++ branches/SAMBA_3_0_26/source/include/nterr.h\t2007-05-07 03:16:54 UTC (rev 22733)\n@@ -30,6 +30,9 @@\n #define STATUS_NO_MORE_FILES              NT_STATUS(0x80000006)\n #define NT_STATUS_NO_MORE_ENTRIES         NT_STATUS(0x8000001a)\n \n+/* Vista Status codes. */\n+#define STATUS_INACCESSIBLE_SYSTEM_SHORTCUT         NT_STATUS(0x8000002d)\n+\n #define STATUS_MORE_ENTRIES               NT_STATUS(0x0105)\n #define STATUS_SOME_UNMAPPED              NT_STATUS(0x0107)\n #define ERROR_INVALID_PARAMETER\t\t  NT_STATUS(0x0057)\n\nModified: branches/SAMBA_3_0_26/source/libsmb/clierror.c\n===================================================================\n--- branches/SAMBA_3_0_26/source/libsmb/clierror.c\t2007-05-07 03:07:39 UTC (rev 22732)\n+++ branches/SAMBA_3_0_26/source/libsmb/clierror.c\t2007-05-07 03:16:54 UTC (rev 22733)\n@@ -380,6 +380,15 @@\n \t\treturn cli_errno_from_nt(status);\n         }\n \n+        /*\n+         * Yuck!  A special case for this Vista error.  Since its high-order\n+         * byte isn't 0xc0, it doesn't match cli_is_nt_error() above.\n+         */\n+        status = cli_nt_error(cli);\n+        if (NT_STATUS_V(status) == NT_STATUS_V(STATUS_INACCESSIBLE_SYSTEM_SHORTCUT)) {\n+            return EACCES;\n+        }\n+\n \t/* for other cases */\n \treturn EINVAL;\n }\n\nModified: branches/SAMBA_3_0_26/source/libsmb/clitrans.c\n===================================================================\n--- branches/SAMBA_3_0_26/source/libsmb/clitrans.c\t2007-05-07 03:07:39 UTC (rev 22732)\n+++ branches/SAMBA_3_0_26/source/libsmb/clitrans.c\t2007-05-07 03:16:54 UTC (rev 22733)\n@@ -197,7 +197,9 @@\n \t */\n \tstatus = cli_nt_error(cli);\n \t\n-\tif (NT_STATUS_IS_ERR(status) || NT_STATUS_EQUAL(status,STATUS_NO_MORE_FILES)) {\n+\tif (NT_STATUS_IS_ERR(status) ||\n+            NT_STATUS_EQUAL(status,STATUS_NO_MORE_FILES) ||\n+            NT_STATUS_EQUAL(status,STATUS_INACCESSIBLE_SYSTEM_SHORTCUT)) {\n \t\tgoto out;\n \t}\n \n\n"}