{"category": "ham", "to_address": "samba-cvs@samba.org", "from_address": "jpeach@samba.org", "subject": "svn commit: samba r23095 - in branches: SAMBA_3_0/source\n\tSAMBA_3_0/source/auth SAMBA_3_0/source/lib\n\tSAMBA_3_0/source/nsswitch SAMBA_3_0/source/pam_smbpass\n\tSAMBA_3_0_26/source SAMBA_3_0_26/source/auth\n\tSAMBA_3_0_26/source/lib SAMBA_3_0_26/source/nsswitch\n\tSAMBA_3_0_26/source/pam_smbpass", "body": "Author: jpeach\nDate: 2007-05-23 20:31:28 +0000 (Wed, 23 May 2007)\nNew Revision: 23095\n\nWebSVN: http://websvn.samba.org/cgi-bin/viewcvs.cgi?view=rev&root=samba&rev=23095\n\nLog:\nSupport systems that have their PAM headers in /usr/include/pam.\n\nModified:\n   branches/SAMBA_3_0/source/auth/pampass.c\n   branches/SAMBA_3_0/source/configure.in\n   branches/SAMBA_3_0/source/lib/pam_errors.c\n   branches/SAMBA_3_0/source/nsswitch/pam_winbind.h\n   branches/SAMBA_3_0/source/pam_smbpass/general.h\n   branches/SAMBA_3_0/source/pam_smbpass/pam_smb_acct.c\n   branches/SAMBA_3_0/source/pam_smbpass/pam_smb_auth.c\n   branches/SAMBA_3_0/source/pam_smbpass/pam_smb_passwd.c\n   branches/SAMBA_3_0_26/source/auth/pampass.c\n   branches/SAMBA_3_0_26/source/configure.in\n   branches/SAMBA_3_0_26/source/lib/pam_errors.c\n   branches/SAMBA_3_0_26/source/nsswitch/pam_winbind.h\n   branches/SAMBA_3_0_26/source/pam_smbpass/general.h\n   branches/SAMBA_3_0_26/source/pam_smbpass/pam_smb_acct.c\n   branches/SAMBA_3_0_26/source/pam_smbpass/pam_smb_auth.c\n   branches/SAMBA_3_0_26/source/pam_smbpass/pam_smb_passwd.c\n\n\nChangeset:\nModified: branches/SAMBA_3_0/source/auth/pampass.c\n===================================================================\n--- branches/SAMBA_3_0/source/auth/pampass.c\t2007-05-23 19:57:13 UTC (rev 23094)\n+++ branches/SAMBA_3_0/source/auth/pampass.c\t2007-05-23 20:31:28 UTC (rev 23095)\n@@ -41,7 +41,11 @@\n  *   which determines what actions/limitations/allowances become affected.\n  *********************************************************************/\n \n+#if defined(HAVE_SECURITY_PAM_APPL_H)\n #include \n+#elif defined(HAVE_PAM_PAM_APPL_H)\n+#include \n+#endif\n \n /*\n  * Structure used to communicate between the conversation function\n\nModified: branches/SAMBA_3_0/source/configure.in\n===================================================================\n--- branches/SAMBA_3_0/source/configure.in\t2007-05-23 19:57:13 UTC (rev 23094)\n+++ branches/SAMBA_3_0/source/configure.in\t2007-05-23 20:31:28 UTC (rev 23095)\n@@ -4399,7 +4399,11 @@\n \n \n #################################################\n-# check for a PAM clear-text auth, accounts, password and session support\n+# Check for a PAM clear-text auth, accounts, password\n+# and session support. Most PAM implementations keep their\n+# headers in /usr/include/security. Darwin keeps its in\n+# /usr/include/pam.\n+\n with_pam_for_crypt=no\n try_pam=no\n AC_MSG_CHECKING(whether to try PAM support)\n@@ -4419,10 +4423,13 @@\n \tuse_pam=yes\n \tcreate_pam_modules=yes\n \n-\tAC_CHECK_HEADERS(security/pam_appl.h)\n-\tif test x\"$ac_cv_header_security_pam_appl_h\" != x\"yes\"; then\n+\t# Most systems have PAM headers in /usr/include/security, but Darwin\n+\t# has them in /usr/include/pam.\n+\tAC_CHECK_HEADERS(security/pam_appl.h pam/pam_appl.h)\n+\tif test x\"$ac_cv_header_security_pam_appl_h\" != x\"yes\" -a \\\n+\t\tx\"$ac_cv_header_pam_pam_appl_h\" != x\"yes\"; then\n \t\tif test x\"${try_pam}\" = x\"yes\";then\n-\t\t\tAC_MSG_ERROR([--with-pam=yes but security/pam_appl.h not found])\n+\t\t\tAC_MSG_ERROR([--with-pam=yes but pam_appl.h not found])\n \t\tfi\n \t\tuse_pam=no\n \t\tcreate_pam_modules=no\n@@ -4437,14 +4444,18 @@\n \t\tcreate_pam_modules=no\n \tfi\n \n-\tAC_CHECK_HEADERS(security/pam_modules.h,,,[[\n+\tAC_CHECK_HEADERS(security/pam_modules.h pam/pam_modules.h,,,[[\n \t\t#if HAVE_SECURITY_PAM_APPL_H\n \t\t#include \n \t\t#endif\n+\t\t#if HAVE_PAM_PAM_APPL_H\n+\t\t#include \n+\t\t#endif\n \t]])\n-\tif test x\"$ac_cv_header_security_pam_modules_h\" = x\"no\"; then\n+\tif test x\"$ac_cv_header_security_pam_modules_h\" = x\"no\" -a \\\n+\t\tx\"$ac_cv_header_pam_pam_modules_h\" = x\"no\" ; then\n \t\tif test x\"${try_pam}\" = x\"yes\";then\n-\t\t\tAC_MSG_ERROR([--with-pam=yes but security/pam_modules.h not found])\n+\t\t\tAC_MSG_ERROR([--with-pam=yes but pam_modules.h not found])\n \t\tfi\n \t\tcreate_pam_modules=no\n \tfi\n@@ -4460,6 +4471,7 @@\n \t\t\t# this checks are optional,\n \t\t\t# we don't care about the results here\n \t\t\tAC_CHECK_HEADERS(security/pam_ext.h security/_pam_macros.h)\n+\t\t\tAC_CHECK_HEADERS(pam/pam_ext.h pam/_pam_macros.h)\n \t\t\tAC_CHECK_FUNC_EXT(pam_vsyslog,$PAM_LIBS)\n \t\telse\n \t\t\tAC_MSG_WARN([PAM support detected but PAM MODULES support is missing])\t\t\n\nModified: branches/SAMBA_3_0/source/lib/pam_errors.c\n===================================================================\n--- branches/SAMBA_3_0/source/lib/pam_errors.c\t2007-05-23 19:57:13 UTC (rev 23094)\n+++ branches/SAMBA_3_0/source/lib/pam_errors.c\t2007-05-23 20:31:28 UTC (rev 23095)\n@@ -21,7 +21,11 @@\n #include \"includes.h\"\n \n #ifdef WITH_PAM\n+#if defined(HAVE_SECURITY_PAM_APPL_H)\n #include \n+#elif defined(HAVE_PAM_PAM_APPL_H)\n+#include \n+#endif\n \n #if defined(PAM_AUTHTOK_RECOVERY_ERR) && !defined(PAM_AUTHTOK_RECOVER_ERR)\n #define PAM_AUTHTOK_RECOVER_ERR PAM_AUTHTOK_RECOVERY_ERR\n\nModified: branches/SAMBA_3_0/source/nsswitch/pam_winbind.h\n===================================================================\n--- branches/SAMBA_3_0/source/nsswitch/pam_winbind.h\t2007-05-23 19:57:13 UTC (rev 23094)\n+++ branches/SAMBA_3_0/source/nsswitch/pam_winbind.h\t2007-05-23 20:31:28 UTC (rev 23095)\n@@ -23,7 +23,11 @@\n \n /* Solaris always uses dynamic pam modules */\n #define PAM_EXTERN extern\n+#if defined(HAVE_SECURITY_PAM_APPL_H)\n #include  \n+#elif defined(HAVE_PAM_PAM_APPL_H)\n+#include \n+#endif\n \n #ifndef PAM_AUTHTOK_RECOVER_ERR\n #define PAM_AUTHTOK_RECOVER_ERR PAM_AUTHTOK_RECOVERY_ERR\n@@ -31,12 +35,16 @@\n \n #endif /* defined(SUNOS5) || defined(SUNOS4) || defined(HPUX) || defined(FREEBSD) || defined(AIX) */\n \n-#ifdef HAVE_SECURITY_PAM_MODULES_H\n+#if defined(HAVE_SECURITY_PAM_MODULES_H)\n #include \n+#elif defined(HAVE_PAM_PAM_MODULES_H)\n+#include \n #endif\n \n-#ifdef HAVE_SECURITY__PAM_MACROS_H\n+#if defined(HAVE_SECURITY__PAM_MACROS_H)\n #include \n+#elif defined(HAVE_PAM__PAM_MACROS_H)\n+#include \n #else\n /* Define required macros from (Linux PAM 0.68) security/_pam_macros.h */\n #define _pam_drop_reply(/* struct pam_response * */ reply, /* int */ replies) \\\n\nModified: branches/SAMBA_3_0/source/pam_smbpass/general.h\n===================================================================\n--- branches/SAMBA_3_0/source/pam_smbpass/general.h\t2007-05-23 19:57:13 UTC (rev 23094)\n+++ branches/SAMBA_3_0/source/pam_smbpass/general.h\t2007-05-23 20:31:28 UTC (rev 23095)\n@@ -1,9 +1,17 @@\n #ifndef LINUX\n /* This is only needed by modules in the Sun implementation. */\n+#if defined(HAVE_SECURITY_PAM_APPL_H)\n #include \n+#elif defined(HAVE_PAM_PAM_APPL_H)\n+#include \n+#endif\n #endif  /* LINUX */\n \n+#if defined(HAVE_SECURITY_PAM_MODULES_H)\n #include \n+#elif defined(HAVE_PAM_PAM_MODULES_H)\n+#include \n+#endif\n \n #ifndef PAM_AUTHTOK_RECOVER_ERR  \n #define PAM_AUTHTOK_RECOVER_ERR PAM_AUTHTOK_RECOVERY_ERR\n\nModified: branches/SAMBA_3_0/source/pam_smbpass/pam_smb_acct.c\n===================================================================\n--- branches/SAMBA_3_0/source/pam_smbpass/pam_smb_acct.c\t2007-05-23 19:57:13 UTC (rev 23094)\n+++ branches/SAMBA_3_0/source/pam_smbpass/pam_smb_acct.c\t2007-05-23 20:31:28 UTC (rev 23095)\n@@ -23,11 +23,19 @@\n #ifndef LINUX\n \n /* This is only used in the Sun implementation. */\n+#if defined(HAVE_SECURITY_PAM_APPL_H)\n #include \n+#elif defined(HAVE_PAM_PAM_APPL_H)\n+#include \n+#endif\n \n #endif  /* LINUX */\n \n+#if defined(HAVE_SECURITY_PAM_MODULES_H)\n #include \n+#elif defined(HAVE_PAM_PAM_MODULES_H)\n+#include \n+#endif\n \n #include \"general.h\"\n \n\nModified: branches/SAMBA_3_0/source/pam_smbpass/pam_smb_auth.c\n===================================================================\n--- branches/SAMBA_3_0/source/pam_smbpass/pam_smb_auth.c\t2007-05-23 19:57:13 UTC (rev 23094)\n+++ branches/SAMBA_3_0/source/pam_smbpass/pam_smb_auth.c\t2007-05-23 20:31:28 UTC (rev 23095)\n@@ -24,11 +24,19 @@\n #ifndef LINUX\n \n /* This is only used in the Sun implementation. */\n+#if defined(HAVE_SECURITY_PAM_APPL_H)\n #include \n+#elif defined(HAVE_PAM_PAM_APPL_H)\n+#include \n+#endif\n \n #endif  /* LINUX */\n \n+#if defined(HAVE_SECURITY_PAM_MODULES_H)\n #include \n+#elif defined(HAVE_PAM_PAM_MODULES_H)\n+#include \n+#endif\n \n #include \"general.h\"\n \n\nModified: branches/SAMBA_3_0/source/pam_smbpass/pam_smb_passwd.c\n===================================================================\n--- branches/SAMBA_3_0/source/pam_smbpass/pam_smb_passwd.c\t2007-05-23 19:57:13 UTC (rev 23094)\n+++ branches/SAMBA_3_0/source/pam_smbpass/pam_smb_passwd.c\t2007-05-23 20:31:28 UTC (rev 23095)\n@@ -29,10 +29,18 @@\n    and others (including FreeBSD). */\n \n #ifndef LINUX\n+#if defined(HAVE_SECURITY_PAM_APPL_H)\n #include \n+#elif defined(HAVE_PAM_PAM_APPL_H)\n+#include \n #endif\n+#endif\n \n+#if defined(HAVE_SECURITY_PAM_MODULES_H)\n #include \n+#elif defined(HAVE_PAM_PAM_MODULES_H)\n+#include \n+#endif\n \n #include \"general.h\" \n \n\nModified: branches/SAMBA_3_0_26/source/auth/pampass.c\n===================================================================\n--- branches/SAMBA_3_0_26/source/auth/pampass.c\t2007-05-23 19:57:13 UTC (rev 23094)\n+++ branches/SAMBA_3_0_26/source/auth/pampass.c\t2007-05-23 20:31:28 UTC (rev 23095)\n@@ -41,7 +41,11 @@\n  *   which determines what actions/limitations/allowances become affected.\n  *********************************************************************/\n \n+#if defined(HAVE_SECURITY_PAM_APPL_H)\n #include \n+#elif defined(HAVE_PAM_PAM_APPL_H)\n+#include \n+#endif\n \n /*\n  * Structure used to communicate between the conversation function\n\nModified: branches/SAMBA_3_0_26/source/configure.in\n===================================================================\n--- branches/SAMBA_3_0_26/source/configure.in\t2007-05-23 19:57:13 UTC (rev 23094)\n+++ branches/SAMBA_3_0_26/source/configure.in\t2007-05-23 20:31:28 UTC (rev 23095)\n@@ -4248,7 +4248,11 @@\n \n \n #################################################\n-# check for a PAM clear-text auth, accounts, password and session support\n+# Check for a PAM clear-text auth, accounts, password\n+# and session support. Most PAM implementations keep their\n+# headers in /usr/include/security. Darwin keeps its in\n+# /usr/include/pam.\n+\n with_pam_for_crypt=no\n try_pam=no\n AC_MSG_CHECKING(whether to try PAM support)\n@@ -4268,10 +4272,13 @@\n \tuse_pam=yes\n \tcreate_pam_modules=yes\n \n-\tAC_CHECK_HEADERS(security/pam_appl.h)\n-\tif test x\"$ac_cv_header_security_pam_appl_h\" != x\"yes\"; then\n+\t# Most systems have PAM headers in /usr/include/security, but Darwin\n+\t# has them in /usr/include/pam.\n+\tAC_CHECK_HEADERS(security/pam_appl.h pam/pam_appl.h)\n+\tif test x\"$ac_cv_header_security_pam_appl_h\" != x\"yes\" -a \\\n+\t\tx\"$ac_cv_header_pam_pam_appl_h\" != x\"yes\"; then\n \t\tif test x\"${try_pam}\" = x\"yes\";then\n-\t\t\tAC_MSG_ERROR([--with-pam=yes but security/pam_appl.h not found])\n+\t\t\tAC_MSG_ERROR([--with-pam=yes but pam_appl.h not found])\n \t\tfi\n \t\tuse_pam=no\n \t\tcreate_pam_modules=no\n@@ -4286,14 +4293,18 @@\n \t\tcreate_pam_modules=no\n \tfi\n \n-\tAC_CHECK_HEADERS(security/pam_modules.h,,,[[\n+\tAC_CHECK_HEADERS(security/pam_modules.h pam/pam_modules.h,,,[[\n \t\t#if HAVE_SECURITY_PAM_APPL_H\n \t\t#include \n \t\t#endif\n+\t\t#if HAVE_PAM_PAM_APPL_H\n+\t\t#include \n+\t\t#endif\n \t]])\n-       if test x\"$ac_cv_header_security_pam_modules_h\" = x\"no\"; then\n+\tif test x\"$ac_cv_header_security_pam_modules_h\" = x\"no\" -a \\\n+\t\tx\"$ac_cv_header_pam_pam_modules_h\" = x\"no\" ; then\n \t\tif test x\"${try_pam}\" = x\"yes\";then\n-\t\t\tAC_MSG_ERROR([--with-pam=yes but security/pam_modules.h not found])\n+\t\t\tAC_MSG_ERROR([--with-pam=yes but pam_modules.h not found])\n        fi\n \t\tcreate_pam_modules=no\n     fi\n@@ -4309,6 +4320,7 @@\n \t\t\t# this checks are optional,\n \t\t\t# we don't care about the results here\n \t\t\tAC_CHECK_HEADERS(security/pam_ext.h security/_pam_macros.h)\n+\t\t\tAC_CHECK_HEADERS(pam/pam_ext.h pam/_pam_macros.h)\n \t\t\tAC_CHECK_FUNC_EXT(pam_vsyslog,$PAM_LIBS)\n \t\telse\n \t\t\tAC_MSG_WARN([PAM support detected but PAM MODULES support is missing])\t\t\n\nModified: branches/SAMBA_3_0_26/source/lib/pam_errors.c\n===================================================================\n--- branches/SAMBA_3_0_26/source/lib/pam_errors.c\t2007-05-23 19:57:13 UTC (rev 23094)\n+++ branches/SAMBA_3_0_26/source/lib/pam_errors.c\t2007-05-23 20:31:28 UTC (rev 23095)\n@@ -21,7 +21,11 @@\n #include \"includes.h\"\n \n #ifdef WITH_PAM\n+#if defined(HAVE_SECURITY_PAM_APPL_H)\n #include \n+#elif defined(HAVE_PAM_PAM_APPL_H)\n+#include \n+#endif\n \n #if defined(PAM_AUTHTOK_RECOVERY_ERR) && !defined(PAM_AUTHTOK_RECOVER_ERR)\n #define PAM_AUTHTOK_RECOVER_ERR PAM_AUTHTOK_RECOVERY_ERR\n\nModified: branches/SAMBA_3_0_26/source/nsswitch/pam_winbind.h\n===================================================================\n--- branches/SAMBA_3_0_26/source/nsswitch/pam_winbind.h\t2007-05-23 19:57:13 UTC (rev 23094)\n+++ branches/SAMBA_3_0_26/source/nsswitch/pam_winbind.h\t2007-05-23 20:31:28 UTC (rev 23095)\n@@ -23,7 +23,11 @@\n \n /* Solaris always uses dynamic pam modules */\n #define PAM_EXTERN extern\n+#if defined(HAVE_SECURITY_PAM_APPL_H)\n #include  \n+#elif defined(HAVE_PAM_PAM_APPL_H)\n+#include \n+#endif\n \n #ifndef PAM_AUTHTOK_RECOVER_ERR\n #define PAM_AUTHTOK_RECOVER_ERR PAM_AUTHTOK_RECOVERY_ERR\n@@ -31,12 +35,16 @@\n \n #endif /* defined(SUNOS5) || defined(SUNOS4) || defined(HPUX) || defined(FREEBSD) || defined(AIX) */\n \n-#ifdef HAVE_SECURITY_PAM_MODULES_H\n+#if defined(HAVE_SECURITY_PAM_MODULES_H)\n #include \n+#elif defined(HAVE_PAM_PAM_MODULES_H)\n+#include \n #endif\n \n-#ifdef HAVE_SECURITY__PAM_MACROS_H\n+#if defined(HAVE_SECURITY__PAM_MACROS_H)\n #include \n+#elif defined(HAVE_PAM__PAM_MACROS_H)\n+#include \n #else\n /* Define required macros from (Linux PAM 0.68) security/_pam_macros.h */\n #define _pam_drop_reply(/* struct pam_response * */ reply, /* int */ replies) \\\n\nModified: branches/SAMBA_3_0_26/source/pam_smbpass/general.h\n===================================================================\n--- branches/SAMBA_3_0_26/source/pam_smbpass/general.h\t2007-05-23 19:57:13 UTC (rev 23094)\n+++ branches/SAMBA_3_0_26/source/pam_smbpass/general.h\t2007-05-23 20:31:28 UTC (rev 23095)\n@@ -1,9 +1,17 @@\n #ifndef LINUX\n /* This is only needed by modules in the Sun implementation. */\n+#if defined(HAVE_SECURITY_PAM_APPL_H)\n #include \n+#elif defined(HAVE_PAM_PAM_APPL_H)\n+#include \n+#endif\n #endif  /* LINUX */\n \n+#if defined(HAVE_SECURITY_PAM_MODULES_H)\n #include \n+#elif defined(HAVE_PAM_PAM_MODULES_H)\n+#include \n+#endif\n \n #ifndef PAM_AUTHTOK_RECOVER_ERR  \n #define PAM_AUTHTOK_RECOVER_ERR PAM_AUTHTOK_RECOVERY_ERR\n\nModified: branches/SAMBA_3_0_26/source/pam_smbpass/pam_smb_acct.c\n===================================================================\n--- branches/SAMBA_3_0_26/source/pam_smbpass/pam_smb_acct.c\t2007-05-23 19:57:13 UTC (rev 23094)\n+++ branches/SAMBA_3_0_26/source/pam_smbpass/pam_smb_acct.c\t2007-05-23 20:31:28 UTC (rev 23095)\n@@ -23,11 +23,19 @@\n #ifndef LINUX\n \n /* This is only used in the Sun implementation. */\n+#if defined(HAVE_SECURITY_PAM_APPL_H)\n #include \n+#elif defined(HAVE_PAM_PAM_APPL_H)\n+#include \n+#endif\n \n #endif  /* LINUX */\n \n+#if defined(HAVE_SECURITY_PAM_MODULES_H)\n #include \n+#elif defined(HAVE_PAM_PAM_MODULES_H)\n+#include \n+#endif\n \n #include \"general.h\"\n \n\nModified: branches/SAMBA_3_0_26/source/pam_smbpass/pam_smb_auth.c\n===================================================================\n--- branches/SAMBA_3_0_26/source/pam_smbpass/pam_smb_auth.c\t2007-05-23 19:57:13 UTC (rev 23094)\n+++ branches/SAMBA_3_0_26/source/pam_smbpass/pam_smb_auth.c\t2007-05-23 20:31:28 UTC (rev 23095)\n@@ -24,11 +24,19 @@\n #ifndef LINUX\n \n /* This is only used in the Sun implementation. */\n+#if defined(HAVE_SECURITY_PAM_APPL_H)\n #include \n+#elif defined(HAVE_PAM_PAM_APPL_H)\n+#include \n+#endif\n \n #endif  /* LINUX */\n \n+#if defined(HAVE_SECURITY_PAM_MODULES_H)\n #include \n+#elif defined(HAVE_PAM_PAM_MODULES_H)\n+#include \n+#endif\n \n #include \"general.h\"\n \n\nModified: branches/SAMBA_3_0_26/source/pam_smbpass/pam_smb_passwd.c\n===================================================================\n--- branches/SAMBA_3_0_26/source/pam_smbpass/pam_smb_passwd.c\t2007-05-23 19:57:13 UTC (rev 23094)\n+++ branches/SAMBA_3_0_26/source/pam_smbpass/pam_smb_passwd.c\t2007-05-23 20:31:28 UTC (rev 23095)\n@@ -29,10 +29,18 @@\n    and others (including FreeBSD). */\n \n #ifndef LINUX\n+#if defined(HAVE_SECURITY_PAM_APPL_H)\n #include \n+#elif defined(HAVE_PAM_PAM_APPL_H)\n+#include \n #endif\n+#endif\n \n+#if defined(HAVE_SECURITY_PAM_MODULES_H)\n #include \n+#elif defined(HAVE_PAM_PAM_MODULES_H)\n+#include \n+#endif\n \n #include \"general.h\" \n \n\n"}