{"category": "ham", "to_address": "samba-cvs@samba.org", "from_address": "metze@samba.org", "subject": "svn commit: samba r22528 - in branches/SAMBA_4_0/source/librpc/rpc:\n\t.", "body": "Author: metze\nDate: 2007-04-27 05:45:53 +0000 (Fri, 27 Apr 2007)\nNew Revision: 22528\n\nWebSVN: http://websvn.samba.org/cgi-bin/viewcvs.cgi?view=rev&root=samba&rev=22528\n\nLog:\nremember that the connection was marked dead and don't\nallow sending packet over the broken connection,\nas we would segfault...\n\nmetze\nModified:\n   branches/SAMBA_4_0/source/librpc/rpc/dcerpc_smb.c\n   branches/SAMBA_4_0/source/librpc/rpc/dcerpc_smb2.c\n\n\nChangeset:\nModified: branches/SAMBA_4_0/source/librpc/rpc/dcerpc_smb.c\n===================================================================\n--- branches/SAMBA_4_0/source/librpc/rpc/dcerpc_smb.c\t2007-04-26 17:36:19 UTC (rev 22527)\n+++ branches/SAMBA_4_0/source/librpc/rpc/dcerpc_smb.c\t2007-04-27 05:45:53 UTC (rev 22528)\n@@ -31,6 +31,7 @@\n \tuint16_t fnum;\n \tstruct smbcli_tree *tree;\n \tconst char *server_name;\n+\tbool dead;\n };\n \n \n@@ -39,6 +40,14 @@\n */\n static void pipe_dead(struct dcerpc_connection *c, NTSTATUS status)\n {\n+\tstruct smb_private *smb = c->transport.private;\n+\n+\tsmb->dead = true;\n+\n+\tif (smb->dead) {\n+\t\treturn;\n+\t}\n+\n \tif (NT_STATUS_EQUAL(NT_STATUS_UNSUCCESSFUL, status)) {\n \t\tstatus = NT_STATUS_UNEXPECTED_NETWORK_ERROR;\n \t}\n@@ -189,6 +198,12 @@\n */\n static NTSTATUS send_read_request(struct dcerpc_connection *c)\n {\n+\tstruct smb_private *smb = c->transport.private;\n+\n+\tif (smb->dead) {\n+\t\treturn NT_STATUS_CONNECTION_DISCONNECTED;\n+\t}\n+\n \treturn send_read_request_continue(c, NULL);\n }\n \n@@ -302,6 +317,10 @@\n \tunion smb_write io;\n \tstruct smbcli_request *req;\n \n+\tif (smb->dead) {\n+\t\treturn NT_STATUS_CONNECTION_DISCONNECTED;\n+\t}\n+\n \tif (trigger_read) {\n \t\treturn smb_send_trans_request(c, blob);\n \t}\n@@ -505,6 +524,8 @@\n \tsmb->server_name= strupper_talloc(smb,\n \t\t\t  state->tree->session->transport->called.name);\n \tif (composite_nomem(smb->server_name, ctx)) return;\n+\tsmb->dead\t= false;\n+\n \tc->transport.private = smb;\n \n \tcomposite_done(ctx);\n\nModified: branches/SAMBA_4_0/source/librpc/rpc/dcerpc_smb2.c\n===================================================================\n--- branches/SAMBA_4_0/source/librpc/rpc/dcerpc_smb2.c\t2007-04-26 17:36:19 UTC (rev 22527)\n+++ branches/SAMBA_4_0/source/librpc/rpc/dcerpc_smb2.c\t2007-04-27 05:45:53 UTC (rev 22528)\n@@ -33,6 +33,7 @@\n \tstruct smb2_handle handle;\n \tstruct smb2_tree *tree;\n \tconst char *server_name;\n+\tbool dead;\n };\n \n \n@@ -41,6 +42,14 @@\n */\n static void pipe_dead(struct dcerpc_connection *c, NTSTATUS status)\n {\n+\tstruct smb2_private *smb = c->transport.private;\n+\n+\tsmb->dead = true;\n+\n+\tif (smb->dead) {\n+\t\treturn;\n+\t}\n+\n \tif (NT_STATUS_EQUAL(NT_STATUS_UNSUCCESSFUL, status)) {\n \t\tstatus = NT_STATUS_UNEXPECTED_NETWORK_ERROR;\n \t}\n@@ -183,6 +192,12 @@\n */\n static NTSTATUS send_read_request(struct dcerpc_connection *c)\n {\n+\tstruct smb2_private *smb = c->transport.private;\n+\n+\tif (smb->dead) {\n+\t\treturn NT_STATUS_CONNECTION_DISCONNECTED;\n+\t}\n+\n \treturn send_read_request_continue(c, NULL);\n }\n \n@@ -287,6 +302,10 @@\n \tstruct smb2_write io;\n \tstruct smb2_request *req;\n \n+\tif (smb->dead) {\n+\t\treturn NT_STATUS_CONNECTION_DISCONNECTED;\n+\t}\n+\n \tif (trigger_read) {\n \t\treturn smb2_send_trans_request(c, blob);\n \t}\n@@ -461,6 +480,7 @@\n \tsmb->server_name= strupper_talloc(smb, \n \t\t\t\t\t  tree->session->transport->socket->hostname);\n \tif (composite_nomem(smb->server_name, ctx)) return;\n+\tsmb->dead\t= false;\n \n \tc->transport.private = smb;\n \n\n"}