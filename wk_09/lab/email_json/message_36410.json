{"category": "ham", "to_address": "samba-cvs@samba.org", "from_address": "jra@samba.org", "subject": "svn commit: samba r23151 - in branches: SAMBA_3_0/source/smbd\n\tSAMBA_3_0_25/source/smbd SAMBA_3_0_26/source/smbd", "body": "Author: jra\nDate: 2007-05-26 01:26:09 +0000 (Sat, 26 May 2007)\nNew Revision: 23151\n\nWebSVN: http://websvn.samba.org/cgi-bin/viewcvs.cgi?view=rev&root=samba&rev=23151\n\nLog:\nRe-arrange the logic so it looks identical to the\n\"file existed\" case above. This has no functional\nchange but is easier to see that it's doing the\nsame thing.\nJeremy.\n\nModified:\n   branches/SAMBA_3_0/source/smbd/open.c\n   branches/SAMBA_3_0_25/source/smbd/open.c\n   branches/SAMBA_3_0_26/source/smbd/open.c\n\n\nChangeset:\nModified: branches/SAMBA_3_0/source/smbd/open.c\n===================================================================\n--- branches/SAMBA_3_0/source/smbd/open.c\t2007-05-26 01:19:51 UTC (rev 23150)\n+++ branches/SAMBA_3_0/source/smbd/open.c\t2007-05-26 01:26:09 UTC (rev 23151)\n@@ -1663,6 +1663,20 @@\n \t\t\t\t\t access_mask, share_access,\n \t\t\t\t\t create_options, &file_existed);\n \n+\t\tif (NT_STATUS_IS_OK(status)) {\n+\t\t\t/* We might be going to allow this open. Check oplock\n+\t\t\t * status again. */\n+\t\t\t/* Second pass - send break for both batch or\n+\t\t\t * exclusive oplocks. */\n+\t\t\tif (delay_for_oplocks(lck, fsp, 2, oplock_request)) {\n+\t\t\t\tschedule_defer_open(lck, request_time);\n+\t\t\t\tTALLOC_FREE(lck);\n+\t\t\t\tfd_close(conn, fsp);\n+\t\t\t\tfile_free(fsp);\n+\t\t\t\treturn NT_STATUS_SHARING_VIOLATION;\n+\t\t\t}\n+\t\t}\n+\n \t\tif (!NT_STATUS_IS_OK(status)) {\n \t\t\tstruct deferred_open_record state;\n \n@@ -1686,14 +1700,6 @@\n \t\t\treturn status;\n \t\t}\n \n-\t\tif (delay_for_oplocks(lck, fsp, 2, oplock_request)) {\n-\t\t\tschedule_defer_open(lck, request_time);\n-\t\t\tTALLOC_FREE(lck);\n-\t\t\tfd_close(conn, fsp);\n-\t\t\tfile_free(fsp);\n-\t\t\treturn NT_STATUS_SHARING_VIOLATION;\n-\t\t}\n-\n \t\t/*\n \t\t * We exit this block with the share entry *locked*.....\n \t\t */\n\nModified: branches/SAMBA_3_0_25/source/smbd/open.c\n===================================================================\n--- branches/SAMBA_3_0_25/source/smbd/open.c\t2007-05-26 01:19:51 UTC (rev 23150)\n+++ branches/SAMBA_3_0_25/source/smbd/open.c\t2007-05-26 01:26:09 UTC (rev 23151)\n@@ -1665,6 +1665,20 @@\n \t\t\t\t\t access_mask, share_access,\n \t\t\t\t\t create_options, &file_existed);\n \n+\t\tif (NT_STATUS_IS_OK(status)) {\n+\t\t\t/* We might be going to allow this open. Check oplock\n+\t\t\t * status again. */\n+\t\t\t/* Second pass - send break for both batch or\n+\t\t\t * exclusive oplocks. */\n+\t\t\tif (delay_for_oplocks(lck, fsp, 2, oplock_request)) {\n+\t\t\t\tschedule_defer_open(lck, request_time);\n+\t\t\t\tTALLOC_FREE(lck);\n+\t\t\t\tfd_close(conn, fsp);\n+\t\t\t\tfile_free(fsp);\n+\t\t\t\treturn NT_STATUS_SHARING_VIOLATION;\n+\t\t\t}\n+\t\t}\n+\n \t\tif (!NT_STATUS_IS_OK(status)) {\n \t\t\tstruct deferred_open_record state;\n \n@@ -1688,14 +1702,6 @@\n \t\t\treturn status;\n \t\t}\n \n-\t\tif (delay_for_oplocks(lck, fsp, 2, oplock_request)) {\n-\t\t\tschedule_defer_open(lck, request_time);\n-\t\t\tTALLOC_FREE(lck);\n-\t\t\tfd_close(conn, fsp);\n-\t\t\tfile_free(fsp);\n-\t\t\treturn NT_STATUS_SHARING_VIOLATION;\n-\t\t}\n-\n \t\t/*\n \t\t * We exit this block with the share entry *locked*.....\n \t\t */\n\nModified: branches/SAMBA_3_0_26/source/smbd/open.c\n===================================================================\n--- branches/SAMBA_3_0_26/source/smbd/open.c\t2007-05-26 01:19:51 UTC (rev 23150)\n+++ branches/SAMBA_3_0_26/source/smbd/open.c\t2007-05-26 01:26:09 UTC (rev 23151)\n@@ -1667,6 +1667,20 @@\n \t\t\t\t\t access_mask, share_access,\n \t\t\t\t\t create_options, &file_existed);\n \n+\t\tif (NT_STATUS_IS_OK(status)) {\n+\t\t\t/* We might be going to allow this open. Check oplock\n+\t\t\t * status again. */\n+\t\t\t/* Second pass - send break for both batch or\n+\t\t\t * exclusive oplocks. */\n+\t\t\tif (delay_for_oplocks(lck, fsp, 2, oplock_request)) {\n+\t\t\t\tschedule_defer_open(lck, request_time);\n+\t\t\t\tTALLOC_FREE(lck);\n+\t\t\t\tfd_close(conn, fsp);\n+\t\t\t\tfile_free(fsp);\n+\t\t\t\treturn NT_STATUS_SHARING_VIOLATION;\n+\t\t\t}\n+\t\t}\n+\n \t\tif (!NT_STATUS_IS_OK(status)) {\n \t\t\tstruct deferred_open_record state;\n \n@@ -1690,14 +1704,6 @@\n \t\t\treturn status;\n \t\t}\n \n-\t\tif (delay_for_oplocks(lck, fsp, 2, oplock_request)) {\n-\t\t\tschedule_defer_open(lck, request_time);\n-\t\t\tTALLOC_FREE(lck);\n-\t\t\tfd_close(conn, fsp);\n-\t\t\tfile_free(fsp);\n-\t\t\treturn NT_STATUS_SHARING_VIOLATION;\n-\t\t}\n-\n \t\t/*\n \t\t * We exit this block with the share entry *locked*.....\n \t\t */\n\n"}