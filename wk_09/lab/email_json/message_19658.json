{"category": "ham", "to_address": "samba-cvs@samba.org", "from_address": "jra@samba.org", "subject": "svn commit: samba r22574 - in branches: SAMBA_3_0/source/rpc_server\n\tSAMBA_3_0_25/source/rpc_server", "body": "Author: jra\nDate: 2007-04-29 19:54:26 +0000 (Sun, 29 Apr 2007)\nNew Revision: 22574\n\nWebSVN: http://websvn.samba.org/cgi-bin/viewcvs.cgi?view=rev&root=samba&rev=22574\n\nLog:\nFix reply when we have no dfs shares.\nJeremy.\n\nModified:\n   branches/SAMBA_3_0/source/rpc_server/srv_dfs_nt.c\n   branches/SAMBA_3_0_25/source/rpc_server/srv_dfs_nt.c\n\n\nChangeset:\nModified: branches/SAMBA_3_0/source/rpc_server/srv_dfs_nt.c\n===================================================================\n--- branches/SAMBA_3_0/source/rpc_server/srv_dfs_nt.c\t2007-04-29 19:20:48 UTC (rev 22573)\n+++ branches/SAMBA_3_0/source/rpc_server/srv_dfs_nt.c\t2007-04-29 19:54:26 UTC (rev 22574)\n@@ -211,12 +211,15 @@\n \tdfs3->num_stores = j->referral_count;\n     \n \t/* also enumerate the stores */\n-\tdfs3->stores = TALLOC_ARRAY(mem_ctx, struct dfs_StorageInfo, j->referral_count);\n-\tif (!dfs3->stores)\n-\t\treturn False;\n+\tif (j->referral_count) {\n+\t\tdfs3->stores = TALLOC_ARRAY(mem_ctx, struct dfs_StorageInfo, j->referral_count);\n+\t\tif (!dfs3->stores)\n+\t\t\treturn False;\n+\t\tmemset(dfs3->stores, '\\0', j->referral_count * sizeof(struct dfs_StorageInfo));\n+\t} else {\n+\t\tdfs3->stores = NULL;\n+\t}\n \n-\tmemset(dfs3->stores, '\\0', j->referral_count * sizeof(struct dfs_StorageInfo));\n-\n \tfor(ii=0;iireferral_count;ii++) {\n \t\tchar* p; \n \t\tpstring path;\n@@ -262,20 +265,32 @@\n \t/* Create the return array */\n \tswitch (r->in.level) {\n \tcase 1:\n-\t\tif ((r->out.info->e.info1->s = TALLOC_ARRAY(p->mem_ctx, struct dfs_Info1, num_jn)) == NULL) {\n-\t\t\treturn WERR_NOMEM;\n+\t\tif (num_jn) {\n+\t\t\tif ((r->out.info->e.info1->s = TALLOC_ARRAY(p->mem_ctx, struct dfs_Info1, num_jn)) == NULL) {\n+\t\t\t\treturn WERR_NOMEM;\n+\t\t\t}\n+\t\t} else {\n+\t\t\tr->out.info->e.info1->s = NULL;\n \t\t}\n \t\tr->out.info->e.info1->count = num_jn;\n \t\tbreak;\n \tcase 2:\n-\t\tif ((r->out.info->e.info2->s = TALLOC_ARRAY(p->mem_ctx, struct dfs_Info2, num_jn)) == NULL) {\n-\t\t\treturn WERR_NOMEM;\n+\t\tif (num_jn) {\n+\t\t\tif ((r->out.info->e.info2->s = TALLOC_ARRAY(p->mem_ctx, struct dfs_Info2, num_jn)) == NULL) {\n+\t\t\t\treturn WERR_NOMEM;\n+\t\t\t}\n+\t\t} else {\n+\t\t\tr->out.info->e.info2->s = NULL;\n \t\t}\n \t\tr->out.info->e.info2->count = num_jn;\n \t\tbreak;\n \tcase 3:\n-\t\tif ((r->out.info->e.info3->s = TALLOC_ARRAY(p->mem_ctx, struct dfs_Info3, num_jn)) == NULL) {\n-\t\t\treturn WERR_NOMEM;\n+\t\tif (num_jn) {\n+\t\t\tif ((r->out.info->e.info3->s = TALLOC_ARRAY(p->mem_ctx, struct dfs_Info3, num_jn)) == NULL) {\n+\t\t\t\treturn WERR_NOMEM;\n+\t\t\t}\n+\t\t} else {\n+\t\t\tr->out.info->e.info3->s = NULL;\n \t\t}\n \t\tr->out.info->e.info3->count = num_jn;\n \t\tbreak;\n@@ -301,7 +316,7 @@\n   \n \treturn WERR_OK;\n }\n-      \n+\n WERROR _dfs_GetInfo(pipes_struct *p, struct dfs_GetInfo *r)\n {\n \tint consumedcnt = sizeof(pstring);\n\nModified: branches/SAMBA_3_0_25/source/rpc_server/srv_dfs_nt.c\n===================================================================\n--- branches/SAMBA_3_0_25/source/rpc_server/srv_dfs_nt.c\t2007-04-29 19:20:48 UTC (rev 22573)\n+++ branches/SAMBA_3_0_25/source/rpc_server/srv_dfs_nt.c\t2007-04-29 19:54:26 UTC (rev 22574)\n@@ -233,15 +233,19 @@\n \tinit_unistr2(&dfs3->comment, j->comment, UNI_STR_TERMINATE);\n \tdfs3->state = 1;\n \tdfs3->num_stores = dfs3->size_stores = j->referral_count;\n-\tdfs3->ptr0_stores = 1;\n     \n \t/* also enumerate the stores */\n-\tdfs3->stores = TALLOC_ARRAY(ctx, NETDFS_DFS_STORAGEINFO, j->referral_count);\n-\tif (!dfs3->stores)\n-\t\treturn False;\n+\tif (j->referral_count) {\n+\t\tdfs3->stores = TALLOC_ARRAY(ctx, NETDFS_DFS_STORAGEINFO, j->referral_count);\n+\t\tif (!dfs3->stores)\n+\t\t\treturn False;\n+\t\tmemset(dfs3->stores, '\\0', j->referral_count * sizeof(NETDFS_DFS_STORAGEINFO));\n+\t\tdfs3->ptr0_stores = 1;\n+\t} else {\n+\t\tdfs3->stores = NULL;\n+\t\tdfs3->ptr0_stores = 0;\n+\t}\n \n-\tmemset(dfs3->stores, '\\0', j->referral_count * sizeof(NETDFS_DFS_STORAGEINFO));\n-\n \tfor(ii=0;iireferral_count;ii++) {\n \t\tchar* p; \n \t\tpstring path;\n@@ -294,28 +298,34 @@\n \t/* Create the return array */\n \tswitch (level) {\n \tcase 1:\n-\t\tif ((r_u->info.e.u.info1.s = TALLOC_ARRAY(p->mem_ctx, NETDFS_DFS_INFO1, num_jn)) == NULL) {\n-\t\t\treturn WERR_NOMEM;\n+\t\tr_u->info.e.u.info1.count = num_jn;\n+\t\tif (num_jn) {\n+\t\t\tif ((r_u->info.e.u.info1.s = TALLOC_ARRAY(p->mem_ctx, NETDFS_DFS_INFO1, num_jn)) == NULL) {\n+\t\t\t\treturn WERR_NOMEM;\n+\t\t\t}\n+\t\t\tr_u->info.e.u.info1.ptr0_s = 1;\n+\t\t\tr_u->info.e.u.info1.size_s = num_jn;\n \t\t}\n-\t\tr_u->info.e.u.info1.count = num_jn;\n-\t\tr_u->info.e.u.info1.ptr0_s = 1;\n-\t\tr_u->info.e.u.info1.size_s = num_jn;\n \t\tbreak;\n \tcase 2:\n-\t\tif ((r_u->info.e.u.info2.s = TALLOC_ARRAY(p->mem_ctx, NETDFS_DFS_INFO2, num_jn)) == NULL) {\n-\t\t\treturn WERR_NOMEM;\n+\t\tr_u->info.e.u.info2.count = num_jn;\n+\t\tif (num_jn) {\n+\t\t\tif ((r_u->info.e.u.info2.s = TALLOC_ARRAY(p->mem_ctx, NETDFS_DFS_INFO2, num_jn)) == NULL) {\n+\t\t\t\treturn WERR_NOMEM;\n+\t\t\t}\n+\t\t\tr_u->info.e.u.info2.ptr0_s = 1;\n+\t\t\tr_u->info.e.u.info2.size_s = num_jn;\n \t\t}\n-\t\tr_u->info.e.u.info2.count = num_jn;\n-\t\tr_u->info.e.u.info2.ptr0_s = 1;\n-\t\tr_u->info.e.u.info2.size_s = num_jn;\n \t\tbreak;\n \tcase 3:\n-\t\tif ((r_u->info.e.u.info3.s = TALLOC_ARRAY(p->mem_ctx, NETDFS_DFS_INFO3, num_jn)) == NULL) {\n-\t\t\treturn WERR_NOMEM;\n+\t\tr_u->info.e.u.info3.count = num_jn;\n+\t\tif (num_jn) {\n+\t\t\tif ((r_u->info.e.u.info3.s = TALLOC_ARRAY(p->mem_ctx, NETDFS_DFS_INFO3, num_jn)) == NULL) {\n+\t\t\t\treturn WERR_NOMEM;\n+\t\t\t}\n+\t\t\tr_u->info.e.u.info3.ptr0_s = 1;\n+\t\t\tr_u->info.e.u.info3.size_s = num_jn;\n \t\t}\n-\t\tr_u->info.e.u.info3.count = num_jn;\n-\t\tr_u->info.e.u.info3.ptr0_s = 1;\n-\t\tr_u->info.e.u.info3.size_s = num_jn;\n \t\tbreak;\n \tdefault:\n \t\treturn WERR_INVALID_PARAM;\n\n"}