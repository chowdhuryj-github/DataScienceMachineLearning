{"category": "ham", "to_address": "Dmitry Shatrov <dhsatrov@linux.vnet.ibm.com>", "from_address": "tridge@au1.ibm.com (Andrew Tridgell)", "subject": "Re: Samba3 memory usage, iconv", "body": "Dmitry,\n\n > It turns out that quite a lot of memory (~300 Kbytes) is allocated right \n > at the start of each smbd process by init_iconv() (lib/charcnv.c).\n\nI tried adding lazy_initialize_conv() before the fork in\nserver.c. That allows us to run 4900 smbd processes on the test system\nin Mainz before the system dies. Without that change the it was around\n4700, although it varies somewhat between runs. The system has 4G of\nram, but about 1.4G is used by system services (such as GPFS).\n\nSo I don't think it's really costing 300k per process for the iconv\ntables. I suspect that massif is giving us misleading results.\n\nI think we will need to fall back on more primitive techniques for\nlooking for high memory usage. For example DEBUG() lines showing\nmallinfo() information would be useful.\n\nTo really scale Samba to large numbers of connections I think we will\nneed to adopt a pre-fork process model, more like apache. So we'd\nspecify how many smbd processes to fork (say 32 or 64 for a typical\nserver) then spread the load across those processes. I suspect we'd be\nable to support between 10x and 50x as many connections on a given\nserver with that model.\n\nCheers, Tridge\n\n"}