{"category": "ham", "to_address": "samba-cvs@samba.org", "from_address": "tridge@samba.org", "subject": "svn commit: samba r22969 - in branches/SAMBA_4_0/source:\n\tauth/credentials auth/gensec auth/kerberos client dsdb/samdb\n\tdsdb/samdb/ldb_modules kdc torture torture/auth torture/basic\n\ttorture/libnet torture/local torture/raw torture/rpc", "body": "Author: tridge\nDate: 2007-05-17 08:47:04 +0000 (Thu, 17 May 2007)\nNew Revision: 22969\n\nWebSVN: http://websvn.samba.org/cgi-bin/viewcvs.cgi?view=rev&root=samba&rev=22969\n\nLog:\n\nfix some more places where we could end up with more than one event\ncontext. We now have an event context on the torture_context, and we\ncan also get one from the cli_credentials structure\n\nModified:\n   branches/SAMBA_4_0/source/auth/credentials/credentials.c\n   branches/SAMBA_4_0/source/auth/credentials/credentials.h\n   branches/SAMBA_4_0/source/auth/credentials/credentials_krb5.c\n   branches/SAMBA_4_0/source/auth/gensec/gensec_gssapi.c\n   branches/SAMBA_4_0/source/auth/kerberos/krb5_init_context.c\n   branches/SAMBA_4_0/source/auth/kerberos/krb5_init_context.h\n   branches/SAMBA_4_0/source/client/client.c\n   branches/SAMBA_4_0/source/dsdb/samdb/cracknames.c\n   branches/SAMBA_4_0/source/dsdb/samdb/ldb_modules/password_hash.c\n   branches/SAMBA_4_0/source/kdc/kdc.c\n   branches/SAMBA_4_0/source/torture/auth/pac.c\n   branches/SAMBA_4_0/source/torture/basic/misc.c\n   branches/SAMBA_4_0/source/torture/libnet/libnet_BecomeDC.c\n   branches/SAMBA_4_0/source/torture/local/irpc.c\n   branches/SAMBA_4_0/source/torture/local/messaging.c\n   branches/SAMBA_4_0/source/torture/local/resolve.c\n   branches/SAMBA_4_0/source/torture/raw/composite.c\n   branches/SAMBA_4_0/source/torture/raw/open.c\n   branches/SAMBA_4_0/source/torture/rpc/async_bind.c\n   branches/SAMBA_4_0/source/torture/torture.c\n   branches/SAMBA_4_0/source/torture/ui.h\n   branches/SAMBA_4_0/source/torture/util_smb.c\n\n\nChangeset:\nModified: branches/SAMBA_4_0/source/auth/credentials/credentials.c\n===================================================================\n--- branches/SAMBA_4_0/source/auth/credentials/credentials.c\t2007-05-17 07:52:33 UTC (rev 22968)\n+++ branches/SAMBA_4_0/source/auth/credentials/credentials.c\t2007-05-17 08:47:04 UTC (rev 22969)\n@@ -27,6 +27,7 @@\n #include \"auth/credentials/credentials.h\"\n #include \"auth/credentials/credentials_krb5.h\"\n #include \"libcli/auth/libcli_auth.h\"\n+#include \"lib/events/events.h\"\n \n /**\n  * Create a new credentials structure\n@@ -61,6 +62,7 @@\n \n \tcred->tries = 3;\n \tcred->callback_running = False;\n+\tcred->ev = NULL;\n \n \tcli_credentials_set_kerberos_state(cred, CRED_AUTO_USE_KERBEROS);\n \tcli_credentials_set_gensec_features(cred, 0);\n@@ -747,3 +749,22 @@\n \n \treturn (cred->tries > 0);\n }\n+\n+/*\n+  set the common event context for this set of credentials\n+ */\n+void cli_credentials_set_event_context(struct cli_credentials *cred, struct event_context *ev)\n+{\n+\tcred->ev = ev;\n+}\n+\n+/*\n+  set the common event context for this set of credentials\n+ */\n+struct event_context *cli_credentials_get_event_context(struct cli_credentials *cred)\n+{\n+\tif (cred->ev == NULL) {\n+\t\tcred->ev = event_context_find(cred);\n+\t}\n+\treturn cred->ev;\n+}\n\nModified: branches/SAMBA_4_0/source/auth/credentials/credentials.h\n===================================================================\n--- branches/SAMBA_4_0/source/auth/credentials/credentials.h\t2007-05-17 07:52:33 UTC (rev 22968)\n+++ branches/SAMBA_4_0/source/auth/credentials/credentials.h\t2007-05-17 08:47:04 UTC (rev 22969)\n@@ -114,6 +114,9 @@\n \n \t/* Whether any callback is currently running */\n \tBOOL callback_running;\n+\n+\t/* an event context for anyone wanting to use the credentials */\n+\tstruct event_context *ev;\n };\n \n struct ldb_context;\n\nModified: branches/SAMBA_4_0/source/auth/credentials/credentials_krb5.c\n===================================================================\n--- branches/SAMBA_4_0/source/auth/credentials/credentials_krb5.c\t2007-05-17 07:52:33 UTC (rev 22968)\n+++ branches/SAMBA_4_0/source/auth/credentials/credentials_krb5.c\t2007-05-17 08:47:04 UTC (rev 22969)\n@@ -37,7 +37,8 @@\n \t\treturn 0;\n \t}\n \n-\tret = smb_krb5_init_context(cred, &cred->smb_krb5_context);\n+\tret = smb_krb5_init_context(cred, cli_credentials_get_event_context(cred), \n+\t\t\t\t    &cred->smb_krb5_context);\n \tif (ret) {\n \t\treturn ret;\n \t}\n\nModified: branches/SAMBA_4_0/source/auth/gensec/gensec_gssapi.c\n===================================================================\n--- branches/SAMBA_4_0/source/auth/gensec/gensec_gssapi.c\t2007-05-17 07:52:33 UTC (rev 22968)\n+++ branches/SAMBA_4_0/source/auth/gensec/gensec_gssapi.c\t2007-05-17 08:47:04 UTC (rev 22969)\n@@ -23,6 +23,7 @@\n */\n \n #include \"includes.h\"\n+#include \"lib/events/events.h\"\n #include \"system/kerberos.h\"\n #include \"heimdal/lib/gssapi/gssapi/gssapi.h\"\n #include \"auth/kerberos/kerberos.h\"\n@@ -226,6 +227,7 @@\n \t}\n \n \tret = smb_krb5_init_context(gensec_gssapi_state, \n+\t\t\t\t    gensec_security->event_ctx,\n \t\t\t\t    &gensec_gssapi_state->smb_krb5_context);\n \tif (ret) {\n \t\tDEBUG(1,(\"gensec_krb5_start: krb5_init_context failed (%s)\\n\",\n\nModified: branches/SAMBA_4_0/source/auth/kerberos/krb5_init_context.c\n===================================================================\n--- branches/SAMBA_4_0/source/auth/kerberos/krb5_init_context.c\t2007-05-17 07:52:33 UTC (rev 22968)\n+++ branches/SAMBA_4_0/source/auth/kerberos/krb5_init_context.c\t2007-05-17 08:47:04 UTC (rev 22969)\n@@ -355,11 +355,11 @@\n }\n \n krb5_error_code smb_krb5_init_context(void *parent_ctx, \n+\t\t\t\t      struct event_context *ev,\n \t\t\t\t       struct smb_krb5_context **smb_krb5_context) \n {\n \tkrb5_error_code ret;\n \tTALLOC_CTX *tmp_ctx;\n-\tstruct event_context *ev;\n \tchar **config_files;\n \tconst char *config_file;\n \t\n@@ -446,7 +446,6 @@\n \t}\n \tkrb5_set_warn_dest((*smb_krb5_context)->krb5_context, (*smb_krb5_context)->logf);\n \n-\tev = event_context_find(*smb_krb5_context);\n \t/* Set use of our socket lib */\n \tret = krb5_set_send_to_kdc_func((*smb_krb5_context)->krb5_context, \n \t\t\t\t\tsmb_krb5_send_and_recv_func, \n\nModified: branches/SAMBA_4_0/source/auth/kerberos/krb5_init_context.h\n===================================================================\n--- branches/SAMBA_4_0/source/auth/kerberos/krb5_init_context.h\t2007-05-17 07:52:33 UTC (rev 22968)\n+++ branches/SAMBA_4_0/source/auth/kerberos/krb5_init_context.h\t2007-05-17 08:47:04 UTC (rev 22969)\n@@ -23,7 +23,8 @@\n \tkrb5_log_facility *logf;\n };\n \t\n-krb5_error_code smb_krb5_init_context(void *parent_ctx, \n+struct event_context;\n+krb5_error_code smb_krb5_init_context(void *parent_ctx, struct event_context *ev,\n \t\t\t\t      struct smb_krb5_context **smb_krb5_context); \n void smb_krb5_free_context(struct smb_krb5_context *smb_krb5_context);\n \n\nModified: branches/SAMBA_4_0/source/client/client.c\n===================================================================\n--- branches/SAMBA_4_0/source/client/client.c\t2007-05-17 07:52:33 UTC (rev 22968)\n+++ branches/SAMBA_4_0/source/client/client.c\t2007-05-17 08:47:04 UTC (rev 22969)\n@@ -2994,7 +2994,8 @@\n \tctx->remote_cur_dir = talloc_strdup(ctx, \"\\\\\");\n \t\n \tstatus = smbcli_full_connection(ctx, &ctx->cli, server,\n-\t\t\t\t\tshare, NULL, cred, NULL);\n+\t\t\t\t\tshare, NULL, cred, \n+\t\t\t\t\tcli_credentials_get_event_context(cred));\n \tif (!NT_STATUS_IS_OK(status)) {\n \t\td_printf(\"Connection to \\\\\\\\%s\\\\%s failed - %s\\n\", \n \t\t\t server, share, nt_errstr(status));\n\nModified: branches/SAMBA_4_0/source/dsdb/samdb/cracknames.c\n===================================================================\n--- branches/SAMBA_4_0/source/dsdb/samdb/cracknames.c\t2007-05-17 07:52:33 UTC (rev 22968)\n+++ branches/SAMBA_4_0/source/dsdb/samdb/cracknames.c\t2007-05-17 08:47:04 UTC (rev 22969)\n@@ -348,7 +348,9 @@\n \tstruct ldb_dn *name_dn = NULL;\n \n \tstruct smb_krb5_context *smb_krb5_context;\n-\tret = smb_krb5_init_context(mem_ctx, &smb_krb5_context);\n+\tret = smb_krb5_init_context(mem_ctx, \n+\t\t\t\t    ldb_get_opaque(sam_ctx, \"EventContext\"), \n+\t\t\t\t    &smb_krb5_context);\n \t\t\t\t\n \tif (ret) {\n \t\treturn WERR_NOMEM;\n\nModified: branches/SAMBA_4_0/source/dsdb/samdb/ldb_modules/password_hash.c\n===================================================================\n--- branches/SAMBA_4_0/source/dsdb/samdb/ldb_modules/password_hash.c\t2007-05-17 07:52:33 UTC (rev 22968)\n+++ branches/SAMBA_4_0/source/dsdb/samdb/ldb_modules/password_hash.c\t2007-05-17 08:47:04 UTC (rev 22969)\n@@ -1430,7 +1430,9 @@\n \t}\n \n \t/* Some operations below require kerberos contexts */\n-\tif (smb_krb5_init_context(ac->down_req, &smb_krb5_context) != 0) {\n+\tif (smb_krb5_init_context(ac->down_req, \n+\t\t\t\t  ldb_get_opaque(h->module->ldb, \"EventContext\"), \n+\t\t\t\t  &smb_krb5_context) != 0) {\n \t\treturn LDB_ERR_OPERATIONS_ERROR;\n \t}\n \n@@ -1760,7 +1762,9 @@\n \tmsg->dn = ac->orig_req->op.mod.message->dn;\n \n \t/* Some operations below require kerberos contexts */\n-\tif (smb_krb5_init_context(ac->mod_req, &smb_krb5_context) != 0) {\n+\tif (smb_krb5_init_context(ac->mod_req, \n+\t\t\t\t  ldb_get_opaque(h->module->ldb, \"EventContext\"), \n+\t\t\t\t  &smb_krb5_context) != 0) {\n \t\treturn LDB_ERR_OPERATIONS_ERROR;\n \t}\n \n\nModified: branches/SAMBA_4_0/source/kdc/kdc.c\n===================================================================\n--- branches/SAMBA_4_0/source/kdc/kdc.c\t2007-05-17 07:52:33 UTC (rev 22968)\n+++ branches/SAMBA_4_0/source/kdc/kdc.c\t2007-05-17 08:47:04 UTC (rev 22969)\n@@ -582,7 +582,7 @@\n \n \tinitialize_krb5_error_table();\n \n-\tret = smb_krb5_init_context(kdc, &kdc->smb_krb5_context);\n+\tret = smb_krb5_init_context(kdc, task->event_ctx, &kdc->smb_krb5_context);\n \tif (ret) {\n \t\tDEBUG(1,(\"kdc_task_init: krb5_init_context failed (%s)\\n\", \n \t\t\t error_message(ret)));\n\nModified: branches/SAMBA_4_0/source/torture/auth/pac.c\n===================================================================\n--- branches/SAMBA_4_0/source/torture/auth/pac.c\t2007-05-17 07:52:33 UTC (rev 22968)\n+++ branches/SAMBA_4_0/source/torture/auth/pac.c\t2007-05-17 08:47:04 UTC (rev 22969)\n@@ -56,7 +56,9 @@\n \n \tTALLOC_CTX *mem_ctx = tctx;\n \n-\ttorture_assert(tctx, 0 == smb_krb5_init_context(mem_ctx, &smb_krb5_context), \n+\ttorture_assert(tctx, 0 == smb_krb5_init_context(mem_ctx, \n+\t\t\t\t\t\t\tNULL,\n+\t\t\t\t\t\t\t&smb_krb5_context), \n \t\t       \"smb_krb5_init_context\");\n \n \tgenerate_random_buffer(server_bytes, 16);\n@@ -282,7 +284,8 @@\n \ttime_t authtime;\n \tTALLOC_CTX *mem_ctx = tctx;\n \n-\ttorture_assert(tctx, 0 == smb_krb5_init_context(mem_ctx, &smb_krb5_context),\n+\ttorture_assert(tctx, 0 == smb_krb5_init_context(mem_ctx, NULL,\n+\t\t\t\t\t\t\t&smb_krb5_context),\n \t\t       \"smb_krb5_init_context\");\n \n \tpac_kdc_key = torture_setting_string(tctx, \"pac_kdc_key\", \n\nModified: branches/SAMBA_4_0/source/torture/basic/misc.c\n===================================================================\n--- branches/SAMBA_4_0/source/torture/basic/misc.c\t2007-05-17 07:52:33 UTC (rev 22968)\n+++ branches/SAMBA_4_0/source/torture/basic/misc.c\t2007-05-17 08:47:04 UTC (rev 22969)\n@@ -843,7 +843,7 @@\n \t\t\ttorture_numops, torture_nprocs);\n \n \t/*init talloc context*/\n-\tev = event_context_init(tctx);\n+\tev = tctx->ev;\n \tstate = talloc_array(tctx, struct benchrw_state *, torture_nprocs);\n \n \t/* init params using lp_parm_xxx */\n\nModified: branches/SAMBA_4_0/source/torture/libnet/libnet_BecomeDC.c\n===================================================================\n--- branches/SAMBA_4_0/source/torture/libnet/libnet_BecomeDC.c\t2007-05-17 07:52:33 UTC (rev 22968)\n+++ branches/SAMBA_4_0/source/torture/libnet/libnet_BecomeDC.c\t2007-05-17 08:47:04 UTC (rev 22969)\n@@ -755,7 +755,7 @@\n \t\treturn False;\n \t}\n \n-\ts->ctx = libnet_context_init(event_context_init(s));\n+\ts->ctx = libnet_context_init(torture->ev);\n \ts->ctx->cred = cmdline_credentials;\n \n \ts->ldb = ldb_init(s);\n\nModified: branches/SAMBA_4_0/source/torture/local/irpc.c\n===================================================================\n--- branches/SAMBA_4_0/source/torture/local/irpc.c\t2007-05-17 07:52:33 UTC (rev 22968)\n+++ branches/SAMBA_4_0/source/torture/local/irpc.c\t2007-05-17 08:47:04 UTC (rev 22969)\n@@ -217,7 +217,7 @@\n \n \tlp_set_cmdline(\"lock dir\", \"lockdir.tmp\");\n \n-\tdata->ev = event_context_init(tctx);\n+\tdata->ev = tctx->ev;\n \ttorture_assert(tctx, data->msg_ctx1 = \n \t\t       messaging_init(tctx, \n \t\t\t\t      cluster_id(MSG_ID1), data->ev),\n\nModified: branches/SAMBA_4_0/source/torture/local/messaging.c\n===================================================================\n--- branches/SAMBA_4_0/source/torture/local/messaging.c\t2007-05-17 07:52:33 UTC (rev 22968)\n+++ branches/SAMBA_4_0/source/torture/local/messaging.c\t2007-05-17 08:47:04 UTC (rev 22969)\n@@ -70,7 +70,7 @@\n \n \tlp_set_cmdline(\"pid directory\", \"piddir.tmp\");\n \n-\tev = event_context_init(mem_ctx);\n+\tev = tctx->ev;\n \n \tmsg_server_ctx = messaging_init(mem_ctx, cluster_id(1), ev);\n \t\n\nModified: branches/SAMBA_4_0/source/torture/local/resolve.c\n===================================================================\n--- branches/SAMBA_4_0/source/torture/local/resolve.c\t2007-05-17 07:52:33 UTC (rev 22968)\n+++ branches/SAMBA_4_0/source/torture/local/resolve.c\t2007-05-17 08:47:04 UTC (rev 22969)\n@@ -35,7 +35,7 @@\n \tstruct timeval tv = timeval_current();\n \tTALLOC_CTX *mem_ctx = tctx;\n \n-\tev = event_context_init(mem_ctx);\n+\tev = tctx->ev;\n \n \tZERO_STRUCT(n);\n \tn.name = host;\n\nModified: branches/SAMBA_4_0/source/torture/raw/composite.c\n===================================================================\n--- branches/SAMBA_4_0/source/torture/raw/composite.c\t2007-05-17 07:52:33 UTC (rev 22968)\n+++ branches/SAMBA_4_0/source/torture/raw/composite.c\t2007-05-17 08:47:04 UTC (rev 22969)\n@@ -164,7 +164,7 @@\n \n \tprintf(\"testing parallel fetchfile with %d ops\\n\", torture_numops);\n \n-\tevent_ctx = event_context_init(mem_ctx);\n+\tevent_ctx = cli->transport->socket->event.ctx;\n \tc = talloc_array(mem_ctx, struct composite_context *, torture_numops);\n \n \tfor (i=0; iui_ops = ui_ops;\n \ttorture->returncode = true;\n+\ttorture->ev = cli_credentials_get_event_context(cmdline_credentials);\n \n \tif (ui_ops->init)\n \t\tui_ops->init(torture);\n\nModified: branches/SAMBA_4_0/source/torture/ui.h\n===================================================================\n--- branches/SAMBA_4_0/source/torture/ui.h\t2007-05-17 07:52:33 UTC (rev 22968)\n+++ branches/SAMBA_4_0/source/torture/ui.h\t2007-05-17 08:47:04 UTC (rev 22969)\n@@ -90,6 +90,7 @@\n \n \tchar *outputdir;\n \tint level;\n+\tstruct event_context *ev;\n };\n \n /* \n\nModified: branches/SAMBA_4_0/source/torture/util_smb.c\n===================================================================\n--- branches/SAMBA_4_0/source/torture/util_smb.c\t2007-05-17 07:52:33 UTC (rev 22968)\n+++ branches/SAMBA_4_0/source/torture/util_smb.c\t2007-05-17 08:47:04 UTC (rev 22969)\n@@ -31,6 +31,7 @@\n #include \"torture/ui.h\"\n #include \"torture/torture.h\"\n #include \"util/dlinklist.h\"\n+#include \"auth/credentials/credentials.h\"\n \n \n /**\n@@ -541,7 +542,8 @@\n \n _PUBLIC_ bool torture_open_connection(struct smbcli_state **c, int conn_index)\n {\n-\treturn torture_open_connection_ev(c, conn_index, NULL);\n+\treturn torture_open_connection_ev(c, conn_index, \n+\t\t\t\t\t  cli_credentials_get_event_context(cmdline_credentials));\n }\n \n \n\n"}