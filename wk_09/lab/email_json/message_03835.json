{"category": "ham", "to_address": "samba-cvs@samba.org", "from_address": "idra@samba.org", "subject": "svn commit: samba r22204 - in branches: SAMBA_3_0/source/nsswitch\n\tSAMBA_3_0_25/source/nsswitch", "body": "Author: idra\nDate: 2007-04-12 21:10:06 +0000 (Thu, 12 Apr 2007)\nNew Revision: 22204\n\nWebSVN: http://websvn.samba.org/cgi-bin/viewcvs.cgi?view=rev&root=samba&rev=22204\n\nLog:\n\nWorkaround to quickly close bug #4508\nThis hack makes thing work, but we will need to try again to\nmake the getpw* calls fully async, that's the real fix.\n\n\nModified:\n   branches/SAMBA_3_0/source/nsswitch/idmap.c\n   branches/SAMBA_3_0/source/nsswitch/winbindd.c\n   branches/SAMBA_3_0/source/nsswitch/winbindd_dual.c\n   branches/SAMBA_3_0_25/source/nsswitch/idmap.c\n   branches/SAMBA_3_0_25/source/nsswitch/winbindd.c\n   branches/SAMBA_3_0_25/source/nsswitch/winbindd_dual.c\n\n\nChangeset:\nModified: branches/SAMBA_3_0/source/nsswitch/idmap.c\n===================================================================\n--- branches/SAMBA_3_0/source/nsswitch/idmap.c\t2007-04-12 19:54:15 UTC (rev 22203)\n+++ branches/SAMBA_3_0/source/nsswitch/idmap.c\t2007-04-12 21:10:06 UTC (rev 22204)\n@@ -84,6 +84,24 @@\n \treturn NULL;\n }\n \n+/* part of a quick hack to avoid loops, need to be sorted out correctly later on */\n+static BOOL idmap_in_own_child;\n+\n+static BOOL idmap_is_in_own_child(void)\n+{\n+\treturn idmap_in_own_child;\n+}\n+\n+void reset_idmap_in_own_child(void)\n+{\n+\tidmap_in_own_child = False;\n+}\n+\n+void set_idmap_in_own_child(void)\n+{\n+\tidmap_in_own_child = True;\n+}\n+\n /**********************************************************************\n  Allow a module to register itself as a method.\n **********************************************************************/\n@@ -801,13 +819,18 @@\n \tif ( ! NT_STATUS_IS_OK(ret)) {\n \t\treturn NT_STATUS_NONE_MAPPED;\n \t}\n-\t\n-\t/* by default calls to winbindd are disabled\n-\t   the following call will not recurse so this is safe */\n-\twinbind_on();\n-\twbret = winbind_lookup_sid(ctx, map->sid, &domname, &name, &sid_type);\n-\twinbind_off();\n \n+\t/* quick hack to make things work, will need proper fix later on */\t\n+\tif (idmap_is_in_own_child()) {\n+\t\t/* by default calls to winbindd are disabled\n+\t\t   the following call will not recurse so this is safe */\n+\t\twinbind_on();\n+\t\twbret = winbind_lookup_sid(ctx, map->sid, &domname, &name, &sid_type);\n+\t\twinbind_off();\n+\t} else {\n+\t\twbret = winbindd_lookup_name_by_sid(ctx, map->sid, &domname, &name, &sid_type);\n+\t}\n+\n \t/* check if this is a valid SID and then map it */\n \tif (wbret) {\n \t\tswitch (sid_type) {\n@@ -1395,3 +1418,4 @@\n \n \treturn ret;\n }\n+\n\nModified: branches/SAMBA_3_0/source/nsswitch/winbindd.c\n===================================================================\n--- branches/SAMBA_3_0/source/nsswitch/winbindd.c\t2007-04-12 19:54:15 UTC (rev 22203)\n+++ branches/SAMBA_3_0/source/nsswitch/winbindd.c\t2007-04-12 21:10:06 UTC (rev 22204)\n@@ -1010,6 +1010,9 @@\n \n \tnamecache_enable();\n \n+\t/* quick hack to avoid a loop in idmap, proper fix later */\n+\treset_idmap_in_own_child();\n+\n \t/* Winbind daemon initialisation */\n \n \tif ( ! NT_STATUS_IS_OK(idmap_init_cache()) ) {\n\nModified: branches/SAMBA_3_0/source/nsswitch/winbindd_dual.c\n===================================================================\n--- branches/SAMBA_3_0/source/nsswitch/winbindd_dual.c\t2007-04-12 19:54:15 UTC (rev 22203)\n+++ branches/SAMBA_3_0/source/nsswitch/winbindd_dual.c\t2007-04-12 21:10:06 UTC (rev 22204)\n@@ -921,6 +921,9 @@\n \t\t\tchild);\n \t}\n \n+\t/* quick hack to avoid a loop in idmap, proper fix later */\n+\tset_idmap_in_own_child();\n+\n \twhile (1) {\n \n \t\tint ret;\n\nModified: branches/SAMBA_3_0_25/source/nsswitch/idmap.c\n===================================================================\n--- branches/SAMBA_3_0_25/source/nsswitch/idmap.c\t2007-04-12 19:54:15 UTC (rev 22203)\n+++ branches/SAMBA_3_0_25/source/nsswitch/idmap.c\t2007-04-12 21:10:06 UTC (rev 22204)\n@@ -84,6 +84,24 @@\n \treturn NULL;\n }\n \n+/* part of a quick hack to avoid loops, need to be sorted out correctly later on */\n+static BOOL idmap_in_own_child;\n+\n+static BOOL idmap_is_in_own_child(void)\n+{\n+\treturn idmap_in_own_child;\n+}\n+\n+void reset_idmap_in_own_child(void)\n+{\n+\tidmap_in_own_child = False;\n+}\n+\n+void set_idmap_in_own_child(void)\n+{\n+\tidmap_in_own_child = True;\n+}\n+\n /**********************************************************************\n  Allow a module to register itself as a method.\n **********************************************************************/\n@@ -801,13 +819,18 @@\n \tif ( ! NT_STATUS_IS_OK(ret)) {\n \t\treturn NT_STATUS_NONE_MAPPED;\n \t}\n-\t\n-\t/* by default calls to winbindd are disabled\n-\t   the following call will not recurse so this is safe */\n-\twinbind_on();\n-\twbret = winbind_lookup_sid(ctx, map->sid, &domname, &name, &sid_type);\n-\twinbind_off();\n \n+\t/* quick hack to make things work, will need proper fix later on */\t\n+\tif (idmap_is_in_own_child()) {\n+\t\t/* by default calls to winbindd are disabled\n+\t\t   the following call will not recurse so this is safe */\n+\t\twinbind_on();\n+\t\twbret = winbind_lookup_sid(ctx, map->sid, &domname, &name, &sid_type);\n+\t\twinbind_off();\n+\t} else {\n+\t\twbret = winbindd_lookup_name_by_sid(ctx, map->sid, &domname, &name, &sid_type);\n+\t}\n+\n \t/* check if this is a valid SID and then map it */\n \tif (wbret) {\n \t\tswitch (sid_type) {\n@@ -1395,3 +1418,4 @@\n \n \treturn ret;\n }\n+\n\nModified: branches/SAMBA_3_0_25/source/nsswitch/winbindd.c\n===================================================================\n--- branches/SAMBA_3_0_25/source/nsswitch/winbindd.c\t2007-04-12 19:54:15 UTC (rev 22203)\n+++ branches/SAMBA_3_0_25/source/nsswitch/winbindd.c\t2007-04-12 21:10:06 UTC (rev 22204)\n@@ -1010,6 +1010,9 @@\n \n \tnamecache_enable();\n \n+\t/* quick hack to avoid a loop in idmap, proper fix later */\n+\treset_idmap_in_own_child();\n+\n \t/* Winbind daemon initialisation */\n \n \tif ( ! NT_STATUS_IS_OK(idmap_init_cache()) ) {\n\nModified: branches/SAMBA_3_0_25/source/nsswitch/winbindd_dual.c\n===================================================================\n--- branches/SAMBA_3_0_25/source/nsswitch/winbindd_dual.c\t2007-04-12 19:54:15 UTC (rev 22203)\n+++ branches/SAMBA_3_0_25/source/nsswitch/winbindd_dual.c\t2007-04-12 21:10:06 UTC (rev 22204)\n@@ -921,6 +921,9 @@\n \t\t\tchild);\n \t}\n \n+\t/* quick hack to avoid a loop in idmap, proper fix later */\n+\tset_idmap_in_own_child();\n+\n \twhile (1) {\n \n \t\tint ret;\n\n"}