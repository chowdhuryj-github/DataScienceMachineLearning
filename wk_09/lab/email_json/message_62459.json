{"category": "ham", "to_address": "abartlet@samba.org, simo@samba.org", "from_address": "tridge@samba.org", "subject": "samdb and the session info", "body": "Andrew and Simo,\n\nI've been looking into memory usage in Samba4. When we first got the\nsingle process model I had measured memory usage of about 15k-20k per\nconnection (as seen with vmstat and BASE-BENCH-HOLDCON).\n\nA test on the current code shows 312k per connection. Approximately\n90% of this is due to samdb_connect().\n\nBy making a small (hackish) patch to samdb_connect() to use a shared\nldb with talloc_reference(), I found that memory usage dropped to 26k\nper connection, which is not too much bloat over what we had before\nconsidering the new features. It also halved the time it takes to\nestablish 1000 connections, and I expect it will greatly speed up many\nother operations (as much more memory will be in level 1 cache).\n\nThe problem is the session_info argument to samdb_connect(). That\nargument is put into the ldb using ldb_set_opaque() then it is used to\nget the current credentials for many operations. For my hack I used\nsystem_session() for all ldb contexts, which is obviously not a good\nsolution!\n\nSo, I'd like to look at ways of getting the session_info argument out\nof samdb_connect(), and in general remove any connection or user\nspecific attributes to the ldb context itself. Obviously we could use\na global instead of the ldb opaque approach, but I'd like to see if we\ncan find a neater way.\n\nCheers, Tridge\n\n"}