{"category": "ham", "to_address": "samba-cvs@samba.org", "from_address": "tridge@samba.org", "subject": "Rev 484: update flags in parent daemon too in\n\thttp://samba.org/~tridge/ctdb", "body": "------------------------------------------------------------\nrevno: 484\nrevision-id: tridge@samba.org-20070606113436-6bo9s8zewul2xwjk\nparent: tridge@samba.org-20070606112709-klp56ghkr55r3m4d\ncommitter: Andrew Tridgell \nbranch nick: tridge\ntimestamp: Wed 2007-06-06 21:34:36 +1000\nmessage:\n  update flags in parent daemon too\nmodified:\n  common/ctdb_daemon.c           ctdb_daemon.c-20070409200331-3el1kqgdb9m4ib0g-1\n=== modified file 'common/ctdb_daemon.c'\n--- a/common/ctdb_daemon.c\t2007-06-06 03:45:12 +0000\n+++ b/common/ctdb_daemon.c\t2007-06-06 11:34:36 +0000\n@@ -31,6 +31,25 @@\n \n static void daemon_incoming_packet(void *, struct ctdb_req_header *);\n \n+/*\n+  handler for when a node changes its flags\n+*/\n+static void flag_change_handler(struct ctdb_context *ctdb, uint64_t srvid, \n+\t\t\t\tTDB_DATA data, void *private_data)\n+{\n+\tstruct ctdb_node_flag_change *c = (struct ctdb_node_flag_change *)data.dptr;\n+\n+\tif (data.dsize != sizeof(*c) || !ctdb_validate_vnn(ctdb, c->vnn)) {\n+\t\tDEBUG(0,(__location__ \"Invalid data in ctdb_node_flag_change\\n\"));\n+\t\treturn;\n+\t}\n+\n+\t/* don't get the connected flag from the other node */\n+\tctdb->nodes[c->vnn]->flags = \n+\t\t(ctdb->nodes[c->vnn]->flags&NODE_FLAGS_CONNECTED) \n+\t\t| (c->flags & ~NODE_FLAGS_CONNECTED);\t\n+}\n+\n /* called when the \"startup\" event script has finished */\n static void ctdb_start_transport(struct ctdb_context *ctdb, int status, void *p)\n {\n@@ -51,6 +70,10 @@\n \t\texit(11);\n \t}\n \n+\t/* a handler for when nodes are disabled/enabled */\n+\tctdb_register_message_handler(ctdb, ctdb, CTDB_SRVID_NODE_FLAGS_CHANGED, \n+\t\t\t\t      flag_change_handler, NULL);\n+\n \t/* start monitoring for dead nodes */\n \tctdb_start_monitoring(ctdb);\n }\n\n"}