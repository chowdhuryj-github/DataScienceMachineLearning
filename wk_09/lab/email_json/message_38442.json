{"category": "ham", "to_address": "samba-cvs@samba.org", "from_address": "jerry@samba.org", "subject": "svn commit: samba r23227 - in\n\tbranches/SAMBA_3_0_26/source/rpc_server: .", "body": "Author: jerry\nDate: 2007-05-29 19:48:34 +0000 (Tue, 29 May 2007)\nNew Revision: 23227\n\nWebSVN: http://websvn.samba.org/cgi-bin/viewcvs.cgi?view=rev&root=samba&rev=23227\n\nLog:\nmerge current user to pipe_user changes on the lsa server pipe\nModified:\n   branches/SAMBA_3_0_26/source/rpc_server/srv_lsa_nt.c\n\n\nChangeset:\nModified: branches/SAMBA_3_0_26/source/rpc_server/srv_lsa_nt.c\n===================================================================\n--- branches/SAMBA_3_0_26/source/rpc_server/srv_lsa_nt.c\t2007-05-29 19:36:13 UTC (rev 23226)\n+++ branches/SAMBA_3_0_26/source/rpc_server/srv_lsa_nt.c\t2007-05-29 19:48:34 UTC (rev 23227)\n@@ -544,7 +544,7 @@\n \tlsa_get_generic_sd(p->mem_ctx, &psd, &sd_size);\n \n \tif(!se_access_check(psd, p->pipe_user.nt_user_token, des_access, &acc_granted, &status)) {\n-\t\tif (geteuid() != 0) {\n+\t\tif (p->pipe_user.ut.uid != sec_initial_uid()) {\n \t\t\treturn status;\n \t\t}\n \t\tDEBUG(4,(\"ACCESS should be DENIED (granted: %#010x;  required: %#010x)\\n\",\n@@ -554,7 +554,7 @@\n \n \t/* This is needed for lsa_open_account and rpcclient .... :-) */\n \n-\tif (geteuid() == 0)\n+\tif (p->pipe_user.ut.uid == sec_initial_uid())\n \t\tacc_granted = POLICY_ALL_ACCESS;\n \n \t/* associate the domain SID with the (unique) handle. */\n@@ -875,7 +875,12 @@\n \n \t\tif (name->type == SID_NAME_UNKNOWN) {\n \t\t\tname->dom_idx = -1;\n-\t\t\t/* unknown sids should return the string representation of the SID */\n+\t\t\t/* Unknown sids should return the string\n+\t\t\t * representation of the SID. Windows 2003 behaves\n+\t\t\t * rather erratic here, in many cases it returns the\n+\t\t\t * RID as 8 bytes hex, in others it returns the full\n+\t\t\t * SID. We (Jerry/VL) could not figure out which the\n+\t\t\t * hard cases are, so leave it with the SID.  */\n \t\t\tname->name = talloc_asprintf(p->mem_ctx, \"%s\", \n \t\t\t                             sid_string_static(sids[i]));\n \t\t\tif (name->name == NULL) {\n@@ -1769,7 +1774,6 @@\n \tstruct lsa_info *info = NULL;\n \tSE_PRIV mask;\n \tPRIVILEGE_SET *set = NULL;\n-\tstruct current_user user;\n \n \t/* find the connection policy handle. */\n \tif (!find_policy_by_hnd(p, &q_u->pol, (void **)(void *)&info))\n@@ -1778,8 +1782,7 @@\n \t/* check to see if the pipe_user is root or a Domain Admin since \n \t   account_pol.tdb was already opened as root, this is all we have */\n \t   \n-\tget_current_user( &user, p );\n-\tif ( user.ut.uid != sec_initial_uid() \n+\tif ( p->pipe_user.ut.uid != sec_initial_uid() \n \t\t&& !nt_token_check_domain_rid( p->pipe_user.nt_user_token, DOMAIN_GROUP_RID_ADMINS ) )\n \t{\n \t\treturn NT_STATUS_ACCESS_DENIED;\n@@ -1810,7 +1813,6 @@\n \tstruct lsa_info *info = NULL;\n \tSE_PRIV mask;\n \tPRIVILEGE_SET *set = NULL;\n-\tstruct current_user user;\n \n \t/* find the connection policy handle. */\n \tif (!find_policy_by_hnd(p, &q_u->pol, (void **)(void *)&info))\n@@ -1819,8 +1821,7 @@\n \t/* check to see if the pipe_user is root or a Domain Admin since \n \t   account_pol.tdb was already opened as root, this is all we have */\n \t   \n-\tget_current_user( &user, p );\n-\tif ( user.ut.uid != sec_initial_uid()\n+\tif ( p->pipe_user.ut.uid != sec_initial_uid()\n \t\t&& !nt_token_check_domain_rid( p->pipe_user.nt_user_token, DOMAIN_GROUP_RID_ADMINS ) ) \n \t{\n \t\treturn NT_STATUS_ACCESS_DENIED;\n@@ -1971,7 +1972,6 @@\n \tDOM_SID sid;\n \tfstring privname;\n \tUNISTR4_ARRAY *uni_privnames = q_u->rights;\n-\tstruct current_user user;\n \t\n \n \t/* find the connection policy handle. */\n@@ -1981,8 +1981,7 @@\n \t/* check to see if the pipe_user is a Domain Admin since \n \t   account_pol.tdb was already opened as root, this is all we have */\n \t   \n-\tget_current_user( &user, p );\n-\tif ( user.ut.uid != sec_initial_uid()\n+\tif ( p->pipe_user.ut.uid != sec_initial_uid()\n \t\t&& !nt_token_check_domain_rid( p->pipe_user.nt_user_token, DOMAIN_GROUP_RID_ADMINS ) ) \n \t{\n \t\treturn NT_STATUS_ACCESS_DENIED;\n@@ -2029,7 +2028,6 @@\n \tDOM_SID sid;\n \tfstring privname;\n \tUNISTR4_ARRAY *uni_privnames = q_u->rights;\n-\tstruct current_user user;\n \t\n \n \t/* find the connection policy handle. */\n@@ -2039,8 +2037,7 @@\n \t/* check to see if the pipe_user is a Domain Admin since \n \t   account_pol.tdb was already opened as root, this is all we have */\n \t   \n-\tget_current_user( &user, p );\n-\tif ( user.ut.uid != sec_initial_uid()\n+\tif ( p->pipe_user.ut.uid != sec_initial_uid()\n \t\t&& !nt_token_check_domain_rid( p->pipe_user.nt_user_token, DOMAIN_GROUP_RID_ADMINS ) )\n \t{\n \t\treturn NT_STATUS_ACCESS_DENIED;\n\n"}