{"category": "ham", "to_address": "samba-cvs@samba.org", "from_address": "vlendec@samba.org", "subject": "svn commit: samba r22908 - in branches: SAMBA_3_0/source/lib\n\tSAMBA_3_0/source/libsmb SAMBA_3_0/source/nmbd\n\tSAMBA_3_0/source/nsswitch SAMBA_3_0/source/smbd\n\tSAMBA_3_0/source/torture SAMBA_3_0/source/utils\n\tSAMBA_3_0_26/source/lib SAMBA_3_0_26/source/libsmb\n\tSAMBA_3_0_26/source/nmbd SAMBA_3_0_26/source/nsswitch\n\tSAMBA_3_0_26/source/smbd SAMBA_3_0_26/source/torture\n\tSAMBA_3_0_26/source/utils", "body": "Author: vlendec\nDate: 2007-05-15 15:14:32 +0000 (Tue, 15 May 2007)\nNew Revision: 22908\n\nWebSVN: http://websvn.samba.org/cgi-bin/viewcvs.cgi?view=rev&root=samba&rev=22908\n\nLog:\nAll callers of message_init now also call messaging_init. Unify those.\n\nModified:\n   branches/SAMBA_3_0/source/lib/debug.c\n   branches/SAMBA_3_0/source/lib/messages.c\n   branches/SAMBA_3_0/source/libsmb/clidgram.c\n   branches/SAMBA_3_0/source/nmbd/nmbd.c\n   branches/SAMBA_3_0/source/nsswitch/winbindd.c\n   branches/SAMBA_3_0/source/smbd/server.c\n   branches/SAMBA_3_0/source/torture/msgtest.c\n   branches/SAMBA_3_0/source/utils/smbcontrol.c\n   branches/SAMBA_3_0_26/source/lib/debug.c\n   branches/SAMBA_3_0_26/source/lib/messages.c\n   branches/SAMBA_3_0_26/source/libsmb/clidgram.c\n   branches/SAMBA_3_0_26/source/nmbd/nmbd.c\n   branches/SAMBA_3_0_26/source/nsswitch/winbindd.c\n   branches/SAMBA_3_0_26/source/smbd/server.c\n   branches/SAMBA_3_0_26/source/torture/msgtest.c\n   branches/SAMBA_3_0_26/source/utils/smbcontrol.c\n\n\nChangeset:\nModified: branches/SAMBA_3_0/source/lib/debug.c\n===================================================================\n--- branches/SAMBA_3_0/source/lib/debug.c\t2007-05-15 14:58:01 UTC (rev 22907)\n+++ branches/SAMBA_3_0/source/lib/debug.c\t2007-05-15 15:14:32 UTC (rev 22908)\n@@ -492,19 +492,6 @@\n }\n \n /****************************************************************************\n- Send a \"set debug level\" message.\n-****************************************************************************/\n-\n-void debug_message_send(pid_t pid, const char *params_str)\n-{\n-\tif (!params_str)\n-\t\treturn;\n-\tmessage_send_pid(pid_to_procid(pid), MSG_DEBUG,\n-\t\t\t params_str, strlen(params_str) + 1,\n-\t\t\t False);\n-}\n-\n-/****************************************************************************\n  Return current debug level.\n ****************************************************************************/\n \n@@ -539,14 +526,17 @@\n \n \tinitialised = True;\n \n-\tmessage_register(MSG_DEBUG, debug_message, NULL);\n-\tmessage_register(MSG_REQ_DEBUGLEVEL, debuglevel_message, NULL);\n-\n \tfor(p = default_classname_table; *p; p++) {\n \t\tdebug_add_class(*p);\n \t}\n }\n \n+void debug_register_msgs(void)\n+{\n+\tmessage_register(MSG_DEBUG, debug_message, NULL);\n+\tmessage_register(MSG_REQ_DEBUGLEVEL, debuglevel_message, NULL);\n+}\n+\n /***************************************************************************\n  Get ready for syslog stuff\n **************************************************************************/\n\nModified: branches/SAMBA_3_0/source/lib/messages.c\n===================================================================\n--- branches/SAMBA_3_0/source/lib/messages.c\t2007-05-15 14:58:01 UTC (rev 22907)\n+++ branches/SAMBA_3_0/source/lib/messages.c\t2007-05-15 15:14:32 UTC (rev 22908)\n@@ -117,7 +117,7 @@\n  Initialise the messaging functions. \n ****************************************************************************/\n \n-BOOL message_init(void)\n+static BOOL message_init(struct messaging_context *msg_ctx)\n {\n \tsec_init();\n \n@@ -144,6 +144,7 @@\n \n \tregister_msg_pool_usage();\n \tregister_dmalloc_msgs();\n+\tdebug_register_msgs();\n \n \treturn True;\n }\n@@ -757,6 +758,12 @@\n \n \tctx->id = server_id;\n \ttalloc_set_destructor(ctx, messaging_context_destructor);\n+\n+\tif (!message_init(ctx)) {\n+\t\tDEBUG(0, (\"message_init failed: %s\\n\", strerror(errno)));\n+\t\tTALLOC_FREE(ctx);\n+\t}\n+\n \treturn ctx;\n }\n \n\nModified: branches/SAMBA_3_0/source/libsmb/clidgram.c\n===================================================================\n--- branches/SAMBA_3_0/source/libsmb/clidgram.c\t2007-05-15 14:58:01 UTC (rev 22907)\n+++ branches/SAMBA_3_0/source/libsmb/clidgram.c\t2007-05-15 15:14:32 UTC (rev 22908)\n@@ -45,9 +45,6 @@\n \t\treturn False;\n \t}\n \n-\tif (!message_init())\n-\t\treturn False;\n-\n \tmemset((char *)&p, '\\0', sizeof(p));\n \n \t/*\n\nModified: branches/SAMBA_3_0/source/nmbd/nmbd.c\n===================================================================\n--- branches/SAMBA_3_0/source/nmbd/nmbd.c\t2007-05-15 14:58:01 UTC (rev 22907)\n+++ branches/SAMBA_3_0/source/nmbd/nmbd.c\t2007-05-15 15:14:32 UTC (rev 22908)\n@@ -753,7 +753,6 @@\n \t\tsetpgid( (pid_t)0, (pid_t)0 );\n #endif\n \n-\tmessage_init();\n \tif (nmbd_messaging_context() == NULL) {\n \t\treturn 1;\n \t}\n\nModified: branches/SAMBA_3_0/source/nsswitch/winbindd.c\n===================================================================\n--- branches/SAMBA_3_0/source/nsswitch/winbindd.c\t2007-05-15 14:58:01 UTC (rev 22907)\n+++ branches/SAMBA_3_0/source/nsswitch/winbindd.c\t2007-05-15 15:14:32 UTC (rev 22908)\n@@ -1125,7 +1125,7 @@\n \n \t/* Initialise messaging system */\n \n-\tif (!message_init()) {\n+\tif (winbind_messaging_context() == NULL) {\n \t\tDEBUG(0, (\"unable to initialize messaging system\\n\"));\n \t\texit(1);\n \t}\n\nModified: branches/SAMBA_3_0/source/smbd/server.c\n===================================================================\n--- branches/SAMBA_3_0/source/smbd/server.c\t2007-05-15 14:58:01 UTC (rev 22907)\n+++ branches/SAMBA_3_0/source/smbd/server.c\t2007-05-15 15:14:32 UTC (rev 22908)\n@@ -967,7 +967,7 @@\n \t}\n \n \t/* Setup all the TDB's - including CLEAR_IF_FIRST tdb's. */\n-\tif (!message_init())\n+\tif (smbd_messaging_context() == NULL)\n \t\texit(1);\n \n \t/* Initialise the password backed before the global_sam_sid\n\nModified: branches/SAMBA_3_0/source/torture/msgtest.c\n===================================================================\n--- branches/SAMBA_3_0/source/torture/msgtest.c\t2007-05-15 14:58:01 UTC (rev 22907)\n+++ branches/SAMBA_3_0/source/torture/msgtest.c\t2007-05-15 15:14:32 UTC (rev 22908)\n@@ -52,8 +52,6 @@\n \t\n \tlp_load(dyn_CONFIGFILE,False,False,False,True);\n \n-\tmessage_init();\n-\n \tif (!(evt_ctx = event_context_init(NULL)) ||\n \t    !(msg_ctx = messaging_init(NULL, server_id_self(), evt_ctx))) {\n \t\tfprintf(stderr, \"could not init messaging context\\n\");\n\nModified: branches/SAMBA_3_0/source/utils/smbcontrol.c\n===================================================================\n--- branches/SAMBA_3_0/source/utils/smbcontrol.c\t2007-05-15 14:58:01 UTC (rev 22907)\n+++ branches/SAMBA_3_0/source/utils/smbcontrol.c\t2007-05-15 15:14:32 UTC (rev 22908)\n@@ -55,9 +55,6 @@\n \tBOOL ret;\n \tint n_sent = 0;\n \n-\tif (!message_init())\n-\t\treturn False;\n-\n \tif (procid_to_pid(&pid) != 0)\n \t\treturn NT_STATUS_IS_OK(\n \t\t\tmessaging_send_buf(msg_ctx, pid, msg_type,\n\nModified: branches/SAMBA_3_0_26/source/lib/debug.c\n===================================================================\n--- branches/SAMBA_3_0_26/source/lib/debug.c\t2007-05-15 14:58:01 UTC (rev 22907)\n+++ branches/SAMBA_3_0_26/source/lib/debug.c\t2007-05-15 15:14:32 UTC (rev 22908)\n@@ -492,19 +492,6 @@\n }\n \n /****************************************************************************\n- Send a \"set debug level\" message.\n-****************************************************************************/\n-\n-void debug_message_send(pid_t pid, const char *params_str)\n-{\n-\tif (!params_str)\n-\t\treturn;\n-\tmessage_send_pid(pid_to_procid(pid), MSG_DEBUG,\n-\t\t\t params_str, strlen(params_str) + 1,\n-\t\t\t False);\n-}\n-\n-/****************************************************************************\n  Return current debug level.\n ****************************************************************************/\n \n@@ -539,14 +526,17 @@\n \n \tinitialised = True;\n \n-\tmessage_register(MSG_DEBUG, debug_message, NULL);\n-\tmessage_register(MSG_REQ_DEBUGLEVEL, debuglevel_message, NULL);\n-\n \tfor(p = default_classname_table; *p; p++) {\n \t\tdebug_add_class(*p);\n \t}\n }\n \n+void debug_register_msgs(void)\n+{\n+\tmessage_register(MSG_DEBUG, debug_message, NULL);\n+\tmessage_register(MSG_REQ_DEBUGLEVEL, debuglevel_message, NULL);\n+}\n+\n /***************************************************************************\n  Get ready for syslog stuff\n **************************************************************************/\n\nModified: branches/SAMBA_3_0_26/source/lib/messages.c\n===================================================================\n--- branches/SAMBA_3_0_26/source/lib/messages.c\t2007-05-15 14:58:01 UTC (rev 22907)\n+++ branches/SAMBA_3_0_26/source/lib/messages.c\t2007-05-15 15:14:32 UTC (rev 22908)\n@@ -117,7 +117,7 @@\n  Initialise the messaging functions. \n ****************************************************************************/\n \n-BOOL message_init(void)\n+static BOOL message_init(struct messaging_context *msg_ctx)\n {\n \tsec_init();\n \n@@ -144,6 +144,7 @@\n \n \tregister_msg_pool_usage();\n \tregister_dmalloc_msgs();\n+\tdebug_register_msgs();\n \n \treturn True;\n }\n@@ -757,6 +758,12 @@\n \n \tctx->id = server_id;\n \ttalloc_set_destructor(ctx, messaging_context_destructor);\n+\n+\tif (!message_init(ctx)) {\n+\t\tDEBUG(0, (\"message_init failed: %s\\n\", strerror(errno)));\n+\t\tTALLOC_FREE(ctx);\n+\t}\n+\n \treturn ctx;\n }\n \n\nModified: branches/SAMBA_3_0_26/source/libsmb/clidgram.c\n===================================================================\n--- branches/SAMBA_3_0_26/source/libsmb/clidgram.c\t2007-05-15 14:58:01 UTC (rev 22907)\n+++ branches/SAMBA_3_0_26/source/libsmb/clidgram.c\t2007-05-15 15:14:32 UTC (rev 22908)\n@@ -45,9 +45,6 @@\n \t\treturn False;\n \t}\n \n-\tif (!message_init())\n-\t\treturn False;\n-\n \tmemset((char *)&p, '\\0', sizeof(p));\n \n \t/*\n\nModified: branches/SAMBA_3_0_26/source/nmbd/nmbd.c\n===================================================================\n--- branches/SAMBA_3_0_26/source/nmbd/nmbd.c\t2007-05-15 14:58:01 UTC (rev 22907)\n+++ branches/SAMBA_3_0_26/source/nmbd/nmbd.c\t2007-05-15 15:14:32 UTC (rev 22908)\n@@ -752,7 +752,6 @@\n \t\tsetpgid( (pid_t)0, (pid_t)0 );\n #endif\n \n-\tmessage_init();\n \tif (nmbd_messaging_context() == NULL) {\n \t\treturn 1;\n \t}\n\nModified: branches/SAMBA_3_0_26/source/nsswitch/winbindd.c\n===================================================================\n--- branches/SAMBA_3_0_26/source/nsswitch/winbindd.c\t2007-05-15 14:58:01 UTC (rev 22907)\n+++ branches/SAMBA_3_0_26/source/nsswitch/winbindd.c\t2007-05-15 15:14:32 UTC (rev 22908)\n@@ -1070,7 +1070,7 @@\n \n \t/* Initialise messaging system */\n \n-\tif (!message_init()) {\n+\tif (winbind_messaging_context() == NULL) {\n \t\tDEBUG(0, (\"unable to initialize messaging system\\n\"));\n \t\texit(1);\n \t}\n\nModified: branches/SAMBA_3_0_26/source/smbd/server.c\n===================================================================\n--- branches/SAMBA_3_0_26/source/smbd/server.c\t2007-05-15 14:58:01 UTC (rev 22907)\n+++ branches/SAMBA_3_0_26/source/smbd/server.c\t2007-05-15 15:14:32 UTC (rev 22908)\n@@ -1015,7 +1015,7 @@\n \t\tpidfile_create(\"smbd\");\n \n \t/* Setup all the TDB's - including CLEAR_IF_FIRST tdb's. */\n-\tif (!message_init())\n+\tif (smbd_messaging_context() == NULL)\n \t\texit(1);\n \n \t/* Initialise the password backed before the global_sam_sid\n\nModified: branches/SAMBA_3_0_26/source/torture/msgtest.c\n===================================================================\n--- branches/SAMBA_3_0_26/source/torture/msgtest.c\t2007-05-15 14:58:01 UTC (rev 22907)\n+++ branches/SAMBA_3_0_26/source/torture/msgtest.c\t2007-05-15 15:14:32 UTC (rev 22908)\n@@ -52,8 +52,6 @@\n \t\n \tlp_load(dyn_CONFIGFILE,False,False,False,True);\n \n-\tmessage_init();\n-\n \tif (!(evt_ctx = event_context_init(NULL)) ||\n \t    !(msg_ctx = messaging_init(NULL, server_id_self(), evt_ctx))) {\n \t\tfprintf(stderr, \"could not init messaging context\\n\");\n\nModified: branches/SAMBA_3_0_26/source/utils/smbcontrol.c\n===================================================================\n--- branches/SAMBA_3_0_26/source/utils/smbcontrol.c\t2007-05-15 14:58:01 UTC (rev 22907)\n+++ branches/SAMBA_3_0_26/source/utils/smbcontrol.c\t2007-05-15 15:14:32 UTC (rev 22908)\n@@ -55,9 +55,6 @@\n \tBOOL ret;\n \tint n_sent = 0;\n \n-\tif (!message_init())\n-\t\treturn False;\n-\n \tif (procid_to_pid(&pid) != 0)\n \t\treturn NT_STATUS_IS_OK(\n \t\t\tmessaging_send_buf(msg_ctx, pid, msg_type,\n\n"}