{"category": "ham", "to_address": "samba-cvs@samba.org", "from_address": "tridge@samba.org", "subject": "svn commit: samba r23697 - in\n\tbranches/SAMBA_4_0/source/ntvfs/posix: .", "body": "Author: tridge\nDate: 2007-07-04 04:16:16 +0000 (Wed, 04 Jul 2007)\nNew Revision: 23697\n\nWebSVN: http://websvn.samba.org/cgi-bin/viewcvs.cgi?view=rev&root=samba&rev=23697\n\nLog:\n\nuse the file perm options in the posix backend\n\nModified:\n   branches/SAMBA_4_0/source/ntvfs/posix/pvfs_fileinfo.c\n   branches/SAMBA_4_0/source/ntvfs/posix/vfs_posix.c\n   branches/SAMBA_4_0/source/ntvfs/posix/vfs_posix.h\n\n\nChangeset:\nModified: branches/SAMBA_4_0/source/ntvfs/posix/pvfs_fileinfo.c\n===================================================================\n--- branches/SAMBA_4_0/source/ntvfs/posix/pvfs_fileinfo.c\t2007-07-04 04:15:07 UTC (rev 23696)\n+++ branches/SAMBA_4_0/source/ntvfs/posix/pvfs_fileinfo.c\t2007-07-04 04:16:16 UTC (rev 23697)\n@@ -88,34 +88,39 @@\n */\n mode_t pvfs_fileperms(struct pvfs_state *pvfs, uint32_t attrib)\n {\n-\tmode_t mode = S_IRUSR;\n+\tmode_t mode = (S_IRUSR | S_IRGRP | S_IROTH | S_IWUSR | S_IWGRP | S_IWOTH);\n \n-\tif (attrib & FILE_ATTRIBUTE_DIRECTORY) {\n-\t\tmode |= S_IXUSR;\n+\tif (!(pvfs->flags & PVFS_FLAG_XATTR_ENABLE) &&\n+\t    (attrib & FILE_ATTRIBUTE_READONLY)) {\n+\t\tmode &= ~(S_IWUSR | S_IWGRP | S_IWOTH);\n \t}\n \n-\tif (!(attrib & FILE_ATTRIBUTE_READONLY) ||\n-\t    (pvfs->flags & PVFS_FLAG_XATTR_ENABLE)) {\n-\t\tmode |= S_IWUSR;\n-\t}\n-\n \tif (!(pvfs->flags & PVFS_FLAG_XATTR_ENABLE)) {\n \t\tif ((attrib & FILE_ATTRIBUTE_ARCHIVE) &&\n \t\t    (pvfs->flags & PVFS_FLAG_MAP_ARCHIVE)) {\n \t\t\tmode |= S_IXUSR;\n \t\t}\n-\t\t\n \t\tif ((attrib & FILE_ATTRIBUTE_SYSTEM) &&\n \t\t    (pvfs->flags & PVFS_FLAG_MAP_SYSTEM)) {\n \t\t\tmode |= S_IXGRP;\n \t\t}\n-\t\t\n \t\tif ((attrib & FILE_ATTRIBUTE_HIDDEN) &&\n \t\t    (pvfs->flags & PVFS_FLAG_MAP_HIDDEN)) {\n \t\t\tmode |= S_IXOTH;\n \t\t}\n \t}\n \n+\tif (attrib & FILE_ATTRIBUTE_DIRECTORY) {\n+\t\tmode |= (S_IFDIR | S_IWUSR);\n+\t\tmode |= (S_IXUSR | S_IXGRP | S_IXOTH);                 \n+\t\tmode &= pvfs->options.dir_mask;\n+\t\tmode |= pvfs->options.force_dir_mode;\n+\t} else {\n+\t\tmode &= pvfs->options.create_mask;\n+\t\tmode |= pvfs->options.force_create_mode;\n+\t}\n+\n \treturn mode;\n }\n \n+\n\nModified: branches/SAMBA_4_0/source/ntvfs/posix/vfs_posix.c\n===================================================================\n--- branches/SAMBA_4_0/source/ntvfs/posix/vfs_posix.c\t2007-07-04 04:15:07 UTC (rev 23696)\n+++ branches/SAMBA_4_0/source/ntvfs/posix/vfs_posix.c\t2007-07-04 04:16:16 UTC (rev 23697)\n@@ -60,6 +60,19 @@\n \tif (share_bool_option(scfg, PVFS_AIO, False))\n \t\tpvfs->flags |= PVFS_FLAG_LINUX_AIO;\n \n+\t/* file perm options */\n+\tpvfs->options.create_mask       = share_int_option(scfg,\n+\t\t\t\t\t\t\t   SHARE_CREATE_MASK,\n+\t\t\t\t\t\t\t   SHARE_CREATE_MASK_DEFAULT);\n+\tpvfs->options.dir_mask          = share_int_option(scfg,\n+\t\t\t\t\t\t\t   SHARE_DIR_MASK,\n+\t\t\t\t\t\t\t   SHARE_DIR_MASK_DEFAULT);\n+\tpvfs->options.force_dir_mode    = share_int_option(scfg,\n+\t\t\t\t\t\t\t   SHARE_FORCE_DIR_MODE,\n+\t\t\t\t\t\t\t   SHARE_FORCE_DIR_MODE_DEFAULT);\n+\tpvfs->options.force_create_mode = share_int_option(scfg,\n+\t\t\t\t\t\t\t   SHARE_FORCE_CREATE_MODE,\n+\t\t\t\t\t\t\t   SHARE_FORCE_CREATE_MODE_DEFAULT);\n \t/* this must be a power of 2 */\n \tpvfs->alloc_size_rounding = share_int_option(scfg,\n \t\t\t\t\t\t\tPVFS_ALLOCATION_ROUNDING,\n\nModified: branches/SAMBA_4_0/source/ntvfs/posix/vfs_posix.h\n===================================================================\n--- branches/SAMBA_4_0/source/ntvfs/posix/vfs_posix.h\t2007-07-04 04:15:07 UTC (rev 23696)\n+++ branches/SAMBA_4_0/source/ntvfs/posix/vfs_posix.h\t2007-07-04 04:16:16 UTC (rev 23697)\n@@ -86,6 +86,14 @@\n \n \t/* the acl backend */\n \tconst struct pvfs_acl_ops *acl_ops;\n+\n+\t/* non-flag share options */\n+\tstruct {\n+\t\tmode_t dir_mask;\n+\t\tmode_t force_dir_mode;\n+\t\tmode_t create_mask;\n+\t\tmode_t force_create_mode;\n+\t} options;\n };\n \n /* this is the basic information needed about a file from the filesystem */\n\n"}