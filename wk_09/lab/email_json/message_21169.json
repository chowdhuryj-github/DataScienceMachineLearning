{"category": "ham", "to_address": "samba-cvs@samba.org", "from_address": "metze@samba.org", "subject": "svn commit: samba r22621 - in branches/SAMBA_4_0/source/auth: .", "body": "Author: metze\nDate: 2007-05-01 03:22:17 +0000 (Tue, 01 May 2007)\nNew Revision: 22621\n\nWebSVN: http://websvn.samba.org/cgi-bin/viewcvs.cgi?view=rev&root=samba&rev=22621\n\nLog:\nfix the 'sam' auth module\n\nmetze\nModified:\n   branches/SAMBA_4_0/source/auth/auth_sam.c\n\n\nChangeset:\nModified: branches/SAMBA_4_0/source/auth/auth_sam.c\n===================================================================\n--- branches/SAMBA_4_0/source/auth/auth_sam.c\t2007-05-01 02:08:11 UTC (rev 22620)\n+++ branches/SAMBA_4_0/source/auth/auth_sam.c\t2007-05-01 03:22:17 UTC (rev 22621)\n@@ -56,24 +56,9 @@\n \n \tif (domain_name) {\n \t\tdomain_dn = samdb_domain_to_dn(sam_ctx, mem_ctx, domain_name);\n-\n-\t\t/* find the domain's DN */\n-\t\tret_domain = gendb_search_dn(sam_ctx, mem_ctx, domain_dn, &msgs_domain_ref, domain_ref_attrs);\n-\t\tif (ret_domain == -1) {\n+\t\tif (!domain_dn) {\n \t\t\treturn NT_STATUS_INTERNAL_DB_CORRUPTION;\n \t\t}\n-\n-\t\tif (ret_domain == 0) {\n-\t\t\tDEBUG(3,(\"sam_search_user: Couldn't find domain [%s] in samdb.\\n\", \n-\t\t\t\t domain_name));\n-\t\t\treturn NT_STATUS_NO_SUCH_USER;\n-\t\t}\n-\n-\t\tif (ret_domain > 1) {\n-\t\t\tDEBUG(0,(\"Found %d records matching domain [%s]\\n\", \n-\t\t\t\t ret_domain, domain_name));\n-\t\t\treturn NT_STATUS_INTERNAL_DB_CORRUPTION;\n-\t\t}\n \t}\n \n \t/* pull the user attributes */\n@@ -95,7 +80,7 @@\n \t\treturn NT_STATUS_INTERNAL_DB_CORRUPTION;\n \t}\n \n-\tif (!domain_name) {\n+\tif (!domain_dn) {\n \t\tstruct dom_sid *domain_sid;\n \n \t\tdomain_sid = samdb_result_sid_prefix(mem_ctx, msgs[0], \"objectSid\");\n@@ -123,25 +108,25 @@\n \t\t\treturn NT_STATUS_INTERNAL_DB_CORRUPTION;\n \t\t}\n \n-\t\tret_domain = gendb_search(sam_ctx, mem_ctx, partitions_basedn, &msgs_domain_ref, domain_ref_attrs,\n-\t\t\t\t\t  \"(nCName=%s)\", ldb_dn_alloc_linearized(msgs_tmp, msgs_tmp[0]->dn));\n+\t\tdomain_dn = msgs_tmp[0]->dn;\n+\t}\n \n-\t\tif (ret_domain == -1) {\n-\t\t\treturn NT_STATUS_INTERNAL_DB_CORRUPTION;\n-\t\t}\n+\tret_domain = gendb_search(sam_ctx, mem_ctx, partitions_basedn, &msgs_domain_ref, domain_ref_attrs,\n+\t\t\t\t  \"(nCName=%s)\", ldb_dn_alloc_linearized(msgs_tmp, domain_dn));\n+\tif (ret_domain == -1) {\n+\t\treturn NT_STATUS_INTERNAL_DB_CORRUPTION;\n+\t}\n \t\t\n-\t\tif (ret_domain == 0) {\n-\t\t\tDEBUG(3,(\"check_sam_security: Couldn't find domain [%s] in passdb file.\\n\",\n-\t\t\t\t ldb_dn_get_linearized(msgs_tmp[0]->dn)));\n-\t\t\treturn NT_STATUS_NO_SUCH_USER;\n-\t\t}\n+\tif (ret_domain == 0) {\n+\t\tDEBUG(3,(\"check_sam_security: Couldn't find domain [%s] in passdb file.\\n\",\n+\t\t\t ldb_dn_get_linearized(msgs_tmp[0]->dn)));\n+\t\treturn NT_STATUS_NO_SUCH_USER;\n+\t}\n \t\t\n-\t\tif (ret_domain > 1) {\n-\t\t\tDEBUG(0,(\"Found %d records matching domain [%s]\\n\", \n-\t\t\t\t ret_domain, ldb_dn_get_linearized(msgs_tmp[0]->dn)));\n-\t\t\treturn NT_STATUS_INTERNAL_DB_CORRUPTION;\n-\t\t}\n-\n+\tif (ret_domain > 1) {\n+\t\tDEBUG(0,(\"Found %d records matching domain [%s]\\n\", \n+\t\t\t ret_domain, ldb_dn_get_linearized(msgs_tmp[0]->dn)));\n+\t\treturn NT_STATUS_INTERNAL_DB_CORRUPTION;\n \t}\n \n \t*ret_msgs = msgs;\n\n"}