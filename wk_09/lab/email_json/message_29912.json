{"category": "ham", "to_address": "samba-cvs@samba.org", "from_address": "tridge@samba.org", "subject": "svn commit: samba r22876 - in\n\tbranches/SAMBA_4_0/source/torture/raw: .", "body": "Author: tridge\nDate: 2007-05-15 03:00:58 +0000 (Tue, 15 May 2007)\nNew Revision: 22876\n\nWebSVN: http://websvn.samba.org/cgi-bin/viewcvs.cgi?view=rev&root=samba&rev=22876\n\nLog:\n\n- try to reconnect once per second, not continously\n- patch from ronnie to fix the lock offset on reconnect\n\nModified:\n   branches/SAMBA_4_0/source/torture/raw/lockbench.c\n\n\nChangeset:\nModified: branches/SAMBA_4_0/source/torture/raw/lockbench.c\n===================================================================\n--- branches/SAMBA_4_0/source/torture/raw/lockbench.c\t2007-05-15 01:57:21 UTC (rev 22875)\n+++ branches/SAMBA_4_0/source/torture/raw/lockbench.c\t2007-05-15 03:00:58 UTC (rev 22876)\n@@ -88,7 +88,8 @@\n \tstate->offset = (state->offset+1)%nprocs;\n }\n \n-static void reopen_connection(struct benchlock_state *state);\n+static void reopen_connection(struct event_context *ev, struct timed_event *te, \n+\t\t\t      struct timeval t, void *private_data);\n \n \n static void reopen_file(struct event_context *ev, struct timed_event *te, \n@@ -114,7 +115,6 @@\n \t}\n \tstate->req->async.private = state;\n \tstate->req->async.fn      = lock_completion;\n-\tstate->offset = (state->offset+1)%nprocs;\n }\n \n /*\n@@ -128,7 +128,9 @@\n \n \tstatus = smb_composite_connect_recv(ctx, state->mem_ctx);\n \tif (!NT_STATUS_IS_OK(status)) {\n-\t\treopen_connection(state);\n+\t\tevent_add_timed(state->ev, state->mem_ctx, \n+\t\t\t\ttimeval_current_ofs(1,0), \n+\t\t\t\treopen_connection, state);\n \t\treturn;\n \t}\n \n@@ -142,10 +144,12 @@\n \t\n \n /*\n-  reopen dead connections\n+  reopen a connection\n  */\n-static void reopen_connection(struct benchlock_state *state)\n+static void reopen_connection(struct event_context *ev, struct timed_event *te, \n+\t\t\t      struct timeval t, void *private_data)\n {\n+\tstruct benchlock_state *state = (struct benchlock_state *)private_data;\n \tstruct composite_context *ctx;\n \tstruct smb_composite_connect *io = &state->reconnect;\n \tchar *host, *share;\n@@ -191,7 +195,9 @@\n \tstate->req = NULL;\n \tif (!NT_STATUS_IS_OK(status)) {\n \t\tif (NT_STATUS_EQUAL(status, NT_STATUS_END_OF_FILE)) {\n-\t\t\treopen_connection(state);\n+\t\t\tevent_add_timed(state->ev, state->mem_ctx, \n+\t\t\t\t\ttimeval_current_ofs(1,0), \n+\t\t\t\t\treopen_connection, state);\n \t\t} else {\n \t\t\tDEBUG(0,(\"Lock failed - %s\\n\", nt_errstr(status)));\n \t\t\tlock_failed++;\n\n"}