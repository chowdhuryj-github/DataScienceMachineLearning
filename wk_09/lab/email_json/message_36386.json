{"category": "ham", "to_address": "samba-cvs@samba.org", "from_address": "abartlet@samba.org", "subject": "svn commit: samba r23149 - in branches/SAMBA_4_0/source/winbind: .", "body": "Author: abartlet\nDate: 2007-05-26 00:25:22 +0000 (Sat, 26 May 2007)\nNew Revision: 23149\n\nWebSVN: http://websvn.samba.org/cgi-bin/viewcvs.cgi?view=rev&root=samba&rev=23149\n\nLog:\nFix up the trusted domain lookup code to use the new structures.\n\nAndrew Bartlett\n\nModified:\n   branches/SAMBA_4_0/source/winbind/wb_dom_info_trusted.c\n   branches/SAMBA_4_0/source/winbind/wb_init_domain.c\n\n\nChangeset:\nModified: branches/SAMBA_4_0/source/winbind/wb_dom_info_trusted.c\n===================================================================\n--- branches/SAMBA_4_0/source/winbind/wb_dom_info_trusted.c\t2007-05-25 23:50:35 UTC (rev 23148)\n+++ branches/SAMBA_4_0/source/winbind/wb_dom_info_trusted.c\t2007-05-26 00:25:22 UTC (rev 23149)\n@@ -27,6 +27,7 @@\n #include \"winbind/wb_server.h\"\n #include \"smbd/service_task.h\"\n #include \"librpc/gen_ndr/ndr_netlogon_c.h\"\n+#include \"libcli/libcli.h\"\n \n struct trusted_dom_info_state {\n \tstruct composite_context *ctx;\n@@ -55,12 +56,6 @@\n \tresult = composite_create(mem_ctx, service->task->event_ctx);\n \tif (result == NULL) goto failed;\n \n-composite_error(result, NT_STATUS_FOOBAR);\n-return result;\n-failed:\n-return NULL;\n-}\n-#if 0\n \tstate = talloc(result, struct trusted_dom_info_state);\n \tif (state == NULL) goto failed;\n \tstate->ctx = result;\n@@ -101,14 +96,14 @@\n \n \tstate->d.in.server_unc =\n \t\ttalloc_asprintf(state, \"\\\\\\\\%s\",\n-\t\t\t\tstate->my_domain->info->dc_name);\n+\t\t\t\tdcerpc_server_name(state->my_domain->netlogon_pipe));\n \tif (composite_nomem(state->d.in.server_unc,\n \t\t\t    state->ctx)) return;\n \n \tstate->d.in.domain_name = state->info->name;\n \tstate->d.in.domain_guid = NULL;\n \tstate->d.in.site_guid = NULL;\n-\tstate->d.in.flags = 0x40000000;\n+\tstate->d.in.flags = DS_RETURN_DNS_NAME;\n \n \treq = dcerpc_netr_DsRGetDCName_send(state->my_domain->netlogon_pipe,\n \t\t\t\t\t    state, &state->d);\n@@ -142,16 +137,17 @@\n \t}\n \n \t/* Hey, that was easy! */\n-\n-\tstate->info->dc_name = talloc_steal(state->info,\n+\tstate->info->num_dcs = 1;\n+\tstate->info->dcs = talloc(state->info, struct nbt_dc_name);\n+\tstate->info->dcs[0].name = talloc_steal(state->info,\n \t\t\t\t\t    state->d.out.info->dc_unc);\n-\tif (*state->info->dc_name == '\\\\') state->info->dc_name++;\n-\tif (*state->info->dc_name == '\\\\') state->info->dc_name++;\n+\tif (*state->info->dcs[0].name == '\\\\') state->info->dcs[0].name++;\n+\tif (*state->info->dcs[0].name == '\\\\') state->info->dcs[0].name++;\n \n-\tstate->info->dc_address = talloc_steal(state->info,\n+\tstate->info->dcs[0].address = talloc_steal(state->info,\n \t\t\t\t\t       state->d.out.info->dc_address);\n-\tif (*state->info->dc_address == '\\\\') state->info->dc_address++;\n-\tif (*state->info->dc_address == '\\\\') state->info->dc_address++;\n+\tif (*state->info->dcs[0].address == '\\\\') state->info->dcs[0].address++;\n+\tif (*state->info->dcs[0].address == '\\\\') state->info->dcs[0].address++;\n \n \tstate->info->dns_name = talloc_steal(state->info,\n \t\t\t\t\t     state->d.out.info->domain_name);\n@@ -187,13 +183,15 @@\n \tstate->ctx->status = werror_to_ntstatus(state->g.out.result);\n \tif (!composite_is_ok(state->ctx)) return;\n \n-\tstate->info->dc_name = talloc_steal(state->info,\n+\t/* Hey, that was easy! */\n+\tstate->info->num_dcs = 1;\n+\tstate->info->dcs = talloc(state->info, struct nbt_dc_name);\n+\tstate->info->dcs[0].name = talloc_steal(state->info,\n \t\t\t\t\t    state->g.out.dcname);\n-\n-\tif (*state->info->dc_name == '\\\\') state->info->dc_name++;\n-\tif (*state->info->dc_name == '\\\\') state->info->dc_name++;\n+\tif (*state->info->dcs[0].name == '\\\\') state->info->dcs[0].name++;\n+\tif (*state->info->dcs[0].name == '\\\\') state->info->dcs[0].name++;\n \t\n-\tmake_nbt_name(&name, state->info->dc_name, 0x20);\n+\tmake_nbt_name(&name, state->info->dcs[0].name, 0x20);\n \tctx = resolve_name_send(&name, state->service->task->event_ctx,\n \t\t\t\tlp_name_resolve_order());\n \n@@ -208,12 +206,11 @@\n \t\t\t\tstruct trusted_dom_info_state);\n \n \tstate->ctx->status = resolve_name_recv(ctx, state->info,\n-\t\t\t\t\t       &state->info->dc_address);\n+\t\t\t\t\t       &state->info->dcs[0].address);\n \tif (!composite_is_ok(state->ctx)) return;\n \n \tcomposite_done(state->ctx);\n }\n-#endif\n \n NTSTATUS wb_trusted_dom_info_recv(struct composite_context *ctx,\n \t\t\t\t  TALLOC_CTX *mem_ctx,\n\nModified: branches/SAMBA_4_0/source/winbind/wb_init_domain.c\n===================================================================\n--- branches/SAMBA_4_0/source/winbind/wb_init_domain.c\t2007-05-25 23:50:35 UTC (rev 23148)\n+++ branches/SAMBA_4_0/source/winbind/wb_init_domain.c\t2007-05-26 00:25:22 UTC (rev 23149)\n@@ -303,8 +303,8 @@\n \t\t\t\tstruct init_domain_state);\n \n \tstate->ctx->status = dcerpc_ndr_request_recv(req);\n-\tif (!(NT_STATUS_IS_OK(state->ctx->status)\n-\t      && NT_STATUS_IS_OK(state->lsa_openpolicy.out.result))) {\n+\tif ((!NT_STATUS_IS_OK(state->ctx->status)\n+\t      || !NT_STATUS_IS_OK(state->lsa_openpolicy.out.result))) {\n \t\tif (retry_with_schannel(state, state->domain->lsa_binding, \n \t\t\t\t\tinit_domain_recv_lsa_pipe)) {\n \t\t\treturn;\n\n"}