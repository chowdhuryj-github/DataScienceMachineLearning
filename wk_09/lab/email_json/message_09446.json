{"category": "ham", "to_address": "samba-cvs@samba.org", "from_address": "jra@samba.org", "subject": "svn commit: samba r22354 - in branches/SAMBA_3_0/source: client\n\tlibsmb", "body": "Author: jra\nDate: 2007-04-19 00:51:18 +0000 (Thu, 19 Apr 2007)\nNew Revision: 22354\n\nWebSVN: http://websvn.samba.org/cgi-bin/viewcvs.cgi?view=rev&root=samba&rev=22354\n\nLog:\nMake client select krb5 encrpyt if krb5 already on.\nJeremy.\n\nModified:\n   branches/SAMBA_3_0/source/client/client.c\n   branches/SAMBA_3_0/source/libsmb/clifsinfo.c\n\n\nChangeset:\nModified: branches/SAMBA_3_0/source/client/client.c\n===================================================================\n--- branches/SAMBA_3_0/source/client/client.c\t2007-04-19 00:45:01 UTC (rev 22353)\n+++ branches/SAMBA_3_0/source/client/client.c\t2007-04-19 00:51:18 UTC (rev 22354)\n@@ -1789,34 +1789,39 @@\n \n static int cmd_posix_encrypt(void)\n {\n-\tfstring buf;\n-\tfstring domain;\n-\tfstring user;\n-\tfstring password;\n \tNTSTATUS status;\n \n-\tif (!next_token_nr(NULL,buf,NULL,sizeof(buf))) {\n-\t\td_printf(\"posix_encrypt domain user password\\n\");\n-\t\treturn 1;\n-\t}\n-\tfstrcpy(domain,buf);\n+\tif (cli->use_kerberos) {\n+\t\tstatus = cli_gss_smb_encryption_start(cli);\n+\t} else {\t\n+\t\tfstring buf;\n+\t\tfstring domain;\n+\t\tfstring user;\n+\t\tfstring password;\n \n-\tif (!next_token_nr(NULL,buf,NULL,sizeof(buf))) {\n-\t\td_printf(\"posix_encrypt domain user password\\n\");\n-\t\treturn 1;\n-\t}\n-\tfstrcpy(user,buf);\n+\t\tif (!next_token_nr(NULL,buf,NULL,sizeof(buf))) {\n+\t\t\td_printf(\"posix_encrypt domain user password\\n\");\n+\t\t\treturn 1;\n+\t\t}\n+\t\tfstrcpy(domain,buf);\n \n-\tif (!next_token_nr(NULL,buf,NULL,sizeof(buf))) {\n-\t\td_printf(\"posix_encrypt domain user password\\n\");\n-\t\treturn 1;\n+\t\tif (!next_token_nr(NULL,buf,NULL,sizeof(buf))) {\n+\t\t\td_printf(\"posix_encrypt domain user password\\n\");\n+\t\t\treturn 1;\n+\t\t}\n+\t\tfstrcpy(user,buf);\n+\n+\t\tif (!next_token_nr(NULL,buf,NULL,sizeof(buf))) {\n+\t\t\td_printf(\"posix_encrypt domain user password\\n\");\n+\t\t\treturn 1;\n+\t\t}\n+\t\tfstrcpy(password,buf);\n+\n+\t\tstatus = cli_raw_ntlm_smb_encryption_start(cli,\n+\t\t\t\t\t\t\tuser,\n+\t\t\t\t\t\t\tpassword,\n+\t\t\t\t\t\t\tdomain);\n \t}\n-\tfstrcpy(password,buf);\n-\n-\tstatus = cli_raw_ntlm_smb_encryption_start(cli,\n-\t\t\t\t\t\tuser,\n-\t\t\t\t\t\tpassword,\n-\t\t\t\t\t\tdomain);\n \t\n \tif (!NT_STATUS_IS_OK(status)) {\n \t\td_printf(\"posix_encrypt failed with error %s\\n\", nt_errstr(status));\n\nModified: branches/SAMBA_3_0/source/libsmb/clifsinfo.c\n===================================================================\n--- branches/SAMBA_3_0/source/libsmb/clifsinfo.c\t2007-04-19 00:45:01 UTC (rev 22353)\n+++ branches/SAMBA_3_0/source/libsmb/clifsinfo.c\t2007-04-19 00:51:18 UTC (rev 22354)\n@@ -614,4 +614,9 @@\n \tcommon_free_encryption_state(&es);\n \treturn status;\n }\n+#else\n+NTSTATUS cli_gss_smb_encryption_start(struct cli_state *cli)\n+{\n+\treturn NT_STATUS_NOT_SUPPORTED;\n+}\n #endif\n\n"}