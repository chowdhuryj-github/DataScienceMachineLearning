{"category": "ham", "to_address": "samba-cvs@samba.org", "from_address": "tridge@samba.org", "subject": "Rev 294: make sure the ctdb control socket is secure in\n\thttp://samba.org/~tridge/ctdb", "body": "------------------------------------------------------------\nrevno: 294\nrevision-id: tridge@samba.org-20070512232016-fdj2opy995c536bs\nparent: tridge@samba.org-20070512112526-9t4ruf7033dstx0u\ncommitter: Andrew Tridgell \nbranch nick: tridge\ntimestamp: Sun 2007-05-13 09:20:16 +1000\nmessage:\n  make sure the ctdb control socket is secure\nmodified:\n  common/ctdb_daemon.c           ctdb_daemon.c-20070409200331-3el1kqgdb9m4ib0g-1\n=== modified file 'common/ctdb_daemon.c'\n--- a/common/ctdb_daemon.c\t2007-05-12 11:25:26 +0000\n+++ b/common/ctdb_daemon.c\t2007-05-12 23:20:16 +0000\n@@ -600,10 +600,15 @@\n \n \tctdb->daemon.sd = socket(AF_UNIX, SOCK_STREAM, 0);\n \tif (ctdb->daemon.sd == -1) {\n-\t\tctdb->daemon.sd = -1;\n \t\treturn -1;\n \t}\n \n+\tif (fchown(ctdb->daemon.sd, geteuid(), getegid()) != 0 ||\n+\t    fchmod(ctdb->daemon.sd, 0700) != 0) {\n+\t\tDEBUG(0,(\"Unable to secure ctdb socket '%s', ctdb->daemon.name\\n\"));\n+\t\tgoto failed;\n+\t}\n+\n \tset_non_blocking(ctdb->daemon.sd);\n \n \tmemset(&addr, 0, sizeof(addr));\n@@ -611,13 +616,20 @@\n \tstrncpy(addr.sun_path, ctdb->daemon.name, sizeof(addr.sun_path));\n \n \tif (bind(ctdb->daemon.sd, (struct sockaddr *)&addr, sizeof(addr)) == -1) {\n-\t\tclose(ctdb->daemon.sd);\n-\t\tctdb->daemon.sd = -1;\n-\t\treturn -1;\n+\t\tDEBUG(0,(\"Unable to bind on ctdb socket '%s', ctdb->daemon.name\\n\"));\n+\t\tgoto failed;\n \t}\t\n-\tlisten(ctdb->daemon.sd, 1);\n+\tif (listen(ctdb->daemon.sd, 10) != 0) {\n+\t\tDEBUG(0,(\"Unable to listen on ctdb socket '%s', ctdb->daemon.name\\n\"));\n+\t\tgoto failed;\n+\t}\n \n \treturn 0;\n+\n+failed:\n+\tclose(ctdb->daemon.sd);\n+\tctdb->daemon.sd = -1;\n+\treturn -1;\t\n }\n \n /*\n\n"}