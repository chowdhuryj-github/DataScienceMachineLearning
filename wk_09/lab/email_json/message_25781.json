{"category": "ham", "to_address": "samba-cvs@samba.org", "from_address": "mimir@samba.org", "subject": "svn commit: samba r22763 - in branches/SAMBA_4_0/source/libnet: .", "body": "Author: mimir\nDate: 2007-05-08 22:04:28 +0000 (Tue, 08 May 2007)\nNew Revision: 22763\n\nWebSVN: http://websvn.samba.org/cgi-bin/viewcvs.cgi?view=rev&root=samba&rev=22763\n\nLog:\nreplace talloc_zero calls with composite_create and add more\nallocation checks.\n\n\nrafal\n\n\nModified:\n   branches/SAMBA_4_0/source/libnet/userinfo.c\n   branches/SAMBA_4_0/source/libnet/userman.c\n\n\nChangeset:\nModified: branches/SAMBA_4_0/source/libnet/userinfo.c\n===================================================================\n--- branches/SAMBA_4_0/source/libnet/userinfo.c\t2007-05-08 21:17:58 UTC (rev 22762)\n+++ branches/SAMBA_4_0/source/libnet/userinfo.c\t2007-05-08 22:04:28 UTC (rev 22763)\n@@ -262,24 +262,22 @@\n \n \tif (!p || !io) return NULL;\n \t\n-\tc = talloc_zero(p, struct composite_context);\n-\tif (c == NULL) goto failure;\n+\tc = composite_create(p, dcerpc_event_context(p));\n+\tif (c == NULL) return c;\n \t\n \ts = talloc_zero(c, struct userinfo_state);\n-\tif (s == NULL) goto failure;\n+\tif (composite_nomem(s, c)) return c;\n \n+\tc->private_data = s;\n+\n \ts->level         = io->in.level;\n \ts->pipe          = p;\n \ts->domain_handle = io->in.domain_handle;\n \ts->monitor_fn    = monitor;\n \n-\tc->state        = COMPOSITE_STATE_IN_PROGRESS;\n-\tc->private_data = s;\n-\tc->event_ctx    = dcerpc_event_context(p);\n-\n \tif (io->in.sid) {\n \t\tsid = dom_sid_parse_talloc(s, io->in.sid);\n-\t\tif (sid == NULL) goto failure;\t\n+\t\tif (composite_nomem(sid, c)) return c;\n \n \t\ts->openuser.in.domain_handle  = &s->domain_handle;\n \t\ts->openuser.in.access_mask    = SEC_FLAG_MAXIMUM_ALLOWED;\n@@ -288,7 +286,7 @@\n \t\t\n \t\t/* send request */\n \t\ts->req = dcerpc_samr_OpenUser_send(p, c, &s->openuser);\n-\t\tif (s->req == NULL) goto failure;\n+\t\tif (composite_nomem(s->req, c)) return c;\n \t\t\n \t\ts->stage = USERINFO_OPENUSER;\n \n@@ -303,7 +301,7 @@\n \t\t\n \t\t/* send request */\n \t\ts->req = dcerpc_samr_LookupNames_send(p, c, &s->lookup);\n-\t\tif (s->req == NULL) goto failure;\n+\t\tif (composite_nomem(s->req, c)) return c;\n \t\t\n \t\ts->stage = USERINFO_LOOKUP;\n \t}\n@@ -313,10 +311,6 @@\n \ts->req->async.private = c;\n \n \treturn c;\n-\t\n-failure:\n-\ttalloc_free(c);\n-\treturn NULL;\n }\n \n \n\nModified: branches/SAMBA_4_0/source/libnet/userman.c\n===================================================================\n--- branches/SAMBA_4_0/source/libnet/userman.c\t2007-05-08 21:17:58 UTC (rev 22762)\n+++ branches/SAMBA_4_0/source/libnet/userman.c\t2007-05-08 22:04:28 UTC (rev 22763)\n@@ -127,16 +127,16 @@\n \tstruct composite_context *c;\n \tstruct useradd_state *s;\n \n+\tif (!p || !io) return NULL;\n+\n \t/* composite allocation and setup */\n-\tc = talloc_zero(p, struct composite_context);\n+\tc = composite_create(p, dcerpc_event_context(p));\n \tif (c == NULL) return NULL;\n \t\n \ts = talloc_zero(c, struct useradd_state);\n \tif (composite_nomem(s, c)) return c;\n \t\n-\tc->state        = COMPOSITE_STATE_IN_PROGRESS;\n \tc->private_data = s;\n-\tc->event_ctx    = dcerpc_event_context(p);\n \n \t/* put passed arguments to the state structure */\n \ts->domain_handle = io->in.domain_handle;\n@@ -145,8 +145,13 @@\n \t\n \t/* preparing parameters to send rpc request */\n \ts->createuser.in.domain_handle         = &io->in.domain_handle;\n+\n \ts->createuser.in.account_name          = talloc_zero(c, struct lsa_String);\n+\tif (composite_nomem(s->createuser.in.account_name, c)) return c;\n+\n \ts->createuser.in.account_name->string  = talloc_strdup(c, io->in.username);\n+\tif (composite_nomem(s->createuser.in.account_name->string, c)) return c;\n+\n \ts->createuser.out.user_handle          = &s->user_handle;\n \ts->createuser.out.rid                  = &s->user_rid;\n \n\n"}