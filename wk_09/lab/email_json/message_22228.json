{"category": "ham", "to_address": "samba-cvs@samba.org", "from_address": "gd@samba.org", "subject": "svn commit: samba r22647 - in branches: SAMBA_3_0/source/libsmb\n\tSAMBA_3_0/source/nsswitch SAMBA_3_0_25/source/libsmb\n\tSAMBA_3_0_25/source/nsswitch", "body": "Author: gd\nDate: 2007-05-03 12:29:32 +0000 (Thu, 03 May 2007)\nNew Revision: 22647\n\nWebSVN: http://websvn.samba.org/cgi-bin/viewcvs.cgi?view=rev&root=samba&rev=22647\n\nLog:\nAvoid leaking a full info3 structure on each winbindd cached login by making\nnetsamlogon_cache_get() return a talloc'ed structure.\n\nGuenther\n\nModified:\n   branches/SAMBA_3_0/source/libsmb/samlogon_cache.c\n   branches/SAMBA_3_0/source/nsswitch/winbindd_rpc.c\n   branches/SAMBA_3_0/source/nsswitch/winbindd_util.c\n   branches/SAMBA_3_0_25/source/libsmb/samlogon_cache.c\n   branches/SAMBA_3_0_25/source/nsswitch/winbindd_rpc.c\n   branches/SAMBA_3_0_25/source/nsswitch/winbindd_util.c\n\n\nChangeset:\nModified: branches/SAMBA_3_0/source/libsmb/samlogon_cache.c\n===================================================================\n--- branches/SAMBA_3_0/source/libsmb/samlogon_cache.c\t2007-05-03 12:28:25 UTC (rev 22646)\n+++ branches/SAMBA_3_0/source/libsmb/samlogon_cache.c\t2007-05-03 12:29:32 UTC (rev 22647)\n@@ -192,10 +192,13 @@\n \tdata = tdb_fetch_bystring( netsamlogon_tdb, keystr );\n \t\n \tif ( data.dptr ) {\n-\t\t\n-\t\tif ( (user = SMB_MALLOC_P(NET_USER_INFO_3)) == NULL )\n+\n+\n+\t\tuser = TALLOC_ZERO_P(mem_ctx, NET_USER_INFO_3);\n+\t\tif (user == NULL) {\n \t\t\treturn NULL;\n-\t\t\t\n+\t\t}\n+\n \t\tprs_init( &ps, 0, mem_ctx, UNMARSHALL );\n \t\tprs_give_memory( &ps, (char *)data.dptr, data.dsize, True );\n \t\t\n@@ -247,7 +250,6 @@\n \tresult = (user != NULL);\n \n \ttalloc_destroy(mem_ctx);\n-\tSAFE_FREE(user);\n \n \treturn result;\n }\n\nModified: branches/SAMBA_3_0/source/nsswitch/winbindd_rpc.c\n===================================================================\n--- branches/SAMBA_3_0/source/nsswitch/winbindd_rpc.c\t2007-05-03 12:28:25 UTC (rev 22646)\n+++ branches/SAMBA_3_0/source/nsswitch/winbindd_rpc.c\t2007-05-03 12:29:32 UTC (rev 22647)\n@@ -422,7 +422,7 @@\n \t\tuser_info->shell = NULL;\n \t\tuser_info->primary_gid = (gid_t)-1;\n \t\t\t\t\t\t\n-\t\tSAFE_FREE(user);\n+\t\tTALLOC_FREE(user);\n \t\t\t\t\n \t\treturn NT_STATUS_OK;\n \t}\n\nModified: branches/SAMBA_3_0/source/nsswitch/winbindd_util.c\n===================================================================\n--- branches/SAMBA_3_0/source/nsswitch/winbindd_util.c\t2007-05-03 12:28:25 UTC (rev 22646)\n+++ branches/SAMBA_3_0/source/nsswitch/winbindd_util.c\t2007-05-03 12:29:32 UTC (rev 22647)\n@@ -984,7 +984,7 @@\n \t}\n \n \tif (info3->num_groups == 0) {\n-\t\tSAFE_FREE(info3);\n+\t\tTALLOC_FREE(info3);\n \t\treturn NT_STATUS_UNSUCCESSFUL;\n \t}\n \t\n@@ -992,7 +992,7 @@\n \tsid_compose(&primary_group, &info3->dom_sid.sid, info3->user_rid);\n \t\n \tif (!add_sid_to_array(mem_ctx, &primary_group, user_sids, &num_groups)) {\n-\t\tSAFE_FREE(info3);\n+\t\tTALLOC_FREE(info3);\n \t\treturn NT_STATUS_NO_MEMORY;\n \t}\n \n@@ -1002,12 +1002,12 @@\n \n \t\tif (!add_sid_to_array(mem_ctx, &group_sid, user_sids,\n \t\t\t\t &num_groups)) {\n-\t\t\tSAFE_FREE(info3);\n+\t\t\tTALLOC_FREE(info3);\n \t\t\treturn NT_STATUS_NO_MEMORY;\n \t\t}\n \t}\n \n-\tSAFE_FREE(info3);\n+\tTALLOC_FREE(info3);\n \t*p_num_groups = num_groups;\n \tstatus = (user_sids != NULL) ? NT_STATUS_OK : NT_STATUS_NO_MEMORY;\n \t\n\nModified: branches/SAMBA_3_0_25/source/libsmb/samlogon_cache.c\n===================================================================\n--- branches/SAMBA_3_0_25/source/libsmb/samlogon_cache.c\t2007-05-03 12:28:25 UTC (rev 22646)\n+++ branches/SAMBA_3_0_25/source/libsmb/samlogon_cache.c\t2007-05-03 12:29:32 UTC (rev 22647)\n@@ -194,10 +194,13 @@\n \tdata = tdb_fetch( netsamlogon_tdb, key );\n \t\n \tif ( data.dptr ) {\n-\t\t\n-\t\tif ( (user = SMB_MALLOC_P(NET_USER_INFO_3)) == NULL )\n+\n+\n+\t\tuser = TALLOC_ZERO_P(mem_ctx, NET_USER_INFO_3);\n+\t\tif (user == NULL) {\n \t\t\treturn NULL;\n-\t\t\t\n+\t\t}\n+\n \t\tprs_init( &ps, 0, mem_ctx, UNMARSHALL );\n \t\tprs_give_memory( &ps, data.dptr, data.dsize, True );\n \t\t\n@@ -249,7 +252,6 @@\n \tresult = (user != NULL);\n \n \ttalloc_destroy(mem_ctx);\n-\tSAFE_FREE(user);\n \n \treturn result;\n }\n\nModified: branches/SAMBA_3_0_25/source/nsswitch/winbindd_rpc.c\n===================================================================\n--- branches/SAMBA_3_0_25/source/nsswitch/winbindd_rpc.c\t2007-05-03 12:28:25 UTC (rev 22646)\n+++ branches/SAMBA_3_0_25/source/nsswitch/winbindd_rpc.c\t2007-05-03 12:29:32 UTC (rev 22647)\n@@ -422,7 +422,7 @@\n \t\tuser_info->shell = NULL;\n \t\tuser_info->primary_gid = (gid_t)-1;\n \t\t\t\t\t\t\n-\t\tSAFE_FREE(user);\n+\t\tTALLOC_FREE(user);\n \t\t\t\t\n \t\treturn NT_STATUS_OK;\n \t}\n\nModified: branches/SAMBA_3_0_25/source/nsswitch/winbindd_util.c\n===================================================================\n--- branches/SAMBA_3_0_25/source/nsswitch/winbindd_util.c\t2007-05-03 12:28:25 UTC (rev 22646)\n+++ branches/SAMBA_3_0_25/source/nsswitch/winbindd_util.c\t2007-05-03 12:29:32 UTC (rev 22647)\n@@ -1040,7 +1040,7 @@\n \t}\n \n \tif (info3->num_groups == 0) {\n-\t\tSAFE_FREE(info3);\n+\t\tTALLOC_FREE(info3);\n \t\treturn NT_STATUS_UNSUCCESSFUL;\n \t}\n \t\n@@ -1048,7 +1048,7 @@\n \tsid_compose(&primary_group, &info3->dom_sid.sid, info3->user_rid);\n \t\n \tif (!add_sid_to_array(mem_ctx, &primary_group, user_sids, &num_groups)) {\n-\t\tSAFE_FREE(info3);\n+\t\tTALLOC_FREE(info3);\n \t\treturn NT_STATUS_NO_MEMORY;\n \t}\n \n@@ -1058,12 +1058,12 @@\n \n \t\tif (!add_sid_to_array(mem_ctx, &group_sid, user_sids,\n \t\t\t\t &num_groups)) {\n-\t\t\tSAFE_FREE(info3);\n+\t\t\tTALLOC_FREE(info3);\n \t\t\treturn NT_STATUS_NO_MEMORY;\n \t\t}\n \t}\n \n-\tSAFE_FREE(info3);\n+\tTALLOC_FREE(info3);\n \t*p_num_groups = num_groups;\n \tstatus = (user_sids != NULL) ? NT_STATUS_OK : NT_STATUS_NO_MEMORY;\n \t\n\n"}