{"category": "ham", "to_address": "samba-cvs@samba.org", "from_address": "abartlet@samba.org", "subject": "svn commit: samba r23720 - in branches/SAMBA_4_0/source:\n\tscripting/libjs selftest setup", "body": "Author: abartlet\nDate: 2007-07-05 06:15:40 +0000 (Thu, 05 Jul 2007)\nNew Revision: 23720\n\nWebSVN: http://websvn.samba.org/cgi-bin/viewcvs.cgi?view=rev&root=samba&rev=23720\n\nLog:\nAllow the member server to work against an LDAP Backend.  Another case\nwhere LDB isn't as strict as OpenLDAP, the self join record contains\nduplicate servicePrincipalNames once the DNS name and domain name are\nmade equal.  (Easier to just skip the useless self-join).\n\nAndrew Bartlett\n\nAdded:\n   branches/SAMBA_4_0/source/setup/provision_self_join.ldif\nModified:\n   branches/SAMBA_4_0/source/scripting/libjs/provision.js\n   branches/SAMBA_4_0/source/selftest/Samba4.pm\n   branches/SAMBA_4_0/source/setup/provision_users.ldif\n\n\nChangeset:\nModified: branches/SAMBA_4_0/source/scripting/libjs/provision.js\n===================================================================\n--- branches/SAMBA_4_0/source/scripting/libjs/provision.js\t2007-07-05 03:30:46 UTC (rev 23719)\n+++ branches/SAMBA_4_0/source/scripting/libjs/provision.js\t2007-07-05 06:15:40 UTC (rev 23720)\n@@ -700,6 +700,11 @@\n \tmessage(\"Setting up sam.ldb users and groups\\n\");\n \tsetup_add_ldif(\"provision_users.ldif\", info, samdb, false);\n \n+\tif (lp.get(\"server role\") == \"domain controller\") {\n+\t\tmessage(\"Setting up self join\\n\");\n+\t\tsetup_add_ldif(\"provision_self_join.ldif\", info, samdb, false);\n+\t}\n+\n \tif (setup_name_mappings(info, samdb) == false) {\n \t\treturn false;\n \t}\n@@ -769,6 +774,11 @@\n /* Write out a DNS zone file, from the info in the current database */\n function provision_dns(subobj, message, paths, session_info, credentials)\n {\n+\tvar lp = loadparm_init();\n+\tif (lp.get(\"server role\") != \"domain controller\") {\n+\t\tmessage(\"No DNS zone required for role %s\\n\", lp.get(\"server role\"));\n+\t\treturn;\n+\t}\n \tmessage(\"Setting up DNS zone: \" + subobj.DNSDOMAIN + \" \\n\");\n \tvar ldb = ldb_init();\n \tldb.session_info = session_info;\n\nModified: branches/SAMBA_4_0/source/selftest/Samba4.pm\n===================================================================\n--- branches/SAMBA_4_0/source/selftest/Samba4.pm\t2007-07-05 03:30:46 UTC (rev 23719)\n+++ branches/SAMBA_4_0/source/selftest/Samba4.pm\t2007-07-05 06:15:40 UTC (rev 23720)\n@@ -281,6 +281,8 @@\n \t$localdomain = $netbiosname if $server_role eq \"member server\";\n \tmy $localrealm = $realm;\n \t$localrealm = $netbiosname if $server_role eq \"member server\";\n+\tmy $localbasedn = $basedn;\n+\t$localbasedn = \"DC=$netbiosname\" if $server_role eq \"member server\";\n \n \topen(CONFFILE, \">$conffile\");\n \tprint CONFFILE \"\n@@ -400,7 +402,7 @@\n \tpush (@provision_options, \"--krbtgtpass=krbtgt$password\");\n \tpush (@provision_options, \"--machinepass=machine$password\");\n \tpush (@provision_options, \"--root=$root\");\n-\tpush (@provision_options, \"--simple-bind-dn=cn=Manager,$basedn\");\n+\tpush (@provision_options, \"--simple-bind-dn=cn=Manager,$localbasedn\");\n \tpush (@provision_options, \"--password=$password\");\n \tpush (@provision_options, \"--root=$root\");\n \n@@ -430,7 +432,7 @@\n \tif (defined($self->{ldap})) {\n \n                 push (@provision_options, \"--ldap-backend=$ldap_uri\");\n-\t        system(\"$self->{bindir}/smbscript $self->{setupdir}/provision-backend $configuration --ldap-manager-pass=$password --root=$root --realm=$dnsname --host-name=$netbiosname --ldap-backend-type=$self->{ldap}>&2\") == 0 or die(\"backend provision failed\");\n+\t        system(\"$self->{bindir}/smbscript $self->{setupdir}/provision-backend $configuration --ldap-manager-pass=$password --root=$root --realm=$localrealm --host-name=$netbiosname --ldap-backend-type=$self->{ldap}>&2\") == 0 or die(\"backend provision failed\");\n \n \t        if ($self->{ldap} eq \"openldap\") {\n \t\t       ($ret->{SLAPD_CONF}, $ret->{OPENLDAP_PIDFILE}) = $self->mk_openldap($ldapdir, $configuration) or die(\"Unable to create openldap directories\");\n\nAdded: branches/SAMBA_4_0/source/setup/provision_self_join.ldif\n===================================================================\n--- branches/SAMBA_4_0/source/setup/provision_self_join.ldif\t2007-07-05 03:30:46 UTC (rev 23719)\n+++ branches/SAMBA_4_0/source/setup/provision_self_join.ldif\t2007-07-05 06:15:40 UTC (rev 23720)\n@@ -0,0 +1,23 @@\n+#Join the DC to itself by default\n+\n+dn: CN=${NETBIOSNAME},CN=Domain Controllers,${DOMAINDN}\n+objectClass: computer\n+cn: ${NETBIOSNAME}\n+userAccountControl: 532480\n+localPolicyFlags: 0\n+primaryGroupID: 516\n+accountExpires: 9223372036854775807\n+sAMAccountName: ${NETBIOSNAME}$\n+sAMAccountType: 805306369\n+operatingSystem: Samba\n+operatingSystemVersion: 4.0\n+dNSHostName: ${DNSNAME}\n+isCriticalSystemObject: TRUE\n+sambaPassword: ${MACHINEPASS}\n+servicePrincipalName: HOST/${DNSNAME}\n+servicePrincipalName: HOST/${NETBIOSNAME}\n+servicePrincipalName: HOST/${DNSNAME}/${REALM}\n+servicePrincipalName: HOST/${NETBIOSNAME}/${REALM}\n+servicePrincipalName: HOST/${DNSNAME}/${DOMAIN}\n+servicePrincipalName: HOST/${NETBIOSNAME}/${DOMAIN}\n+${HOSTGUID_ADD}\n\nModified: branches/SAMBA_4_0/source/setup/provision_users.ldif\n===================================================================\n--- branches/SAMBA_4_0/source/setup/provision_users.ldif\t2007-07-05 03:30:46 UTC (rev 23719)\n+++ branches/SAMBA_4_0/source/setup/provision_users.ldif\t2007-07-05 06:15:40 UTC (rev 23720)\n@@ -67,29 +67,6 @@\n privilege: SeNetworkLogonRight\n privilege: SeRemoteInteractiveLogonRight\n \n-\n-dn: CN=${NETBIOSNAME},CN=Domain Controllers,${DOMAINDN}\n-objectClass: computer\n-cn: ${NETBIOSNAME}\n-userAccountControl: 532480\n-localPolicyFlags: 0\n-primaryGroupID: 516\n-accountExpires: 9223372036854775807\n-sAMAccountName: ${NETBIOSNAME}$\n-sAMAccountType: 805306369\n-operatingSystem: Samba\n-operatingSystemVersion: 4.0\n-dNSHostName: ${DNSNAME}\n-isCriticalSystemObject: TRUE\n-sambaPassword: ${MACHINEPASS}\n-servicePrincipalName: HOST/${DNSNAME}\n-servicePrincipalName: HOST/${NETBIOSNAME}\n-servicePrincipalName: HOST/${DNSNAME}/${REALM}\n-servicePrincipalName: HOST/${NETBIOSNAME}/${REALM}\n-servicePrincipalName: HOST/${DNSNAME}/${DOMAIN}\n-servicePrincipalName: HOST/${NETBIOSNAME}/${DOMAIN}\n-${HOSTGUID_ADD}\n-\n dn: CN=Users,CN=Builtin,${DOMAINDN}\n objectClass: top\n objectClass: group\n\n"}