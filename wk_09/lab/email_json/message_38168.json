{"category": "ham", "to_address": "samba-cvs@samba.org", "from_address": "abartlet@samba.org", "subject": "svn commit: samba r23189 - in branches/SAMBA_4_0/source: script\n\tscripting/libjs selftest setup", "body": "Author: abartlet\nDate: 2007-05-29 12:18:41 +0000 (Tue, 29 May 2007)\nNew Revision: 23189\n\nWebSVN: http://websvn.samba.org/cgi-bin/viewcvs.cgi?view=rev&root=samba&rev=23189\n\nLog:\nWork towards a totally scripted setup of LDAP backends, so others can\neasily try this out.\n\nI also intend to use this for the selftest, but I'm chasing issues\nwith the OpenlDAP (but not Fedora DS) backend.\n\nAndrew Bartlett\n\nModified:\n   branches/SAMBA_4_0/source/script/installmisc.sh\n   branches/SAMBA_4_0/source/scripting/libjs/provision.js\n   branches/SAMBA_4_0/source/selftest/Samba4.pm\n   branches/SAMBA_4_0/source/setup/fedorads-partitions.ldif\n   branches/SAMBA_4_0/source/setup/fedorads.inf\n   branches/SAMBA_4_0/source/setup/provision\n   branches/SAMBA_4_0/source/setup/provision-backend\n   branches/SAMBA_4_0/source/setup/slapd.conf\n\n\nChangeset:\nModified: branches/SAMBA_4_0/source/script/installmisc.sh\n===================================================================\n--- branches/SAMBA_4_0/source/script/installmisc.sh\t2007-05-29 11:13:07 UTC (rev 23188)\n+++ branches/SAMBA_4_0/source/script/installmisc.sh\t2007-05-29 12:18:41 UTC (rev 23189)\n@@ -15,6 +15,7 @@\n echo \"Installing setup templates\"\n mkdir -p $SETUPDIR || exit 1\n cp setup/schema-map-* $SETUPDIR || exit 1\n+cp setup/DB_CONFIG $SETUPDIR || exit 1\n cp setup/*.inf $SETUPDIR || exit 1\n cp setup/*.ldif $SETUPDIR || exit 1\n cp setup/*.zone $SETUPDIR || exit 1\n\nModified: branches/SAMBA_4_0/source/scripting/libjs/provision.js\n===================================================================\n--- branches/SAMBA_4_0/source/scripting/libjs/provision.js\t2007-05-29 11:13:07 UTC (rev 23188)\n+++ branches/SAMBA_4_0/source/scripting/libjs/provision.js\t2007-05-29 12:18:41 UTC (rev 23189)\n@@ -385,10 +385,10 @@\n \tpaths.keytab = \"secrets.keytab\";\n \tpaths.dns = lp.get(\"private dir\") + \"/\" + subobj.DNSDOMAIN + \".zone\";\n \tpaths.winsdb = \"wins.ldb\";\n-\tpaths.ldap_basedn_ldif = lp.get(\"private dir\") + \"/\" + subobj.DNSDOMAIN + \".ldif\";\n-\tpaths.ldap_config_basedn_ldif = lp.get(\"private dir\") + \"/\" + subobj.DNSDOMAIN + \"-config.ldif\";\n-\tpaths.ldap_schema_basedn_ldif = lp.get(\"private dir\") + \"/\" + subobj.DNSDOMAIN + \"-schema.ldif\";\n \tpaths.ldapdir = lp.get(\"private dir\") + \"/ldap\";\n+\tpaths.ldap_basedn_ldif = paths.ldapdir + \"/\" + subobj.DNSDOMAIN + \".ldif\";\n+\tpaths.ldap_config_basedn_ldif = paths.ldapdir + \"/\" + subobj.DNSDOMAIN + \"-config.ldif\";\n+\tpaths.ldap_schema_basedn_ldif = paths.ldapdir + \"/\" + subobj.DNSDOMAIN + \"-schema.ldif\";\n \treturn paths;\n }\n \n@@ -793,6 +793,8 @@\n \n \tsubobj.RDN_DC = substr(rdns[0], strlen(\"DC=\"));\n \n+\tsys.mkdir(paths.ldapdir, 0700);\n+\n \tsetup_file(\"provision_basedn.ldif\", \n \t\t   message, paths.ldap_basedn_ldif, \n \t\t   subobj);\n@@ -805,7 +807,6 @@\n \t\t   message, paths.ldap_schema_basedn_ldif, \n \t\t   subobj);\n \n-\tmessage(\"Please install the LDIF located in \" + paths.ldap_basedn_ldif + \", \" + paths.ldap_config_basedn_ldif + \" and \" + paths.ldap_schema_basedn_ldif + \" into your LDAP server, and re-run with --ldap-backend=ldap://my.ldap.server\\n\");\n }\n \n \n\nModified: branches/SAMBA_4_0/source/selftest/Samba4.pm\n===================================================================\n--- branches/SAMBA_4_0/source/selftest/Samba4.pm\t2007-05-29 11:13:07 UTC (rev 23188)\n+++ branches/SAMBA_4_0/source/selftest/Samba4.pm\t2007-05-29 12:18:41 UTC (rev 23189)\n@@ -422,8 +422,8 @@\n \t}\n \n \tsystem(\"slaptest -u -f $slapd_conf\") == 0 or die(\"slaptest still fails after adding modules\");\n-\tsystem(\"slapadd -b cn=Configuration,$basedn -f $slapd_conf -l $privatedir/$dnsname-config.ldif >/dev/null\") == 0 or die(\"slapadd failed\");\n-\tsystem(\"slapadd -b cn=Schema,cn=Configuration,$basedn -f $slapd_conf -l $privatedir/$dnsname-schema.ldif >/dev/null\") == 0 or die(\"slapadd failed\");\n+\tsystem(\"slapadd -b cn=Configuration,$basedn -f $slapd_conf -l $ldapdir/$dnsname-config.ldif >/dev/null\") == 0 or die(\"slapadd failed\");\n+\tsystem(\"slapadd -b cn=Schema,cn=Configuration,$basedn -f $slapd_conf -l $ldapdir/$dnsname-schema.ldif >/dev/null\") == 0 or die(\"slapadd failed\");\n \n     system(\"slaptest -u -f $slapd_conf >/dev/null\") == 0 or \n \t\tdie (\"slaptest after database load failed\");\n@@ -458,7 +458,7 @@\n \tmy $winbindd_socket_dir = \"$prefix_abs/winbind_socket\";\n \n \tmy $configuration = \"--configfile=$conffile\";\n-\tmy $ldapdir = \"$prefix_abs/ldap\";\n+\tmy $ldapdir = \"$privatedir/ldap\";\n \n \tmy $tlsdir = \"$privatedir/tls\";\n \n\nModified: branches/SAMBA_4_0/source/setup/fedorads-partitions.ldif\n===================================================================\n--- branches/SAMBA_4_0/source/setup/fedorads-partitions.ldif\t2007-05-29 11:13:07 UTC (rev 23188)\n+++ branches/SAMBA_4_0/source/setup/fedorads-partitions.ldif\t2007-05-29 12:18:41 UTC (rev 23189)\n@@ -1,4 +1,4 @@\n-dn: cn=\\\"${CONFIGDN}\\\",cn=mapping tree,cn=config\n+dn: cn=\"${CONFIGDN}\",cn=mapping tree,cn=config\n objectclass: top\n objectclass: extensibleObject\n objectclass: nsMappingTree\n@@ -12,7 +12,7 @@\n nsslapd-suffix: ${CONFIGDN}\n cn: configData\n \n-dn: cn=\\\"${SCHEMADN}\\\",cn=mapping tree,cn=config\n+dn: cn=\"${SCHEMADN}\",cn=mapping tree,cn=config\n objectclass: top\n objectclass: extensibleObject\n objectclass: nsMappingTree\n\nModified: branches/SAMBA_4_0/source/setup/fedorads.inf\n===================================================================\n--- branches/SAMBA_4_0/source/setup/fedorads.inf\t2007-05-29 11:13:07 UTC (rev 23188)\n+++ branches/SAMBA_4_0/source/setup/fedorads.inf\t2007-05-29 12:18:41 UTC (rev 23189)\n@@ -9,6 +9,7 @@\n RootDN= cn=Manager,${DOMAINDN}\n RootDNPwd= ${LDAPMANAGERPASS}\n ServerIdentifier= samba4\n+${SERVERPORT}\n \n inst_dir= ${LDAPDIR}/slapd-samba4\n config_dir= ${LDAPDIR}/slapd-samba4\n\nModified: branches/SAMBA_4_0/source/setup/provision\n===================================================================\n--- branches/SAMBA_4_0/source/setup/provision\t2007-05-29 11:13:07 UTC (rev 23188)\n+++ branches/SAMBA_4_0/source/setup/provision\t2007-05-29 12:18:41 UTC (rev 23189)\n@@ -150,6 +150,7 @@\n message(\"Using administrator password: %s\\n\", subobj.ADMINPASS);\n if (ldapbase) {\n \tprovision_ldapbase(subobj, message, paths);\n+\tmessage(\"Please install the LDIF located in \" + paths.ldap_basedn_ldif + \", \" + paths.ldap_config_basedn_ldif + \" and \" + paths.ldap_schema_basedn_ldif + \" into your LDAP server, and re-run with --ldap-backend=ldap://my.ldap.server\\n\");\n } else if (partitions_only) {\n \tprovision_become_dc(subobj, message, false, paths, system_session);\n } else {\n\nModified: branches/SAMBA_4_0/source/setup/provision-backend\n===================================================================\n--- branches/SAMBA_4_0/source/setup/provision-backend\t2007-05-29 11:13:07 UTC (rev 23188)\n+++ branches/SAMBA_4_0/source/setup/provision-backend\t2007-05-29 12:18:41 UTC (rev 23189)\n@@ -16,7 +16,8 @@\n \t\t'ldap-manager-pass=s',\n \t\t'root=s',\n \t\t'quiet',\n-\t\t'ldap-backend-type=s');\n+\t\t'ldap-backend-type=s',\n+                'ldap-backend-port=i');\n \n if (options == undefined) {\n    println(\"Failed to parse options\");\n@@ -52,8 +53,8 @@\n  --ldap-manager-pass\tPASSWORD\tchoose LDAP Manager password (otherwise random)\n  --root         USERNAME\tchoose 'root' unix username\n  --quiet\t\t\tBe quiet\n- --ldap-backend-type LDAPSERVER     Select either \\\"openldap\\\" or \\\"fedora-ds\\\" as a target to configure\n- --ldap-module= MODULE          LDB mapping module to use for the LDAP backend\n+ --ldap-backend-type LDAPSERVER Select either \\\"openldap\\\" or \\\"fedora-ds\\\" as a target to configure\n+ --ldap-backend-port PORT       Select the TCP port (if any) that the LDAP backend should listen on (Fedora DS only)\n You must provide at least a realm and ldap-backend-type\n \n \");\n@@ -84,13 +85,12 @@\n \tsubobj[key] = options[r];\n }\n \n-var ldapbackend = (options[\"ldap-backend-type\"] != undefined);\n \n+\n var paths = provision_default_paths(subobj);\n provision_fix_subobj(subobj, message, paths);\n message(\"Provisioning LDAP backend for %s in realm %s into %s\\n\", subobj.HOSTNAME, subobj.REALM, subobj.LDAPDIR);\n message(\"Using LDAP Manager password: %s\\n\", subobj.LDAPMANAGERPASS);\n-\n var tmp_schema_ldb = subobj.LDAPDIR + \"/schema-tmp.ldb\";\n sys.mkdir(subobj.LDAPDIR, 0700);\n \n@@ -101,12 +101,40 @@\n if (options[\"ldap-backend-type\"] == \"fedora-ds\") {\n \tmapping = \"schema-map-fedora-ds-1.0\";\n \text = \"ldif\";\n+\tif (options[\"ldap-backend-port\"] != undefined) {\n+\t\tmessage(\"Will listen on TCP port \" + options[\"ldap-backend-port\"] + \"\\n\");\n+\t\tsubobj.SERVERPORT=\"ServerPort = \" + options[\"ldap-backend-port\"];\n+\t} else {\n+\t\tmessage(\"Will listen on LDAPI only\\n\");\n+\t\tsubobj.SERVERPORT=\"\";\n+\t}\n \tsetup_file(\"fedorads.inf\", message, subobj.LDAPDIR + \"/fedorads.inf\", subobj);\n \tsetup_file(\"fedorads-partitions.ldif\", message, subobj.LDAPDIR + \"/fedorads-partitions.ldif\", subobj);\n } else if (options[\"ldap-backend-type\"] == \"openldap\") {\n+\tprovision_ldapbase(subobj, message, paths);\n \tmapping = \"schema-map-openldap-2.3\";\n \text = \"schema\";\n \tsetup_file(\"slapd.conf\", message, subobj.LDAPDIR + \"/slapd.conf\", subobj);\n+\tsetup_file(\"modules.conf\", message, subobj.LDAPDIR + \"/modules.conf\", subobj);\n+\tsys.mkdir(subobj.LDAPDIR + \"/db\", 0700);\n+\tsubobj.LDAPDBDIR = subobj.LDAPDIR + \"/db/user\";\n+\tsys.mkdir(subobj.LDAPDBDIR, 0700);\n+\tsys.mkdir(subobj.LDAPDBDIR + \"/bdb-logs\", 0700);\n+\tsys.mkdir(subobj.LDAPDBDIR + \"/tmp\", 0700);\n+\tsetup_file(\"DB_CONFIG\", message, subobj.LDAPDBDIR + \"/DB_CONFIG\", subobj);\n+\tsubobj.LDAPDBDIR = subobj.LDAPDIR + \"/db/config\";\n+\tsys.mkdir(subobj.LDAPDBDIR, 0700);\n+\tsys.mkdir(subobj.LDAPDBDIR + \"/bdb-logs\", 0700);\n+\tsys.mkdir(subobj.LDAPDBDIR + \"/tmp\", 0700);\n+\tsetup_file(\"DB_CONFIG\", message, subobj.LDAPDBDIR + \"/DB_CONFIG\", subobj);\n+\tsubobj.LDAPDBDIR = subobj.LDAPDIR + \"/db/schema\";\n+\tsys.mkdir(subobj.LDAPDBDIR, 0700);\n+\tsys.mkdir(subobj.LDAPDBDIR + \"/tmp\", 0700);\n+\tsys.mkdir(subobj.LDAPDBDIR + \"/bdb-logs\", 0700);\n+\tsetup_file(\"DB_CONFIG\", message, subobj.LDAPDBDIR + \"/DB_CONFIG\", subobj);\n+\tif (options[\"ldap-backend-port\"] != undefined) {\n+\t\tmessage(\"NOTE: OpenLDAP TCP ports are controlled on the command line, not in the generated config file\\n\");\n+\t}\n }\n message(\"ad2oLschema --option=convert:target=\" + options[\"ldap-backend-type\"] + \" -I \" + lp.get(\"setup directory\") + \"/\" + mapping + \" -H tdb://\" + tmp_schema_ldb + \" -O \" + subobj.LDAPDIR + \"/backend-schema.\" + ext + \"\\n\");\n \n\nModified: branches/SAMBA_4_0/source/setup/slapd.conf\n===================================================================\n--- branches/SAMBA_4_0/source/setup/slapd.conf\t2007-05-29 11:13:07 UTC (rev 23188)\n+++ branches/SAMBA_4_0/source/setup/slapd.conf\t2007-05-29 12:18:41 UTC (rev 23189)\n@@ -17,13 +17,13 @@\n           uid=([^,]*),cn=([^,]*),cn=digest-md5,cn=auth\n           ldap:///${DOMAINDN}??sub?(samAccountName=\\$1)\n \n-include $modconf\n+include ${LDAPDIR}/modules.conf\n \n-defaultsearchbase \\\"${DOMAINDN}\\\"\n+defaultsearchbase ${DOMAINDN}\n \n backend\t\tbdb\n database        bdb\n-suffix\t\t\\\"cn=Schema,cn=Configuration,${DOMAINDN}\\\"\n+suffix\t\t${SCHEMADN}\n directory\t${LDAPDIR}/db/schema\n index           objectClass eq\n index           samAccountName eq\n@@ -33,7 +33,7 @@\n index subClassOf eq\n \n database        bdb\n-suffix\t\t\\\"cn=Configuration,${DOMAINDN}\\\"\n+suffix\t\t${CONFIGDN}\n directory\t${LDAPDIR}/db/config\n index           objectClass eq\n index           samAccountName eq\n@@ -46,8 +46,8 @@\n index nETBIOSName eq pres\n \n database        bdb\n-suffix\t\t\\\"${DOMAINDN}\\\"\n-rootdn          \\\"cn=Manager,${DOMAINDN}\\\"\n+suffix\t\t${DOMAINDN}\n+rootdn          cn=Manager,${DOMAINDN}\n rootpw          ${LDAPMANAGERPASS}\n directory\t${LDAPDIR}/db/user\n index           objectClass eq\n\n"}