{"category": "ham", "to_address": "samba-cvs@samba.org", "from_address": "jerry@samba.org", "subject": "svn commit: samba r23602 - in branches/SAMBA_3_0_RELEASE: .\n\tsource/client source/include source/libsmb source/nmbd\n\tsource/nsswitch source/registry source/rpc_server source/smbd", "body": "Author: jerry\nDate: 2007-06-26 01:14:37 +0000 (Tue, 26 Jun 2007)\nNew Revision: 23602\n\nWebSVN: http://websvn.samba.org/cgi-bin/viewcvs.cgi?view=rev&root=samba&rev=23602\n\nLog:\ngrab final changes for 3.0.25b due out tomorrow\nModified:\n   branches/SAMBA_3_0_RELEASE/WHATSNEW.txt\n   branches/SAMBA_3_0_RELEASE/source/client/smbmount.c\n   branches/SAMBA_3_0_RELEASE/source/client/smbumount.c\n   branches/SAMBA_3_0_RELEASE/source/include/includes.h\n   branches/SAMBA_3_0_RELEASE/source/libsmb/clikrb5.c\n   branches/SAMBA_3_0_RELEASE/source/nmbd/nmbd_winsserver.c\n   branches/SAMBA_3_0_RELEASE/source/nsswitch/winbindd_cm.c\n   branches/SAMBA_3_0_RELEASE/source/nsswitch/winbindd_util.c\n   branches/SAMBA_3_0_RELEASE/source/registry/reg_eventlog.c\n   branches/SAMBA_3_0_RELEASE/source/rpc_server/srv_eventlog_nt.c\n   branches/SAMBA_3_0_RELEASE/source/smbd/files.c\n   branches/SAMBA_3_0_RELEASE/source/smbd/oplock.c\n\n\nChangeset:\nModified: branches/SAMBA_3_0_RELEASE/WHATSNEW.txt\n===================================================================\n--- branches/SAMBA_3_0_RELEASE/WHATSNEW.txt\t2007-06-26 00:52:19 UTC (rev 23601)\n+++ branches/SAMBA_3_0_RELEASE/WHATSNEW.txt\t2007-06-26 01:14:37 UTC (rev 23602)\n@@ -1,6 +1,6 @@\n                    ===============================\n                    Release Notes for Samba 3.0.25b\n-                             June 20, 2007\n+                             June 26, 2007\n                    ===============================\n \n This is the third production release of the Samba 3.0.25 code \n@@ -44,17 +44,25 @@\n     * Fix sync_file() to return NTSTATUS and return this on failure in\n       the write reply path.\n     * BUG 4678,4697: Fix token creation for clear text logins.  \n+    * BUG 4725: Don't crash when no eventlog names are defined in\n+      smb.conf.\n+    * Ensure we will always release any timeout handler on fsp close \n+      or removal of oplock.\n \n \n o   Jacob Berkman \n     * BUG 4566: Pass password data to krb5_prompter.\n \n \n+o   Gerald (Jerry) Carter \n+    * BUG 4579: Fix \"wbinfo -t\" when running winbindd on a Samba DC.\n+\n+\n o   Guenther Deschner \n     * BUG 4657: Fix compilation and linking of pam_smbpass.so.\n     * Add more netlogon GetDcName() client calls.\n+    * Fix event based krb5 ticket refreshing in winbindd.\n \n-\n o   SATOH Fumiyasu \n     * BUG 4720: Fix smbclient connections to share names containing \n       multibyte characters.\n\nModified: branches/SAMBA_3_0_RELEASE/source/client/smbmount.c\n===================================================================\n--- branches/SAMBA_3_0_RELEASE/source/client/smbmount.c\t2007-06-26 00:52:19 UTC (rev 23601)\n+++ branches/SAMBA_3_0_RELEASE/source/client/smbmount.c\t2007-06-26 01:14:37 UTC (rev 23602)\n@@ -152,7 +152,7 @@\n \n \t/* have to open a new connection */\n \tif (!(c=cli_initialise()) || (cli_set_port(c, smb_port) != smb_port) ||\n-\t    !cli_connect(c, server_n, &ip)) {\n+\t    !NT_STATUS_IS_OK(cli_connect(c, server_n, &ip))) {\n \t\tDEBUG(0,(\"%d: Connection to %s failed\\n\", sys_getpid(), server_n));\n \t\tif (c) {\n \t\t\tcli_shutdown(c);\n@@ -669,6 +669,9 @@\n \n \tprintf(\"Version %s\\n\\n\",SAMBA_VERSION_STRING);\n \n+\tprintf(\"Please be aware that smbfs is deprecated in favor of \"\n+\t       \"cifs\\n\\n\");\n+\n \tprintf(\n \"Options:\\n\\\n       username=                  SMB username\\n\\\n\nModified: branches/SAMBA_3_0_RELEASE/source/client/smbumount.c\n===================================================================\n--- branches/SAMBA_3_0_RELEASE/source/client/smbumount.c\t2007-06-26 00:52:19 UTC (rev 23601)\n+++ branches/SAMBA_3_0_RELEASE/source/client/smbumount.c\t2007-06-26 01:14:37 UTC (rev 23602)\n@@ -32,7 +32,9 @@\n static void\n usage(void)\n {\n-        printf(\"usage: smbumount mountpoint\\n\");\n+        printf(\"usage: smbumount mountpoint\\n\\n\");\n+\tprintf(\"Please be aware that smbfs is deprecated in favor of \"\n+\t       \"cifs\\n\");\n }\n \n static int\n\nModified: branches/SAMBA_3_0_RELEASE/source/include/includes.h\n===================================================================\n--- branches/SAMBA_3_0_RELEASE/source/include/includes.h\t2007-06-26 00:52:19 UTC (rev 23601)\n+++ branches/SAMBA_3_0_RELEASE/source/include/includes.h\t2007-06-26 01:14:37 UTC (rev 23602)\n@@ -1182,7 +1182,7 @@\n int cli_krb5_get_ticket(const char *principal, time_t time_offset, \n \t\t\tDATA_BLOB *ticket, DATA_BLOB *session_key_krb5, uint32 extra_ap_opts, const char *ccname, time_t *tgs_expire);\n PAC_LOGON_INFO *get_logon_info_from_pac(PAC_DATA *pac_data);\n-krb5_error_code smb_krb5_renew_ticket(const char *ccache_string, const char *client_string, const char *service_string, time_t *new_start_time);\n+krb5_error_code smb_krb5_renew_ticket(const char *ccache_string, const char *client_string, const char *service_string, time_t *expire_time);\n krb5_error_code kpasswd_err_to_krb5_err(krb5_error_code res_code);\n krb5_error_code smb_krb5_gen_netbios_krb5_address(smb_krb5_addresses **kerb_addr);\n krb5_error_code smb_krb5_free_addresses(krb5_context context, smb_krb5_addresses *addr);\n\nModified: branches/SAMBA_3_0_RELEASE/source/libsmb/clikrb5.c\n===================================================================\n--- branches/SAMBA_3_0_RELEASE/source/libsmb/clikrb5.c\t2007-06-26 00:52:19 UTC (rev 23601)\n+++ branches/SAMBA_3_0_RELEASE/source/libsmb/clikrb5.c\t2007-06-26 01:14:37 UTC (rev 23602)\n@@ -1095,7 +1095,7 @@\n  krb5_error_code smb_krb5_renew_ticket(const char *ccache_string,\t/* FILE:/tmp/krb5cc_0 */\n \t\t\t\t       const char *client_string,\t/* gd@BER.SUSE.DE */\n \t\t\t\t       const char *service_string,\t/* krbtgt/BER.SUSE.DE@BER.SUSE.DE */\n-\t\t\t\t       time_t *new_start_time)\n+\t\t\t\t       time_t *expire_time)\n {\n \tkrb5_error_code ret;\n \tkrb5_context context = NULL;\n@@ -1150,8 +1150,8 @@\n \t\n \t\tret = krb5_cc_store_cred(context, ccache, &creds);\n \n-\t\tif (new_start_time) {\n-\t\t\t*new_start_time = (time_t) creds.times.renew_till;\n+\t\tif (expire_time) {\n+\t\t\t*expire_time = (time_t) creds.times.endtime;\n \t\t}\n \n \t\tkrb5_free_cred_contents(context, &creds);\n@@ -1184,7 +1184,11 @@\n \t\t\t}\n \t\t} else {\n \t\t\t/* build tgt service by default */\n-\t\t\tclient_realm = krb5_princ_realm(context, client);\n+\t\t\tclient_realm = krb5_princ_realm(context, creds_in.client);\n+\t\t\tif (!client_realm) {\n+\t\t\t\tret = ENOMEM;\n+\t\t\t\tgoto done;\n+\t\t\t}\n \t\t\tret = krb5_make_principal(context, &creds_in.server, *client_realm, KRB5_TGS_NAME, *client_realm, NULL);\n \t\t\tif (ret) {\n \t\t\t\tgoto done;\n@@ -1208,8 +1212,8 @@\n \t\n \t\tret = krb5_cc_store_cred(context, ccache, creds);\n \n-\t\tif (new_start_time) {\n-\t\t\t*new_start_time = (time_t) creds->times.renew_till;\n+\t\tif (expire_time) {\n+\t\t\t*expire_time = (time_t) creds->times.endtime;\n \t\t}\n \t\t\t\t\t\t\n \t\tkrb5_free_cred_contents(context, &creds_in);\n\nModified: branches/SAMBA_3_0_RELEASE/source/nmbd/nmbd_winsserver.c\n===================================================================\n--- branches/SAMBA_3_0_RELEASE/source/nmbd/nmbd_winsserver.c\t2007-06-26 00:52:19 UTC (rev 23601)\n+++ branches/SAMBA_3_0_RELEASE/source/nmbd/nmbd_winsserver.c\t2007-06-26 01:14:37 UTC (rev 23602)\n@@ -2333,6 +2333,7 @@\n \t\tif (tdb_reopen(wins_tdb)) {\n \t\t\tDEBUG(0,(\"wins_write_database: tdb_reopen failed. Error was %s\\n\",\n \t\t\t\tstrerror(errno)));\n+\t\t\t_exit(0);\n \t\t\treturn;\n \t\t}\n \t}\n\nModified: branches/SAMBA_3_0_RELEASE/source/nsswitch/winbindd_cm.c\n===================================================================\n--- branches/SAMBA_3_0_RELEASE/source/nsswitch/winbindd_cm.c\t2007-06-26 00:52:19 UTC (rev 23601)\n+++ branches/SAMBA_3_0_RELEASE/source/nsswitch/winbindd_cm.c\t2007-06-26 01:14:37 UTC (rev 23602)\n@@ -249,9 +249,7 @@\n \tDEBUG(10,(\"check_domain_online_handler: called for domain %s\\n\",\n \t\tdomain->name ));\n \n-\tif (domain->check_online_event) {\n-\t\tTALLOC_FREE(domain->check_online_event);\n-\t}\n+\tTALLOC_FREE(domain->check_online_event);\n \n \t/* Are we still in \"startup\" mode ? */\n \n@@ -303,9 +301,7 @@\n \tDEBUG(10,(\"set_domain_offline: called for domain %s\\n\",\n \t\tdomain->name ));\n \n-\tif (domain->check_online_event) {\n-\t\tTALLOC_FREE(domain->check_online_event);\n-\t}\n+\tTALLOC_FREE(domain->check_online_event);\n \n \tif (domain->internal) {\n \t\tDEBUG(3,(\"set_domain_offline: domain %s is internal - logic error.\\n\",\n@@ -400,9 +396,7 @@\n \n \t/* Ensure we have no online timeout checks. */\n \tdomain->check_online_timeout = 0;\n-\tif (domain->check_online_event) {\n-\t\tTALLOC_FREE(domain->check_online_event);\n-\t}\n+\tTALLOC_FREE(domain->check_online_event);\n \n \t/* Ensure we ignore any pending child messages. */\n \tmessage_deregister(MSG_WINBIND_TRY_TO_GO_ONLINE);\n\nModified: branches/SAMBA_3_0_RELEASE/source/nsswitch/winbindd_util.c\n===================================================================\n--- branches/SAMBA_3_0_RELEASE/source/nsswitch/winbindd_util.c\t2007-06-26 00:52:19 UTC (rev 23601)\n+++ branches/SAMBA_3_0_RELEASE/source/nsswitch/winbindd_util.c\t2007-06-26 01:14:37 UTC (rev 23602)\n@@ -91,6 +91,9 @@\n \tif (sid == NULL)\n \t\treturn False;\n \n+\tif ( IS_DC )\n+\t\treturn sid_check_is_builtin(sid);\n+\n \treturn (sid_check_is_domain(sid) || sid_check_is_builtin(sid));\n }\n \n@@ -99,6 +102,9 @@\n \tif (sid == NULL)\n \t\treturn False;\n \n+\tif ( IS_DC )\n+\t\treturn sid_check_is_in_builtin(sid);\n+\n \treturn (sid_check_is_in_our_domain(sid) || sid_check_is_in_builtin(sid));\n }\n \n\nModified: branches/SAMBA_3_0_RELEASE/source/registry/reg_eventlog.c\n===================================================================\n--- branches/SAMBA_3_0_RELEASE/source/registry/reg_eventlog.c\t2007-06-26 00:52:19 UTC (rev 23601)\n+++ branches/SAMBA_3_0_RELEASE/source/registry/reg_eventlog.c\t2007-06-26 01:14:37 UTC (rev 23602)\n@@ -190,6 +190,10 @@\n \tint i;\n \tint numsources;\n \n+\tif (!elogs) {\n+\t\treturn False;\n+\t}\n+\n \tfor ( i = 0; elogs[i]; i++ ) {\n \t\tif ( strequal( elogs[i], eventlog ) )\n \t\t\tbreak;\n\nModified: branches/SAMBA_3_0_RELEASE/source/rpc_server/srv_eventlog_nt.c\n===================================================================\n--- branches/SAMBA_3_0_RELEASE/source/rpc_server/srv_eventlog_nt.c\t2007-06-26 00:52:19 UTC (rev 23601)\n+++ branches/SAMBA_3_0_RELEASE/source/rpc_server/srv_eventlog_nt.c\t2007-06-26 01:14:37 UTC (rev 23602)\n@@ -123,6 +123,10 @@\n \tint i;\n \tconst char **elogs = lp_eventlog_list();\n \t\n+\tif (!elogs) {\n+\t\treturn False;\n+\t}\n+\n \tfor ( i=0; elogs[i]; i++ ) {\n \t\tif ( strequal( name, elogs[i] ) )\n \t\t\treturn True;\n\nModified: branches/SAMBA_3_0_RELEASE/source/smbd/files.c\n===================================================================\n--- branches/SAMBA_3_0_RELEASE/source/smbd/files.c\t2007-06-26 00:52:19 UTC (rev 23601)\n+++ branches/SAMBA_3_0_RELEASE/source/smbd/files.c\t2007-06-26 01:14:37 UTC (rev 23602)\n@@ -444,6 +444,9 @@\n \t\tTALLOC_FREE(fsp->notify);\n \t}\n \n+\t/* Ensure this event will never fire. */\n+\tTALLOC_FREE(fsp->oplock_timeout);\n+\n \tbitmap_clear(file_bmap, fsp->fnum - FILE_HANDLE_OFFSET);\n \tfiles_used--;\n \n\nModified: branches/SAMBA_3_0_RELEASE/source/smbd/oplock.c\n===================================================================\n--- branches/SAMBA_3_0_RELEASE/source/smbd/oplock.c\t2007-06-26 00:52:19 UTC (rev 23601)\n+++ branches/SAMBA_3_0_RELEASE/source/smbd/oplock.c\t2007-06-26 01:14:37 UTC (rev 23602)\n@@ -153,6 +153,8 @@\n \tfsp->sent_oplock_break = NO_BREAK_SENT;\n \t\n \tflush_write_cache(fsp, OPLOCK_RELEASE_FLUSH);\n+\n+\tTALLOC_FREE(fsp->oplock_timeout);\n }\n \n /****************************************************************************\n@@ -349,12 +351,8 @@\n {\n \tfiles_struct *fsp = (files_struct *)private_data;\n \n-\t/* Ensure we always remove this event. */\n-\tif (fsp->oplock_timeout != NULL) {\n-\t\t/* Remove the timed event handler. */\n-\t\tTALLOC_FREE(fsp->oplock_timeout);\n-\t\tfsp->oplock_timeout = NULL;\n-\t}\n+\t/* Remove the timed event handler. */\n+\tTALLOC_FREE(fsp->oplock_timeout);\n \tDEBUG(0, (\"Oplock break failed for file %s -- replying anyway\\n\", fsp->fsp_name));\n \tglobal_client_failed_oplock_break = True;\n \tremove_oplock(fsp);\n\n"}