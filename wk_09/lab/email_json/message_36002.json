{"category": "ham", "to_address": "samba-cvs@samba.org", "from_address": "tridge@samba.org", "subject": "svn commit: samba r23138 - in branches/SAMBA_4_0/source/libcli/raw:\n\t.", "body": "Author: tridge\nDate: 2007-05-25 10:42:29 +0000 (Fri, 25 May 2007)\nNew Revision: 23138\n\nWebSVN: http://websvn.samba.org/cgi-bin/viewcvs.cgi?view=rev&root=samba&rev=23138\n\nLog:\n\nadded a raw interface for SMBecho operations\n\nModified:\n   branches/SAMBA_4_0/source/libcli/raw/clitransport.c\n   branches/SAMBA_4_0/source/libcli/raw/interfaces.h\n\n\nChangeset:\nModified: branches/SAMBA_4_0/source/libcli/raw/clitransport.c\n===================================================================\n--- branches/SAMBA_4_0/source/libcli/raw/clitransport.c\t2007-05-25 09:15:09 UTC (rev 23137)\n+++ branches/SAMBA_4_0/source/libcli/raw/clitransport.c\t2007-05-25 10:42:29 UTC (rev 23138)\n@@ -593,3 +593,71 @@\n \n \ttalloc_set_destructor(req, smbcli_request_destructor);\n }\n+\n+\n+/****************************************************************************\n+ Send an SMBecho (async send)\n+*****************************************************************************/\n+struct smbcli_request *smb_raw_echo_send(struct smbcli_transport *transport,\n+\t\t\t\t\t struct smb_echo *p)\n+{\n+\tstruct smbcli_request *req;\n+\n+\treq = smbcli_request_setup_transport(transport, SMBecho, 1, p->in.size);\n+\tif (!req) return NULL;\n+\n+\tSSVAL(req->out.vwv, VWV(0), p->in.repeat_count);\n+\n+\tmemcpy(req->out.data, p->in.data, p->in.size);\n+\n+\tZERO_STRUCT(p->out);\n+\n+\tif (!smbcli_request_send(req)) {\n+\t\tsmbcli_request_destroy(req);\n+\t\treturn NULL;\n+\t}\n+\n+\treturn req;\n+}\n+\n+/****************************************************************************\n+ raw echo interface (async recv)\n+****************************************************************************/\n+NTSTATUS smb_raw_echo_recv(struct smbcli_request *req, TALLOC_CTX *mem_ctx,\n+\t\t\t   struct smb_echo *p)\n+{\n+\tif (!smbcli_request_receive(req) ||\n+\t    smbcli_request_is_error(req)) {\n+\t\tgoto failed;\n+\t}\n+\n+\tSMBCLI_CHECK_WCT(req, 1);\n+\tp->out.count++;\n+\tp->out.sequence_number = SVAL(req->in.vwv, VWV(0));\n+\tp->out.size = req->in.data_size;\n+\ttalloc_free(p->out.data);\n+\tp->out.data = talloc_size(mem_ctx, p->out.size);\n+\tNT_STATUS_HAVE_NO_MEMORY(p->out.data);\n+\n+\tif (!smbcli_raw_pull_data(req, req->in.data, p->out.size, p->out.data)) {\n+\t\treq->status = NT_STATUS_BUFFER_TOO_SMALL;\n+\t}\n+\n+\tif (p->out.count == p->in.repeat_count) {\n+\t\treturn smbcli_request_destroy(req);\n+\t}\n+\n+\treturn NT_STATUS_OK;\n+\n+failed:\n+\treturn smbcli_request_destroy(req);\n+}\n+\n+/****************************************************************************\n+ Send a echo (sync interface)\n+*****************************************************************************/\n+NTSTATUS smb_raw_echo(struct smbcli_transport *transport, struct smb_echo *p)\n+{\n+\tstruct smbcli_request *req = smb_raw_echo_send(transport, p);\n+\treturn smbcli_request_simple_recv(req);\n+}\n\nModified: branches/SAMBA_4_0/source/libcli/raw/interfaces.h\n===================================================================\n--- branches/SAMBA_4_0/source/libcli/raw/interfaces.h\t2007-05-25 09:15:09 UTC (rev 23137)\n+++ branches/SAMBA_4_0/source/libcli/raw/interfaces.h\t2007-05-25 10:42:29 UTC (rev 23138)\n@@ -2614,4 +2614,22 @@\n \t} findclose;\n };\n \n+\n+/*\n+  struct for SMBecho call\n+*/\n+struct smb_echo {\n+\tstruct {\n+\t\tuint16_t repeat_count;\n+\t\tuint16_t size;\n+\t\tuint8_t *data;\n+\t} in;\n+\tstruct {\n+\t\tuint16_t count;\n+\t\tuint16_t sequence_number;\n+\t\tuint16_t size;\n+\t\tuint8_t *data;\n+\t} out;\n+};\n+\n #endif /* __LIBCLI_RAW_INTERFACES_H__ */\n\n"}