{"category": "ham", "to_address": "samba-cvs@samba.org", "from_address": "jmcd@samba.org", "subject": "svn commit: samba r23643 - in branches/SAMBA_4_0/source: librpc/idl\n\ttorture/rpc", "body": "Author: jmcd\nDate: 2007-06-28 18:08:04 +0000 (Thu, 28 Jun 2007)\nNew Revision: 23643\n\nWebSVN: http://websvn.samba.org/cgi-bin/viewcvs.cgi?view=rev&root=samba&rev=23643\n\nLog:\nFix the build farm tests.  We were incorrectly passing the\nRPC-SAMBA3-GETUSERNAME tests before the previous password expiration\nfixes, because if you create a user and only set the password\nadministratrively, the \"last set time\" should not get updated.  Needed\nto add some more of the fields_present flags to do this.\n\nModified:\n   branches/SAMBA_4_0/source/librpc/idl/samr.idl\n   branches/SAMBA_4_0/source/torture/rpc/samba3rpc.c\n\n\nChangeset:\nModified: branches/SAMBA_4_0/source/librpc/idl/samr.idl\n===================================================================\n--- branches/SAMBA_4_0/source/librpc/idl/samr.idl\t2007-06-28 18:05:35 UTC (rev 23642)\n+++ branches/SAMBA_4_0/source/librpc/idl/samr.idl\t2007-06-28 18:08:04 UTC (rev 23643)\n@@ -684,23 +684,36 @@\n \n \t/* this defines the bits used for fields_present in info21 */\n \ttypedef [bitmap32bit] bitmap {\n-\t\tSAMR_FIELD_ACCOUNT_NAME   = 0x00000001,\n-\t\tSAMR_FIELD_FULL_NAME      = 0x00000002,\n-\t\tSAMR_FIELD_PRIMARY_GID    = 0x00000008,\n-\t\tSAMR_FIELD_DESCRIPTION    = 0x00000010,\n-\t\tSAMR_FIELD_COMMENT        = 0x00000020,\n-\t\tSAMR_FIELD_HOME_DIRECTORY = 0x00000040,\n-\t\tSAMR_FIELD_HOME_DRIVE     = 0x00000080,\n-\t\tSAMR_FIELD_LOGON_SCRIPT   = 0x00000100,\n-\t\tSAMR_FIELD_PROFILE_PATH   = 0x00000200,\n-\t\tSAMR_FIELD_WORKSTATIONS   = 0x00000400,\n-\t\tSAMR_FIELD_LOGON_HOURS    = 0x00002000,\n-\t\tSAMR_FIELD_ACCT_FLAGS     = 0x00100000,\n-\t\tSAMR_FIELD_PARAMETERS     = 0x00200000,\n-\t\tSAMR_FIELD_COUNTRY_CODE   = 0x00400000,\n-\t\tSAMR_FIELD_CODE_PAGE      = 0x00800000,\n-\t\tSAMR_FIELD_PASSWORD       = 0x01000000, /* either of these */\n-\t\tSAMR_FIELD_PASSWORD2      = 0x02000000  /* two bits seems to work */\n+\t\tSAMR_FIELD_ACCOUNT_NAME     = 0x00000001,\n+\t\tSAMR_FIELD_FULL_NAME        = 0x00000002,\n+\t\tSAMR_FIELD_RID              = 0x00000004,\n+\t\tSAMR_FIELD_PRIMARY_GID      = 0x00000008,\n+\t\tSAMR_FIELD_DESCRIPTION      = 0x00000010,\n+\t\tSAMR_FIELD_COMMENT          = 0x00000020,\n+\t\tSAMR_FIELD_HOME_DIRECTORY   = 0x00000040,\n+\t\tSAMR_FIELD_HOME_DRIVE       = 0x00000080,\n+\t\tSAMR_FIELD_LOGON_SCRIPT     = 0x00000100,\n+\t\tSAMR_FIELD_PROFILE_PATH     = 0x00000200,\n+\t\tSAMR_FIELD_WORKSTATIONS     = 0x00000400,\n+\t\tSAMR_FIELD_LAST_LOGON       = 0x00000800,\n+\t\tSAMR_FIELD_LAST_LOGOFF      = 0x00001000,\n+\t\tSAMR_FIELD_LOGON_HOURS      = 0x00002000,\n+\t\tSAMR_FIELD_BAD_PWD_COUNT    = 0x00004000,\n+\t\tSAMR_FIELD_NUM_LOGONS       = 0x00008000,\n+\t\tSAMR_FIELD_ALLOW_PWD_CHANGE = 0x00010000,\n+\t\tSAMR_FIELD_FORCE_PWD_CHANGE = 0x00020000,\n+\t\tSAMR_FIELD_LAST_PWD_CHANGE  = 0x00040000,\n+\t\tSAMR_FIELD_ACCT_EXPIRY      = 0x00080000,\n+\t\tSAMR_FIELD_ACCT_FLAGS       = 0x00100000,\n+\t\tSAMR_FIELD_PARAMETERS       = 0x00200000,\n+\t\tSAMR_FIELD_COUNTRY_CODE     = 0x00400000,\n+\t\tSAMR_FIELD_CODE_PAGE        = 0x00800000,\n+\t\tSAMR_FIELD_PASSWORD         = 0x01000000, /* either of these */\n+\t\tSAMR_FIELD_PASSWORD2        = 0x02000000, /* two bits seems to work */\n+\t\tSAMR_FIELD_PRIVATE_DATA     = 0x04000000,\n+\t\tSAMR_FIELD_EXPIRED_FLAG     = 0x08000000,\n+\t\tSAMR_FIELD_SEC_DESC         = 0x10000000,\n+\t\tSAMR_FIELD_OWF_PWD          = 0x20000000\n \t} samr_FieldsPresent;\n \n \ttypedef struct {\n\nModified: branches/SAMBA_4_0/source/torture/rpc/samba3rpc.c\n===================================================================\n--- branches/SAMBA_4_0/source/torture/rpc/samba3rpc.c\t2007-06-28 18:05:35 UTC (rev 23642)\n+++ branches/SAMBA_4_0/source/torture/rpc/samba3rpc.c\t2007-06-28 18:08:04 UTC (rev 23643)\n@@ -536,24 +536,29 @@\n \t\tunion samr_UserInfo u_info;\n \t\tDATA_BLOB session_key;\n \n-\t\tencode_pw_buffer(u_info.info24.password.data, password,\n+\n+\t\tZERO_STRUCT(u_info);\n+\t\tencode_pw_buffer(u_info.info23.password.data, password,\n \t\t\t\t STR_UNICODE);\n-\t\tu_info.info24.pw_len =\tstrlen_m(password)*2;\n \n \t\tstatus = dcerpc_fetch_session_key(samr_pipe, &session_key);\n \t\tif (!NT_STATUS_IS_OK(status)) {\n \t\t\td_printf(\"dcerpc_fetch_session_key failed\\n\");\n \t\t\tgoto done;\n \t\t}\n-\t\tarcfour_crypt_blob(u_info.info24.password.data, 516,\n+\t\tarcfour_crypt_blob(u_info.info23.password.data, 516,\n \t\t\t\t   &session_key);\n+\t\tu_info.info23.info.password_expired = 0;\n+\t\tu_info.info23.info.fields_present = SAMR_FIELD_PASSWORD | \n+\t\t\t\t\t\t    SAMR_FIELD_PASSWORD2 |\n+\t\t\t\t\t\t    SAMR_FIELD_EXPIRED_FLAG;\n \t\tsui2.in.user_handle = wks_handle;\n \t\tsui2.in.info = &u_info;\n-\t\tsui2.in.level = 24;\n+\t\tsui2.in.level = 23;\n \n \t\tstatus = dcerpc_samr_SetUserInfo2(samr_pipe, tmp_ctx, &sui2);\n \t\tif (!NT_STATUS_IS_OK(status)) {\n-\t\t\td_printf(\"samr_SetUserInfo(24) failed: %s\\n\",\n+\t\t\td_printf(\"samr_SetUserInfo(23) failed: %s\\n\",\n \t\t\t\t nt_errstr(status));\n \t\t\tgoto done;\n \t\t}\n\n"}