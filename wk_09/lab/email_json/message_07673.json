{"category": "ham", "to_address": "samba-cvs@samba.org", "from_address": "Jelmer Vernooij <jelmer@samba.org>", "subject": "Rev 11895: Make sure the right binaries are used. in\n\tfile:///home/jelmer/bzr.samba/SAMBA_4_0/", "body": "At file:///home/jelmer/bzr.samba/SAMBA_4_0/\n\n------------------------------------------------------------\nrevno: 11895\nrevision-id: jelmer@samba.org-20070417123659-yqoyuis1mvjh2kz8\nparent: jelmer@samba.org-20070417121100-58zt3zyuny95tia2\ncommitter: Jelmer Vernooij \nbranch nick: SAMBA_4_0\ntimestamp: Tue 2007-04-17 14:36:59 +0200\nmessage:\n  Make sure the right binaries are used.\nmodified:\n  source/script/tests/Samba3.pm  svn-v2:21909@0c0555d6-39d7-0310-84fc-f1cc0bd64818-branches%2fSAMBA_4_0-source%2fscript%2ftests%2fSamba3.pm\n=== modified file 'source/script/tests/Samba3.pm'\n--- a/source/script/tests/Samba3.pm\t2007-04-17 12:11:00 +0000\n+++ b/source/script/tests/Samba3.pm\t2007-04-17 12:36:59 +0000\n@@ -14,7 +14,9 @@\n \tmy ($self, $binary) = @_;\n \n \tif (defined($self->{bindir})) {\n-\t\treturn \"$self->{bindir}/$binary\";\n+\t\tmy $path = \"$self->{bindir}/$binary\";\n+\t\t-f $path or die(\"File $path doesn't exist\");\n+\t\treturn $path;\n \t}\n \n \treturn $binary;\n@@ -54,7 +56,7 @@\n \n \tmy $vars = $self->provision($path);\n \n-\t$self->check_or_start($vars, $ENV{NMBD_MAXTIME} or 2700, $ENV{SMBD_MAXTIME} or 2700);\n+\t$self->check_or_start($vars, ($ENV{NMBD_MAXTIME} or 2700), ($ENV{SMBD_MAXTIME} or 2700));\n \n \t$self->wait_for_start($vars);\n \n@@ -96,7 +98,7 @@\n \t\topen STDERR, '>&STDOUT';\n \t\n \t\t$ENV{MAKE_TEST_BINARY} = $self->binpath(\"nmbd\");\n-\t\texec(\"timelimit\", $nmbd_maxtime, $self->binpath(\"nmbd\"), \"-F\", \"-S\", \"--no-process-group\", \"-d0\" ,\"-s\", $env_vars->{SERVERCONFFILE}) or die(\"Unable to start nmbd\");\n+\t\texec($self->binpath(\"timelimit\"), $nmbd_maxtime, $self->binpath(\"nmbd\"), \"-F\", \"-S\", \"--no-process-group\", \"-d0\" ,\"-s\", $env_vars->{SERVERCONFFILE}) or die(\"Unable to start nmbd: $!\");\n \t}\n \topen(PID, \">$env_vars->{PIDDIR}/timelimit.nmbd.pid\");\n \tprint PID $pid;\n@@ -111,7 +113,7 @@\n \t\topen STDERR, '>&STDOUT';\n \t\n \t\t$ENV{MAKE_TEST_BINARY} = $self->binpath(\"smbd\");\n-\t\texec(\"timelimit\", $nmbd_maxtime, $self->binpath(\"smbd\"), \"-F\", \"-S\", \"--no-process-group\", \"-d0\" ,\"-s\", $env_vars->{SERVERCONFFILE}) or die(\"Unable to start nmbd\");\n+\t\texec($self->binpath(\"timelimit\"), $nmbd_maxtime, $self->binpath(\"smbd\"), \"-F\", \"-S\", \"--no-process-group\", \"-d0\" ,\"-s\", $env_vars->{SERVERCONFFILE}) or die(\"Unable to start smbd: $!\");\n \t}\n \topen(PID, \">$env_vars->{PIDDIR}/timelimit.smbd.pid\");\n \tprint PID $pid;\n@@ -175,8 +177,7 @@\n \tmy $shrdir=\"$prefix_abs/tmp\";\n \tmy $libdir=\"$prefix_abs/lib\";\n \tmy $piddir=\"$prefix_abs/pid\";\n-\tmy $conffile=\"$libdir/client.conf\";\n-\tmy $serverconffile=\"$libdir/server.conf\";\n+\tmy $conffile=\"$libdir/server.conf\";\n \tmy $privatedir=\"$prefix_abs/private\";\n \tmy $lockdir=\"$prefix_abs/lockdir\";\n \tmy $logdir=\"$prefix_abs/logs\";\n@@ -185,14 +186,15 @@\n \t## \n \t## create the test directory layout\n \t##\n+\tmkdir($prefix_abs);\n \tprint \"CREATE TEST ENVIRONMENT IN '$prefix'...\";\n-\tsystem(\"/bin/rm -rf $prefix/*\");\n+\tsystem(\"rm -rf $prefix_abs/*\");\n \tmkdir($_) foreach($privatedir,$libdir,$piddir,$lockdir,$logdir);\n \tmy $tmpdir = \"$prefix_abs/tmp\";\n \tmkdir($tmpdir);\n \tchmod 0777, $tmpdir;\n \n-\topen(CONF, \">$serverconffile\");\n+\topen(CONF, \">$conffile\") or die(\"Unable to open $conffile\");\n \tprint CONF \"\n [global]\n \tworkgroup = $domain\n@@ -259,8 +261,10 @@\n \n \tprint \"DONE\\n\";\n \n+\t$ret{SERVER_IP} = $server_ip;\n \t$ret{NMBD_TEST_LOG} = \"$prefix/nmbd_test.log\";\n \t$ret{SMBD_TEST_LOG} = \"$prefix/smbd_test.log\";\n+\t$ret{SERVERCONFFILE} = $conffile;\n \t$ret{CONFIGURATION} =\"-s $conffile\";\n \t$ret{SERVER} = $server;\n \t$ret{USERNAME} = $username;\n@@ -279,15 +283,15 @@\n \tprint \"delaying for nbt name registration\\n\";\n \tsleep(10);\n \t# This will return quickly when things are up, but be slow if we need to wait for (eg) SSL init \n-\tsystem(\"bin/nmblookup $envvars->{CONFIGURATION} -U $envvars->{SERVER_IP} __SAMBA__\");\n-\tsystem(\"bin/nmblookup $envvars->{CONFIGURATION} __SAMBA__\");\n-\tsystem(\"bin/nmblookup $envvars->{CONFIGURATION} -U 127.255.255.255 __SAMBA__\");\n-\tsystem(\"bin/nmblookup $envvars->{CONFIGURATION} -U $envvars->{SERVER_IP} $envvars->{SERVER}\");\n-\tsystem(\"bin/nmblookup $envvars->{CONFIGURATION} $envvars->{SERVER}\");\n+\tsystem($self->binpath(\"nmblookup\") .\" $envvars->{CONFIGURATION} -U $envvars->{SERVER_IP} __SAMBA__\");\n+\tsystem($self->binpath(\"nmblookup\") .\" $envvars->{CONFIGURATION} __SAMBA__\");\n+\tsystem($self->binpath(\"nmblookup\") .\" $envvars->{CONFIGURATION} -U 127.255.255.255 __SAMBA__\");\n+\tsystem($self->binpath(\"nmblookup\") .\" $envvars->{CONFIGURATION} -U $envvars->{SERVER_IP} $envvars->{SERVER}\");\n+\tsystem($self->binpath(\"nmblookup\") .\" $envvars->{CONFIGURATION} $envvars->{SERVER}\");\n \t# make sure smbd is also up set\n \tprint \"wait for smbd\\n\";\n-\tsystem(\"bin/smbclient $envvars->{CONFIGURATION} -L $envvars->{SERVER_IP} -U% -p 139 | head -2\");\n-\tsystem(\"bin/smbclient $envvars->{CONFIGURATION} -L $envvars->{SERVER_IP} -U% -p 139 | head -2\");\n+\tsystem($self->binpath(\"smbclient\") .\" $envvars->{CONFIGURATION} -L $envvars->{SERVER_IP} -U% -p 139 | head -2\");\n+\tsystem($self->binpath(\"smbclient\") .\" $envvars->{CONFIGURATION} -L $envvars->{SERVER_IP} -U% -p 139 | head -2\");\n }\n \n 1;\n\n"}