{"category": "ham", "to_address": "samba-cvs@samba.org", "from_address": "jerry@samba.org", "subject": "svn commit: samba r23048 - in branches: SAMBA_3_0/source/nsswitch\n\tSAMBA_3_0_26/source/nsswitch", "body": "Author: jerry\nDate: 2007-05-21 20:36:22 +0000 (Mon, 21 May 2007)\nNew Revision: 23048\n\nWebSVN: http://websvn.samba.org/cgi-bin/viewcvs.cgi?view=rev&root=samba&rev=23048\n\nLog:\nSimo is correct in that winbind_lookup{sid,name}_async() needs\nto be able to handle SIDs in the S-1-22-{1,2} domain in order\nfor winbindd_sid_to_uid(), et. al. to succeed.  For 3.0.25a,\nwe will short circuit in the sid_to_uid() family of functions\nso that smbd is ok.\n\nFor 3.0.26, we need to allow winbindd to handle all types of SIDs.\n\n\nModified:\n   branches/SAMBA_3_0/source/nsswitch/idmap.c\n   branches/SAMBA_3_0/source/nsswitch/winbindd_passdb.c\n   branches/SAMBA_3_0/source/nsswitch/winbindd_util.c\n   branches/SAMBA_3_0_26/source/nsswitch/idmap.c\n   branches/SAMBA_3_0_26/source/nsswitch/winbindd_passdb.c\n   branches/SAMBA_3_0_26/source/nsswitch/winbindd_util.c\n\n\nChangeset:\nModified: branches/SAMBA_3_0/source/nsswitch/idmap.c\n===================================================================\n--- branches/SAMBA_3_0/source/nsswitch/idmap.c\t2007-05-21 19:53:57 UTC (rev 23047)\n+++ branches/SAMBA_3_0/source/nsswitch/idmap.c\t2007-05-21 20:36:22 UTC (rev 23048)\n@@ -821,7 +821,10 @@\n \t/* Check we do not create mappings for our own local domain, or BUILTIN or special SIDs */\n \tif ((sid_compare_domain(map->sid, get_global_sam_sid()) == 0) ||\n \t    sid_check_is_in_builtin(map->sid) ||\n-\t    sid_check_is_in_wellknown_domain(map->sid)) {\n+\t    sid_check_is_in_wellknown_domain(map->sid) ||\n+\t    sid_check_is_in_unix_users(map->sid) ||\n+\t    sid_check_is_in_unix_groups(map->sid) ) \n+\t{\n \t\tDEBUG(10, (\"We are not supposed to create mappings for our own domains (local, builtin, specials)\\n\"));\n \t\treturn NT_STATUS_UNSUCCESSFUL;\n \t}\n\nModified: branches/SAMBA_3_0/source/nsswitch/winbindd_passdb.c\n===================================================================\n--- branches/SAMBA_3_0/source/nsswitch/winbindd_passdb.c\t2007-05-21 19:53:57 UTC (rev 23047)\n+++ branches/SAMBA_3_0/source/nsswitch/winbindd_passdb.c\t2007-05-21 20:36:22 UTC (rev 23048)\n@@ -125,7 +125,12 @@\n \n \t/* Paranoia check */\n \tif (!sid_check_is_in_builtin(sid) &&\n-\t    !sid_check_is_in_our_domain(sid)) {\n+\t    !sid_check_is_in_our_domain(sid) &&\n+\t    !sid_check_is_in_unix_users(sid) &&\n+\t    !sid_check_is_unix_users(sid) &&\n+\t    !sid_check_is_in_unix_groups(sid) &&\n+\t    !sid_check_is_unix_groups(sid) )\n+\t{\n \t\tDEBUG(0, (\"Possible deadlock: Trying to lookup SID %s with \"\n \t\t\t  \"passdb backend\\n\", sid_string_static(sid)));\n \t\treturn NT_STATUS_NONE_MAPPED;\n\nModified: branches/SAMBA_3_0/source/nsswitch/winbindd_util.c\n===================================================================\n--- branches/SAMBA_3_0/source/nsswitch/winbindd_util.c\t2007-05-21 19:53:57 UTC (rev 23047)\n+++ branches/SAMBA_3_0/source/nsswitch/winbindd_util.c\t2007-05-21 20:36:22 UTC (rev 23048)\n@@ -914,6 +914,17 @@\n \t\treturn find_domain_from_sid(sid);\n \t}\n \n+\t/* SIDs in the S-1-22-{1,2} domain should be handled by our passdb */\n+\n+\tif ( sid_check_is_in_unix_groups(sid) || \n+\t     sid_check_is_unix_groups(sid) ||\n+\t     sid_check_is_in_unix_users(sid) ||\n+\t     sid_check_is_unix_users(sid) )\n+\t{\n+\t\treturn find_domain_from_sid(get_global_sam_sid());\n+\t}\n+\t\n+\n \t/* On a member server a query for SID or name can always go to our\n \t * primary DC. */\n \n@@ -927,6 +938,14 @@\n \t    strequal(domain_name, get_global_sam_name()))\n \t\treturn find_domain_from_name_noinit(domain_name);\n \n+\t/* The \"Unix User\" and \"Unix Group\" domain our handled by passdb */\n+\n+\tif ( strequal(domain_name, unix_users_domain_name() ) ||\n+\t     strequal(domain_name, unix_groups_domain_name() ) )\n+\t{\n+\t\treturn find_domain_from_name_noinit( get_global_sam_name() );\n+\t}\n+\n \treturn find_our_domain();\n }\n \n\nModified: branches/SAMBA_3_0_26/source/nsswitch/idmap.c\n===================================================================\n--- branches/SAMBA_3_0_26/source/nsswitch/idmap.c\t2007-05-21 19:53:57 UTC (rev 23047)\n+++ branches/SAMBA_3_0_26/source/nsswitch/idmap.c\t2007-05-21 20:36:22 UTC (rev 23048)\n@@ -821,7 +821,10 @@\n \t/* Check we do not create mappings for our own local domain, or BUILTIN or special SIDs */\n \tif ((sid_compare_domain(map->sid, get_global_sam_sid()) == 0) ||\n \t    sid_check_is_in_builtin(map->sid) ||\n-\t    sid_check_is_in_wellknown_domain(map->sid)) {\n+\t    sid_check_is_in_wellknown_domain(map->sid) ||\n+\t    sid_check_is_in_unix_users(map->sid) ||\n+\t    sid_check_is_in_unix_groups(map->sid) ) \n+\t{\n \t\tDEBUG(10, (\"We are not supposed to create mappings for our own domains (local, builtin, specials)\\n\"));\n \t\treturn NT_STATUS_UNSUCCESSFUL;\n \t}\n\nModified: branches/SAMBA_3_0_26/source/nsswitch/winbindd_passdb.c\n===================================================================\n--- branches/SAMBA_3_0_26/source/nsswitch/winbindd_passdb.c\t2007-05-21 19:53:57 UTC (rev 23047)\n+++ branches/SAMBA_3_0_26/source/nsswitch/winbindd_passdb.c\t2007-05-21 20:36:22 UTC (rev 23048)\n@@ -125,7 +125,12 @@\n \n \t/* Paranoia check */\n \tif (!sid_check_is_in_builtin(sid) &&\n-\t    !sid_check_is_in_our_domain(sid)) {\n+\t    !sid_check_is_in_our_domain(sid) &&\n+\t    !sid_check_is_in_unix_users(sid) &&\n+\t    !sid_check_is_unix_users(sid) &&\n+\t    !sid_check_is_in_unix_groups(sid) &&\n+\t    !sid_check_is_unix_groups(sid) )\n+\t{\n \t\tDEBUG(0, (\"Possible deadlock: Trying to lookup SID %s with \"\n \t\t\t  \"passdb backend\\n\", sid_string_static(sid)));\n \t\treturn NT_STATUS_NONE_MAPPED;\n\nModified: branches/SAMBA_3_0_26/source/nsswitch/winbindd_util.c\n===================================================================\n--- branches/SAMBA_3_0_26/source/nsswitch/winbindd_util.c\t2007-05-21 19:53:57 UTC (rev 23047)\n+++ branches/SAMBA_3_0_26/source/nsswitch/winbindd_util.c\t2007-05-21 20:36:22 UTC (rev 23048)\n@@ -923,6 +923,17 @@\n \t\treturn find_domain_from_sid(sid);\n \t}\n \n+\t/* SIDs in the S-1-22-{1,2} domain should be handled by our passdb */\n+\n+\tif ( sid_check_is_in_unix_groups(sid) || \n+\t     sid_check_is_unix_groups(sid) ||\n+\t     sid_check_is_in_unix_users(sid) ||\n+\t     sid_check_is_unix_users(sid) )\n+\t{\n+\t\treturn find_domain_from_sid(get_global_sam_sid());\n+\t}\n+\t\n+\n \t/* On a member server a query for SID or name can always go to our\n \t * primary DC. */\n \n@@ -936,6 +947,14 @@\n \t    strequal(domain_name, get_global_sam_name()))\n \t\treturn find_domain_from_name_noinit(domain_name);\n \n+\t/* The \"Unix User\" and \"Unix Group\" domain our handled by passdb */\n+\n+\tif ( strequal(domain_name, unix_users_domain_name() ) ||\n+\t     strequal(domain_name, unix_groups_domain_name() ) )\n+\t{\n+\t\treturn find_domain_from_name_noinit( get_global_sam_name() );\n+\t}\n+\n \treturn find_our_domain();\n }\n \n\n"}