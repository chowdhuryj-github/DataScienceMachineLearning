{"category": "ham", "to_address": "r-help@stat.math.ethz.ch", "from_address": "\"Mark Wardle\" <mark@wardle.org>", "subject": "[R] Aggregation of data frame with calculations of proportions", "body": "Dear all,\n\nI have been stuck on this problem, am rather struggling and would\nappreciate some advice if anyone can help. I apologise if this is a\nbit long-winded, but I've tried to limit it to the bare essentials,\nbut don't know how to make it more generic!\n\nI have some slightly odd real world data that I'm looking at\nrepresenting number of positive diagnoses for different diseases, plus\nthe number tested. It's all in a data frame:\n\nThis should all be directly runnable with cut+paste:\n\nsp = read.csv('http://www.wardle.org/sca-prev.csv', header=T)[,c(-1,-2)]\n\nstr(sp)\n\n#'data.frame':   46 obs. of  19 variables:\n# $ sca1        : int  5 1 NA NA 48 1 NA 17 21 4 ...\n# $ sca2        : int  7 3 NA NA 53 1 NA NA 7 7 ...\n# $ sca3        : int  3 1 NA NA 2 0 NA 29 0 0 ...\n# $ sca6        : int  1 0 NA NA 2 2 NA NA 0 0 ...\n# $ sca7        : int  NA NA NA NA 2 0 NA NA 1 0 ...\n# $ sca8        : int  NA NA NA NA 2 1 NA NA NA NA ...\n# $ sca10       : int  NA NA NA NA 0 0 NA NA NA NA ...\n# $ sca12       : int  NA NA NA NA 0 0 NA NA NA NA ...\n# $ sca17       : int  NA NA NA NA 2 1 NA NA NA NA ...\n# $ frda        : int  NA NA NA NA 0 1 NA NA NA NA ...\n# $ drpla       : int  NA NA 1 1 1 1 NA NA 0 0 ...\n# $ fmr1        : int  NA NA NA NA NA NA 6 NA NA NA ...\n# $ diagnosis   : int  16 5 1 1 112 8 6 46 29 11 ...\n# $ unexplained : int  10 26 415 392 71 35 137 51 0 11 ...\n# $ total       : int  26 31 416 393 183 43 143 97 29 22 ...\n# $ patient.type: Factor w/ 8 levels \"\",\"ADCA\",\"ADCA I\",..: 2 5 2 5 2\n4 8 3 2 2 ...\n# $ age.group   : Factor w/ 5 levels \"\",\"<40\",\">40\",..: 5 5 5 5 1 1 4 5 1 1 ...\n# $ country     : Factor w/ 19 levels \"\",\"Australia\",..: 7 7 1 1 8 8 8 1 8 8 ...\n# $ region      : Factor w/ 6 levels \"Americas\",\"Asia\",..: 4 4 3 3 3 3\n3 3 3 3 ...\n\n# It is straightforward to aggregate data:\n\nsmart.sum <- function(x,...) {\t\n\tif (is.numeric(x)) return(sum(x, na.rm=T))\n\telse return(paste(unique(x), collapse=\", \"))\t\t# for natbib citations\n}\nsp.ag1 = aggregate(sp, by=list(region=sp$region), FUN=smart.sum)\nsp.ag2 = aggregate(sp, by=list(patient.type=sp$patient.type), FUN=smart.sum)\nprint(sp.ag1)\n\n# and even to calculate crude percentages\nspp = sp.ag1\nspp[,2:15] = sapply(spp[,2:15], FUN=function(x) { round(x*100/ spp$total, 1)})\n\n# *BUT*, the problem is that this is underestimating the true\nproportions, because some of the data is NA. This means the diagnosis\nwas not tested rather than not found (which would be zero).\n\n# What I want to do is calculate a true proportion, with the number\nfound divided by the number tested.\n# I have managed to do this:\n\n# calculates true proportion by only including values in the\ndenominator that have non-NAs in the numerator\n# x= vector of numbers\n# total = vector of numbers\ncalc.prevalence <- function(x, total) {\n\tsum.x = sum(x, na.rm=T)\t\t# calculate numerator\n\tsum.y = sum(total[!is.na(x)])\t\t# calculate denominator\n\treturn(sum.x/sum.y)\n}\n\ncorrect.prevalence <- calc.prevalence(sp$drpla, sp$total)\nincorrect.prevalence <- sum(sp$drpla, na.rm=T) / sum(sp$total, na.rm=T)\nprint(correct.prevalence)\nprint(incorrect.prevalence)\n\n\nThis is easy to apply to one column in one table, but I'm finding it\nvery difficult to do when I manipulate the data using the aggregate()\nfunction above.\n\nIs there a straightforward way, while aggregating columns by a\nvariable (number of) factors, in generating the sum of a column and\ndividing by the sum of another column, only including data from the\nsecond column when the first column is not NA. AND is it possible to\ndo that to all of the relevant columns (3:15)?\n\nYou won't believe how many iterations of by(), aggregate(), tapply(),\napply() and (finally) \"for loops\" I have tried with no success. The\nbest partial solution involved a combination of by() calling a\nfunction calling aggregate(), but I can't parse the data returned. I'm\nsure I am missing something! Can anyone help?\n\nMany (many many) thanks!\n\nBest wishes,\n\nMark\n\nP.S. this is enough to drive me to drink!\n-- \nDr. Mark Wardle\nClinical research fellow and specialist registrar, Neurology\nCardiff, UK\n\n______________________________________________\nR-help@stat.math.ethz.ch mailing list\nhttps://stat.ethz.ch/mailman/listinfo/r-help\nPLEASE do read the posting guide http://www.R-project.org/posting-guide.html\nand provide commented, minimal, self-contained, reproducible code.\n\n"}