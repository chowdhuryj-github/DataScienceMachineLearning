{"category": "ham", "to_address": "\"Gerald (Jerry) Carter\" <jerry@samba.org>", "from_address": "Ed Plese <ed@edplese.com>", "subject": "Re: 3.0.25pre2 winbind woes", "body": "On Wed, Apr 11, 2007 at 09:09:20AM -0500, Gerald (Jerry) Carter wrote:\n> >> > I read the new winbind documentation and modified my smb.conf to\n> >> > include the following lines:\n> >> > [global]\n> >> > workgroup = AMBER\n> >> > netbios name = gandalf\n> >> > realm = AMBER\n> >> > security = ADS\n> >> > allow trusted domains = no\n> >> > idmap domains = AMBER\n> >> > idmap config AMBER: default = yes\n> >> > idmap config AMBER: backend = rid\n> >> > idmap config AMBER: range = 100000-999999\n> >> > idmap alloc config: range = 100000-999999\n> \n> Please grab the latest SAMBA_3_0_25 svn tree, remove the\n> \"idmap alloc config\" line and retest.  I think this should\n> be fixed now.\n\nI just pulled SAMBA_3_0_25 rev 22265 and it's still showing the same\nbehavior.  I'm compiling it on Solaris 10 (x86) with Sun Studio 11.\nCompiling 3.0.24 the exact same way works just fine.  Configure options\nare identical between the versions and the only changes to smb.conf are\nthe new idmap changes.\n\nwbinfo -u and wbinfo -g both display the full lists, but some of the\nother tests mentioned in this thread don't work.\n\n# time wbinfo --group-info \"domain admins\"\nCould not get info for group domain admins\n\nreal    0m35.081s\nuser    0m0.014s\nsys     0m0.008s\n\nDebug level 10 from winbind shows (with some edits):\n\nwcache_save_name_to_sid: MYAD\\DOMAIN ADMINS -> S-1-5-21-X-Y-Z-512\nwcache_save_sid_to_name: S-1-5-21-X-Y-Z-512 -> domain admins\nidmap_sid_to_gid: sid = [S-1-5-21-X-Y-Z-512]\nQuery backends to map sids->ids\nSID S-1-5-21-X-Y-Z-512 is being handled by MYAD\nQuery ids from domain MYAD\n\n[long pause of around 30 seconds]\n\nFailed: to resolve SID\nUnexpected error resolving a SID (S-1-5-21-X-Y-Z-512)\nidmap backend for SID S-1-5-21-X-Y-Z-512 is READONLY!\nAdding cache entry with key = IDMAP/SID/S-1-5-21-X-Y-Z-512; value =\n  1176750110/IDMAP/NEGATIVE and timeout = Mon Apr 16 14:01:50 2007\n (120 seconds ahead)\nsid [S-1-5-21-X-Y-Z-512] not mapped to an gid [2,138390596,10512]\nSid S-1-5-21-X-Y-Z-512 is neither ours, a Unix SID, nor builtin\nerror converting unix gid to sid\naccepted socket 18\nrocess_request: request fn INTERFACE_VERSION\n[    0]: request interface version\n\nDuring the 30 second pause, a stack trace of winbind shows:\n\n# pstack `pgrep winbind`\n6572:   ./sbin/winbindd -S -i -d 10\n fea80957 pollsys  (8043100, 1, 80431e8, 0)\n fea2ee0a pselect  (13, 8043220, feaa9868, feaa9868, 80431e8, 0) + 18e\n fea2f100 select   (13, 8043220, 0, 0, 80432a0) + 82\n 08165c74 read_sock (8044008, ca8) + 104\n 08165dc2 read_reply (8044008) + 52\n 081660b2 winbindd_get_response (8044008) + 72\n 08166195 winbindd_request_response (0, 8044cb0, 8044008) + 75\n 08165890 winbind_open_pipe_sock (0, 0) + 140\n 081659e3 write_sock (8046ae4, 824, 0, 0) + 43\n 08165fb2 winbindd_send_request (14, 0, 8046ae4) + a2\n 08166174 winbindd_request_response (14, 8046ae4, 8045e3c) + 54\n 08163ad1 winbind_lookup_sid (83b3158, 804770c, 804734c, 8047348, 8047344) + a1\n fe4f11b2 idmap_rid_sid_to_id (83b3158, 83fa738, 804745c) + 72\n fe4f177c idmap_rid_sids_to_unixids (83fa590, 83b4960) + 11c\n 082d2bd8 idmap_backends_sids_to_unixids (83fa858) + 5e8\n 082d38c5 idmap_sids_to_unixids (8047454) + 4a5\n 082d69cb idmap_sid_to_gid (804770c, 80474a8) + cb\n 0808e358 winbindd_getgrnam (83fac38) + 5e8\n 08086e0f process_request (83fac38) + 16f\n 08087d9d request_recv (83fac38, 1) + 5d\n 08087b5a request_main_recv (83fac38, 1) + 7a\n 080872e0 rw_callback (83fac44, 1) + 260\n 0808868d process_loop (8047ed0, 8047e44, feffa840, 8088b3b, fe9f370a, 1) + 49d\n 08089350 main     (5, 8047e88, 8047ea0) + 830\n 0808649a _start   (5, 8047f38, 8047f48, 8047f4b, 8047f4e, 8047f51) + 7a\n6573:   ./sbin/winbindd -S -i -d 10\n fea80957 pollsys  (8045f20, 2, 0, 0)\n fea2ee0a pselect  (e, 804610c, feaa9868, feaa9868, 0, 0) + 18e\n fea2f100 select   (e, 804610c, 0, 0, 0) + 82\n 0815a6d0 sys_select (e, 804610c, 0, 0, 0) + 180\n 080bd50e fork_domain_child (83b41a8) + 7be\n 080bb0b8 schedule_async_request (83b41a8) + 68\n 080baa70 async_request (83b4888, 83b41a8, 83b72c0, 83b7b20, 8092da0, 83b4910) + 220\n 08092b6f init_child_connection (83b3cd0, 80bb410, 83b4838) + 2cf\n 080bb28a async_domain_request (83b4770, 83b3cd0, 83b5d80, 83b65e0, 80923e0, 83b47f8) + 15a\n 080923ca add_trusted_domains (83b3cd0) + 1fa\n 08092883 rescan_trusted_domains (8047ed0, 82eba84, 8370284, 8047ed0, 808820b, feaa94d0) + 63\n 08088289 process_loop (8047ed0, 8047e44, feffa840, 8088b3b, fe9f370a, 1) + 99\n 08089350 main     (5, 8047e88, 8047ea0) + 830\n 0808649a _start   (5, 8047f38, 8047f48, 8047f4b, 8047f4e, 8047f51) + 7a\n\n`getent group` and `getent passwd` display only the local users or groups\nwhich is normal with 'winbind enum users = no' and 'winbind enum groups = no'.\nIf I set these parameters to 'yes', then these commands hang and\ndebuglevel 10 shows that it's hanging right after 'Query ids from domain\nMYAD', the same as `wbinfo --group-info \"domain admins\"`.  I can't say\nas I've let these commands finish since they hang for 30 seconds at\nevery entry.\n\n# getent group \"domain admins\"; echo $?\n2\n\nDuring this time, winbind with debuglevel 10 shows:\n\naccepted socket 18\nrequest_len_recv: Invalid request size received: 1848\n\nThe behavior with a gid instead of group name is identical.\n\n# wbinfo -D MYAD\nName              : MYAD\nAlt_Name          : myad.org\nSID               : S-1-5-21-X-Y-Z\nActive Directory  : Yes\nNative            : Yes\nPrimary           : Yes\nSequence          : -1\n\nSome points of interest from smb.conf:\n  workgroup = MYAD\n  realm = MYAD.ORG\n  security = ads\n  idmap uid = 10000-100000000\n  idmap gid = 10000-100000000\n\n  idmap domains = MYAD\n  idmap config MYAD: default = yes\n  idmap config MYAD: backend = rid\n  idmap config MYAD: range = 10000-100000000\n  idmap config MYAD:read_only = yes\n\nIs there anything I'm overlooking here?  Anything else I could try?\n\nThanks,\n\nEd Plese\n\n"}