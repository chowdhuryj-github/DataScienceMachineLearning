{"category": "ham", "to_address": "samba-cvs@samba.org", "from_address": "abartlet@samba.org", "subject": "svn commit: samba r22756 - in branches/SAMBA_4_0/source:\n\tscripting/libjs setup torture/libnet", "body": "Author: abartlet\nDate: 2007-05-08 04:38:16 +0000 (Tue, 08 May 2007)\nNew Revision: 22756\n\nWebSVN: http://websvn.samba.org/cgi-bin/viewcvs.cgi?view=rev&root=samba&rev=22756\n\nLog:\nMake it easier to setup an LDAP replica.  Provision with\n--partitions-only (suggestions for a better name welcome) will setup\nthe partitions records, but no any data in those partitions.  This can\nthen point at the already configured remote LDAP server.\n\nAndrew Bartlett\n\nModified:\n   branches/SAMBA_4_0/source/scripting/libjs/provision.js\n   branches/SAMBA_4_0/source/setup/provision\n   branches/SAMBA_4_0/source/torture/libnet/libnet_BecomeDC.c\n\n\nChangeset:\nModified: branches/SAMBA_4_0/source/scripting/libjs/provision.js\n===================================================================\n--- branches/SAMBA_4_0/source/scripting/libjs/provision.js\t2007-05-07 20:53:10 UTC (rev 22755)\n+++ branches/SAMBA_4_0/source/scripting/libjs/provision.js\t2007-05-08 04:38:16 UTC (rev 22756)\n@@ -453,7 +453,7 @@\n \treturn true;\n }\n \n-function provision_become_dc(subobj, message, paths, session_info)\n+function provision_become_dc(subobj, message, erase, paths, session_info)\n {\n \tvar lp = loadparm_init();\n \tvar sys = sys_init();\n@@ -478,8 +478,10 @@\n \tmessage(\"Setting up \" + paths.samdb + \" rootDSE\\n\");\n \tsetup_add_ldif(\"provision_rootdse_add.ldif\", info, samdb, false);\n \n-\tmessage(\"Erasing data from partitions\\n\");\n-\tldb_erase_partitions(info, samdb, undefined);\n+\tif (erase) {\n+\t\tmessage(\"Erasing data from partitions\\n\");\n+\t\tldb_erase_partitions(info, samdb, undefined);\n+\t}\n \n \tmessage(\"Setting up \" + paths.samdb + \" indexes\\n\");\n \tsetup_add_ldif(\"provision_index.ldif\", info, samdb, false);\n\nModified: branches/SAMBA_4_0/source/setup/provision\n===================================================================\n--- branches/SAMBA_4_0/source/setup/provision\t2007-05-07 20:53:10 UTC (rev 22755)\n+++ branches/SAMBA_4_0/source/setup/provision\t2007-05-08 04:38:16 UTC (rev 22756)\n@@ -29,6 +29,7 @@\n \t\t'users=s',\n \t\t'quiet',\n \t\t'blank',\n+\t\t'partitions-only',\n \t\t'ldap-base',\n \t\t'ldap-backend=s',\n                 'ldap-module=s',\n@@ -79,6 +80,7 @@\n  --users\tGROUPNAME\tchoose 'users' group\n  --quiet\t\t\tBe quiet\n  --blank\t\t\tdo not add users or groups, just the structure\n+ --partitions-only              Configure Samba's partitions, but do not modify them (ie, join a BDC)\n  --ldap-base\t\t\toutput only an LDIF file, suitable for creating an LDAP baseDN\n  --ldap-backend LDAPSERVER      LDAP server to use for this provision\n  --ldap-module= MODULE          LDB mapping module to use for the LDAP backend\n@@ -118,7 +120,7 @@\n var ldapbase = (options[\"ldap-base\"] != undefined);\n var ldapbackend = (options[\"ldap-backend\"] != undefined);\n var ldapmodule = (options[\"ldap-module\"] != undefined);\n-\n+var partitions_only = (options[\"partitions-only\"] != undefined);\n if (options[\"aci\"] != undefined) {\n \tmessage(\"set ACI: %s\\n\", subobj[\"ACI\"]);\n }\n@@ -148,6 +150,8 @@\n message(\"Using administrator password: %s\\n\", subobj.ADMINPASS);\n if (ldapbase) {\n \tprovision_ldapbase(subobj, message, paths);\n+} else if (partitions_only) {\n+\tprovision_become_dc(subobj, message, false, paths, system_session);\n } else {\n \tprovision(subobj, message, blank, paths, system_session, creds, ldapbackend);\n \tprovision_dns(subobj, message, paths, system_session, creds);\n\nModified: branches/SAMBA_4_0/source/torture/libnet/libnet_BecomeDC.c\n===================================================================\n--- branches/SAMBA_4_0/source/torture/libnet/libnet_BecomeDC.c\t2007-05-07 20:53:10 UTC (rev 22755)\n+++ branches/SAMBA_4_0/source/torture/libnet/libnet_BecomeDC.c\t2007-05-08 04:38:16 UTC (rev 22756)\n@@ -224,7 +224,7 @@\n \t\t\"\\n\"\n \t\t\"var system_session = system_session();\\n\"\n \t\t\"\\n\"\n-\t\t\"var ok = provision_become_dc(subobj, message, paths, system_session);\\n\"\n+\t\t\"var ok = provision_become_dc(subobj, message, true, paths, system_session);\\n\"\n \t\t\"assert(ok);\\n\"\n \t\t\"\\n\"\n \t\t\"return 0;\\n\",\n\n"}