{"category": "ham", "to_address": "samba-cvs@samba.org", "from_address": "metze@samba.org", "subject": "svn commit: samba r22548 - in\n\tbranches/SAMBA_4_0/source/script/tests: .", "body": "Author: metze\nDate: 2007-04-28 08:48:11 +0000 (Sat, 28 Apr 2007)\nNew Revision: 22548\n\nWebSVN: http://websvn.samba.org/cgi-bin/viewcvs.cgi?view=rev&root=samba&rev=22548\n\nLog:\n- maintain a global array of exported envvars\n- make it possible to specify the envname for make testenv:\n  SELFTEST_TESTENV=member make testenv\n\nmetze\nModified:\n   branches/SAMBA_4_0/source/script/tests/selftest.pl\n\n\nChangeset:\nModified: branches/SAMBA_4_0/source/script/tests/selftest.pl\n===================================================================\n--- branches/SAMBA_4_0/source/script/tests/selftest.pl\t2007-04-28 08:43:51 UTC (rev 22547)\n+++ branches/SAMBA_4_0/source/script/tests/selftest.pl\t2007-04-28 08:48:11 UTC (rev 22548)\n@@ -675,6 +675,23 @@\n \n my %running_envs = ();\n \n+my @exported_envvars = (\n+\t# domain stuff\n+\t\"DOMAIN\",\n+\t\"REALM\",\n+\n+\t# server stuff\n+\t\"SERVER\",\n+\t\"NETBIOSNAME\",\n+\n+\t# user stuff\n+\t\"USERNAME\",\n+\t\"PASSWORD\",\n+\n+\t# misc stuff\n+\t\"KRB5_CONFIG\"\n+);\n+\n sub setup_env($)\n {\n \tmy ($envname) = @_;\n@@ -693,9 +710,10 @@\n \n \treturn undef unless defined($testenv_vars);\n \n+\tSocketWrapper::set_default_iface(6);\n \twrite_clientconf($conffile, $testenv_vars);\n-\tforeach (\"PASSWORD\", \"DOMAIN\", \"SERVER\", \"USERNAME\", \"NETBIOSNAME\", \n-\t\t\t \"KRB5_CONFIG\", \"REALM\") {\n+\n+\tforeach (@exported_envvars) {\n \t\tif (defined($testenv_vars->{$_})) {\n \t\t\t$ENV{$_} = $testenv_vars->{$_};\n \t\t} else {\n@@ -703,12 +721,23 @@\n \t\t}\n \t}\n \n-\tSocketWrapper::set_default_iface(6);\n-\n \t$running_envs{$envname} = $testenv_vars;\n \treturn $testenv_vars;\n }\n \n+sub exported_envvars_str($)\n+{\n+\tmy ($testenv_vars) = @_;\n+\tmy $out = \"\";\n+\n+\tforeach (@exported_envvars) {\n+\t\tnext unless defined($testenv_vars->{$_});\n+\t\t$out .= $_.\"=\".$testenv_vars->{$_}.\"\\n\";\n+\t}\n+\n+\treturn $out;\n+}\n+\n sub getlog_env($)\n {\n \tmy ($envname) = @_;\n@@ -739,19 +768,29 @@\n }\n \n if ($opt_testenv) {\n-\tmy $testenv_vars = setup_env(\"dc\");\n+\tmy $testenv_name = $ENV{SELFTEST_TESTENV};\n+\t$testenv_name = \"dc\" unless defined($testenv_name);\n+\n+\tmy $testenv_vars = setup_env($testenv_name);\n+\n \t$ENV{PIDDIR} = $testenv_vars->{PIDDIR};\n+\n+\tmy $envvarstr = exported_envvars_str($testenv_vars);\n+\n \tmy $term = ($ENV{TERM} or \"xterm\");\n-\tsystem(\"$term -e 'echo -e \\\"Welcome to the Samba4 Test environment\n+\tsystem(\"$term -e 'echo -e \\\"\n+Welcome to the Samba4 Test environment '$testenv_name'\n+\n This matches the client environment used in make test\n smbd is pid `cat \\$PIDDIR/smbd.pid`\n \n Some useful environment variables:\n TORTURE_OPTIONS=\\$TORTURE_OPTIONS\n CONFIGURATION=\\$CONFIGURATION\n-SERVER=\\$SERVER\n-NETBIOSNAME=\\$NETBIOSNAME\\\" && bash'\");\n-\tteardown_env(\"dc\");\n+\n+$envvarstr\n+\\\" && bash'\");\n+\tteardown_env($testenv_name);\n } else {\n \tforeach (@todo) {\n \t\t$i++;\n\n"}