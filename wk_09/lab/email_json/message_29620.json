{"category": "ham", "to_address": "samba-cvs@samba.org", "from_address": "metze@samba.org", "subject": "svn commit: samba r22864 - in\n\tbranches/SAMBA_4_0/source/ntvfs/posix: .", "body": "Author: metze\nDate: 2007-05-14 17:56:00 +0000 (Mon, 14 May 2007)\nNew Revision: 22864\n\nWebSVN: http://websvn.samba.org/cgi-bin/viewcvs.cgi?view=rev&root=samba&rev=22864\n\nLog:\nin SMB2 mode we need to cancel an existing lock with a conflicting lock\nif they're on the same handle and the same range\n\nmetze\nModified:\n   branches/SAMBA_4_0/source/ntvfs/posix/pvfs_lock.c\n\n\nChangeset:\nModified: branches/SAMBA_4_0/source/ntvfs/posix/pvfs_lock.c\n===================================================================\n--- branches/SAMBA_4_0/source/ntvfs/posix/pvfs_lock.c\t2007-05-14 17:51:19 UTC (rev 22863)\n+++ branches/SAMBA_4_0/source/ntvfs/posix/pvfs_lock.c\t2007-05-14 17:56:00 UTC (rev 22864)\n@@ -69,8 +69,13 @@\n \t\t\t\t   int i,\n \t\t\t\t   NTSTATUS status)\n {\n+\t/* in SMB2 mode we also try to unlock failing lock */ \n+\tif (req->ctx->protocol != PROTOCOL_SMB2) {\n+\t\ti--;\n+\t}\n+\n \t/* undo the locks we just did */\n-\tfor (i=i-1;i>=0;i--) {\n+\tfor (;i>=0;i--) {\n \t\tbrl_unlock(pvfs->brl_context,\n \t\t\t   f->brl_handle,\n \t\t\t   locks[i].pid,\n@@ -377,8 +382,12 @@\n \t\t\t\tDLIST_ADD(f->pending_list, pending);\n \t\t\t\treturn NT_STATUS_OK;\n \t\t\t}\n+\t\t\t/* in SMB2 mode we also try to unlock failing lock */ \n+\t\t\tif (req->ctx->protocol != PROTOCOL_SMB2) {\n+\t\t\t\ti--;\n+\t\t\t}\n \t\t\t/* undo the locks we just did */\n-\t\t\tfor (i=i-1;i>=0;i--) {\n+\t\t\tfor (;i>=0;i--) {\n \t\t\t\tbrl_unlock(pvfs->brl_context,\n \t\t\t\t\t   f->brl_handle,\n \t\t\t\t\t   locks[i].pid,\n\n"}