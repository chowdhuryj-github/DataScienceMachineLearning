{"category": "ham", "to_address": "samba-cvs@samba.org", "from_address": "metze@samba.org", "subject": "svn commit: samba r22774 - in\n\tbranches/SAMBA_4_0/source/smb_server/smb: .", "body": "Author: metze\nDate: 2007-05-10 08:39:44 +0000 (Thu, 10 May 2007)\nNew Revision: 22774\n\nWebSVN: http://websvn.samba.org/cgi-bin/viewcvs.cgi?view=rev&root=samba&rev=22774\n\nLog:\ncorrectly initialize the smbsrv_connection when switching to SMB2\n\nmetze\nModified:\n   branches/SAMBA_4_0/source/smb_server/smb/negprot.c\n\n\nChangeset:\nModified: branches/SAMBA_4_0/source/smb_server/smb/negprot.c\n===================================================================\n--- branches/SAMBA_4_0/source/smb_server/smb/negprot.c\t2007-05-10 02:48:22 UTC (rev 22773)\n+++ branches/SAMBA_4_0/source/smb_server/smb/negprot.c\t2007-05-10 08:39:44 UTC (rev 22774)\n@@ -436,8 +436,21 @@\n static void reply_smb2(struct smbsrv_request *req, uint16_t choice)\n {\n \tstruct smbsrv_connection *smb_conn = req->smb_conn;\n+\tNTSTATUS status;\n \n+\ttalloc_free(smb_conn->sessions.idtree_vuid);\n+\tZERO_STRUCT(smb_conn->sessions);\n+\ttalloc_free(smb_conn->smb_tcons.idtree_tid);\n+\tZERO_STRUCT(smb_conn->smb_tcons);\n+\tZERO_STRUCT(smb_conn->signing);\n+\n \t/* reply with a SMB2 packet */\n+\tstatus = smbsrv_init_smb2_connection(smb_conn);\n+\tif (!NT_STATUS_IS_OK(status)) {\n+\t\tsmbsrv_terminate_connection(smb_conn, nt_errstr(status));\n+\t\ttalloc_free(req);\n+\t\treturn;\n+\t}\n \tpacket_set_callback(smb_conn->packet, smbsrv_recv_smb2_request);\n \tsmb2srv_reply_smb_negprot(req);\n \treq = NULL;\n\n"}