{"category": "ham", "to_address": "samba-cvs@samba.org", "from_address": "tridge@samba.org", "subject": "Rev 520: merge from ronnie in http://samba.org/~tridge/ctdb", "body": "------------------------------------------------------------\nrevno: 520\nrevision-id: tridge@samba.org-20070609113159-5dbmd2zzrudupla8\nparent: tridge@samba.org-20070609052832-x558qiq25yeye30k\nparent: sahlberg@ronnie-20070609101325-65apvsghait3cob6\ncommitter: Andrew Tridgell \nbranch nick: tridge\ntimestamp: Sat 2007-06-09 21:31:59 +1000\nmessage:\n  merge from ronnie\nadded:\n  web/prerequisites.html         prerequisites.html-20070609072440-316agucpmgyar8n9-1\nmodified:\n  server/ctdb_recoverd.c         recoverd.c-20070503213540-bvxuyd9jm1f7ig90-1\n  web/documentation.html         documentation.html-20070609045837-x3vec3l27niwxtfg-1\n  web/index.html                 ctdb.html-20070601052353-vgod9lfo4an4o83j-2\n    ------------------------------------------------------------\n    revno: 432.1.65\n    merged: sahlberg@ronnie-20070609101325-65apvsghait3cob6\n    parent: sahlberg@ronnie-20070609101151-cbt48hofe9qf2br1\n    committer: Ronnie Sahlberg \n    branch nick: ctdb\n    timestamp: Sat 2007-06-09 20:13:25 +1000\n    message:\n      should be sufficient to unban nodes when we unbecome recmaster\n    ------------------------------------------------------------\n    revno: 432.1.64\n    merged: sahlberg@ronnie-20070609101151-cbt48hofe9qf2br1\n    parent: sahlberg@ronnie-20070609094928-jetgujizp5286osb\n    committer: Ronnie Sahlberg \n    branch nick: ctdb\n    timestamp: Sat 2007-06-09 20:11:51 +1000\n    message:\n      unban all nodes when we release recmaster role or when we win an \n      election\n    ------------------------------------------------------------\n    revno: 432.1.63\n    merged: sahlberg@ronnie-20070609094928-jetgujizp5286osb\n    parent: sahlberg@ronnie-20070609094241-8ls89c059hkeoopa\n    committer: Ronnie Sahlberg \n    branch nick: ctdb\n    timestamp: Sat 2007-06-09 19:49:28 +1000\n    message:\n      remove rht unban code from when we take recmaster role.   we can not \n      send control broadcasts yet\n    ------------------------------------------------------------\n    revno: 432.1.62\n    merged: sahlberg@ronnie-20070609094241-8ls89c059hkeoopa\n    parent: sahlberg@ronnie-20070609074524-msfy22b977z5luc1\n    committer: Ronnie Sahlberg \n    branch nick: ctdb\n    timestamp: Sat 2007-06-09 19:42:41 +1000\n    message:\n      add code to unban when we become/unbecome recmaster\n    ------------------------------------------------------------\n    revno: 432.1.61\n    merged: sahlberg@ronnie-20070609074524-msfy22b977z5luc1\n    parent: sahlberg@ronnie-20070609072444-x81ar8lm0t39se17\n    committer: Ronnie Sahlberg \n    branch nick: ctdb\n    timestamp: Sat 2007-06-09 17:45:24 +1000\n    message:\n      capitalize some links\n    ------------------------------------------------------------\n    revno: 432.1.60\n    merged: sahlberg@ronnie-20070609072444-x81ar8lm0t39se17\n    parent: sahlberg@ronnie-20070609071659-rff3ycim4ytcn3a2\n    committer: Ronnie Sahlberg \n    branch nick: ctdb\n    timestamp: Sat 2007-06-09 17:24:44 +1000\n    message:\n      add a tiny prerequisites page stating that you need a cluster filesystem \n      first before you install CTDB\n    ------------------------------------------------------------\n    revno: 432.1.59\n    merged: sahlberg@ronnie-20070609071659-rff3ycim4ytcn3a2\n    parent: sahlberg@ronnie-20070609071526-mqpk7szyrcdutqab\n    committer: Ronnie Sahlberg \n    branch nick: ctdb\n    timestamp: Sat 2007-06-09 17:16:59 +1000\n    message:\n      create a separate list of links for the manpages\n    ------------------------------------------------------------\n    revno: 432.1.58\n    merged: sahlberg@ronnie-20070609071526-mqpk7szyrcdutqab\n    parent: sahlberg@ronnie-20070609053817-yl14lhl41xsmmzmi\n    committer: Ronnie Sahlberg \n    branch nick: ctdb\n    timestamp: Sat 2007-06-09 17:15:26 +1000\n    message:\n      replace the list of documentation links on the front page with a link to \n      the documentations page\n    ------------------------------------------------------------\n    revno: 432.1.57\n    merged: sahlberg@ronnie-20070609053817-yl14lhl41xsmmzmi\n    parent: sahlberg@ronnie-20070609051716-mfxwueq39a30tgsf\n    parent: tridge@samba.org-20070609052130-7kxgjidk0a3frpdc\n    committer: Ronnie Sahlberg \n    branch nick: ctdb\n    timestamp: Sat 2007-06-09 15:38:17 +1000\n    message:\n      merge from tridge\n    ------------------------------------------------------------\n    revno: 432.1.56\n    merged: sahlberg@ronnie-20070609051716-mfxwueq39a30tgsf\n    parent: sahlberg@ronnie-20070609035531-3czj4em17pohyjhx\n    parent: tridge@samba.org-20070609051105-qttmz36qj1fsfrqh\n    committer: Ronnie Sahlberg \n    branch nick: ctdb\n    timestamp: Sat 2007-06-09 15:17:16 +1000\n    message:\n      merge from tridge\n=== added file 'web/prerequisites.html'\n--- a/web/prerequisites.html\t1970-01-01 00:00:00 +0000\n+++ b/web/prerequisites.html\t2007-06-09 07:24:44 +0000\n@@ -0,0 +1,22 @@\n+\n+\n+\n+Prerequisites\n+\n+\n+\n+Prerequisites\n+\n+Before you can start using CTDB you must first install and configure a bunch of linux boxes.\n+\n+After that you need to install and configure a cluster filesystem and mount that cluster filesystem on all the linux boxes that will form your cluster.\n+\n+We have primarily used the GPFS filesystem for our testing but any cluster filesystem should work as long as it provides correct file locking.\n+\n+Other cluster filesystems\n+While we primarily test with GPFS, CTDB should work with almost any other cluster filesystem as well.\n+Please let us know your experiences in using other cluster filesystems.\n+\n+\n+\n+\n\n=== modified file 'server/ctdb_recoverd.c'\n--- a/server/ctdb_recoverd.c\t2007-06-07 12:06:19 +0000\n+++ b/server/ctdb_recoverd.c\t2007-06-09 10:13:25 +0000\n@@ -888,6 +888,30 @@\n \treturn 0;\n }\n \n+/*\n+  this function will unban all nodes in the cluster\n+*/\n+static void unban_all_nodes(struct ctdb_context *ctdb)\n+{\n+\tint ret, i;\n+\tstruct ctdb_node_map *nodemap;\n+\tTALLOC_CTX *tmp_ctx = talloc_new(ctdb);\n+\t\n+\tret = ctdb_ctrl_getnodemap(ctdb, CONTROL_TIMEOUT(), CTDB_CURRENT_NODE, tmp_ctx, &nodemap);\n+\tif (ret != 0) {\n+\t\tDEBUG(0,(__location__ \" failed to get nodemap to unban all nodes\\n\"));\n+\t\treturn;\n+\t}\n+\n+\tfor (i=0;inum;i++) {\n+\t\tif ( (!(nodemap->nodes[i].flags & NODE_FLAGS_DISCONNECTED))\n+\t\t  && (nodemap->nodes[i].flags & NODE_FLAGS_BANNED) ) {\n+\t\t\tctdb_ctrl_modflags(ctdb, CONTROL_TIMEOUT(), nodemap->nodes[i].vnn, 0, NODE_FLAGS_BANNED);\n+\t\t}\n+\t}\n+\n+\ttalloc_free(tmp_ctx);\n+}\n \n /*\n   handler for recovery master elections\n@@ -912,6 +936,7 @@\n \t\t\tDEBUG(0, (__location__ \" failed to initiate recmaster election\"));\n \t\t}\n \t\ttalloc_free(mem_ctx);\n+\t\t/*unban_all_nodes(ctdb);*/\n \t\treturn;\n \t}\n \n@@ -920,6 +945,7 @@\n \t    ctdb->recovery_lock_fd != -1) {\n \t\tclose(ctdb->recovery_lock_fd);\n \t\tctdb->recovery_lock_fd = -1;\n+\t\tunban_all_nodes(ctdb);\n \t}\n \n \t/* ok, let that guy become recmaster then */\n\n=== modified file 'web/documentation.html'\n--- a/web/documentation.html\t2007-06-09 05:11:05 +0000\n+++ b/web/documentation.html\t2007-06-09 07:45:24 +0000\n@@ -11,15 +11,20 @@\n get you started\n \n \n-ctdb manual page\n-downloading CTDB\n-building CTDB\n-configuring CTDB\n-testing CTDB\n+Prerequisites\n+Downloading CTDB\n+Building CTDB\n+Configuring CTDB\n+Testing CTDB\nSetting up Samba with CTDB\nSetting up FTP with CTDB\nSetting up NFS with CTDB\nCTDB Wiki\n\n \n+Man pages:\n+\n+ctdb manual page\n+\n+\n \n\n=== modified file 'web/index.html'\n--- a/web/index.html\t2007-06-09 05:11:05 +0000\n+++ b/web/index.html\t2007-06-09 07:15:26 +0000\n@@ -61,17 +61,8 @@\n \n Documentation\n \n-\n-Getting the code\n-Building Samba and CTDB\n-Configuring CTDB\n-Starting and testing CTDB\n-Setting up clustered Samba\n-Setting up clustered NFS\n-Setting up clustered FTP\n-\n+CTDB documentation\n \n-\n Additional documentation on how to install and configure CTDB is available in the\n CTDB\n   Wiki. Please read all of the documentation carefully.\n@@ -127,7 +118,7 @@\n Discussion and bug reports\n \n For discussions please use\n-the samba-technical\n+the samba-technical\n mailing list. To submit a bug report, please use\n the Samba bugzilla bug\n tracking system.\n\n"}