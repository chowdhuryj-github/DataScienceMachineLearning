{"category": "ham", "to_address": "samba-cvs@samba.org", "from_address": "tridge@samba.org", "subject": "Rev 285: - nicer message if freeze child dies in\n\thttp://samba.org/~tridge/ctdb", "body": "------------------------------------------------------------\nrevno: 285\nrevision-id: tridge@samba.org-20070512055949-osv0s89sfsx6sj8x\nparent: tridge@samba.org-20070512055108-iu7dpt4clrysv3dp\ncommitter: Andrew Tridgell \nbranch nick: tridge\ntimestamp: Sat 2007-05-12 15:59:49 +1000\nmessage:\n  - nicer message if freeze child dies\n  - change local generation count after recovery/freeze started\nmodified:\n  common/ctdb_freeze.c           ctdb_freeze.c-20070512051503-935zdtyuqknqnhmo-1\n  direct/ctdb_recoverd.c         recoverd.c-20070503213540-bvxuyd9jm1f7ig90-1\n=== modified file 'common/ctdb_freeze.c'\n--- a/common/ctdb_freeze.c\t2007-05-12 05:44:35 +0000\n+++ b/common/ctdb_freeze.c\t2007-05-12 05:59:49 +0000\n@@ -82,6 +82,12 @@\n \tint32_t status;\n \tstruct ctdb_freeze_waiter *w;\n \n+\tif (h->ctdb->freeze_mode == CTDB_FREEZE_FROZEN) {\n+\t\tDEBUG(0,(\"freeze child died - unfreezing\\n\"));\n+\t\ttalloc_free(h);\n+\t\treturn;\n+\t}\n+\n \tif (read(h->fd, &status, sizeof(status)) != sizeof(status)) {\n \t\tDEBUG(0,(\"read error from freeze lock child\\n\"));\n \t\tstatus = -1;\n\n=== modified file 'direct/ctdb_recoverd.c'\n--- a/direct/ctdb_recoverd.c\t2007-05-12 05:15:27 +0000\n+++ b/direct/ctdb_recoverd.c\t2007-05-12 05:59:49 +0000\n@@ -330,6 +330,13 @@\n \n \tDEBUG(0, (__location__ \" Recovery initiated\\n\"));\n \n+\t/* set recovery mode to active on all nodes */\n+\tret = set_recovery_mode(ctdb, nodemap, CTDB_RECOVERY_ACTIVE);\n+\tif (ret!=0) {\n+\t\tDEBUG(0, (__location__ \" Unable to set recovery mode to active on cluster\\n\"));\n+\t\treturn -1;\n+\t}\n+\n \t/* pick a new generation number */\n \tgeneration = random();\n \n@@ -350,15 +357,6 @@\n \t\treturn -1;\n \t}\n \n-\n-\t/* set recovery mode to active on all nodes */\n-\tret = set_recovery_mode(ctdb, nodemap, CTDB_RECOVERY_ACTIVE);\n-\tif (ret!=0) {\n-\t\tDEBUG(0, (__location__ \" Unable to set recovery mode to active on cluster\\n\"));\n-\t\treturn -1;\n-\t}\n-\n-\n \t/* get a list of all databases */\n \tret = ctdb_ctrl_getdbmap(ctdb, timeval_current_ofs(1, 0), vnn, mem_ctx, &dbmap);\n \tif (ret != 0) {\n\n"}