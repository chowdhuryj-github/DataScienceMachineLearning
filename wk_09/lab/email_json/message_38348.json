{"category": "ham", "to_address": "samba-cvs@samba.org", "from_address": "jerry@samba.org", "subject": "svn commit: samba r23213 - in\n\tbranches/SAMBA_3_0_26/source/rpc_server: .", "body": "Author: jerry\nDate: 2007-05-29 16:54:01 +0000 (Tue, 29 May 2007)\nNew Revision: 23213\n\nWebSVN: http://websvn.samba.org/cgi-bin/viewcvs.cgi?view=rev&root=samba&rev=23213\n\nLog:\nMerge printer_info6 support from SAMBA_3_0\n(TODO check svn annotate in SAMBA_3_0 for release notes)\n\n\nModified:\n   branches/SAMBA_3_0_26/source/rpc_server/srv_spoolss_nt.c\n\n\nChangeset:\nModified: branches/SAMBA_3_0_26/source/rpc_server/srv_spoolss_nt.c\n===================================================================\n--- branches/SAMBA_3_0_26/source/rpc_server/srv_spoolss_nt.c\t2007-05-29 16:46:16 UTC (rev 23212)\n+++ branches/SAMBA_3_0_26/source/rpc_server/srv_spoolss_nt.c\t2007-05-29 16:54:01 UTC (rev 23213)\n@@ -4333,6 +4333,32 @@\n }\n \n /********************************************************************\n+ * construct_printer_info_6\n+ * fill a printer_info_6 struct\n+ ********************************************************************/\n+\n+static BOOL construct_printer_info_6(Printer_entry *print_hnd,\n+\t\t\t\t     PRINTER_INFO_6 *printer,\n+\t\t\t\t     int snum)\n+{\n+\tNT_PRINTER_INFO_LEVEL *ntprinter = NULL;\n+\tint count;\n+\tprint_status_struct status;\n+\n+\tif (!W_ERROR_IS_OK(get_a_printer(print_hnd, &ntprinter, 2,\n+\t\t\t\t\t lp_const_servicename(snum))))\n+\t\treturn False;\n+\n+\tcount = print_queue_length(snum, &status);\n+\n+\tprinter->status = nt_printq_status(status.status);\n+\t\t\n+\tfree_a_printer(&ntprinter, 2);\n+\n+\treturn True;\n+}\n+\n+/********************************************************************\n  * construct_printer_info_7\n  * fill a printer_info_7 struct\n  ********************************************************************/\n@@ -4960,6 +4986,46 @@\n \treturn result;\t\n }\n \n+static WERROR getprinter_level_6(Printer_entry *print_hnd,\n+\t\t\t\t int snum,\n+\t\t\t\t RPC_BUFFER *buffer, uint32 offered,\n+\t\t\t\t uint32 *needed)\n+{\n+\tPRINTER_INFO_6 *printer;\n+\tWERROR result = WERR_OK;\n+\n+\tif ((printer = SMB_MALLOC_P(PRINTER_INFO_6)) == NULL) {\n+\t\treturn WERR_NOMEM;\n+\t}\n+\n+\tif (!construct_printer_info_6(print_hnd, printer, snum)) {\n+\t\tfree_printer_info_6(printer);\n+\t\treturn WERR_NOMEM;\n+\t}\n+\n+\t/* check the required size. */\n+\t*needed += spoolss_size_printer_info_6(printer);\n+\n+\tif (*needed > offered) {\n+\t\tresult = WERR_INSUFFICIENT_BUFFER;\n+\t\tgoto out;\n+\t}\n+\n+\tif (!rpcbuf_alloc_size(buffer, *needed)) {\n+\t\tresult = WERR_NOMEM;\n+\t\tgoto out;\n+\t}\n+\n+\t/* fill the buffer with the structures */\n+\tsmb_io_printer_info_6(\"\", buffer, printer, 0);\t\n+\t\n+out:\n+\t/* clear memory */\n+\tfree_printer_info_6(printer);\n+\t\n+\treturn result;\t\n+}\n+\n static WERROR getprinter_level_7(Printer_entry *print_hnd, int snum, RPC_BUFFER *buffer, uint32 offered, uint32 *needed)\n {\n \tPRINTER_INFO_7 *printer=NULL;\n@@ -5036,6 +5102,8 @@\n \t\treturn getprinter_level_4(Printer, snum, buffer, offered, needed);\n \tcase 5:\t\t\n \t\treturn getprinter_level_5(Printer, snum, buffer, offered, needed);\n+\tcase 6:\t\t\n+\t\treturn getprinter_level_6(Printer, snum, buffer, offered, needed);\n \tcase 7:\n \t\treturn getprinter_level_7(Printer, snum, buffer, offered, needed);\n \t}\n\n"}