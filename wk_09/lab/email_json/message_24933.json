{"category": "ham", "to_address": "samba-cvs@samba.org", "from_address": "vlendec@samba.org", "subject": "svn commit: samba r22755 - in branches: SAMBA_3_0/source/smbd\n\tSAMBA_3_0_25/source/smbd SAMBA_3_0_26/source/smbd", "body": "Author: vlendec\nDate: 2007-05-07 20:53:10 +0000 (Mon, 07 May 2007)\nNew Revision: 22755\n\nWebSVN: http://websvn.samba.org/cgi-bin/viewcvs.cgi?view=rev&root=samba&rev=22755\n\nLog:\nSecond half of r22754. As it stands now, string_replace expects a\npstring. Give it one, although I hate putting it in :-)\n\nThanks to Tom Bork! :-)\n\nModified:\n   branches/SAMBA_3_0/source/smbd/notify.c\n   branches/SAMBA_3_0_25/source/smbd/notify.c\n   branches/SAMBA_3_0_26/source/smbd/notify.c\n\n\nChangeset:\nModified: branches/SAMBA_3_0/source/smbd/notify.c\n===================================================================\n--- branches/SAMBA_3_0/source/smbd/notify.c\t2007-05-07 19:27:46 UTC (rev 22754)\n+++ branches/SAMBA_3_0/source/smbd/notify.c\t2007-05-07 20:53:10 UTC (rev 22755)\n@@ -337,7 +337,7 @@\n static void notify_fsp(files_struct *fsp, uint32 action, const char *name)\n {\n \tstruct notify_change *change, *changes;\n-\tchar *name2;\n+\tpstring name2;\n \n \tif (fsp->notify == NULL) {\n \t\t/*\n@@ -346,11 +346,7 @@\n \t\treturn;\n \t}\n \n-\tif (!(name2 = talloc_strdup(fsp->notify, name))) {\n-\t\tDEBUG(0, (\"talloc_strdup failed\\n\"));\n-\t\t\treturn;\n-\t}\n-\n+\tpstrcpy(name2, name);\n \tstring_replace(name2, '/', '\\\\');\n \n \t/*\n@@ -364,7 +360,6 @@\n \t\t * guard against a DoS here.\n \t\t */\n \t\tTALLOC_FREE(fsp->notify->changes);\n-\t\tTALLOC_FREE(name2);\n \t\tfsp->notify->num_changes = -1;\n \t\treturn;\n \t}\n@@ -377,7 +372,6 @@\n \t\t      fsp->notify, fsp->notify->changes,\n \t\t      struct notify_change, fsp->notify->num_changes+1))) {\n \t\tDEBUG(0, (\"talloc_realloc failed\\n\"));\n-\t\tTALLOC_FREE(name2);\n \t\treturn;\n \t}\n \n@@ -385,7 +379,11 @@\n \n \tchange = &(fsp->notify->changes[fsp->notify->num_changes]);\n \n-\tchange->name = talloc_move(changes, &name2);\n+\tif (!(change->name = talloc_strdup(changes, name2))) {\n+\t\tDEBUG(0, (\"talloc_strdup failed\\n\"));\n+\t\treturn;\n+\t}\n+\n \tchange->action = action;\n \tfsp->notify->num_changes += 1;\n \n@@ -401,7 +399,7 @@\n \t\t * We have to send the two rename events in one reply. So hold\n \t\t * the first part back.\n \t\t */\n-\treturn;\n+\t\treturn;\n \t}\n \n \t/*\n\nModified: branches/SAMBA_3_0_25/source/smbd/notify.c\n===================================================================\n--- branches/SAMBA_3_0_25/source/smbd/notify.c\t2007-05-07 19:27:46 UTC (rev 22754)\n+++ branches/SAMBA_3_0_25/source/smbd/notify.c\t2007-05-07 20:53:10 UTC (rev 22755)\n@@ -336,7 +336,7 @@\n static void notify_fsp(files_struct *fsp, uint32 action, const char *name)\n {\n \tstruct notify_change *change, *changes;\n-\tchar *name2;\n+\tpstring name2;\n \n \tif (fsp->notify == NULL) {\n \t\t/*\n@@ -345,11 +345,7 @@\n \t\treturn;\n \t}\n \n-\tif (!(name2 = talloc_strdup(fsp->notify, name))) {\n-\t\tDEBUG(0, (\"talloc_strdup failed\\n\"));\n-\t\t\treturn;\n-\t}\n-\n+\tpstrcpy(name2, name);\n \tstring_replace(name2, '/', '\\\\');\n \n \t/*\n@@ -363,7 +359,6 @@\n \t\t * guard against a DoS here.\n \t\t */\n \t\tTALLOC_FREE(fsp->notify->changes);\n-\t\tTALLOC_FREE(name2);\n \t\tfsp->notify->num_changes = -1;\n \t\treturn;\n \t}\n@@ -376,7 +371,6 @@\n \t\t      fsp->notify, fsp->notify->changes,\n \t\t      struct notify_change, fsp->notify->num_changes+1))) {\n \t\tDEBUG(0, (\"talloc_realloc failed\\n\"));\n-\t\tTALLOC_FREE(name2);\n \t\treturn;\n \t}\n \n@@ -384,7 +378,11 @@\n \n \tchange = &(fsp->notify->changes[fsp->notify->num_changes]);\n \n-\tchange->name = talloc_move(changes, &name2);\n+\tif (!(change->name = talloc_strdup(changes, name2))) {\n+\t\tDEBUG(0, (\"talloc_strdup failed\\n\"));\n+\t\treturn;\n+\t}\n+\n \tchange->action = action;\n \tfsp->notify->num_changes += 1;\n \n@@ -400,7 +398,7 @@\n \t\t * We have to send the two rename events in one reply. So hold\n \t\t * the first part back.\n \t\t */\n-\treturn;\n+\t\treturn;\n \t}\n \n \t/*\n\nModified: branches/SAMBA_3_0_26/source/smbd/notify.c\n===================================================================\n--- branches/SAMBA_3_0_26/source/smbd/notify.c\t2007-05-07 19:27:46 UTC (rev 22754)\n+++ branches/SAMBA_3_0_26/source/smbd/notify.c\t2007-05-07 20:53:10 UTC (rev 22755)\n@@ -336,7 +336,7 @@\n static void notify_fsp(files_struct *fsp, uint32 action, const char *name)\n {\n \tstruct notify_change *change, *changes;\n-\tchar *name2;\n+\tpstring name2;\n \n \tif (fsp->notify == NULL) {\n \t\t/*\n@@ -345,11 +345,7 @@\n \t\treturn;\n \t}\n \n-\tif (!(name2 = talloc_strdup(fsp->notify, name))) {\n-\t\tDEBUG(0, (\"talloc_strdup failed\\n\"));\n-\t\t\treturn;\n-\t}\n-\n+\tpstrcpy(name2, name);\n \tstring_replace(name2, '/', '\\\\');\n \n \t/*\n@@ -363,7 +359,6 @@\n \t\t * guard against a DoS here.\n \t\t */\n \t\tTALLOC_FREE(fsp->notify->changes);\n-\t\tTALLOC_FREE(name2);\n \t\tfsp->notify->num_changes = -1;\n \t\treturn;\n \t}\n@@ -376,7 +371,6 @@\n \t\t      fsp->notify, fsp->notify->changes,\n \t\t      struct notify_change, fsp->notify->num_changes+1))) {\n \t\tDEBUG(0, (\"talloc_realloc failed\\n\"));\n-\t\tTALLOC_FREE(name2);\n \t\treturn;\n \t}\n \n@@ -384,7 +378,11 @@\n \n \tchange = &(fsp->notify->changes[fsp->notify->num_changes]);\n \n-\tchange->name = talloc_move(changes, &name2);\n+\tif (!(change->name = talloc_strdup(changes, name2))) {\n+\t\tDEBUG(0, (\"talloc_strdup failed\\n\"));\n+\t\treturn;\n+\t}\n+\n \tchange->action = action;\n \tfsp->notify->num_changes += 1;\n \n@@ -400,7 +398,7 @@\n \t\t * We have to send the two rename events in one reply. So hold\n \t\t * the first part back.\n \t\t */\n-\treturn;\n+\t\treturn;\n \t}\n \n \t/*\n\n"}