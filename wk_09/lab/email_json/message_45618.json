{"category": "ham", "to_address": "samba-cvs@samba.org", "from_address": "idra@samba.org", "subject": "svn commit: samba r23407 - in branches: SAMBA_3_0/source/utils\n\tSAMBA_3_0_25/source/utils SAMBA_3_0_26/source/utils", "body": "Author: idra\nDate: 2007-06-09 22:45:21 +0000 (Sat, 09 Jun 2007)\nNew Revision: 23407\n\nWebSVN: http://websvn.samba.org/cgi-bin/viewcvs.cgi?view=rev&root=samba&rev=23407\n\nLog:\n\nWhile verifying a bug I found out that for some reason\nthe code to add a machine was different then the one used\nto add a user, the old code led to the machine SID not being\nbuilt out correctly allocationg a new RID out of the passdb\nbut instead by using the old algorithmic method.\nThis may easily end up in creating duplicated SID when the\nRID counter get close to the values built by the algorithmic method.\n\nSimo.\n\n\nModified:\n   branches/SAMBA_3_0/source/utils/pdbedit.c\n   branches/SAMBA_3_0_25/source/utils/pdbedit.c\n   branches/SAMBA_3_0_26/source/utils/pdbedit.c\n\n\nChangeset:\nModified: branches/SAMBA_3_0/source/utils/pdbedit.c\n===================================================================\n--- branches/SAMBA_3_0/source/utils/pdbedit.c\t2007-06-09 19:29:35 UTC (rev 23406)\n+++ branches/SAMBA_3_0/source/utils/pdbedit.c\t2007-06-09 22:45:21 UTC (rev 23407)\n@@ -624,28 +624,25 @@\n \tfstrcpy(machineaccount, machinename);\n \tfstrcat(machineaccount, \"$\");\n \n-\tif ((pwd = getpwnam_alloc(NULL, machineaccount))) {\n+\tif ( !(pwd = getpwnam_alloc( NULL, machineaccount )) ) {\n+\t\tDEBUG(0,(\"Cannot locate Unix account for %s\\n\", machineaccount));\n+\t\treturn -1;\n+\t}\n \n-\t\tif ( (sam_pwent = samu_new( NULL )) == NULL ) {\n-\t\t\tfprintf(stderr, \"Memory allocation error!\\n\");\n-\t\t\tTALLOC_FREE(pwd);\n-\t\t\treturn -1;\n-\t\t}\n+\tif ( (sam_pwent = samu_new( NULL )) == NULL ) {\n+\t\tfprintf(stderr, \"Memory allocation error!\\n\");\n+\t\tTALLOC_FREE(pwd);\n+\t\treturn -1;\n+\t}\n \n-\t\tif ( !NT_STATUS_IS_OK(samu_set_unix(sam_pwent, pwd )) ) {\n-\t\t\tfprintf(stderr, \"Could not init sam from pw\\n\");\n-\t\t\tTALLOC_FREE(pwd);\n-\t\t\treturn -1;\n-\t\t}\n-\n+\tif ( !NT_STATUS_IS_OK(samu_alloc_rid_unix(sam_pwent, pwd )) ) {\n+\t\tfprintf(stderr, \"Could not init sam from pw\\n\");\n \t\tTALLOC_FREE(pwd);\n-\t} else {\n-\t\tif ( (sam_pwent = samu_new( NULL )) == NULL ) {\n-\t\t\tfprintf(stderr, \"Could not init sam from pw\\n\");\n-\t\t\treturn -1;\n-\t\t}\n+\t\treturn -1;\n \t}\n \n+\tTALLOC_FREE(pwd);\n+\n \tpdb_set_plaintext_passwd (sam_pwent, machinename);\n \tpdb_set_username (sam_pwent, machineaccount, PDB_CHANGED);\t\n \tpdb_set_acct_ctrl (sam_pwent, ACB_WSTRUST, PDB_CHANGED);\n\nModified: branches/SAMBA_3_0_25/source/utils/pdbedit.c\n===================================================================\n--- branches/SAMBA_3_0_25/source/utils/pdbedit.c\t2007-06-09 19:29:35 UTC (rev 23406)\n+++ branches/SAMBA_3_0_25/source/utils/pdbedit.c\t2007-06-09 22:45:21 UTC (rev 23407)\n@@ -624,28 +624,25 @@\n \tfstrcpy(machineaccount, machinename);\n \tfstrcat(machineaccount, \"$\");\n \n-\tif ((pwd = getpwnam_alloc(NULL, machineaccount))) {\n+\tif ( !(pwd = getpwnam_alloc( NULL, machineaccount )) ) {\n+\t\tDEBUG(0,(\"Cannot locate Unix account for %s\\n\", machineaccount));\n+\t\treturn -1;\n+\t}\n \n-\t\tif ( (sam_pwent = samu_new( NULL )) == NULL ) {\n-\t\t\tfprintf(stderr, \"Memory allocation error!\\n\");\n-\t\t\tTALLOC_FREE(pwd);\n-\t\t\treturn -1;\n-\t\t}\n+\tif ( (sam_pwent = samu_new( NULL )) == NULL ) {\n+\t\tfprintf(stderr, \"Memory allocation error!\\n\");\n+\t\tTALLOC_FREE(pwd);\n+\t\treturn -1;\n+\t}\n \n-\t\tif ( !NT_STATUS_IS_OK(samu_set_unix(sam_pwent, pwd )) ) {\n-\t\t\tfprintf(stderr, \"Could not init sam from pw\\n\");\n-\t\t\tTALLOC_FREE(pwd);\n-\t\t\treturn -1;\n-\t\t}\n-\n+\tif ( !NT_STATUS_IS_OK(samu_alloc_rid_unix(sam_pwent, pwd )) ) {\n+\t\tfprintf(stderr, \"Could not init sam from pw\\n\");\n \t\tTALLOC_FREE(pwd);\n-\t} else {\n-\t\tif ( (sam_pwent = samu_new( NULL )) == NULL ) {\n-\t\t\tfprintf(stderr, \"Could not init sam from pw\\n\");\n-\t\t\treturn -1;\n-\t\t}\n+\t\treturn -1;\n \t}\n \n+\tTALLOC_FREE(pwd);\n+\n \tpdb_set_plaintext_passwd (sam_pwent, machinename);\n \tpdb_set_username (sam_pwent, machineaccount, PDB_CHANGED);\t\n \tpdb_set_acct_ctrl (sam_pwent, ACB_WSTRUST, PDB_CHANGED);\n\nModified: branches/SAMBA_3_0_26/source/utils/pdbedit.c\n===================================================================\n--- branches/SAMBA_3_0_26/source/utils/pdbedit.c\t2007-06-09 19:29:35 UTC (rev 23406)\n+++ branches/SAMBA_3_0_26/source/utils/pdbedit.c\t2007-06-09 22:45:21 UTC (rev 23407)\n@@ -624,28 +624,25 @@\n \tfstrcpy(machineaccount, machinename);\n \tfstrcat(machineaccount, \"$\");\n \n-\tif ((pwd = getpwnam_alloc(NULL, machineaccount))) {\n+\tif ( !(pwd = getpwnam_alloc( NULL, machineaccount )) ) {\n+\t\tDEBUG(0,(\"Cannot locate Unix account for %s\\n\", machineaccount));\n+\t\treturn -1;\n+\t}\n \n-\t\tif ( (sam_pwent = samu_new( NULL )) == NULL ) {\n-\t\t\tfprintf(stderr, \"Memory allocation error!\\n\");\n-\t\t\tTALLOC_FREE(pwd);\n-\t\t\treturn -1;\n-\t\t}\n+\tif ( (sam_pwent = samu_new( NULL )) == NULL ) {\n+\t\tfprintf(stderr, \"Memory allocation error!\\n\");\n+\t\tTALLOC_FREE(pwd);\n+\t\treturn -1;\n+\t}\n \n-\t\tif ( !NT_STATUS_IS_OK(samu_set_unix(sam_pwent, pwd )) ) {\n-\t\t\tfprintf(stderr, \"Could not init sam from pw\\n\");\n-\t\t\tTALLOC_FREE(pwd);\n-\t\t\treturn -1;\n-\t\t}\n-\n+\tif ( !NT_STATUS_IS_OK(samu_alloc_rid_unix(sam_pwent, pwd )) ) {\n+\t\tfprintf(stderr, \"Could not init sam from pw\\n\");\n \t\tTALLOC_FREE(pwd);\n-\t} else {\n-\t\tif ( (sam_pwent = samu_new( NULL )) == NULL ) {\n-\t\t\tfprintf(stderr, \"Could not init sam from pw\\n\");\n-\t\t\treturn -1;\n-\t\t}\n+\t\treturn -1;\n \t}\n \n+\tTALLOC_FREE(pwd);\n+\n \tpdb_set_plaintext_passwd (sam_pwent, machinename);\n \tpdb_set_username (sam_pwent, machineaccount, PDB_CHANGED);\t\n \tpdb_set_acct_ctrl (sam_pwent, ACB_WSTRUST, PDB_CHANGED);\n\n"}