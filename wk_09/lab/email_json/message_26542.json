{"category": "ham", "to_address": "samba-cvs@samba.org", "from_address": "tridge@samba.org", "subject": "Rev 269: fixed setvnnmap to use wire structures too in\n\thttp://samba.org/~tridge/ctdb", "body": "------------------------------------------------------------\nrevno: 269\nrevision-id: tridge@samba.org-20070509222226-gxev7f84ugyfdkti\nparent: tridge@samba.org-20070509221319-2i6pfo0e6gudc6dz\ncommitter: Andrew Tridgell \nbranch nick: tridge\ntimestamp: Thu 2007-05-10 08:22:26 +1000\nmessage:\n  fixed setvnnmap to use wire structures too\nmodified:\n  common/ctdb_client.c           ctdb_client.c-20070411010216-3kd8v37k61steeya-1\n  common/ctdb_recover.c          ctdb_recover.c-20070503002147-admmfgt1oj6gexfo-1\n=== modified file 'common/ctdb_client.c'\n--- a/common/ctdb_client.c\t2007-05-09 22:13:19 +0000\n+++ b/common/ctdb_client.c\t2007-05-09 22:22:26 +0000\n@@ -990,9 +990,19 @@\n \tint ret;\n \tTDB_DATA data, outdata;\n \tint32_t res;\n-\n-\tdata.dsize = offsetof(struct ctdb_vnn_map, map) + 4*vnnmap->size;\n-\tdata.dptr  = (unsigned char *)vnnmap;\n+\tstruct ctdb_vnn_map_wire *map;\n+\tsize_t len;\n+\n+\tlen = offsetof(struct ctdb_vnn_map_wire, map) + sizeof(uint32_t)*vnnmap->size;\n+\tmap = talloc_size(mem_ctx, len);\n+\tCTDB_NO_MEMORY_VOID(ctdb, map);\n+\n+\tmap->generation = vnnmap->generation;\n+\tmap->size = vnnmap->size;\n+\tmemcpy(map->map, vnnmap->map, sizeof(uint32_t)*map->size);\n+\t\n+\tdata.dsize = len;\n+\tdata.dptr  = (uint8_t *)map;\n \n \tret = ctdb_control(ctdb, destnode, 0, \n \t\t\t   CTDB_CONTROL_SETVNNMAP, 0, data, \n@@ -1002,6 +1012,8 @@\n \t\treturn -1;\n \t}\n \n+\ttalloc_free(map);\n+\n \treturn 0;\n }\n \n\n=== modified file 'common/ctdb_recover.c'\n--- a/common/ctdb_recover.c\t2007-05-09 22:13:19 +0000\n+++ b/common/ctdb_recover.c\t2007-05-09 22:22:26 +0000\n@@ -52,12 +52,19 @@\n int \n ctdb_control_setvnnmap(struct ctdb_context *ctdb, uint32_t opcode, TDB_DATA indata, TDB_DATA *outdata)\n {\n-\tif (ctdb->vnn_map) {\n-\t\ttalloc_free(ctdb->vnn_map);\n-\t\tctdb->vnn_map = NULL;\n-\t}\n-\n-\tctdb->vnn_map = (struct ctdb_vnn_map *)talloc_memdup(ctdb, indata.dptr, indata.dsize);\n+\tstruct ctdb_vnn_map_wire *map = (struct ctdb_vnn_map_wire *)indata.dptr;\n+\n+\ttalloc_free(ctdb->vnn_map);\n+\n+\tctdb->vnn_map = talloc(ctdb, struct ctdb_vnn_map);\n+\tCTDB_NO_MEMORY(ctdb, ctdb->vnn_map);\n+\n+\tctdb->vnn_map->generation = map->generation;\n+\tctdb->vnn_map->size       = map->size;\n+\tctdb->vnn_map->map = talloc_array(ctdb->vnn_map, uint32_t, map->size);\n+\tCTDB_NO_MEMORY(ctdb, ctdb->vnn_map->map);\n+\n+\tmemcpy(ctdb->vnn_map->map, map->map, sizeof(uint32_t)*map->size);\n \n \treturn 0;\n }\n\n"}