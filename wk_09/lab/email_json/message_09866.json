{"category": "ham", "to_address": "samba-cvs@samba.org", "from_address": "gd@samba.org", "subject": "svn commit: samba r22370 - in branches/SAMBA_3_0_25/source: .\n\tinclude libads libsmb", "body": "Author: gd\nDate: 2007-04-19 13:13:09 +0000 (Thu, 19 Apr 2007)\nNew Revision: 22370\n\nWebSVN: http://websvn.samba.org/cgi-bin/viewcvs.cgi?view=rev&root=samba&rev=22370\n\nLog:\nMerge -r21777:21779 from 3_0 to fix the build with Heimdal 0.8.\n\nGuenther\n\nModified:\n   branches/SAMBA_3_0_25/source/configure.in\n   branches/SAMBA_3_0_25/source/include/includes.h\n   branches/SAMBA_3_0_25/source/libads/kerberos.c\n   branches/SAMBA_3_0_25/source/libsmb/clikrb5.c\n\n\nChangeset:\nModified: branches/SAMBA_3_0_25/source/configure.in\n===================================================================\n--- branches/SAMBA_3_0_25/source/configure.in\t2007-04-19 12:51:04 UTC (rev 22369)\n+++ branches/SAMBA_3_0_25/source/configure.in\t2007-04-19 13:13:09 UTC (rev 22370)\n@@ -3564,6 +3564,26 @@\n \t    [Whether the krb5_ticket structure contains the kvno and enctype])\n   fi\n \n+  AC_CACHE_CHECK(whether krb5_get_init_creds_opt_free takes a context argument,\n+\t  smb_krb5_creds_opt_free_context,\n+\t  [\n+\t\tAC_TRY_COMPILE([\n+\t\t    #include ],\n+\t\t    [\n+\t\t\tkrb5_context ctx;\n+\t\t\tkrb5_get_init_creds_opt *opt = NULL;\n+\t\t\tkrb5_get_init_creds_opt_free(ctx, opt);\n+\t\t    ],\n+\t\t    [smb_krb5_creds_opt_free_context=yes],\n+\t\t    [smb_krb5_creds_opt_free_context=no]\n+\t\t)\n+\t  ])\n+\n+  if test x\"$smb_krb5_creds_opt_free_context\" = x\"yes\" ; then\n+\tAC_DEFINE(KRB5_CREDS_OPT_FREE_REQUIRES_CONTEXT, 1,\n+\t    [Whether krb5_get_init_creds_opt_free takes a context argument])\n+  fi\n+\n   AC_CACHE_CHECK(whether krb5_verify_checksum takes 7 arguments, smb_krb5_verify_checksum, [\n     AC_TRY_COMPILE([\n \t#include ],\n\nModified: branches/SAMBA_3_0_25/source/include/includes.h\n===================================================================\n--- branches/SAMBA_3_0_25/source/include/includes.h\t2007-04-19 12:51:04 UTC (rev 22369)\n+++ branches/SAMBA_3_0_25/source/include/includes.h\t2007-04-19 13:13:09 UTC (rev 22370)\n@@ -1191,8 +1191,11 @@\n void smb_krb5_free_error(krb5_context context, krb5_error *krberror);\n krb5_error_code handle_krberror_packet(krb5_context context,\n                                          krb5_data *packet);\n-void krb5_get_init_creds_opt_free(krb5_get_init_creds_opt *opt);\n-krb5_error_code krb5_get_init_creds_opt_alloc(krb5_context context, krb5_get_init_creds_opt **opt);\n+\n+void smb_krb5_get_init_creds_opt_free(krb5_context context,\n+\t\t\t\t    krb5_get_init_creds_opt *opt);\n+krb5_error_code smb_krb5_get_init_creds_opt_alloc(krb5_context context,\n+\t\t\t\t    krb5_get_init_creds_opt **opt);\n krb5_error_code smb_krb5_mk_error(krb5_context context,\n \t\t\t\t\tkrb5_error_code error_code,\n \t\t\t\t\tconst krb5_principal server,\n\nModified: branches/SAMBA_3_0_25/source/libads/kerberos.c\n===================================================================\n--- branches/SAMBA_3_0_25/source/libads/kerberos.c\t2007-04-19 12:51:04 UTC (rev 22369)\n+++ branches/SAMBA_3_0_25/source/libads/kerberos.c\t2007-04-19 13:13:09 UTC (rev 22370)\n@@ -101,7 +101,7 @@\n \t\treturn code;\n \t}\n \n-\tcode = krb5_get_init_creds_opt_alloc(ctx, &opt);\n+\tcode = smb_krb5_get_init_creds_opt_alloc(ctx, &opt);\n \tif (code) {\n \t\tkrb5_cc_close(ctx, cc);\n \t\tkrb5_free_context(ctx);\t\n@@ -140,7 +140,7 @@\n \tif ((code = krb5_get_init_creds_password(ctx, &my_creds, me, CONST_DISCARD(char *,password), \n \t\t\t\t\t\t kerb_prompter, NULL, 0, NULL, opt)))\n \t{\n-\t\tkrb5_get_init_creds_opt_free(opt);\n+\t\tsmb_krb5_get_init_creds_opt_free(ctx, opt);\n \t\tsmb_krb5_free_addresses(ctx, addr);\n \t\tkrb5_cc_close(ctx, cc);\n \t\tkrb5_free_principal(ctx, me);\n@@ -148,7 +148,7 @@\n \t\treturn code;\n \t}\n \n-\tkrb5_get_init_creds_opt_free(opt);\n+\tsmb_krb5_get_init_creds_opt_free(ctx, opt);\n \n \tif ((code = krb5_cc_initialize(ctx, cc, me))) {\n \t\tsmb_krb5_free_addresses(ctx, addr);\n\nModified: branches/SAMBA_3_0_25/source/libsmb/clikrb5.c\n===================================================================\n--- branches/SAMBA_3_0_25/source/libsmb/clikrb5.c\t2007-04-19 12:51:04 UTC (rev 22369)\n+++ branches/SAMBA_3_0_25/source/libsmb/clikrb5.c\t2007-04-19 13:13:09 UTC (rev 22370)\n@@ -1399,9 +1399,14 @@\n \treturn ret;\n }\n \n-#ifndef HAVE_KRB5_GET_INIT_CREDS_OPT_ALLOC \n- krb5_error_code krb5_get_init_creds_opt_alloc(krb5_context context, krb5_get_init_creds_opt **opt)\n+ krb5_error_code smb_krb5_get_init_creds_opt_alloc(krb5_context context,\n+\t\t\t\t\t    krb5_get_init_creds_opt **opt)\n {\n+#ifdef HAVE_KRB5_GET_INIT_CREDS_OPT_ALLOC\n+\t/* Heimdal or modern MIT version */\n+\treturn krb5_get_init_creds_opt_alloc(context, opt);\n+#else\n+\t/* Historical MIT version */\n \tkrb5_get_init_creds_opt *my_opt;\n \n \t*opt = NULL;\n@@ -1414,16 +1419,28 @@\n \n \t*opt =  my_opt;\n \treturn 0;\n+#endif /* HAVE_KRB5_GET_INIT_CREDS_OPT_ALLOC  */\n }\n+\n+ void smb_krb5_get_init_creds_opt_free(krb5_context context,\n+\t\t\t\tkrb5_get_init_creds_opt *opt)\n+{\n+#ifdef HAVE_KRB5_GET_INIT_CREDS_OPT_FREE\n+\n+#ifdef KRB5_CREDS_OPT_FREE_REQUIRES_CONTEXT\n+\t/* Modern MIT version */\n+\tkrb5_get_init_creds_opt_free(context, opt);\n+#else\n+\t/* Heimdal version */\n+\tkrb5_get_init_creds_opt_free(opt);\n #endif\n \n-#ifndef HAVE_KRB5_GET_INIT_CREDS_OPT_FREE \n- void krb5_get_init_creds_opt_free(krb5_get_init_creds_opt *opt)\n-{\n+#else /* HAVE_KRB5_GET_INIT_CREDS_OPT_FREE */\n+\t/* Historical MIT version */\n \tSAFE_FREE(opt);\n \topt = NULL;\n+#endif /* HAVE_KRB5_GET_INIT_CREDS_OPT_FREE */\n }\n-#endif\n \n  krb5_error_code smb_krb5_mk_error(krb5_context context,\n \t\t\t\tkrb5_error_code error_code,\n\n"}