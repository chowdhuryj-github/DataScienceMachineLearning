{"category": "ham", "to_address": "samba-cvs@samba.org", "from_address": "tridge@samba.org", "subject": "Rev 200: nicer testing of control data size in\n\thttp://samba.org/~tridge/ctdb", "body": "------------------------------------------------------------\nrevno: 200\nrevision-id: tridge@samba.org-20070427124944-2j7heznacmw08fim\nparent: tridge@samba.org-20070427124545-ndyfb1xifibkme1t\ncommitter: Andrew Tridgell \nbranch nick: tridge\ntimestamp: Fri 2007-04-27 14:49:44 +0200\nmessage:\n  nicer testing of control data size\nmodified:\n  common/ctdb_control.c          ctdb_control.c-20070426122724-j6gkpiofhbwdin63-1\n=== modified file 'common/ctdb_control.c'\n--- a/common/ctdb_control.c\t2007-04-27 12:08:12 +0000\n+++ b/common/ctdb_control.c\t2007-04-27 12:49:44 +0000\n@@ -33,6 +33,13 @@\n \tvoid *private_data;\n };\n \n+#define CHECK_CONTROL_DATA_SIZE(size) do { \\\n+ if (indata.dsize != sizeof(pid_t)) { \\\n+\t DEBUG(0,(__location__ \" Invalid data in opcode %u\\n\", opcode)); \\\n+\t return -1; \\\n+ } \\\n+ } while (0)\n+\n /*\n   process a control request\n  */\n@@ -43,15 +50,13 @@\n \tswitch (opcode) {\n \tcase CTDB_CONTROL_PROCESS_EXISTS: {\n \t\tpid_t pid;\n-\t\tif (indata.dsize != sizeof(pid_t)) {\n-\t\t\tDEBUG(0,(__location__ \" Invalid data in CTDB_CONTROL_PROCESS_EXISTS\\n\"));\n-\t\t\treturn -1;\n-\t\t}\n+\t\tCHECK_CONTROL_DATA_SIZE(sizeof(pid));\n \t\tpid = *(pid_t *)indata.dptr;\n \t\treturn kill(pid, 0);\n \t}\n \n \tcase CTDB_CONTROL_STATUS: {\n+\t\tCHECK_CONTROL_DATA_SIZE(0);\n \t\toutdata->dptr = (uint8_t *)&ctdb->status;\n \t\toutdata->dsize = sizeof(ctdb->status);\n \t\treturn 0;\n@@ -59,7 +64,7 @@\n \n \tcase CTDB_CONTROL_GETVNNMAP: {\n \t\tuint32_t i, len;\n-\n+\t\tCHECK_CONTROL_DATA_SIZE(0);\n \t\tlen = 2+ctdb->vnn_map->size;\n \t\toutdata->dsize = 4*len;\n \t\toutdata->dptr = (unsigned char *)talloc_array(outdata, uint32_t, len);\n@@ -95,22 +100,21 @@\n \t}\n \n \tcase CTDB_CONTROL_CONFIG: {\n+\t\tCHECK_CONTROL_DATA_SIZE(0);\n \t\toutdata->dptr = (uint8_t *)ctdb;\n \t\toutdata->dsize = sizeof(*ctdb);\n \t\treturn 0;\n \t}\n \n \tcase CTDB_CONTROL_PING:\n+\t\tCHECK_CONTROL_DATA_SIZE(0);\n \t\treturn 0;\n \n \tcase CTDB_CONTROL_GETDBPATH: {\n \t\tuint32_t db_id;\n \t\tstruct ctdb_db_context *ctdb_db;\n \n-\t\tif (indata.dsize != sizeof(uint32_t)) {\n-\t\t\tDEBUG(0,(__location__ \" Invalid data in CTDB_CONTROL_GETDBPATH\\n\"));\n-\t\t\treturn -1;\n-\t\t}\n+\t\tCHECK_CONTROL_DATA_SIZE(db_id);\n \t\tdb_id = *(uint32_t *)indata.dptr;\n \t\tctdb_db = find_ctdb_db(ctdb, db_id);\n \t\tif (ctdb_db == NULL) return -1;\n\n"}