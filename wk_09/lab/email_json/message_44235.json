{"category": "ham", "to_address": "samba-cvs@samba.org", "from_address": "tridge@samba.org", "subject": "Rev 500: more code rearrangement in http://samba.org/~tridge/ctdb", "body": "------------------------------------------------------------\nrevno: 500\nrevision-id: tridge@samba.org-20070607121648-wml5bxdf98o94rqh\nparent: tridge@samba.org-20070607120619-egp84n6ztuhc9520\ncommitter: Andrew Tridgell \nbranch nick: tridge\ntimestamp: Thu 2007-06-07 22:16:48 +1000\nmessage:\n  more code rearrangement\nrenamed:\n  server/ctdb.c => server/ctdb_server.c ctdb.c-20061127094323-t50f58d65iaao5of-2\n  tools/ctdb_control.c => tools/ctdb.c ctdb_control.c-20070426122705-9ehj1l5lu2gn9kuj-1\nmodified:\n  .bzrignore                     bzrignore-20061117235536-slq8jlz2b5161dfm-1\n  Makefile.in                    makefile.in-20061117234101-o3qt14umlg9en8z0-1\n  client/ctdb_client.c           ctdb_client.c-20070411010216-3kd8v37k61steeya-1\n  tests/recover.sh               recover.sh-20070502031230-tpuiet6m6tjdotta-1\n=== renamed file 'server/ctdb.c' => 'server/ctdb_server.c'\n=== renamed file 'tools/ctdb_control.c' => 'tools/ctdb.c'\n=== modified file '.bzrignore'\n--- a/.bzrignore\t2007-06-04 09:53:19 +0000\n+++ b/.bzrignore\t2007-06-07 12:16:48 +0000\n@@ -19,3 +19,6 @@\n web/packages\n rec.lock\n test.db\n+sock.1\n+sock.3\n+sock.4\n\n=== modified file 'Makefile.in'\n--- a/Makefile.in\t2007-06-07 12:06:19 +0000\n+++ b/Makefile.in\t2007-06-07 12:16:48 +0000\n@@ -22,7 +22,8 @@\n \n CFLAGS=-g -I$(srcdir)/include -Iinclude -Ilib -Ilib/util -I$(srcdir) \\\n        -I@tallocdir@ -I@tdbdir@/include -I@libreplacedir@ \\\n-\t-DVARDIR=\\\"$(localstatedir)\\\" -DETCDIR=\\\"$(etcdir)\\\" -DUSE_MMAP=1 @CFLAGS@ $(POPT_CFLAGS)\n+\t-DVARDIR=\\\"$(localstatedir)\\\" -DETCDIR=\\\"$(etcdir)\\\" \\\n+\t-DUSE_MMAP=1 @CFLAGS@ $(POPT_CFLAGS)\n \n LIB_FLAGS=@LDFLAGS@ -Llib @LIBS@ $(POPT_LIBS) @INFINIBAND_LIBS@\n \n@@ -35,14 +36,15 @@\n CTDB_TCP_OBJ = tcp/tcp_connect.o tcp/tcp_io.o tcp/tcp_init.o\n \n CTDB_CLIENT_OBJ = client/ctdb_client.o \\\n-\t$(CTDB_COMMON_OBJ) $(POPT_OBJ) $(UTIL_OBJ) @TALLOC_OBJ@ @TDB_OBJ@ @LIBREPLACEOBJ@ \\\n-\t$(EXTRA_OBJ) @EVENTS_OBJ@ \n+\t$(CTDB_COMMON_OBJ) $(POPT_OBJ) $(UTIL_OBJ) @TALLOC_OBJ@ @TDB_OBJ@ \\\n+\t@LIBREPLACEOBJ@ $(EXTRA_OBJ) @EVENTS_OBJ@ \n \n CTDB_TAKEOVER_OBJ = takeover/system.o takeover/ctdb_takeover.o\n \n-CTDB_SERVER_OBJ = server/ctdbd.o server/ctdb_daemon.o server/ctdb_lockwait.o server/ctdb_recoverd.o \\\n-\tserver/ctdb_recover.o server/ctdb_freeze.o server/ctdb_tunables.o server/ctdb_monitor.o \\\n-\tserver/ctdb.o server/ctdb_control.o server/ctdb_call.o server/ctdb_ltdb_server.o \\\n+CTDB_SERVER_OBJ = server/ctdbd.o server/ctdb_daemon.o server/ctdb_lockwait.o \\\n+\tserver/ctdb_recoverd.o server/ctdb_recover.o server/ctdb_freeze.o \\\n+\tserver/ctdb_tunables.o server/ctdb_monitor.o server/ctdb_server.o \\\n+\tserver/ctdb_control.o server/ctdb_call.o server/ctdb_ltdb_server.o \\\n \tserver/ctdb_traverse.o $(CTDB_CLIENT_OBJ) \\\n \t$(CTDB_TAKEOVER_OBJ) $(CTDB_TCP_OBJ) @INFINIBAND_WRAPPER_OBJ@\n \n@@ -71,9 +73,9 @@\n \t@echo Linking $@\n \t@$(CC) $(CFLAGS) -o $@ $(CTDB_SERVER_OBJ) $(LIB_FLAGS)\n \n-bin/ctdb: $(OBJS) tools/ctdb_control.o \n+bin/ctdb: $(CLIENT_OBJS) tools/ctdb.o \n \t@echo Linking $@\n-\t@$(CC) $(CFLAGS) -o $@ tools/ctdb_control.o $(CTDB_CLIENT_OBJ) $(LIB_FLAGS)\n+\t@$(CC) $(CFLAGS) -o $@ tools/ctdb.o $(CTDB_CLIENT_OBJ) $(LIB_FLAGS)\n \n bin/ctdb_bench: $(CTDB_CLIENT_OBJ) tests/ctdb_bench.o \n \t@echo Linking $@\n@@ -88,7 +90,7 @@\n \t@$(CC) $(CFLAGS) -o $@ ib/ibwrapper_test.o $(CTDB_CLIENT_OBJ) $(LIB_FLAGS)\n \n clean:\n-\trm -f *.o */*.o */*/*.o\n+\trm -f *.o */*.o */*/*.o */*~\n \trm -f $(BINS) $(SBINS) $(TEST_BINS)\n \n distclean: clean\n\n=== modified file 'client/ctdb_client.c'\n--- a/client/ctdb_client.c\t2007-06-07 12:06:19 +0000\n+++ b/client/ctdb_client.c\t2007-06-07 12:16:48 +0000\n@@ -2099,7 +2099,9 @@\n \tstruct ctdb_context *ctdb;\n \n \tctdb = talloc_zero(ev, struct ctdb_context);\n-\tctdb->ev               = ev;\n+\tctdb->ev  = ev;\n+\tctdb->idr = idr_init(ctdb);\n+\tCTDB_NO_MEMORY_NULL(ctdb, ctdb->idr);\n \n \treturn ctdb;\n }\n\n=== modified file 'tests/recover.sh'\n--- a/tests/recover.sh\t2007-05-29 05:15:00 +0000\n+++ b/tests/recover.sh\t2007-06-07 12:16:48 +0000\n@@ -3,10 +3,10 @@\n killall -q ctdbd\n \n echo \"Starting 4 ctdb daemons\"\n-bin/ctdbd --recovery-daemon --nlist direct/4nodes.txt\n-bin/ctdbd --recovery-daemon --nlist direct/4nodes.txt --listen=127.0.0.2 --socket=/tmp/ctdb.socket.127.0.0.2\n-bin/ctdbd --recovery-daemon --nlist direct/4nodes.txt --listen=127.0.0.3 --socket=/tmp/ctdb.socket.127.0.0.3\n-bin/ctdbd --recovery-daemon --nlist direct/4nodes.txt --listen=127.0.0.4 --socket=/tmp/ctdb.socket.127.0.0.4\n+bin/ctdbd --recovery-daemon --nlist tests/4nodes.txt\n+bin/ctdbd --recovery-daemon --nlist tests/4nodes.txt --listen=127.0.0.2 --socket=/tmp/ctdb.socket.127.0.0.2\n+bin/ctdbd --recovery-daemon --nlist tests/4nodes.txt --listen=127.0.0.3 --socket=/tmp/ctdb.socket.127.0.0.3\n+bin/ctdbd --recovery-daemon --nlist tests/4nodes.txt --listen=127.0.0.4 --socket=/tmp/ctdb.socket.127.0.0.4\n \n echo\n echo \"Attaching to some databases\"\n\n"}