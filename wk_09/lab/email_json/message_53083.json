{"category": "ham", "to_address": "samba-cvs@samba.org", "from_address": "jra@samba.org", "subject": "svn commit: samba r23590 - in branches:\n\tSAMBA_3_0/source/lib/tdb/common SAMBA_3_0_25/source/tdb/common\n\tSAMBA_3_0_26/source/lib/tdb/common SAMBA_4_0/source/lib/tdb/common", "body": "Author: jra\nDate: 2007-06-22 17:36:10 +0000 (Fri, 22 Jun 2007)\nNew Revision: 23590\n\nWebSVN: http://websvn.samba.org/cgi-bin/viewcvs.cgi?view=rev&root=samba&rev=23590\n\nLog:\nFix realloc leak on failure case from Jim Meyering  .\nJeremy.\n\nModified:\n   branches/SAMBA_3_0/source/lib/tdb/common/tdb.c\n   branches/SAMBA_3_0_25/source/tdb/common/tdb.c\n   branches/SAMBA_3_0_26/source/lib/tdb/common/tdb.c\n   branches/SAMBA_4_0/source/lib/tdb/common/tdb.c\n\n\nChangeset:\nModified: branches/SAMBA_3_0/source/lib/tdb/common/tdb.c\n===================================================================\n--- branches/SAMBA_3_0/source/lib/tdb/common/tdb.c\t2007-06-22 17:19:08 UTC (rev 23589)\n+++ branches/SAMBA_3_0/source/lib/tdb/common/tdb.c\t2007-06-22 17:36:10 UTC (rev 23590)\n@@ -566,8 +566,12 @@\n \tif (dbuf.dptr == NULL) {\n \t\tdbuf.dptr = (unsigned char *)malloc(new_dbuf.dsize);\n \t} else {\n-\t\tdbuf.dptr = (unsigned char *)realloc(dbuf.dptr,\n+\t\tunsigned char *new_dptr = (unsigned char *)realloc(dbuf.dptr,\n \t\t\t\t\t\t     dbuf.dsize + new_dbuf.dsize);\n+\t\tif (new_dptr == NULL) {\n+\t\t\tfree(dbuf.dptr);\n+\t\t}\n+\t\tdbuf.dptr = new_dptr;\n \t}\n \n \tif (dbuf.dptr == NULL) {\n\nModified: branches/SAMBA_3_0_25/source/tdb/common/tdb.c\n===================================================================\n--- branches/SAMBA_3_0_25/source/tdb/common/tdb.c\t2007-06-22 17:19:08 UTC (rev 23589)\n+++ branches/SAMBA_3_0_25/source/tdb/common/tdb.c\t2007-06-22 17:36:10 UTC (rev 23590)\n@@ -566,8 +566,12 @@\n \tif (dbuf.dptr == NULL) {\n \t\tdbuf.dptr = (char *)malloc(new_dbuf.dsize);\n \t} else {\n-\t\tdbuf.dptr = (char *)realloc(dbuf.dptr,\n+\t\tchar *new_dptr = (char *)realloc(dbuf.dptr,\n \t\t\t\t\t    dbuf.dsize + new_dbuf.dsize);\n+\t\tif (new_dptr == NULL) {\n+\t\t\tfree(dbuf.dptr);\n+\t\t}\n+\t\tdbuf.dptr = new_dptr;\n \t}\n \n \tif (dbuf.dptr == NULL) {\n\nModified: branches/SAMBA_3_0_26/source/lib/tdb/common/tdb.c\n===================================================================\n--- branches/SAMBA_3_0_26/source/lib/tdb/common/tdb.c\t2007-06-22 17:19:08 UTC (rev 23589)\n+++ branches/SAMBA_3_0_26/source/lib/tdb/common/tdb.c\t2007-06-22 17:36:10 UTC (rev 23590)\n@@ -566,8 +566,12 @@\n \tif (dbuf.dptr == NULL) {\n \t\tdbuf.dptr = (unsigned char *)malloc(new_dbuf.dsize);\n \t} else {\n-\t\tdbuf.dptr = (unsigned char *)realloc(dbuf.dptr,\n+\t\tunsigned char *new_dptr = (unsigned char *)realloc(dbuf.dptr,\n \t\t\t\t\t\t     dbuf.dsize + new_dbuf.dsize);\n+\t\tif (new_dptr == NULL) {\n+\t\t\tfree(dbuf.dptr);\n+\t\t}\n+\t\tdbuf.dptr = new_dptr;\n \t}\n \n \tif (dbuf.dptr == NULL) {\n\nModified: branches/SAMBA_4_0/source/lib/tdb/common/tdb.c\n===================================================================\n--- branches/SAMBA_4_0/source/lib/tdb/common/tdb.c\t2007-06-22 17:19:08 UTC (rev 23589)\n+++ branches/SAMBA_4_0/source/lib/tdb/common/tdb.c\t2007-06-22 17:36:10 UTC (rev 23590)\n@@ -579,8 +579,12 @@\n \tif (dbuf.dptr == NULL) {\n \t\tdbuf.dptr = (unsigned char *)malloc(new_dbuf.dsize);\n \t} else {\n-\t\tdbuf.dptr = (unsigned char *)realloc(dbuf.dptr,\n+\t\tunsigned char *new_dptr = (unsigned char *)realloc(dbuf.dptr,\n \t\t\t\t\t\t     dbuf.dsize + new_dbuf.dsize);\n+\t\tif (new_dptr == NULL) {\n+\t\t\tfree(dbuf.dptr);\n+\t\t}\n+\t\tdbuf.dptr = new_dptr;\n \t}\n \n \tif (dbuf.dptr == NULL) {\n\n"}