{"category": "ham", "to_address": "samba-technical@lists.samba.org", "from_address": "\"Robert Rappaport\" <robert.rappaport@gmail.com>", "subject": "samba not responding to linux __break_lease() call.", "body": "A couple of weeks ago I posted a message with the above subject to the samba\ngeneral interest list and I received a response from Volker Lendecke.  We\nsubsequently interchanged several mail messages on this subject.  I now have\nsome more evidence about my problem and I would like to know if anyone can\nhelp.\n\nBasically I see the foolwoing sequence of calls:\n\n  First  __break_lease() is called and it then calls:\n\n      lease_break_callback() => kill_fasync() => __kill_fasync() =>\nsend_sigio() => send_sigio_to_task() => sigio_perm()\n\nThis is where it fails because sigio_perm() is called in\nsend_sigio_to_task() with the following lines of code:\n\n        if (!sigio_perm(p, fown, fown->signum))\n                return;\n\nAnd I am seeing an early return from send_sigio_to_task() with ever having\ncalled the following sequence:\n\n       group_send_sig_info() => __group_send_sig_info() => send_signal()\n\nBecause send_signal() is not being called the signal is not delivered to the\nsmbd task and the lease is not being released.\n\nRoutine, sigio_perm() is very simple:\n\nstatic inline int sigio_perm(struct task_struct *p,\n                             struct fown_struct *fown, int sig)\n{\n        return (((fown->euid == 0) ||\n                 (fown->euid == p->suid) || (fown->euid == p->uid) ||\n                 (fown->uid == p->suid) || (fown->uid == p->uid)) &&\n                !security_file_send_sigiotask(p, fown, sig));\n}\n\nand the problem I see is that it is returning the value zero because:\n\n           fown->euid is 500\n           fown-> uid  is 500\n           p->uid        is 0\n           p->suid      is 0\n\nwhere p is a pointer to the task_stuct of the smbd task.\n\nIt appears to me that the euid and the uid of the file owner being 500 is\nprobably correct in that that should reflect the properties of the PC client\nfor whom samba has opened the file.  But I am not sure what the smbd task\nshould have in its task_struct and if the values I see represent an error.\n\nI am running samba-3.0.24-3.fc6 on linux 2.6.19.5.\n\nI have observed this behavior when running with my own file system and also\nwith an ext3 file system served to a PC client.\n\nI would be grateful for any help in resolving this.\n\n- Robert Rappaport\n\n"}