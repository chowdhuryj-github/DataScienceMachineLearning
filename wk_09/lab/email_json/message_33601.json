{"category": "ham", "to_address": "samba-cvs@samba.org", "from_address": "tridge@samba.org", "subject": "svn commit: samba r23036 - in branches/SAMBA_4_0/source:\n\tauth/gensec auth/kerberos ldap_server libcli/cldap\n\tlibcli/ldap libcli/util", "body": "Author: tridge\nDate: 2007-05-21 12:47:18 +0000 (Mon, 21 May 2007)\nNew Revision: 23036\n\nWebSVN: http://websvn.samba.org/cgi-bin/viewcvs.cgi?view=rev&root=samba&rev=23036\n\nLog:\n\nerror checking on asn1_init() failure\n\nModified:\n   branches/SAMBA_4_0/source/auth/gensec/spnego_parse.c\n   branches/SAMBA_4_0/source/auth/kerberos/gssapi_parse.c\n   branches/SAMBA_4_0/source/ldap_server/ldap_server.c\n   branches/SAMBA_4_0/source/libcli/cldap/cldap.c\n   branches/SAMBA_4_0/source/libcli/ldap/ldap.c\n   branches/SAMBA_4_0/source/libcli/ldap/ldap_client.c\n   branches/SAMBA_4_0/source/libcli/ldap/ldap_controls.c\n   branches/SAMBA_4_0/source/libcli/util/asn1.c\n\n\nChangeset:\nModified: branches/SAMBA_4_0/source/auth/gensec/spnego_parse.c\n===================================================================\n--- branches/SAMBA_4_0/source/auth/gensec/spnego_parse.c\t2007-05-21 12:03:15 UTC (rev 23035)\n+++ branches/SAMBA_4_0/source/auth/gensec/spnego_parse.c\t2007-05-21 12:47:18 UTC (rev 23036)\n@@ -265,7 +265,7 @@\n \n ssize_t spnego_read_data(TALLOC_CTX *mem_ctx, DATA_BLOB data, struct spnego_data *token)\n {\n-\tstruct asn1_data *asn1 = asn1_init(mem_ctx);\n+\tstruct asn1_data *asn1;\n \tssize_t ret = -1;\n \tuint8_t context;\n \n@@ -275,6 +275,11 @@\n \t\treturn ret;\n \t}\n \n+\tasn1 = asn1_init(mem_ctx);\n+\tif (asn1 == NULL) {\n+\t\treturn -1;\n+\t}\n+\n \tasn1_load(asn1, data);\n \n \tif (!asn1_peek_uint8(asn1, &context)) {\n@@ -311,6 +316,10 @@\n \tstruct asn1_data *asn1 = asn1_init(mem_ctx);\n \tssize_t ret = -1;\n \n+\tif (asn1 == NULL) {\n+\t\treturn -1;\n+\t}\n+\n \tswitch (spnego->type) {\n \tcase SPNEGO_NEG_TOKEN_INIT:\n \t\tasn1_push_tag(asn1, ASN1_APPLICATION(0));\n\nModified: branches/SAMBA_4_0/source/auth/kerberos/gssapi_parse.c\n===================================================================\n--- branches/SAMBA_4_0/source/auth/kerberos/gssapi_parse.c\t2007-05-21 12:03:15 UTC (rev 23035)\n+++ branches/SAMBA_4_0/source/auth/kerberos/gssapi_parse.c\t2007-05-21 12:47:18 UTC (rev 23036)\n@@ -31,13 +31,18 @@\n */\n DATA_BLOB gensec_gssapi_gen_krb5_wrap(TALLOC_CTX *mem_ctx, const DATA_BLOB *ticket, const uint8_t tok_id[2])\n {\n-\tstruct asn1_data *data = asn1_init(mem_ctx);\n+\tstruct asn1_data *data;\n \tDATA_BLOB ret;\n \n \tif (!data || !ticket->data) {\n \t\treturn data_blob(NULL,0);\n \t}\n \n+\tdata = asn1_init(mem_ctx);\n+\tif (data == NULL) {\n+\t\treturn data_blob(NULL,0);\n+\t}\n+\n \tasn1_push_tag(data, ASN1_APPLICATION(0));\n \tasn1_write_OID(data, GENSEC_OID_KERBEROS5);\n \n@@ -66,6 +71,10 @@\n \tstruct asn1_data *data = asn1_init(mem_ctx);\n \tint data_remaining;\n \n+\tif (!data) {\n+\t\treturn False;\n+\t}\n+\n \tasn1_load(data, *blob);\n \tasn1_start_tag(data, ASN1_APPLICATION(0));\n \tasn1_check_OID(data, GENSEC_OID_KERBEROS5);\n@@ -99,6 +108,8 @@\n \tBOOL ret;\n \tstruct asn1_data *data = asn1_init(NULL);\n \n+\tif (!data) return False;\n+\n \tasn1_load(data, *blob);\n \tasn1_start_tag(data, ASN1_APPLICATION(0));\n \tasn1_check_OID(data, oid);\n\nModified: branches/SAMBA_4_0/source/ldap_server/ldap_server.c\n===================================================================\n--- branches/SAMBA_4_0/source/ldap_server/ldap_server.c\t2007-05-21 12:03:15 UTC (rev 23035)\n+++ branches/SAMBA_4_0/source/ldap_server/ldap_server.c\t2007-05-21 12:47:18 UTC (rev 23036)\n@@ -137,11 +137,13 @@\n \tstruct asn1_data *asn1 = asn1_init(conn);\n \tstruct ldap_message *msg = talloc(conn, struct ldap_message);\n \n-\tif (msg == NULL) {\n+\tif (asn1 == NULL || msg == NULL) {\n \t\treturn NT_STATUS_NO_MEMORY;\n \t}\n \n \tif (!asn1_load(asn1, blob)) {\n+\t\ttalloc_free(msg);\n+\t\ttalloc_free(asn1);\n \t\treturn NT_STATUS_NO_MEMORY;\n \t}\n \n\nModified: branches/SAMBA_4_0/source/libcli/cldap/cldap.c\n===================================================================\n--- branches/SAMBA_4_0/source/libcli/cldap/cldap.c\t2007-05-21 12:03:15 UTC (rev 23035)\n+++ branches/SAMBA_4_0/source/libcli/cldap/cldap.c\t2007-05-21 12:47:18 UTC (rev 23036)\n@@ -70,6 +70,8 @@\n \tstruct ldap_message *ldap_msg;\n \tstruct cldap_request *req;\n \n+\tif (!asn1) return;\n+\n \tstatus = socket_pending(cldap->sock, &dsize);\n \tif (!NT_STATUS_IS_OK(status)) {\n \t\ttalloc_free(tmp_ctx);\n\nModified: branches/SAMBA_4_0/source/libcli/ldap/ldap.c\n===================================================================\n--- branches/SAMBA_4_0/source/libcli/ldap/ldap.c\t2007-05-21 12:03:15 UTC (rev 23035)\n+++ branches/SAMBA_4_0/source/libcli/ldap/ldap.c\t2007-05-21 12:47:18 UTC (rev 23036)\n@@ -193,6 +193,8 @@\n \tstruct asn1_data *data = asn1_init(mem_ctx);\n \tint i, j;\n \n+\tif (!data) return False;\n+\n \tasn1_push_tag(data, ASN1_SEQUENCE(0));\n \tasn1_write_Integer(data, msg->messageid);\n \n\nModified: branches/SAMBA_4_0/source/libcli/ldap/ldap_client.c\n===================================================================\n--- branches/SAMBA_4_0/source/libcli/ldap/ldap_client.c\t2007-05-21 12:03:15 UTC (rev 23035)\n+++ branches/SAMBA_4_0/source/libcli/ldap/ldap_client.c\t2007-05-21 12:47:18 UTC (rev 23036)\n@@ -175,11 +175,13 @@\n \tstruct ldap_message *msg = talloc(conn, struct ldap_message);\n \tstruct asn1_data *asn1 = asn1_init(conn);\n \n-\tif (msg == NULL) {\n+\tif (asn1 == NULL || msg == NULL) {\n \t\treturn NT_STATUS_LDAP(LDAP_PROTOCOL_ERROR);\n \t}\n \n \tif (!asn1_load(asn1, blob)) {\n+\t\ttalloc_free(msg);\n+\t\ttalloc_free(asn1);\n \t\treturn NT_STATUS_LDAP(LDAP_PROTOCOL_ERROR);\n \t}\n \t\n\nModified: branches/SAMBA_4_0/source/libcli/ldap/ldap_controls.c\n===================================================================\n--- branches/SAMBA_4_0/source/libcli/ldap/ldap_controls.c\t2007-05-21 12:03:15 UTC (rev 23035)\n+++ branches/SAMBA_4_0/source/libcli/ldap/ldap_controls.c\t2007-05-21 12:47:18 UTC (rev 23036)\n@@ -37,6 +37,8 @@\n \tstruct asn1_data *data = asn1_init(mem_ctx);\n \tstruct ldb_sort_resp_control *lsrc;\n \n+\tif (!data) return False;\n+\n \tif (!asn1_load(data, in)) {\n \t\treturn False;\n \t}\n@@ -82,6 +84,8 @@\n \tstruct ldb_server_sort_control **lssc;\n \tint num;\n \n+\tif (!data) return False;\n+\n \tif (!asn1_load(data, in)) {\n \t\treturn False;\n \t}\n@@ -156,6 +160,8 @@\n \tstruct asn1_data *data = asn1_init(mem_ctx);\n \tstruct ldb_extended_dn_control *ledc;\n \n+\tif (!data) return False;\n+\n \tif (!asn1_load(data, in)) {\n \t\treturn False;\n \t}\n@@ -187,6 +193,8 @@\n \tstruct asn1_data *data = asn1_init(mem_ctx);\n \tstruct ldb_sd_flags_control *lsdfc;\n \n+\tif (!data) return False;\n+\n \tif (!asn1_load(data, in)) {\n \t\treturn False;\n \t}\n@@ -218,6 +226,8 @@\n \tstruct asn1_data *data = asn1_init(mem_ctx);\n \tstruct ldb_search_options_control *lsoc;\n \n+\tif (!data) return False;\n+\n \tif (!asn1_load(data, in)) {\n \t\treturn False;\n \t}\n@@ -250,6 +260,8 @@\n \tstruct asn1_data *data = asn1_init(mem_ctx);\n \tstruct ldb_paged_control *lprc;\n \n+\tif (!data) return False;\n+\n \tif (!asn1_load(data, in)) {\n \t\treturn False;\n \t}\n@@ -296,6 +308,8 @@\n \tstruct asn1_data *data = asn1_init(mem_ctx);\n \tstruct ldb_dirsync_control *ldc;\n \n+\tif (!data) return False;\n+\n \tif (!asn1_load(data, in)) {\n \t\treturn False;\n \t}\n@@ -349,6 +363,8 @@\n \tstruct asn1_data *data = asn1_init(mem_ctx);\n \tstruct ldb_asq_control *lac;\n \n+\tif (!data) return False;\n+\n \tif (!asn1_load(data, in)) {\n \t\treturn False;\n \t}\n@@ -452,6 +468,8 @@\n \tstruct asn1_data *data = asn1_init(mem_ctx);\n \tstruct ldb_vlv_req_control *lvrc;\n \n+\tif (!data) return False;\n+\n \tif (!asn1_load(data, in)) {\n \t\treturn False;\n \t}\n@@ -562,6 +580,8 @@\n \tstruct asn1_data *data = asn1_init(mem_ctx);\n \tstruct ldb_vlv_resp_control *lvrc;\n \n+\tif (!data) return False;\n+\n \tif (!asn1_load(data, in)) {\n \t\treturn False;\n \t}\n@@ -615,6 +635,8 @@\n \tstruct ldb_sort_resp_control *lsrc = talloc_get_type(in, struct ldb_sort_resp_control);\n \tstruct asn1_data *data = asn1_init(mem_ctx);\n \n+\tif (!data) return False;\n+\n \tif (!asn1_push_tag(data, ASN1_SEQUENCE(0))) {\n \t\treturn False;\n \t}\n@@ -648,6 +670,8 @@\n \tstruct asn1_data *data = asn1_init(mem_ctx);\n \tint num;\n \n+\tif (!data) return False;\n+\n \tif (!asn1_push_tag(data, ASN1_SEQUENCE(0))) {\n \t\treturn False;\n \t}\n@@ -696,6 +720,8 @@\n \tstruct ldb_extended_dn_control *ledc = talloc_get_type(in, struct ldb_extended_dn_control);\n \tstruct asn1_data *data = asn1_init(mem_ctx);\n \n+\tif (!data) return False;\n+\n \tif (!asn1_push_tag(data, ASN1_SEQUENCE(0))) {\n \t\treturn False;\n \t}\n@@ -722,6 +748,8 @@\n \tstruct ldb_sd_flags_control *lsdfc = talloc_get_type(in, struct ldb_sd_flags_control);\n \tstruct asn1_data *data = asn1_init(mem_ctx);\n \n+\tif (!data) return False;\n+\n \tif (!asn1_push_tag(data, ASN1_SEQUENCE(0))) {\n \t\treturn False;\n \t}\n@@ -748,6 +776,8 @@\n \tstruct ldb_search_options_control *lsoc = talloc_get_type(in, struct ldb_search_options_control);\n \tstruct asn1_data *data = asn1_init(mem_ctx);\n \n+\tif (!data) return False;\n+\n \tif (!asn1_push_tag(data, ASN1_SEQUENCE(0))) {\n \t\treturn False;\n \t}\n@@ -774,6 +804,8 @@\n \tstruct ldb_paged_control *lprc = talloc_get_type(in, struct ldb_paged_control);\n \tstruct asn1_data *data = asn1_init(mem_ctx);\n \n+\tif (!data) return False;\n+\n \tif (!asn1_push_tag(data, ASN1_SEQUENCE(0))) {\n \t\treturn False;\n \t}\n@@ -807,6 +839,8 @@\n \tstruct ldb_asq_control *lac = talloc_get_type(in, struct ldb_asq_control);\n \tstruct asn1_data *data = asn1_init(mem_ctx);\n \n+\tif (!data) return False;\n+\n \tif (!asn1_push_tag(data, ASN1_SEQUENCE(0))) {\n \t\treturn False;\n \t}\n@@ -840,6 +874,8 @@\n \tstruct ldb_dirsync_control *ldc = talloc_get_type(in, struct ldb_dirsync_control);\n \tstruct asn1_data *data = asn1_init(mem_ctx);\n \n+\tif (!data) return False;\n+\n \tif (!asn1_push_tag(data, ASN1_SEQUENCE(0))) {\n \t\treturn False;\n \t}\n@@ -924,6 +960,8 @@\n \tstruct ldb_vlv_req_control *lvrc = talloc_get_type(in, struct ldb_vlv_req_control);\n \tstruct asn1_data *data = asn1_init(mem_ctx);\n \n+\tif (!data) return False;\n+\n \tif (!asn1_push_tag(data, ASN1_SEQUENCE(0))) {\n \t\treturn False;\n \t}\n@@ -998,6 +1036,8 @@\n \tstruct ldb_vlv_resp_control *lvrc = talloc_get_type(in, struct ldb_vlv_resp_control);\n \tstruct asn1_data *data = asn1_init(mem_ctx);\n \n+\tif (!data) return False;\n+\n \tif (!asn1_push_tag(data, ASN1_SEQUENCE(0))) {\n \t\treturn False;\n \t}\n\nModified: branches/SAMBA_4_0/source/libcli/util/asn1.c\n===================================================================\n--- branches/SAMBA_4_0/source/libcli/util/asn1.c\t2007-05-21 12:03:15 UTC (rev 23035)\n+++ branches/SAMBA_4_0/source/libcli/util/asn1.c\t2007-05-21 12:47:18 UTC (rev 23036)\n@@ -24,7 +24,11 @@\n /* allocate an asn1 structure */\n struct asn1_data *asn1_init(TALLOC_CTX *mem_ctx)\n {\n-\treturn talloc_zero(NULL, struct asn1_data);\n+\tstruct asn1_data *ret = talloc_zero(NULL, struct asn1_data);\n+\tif (ret == NULL) {\n+\t\tDEBUG(0,(\"asn1_init failed! out of memory\\n\"));\n+\t}\n+\treturn ret;\n }\n \n /* free an asn1 structure */\n\n"}