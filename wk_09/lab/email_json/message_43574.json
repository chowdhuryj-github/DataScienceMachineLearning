{"category": "ham", "to_address": "samba-cvs@samba.org", "from_address": "tridge@samba.org", "subject": "svn commit: samba r23367 - in branches: SAMBA_3_0/source/groupdb\n\tSAMBA_3_0/source/lib/ldb/include\n\tSAMBA_3_0/source/lib/ldb/ldb_tdb SAMBA_3_0_26/source/groupdb\n\tSAMBA_3_0_26/source/lib/ldb/include\n\tSAMBA_3_0_26/source/lib/ldb/ldb_tdb", "body": "Author: tridge\nDate: 2007-06-06 13:02:14 +0000 (Wed, 06 Jun 2007)\nNew Revision: 23367\n\nWebSVN: http://websvn.samba.org/cgi-bin/viewcvs.cgi?view=rev&root=samba&rev=23367\n\nLog:\ncheck the \"use mmap\" option for ldb too\nModified:\n   branches/SAMBA_3_0/source/groupdb/mapping_ldb.c\n   branches/SAMBA_3_0/source/lib/ldb/include/ldb.h\n   branches/SAMBA_3_0/source/lib/ldb/ldb_tdb/ldb_tdb.c\n   branches/SAMBA_3_0_26/source/groupdb/mapping_ldb.c\n   branches/SAMBA_3_0_26/source/lib/ldb/include/ldb.h\n   branches/SAMBA_3_0_26/source/lib/ldb/ldb_tdb/ldb_tdb.c\n\n\nChangeset:\nModified: branches/SAMBA_3_0/source/groupdb/mapping_ldb.c\n===================================================================\n--- branches/SAMBA_3_0/source/groupdb/mapping_ldb.c\t2007-06-06 12:52:48 UTC (rev 23366)\n+++ branches/SAMBA_3_0/source/groupdb/mapping_ldb.c\t2007-06-06 13:02:14 UTC (rev 23367)\n@@ -67,6 +67,10 @@\n \t\tflags |= LDB_FLG_NOSYNC;\n \t}\n \n+\tif (!lp_use_mmap()) {\n+\t\tflags |= LDB_FLG_NOMMAP;\n+\t}\n+\n \tret = ldb_connect(ldb, db_path, flags, NULL);\n \tif (ret != LDB_SUCCESS) {\n \t\tgoto failed;\n\nModified: branches/SAMBA_3_0/source/lib/ldb/include/ldb.h\n===================================================================\n--- branches/SAMBA_3_0/source/lib/ldb/include/ldb.h\t2007-06-06 12:52:48 UTC (rev 23366)\n+++ branches/SAMBA_3_0/source/lib/ldb/include/ldb.h\t2007-06-06 13:02:14 UTC (rev 23367)\n@@ -233,6 +233,11 @@\n */\n #define LDB_FLG_RECONNECT 4\n \n+/**\n+   Flag to tell backends not to use mmap\n+*/\n+#define LDB_FLG_NOMMAP 8\n+\n /*\n    structures for ldb_parse_tree handling code\n */\n\nModified: branches/SAMBA_3_0/source/lib/ldb/ldb_tdb/ldb_tdb.c\n===================================================================\n--- branches/SAMBA_3_0/source/lib/ldb/ldb_tdb/ldb_tdb.c\t2007-06-06 12:52:48 UTC (rev 23366)\n+++ branches/SAMBA_3_0/source/lib/ldb/ldb_tdb/ldb_tdb.c\t2007-06-06 13:02:14 UTC (rev 23367)\n@@ -1029,6 +1029,11 @@\n \t\ttdb_flags |= TDB_NOSYNC;\n \t}\n \n+\t/* and nommap option */\n+\tif (flags & LDB_FLG_NOMMAP) {\n+\t\ttdb_flags |= TDB_NOMMAP;\n+\t}\n+\n \tif (flags & LDB_FLG_RDONLY) {\n \t\topen_flags = O_RDONLY;\n \t} else {\n\nModified: branches/SAMBA_3_0_26/source/groupdb/mapping_ldb.c\n===================================================================\n--- branches/SAMBA_3_0_26/source/groupdb/mapping_ldb.c\t2007-06-06 12:52:48 UTC (rev 23366)\n+++ branches/SAMBA_3_0_26/source/groupdb/mapping_ldb.c\t2007-06-06 13:02:14 UTC (rev 23367)\n@@ -67,6 +67,10 @@\n \t\tflags |= LDB_FLG_NOSYNC;\n \t}\n \n+\tif (!lp_use_mmap()) {\n+\t\tflags |= LDB_FLG_NOMMAP;\n+\t}\n+\n \tret = ldb_connect(ldb, db_path, flags, NULL);\n \tif (ret != LDB_SUCCESS) {\n \t\tgoto failed;\n\nModified: branches/SAMBA_3_0_26/source/lib/ldb/include/ldb.h\n===================================================================\n--- branches/SAMBA_3_0_26/source/lib/ldb/include/ldb.h\t2007-06-06 12:52:48 UTC (rev 23366)\n+++ branches/SAMBA_3_0_26/source/lib/ldb/include/ldb.h\t2007-06-06 13:02:14 UTC (rev 23367)\n@@ -233,6 +233,11 @@\n */\n #define LDB_FLG_RECONNECT 4\n \n+/**\n+   Flag to tell backends not to use mmap\n+*/\n+#define LDB_FLG_NOMMAP 8\n+\n /*\n    structures for ldb_parse_tree handling code\n */\n\nModified: branches/SAMBA_3_0_26/source/lib/ldb/ldb_tdb/ldb_tdb.c\n===================================================================\n--- branches/SAMBA_3_0_26/source/lib/ldb/ldb_tdb/ldb_tdb.c\t2007-06-06 12:52:48 UTC (rev 23366)\n+++ branches/SAMBA_3_0_26/source/lib/ldb/ldb_tdb/ldb_tdb.c\t2007-06-06 13:02:14 UTC (rev 23367)\n@@ -1029,6 +1029,11 @@\n \t\ttdb_flags |= TDB_NOSYNC;\n \t}\n \n+\t/* and nommap option */\n+\tif (flags & LDB_FLG_NOMMAP) {\n+\t\ttdb_flags |= TDB_NOMMAP;\n+\t}\n+\n \tif (flags & LDB_FLG_RDONLY) {\n \t\topen_flags = O_RDONLY;\n \t} else {\n\n"}