{"category": "ham", "to_address": "beginners@perl.org", "from_address": "Michael Scondo <michael.scondo@phil.stud.uni-erlangen.de>", "subject": "strange unexpected deadlock", "body": "Hi,\nI'm trying to make myself familiar with threads.\n\nHowever, I encountered some unexpected behaviour of locks/cond_wait I wasn't \nable to figure out.\nCould someone explain to me what's happening ??\nThanks, Michael\n\n\n---------------------- \n\n#!/usr/bin/perl -w\nuse threads;\nuse threads::shared;\n\nshare( $x );\nshare( $y );\n\nsub thread1{\n\t\tprint \"1\\n\";\n\t\tlock $x;\n\t\tprint \"locked x: 1\\n\";\n\t\tcond_wait $x;\n\t\tprint \"thread1\\n\";\n\t\tlock $y;\n\t\tcond_signal $y;\n\t\tprint \"t1\\n\";\n}\n\nsub thread2{\n\t\tsleep 1;\n\t\tlock $y;\n#\t\t{ \n\t\t\tlock $x;\n\t\t\tprint \"locked x: 2\\n\";\n\t\t\tcond_signal $x;\n#\t\t}\n\t\tprint \"thread2\\n\";\n\t\tsleep 1;\n\t\tcond_wait $y;\n\t\tprint \"t2\\n\";\n}\n\nmy $t1 = threads->create( \"thread1\" );\nmy $t2 = threads->create( \"thread2\" );\n\n$t1->join;\n$t2->join;\n\nprint \"exit.\\n\";\n\n---------------------\n\n\nI expected the script to have a output like:\n---\n1\nlocked x: 1\nlocked x: 2\nthread2\nthread1\nt1\nt2\nexit.\n---\nInstead it hangs in the function thread1, at cond_wait $x,\nso here's the actual output.\n---\n1\nlocked x: 1\nlocked x: 2\nthread2\n---\n\nIf I uncomment the two brackets of the function thread2, it works again. Which \nI cannot understand.\n\n---\nsub thread2{\n\t\tsleep 1;\n\t\tlock $y;\n\t\t{ \n\t\t\tlock $x;\n\t\t\tprint \"locked x: 2\\n\";\n\t\t\tcond_signal $x;\n\t\t}\n\t\tprint \"thread2\\n\";\n\t\tsleep 1;\n\t\tcond_wait $y;\n\t\tprint \"t2\\n\";\n}\n\n\n\n\n\n\n-- \nTo unsubscribe, e-mail: beginners-unsubscribe@perl.org\nFor additional commands, e-mail: beginners-help@perl.org\nhttp://learn.perl.org/\n\n\n"}