{"category": "ham", "to_address": "samba-cvs@samba.org", "from_address": "tridge@samba.org", "subject": "Rev 590: added option to call out to a script for ID mapping in\n\ttdb2 idmapper in http://samba.org/~tridge/3_0-ctdb", "body": "------------------------------------------------------------\nrevno: 590\nrevision-id: tridge@samba.org-20070614213512-ie5pz1ac78fwlxw9\nparent: tridge@samba.org-20070604032449-86q3i3fvrqr5812n\ncommitter: Andrew Tridgell \nbranch nick: s3-ctdb-tridge\ntimestamp: Fri 2007-06-15 07:35:12 +1000\nmessage:\n  added option to call out to a script for ID mapping in tdb2 idmapper\nmodified:\n  source/nsswitch/idmap_tdb2.c   idmap_tdb2.c-20070531053925-e5x7av5etjs83rk0-1\n=== modified file 'source/nsswitch/idmap_tdb2.c'\n--- a/source/nsswitch/idmap_tdb2.c\t2007-05-31 06:31:34 +0000\n+++ b/source/nsswitch/idmap_tdb2.c\t2007-06-14 21:35:12 +0000\n@@ -45,6 +45,7 @@\n \t/* User and group id pool */\n \tuid_t low_uid, high_uid;               /* Range of uids to allocate */\n \tgid_t low_gid, high_gid;               /* Range of gids to allocate */\n+\tconst char *idmap_script;\n } idmap_tdb2_state;\n \n \n@@ -132,6 +133,13 @@\n \tidmap_tdb2_state.low_gid = 0;\n \tidmap_tdb2_state.high_gid = 0;\n \n+\t/* see if a idmap script is configured */\n+\tidmap_tdb2_state.idmap_script = lp_parm_const_string(-1, \"idmap\", \"script\", NULL);\n+\n+\tif (idmap_tdb2_state.idmap_script) {\n+\t\tDEBUG(1, (\"using idmap script '%s'\\n\", idmap_tdb2_state.idmap_script));\n+\t}\n+\n \trange = lp_parm_const_string(-1, \"idmap alloc config\", \"range\", NULL);\n \tif (range && range[0]) {\n \t\tunsigned low_id, high_id;\n@@ -470,6 +478,76 @@\n \treturn ret;\n }\n \n+\n+/*\n+  run a script to perform a mapping\n+\n+  The script should the following command lines:\n+\n+      SIDTOID S-1-xxxx\n+      IDTOSID UID xxxx\n+      IDTOSID GID xxxx\n+\n+  and should return one of the following as a single line of text\n+     UID:xxxx\n+     GID:xxxx\n+     SID:xxxx\n+     ERR:xxxx\n+ */\n+static NTSTATUS idmap_tdb2_script(struct idmap_tdb2_context *ctx, struct id_map *map,\n+\t\t\t\t  const char *fmt, ...)\n+{\n+\tva_list ap;\n+\tchar *cmd;\n+\tFILE *p;\n+\tchar line[64];\n+\tunsigned long v;\n+\n+\tcmd = talloc_asprintf(ctx, \"%s \", idmap_tdb2_state.idmap_script);\n+\tNT_STATUS_HAVE_NO_MEMORY(cmd);\t\n+\n+\tva_start(ap, fmt);\n+\tcmd = talloc_vasprintf_append(cmd, fmt, ap);\n+\tva_end(ap);\n+\tNT_STATUS_HAVE_NO_MEMORY(cmd);\n+\n+\tp = popen(cmd, \"r\");\n+\ttalloc_free(cmd);\n+\tif (p == NULL) {\n+\t\treturn NT_STATUS_NONE_MAPPED;\n+\t}\n+\n+\tif (fgets(line, sizeof(line)-1, p) == NULL) {\n+\t\tpclose(p);\n+\t\treturn NT_STATUS_NONE_MAPPED;\n+\t}\n+\tpclose(p);\n+\n+\tDEBUG(10,(\"idmap script gave: %s\\n\", line));\n+\n+\tif (sscanf(line, \"UID:%lu\", &v) == 1) {\n+\t\tmap->xid.id   = v;\n+\t\tmap->xid.type = ID_TYPE_UID;\n+\t} else if (sscanf(line, \"GID:%lu\", &v) == 1) {\n+\t\tmap->xid.id   = v;\n+\t\tmap->xid.type = ID_TYPE_GID;\t\t\n+\t} else if (strncmp(line, \"SID:S-\", 6) == 0) {\n+\t\tif (!string_to_sid(map->sid, &line[4])) {\n+\t\t\tDEBUG(0,(\"Bad SID in '%s' from idmap script %s\\n\",\n+\t\t\t\t line, idmap_tdb2_state.idmap_script));\n+\t\t\treturn NT_STATUS_NONE_MAPPED;\t\t\t\n+\t\t}\n+\t} else {\n+\t\tDEBUG(0,(\"Bad reply '%s' from idmap script %s\\n\",\n+\t\t\t line, idmap_tdb2_state.idmap_script));\n+\t\treturn NT_STATUS_NONE_MAPPED;\n+\t}\n+\n+\treturn NT_STATUS_OK;\n+}\n+\n+\n+\n /*\n   Single id to sid lookup function. \n */\n@@ -522,7 +600,11 @@\n \n \tif (!data.dptr) {\n \t\tDEBUG(10,(\"Record %s not found\\n\", keystr));\n-\t\tret = NT_STATUS_NONE_MAPPED;\n+\t\tif (idmap_tdb2_state.idmap_script) {\n+\t\t\tret = idmap_tdb2_script(ctx, map, \"IDTOSID %s\", keystr);\n+\t\t} else {\n+\t\t\tret = NT_STATUS_NONE_MAPPED;\n+\t\t}\n \t\tgoto done;\n \t}\n \t\t\n@@ -542,6 +624,7 @@\n \treturn ret;\n }\n \n+\n /*\n  Single sid to id lookup function. \n */\n@@ -563,8 +646,12 @@\n \t/* Check if sid is present in database */\n \tdata = tdb2_fetch_bystring(keystr);\n \tif (!data.dptr) {\n-\t\tDEBUG(10,(\"Record %s not found\\n\", keystr));\n-\t\tret = NT_STATUS_NONE_MAPPED;\n+\t\tDEBUG(10,(__location__ \" Record %s not found\\n\", keystr));\n+\t\tif (idmap_tdb2_state.idmap_script) {\n+\t\t\tret = idmap_tdb2_script(ctx, map, \"SIDTOID %s\", keystr);\n+\t\t} else {\n+\t\t\tret = NT_STATUS_NONE_MAPPED;\n+\t\t}\n \t\tgoto done;\n \t}\n \n\n"}