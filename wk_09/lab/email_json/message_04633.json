{"category": "ham", "to_address": "samba-cvs@samba.org", "from_address": "Michael Adam <ma@sernet.de>", "subject": "Rev 5354: refactoring: Move initialization of regdb into a function\n\tof its in http://samba.sernet.de/ma/bzr/SAMBA_3_0-registry.bzr/", "body": "At http://samba.sernet.de/ma/bzr/SAMBA_3_0-registry.bzr/\n\n------------------------------------------------------------\nrevno: 5354\nrevision-id: ma@sernet.de-20070413155735-bcd3cd2c2e57f281\nparent: ma@sernet.de-20070412141700-8ecb2c6ec62e1b2b\ncommitter: Michael Adam \nbranch nick: SAMBA_3_0-registry.bzr\ntimestamp: Fri 2007-04-13 17:57:35 +0200\nmessage:\n  refactoring: Move initialization of regdb into a function of its\n  own. (peparation for use of registry in loadparm.c)\nmodified:\n  source/lib/util_reg.c          util_reg.c-20060711181331-c2d45d0e1f4a8648\n  source/utils/net_conf.c        net_conf.c-20070409110216-64p0zt0mes4j6yoe-1\n=== modified file 'source/lib/util_reg.c'\n--- a/source/lib/util_reg.c\t2007-04-12 12:27:43 +0000\n+++ b/source/lib/util_reg.c\t2007-04-13 15:57:35 +0000\n@@ -20,6 +20,8 @@\n \n #include \"includes.h\"\n \n+extern REGISTRY_OPS smbconf_reg_ops;\n+\n const char *reg_type_lookup(enum winreg_Type type)\n {\n \tconst char *result;\n@@ -246,3 +248,29 @@\n \treturn token;\n }\n \n+BOOL registry_init_regdb(void)\n+{\n+\tBOOL ret = False;\n+\tint saved_errno = 0;\n+\tREGISTRY_HOOK smbconf_reg_hook = {KEY_SMBCONF, &smbconf_reg_ops};\n+\n+\tif (!regdb_init()) {\n+\t\tsaved_errno = errno;\n+\t\tDEBUG(1, (\"Can't open the registry\"));\n+\t\tif (saved_errno) {\n+\t\t\tDEBUGADD(1, (\": %s\", strerror(saved_errno)));\n+\t\t}\n+\t\tDEBUGADD(1, (\".\\n\"));\n+\t\tgoto done;\n+\t}\n+\treghook_cache_init();\n+\tif (!reghook_cache_add(&smbconf_reg_hook)) {\n+\t\tDEBUG(1, (\"Error adding smbconf reghooks to reghook cache.\\n\"));\n+\t\tgoto done;\n+\t}\n+\n+\tret = True;\n+\n+done:\n+\treturn ret;\n+}\n\n=== modified file 'source/utils/net_conf.c'\n--- a/source/utils/net_conf.c\t2007-04-12 12:27:43 +0000\n+++ b/source/utils/net_conf.c\t2007-04-13 15:57:35 +0000\n@@ -1075,7 +1075,6 @@\n int net_conf(int argc, const char **argv)\n {\n \tint ret = -1;\n-\tint saved_errno = 0;\n \tstruct functable2 func[] = {\n \t\t{\"list\", net_conf_list, \n \t\t \"Dump the complete configuration in smb.conf like format.\"},\n@@ -1098,21 +1097,10 @@\n \t\t{NULL, NULL, NULL}\n \t};\n \n-\tREGISTRY_HOOK smbconf_reg_hook = {KEY_SMBCONF, &smbconf_reg_ops};\n-\t\n-\tif (!regdb_init()) {\n-\t\tsaved_errno = errno;\n-\t\td_fprintf(stderr, \"Can't open the registry\");\n-\t\tif (saved_errno) {\n-\t\t\td_fprintf(stderr, \": %s\\n\", strerror(saved_errno));\n-\t\t}\n-\t\telse {\n-\t\t\td_fprintf(stderr, \"!\\n\");\n-\t\t}\n+\tif (!registry_init_regdb()) {\n+\t\td_fprintf(stderr, \"Error initializing the registry!\\n\");\n \t\tgoto done;\n \t}\n-\treghook_cache_init();\n-\treghook_cache_add(&smbconf_reg_hook);\n \n \tret = net_run_function2(argc, argv, \"net conf\", func);\n \n\n"}