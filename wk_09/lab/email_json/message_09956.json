{"category": "ham", "to_address": "simo <idra@samba.org>", "from_address": "\"Gerald (Jerry) Carter\" <jerry@samba.org>", "subject": "Broken idmap interface design", "body": "-----BEGIN PGP SIGNED MESSAGE-----\nHash: SHA1\n\nSimo,\n\n> On Thu, 2007-04-19 at 23:30 +1000, Luke Howard wrote:\n>> Sorry to jump in here, one thing I'd like to see \n>> in idmap_ad is support for using the Global Catalog. Shouldn't\n>> be too hard. Thoughts?\n> \n> Well IIRC rfc2307 attributes are not exposed via GC by \n> default, so to use it we must have fallback code in place.\n> Not that hard, but I guess this is more of a 3.0.26 feature.\n> I am working only to stabilize the code for offline\n> usage right now.\n\nIt's actually worse than that.  The idmap interface is\nbadly broken.  I hate to say this, but the calls into\nwinbindd from the idmap child has to go.  I know how you\narrived at the design assumptions.\n\nYou designed the unixids_to_sids() and sids_to_unixids()\nwith the assumption that the idmap plugin would have\nknowledge about the SID type.  I didn't catch this\nbecause the backend I'm using for primary testing operates\nsimilarly to idmap_ad and can obtain the SID type based\non LDAP searches.  This is ok for something like idmap_ad\nwhich can get the information.  But the general and\ndefault case is idmap_tdb (or even idmap_ldap).\n\nRequiring the idmap_tdb code (or idmap_rid) to issues a\nwinbindd client call is wrong and a layering violation.  The\ncaller should specify the SID type which is exactly what\nthe WINBINDD_SID_TO_UID, et. al. calls used to do.\n\nRight now I'm going to do several things in order to get\nthe code to a release point.\n\n(a) Remove WINBINDD_SIDS_TO_XIDS from winbindd_nss.h to\n    prevent us from having to support the broken call in\n    future releases.  The existing idmap_methods API will\n    not change but will become solely an internal interface\n    used by winbindd.\n\n(b) Overload the id_map.xid.type to be specified by the caller\n    and not filled by the idmap backend.\n\n(c) convert smbd back to the 3.0.24 method of mapping\n    SIDs one by one to create the Unix token\n\nPost 3.0.25 I'm going to rewrite the idmap query interface\nto use a formal parameter list instead of the struct **id_map\nin/out buffer and make it explicit that the caller is to\nspecify the SID type as part of the query.\n\nIt is likely that this will delay the 3.0.25.  Please don't make\nany more changes to SAMBA_3_0_25/source/nsswitch/idmap*.[ch]\nright now.  Thanks.\n\n\n\n\ncheers, jerry\n-----BEGIN PGP SIGNATURE-----\nVersion: GnuPG v1.4.3 (GNU/Linux)\nComment: Using GnuPG with Mozilla - http://enigmail.mozdev.org\n\niD8DBQFGJ4FxIR7qMdg1EfYRAklqAKCN7k24FzvGy81s9VwSBfytzLXZ7wCgrPab\n5ReLld5GDQ9QfZT7efa+jLk=\n=YxYg\n-----END PGP SIGNATURE-----\n\n"}