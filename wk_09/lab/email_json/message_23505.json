{"category": "ham", "to_address": "samba-cvs@samba.org", "from_address": "tridge@samba.org", "subject": "Rev 261: merged vnn map broadcast from ronnie in\n\thttp://samba.org/~tridge/ctdb", "body": "------------------------------------------------------------\nrevno: 261\nrevision-id: tridge@samba.org-20070505073528-7a0k8rak6j00p6bl\nparent: tridge@samba.org-20070505071959-wvf5a3e37mch3vy3\nparent: sahlberg@ronnie-20070505031726-667ed50c2053a8aa\ncommitter: Andrew Tridgell \nbranch nick: tridge\ntimestamp: Sat 2007-05-05 17:35:28 +1000\nmessage:\n  merged vnn map broadcast from ronnie\nmodified:\n  common/ctdb.c                  ctdb.c-20061127094323-t50f58d65iaao5of-2\n  common/ctdb_control.c          ctdb_control.c-20070426122724-j6gkpiofhbwdin63-1\n  common/ctdb_ltdb.c             ctdb_ltdb.c-20061128065342-to93h6eejj5kon81-2\n  common/ctdb_traverse.c         ctdb_traverse.c-20070503021550-ztfs5rwx8jfm8qqx-1\n  include/ctdb_private.h         ctdb_private.h-20061117234101-o3qt14umlg9en8z0-13\n  tools/ctdb_control.c           ctdb_control.c-20070426122705-9ehj1l5lu2gn9kuj-1\n    ------------------------------------------------------------\n    revno: 197.1.57\n    merged: sahlberg@ronnie-20070505031726-667ed50c2053a8aa\n    parent: sahlberg@ronnie-20070505014644-64544864493dc596\n    committer: Ronnie Sahlberg \n    branch nick: ctdb\n    timestamp: Sat 2007-05-05 13:17:26 +1000\n    message:\n      split the vnn broadcast address into two\n      one broadcast address for all nodes\n      and one broadcast address for all nodes in the current vnnmap\n      \n      update all useage of the old flag to now only broadcast to the vnnmap\n      except for tools/ctdb_control where it makes more sense to broadcast to \n      all nodes\n    ------------------------------------------------------------\n    revno: 197.1.56\n    merged: sahlberg@ronnie-20070505014644-64544864493dc596\n    parent: sahlberg@ronnie-20070504152230-2e8efa9c50c6791a\n    parent: tridge@samba.org-20070505010310-wlknjyla4cqkbdld\n    committer: Ronnie Sahlberg \n    branch nick: ctdb\n    timestamp: Sat 2007-05-05 11:46:44 +1000\n    message:\n      merge from tridge\n=== modified file 'common/ctdb.c'\n--- a/common/ctdb.c\t2007-05-04 22:11:54 +0000\n+++ b/common/ctdb.c\t2007-05-05 03:17:26 +0000\n@@ -469,7 +469,7 @@\n /*\n   broadcast a packet to all nodes\n */\n-static void ctdb_broadcast_packet(struct ctdb_context *ctdb, struct ctdb_req_header *hdr)\n+static void ctdb_broadcast_packet_all(struct ctdb_context *ctdb, struct ctdb_req_header *hdr)\n {\n \tint i;\n \tfor (i=0;ivnn_map->size;i++) {\n+\t\thdr->destnode = ctdb->vnn_map->map[i];\n+\t\tctdb_queue_packet(ctdb, hdr);\n+\t}\n+}\n+\n+/*\n   queue a packet or die\n */\n void ctdb_queue_packet(struct ctdb_context *ctdb, struct ctdb_req_header *hdr)\n {\n \tstruct ctdb_node *node;\n \n-\tif (hdr->destnode == CTDB_BROADCAST_VNN) {\n-\t\tctdb_broadcast_packet(ctdb, hdr);\n+\tswitch (hdr->destnode) {\n+\tcase CTDB_BROADCAST_ALL:\n+\t\tctdb_broadcast_packet_all(ctdb, hdr);\n+\t\treturn;\n+\tcase CTDB_BROADCAST_VNNMAP:\n+\t\tctdb_broadcast_packet_vnnmap(ctdb, hdr);\n \t\treturn;\n \t}\n \n\n=== modified file 'common/ctdb_control.c'\n--- a/common/ctdb_control.c\t2007-05-05 04:09:46 +0000\n+++ b/common/ctdb_control.c\t2007-05-05 07:35:28 +0000\n@@ -533,7 +533,7 @@\n \tstruct ctdb_control_state *state;\n \tsize_t len;\n \n-\tif (destnode == CTDB_BROADCAST_VNN && !(flags & CTDB_CTRL_FLAG_NOREPLY)) {\n+\tif (((destnode == CTDB_BROADCAST_VNNMAP) || (destnode == CTDB_BROADCAST_VNNMAP)) && !(flags & CTDB_CTRL_FLAG_NOREPLY)) {\n \t\tDEBUG(0,(\"Attempt to broadcast control without NOREPLY\\n\"));\n \t\treturn -1;\n \t}\n\n=== modified file 'common/ctdb_ltdb.c'\n--- a/common/ctdb_ltdb.c\t2007-05-05 07:19:59 +0000\n+++ b/common/ctdb_ltdb.c\t2007-05-05 07:35:28 +0000\n@@ -387,7 +387,7 @@\n \t}\n \t\n \t/* tell all the other nodes about this database */\n-\tctdb_daemon_send_control(ctdb, CTDB_BROADCAST_VNN, 0,\n+\tctdb_daemon_send_control(ctdb, CTDB_BROADCAST_VNNMAP, 0,\n \t\t\t\t CTDB_CONTROL_DB_ATTACH, 0, CTDB_CTRL_FLAG_NOREPLY,\n \t\t\t\t indata, NULL, NULL);\n \n@@ -433,7 +433,7 @@\n \t\tTDB_DATA data;\n \t\tdata.dptr = (uint8_t *)&ctdb_db->db_id;\n \t\tdata.dsize = sizeof(uint32_t);\n-\t\tctdb_daemon_send_control(ctdb, CTDB_BROADCAST_VNN, 0,\n+\t\tctdb_daemon_send_control(ctdb, CTDB_BROADCAST_VNNMAP, 0,\n \t\t\t\t\t CTDB_CONTROL_UPDATE_SEQNUM, 0, CTDB_CTRL_FLAG_NOREPLY,\n \t\t\t\t\t data, NULL, NULL);\t\t\n \t}\n\n=== modified file 'common/ctdb_traverse.c'\n--- a/common/ctdb_traverse.c\t2007-05-05 07:19:59 +0000\n+++ b/common/ctdb_traverse.c\t2007-05-05 07:35:28 +0000\n@@ -262,7 +262,7 @@\n \tdata.dsize = sizeof(r);\n \n \t/* tell all the nodes in the cluster to start sending records to this node */\n-\tret = ctdb_daemon_send_control(ctdb, CTDB_BROADCAST_VNN, 0, CTDB_CONTROL_TRAVERSE_ALL,\n+\tret = ctdb_daemon_send_control(ctdb, CTDB_BROADCAST_VNNMAP, 0, CTDB_CONTROL_TRAVERSE_ALL,\n \t\t\t\t       0, CTDB_CTRL_FLAG_NOREPLY, data, NULL, NULL);\n \tif (ret != 0) {\n \t\ttalloc_free(state);\n\n=== modified file 'include/ctdb_private.h'\n--- a/include/ctdb_private.h\t2007-05-05 04:09:46 +0000\n+++ b/include/ctdb_private.h\t2007-05-05 07:35:28 +0000\n@@ -33,8 +33,12 @@\n #define CTDB_NULL_FUNC      0xFF000001\n #define CTDB_FETCH_FUNC     0xFF000002\n \n-#define CTDB_CURRENT_NODE  0xF0000001\n-#define CTDB_BROADCAST_VNN 0xF0000002\n+/* used on the domain socket, send a pdu to the local daemon */\n+#define CTDB_CURRENT_NODE     0xF0000001\n+/* send a broadcast to all nodes in the cluster, active or not */\n+#define CTDB_BROADCAST_ALL    0xF0000002\n+/* send a broadcast to all nodes in the current vnn map */\n+#define CTDB_BROADCAST_VNNMAP 0xF0000003\n \n #define CTDB_MAX_REDIRECT_COUNT 3\n #define CTDB_DEFAULT_SEQNUM_FREQUENCY 1\n\n=== modified file 'tools/ctdb_control.c'\n--- a/tools/ctdb_control.c\t2007-05-05 04:09:46 +0000\n+++ b/tools/ctdb_control.c\t2007-05-05 07:35:28 +0000\n@@ -946,7 +946,7 @@\n \t\tusage();\n \t}\n \tif (strcmp(argv[0], \"all\") == 0) {\n-\t\tvnn = CTDB_BROADCAST_VNN;\n+\t\tvnn = CTDB_BROADCAST_ALL;\n \t} else {\n \t\tvnn = strtoul(argv[0], NULL, 0);\n \t}\n\n"}