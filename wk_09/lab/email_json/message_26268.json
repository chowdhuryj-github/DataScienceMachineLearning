{"category": "ham", "to_address": "\"Jeremy Kister\" <perl-04@jeremykister.com>", "from_address": "\"Chas Owens\" <chas.owens@gmail.com>", "subject": "Re: forking problem with dbd::mysql", "body": "On 5/9/07, Jeremy Kister  wrote:\n> On 5/9/2007 12:01 AM, Jeff Pang wrote:\n> > 1) too less timeout setting in my.cnf? see /etc/my.cnf and look for this line:\n>\n> I actually have no my.cnf.  But if I s/my $pid = fork()/my $pid=1/ all\n> works fine, even with 60 second sleeps.\n>\n> > 2) as we know,child exiting would return a SIGCHLD signal to parent,maybe this\n> > break the dbh connection?try to add these 2 lines in parent code:\n> >\n> > use POSIX qw(:signal_h WNOHANG);\n> > $SIG{CHLD}=sub {while((my $child=waitpid(-1,WNOHANG))>0){}};\n>\n> Nope, same problem.\n>\n> Thanks,\n>\n> --\n>\n> Jeremy Kister\n> http://jeremy.kister.net./\n\nIt looks like it has something to do with $dbh going out of scope\n(when the child exits).  You can see the behavior by first adding\n\"sleep 10;\" to the child (the handle doesn't die for 10 seconds) and\nthen adding \"$dbh = undef\" to the child before the sleep (the handle\ndies as soon as it is set to undef).  It is a hack, but so long as you\nare using the AutoCommit attribute (on by default) you can also use\nthe mysql_auto_reconnect attribute.  Change\n\n\nmy $dbh = DBI->connect($dsn, $dbun, $dbpw, {RaiseError => 1});\n\nto\n\nmy $dbh = DBI->connect(\n    $dsn, $dbun, $dbpw,\n    {\n        RaiseError => 1,\n        mysql_auto_reconnect => 1\n    }\n);\n\n-- \nTo unsubscribe, e-mail: beginners-unsubscribe@perl.org\nFor additional commands, e-mail: beginners-help@perl.org\nhttp://learn.perl.org/\n\n\n"}