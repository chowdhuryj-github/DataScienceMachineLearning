{"category": "ham", "to_address": "Simon McVittie <simon.mcvittie@collabora.co.uk>", "from_address": "Dan Williams <dcbw@redhat.com>", "subject": "Re: [sugar] [PATCH sugar] services/presence: Use\n\tExportedGObject\tfrom dbus-python rather than reimplementing it", "body": "On Fri, 2007-05-11 at 12:39 +0100, Simon McVittie wrote:\n> -----BEGIN PGP SIGNED MESSAGE-----\n> Hash: SHA1\n> \n> dbus-python now has a working implementation of ExportedGObject, so\n> there's no need for the presence service to have its own internal\n> implementation(s).\n\nLooks good.\n\n\n> - ---\n>  services/presence/activity.py        |   14 ++++++--------\n>  services/presence/buddy.py           |   16 +++++++---------\n>  services/presence/presenceservice.py |   16 ++++++++--------\n>  3 files changed, 21 insertions(+), 25 deletions(-)\n> \n> diff --git a/services/presence/activity.py b/services/presence/activity.py\n> index c856f54..d955c71 100644\n> - --- a/services/presence/activity.py\n> +++ b/services/presence/activity.py\n> @@ -16,7 +16,9 @@\n>  # Foundation, Inc., 51 Franklin St, Fifth Floor, Boston, MA  02110-1301  USA\n>  \n>  import gobject\n> - -import dbus, dbus.service\n> +import dbus\n> +import dbus.service\n> +from dbus.gobject_service import ExportedGObject\n>  from sugar import util\n>  import logging\n>  \n> @@ -25,10 +27,6 @@ from telepathy.interfaces import (CHANNEL_INTERFACE)\n>  _ACTIVITY_PATH = \"/org/laptop/Sugar/Presence/Activities/\"\n>  _ACTIVITY_INTERFACE = \"org.laptop.Sugar.Presence.Activity\"\n>  \n> - -class DBusGObjectMetaclass(dbus.service.InterfaceType, gobject.GObjectMeta): pass\n> - -class DBusGObject(dbus.service.Object, gobject.GObject): __metaclass__ = DBusGObjectMetaclass\n> - -\n> - -\n>  _PROP_ID = \"id\"\n>  _PROP_NAME = \"name\"\n>  _PROP_COLOR = \"color\"\n> @@ -38,7 +36,7 @@ _PROP_LOCAL = \"local\"\n>  _PROP_JOINED = \"joined\"\n>  _PROP_CUSTOM_PROPS = \"custom-props\"\n>  \n> - -class Activity(DBusGObject):\n> +class Activity(ExportedGObject):\n>      \"\"\"Represents a potentially shareable activity on the network.\n>      \"\"\"\n>      \n> @@ -84,7 +82,6 @@ class Activity(DBusGObject):\n>  \n>          self._object_id = object_id\n>          self._object_path = _ACTIVITY_PATH + str(self._object_id)\n> - -        dbus.service.Object.__init__(self, bus_name, self._object_path)\n>  \n>          self._buddies = []\n>          self._joined = False\n> @@ -111,7 +108,8 @@ class Activity(DBusGObject):\n>          if not util.validate_activity_id(kwargs[_PROP_ID]):\n>              raise ValueError(\"Invalid activity id '%s'\" % kwargs[_PROP_ID])\n>  \n> - -        gobject.GObject.__init__(self, **kwargs)\n> +        ExportedGObject.__init__(self, bus_name, self._object_path,\n> +                                 gobject_properties=kwargs)\n>          if self.props.local and not self.props.valid:\n>              raise RuntimeError(\"local activities require color, type, and name\")\n>  \n> diff --git a/services/presence/buddy.py b/services/presence/buddy.py\n> index fcc655b..f302b8c 100644\n> - --- a/services/presence/buddy.py\n> +++ b/services/presence/buddy.py\n> @@ -18,7 +18,9 @@\n>  \n>  import os\n>  import gobject\n> - -import dbus, dbus.service\n> +import dbus\n> +import dbus.service\n> +from dbus.gobject_service import ExportedGObject\n>  from ConfigParser import ConfigParser, NoOptionError\n>  \n>  from sugar import env, profile, util\n> @@ -35,10 +37,6 @@ class NotFoundError(dbus.DBusException):\n>          dbus.DBusException.__init__(self)\n>          self._dbus_error_name = _PRESENCE_INTERFACE + '.NotFound'\n>  \n> - -class DBusGObjectMetaclass(dbus.service.InterfaceType, gobject.GObjectMeta): pass\n> - -class DBusGObject(dbus.service.Object, gobject.GObject): __metaclass__ = DBusGObjectMetaclass\n> - -\n> - -\n>  _PROP_NICK = \"nick\"\n>  _PROP_KEY = \"key\"\n>  _PROP_ICON = \"icon\"\n> @@ -50,7 +48,7 @@ _PROP_VALID = \"valid\"\n>  # Will go away soon\n>  _PROP_IP4_ADDRESS = \"ip4-address\"\n>  \n> - -class Buddy(DBusGObject):\n> +class Buddy(ExportedGObject):\n>      \"\"\"Person on the network (tracks properties and shared activites)\n>      \n>      The Buddy is a collection of metadata describing a particular\n> @@ -111,7 +109,6 @@ class Buddy(DBusGObject):\n>          self._bus_name = bus_name\n>          self._object_id = object_id\n>          self._object_path = _BUDDY_PATH + str(self._object_id)\n> - -        dbus.service.Object.__init__(self, self._bus_name, self._object_path)\n>  \n>          self._activities = {}   # Activity ID -> Activity\n>          self._activity_sigids = {}\n> @@ -134,8 +131,9 @@ class Buddy(DBusGObject):\n>              if key not in _ALLOWED_INIT_PROPS:\n>                  logging.debug(\"Invalid init property '%s'; ignoring...\" % key)\n>                  del kwargs[key]\n> - -                \n> - -        gobject.GObject.__init__(self, **kwargs)\n> +\n> +        ExportedGObject.__init__(self, bus_name, self._object_path,\n> +                                 gobject_properties=kwargs)\n>  \n>      def do_get_property(self, pspec):\n>          \"\"\"Retrieve current value for the given property specifier\n> diff --git a/services/presence/presenceservice.py b/services/presence/presenceservice.py\n> index 2598942..e3e217c 100644\n> - --- a/services/presence/presenceservice.py\n> +++ b/services/presence/presenceservice.py\n> @@ -15,9 +15,14 @@\n>  # Foundation, Inc., 51 Franklin St, Fifth Floor, Boston, MA  02110-1301  USA\n>  \n>  import gobject\n> - -import dbus, dbus.service, dbus.glib\n> +import dbus\n> +import dbus.service\n> +from dbus.gobject_service import ExportedGObject\n>  import logging\n>  \n> +# Note that this import has side effects!\n> +import dbus.glib\n> +\n>  from telepathy.client import ManagerRegistry, Connection\n>  from telepathy.interfaces import (CONN_MGR_INTERFACE, CONN_INTERFACE)\n>  from telepathy.constants import (CONNECTION_STATUS_CONNECTING, CONNECTION_STATUS_CONNECTED,\n> @@ -40,10 +45,7 @@ class NotFoundError(dbus.DBusException):\n>          dbus.DBusException.__init__(self, msg)\n>          self._dbus_error_name = _PRESENCE_INTERFACE + '.NotFound'\n>  \n> - -class DBusGObjectMetaclass(dbus.service.InterfaceType, gobject.GObjectMeta): pass\n> - -class DBusGObject(dbus.service.Object, gobject.GObject): __metaclass__ = DBusGObjectMetaclass\n> - -\n> - -class PresenceService(DBusGObject):\n> +class PresenceService(ExportedGObject):\n>      __gtype_name__ = \"PresenceService\"\n>  \n>      __gsignals__ = {\n> @@ -59,8 +61,6 @@ class PresenceService(DBusGObject):\n>          self._handles_buddies = {}      # tp client -> (handle -> Buddy)\n>          self._activities = {}   # activity id -> Activity\n>  \n> - -        gobject.GObject.__init__(self)\n> - -\n>          bus = dbus.SessionBus()\n>          self._bus_name = dbus.service.BusName(_PRESENCE_SERVICE, bus=bus)\n>  \n> @@ -94,7 +94,7 @@ class PresenceService(DBusGObject):\n>          self._ll_plugin = LinkLocalPlugin(self._registry, self._owner)\n>          self._handles_buddies[self._ll_plugin] = {}\n>  \n> - -        dbus.service.Object.__init__(self, self._bus_name, _PRESENCE_PATH)\n> +        ExportedGObject.__init__(self, self._bus_name, _PRESENCE_PATH)\n>  \n>      def _activity_shared_cb(self, tp, activity, success, exc, async_cb, async_err_cb):\n>          if success:\n> - -- \n> 1.5.1.3\n> \n> -----BEGIN PGP SIGNATURE-----\n> Version: GnuPG v1.4.6 (GNU/Linux)\n> Comment: OpenPGP key: http://www.pseudorandom.co.uk/2003/contact/ or pgp.net\n> \n> iD8DBQFGRFX9WSc8zVUw7HYRAvf9AJ9stwZtVzgI36oRTqFmzHcFZwX8HgCg5bUW\n> GE8bg3yEBzZT2ruSA/btZNg=\n> =59rE\n> -----END PGP SIGNATURE-----\n> _______________________________________________\n> Sugar mailing list\n> Sugar@laptop.org\n> http://mailman.laptop.org/mailman/listinfo/sugar\n\n_______________________________________________\nSugar mailing list\nSugar@laptop.org\nhttp://mailman.laptop.org/mailman/listinfo/sugar\n\n"}