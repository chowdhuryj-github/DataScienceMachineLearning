{"category": "ham", "to_address": "samba-cvs@samba.org", "from_address": "tridge@samba.org", "subject": "Rev 322: merge tx_cnt code from ronnie in\n\thttp://samba.org/~tridge/ctdb", "body": "------------------------------------------------------------\nrevno: 322\nrevision-id: tridge@samba.org-20070519031856-9snwstii1s8dzz4u\nparent: tridge@samba.org-20070518145649-ftagi1x44wuzm36n\nparent: sahlberg@ronnie-20070519002717-icrcqusasl3psffk\ncommitter: Andrew Tridgell \nbranch nick: tridge\ntimestamp: Sat 2007-05-19 13:18:56 +1000\nmessage:\n  merge tx_cnt code from ronnie\nmodified:\n  common/ctdb.c                  ctdb.c-20061127094323-t50f58d65iaao5of-2\n  common/ctdb_monitor.c          ctdb_monitor.c-20070518100625-8jf4ft1mjzmb22ck-1\n  include/ctdb_private.h         ctdb_private.h-20061117234101-o3qt14umlg9en8z0-13\n    ------------------------------------------------------------\n    revno: 197.1.122\n    merged: sahlberg@ronnie-20070519002717-icrcqusasl3psffk\n    parent: sahlberg@ronnie-20070519002019-otjtblbn6da2lmui\n    committer: Ronnie Sahlberg \n    branch nick: ctdb\n    timestamp: Sat 2007-05-19 10:27:17 +1000\n    message:\n      increase the tx_cnt everytime we send a packet to a node\n    ------------------------------------------------------------\n    revno: 197.1.121\n    merged: sahlberg@ronnie-20070519002019-otjtblbn6da2lmui\n    parent: sahlberg@ronnie-20070519001237-l1dov8lpchtdip96\n    committer: Ronnie Sahlberg \n    branch nick: ctdb\n    timestamp: Sat 2007-05-19 10:20:19 +1000\n    message:\n      add a node->tx_cnt counter\n      \n      only send keepalive packets if the count is zero\n    ------------------------------------------------------------\n    revno: 197.1.120\n    merged: sahlberg@ronnie-20070519001237-l1dov8lpchtdip96\n    parent: sahlberg@ronnie-20070518100629-h54kmcodi83l5oqc\n    parent: tridge@samba.org-20070518145649-ftagi1x44wuzm36n\n    committer: Ronnie Sahlberg \n    branch nick: ctdb\n    timestamp: Sat 2007-05-19 10:12:37 +1000\n    message:\n      merge from tridge\n=== modified file 'common/ctdb.c'\n--- a/common/ctdb.c\t2007-05-18 13:48:29 +0000\n+++ b/common/ctdb.c\t2007-05-19 00:27:17 +0000\n@@ -507,8 +507,11 @@\n \n \tif (hdr->destnode == ctdb->vnn && !(ctdb->flags & CTDB_FLAG_SELF_CONNECT)) {\n \t\tctdb_defer_packet(ctdb, hdr);\n-\t} else if (ctdb->methods->queue_pkt(node, (uint8_t *)hdr, hdr->length) != 0) {\n-\t\tctdb_fatal(ctdb, \"Unable to queue packet\\n\");\n+\t} else {\n+\t\tnode->tx_cnt++;\n+\t\tif (ctdb->methods->queue_pkt(node, (uint8_t *)hdr, hdr->length) != 0) {\n+\t\t\tctdb_fatal(ctdb, \"Unable to queue packet\\n\");\n+\t\t}\n \t}\n }\n \n\n=== modified file 'common/ctdb_monitor.c'\n--- a/common/ctdb_monitor.c\t2007-05-18 13:48:29 +0000\n+++ b/common/ctdb_monitor.c\t2007-05-19 00:20:19 +0000\n@@ -64,8 +64,12 @@\n \t\t\t*/\n \t\t\tcontinue;\n \t\t}\n+\t\t\n+\t\tif (node->tx_cnt == 0) {\n+\t\t\tctdb_send_keepalive(ctdb, node->vnn);\n+\t\t}\n \n-\t\tctdb_send_keepalive(ctdb, node->vnn);\n+\t\tnode->tx_cnt = 0;\n \t}\n \t\n \tevent_add_timed(ctdb->ev, ctdb, \n\n=== modified file 'include/ctdb_private.h'\n--- a/include/ctdb_private.h\t2007-05-18 14:56:49 +0000\n+++ b/include/ctdb_private.h\t2007-05-19 00:20:19 +0000\n@@ -93,6 +93,7 @@\n \t/* used by the dead node monitoring */\n \tuint32_t dead_count;\n \tuint32_t rx_cnt;\n+\tuint32_t tx_cnt;\n \n \t/* a list of controls pending to this node, so we can time them out quickly\n \t   if the node becomes disconnected */\n\n"}