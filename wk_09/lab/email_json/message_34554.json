{"category": "ham", "to_address": "samba-cvs@samba.org", "from_address": "jra@samba.org", "subject": "svn commit: samba r23087 - in branches: SAMBA_3_0/source/smbd\n\tSAMBA_3_0_25/source/smbd SAMBA_3_0_26/source/smbd", "body": "Author: jra\nDate: 2007-05-22 22:35:13 +0000 (Tue, 22 May 2007)\nNew Revision: 23087\n\nWebSVN: http://websvn.samba.org/cgi-bin/viewcvs.cgi?view=rev&root=samba&rev=23087\n\nLog:\nFix POSIX setfilepathinfo to use lstat, not stat.\nStill missing lchown (will add this for 3.0.26).\nDon't merge for 3.0.25a - possibly 3.0.25b (if it\nexists).\nJeremy.\n\nModified:\n   branches/SAMBA_3_0/source/smbd/open.c\n   branches/SAMBA_3_0/source/smbd/trans2.c\n   branches/SAMBA_3_0_25/source/smbd/open.c\n   branches/SAMBA_3_0_25/source/smbd/trans2.c\n   branches/SAMBA_3_0_26/source/smbd/open.c\n   branches/SAMBA_3_0_26/source/smbd/trans2.c\n\n\nChangeset:\nModified: branches/SAMBA_3_0/source/smbd/open.c\n===================================================================\n--- branches/SAMBA_3_0/source/smbd/open.c\t2007-05-22 22:07:56 UTC (rev 23086)\n+++ branches/SAMBA_3_0/source/smbd/open.c\t2007-05-22 22:35:13 UTC (rev 23087)\n@@ -47,7 +47,12 @@\n \tNTSTATUS status = NT_STATUS_OK;\n \n #ifdef O_NOFOLLOW\n-\tif (!lp_symlinks(SNUM(conn))) {\n+\t/* \n+\t * Never follow symlinks on a POSIX client. The\n+\t * client should be doing this.\n+\t */\n+\n+\tif (fsp->posix_open || !lp_symlinks(SNUM(conn))) {\n \t\tflags |= O_NOFOLLOW;\n \t}\n #endif\n\nModified: branches/SAMBA_3_0/source/smbd/trans2.c\n===================================================================\n--- branches/SAMBA_3_0/source/smbd/trans2.c\t2007-05-22 22:07:56 UTC (rev 23086)\n+++ branches/SAMBA_3_0/source/smbd/trans2.c\t2007-05-22 22:35:13 UTC (rev 23087)\n@@ -5777,9 +5777,17 @@\n \t\t\t * to do this call. JRA.\n \t\t\t */\n \t\t\tpstrcpy(fname, fsp->fsp_name);\n-\t\t\tif (SMB_VFS_STAT(conn,fname,&sbuf) != 0) {\n-\t\t\t\tDEBUG(3,(\"call_trans2setfilepathinfo: fileinfo of %s failed (%s)\\n\",fname,strerror(errno)));\n-\t\t\t\treturn UNIXERROR(ERRDOS,ERRbadpath);\n+\t\t\tif (INFO_LEVEL_IS_UNIX(info_level)) {\n+\t\t\t\t/* Always do lstat for UNIX calls. */\n+\t\t\t\tif (SMB_VFS_LSTAT(conn,fname,&sbuf)) {\n+\t\t\t\t\tDEBUG(3,(\"call_trans2setfilepathinfo: SMB_VFS_LSTAT of %s failed (%s)\\n\",fname,strerror(errno)));\n+\t\t\t\t\treturn UNIXERROR(ERRDOS,ERRbadpath);\n+\t\t\t\t}\n+\t\t\t} else {\n+\t\t\t\tif (SMB_VFS_STAT(conn,fname,&sbuf) != 0) {\n+\t\t\t\t\tDEBUG(3,(\"call_trans2setfilepathinfo: fileinfo of %s failed (%s)\\n\",fname,strerror(errno)));\n+\t\t\t\t\treturn UNIXERROR(ERRDOS,ERRbadpath);\n+\t\t\t\t}\n \t\t\t}\n \t\t} else if (fsp && fsp->print_file) {\n \t\t\t/*\n@@ -5838,14 +5846,18 @@\n \t\t\treturn ERROR_NT(status);\n \t\t}\n \n-\t\t/*\n-\t\t * For CIFS UNIX extensions the target name may not exist.\n-\t\t */\n+\t\tif (INFO_LEVEL_IS_UNIX(info_level)) {\n+\t\t\t/*\n+\t\t\t * For CIFS UNIX extensions the target name may not exist.\n+\t\t\t */\n \n-\t\tif(!VALID_STAT(sbuf) && !INFO_LEVEL_IS_UNIX(info_level)) {\n-\t\t\tDEBUG(3,(\"call_trans2setfilepathinfo: stat of %s failed (%s)\\n\", fname, strerror(errno)));\n+\t\t\t/* Always do lstat for UNIX calls. */\n+\t\t\tSMB_VFS_LSTAT(conn,fname,&sbuf);\n+\n+\t\t} else if (!VALID_STAT(sbuf) && SMB_VFS_STAT(conn,fname,&sbuf)) {\n+\t\t\tDEBUG(3,(\"call_trans2setfilepathinfo: SMB_VFS_STAT of %s failed (%s)\\n\",fname,strerror(errno)));\n \t\t\treturn UNIXERROR(ERRDOS,ERRbadpath);\n-\t\t}    \n+\t\t}\n \t}\n \n \tif (!CAN_WRITE(conn)) {\n\nModified: branches/SAMBA_3_0_25/source/smbd/open.c\n===================================================================\n--- branches/SAMBA_3_0_25/source/smbd/open.c\t2007-05-22 22:07:56 UTC (rev 23086)\n+++ branches/SAMBA_3_0_25/source/smbd/open.c\t2007-05-22 22:35:13 UTC (rev 23087)\n@@ -47,7 +47,12 @@\n \tNTSTATUS status = NT_STATUS_OK;\n \n #ifdef O_NOFOLLOW\n-\tif (!lp_symlinks(SNUM(conn))) {\n+\t/* \n+\t * Never follow symlinks on a POSIX client. The\n+\t * client should be doing this.\n+\t */\n+\n+\tif (fsp->posix_open || !lp_symlinks(SNUM(conn))) {\n \t\tflags |= O_NOFOLLOW;\n \t}\n #endif\n\nModified: branches/SAMBA_3_0_25/source/smbd/trans2.c\n===================================================================\n--- branches/SAMBA_3_0_25/source/smbd/trans2.c\t2007-05-22 22:07:56 UTC (rev 23086)\n+++ branches/SAMBA_3_0_25/source/smbd/trans2.c\t2007-05-22 22:35:13 UTC (rev 23087)\n@@ -5632,9 +5632,17 @@\n \t\t\t * to do this call. JRA.\n \t\t\t */\n \t\t\tpstrcpy(fname, fsp->fsp_name);\n-\t\t\tif (SMB_VFS_STAT(conn,fname,&sbuf) != 0) {\n-\t\t\t\tDEBUG(3,(\"call_trans2setfilepathinfo: fileinfo of %s failed (%s)\\n\",fname,strerror(errno)));\n-\t\t\t\treturn UNIXERROR(ERRDOS,ERRbadpath);\n+\t\t\tif (INFO_LEVEL_IS_UNIX(info_level)) {\n+\t\t\t\t/* Always do lstat for UNIX calls. */\n+\t\t\t\tif (SMB_VFS_LSTAT(conn,fname,&sbuf)) {\n+\t\t\t\t\tDEBUG(3,(\"call_trans2setfilepathinfo: SMB_VFS_LSTAT of %s failed (%s)\\n\",fname,strerror(errno)));\n+\t\t\t\t\treturn UNIXERROR(ERRDOS,ERRbadpath);\n+\t\t\t\t}\n+\t\t\t} else {\n+\t\t\t\tif (SMB_VFS_STAT(conn,fname,&sbuf) != 0) {\n+\t\t\t\t\tDEBUG(3,(\"call_trans2setfilepathinfo: fileinfo of %s failed (%s)\\n\",fname,strerror(errno)));\n+\t\t\t\t\treturn UNIXERROR(ERRDOS,ERRbadpath);\n+\t\t\t\t}\n \t\t\t}\n \t\t} else if (fsp && fsp->print_file) {\n \t\t\t/*\n@@ -5693,14 +5701,18 @@\n \t\t\treturn ERROR_NT(status);\n \t\t}\n \n-\t\t/*\n-\t\t * For CIFS UNIX extensions the target name may not exist.\n-\t\t */\n+\t\tif (INFO_LEVEL_IS_UNIX(info_level)) {\n+\t\t\t/*\n+\t\t\t * For CIFS UNIX extensions the target name may not exist.\n+\t\t\t */\n \n-\t\tif(!VALID_STAT(sbuf) && !INFO_LEVEL_IS_UNIX(info_level)) {\n-\t\t\tDEBUG(3,(\"call_trans2setfilepathinfo: stat of %s failed (%s)\\n\", fname, strerror(errno)));\n+\t\t\t/* Always do lstat for UNIX calls. */\n+\t\t\tSMB_VFS_LSTAT(conn,fname,&sbuf);\n+\n+\t\t} else if (!VALID_STAT(sbuf) && SMB_VFS_STAT(conn,fname,&sbuf)) {\n+\t\t\tDEBUG(3,(\"call_trans2setfilepathinfo: SMB_VFS_STAT of %s failed (%s)\\n\",fname,strerror(errno)));\n \t\t\treturn UNIXERROR(ERRDOS,ERRbadpath);\n-\t\t}    \n+\t\t}\n \t}\n \n \tif (!CAN_WRITE(conn)) {\n\nModified: branches/SAMBA_3_0_26/source/smbd/open.c\n===================================================================\n--- branches/SAMBA_3_0_26/source/smbd/open.c\t2007-05-22 22:07:56 UTC (rev 23086)\n+++ branches/SAMBA_3_0_26/source/smbd/open.c\t2007-05-22 22:35:13 UTC (rev 23087)\n@@ -47,7 +47,12 @@\n \tNTSTATUS status = NT_STATUS_OK;\n \n #ifdef O_NOFOLLOW\n-\tif (!lp_symlinks(SNUM(conn))) {\n+\t/* \n+\t * Never follow symlinks on a POSIX client. The\n+\t * client should be doing this.\n+\t */\n+\n+\tif (fsp->posix_open || !lp_symlinks(SNUM(conn))) {\n \t\tflags |= O_NOFOLLOW;\n \t}\n #endif\n\nModified: branches/SAMBA_3_0_26/source/smbd/trans2.c\n===================================================================\n--- branches/SAMBA_3_0_26/source/smbd/trans2.c\t2007-05-22 22:07:56 UTC (rev 23086)\n+++ branches/SAMBA_3_0_26/source/smbd/trans2.c\t2007-05-22 22:35:13 UTC (rev 23087)\n@@ -5723,9 +5723,17 @@\n \t\t\t * to do this call. JRA.\n \t\t\t */\n \t\t\tpstrcpy(fname, fsp->fsp_name);\n-\t\t\tif (SMB_VFS_STAT(conn,fname,&sbuf) != 0) {\n-\t\t\t\tDEBUG(3,(\"call_trans2setfilepathinfo: fileinfo of %s failed (%s)\\n\",fname,strerror(errno)));\n-\t\t\t\treturn UNIXERROR(ERRDOS,ERRbadpath);\n+\t\t\tif (INFO_LEVEL_IS_UNIX(info_level)) {\n+\t\t\t\t/* Always do lstat for UNIX calls. */\n+\t\t\t\tif (SMB_VFS_LSTAT(conn,fname,&sbuf)) {\n+\t\t\t\t\tDEBUG(3,(\"call_trans2setfilepathinfo: SMB_VFS_LSTAT of %s failed (%s)\\n\",fname,strerror(errno)));\n+\t\t\t\t\treturn UNIXERROR(ERRDOS,ERRbadpath);\n+\t\t\t\t}\n+\t\t\t} else {\n+\t\t\t\tif (SMB_VFS_STAT(conn,fname,&sbuf) != 0) {\n+\t\t\t\t\tDEBUG(3,(\"call_trans2setfilepathinfo: fileinfo of %s failed (%s)\\n\",fname,strerror(errno)));\n+\t\t\t\t\treturn UNIXERROR(ERRDOS,ERRbadpath);\n+\t\t\t\t}\n \t\t\t}\n \t\t} else if (fsp && fsp->print_file) {\n \t\t\t/*\n@@ -5784,14 +5792,18 @@\n \t\t\treturn ERROR_NT(status);\n \t\t}\n \n-\t\t/*\n-\t\t * For CIFS UNIX extensions the target name may not exist.\n-\t\t */\n+\t\tif (INFO_LEVEL_IS_UNIX(info_level)) {\n+\t\t\t/*\n+\t\t\t * For CIFS UNIX extensions the target name may not exist.\n+\t\t\t */\n \n-\t\tif(!VALID_STAT(sbuf) && !INFO_LEVEL_IS_UNIX(info_level)) {\n-\t\t\tDEBUG(3,(\"call_trans2setfilepathinfo: stat of %s failed (%s)\\n\", fname, strerror(errno)));\n+\t\t\t/* Always do lstat for UNIX calls. */\n+\t\t\tSMB_VFS_LSTAT(conn,fname,&sbuf);\n+\n+\t\t} else if (!VALID_STAT(sbuf) && SMB_VFS_STAT(conn,fname,&sbuf)) {\n+\t\t\tDEBUG(3,(\"call_trans2setfilepathinfo: SMB_VFS_STAT of %s failed (%s)\\n\",fname,strerror(errno)));\n \t\t\treturn UNIXERROR(ERRDOS,ERRbadpath);\n-\t\t}    \n+\t\t}\n \t}\n \n \tif (!CAN_WRITE(conn)) {\n\n"}