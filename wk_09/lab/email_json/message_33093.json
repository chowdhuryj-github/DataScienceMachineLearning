{"category": "ham", "to_address": "samba-cvs@samba.org", "from_address": "tridge@samba.org", "subject": "svn commit: samba r23018 - in\n\tbranches/SAMBA_4_0/source/smb_server/smb: .", "body": "Author: tridge\nDate: 2007-05-20 08:43:03 +0000 (Sun, 20 May 2007)\nNew Revision: 23018\n\nWebSVN: http://websvn.samba.org/cgi-bin/viewcvs.cgi?view=rev&root=samba&rev=23018\n\nLog:\n\nfixed a memory leak in our server side session setup code for failed\nsession setups\n\nModified:\n   branches/SAMBA_4_0/source/smb_server/smb/sesssetup.c\n\n\nChangeset:\nModified: branches/SAMBA_4_0/source/smb_server/smb/sesssetup.c\n===================================================================\n--- branches/SAMBA_4_0/source/smb_server/smb/sesssetup.c\t2007-05-20 08:01:02 UTC (rev 23017)\n+++ branches/SAMBA_4_0/source/smb_server/smb/sesssetup.c\t2007-05-20 08:43:03 UTC (rev 23018)\n@@ -60,7 +60,7 @@\n \tunion smb_sesssetup *sess = talloc_get_type(req->io_ptr, union smb_sesssetup);\n \tstruct auth_serversupplied_info *server_info = NULL;\n \tstruct auth_session_info *session_info;\n-\tstruct smbsrv_session *smb_sess;\n+\tstruct smbsrv_session *smb_sess = NULL;\n \tNTSTATUS status;\n \n \tstatus = auth_check_password_recv(areq, req, &server_info);\n@@ -88,6 +88,10 @@\n \tsess->old.out.vuid = smb_sess->vuid;\n \n failed:\n+\tif (!NT_STATUS_IS_OK(status)) {\n+\t\ttalloc_free(smb_sess);\n+\t\treq->session = NULL;\n+\t}\n \tstatus = auth_nt_status_squash(status);\n \tsmbsrv_sesssetup_backend_send(req, sess, status);\n }\n@@ -155,7 +159,7 @@\n \tunion smb_sesssetup *sess = talloc_get_type(req->io_ptr, union smb_sesssetup);\n \tstruct auth_serversupplied_info *server_info = NULL;\n \tstruct auth_session_info *session_info;\n-\tstruct smbsrv_session *smb_sess;\n+\tstruct smbsrv_session *smb_sess = NULL;\n \tNTSTATUS status;\n \n \tstatus = auth_check_password_recv(areq, req, &server_info);\n@@ -204,6 +208,10 @@\n done:\n \tstatus = NT_STATUS_OK;\n failed:\n+\tif (!NT_STATUS_IS_OK(status)) {\n+\t\ttalloc_free(smb_sess);\n+\t\treq->session = NULL;\n+\t}\n \tstatus = auth_nt_status_squash(status);\n \tsmbsrv_sesssetup_backend_send(req, sess, status);\n }\n@@ -337,6 +345,10 @@\n done:\n \tsess->spnego.out.vuid = smb_sess->vuid;\n failed:\n+\tif (!NT_STATUS_IS_OK(status)) {\n+\t\ttalloc_free(smb_sess);\n+\t\treq->session = NULL;\n+\t}\n \tstatus = auth_nt_status_squash(status);\n \tsmbsrv_sesssetup_backend_send(req, sess, status);\n }\n\n"}