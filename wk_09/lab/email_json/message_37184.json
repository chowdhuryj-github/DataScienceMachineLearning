{"category": "ham", "to_address": "samba-cvs@samba.org", "from_address": "vlendec@samba.org", "subject": "svn commit: samba r23168 - in branches: SAMBA_3_0/source/printing\n\tSAMBA_3_0/source/smbd SAMBA_3_0_26/source/printing\n\tSAMBA_3_0_26/source/smbd", "body": "Author: vlendec\nDate: 2007-05-27 16:34:49 +0000 (Sun, 27 May 2007)\nNew Revision: 23168\n\nWebSVN: http://websvn.samba.org/cgi-bin/viewcvs.cgi?view=rev&root=samba&rev=23168\n\nLog:\nMove the lp_max_connections() into service.c.\n\nModified:\n   branches/SAMBA_3_0/source/printing/printing.c\n   branches/SAMBA_3_0/source/smbd/connection.c\n   branches/SAMBA_3_0/source/smbd/negprot.c\n   branches/SAMBA_3_0/source/smbd/server.c\n   branches/SAMBA_3_0/source/smbd/service.c\n   branches/SAMBA_3_0_26/source/printing/printing.c\n   branches/SAMBA_3_0_26/source/smbd/connection.c\n   branches/SAMBA_3_0_26/source/smbd/negprot.c\n   branches/SAMBA_3_0_26/source/smbd/server.c\n   branches/SAMBA_3_0_26/source/smbd/service.c\n\n\nChangeset:\nModified: branches/SAMBA_3_0/source/printing/printing.c\n===================================================================\n--- branches/SAMBA_3_0/source/printing/printing.c\t2007-05-27 16:22:12 UTC (rev 23167)\n+++ branches/SAMBA_3_0/source/printing/printing.c\t2007-05-27 16:34:49 UTC (rev 23168)\n@@ -1396,7 +1396,7 @@\n \t\t/* Child. */\n \t\tDEBUG(5,(\"start_background_queue: background LPQ thread started\\n\"));\n \n-\t\tclaim_connection( NULL, \"smbd lpq backend\", 0, \n+\t\tclaim_connection( NULL, \"smbd lpq backend\",\n \t\t\tFLAG_MSG_GENERAL|FLAG_MSG_SMBD|FLAG_MSG_PRINT_GENERAL);\n \n \t\tif (!locking_init(0)) {\n\nModified: branches/SAMBA_3_0/source/smbd/connection.c\n===================================================================\n--- branches/SAMBA_3_0/source/smbd/connection.c\t2007-05-27 16:22:12 UTC (rev 23167)\n+++ branches/SAMBA_3_0/source/smbd/connection.c\t2007-05-27 16:34:49 UTC (rev 23168)\n@@ -167,7 +167,7 @@\n ****************************************************************************/\n \n BOOL claim_connection(connection_struct *conn, const char *name,\n-\t\t      int max_connections, uint32 msg_flags)\n+\t\t      uint32 msg_flags)\n {\n \tstruct connections_key key;\n \tstruct connections_data crec;\n@@ -178,24 +178,8 @@\n \t\treturn False;\n \t}\n \t\n-\t/*\n-\t * Enforce the max connections parameter.\n-\t */\n+\tDEBUG(5,(\"claiming %s\\n\",name));\n \n-\tif (max_connections > 0) {\n-\t\tint curr_connections;\n-\t\t\n-\t\tcurr_connections = count_current_connections( lp_servicename(SNUM(conn)), True );\n-\n-\t\tif (curr_connections >= max_connections) {\n-\t\t\tDEBUG(1,(\"claim_connection: Max connections (%d) exceeded for %s\\n\",\n-\t\t\t\tmax_connections, name ));\n-\t\t\treturn False;\n-\t\t}\n-\t}\n-\n-\tDEBUG(5,(\"claiming %s %d\\n\",name,max_connections));\n-\n \tmake_conn_key(conn, name, &kbuf, &key);\n \n \t/* fill in the crec */\n\nModified: branches/SAMBA_3_0/source/smbd/negprot.c\n===================================================================\n--- branches/SAMBA_3_0/source/smbd/negprot.c\t2007-05-27 16:22:12 UTC (rev 23167)\n+++ branches/SAMBA_3_0/source/smbd/negprot.c\t2007-05-27 16:34:49 UTC (rev 23168)\n@@ -584,7 +584,8 @@\n \t   when the client connects to port 445.  Of course there is a small\n \t   window where we are listening to messages   -- jerry */\n \n-\tclaim_connection(NULL,\"\",0,FLAG_MSG_GENERAL|FLAG_MSG_SMBD|FLAG_MSG_PRINT_GENERAL);\n+\tclaim_connection(\n+\t\tNULL,\"\",FLAG_MSG_GENERAL|FLAG_MSG_SMBD|FLAG_MSG_PRINT_GENERAL);\n     \n \t/* Check for protocols, most desirable first */\n \tfor (protocol = 0; supported_protocols[protocol].proto_name; protocol++) {\n\nModified: branches/SAMBA_3_0/source/smbd/server.c\n===================================================================\n--- branches/SAMBA_3_0/source/smbd/server.c\t2007-05-27 16:22:12 UTC (rev 23167)\n+++ branches/SAMBA_3_0/source/smbd/server.c\t2007-05-27 16:34:49 UTC (rev 23168)\n@@ -1040,7 +1040,7 @@\n \t/* Setup the main smbd so that we can get messages. */\n \t/* don't worry about general printing messages here */\n \n-\tclaim_connection(NULL,\"\",0,FLAG_MSG_GENERAL|FLAG_MSG_SMBD);\n+\tclaim_connection(NULL,\"\",FLAG_MSG_GENERAL|FLAG_MSG_SMBD);\n \n \t/* only start the background queue daemon if we are \n \t   running as a daemon -- bad things will happen if\n\nModified: branches/SAMBA_3_0/source/smbd/service.c\n===================================================================\n--- branches/SAMBA_3_0/source/smbd/service.c\t2007-05-27 16:22:12 UTC (rev 23167)\n+++ branches/SAMBA_3_0/source/smbd/service.c\t2007-05-27 16:34:49 UTC (rev 23168)\n@@ -989,17 +989,31 @@\n \t}\n \n /* ROOT Activities: */\t\n-\t/* check number of connections */\n-\tif (!claim_connection(conn,\n-\t\t\t      lp_servicename(snum),\n-\t\t\t      lp_max_connections(snum),\n-\t\t\t      0)) {\n-\t\tDEBUG(1,(\"too many connections - rejected\\n\"));\n+\t/*\n+\t * Enforce the max connections parameter.\n+\t */\n+\n+\tif ((lp_max_connections(snum) > 0)\n+\t    && (count_current_connections(lp_servicename(SNUM(conn)), True) >=\n+\t\tlp_max_connections(snum))) {\n+\n+\t\tDEBUG(1, (\"Max connections (%d) exceeded for %s\\n\",\n+\t\t\t  lp_max_connections(snum), lp_servicename(snum)));\n \t\tconn_free(conn);\n \t\t*status = NT_STATUS_INSUFFICIENT_RESOURCES;\n \t\treturn NULL;\n \t}  \n \n+\t/*\n+\t * Get us an entry in the connections db\n+\t */\n+\tif (!claim_connection(conn, lp_servicename(snum), 0)) {\n+\t\tDEBUG(1, (\"Could not store connections entry\\n\"));\n+\t\tconn_free(conn);\n+\t\t*status = NT_STATUS_INTERNAL_DB_ERROR;\n+\t\treturn NULL;\n+\t}  \n+\n \t/* Preexecs are done here as they might make the dir we are to ChDir\n \t * to below */\n \t/* execute any \"root preexec = \" line */\n\nModified: branches/SAMBA_3_0_26/source/printing/printing.c\n===================================================================\n--- branches/SAMBA_3_0_26/source/printing/printing.c\t2007-05-27 16:22:12 UTC (rev 23167)\n+++ branches/SAMBA_3_0_26/source/printing/printing.c\t2007-05-27 16:34:49 UTC (rev 23168)\n@@ -1396,7 +1396,7 @@\n \t\t/* Child. */\n \t\tDEBUG(5,(\"start_background_queue: background LPQ thread started\\n\"));\n \n-\t\tclaim_connection( NULL, \"smbd lpq backend\", 0, \n+\t\tclaim_connection( NULL, \"smbd lpq backend\",\n \t\t\tFLAG_MSG_GENERAL|FLAG_MSG_SMBD|FLAG_MSG_PRINT_GENERAL);\n \n \t\tif (!locking_init(0)) {\n\nModified: branches/SAMBA_3_0_26/source/smbd/connection.c\n===================================================================\n--- branches/SAMBA_3_0_26/source/smbd/connection.c\t2007-05-27 16:22:12 UTC (rev 23167)\n+++ branches/SAMBA_3_0_26/source/smbd/connection.c\t2007-05-27 16:34:49 UTC (rev 23168)\n@@ -139,7 +139,7 @@\n ****************************************************************************/\n \n BOOL claim_connection(connection_struct *conn, const char *name,\n-\t\t      int max_connections, uint32 msg_flags)\n+\t\t      uint32 msg_flags)\n {\n \tstruct connections_key key;\n \tstruct connections_data crec;\n@@ -150,24 +150,8 @@\n \t\treturn False;\n \t}\n \t\n-\t/*\n-\t * Enforce the max connections parameter.\n-\t */\n+\tDEBUG(5,(\"claiming %s\\n\",name));\n \n-\tif (max_connections > 0) {\n-\t\tint curr_connections;\n-\t\t\n-\t\tcurr_connections = count_current_connections( lp_servicename(SNUM(conn)), True );\n-\n-\t\tif (curr_connections >= max_connections) {\n-\t\t\tDEBUG(1,(\"claim_connection: Max connections (%d) exceeded for %s\\n\",\n-\t\t\t\tmax_connections, name ));\n-\t\t\treturn False;\n-\t\t}\n-\t}\n-\n-\tDEBUG(5,(\"claiming %s %d\\n\",name,max_connections));\n-\n \tmake_conn_key(conn, name, &kbuf, &key);\n \n \t/* fill in the crec */\n\nModified: branches/SAMBA_3_0_26/source/smbd/negprot.c\n===================================================================\n--- branches/SAMBA_3_0_26/source/smbd/negprot.c\t2007-05-27 16:22:12 UTC (rev 23167)\n+++ branches/SAMBA_3_0_26/source/smbd/negprot.c\t2007-05-27 16:34:49 UTC (rev 23168)\n@@ -580,7 +580,8 @@\n \t   when the client connects to port 445.  Of course there is a small\n \t   window where we are listening to messages   -- jerry */\n \n-\tclaim_connection(NULL,\"\",0,FLAG_MSG_GENERAL|FLAG_MSG_SMBD|FLAG_MSG_PRINT_GENERAL);\n+\tclaim_connection(\n+\t\tNULL,\"\",FLAG_MSG_GENERAL|FLAG_MSG_SMBD|FLAG_MSG_PRINT_GENERAL);\n     \n \t/* Check for protocols, most desirable first */\n \tfor (protocol = 0; supported_protocols[protocol].proto_name; protocol++) {\n\nModified: branches/SAMBA_3_0_26/source/smbd/server.c\n===================================================================\n--- branches/SAMBA_3_0_26/source/smbd/server.c\t2007-05-27 16:22:12 UTC (rev 23167)\n+++ branches/SAMBA_3_0_26/source/smbd/server.c\t2007-05-27 16:34:49 UTC (rev 23168)\n@@ -1088,7 +1088,7 @@\n \t/* Setup the main smbd so that we can get messages. */\n \t/* don't worry about general printing messages here */\n \n-\tclaim_connection(NULL,\"\",0,FLAG_MSG_GENERAL|FLAG_MSG_SMBD);\n+\tclaim_connection(NULL,\"\",FLAG_MSG_GENERAL|FLAG_MSG_SMBD);\n \n \t/* only start the background queue daemon if we are \n \t   running as a daemon -- bad things will happen if\n\nModified: branches/SAMBA_3_0_26/source/smbd/service.c\n===================================================================\n--- branches/SAMBA_3_0_26/source/smbd/service.c\t2007-05-27 16:22:12 UTC (rev 23167)\n+++ branches/SAMBA_3_0_26/source/smbd/service.c\t2007-05-27 16:34:49 UTC (rev 23168)\n@@ -888,17 +888,31 @@\n \t}\n \n /* ROOT Activities: */\t\n-\t/* check number of connections */\n-\tif (!claim_connection(conn,\n-\t\t\t      lp_servicename(snum),\n-\t\t\t      lp_max_connections(snum),\n-\t\t\t      0)) {\n-\t\tDEBUG(1,(\"too many connections - rejected\\n\"));\n+\t/*\n+\t * Enforce the max connections parameter.\n+\t */\n+\n+\tif ((lp_max_connections(snum) > 0)\n+\t    && (count_current_connections(lp_servicename(SNUM(conn)), True) >=\n+\t\tlp_max_connections(snum))) {\n+\n+\t\tDEBUG(1, (\"Max connections (%d) exceeded for %s\\n\",\n+\t\t\t  lp_max_connections(snum), lp_servicename(snum)));\n \t\tconn_free(conn);\n \t\t*status = NT_STATUS_INSUFFICIENT_RESOURCES;\n \t\treturn NULL;\n \t}  \n \n+\t/*\n+\t * Get us an entry in the connections db\n+\t */\n+\tif (!claim_connection(conn, lp_servicename(snum), 0)) {\n+\t\tDEBUG(1, (\"Could not store connections entry\\n\"));\n+\t\tconn_free(conn);\n+\t\t*status = NT_STATUS_INTERNAL_DB_ERROR;\n+\t\treturn NULL;\n+\t}  \n+\n \t/* Preexecs are done here as they might make the dir we are to ChDir\n \t * to below */\n \t/* execute any \"root preexec = \" line */\n\n"}