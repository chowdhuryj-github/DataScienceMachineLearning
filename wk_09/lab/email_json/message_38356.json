{"category": "ham", "to_address": "samba-cvs@samba.org", "from_address": "jerry@samba.org", "subject": "svn commit: samba r23214 - in\n\tbranches/SAMBA_3_0_26/source/rpc_server: .", "body": "Author: jerry\nDate: 2007-05-29 17:10:36 +0000 (Tue, 29 May 2007)\nNew Revision: 23214\n\nWebSVN: http://websvn.samba.org/cgi-bin/viewcvs.cgi?view=rev&root=samba&rev=23214\n\nLog:\nMerge signature change for get_printer_snum() from SAMBA_3_0.\nDoes not include change from snum to struct share_pararms.\nJust decreases the diff.\n\n\nModified:\n   branches/SAMBA_3_0_26/source/rpc_server/srv_spoolss_nt.c\n\n\nChangeset:\nModified: branches/SAMBA_3_0_26/source/rpc_server/srv_spoolss_nt.c\n===================================================================\n--- branches/SAMBA_3_0_26/source/rpc_server/srv_spoolss_nt.c\t2007-05-29 16:54:01 UTC (rev 23213)\n+++ branches/SAMBA_3_0_26/source/rpc_server/srv_spoolss_nt.c\t2007-05-29 17:10:36 UTC (rev 23214)\n@@ -375,7 +375,8 @@\n  Return the snum of a printer corresponding to an handle.\n ****************************************************************************/\n \n-static BOOL get_printer_snum(pipes_struct *p, POLICY_HND *hnd, int *number)\n+static BOOL get_printer_snum(pipes_struct *p, POLICY_HND *hnd, int *number,\n+\t\t\t     struct share_params **params)\n {\n \tPrinter_entry *Printer = find_printer_index_by_hnd(p, hnd);\n \t\t\n@@ -1649,7 +1650,7 @@\n \t\t/* NT doesn't let us connect to a printer if the connecting user\n \t\t   doesn't have print permission.  */\n \n-\t\tif (!get_printer_snum(p, handle, &snum)) {\n+\t\tif (!get_printer_snum(p, handle, &snum, NULL)) {\n \t\t\tclose_printer_handle(p, handle);\n \t\t\treturn WERR_BADFID;\n \t\t}\n@@ -1876,7 +1877,7 @@\n \t\treturn WERR_BADFID;\n \t}\n \t\n-\tif (!get_printer_snum(p, handle, &snum))\n+\tif (!get_printer_snum(p, handle, &snum, NULL))\n \t\treturn WERR_BADFID;\n \n \tPrinter->document_started=False;\n@@ -2468,7 +2469,7 @@\n \t\tstatus = getprinterdata_printer_server( p->mem_ctx, value, type, data, needed, *out_size );\n \telse\n \t{\n-\t\tif ( !get_printer_snum(p,handle, &snum) ) {\n+\t\tif ( !get_printer_snum(p,handle, &snum, NULL) ) {\n \t\t\tstatus = WERR_BADFID;\n \t\t\tgoto done;\n \t\t}\n@@ -2687,7 +2688,7 @@\n \tif ( Printer->printer_type == SPLHND_SERVER)\n \t\tsnum = -1;\n \telse if ( (Printer->printer_type == SPLHND_PRINTER) &&\n-\t\t\t!get_printer_snum(p, handle, &snum) )\n+\t\t\t!get_printer_snum(p, handle, &snum, NULL) )\n \t\treturn WERR_BADFID;\n \t\t\n \tclient_ip.s_addr = inet_addr(p->conn->client_address);\n@@ -3827,7 +3828,7 @@\n \tif ( !option )\n \t\treturn WERR_BADFID;\n \n-\tget_printer_snum(p, hnd, &snum);\n+\tget_printer_snum(p, hnd, &snum, NULL);\n \n \tfor (i=0; icount; i++) {\n \t\toption_type=&option->ctr.type[i];\n@@ -5086,7 +5087,7 @@\n \n \t*needed=0;\n \n-\tif (!get_printer_snum(p, handle, &snum))\n+\tif (!get_printer_snum(p, handle, &snum, NULL))\n \t\treturn WERR_BADFID;\n \n \tswitch (level) {\n@@ -5702,7 +5703,7 @@\n \tfstrcpy(servername, get_server_name( printer ));\n \tunistr2_to_ascii(architecture, uni_arch, sizeof(architecture)-1);\n \n-\tif (!get_printer_snum(p, handle, &snum))\n+\tif (!get_printer_snum(p, handle, &snum, NULL))\n \t\treturn WERR_BADFID;\n \n \tswitch (level) {\n@@ -5758,7 +5759,7 @@\n \t\treturn WERR_BADFID;\n \t}\n \t\n-\tif (!get_printer_snum(p, handle, &snum))\n+\tif (!get_printer_snum(p, handle, &snum, NULL))\n \t\treturn WERR_BADFID;\n \n \tPrinter->page_started=False;\n@@ -5807,7 +5808,7 @@\n \t}\t\t\n \t\n \t/* get the share number of the printer */\n-\tif (!get_printer_snum(p, handle, &snum)) {\n+\tif (!get_printer_snum(p, handle, &snum, NULL)) {\n \t\treturn WERR_BADFID;\n \t}\n \n@@ -5859,7 +5860,7 @@\n \t\treturn WERR_BADFID;\n \t}\n \n-\tif (!get_printer_snum(p, handle, &snum))\n+\tif (!get_printer_snum(p, handle, &snum, NULL))\n \t\treturn WERR_BADFID;\n \n \t(*buffer_written) = (uint32)print_job_write(snum, Printer->jobid, (const char *)buffer,\n@@ -5895,7 +5896,7 @@\n \t\treturn WERR_BADFID;\n \t}\n \n-\tif (!get_printer_snum(p, handle, &snum))\n+\tif (!get_printer_snum(p, handle, &snum, NULL))\n \t\treturn WERR_BADFID;\n \n \tswitch (command) {\n@@ -5940,7 +5941,7 @@\n \t\treturn WERR_BADFID;\n \t}\n \t\n-\tif (!get_printer_snum(p, handle, &snum))\n+\tif (!get_printer_snum(p, handle, &snum, NULL))\n \t\treturn WERR_BADFID;\n \t\n \tprint_job_delete( &p->pipe_user, snum, Printer->jobid, &errcode );\t\n@@ -5963,7 +5964,7 @@\n \n \tPrinter_entry *Printer = find_printer_index_by_hnd(p, handle);\n \n-\tif (!Printer || !get_printer_snum(p, handle, &snum)) {\n+\tif (!Printer || !get_printer_snum(p, handle, &snum, NULL)) {\n \t\tDEBUG(2,(\"update_printer_sec: Invalid handle (%s:%u:%u)\\n\",\n \t\t\t OUR_HANDLE(handle)));\n \n@@ -6245,7 +6246,7 @@\n \t\tgoto done;\n \t}\n \n-\tif (!get_printer_snum(p, handle, &snum)) {\n+\tif (!get_printer_snum(p, handle, &snum, NULL)) {\n \t\tresult = WERR_BADFID;\n \t\tgoto done;\n \t}\n@@ -6436,7 +6437,7 @@\n \tif (!Printer)\n \t\treturn WERR_BADFID;\n \n-\tif (!get_printer_snum(p, handle, &snum))\n+\tif (!get_printer_snum(p, handle, &snum, NULL))\n \t\treturn WERR_BADFID;\n \t\n \tnt_printer_publish(Printer, snum, info7->action);\n@@ -6506,7 +6507,7 @@\n \t\tif ( Printer->printer_type == SPLHND_SERVER)\n \t\t\tsnum = -1;\n \t\telse if ( (Printer->printer_type == SPLHND_PRINTER) &&\n-\t\t\t\t!get_printer_snum(p, handle, &snum) )\n+\t\t\t\t!get_printer_snum(p, handle, &snum, NULL) )\n \t\t\treturn WERR_BADFID;\n \n \t\tsrv_spoolss_replycloseprinter(snum, &Printer->notify.client_hnd);\n@@ -6753,7 +6754,7 @@\n \n \t/* lookup the printer snum and tdb entry */\n \t\n-\tif (!get_printer_snum(p, handle, &snum))\n+\tif (!get_printer_snum(p, handle, &snum, NULL))\n \t\treturn WERR_BADFID;\n \n \twret = get_a_printer(NULL, &ntprinter, 2, lp_servicename(snum));\n@@ -6803,10 +6804,11 @@\n \tPOLICY_HND *handle = &q_u->handle;\n \tuint32 jobid = q_u->jobid;\n \tuint32 command = q_u->command;\n+\n \tint snum;\n \tWERROR errcode = WERR_BADFUNC;\n \t\t\n-\tif (!get_printer_snum(p, handle, &snum)) {\n+\tif (!get_printer_snum(p, handle, &snum, NULL)) {\n \t\treturn WERR_BADFID;\n \t}\n \n@@ -8032,7 +8034,7 @@\n \t\treturn WERR_BADFID;\n \t}\n \n-\tif (!get_printer_snum(p,handle, &snum))\n+\tif (!get_printer_snum(p,handle, &snum, NULL))\n \t\treturn WERR_BADFID;\n \t\n \tresult = get_a_printer(Printer, &printer, 2, lp_const_servicename(snum));\n@@ -8206,7 +8208,7 @@\n \t\treturn WERR_INVALID_PARAM;\n \t}\n \n-\tif (!get_printer_snum(p,handle, &snum))\n+\tif (!get_printer_snum(p,handle, &snum, NULL))\n \t\treturn WERR_BADFID;\n \n \t/* \n@@ -8278,7 +8280,7 @@\n \t\treturn WERR_BADFID;\n \t}\n \n-\tif (!get_printer_snum(p,handle, &snum))\n+\tif (!get_printer_snum(p,handle, &snum, NULL))\n \t\treturn WERR_BADFID;\n \n \n@@ -8308,7 +8310,7 @@\n \t\treturn WERR_BADFID;\n \t}\n \n-\tif (!get_printer_snum(p, handle, &snum))\n+\tif (!get_printer_snum(p, handle, &snum, NULL))\n \t\treturn WERR_BADFID;\n \n \tif (Printer->access_granted != PRINTER_ACCESS_ADMINISTER) {\n@@ -8360,7 +8362,7 @@\n \t\n \tif ( Printer->printer_type == SPLHND_PRINTER )\n \t{\n-\t\tif (!get_printer_snum(p,handle, &snum))\n+\t\tif (!get_printer_snum(p,handle, &snum, NULL))\n \t                return WERR_BADFID;\n \t \n \t\tstatus = get_a_printer(Printer, &printer, 2, lp_const_servicename(snum));\n@@ -8431,7 +8433,7 @@\n \t\n \tif ( Printer->printer_type == SPLHND_PRINTER )\n \t{\n-\t\tif (!get_printer_snum(p,handle, &snum))\n+\t\tif (!get_printer_snum(p,handle, &snum, NULL))\n \t                return WERR_BADFID;\n \t \n \t\tstatus = get_a_printer(Printer, &printer, 2, lp_const_servicename(snum));\n@@ -8499,7 +8501,7 @@\n \t\n \tif ( Printer->printer_type == SPLHND_PRINTER )\n \t{\n-\t\tif (!get_printer_snum(p,handle, &snum))\n+\t\tif (!get_printer_snum(p,handle, &snum, NULL))\n \t                return WERR_BADFID;\n \t \n \t\tstatus = get_a_printer(Printer, &printer, 2, lp_const_servicename(snum));\n@@ -8985,7 +8987,7 @@\n \t\n \t*needed = 0;\n \t\n-\tif (!get_printer_snum(p, handle, &snum))\n+\tif (!get_printer_snum(p, handle, &snum, NULL))\n \t\treturn WERR_BADFID;\n \t\n \twstatus = get_a_printer(NULL, &ntprinter, 2, lp_servicename(snum));\n@@ -9068,7 +9070,7 @@\n \t\tgoto done;\n \t}\n \t\n-\tif ( !get_printer_snum(p,handle, &snum) )\n+\tif ( !get_printer_snum(p,handle, &snum, NULL) )\n \t\treturn WERR_BADFID;\n \n \tstatus = get_a_printer(Printer, &printer, 2, lp_servicename(snum));\n@@ -9153,7 +9155,7 @@\n \t\treturn WERR_INVALID_PARAM;\n \t}\n \n-\tif ( !get_printer_snum(p,handle, &snum) )\n+\tif ( !get_printer_snum(p,handle, &snum, NULL) )\n \t\treturn WERR_BADFID;\n \n \t/* \n@@ -9204,7 +9206,8 @@\n \t\t\t */\n \t\t \n \t\t\tset_printer_dataex( printer, keyname, valuename, \n-\t\t\t                    REG_SZ, (uint8 *)oid_string, strlen(oid_string)+1 );\t\t\n+\t\t\t                    REG_SZ, (uint8 *)oid_string,\n+\t\t\t\t\t    strlen(oid_string)+1 );\n \t\t}\n \t\n \t\tstatus = mod_a_printer(printer, 2);\n@@ -9239,7 +9242,7 @@\n \t\treturn WERR_BADFID;\n \t}\n \n-\tif (!get_printer_snum(p, handle, &snum))\n+\tif (!get_printer_snum(p, handle, &snum, NULL))\n \t\treturn WERR_BADFID;\n \n \tif (Printer->access_granted != PRINTER_ACCESS_ADMINISTER) {\n@@ -9291,7 +9294,7 @@\n \t\treturn WERR_BADFID;\n \t}\n \n-\tif ( !get_printer_snum(p,handle, &snum) )\n+\tif ( !get_printer_snum(p,handle, &snum, NULL) )\n \t\treturn WERR_BADFID;\n \n \tstatus = get_a_printer(Printer, &printer, 2, lp_const_servicename(snum));\n@@ -9361,7 +9364,7 @@\n \tif ( !q_u->keyname.buffer )\n \t\treturn WERR_INVALID_PARAM;\n \t\t\n-\tif (!get_printer_snum(p, handle, &snum))\n+\tif (!get_printer_snum(p, handle, &snum, NULL))\n \t\treturn WERR_BADFID;\n \n \tif (Printer->access_granted != PRINTER_ACCESS_ADMINISTER) {\n@@ -9434,7 +9437,7 @@\n \n \t/* get the printer off of disk */\n \t\n-\tif (!get_printer_snum(p,handle, &snum))\n+\tif (!get_printer_snum(p,handle, &snum, NULL))\n \t\treturn WERR_BADFID;\n \t\n \tZERO_STRUCT(printer);\n@@ -9494,7 +9497,7 @@\n \t\t\n \t\tdata_len = regval_size( val );\n \t\tif ( data_len ) {\n-\t\t\tif ( !(enum_values[i].data = TALLOC_MEMDUP(p->mem_ctx, regval_data_p(val), data_len)) ) \n+\t\t\tif ( !(enum_values[i].data = (uint8 *)TALLOC_MEMDUP(p->mem_ctx, regval_data_p(val), data_len)) ) \n \t\t\t{\n \t\t\t\tDEBUG(0,(\"TALLOC_MEMDUP failed to allocate memory [data_len=%d] for data!\\n\", \n \t\t\t\t\tdata_len ));\n\n"}