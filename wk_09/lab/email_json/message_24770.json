{"category": "ham", "to_address": "samba-cvs@samba.org", "from_address": "vlendec@samba.org", "subject": "svn commit: samba r22751 - in branches: SAMBA_3_0/source/include\n\tSAMBA_3_0/source/rpc_server SAMBA_3_0/source/smbd\n\tSAMBA_3_0/source/utils SAMBA_3_0_26/source/include\n\tSAMBA_3_0_26/source/rpc_server SAMBA_3_0_26/source/smbd\n\tSAMBA_3_0_26/source/utils", "body": "Author: vlendec\nDate: 2007-05-07 15:31:12 +0000 (Mon, 07 May 2007)\nNew Revision: 22751\n\nWebSVN: http://websvn.samba.org/cgi-bin/viewcvs.cgi?view=rev&root=samba&rev=22751\n\nLog:\nNext step for the cluster merge: sessionid.tdb should contain a 'struct\nserver_id' instead of a 'uint32 pid'\n\nModified:\n   branches/SAMBA_3_0/source/include/session.h\n   branches/SAMBA_3_0/source/rpc_server/srv_srvsvc_nt.c\n   branches/SAMBA_3_0/source/smbd/session.c\n   branches/SAMBA_3_0/source/smbd/sesssetup.c\n   branches/SAMBA_3_0/source/utils/net_status.c\n   branches/SAMBA_3_0/source/utils/status.c\n   branches/SAMBA_3_0_26/source/include/session.h\n   branches/SAMBA_3_0_26/source/rpc_server/srv_srvsvc_nt.c\n   branches/SAMBA_3_0_26/source/smbd/session.c\n   branches/SAMBA_3_0_26/source/smbd/sesssetup.c\n   branches/SAMBA_3_0_26/source/utils/net_status.c\n   branches/SAMBA_3_0_26/source/utils/status.c\n\n\nChangeset:\nModified: branches/SAMBA_3_0/source/include/session.h\n===================================================================\n--- branches/SAMBA_3_0/source/include/session.h\t2007-05-07 15:29:25 UTC (rev 22750)\n+++ branches/SAMBA_3_0/source/include/session.h\t2007-05-07 15:31:12 UTC (rev 22751)\n@@ -36,7 +36,7 @@\n \tfstring remote_machine;\n \tfstring id_str;\n \tuint32  id_num;\n-\tuint32  pid;\n+\tstruct server_id pid;\n \tfstring ip_addr;\n \ttime_t connect_start;\n };\n\nModified: branches/SAMBA_3_0/source/rpc_server/srv_srvsvc_nt.c\n===================================================================\n--- branches/SAMBA_3_0/source/rpc_server/srv_srvsvc_nt.c\t2007-05-07 15:29:25 UTC (rev 22750)\n+++ branches/SAMBA_3_0/source/rpc_server/srv_srvsvc_nt.c\t2007-05-07 15:31:12 UTC (rev 22751)\n@@ -43,7 +43,7 @@\n };\n \n struct sess_file_count {\n-\tpid_t pid;\n+\tstruct server_id pid;\n \tuid_t uid;\n \tint count;\n };\n@@ -809,7 +809,7 @@\n {\n \tstruct sess_file_count *sess = (struct sess_file_count *)private_data;\n  \n-\tif ( (procid_to_pid(&e->pid) == sess->pid) && (sess->uid == e->uid) ) {\n+\tif ( procid_equal(&e->pid, &sess->pid) && (sess->uid == e->uid) ) {\n \t\tsess->count++;\n \t}\n \t\n@@ -819,7 +819,7 @@\n /*******************************************************************\n ********************************************************************/\n \n-static int net_count_files( uid_t uid, pid_t pid )\n+static int net_count_files( uid_t uid, struct server_id pid )\n {\n \tstruct sess_file_count s_file_cnt;\n \n@@ -1237,7 +1237,7 @@\n \t\tif ((strequal(session_list[snum].username, r->in.user) || r->in.user[0] == '\\0' ) &&\n \t\t     strequal(session_list[snum].remote_machine, machine)) {\n \t\t\n-\t\t\tif (NT_STATUS_IS_OK(message_send_pid(pid_to_procid(session_list[snum].pid), MSG_SHUTDOWN, NULL, 0, False)))\n+\t\t\tif (NT_STATUS_IS_OK(message_send_pid(session_list[snum].pid, MSG_SHUTDOWN, NULL, 0, False)))\n \t\t\t\tstatus = WERR_OK;\n \t\t}\n \t}\n\nModified: branches/SAMBA_3_0/source/smbd/session.c\n===================================================================\n--- branches/SAMBA_3_0/source/smbd/session.c\t2007-05-07 15:29:25 UTC (rev 22750)\n+++ branches/SAMBA_3_0/source/smbd/session.c\t2007-05-07 15:31:12 UTC (rev 22751)\n@@ -60,7 +60,7 @@\n \tstruct sockaddr sa;\n \tstruct in_addr *client_ip;\n \tstruct sessionid sessionid;\n-\tuint32 pid = (uint32)sys_getpid();\n+\tstruct server_id pid = procid_self();\n \tfstring keystr;\n \tchar * hostname;\n \tint tdb_store_flag;  /* If using utmp, we do an inital 'lock hold' store,\n\nModified: branches/SAMBA_3_0/source/smbd/sesssetup.c\n===================================================================\n--- branches/SAMBA_3_0/source/smbd/sesssetup.c\t2007-05-07 15:29:25 UTC (rev 22750)\n+++ branches/SAMBA_3_0/source/smbd/sesssetup.c\t2007-05-07 15:31:12 UTC (rev 22751)\n@@ -1180,11 +1180,11 @@\n \tstruct sessionid *sessionid = (struct sessionid *)dbuf.dptr;\n \tconst char *ip = (const char *)p;\n \n-\tif (!process_exists(pid_to_procid(sessionid->pid))) {\n+\tif (!process_exists(sessionid->pid)) {\n \t\treturn 0;\n \t}\n \n-\tif (sessionid->pid == sys_getpid()) {\n+\tif (procid_is_me(&sessionid->pid)) {\n \t\treturn 0;\n \t}\n \n@@ -1192,7 +1192,7 @@\n \t\treturn 0;\n \t}\n \n-\tmessage_send_pid(pid_to_procid(sessionid->pid), MSG_SHUTDOWN,\n+\tmessage_send_pid(sessionid->pid, MSG_SHUTDOWN,\n \t\t\t NULL, 0, True);\n \treturn 0;\n }\n\nModified: branches/SAMBA_3_0/source/utils/net_status.c\n===================================================================\n--- branches/SAMBA_3_0/source/utils/net_status.c\t2007-05-07 15:29:25 UTC (rev 22750)\n+++ branches/SAMBA_3_0/source/utils/net_status.c\t2007-05-07 15:31:12 UTC (rev 22751)\n@@ -31,18 +31,18 @@\n \n \tmemcpy(&sessionid, dbuf.dptr, sizeof(sessionid));\n \n-\tif (!process_exists_by_pid(sessionid.pid)) {\n+\tif (!process_exists(sessionid.pid)) {\n \t\treturn 0;\n \t}\n \n \tif (*parseable) {\n-\t\td_printf(\"%d\\\\%s\\\\%s\\\\%s\\\\%s\\n\",\n-\t\t\t (int)sessionid.pid, uidtoname(sessionid.uid),\n+\t\td_printf(\"%s\\\\%s\\\\%s\\\\%s\\\\%s\\n\",\n+\t\t\t procid_str_static(&sessionid.pid), uidtoname(sessionid.uid),\n \t\t\t gidtoname(sessionid.gid), \n \t\t\t sessionid.remote_machine, sessionid.hostname);\n \t} else {\n-\t\td_printf(\"%5d   %-12s  %-12s  %-12s (%s)\\n\",\n-\t\t\t (int)sessionid.pid, uidtoname(sessionid.uid),\n+\t\td_printf(\"%7s   %-12s  %-12s  %-12s (%s)\\n\",\n+\t\t\t procid_str_static(&sessionid.pid), uidtoname(sessionid.uid),\n \t\t\t gidtoname(sessionid.gid), \n \t\t\t sessionid.remote_machine, sessionid.hostname);\n \t}\n@@ -102,7 +102,7 @@\n \t}\n \n \td_printf(\"%-10.10s   %s   %-12s  %s\",\n-\t       crec.servicename,procid_str_static(&crec.pid),\n+\t       crec.servicename, procid_str_static(&crec.pid),\n \t       crec.machine,\n \t       time_to_asc(crec.start));\n \n@@ -125,7 +125,7 @@\n \n \tmemcpy(&sessionid, dbuf.dptr, sizeof(sessionid));\n \n-\tif (!process_exists_by_pid(sessionid.pid)) \n+\tif (!process_exists(sessionid.pid)) \n \t\treturn 0;\n \n \tids->num_entries += 1;\n@@ -160,7 +160,7 @@\n \t}\n \n \tfor (i=0; inum_entries; i++) {\n-\t\tstruct server_id id = pid_to_procid(ids->entries[i].pid);\n+\t\tstruct server_id id = ids->entries[i].pid;\n \t\tif (procid_equal(&id, &crec.pid)) {\n \t\t\tguest = False;\n \t\t\tbreak;\n\nModified: branches/SAMBA_3_0/source/utils/status.c\n===================================================================\n--- branches/SAMBA_3_0/source/utils/status.c\t2007-05-07 15:29:25 UTC (rev 22750)\n+++ branches/SAMBA_3_0/source/utils/status.c\t2007-05-07 15:31:12 UTC (rev 22751)\n@@ -35,7 +35,7 @@\n \n #define SMB_MAXPIDS\t\t2048\n static uid_t \t\tUcrit_uid = 0;               /* added by OH */\n-static pid_t\t\tUcrit_pid[SMB_MAXPIDS];  /* Ugly !!! */   /* added by OH */\n+static struct server_id\tUcrit_pid[SMB_MAXPIDS];  /* Ugly !!! */   /* added by OH */\n static int\t\tUcrit_MaxPid=0;                    /* added by OH */\n static unsigned int\tUcrit_IsActive = 0;                /* added by OH */\n \n@@ -69,7 +69,7 @@\n \treturn 0;\n }\n \n-static unsigned int Ucrit_checkPid(pid_t pid)\n+static unsigned int Ucrit_checkPid(struct server_id pid)\n {\n \tint i;\n \t\n@@ -77,14 +77,14 @@\n \t\treturn 1;\n \t\n \tfor (i=0;ipid))) {\n+\tif (Ucrit_checkPid(e->pid)) {\n \t\td_printf(\"%-11s  \",procid_str_static(&e->pid));\n \t\td_printf(\"%-9u  \", (unsigned int)e->uid);\n \t\tswitch (map_share_mode_to_deny_mode(e->share_access,\n@@ -222,7 +222,7 @@\n \n \tmemcpy(&sessionid, dbuf.dptr, sizeof(sessionid));\n \n-\tif (!process_exists_by_pid(sessionid.pid) || !Ucrit_checkUid(sessionid.uid)) {\n+\tif (!process_exists(sessionid.pid) || !Ucrit_checkUid(sessionid.uid)) {\n \t\treturn 0;\n \t}\n \n@@ -231,8 +231,8 @@\n \tfstr_sprintf(uid_str, \"%d\", sessionid.uid);\n \tfstr_sprintf(gid_str, \"%d\", sessionid.gid);\n \n-\td_printf(\"%5d   %-12s  %-12s  %-12s (%s)\\n\",\n-\t\t (int)sessionid.pid,\n+\td_printf(\"%s   %-12s  %-12s  %-12s (%s)\\n\",\n+\t\t procid_str_static(&sessionid.pid),\n \t\t numeric_only ? uid_str : uidtoname(sessionid.uid),\n \t\t numeric_only ? gid_str : gidtoname(sessionid.gid), \n \t\t sessionid.remote_machine, sessionid.hostname);\n\nModified: branches/SAMBA_3_0_26/source/include/session.h\n===================================================================\n--- branches/SAMBA_3_0_26/source/include/session.h\t2007-05-07 15:29:25 UTC (rev 22750)\n+++ branches/SAMBA_3_0_26/source/include/session.h\t2007-05-07 15:31:12 UTC (rev 22751)\n@@ -36,7 +36,7 @@\n \tfstring remote_machine;\n \tfstring id_str;\n \tuint32  id_num;\n-\tuint32  pid;\n+\tstruct server_id pid;\n \tfstring ip_addr;\n \ttime_t connect_start;\n };\n\nModified: branches/SAMBA_3_0_26/source/rpc_server/srv_srvsvc_nt.c\n===================================================================\n--- branches/SAMBA_3_0_26/source/rpc_server/srv_srvsvc_nt.c\t2007-05-07 15:29:25 UTC (rev 22750)\n+++ branches/SAMBA_3_0_26/source/rpc_server/srv_srvsvc_nt.c\t2007-05-07 15:31:12 UTC (rev 22751)\n@@ -39,7 +39,7 @@\n };\n \n struct sess_file_count {\n-\tpid_t pid;\n+\tstruct server_id pid;\n \tuid_t uid;\n \tint count;\n };\n@@ -821,7 +821,7 @@\n {\n \tstruct sess_file_count *sess = &s_file_cnt;\n  \n-\tif ( (procid_to_pid(&e->pid) == sess->pid) && (sess->uid == e->uid) ) {\n+\tif ( procid_equal(&e->pid, &sess->pid) && (sess->uid == e->uid) ) {\n \t\tsess->count++;\n \t}\n \t\n@@ -831,7 +831,7 @@\n /*******************************************************************\n ********************************************************************/\n \n-static int net_count_files( uid_t uid, pid_t pid )\n+static int net_count_files( uid_t uid, struct server_id pid )\n {\n \ts_file_cnt.count = 0;\n \ts_file_cnt.uid = uid;\n@@ -1350,7 +1350,7 @@\n \t\t\t\tbecome_root();\n \t\t\t}\n \n-\t\t\tif (NT_STATUS_IS_OK(message_send_pid(pid_to_procid(session_list[snum].pid), MSG_SHUTDOWN, NULL, 0, False)))\n+\t\t\tif (NT_STATUS_IS_OK(message_send_pid(session_list[snum].pid, MSG_SHUTDOWN, NULL, 0, False)))\n \t\t\t\tr_u->status = WERR_OK;\n \n \t\t\tif (not_root) \n\nModified: branches/SAMBA_3_0_26/source/smbd/session.c\n===================================================================\n--- branches/SAMBA_3_0_26/source/smbd/session.c\t2007-05-07 15:29:25 UTC (rev 22750)\n+++ branches/SAMBA_3_0_26/source/smbd/session.c\t2007-05-07 15:31:12 UTC (rev 22751)\n@@ -60,7 +60,7 @@\n \tstruct sockaddr sa;\n \tstruct in_addr *client_ip;\n \tstruct sessionid sessionid;\n-\tuint32 pid = (uint32)sys_getpid();\n+\tstruct server_id pid = procid_self();\n \tTDB_DATA key;\t\t\n \tfstring keystr;\n \tchar * hostname;\n\nModified: branches/SAMBA_3_0_26/source/smbd/sesssetup.c\n===================================================================\n--- branches/SAMBA_3_0_26/source/smbd/sesssetup.c\t2007-05-07 15:29:25 UTC (rev 22750)\n+++ branches/SAMBA_3_0_26/source/smbd/sesssetup.c\t2007-05-07 15:31:12 UTC (rev 22751)\n@@ -1178,11 +1178,11 @@\n \tstruct sessionid *sessionid = (struct sessionid *)dbuf.dptr;\n \tconst char *ip = (const char *)p;\n \n-\tif (!process_exists(pid_to_procid(sessionid->pid))) {\n+\tif (!process_exists(sessionid->pid)) {\n \t\treturn 0;\n \t}\n \n-\tif (sessionid->pid == sys_getpid()) {\n+\tif (procid_is_me(&sessionid->pid)) {\n \t\treturn 0;\n \t}\n \n@@ -1190,7 +1190,7 @@\n \t\treturn 0;\n \t}\n \n-\tmessage_send_pid(pid_to_procid(sessionid->pid), MSG_SHUTDOWN,\n+\tmessage_send_pid(sessionid->pid, MSG_SHUTDOWN,\n \t\t\t NULL, 0, True);\n \treturn 0;\n }\n\nModified: branches/SAMBA_3_0_26/source/utils/net_status.c\n===================================================================\n--- branches/SAMBA_3_0_26/source/utils/net_status.c\t2007-05-07 15:29:25 UTC (rev 22750)\n+++ branches/SAMBA_3_0_26/source/utils/net_status.c\t2007-05-07 15:31:12 UTC (rev 22751)\n@@ -31,18 +31,18 @@\n \n \tmemcpy(&sessionid, dbuf.dptr, sizeof(sessionid));\n \n-\tif (!process_exists_by_pid(sessionid.pid)) {\n+\tif (!process_exists(sessionid.pid)) {\n \t\treturn 0;\n \t}\n \n \tif (*parseable) {\n-\t\td_printf(\"%d\\\\%s\\\\%s\\\\%s\\\\%s\\n\",\n-\t\t\t (int)sessionid.pid, uidtoname(sessionid.uid),\n+\t\td_printf(\"%s\\\\%s\\\\%s\\\\%s\\\\%s\\n\",\n+\t\t\t procid_str_static(&sessionid.pid), uidtoname(sessionid.uid),\n \t\t\t gidtoname(sessionid.gid), \n \t\t\t sessionid.remote_machine, sessionid.hostname);\n \t} else {\n-\t\td_printf(\"%5d   %-12s  %-12s  %-12s (%s)\\n\",\n-\t\t\t (int)sessionid.pid, uidtoname(sessionid.uid),\n+\t\td_printf(\"%7s   %-12s  %-12s  %-12s (%s)\\n\",\n+\t\t\t procid_str_static(&sessionid.pid), uidtoname(sessionid.uid),\n \t\t\t gidtoname(sessionid.gid), \n \t\t\t sessionid.remote_machine, sessionid.hostname);\n \t}\n@@ -102,7 +102,7 @@\n \t}\n \n \td_printf(\"%-10.10s   %s   %-12s  %s\",\n-\t       crec.servicename,procid_str_static(&crec.pid),\n+\t       crec.servicename, procid_str_static(&crec.pid),\n \t       crec.machine,\n \t       time_to_asc(crec.start));\n \n@@ -125,7 +125,7 @@\n \n \tmemcpy(&sessionid, dbuf.dptr, sizeof(sessionid));\n \n-\tif (!process_exists_by_pid(sessionid.pid)) \n+\tif (!process_exists(sessionid.pid)) \n \t\treturn 0;\n \n \tids->num_entries += 1;\n@@ -160,7 +160,7 @@\n \t}\n \n \tfor (i=0; inum_entries; i++) {\n-\t\tstruct server_id id = pid_to_procid(ids->entries[i].pid);\n+\t\tstruct server_id id = ids->entries[i].pid;\n \t\tif (procid_equal(&id, &crec.pid)) {\n \t\t\tguest = False;\n \t\t\tbreak;\n\nModified: branches/SAMBA_3_0_26/source/utils/status.c\n===================================================================\n--- branches/SAMBA_3_0_26/source/utils/status.c\t2007-05-07 15:29:25 UTC (rev 22750)\n+++ branches/SAMBA_3_0_26/source/utils/status.c\t2007-05-07 15:31:12 UTC (rev 22751)\n@@ -35,7 +35,7 @@\n \n #define SMB_MAXPIDS\t\t2048\n static uid_t \t\tUcrit_uid = 0;               /* added by OH */\n-static pid_t\t\tUcrit_pid[SMB_MAXPIDS];  /* Ugly !!! */   /* added by OH */\n+static struct server_id\tUcrit_pid[SMB_MAXPIDS];  /* Ugly !!! */   /* added by OH */\n static int\t\tUcrit_MaxPid=0;                    /* added by OH */\n static unsigned int\tUcrit_IsActive = 0;                /* added by OH */\n \n@@ -69,7 +69,7 @@\n \treturn 0;\n }\n \n-static unsigned int Ucrit_checkPid(pid_t pid)\n+static unsigned int Ucrit_checkPid(struct server_id pid)\n {\n \tint i;\n \t\n@@ -77,14 +77,14 @@\n \t\treturn 1;\n \t\n \tfor (i=0;ipid))) {\n+\tif (Ucrit_checkPid(e->pid)) {\n \t\td_printf(\"%-11s  \",procid_str_static(&e->pid));\n \t\td_printf(\"%-9u  \", (unsigned int)e->uid);\n \t\tswitch (map_share_mode_to_deny_mode(e->share_access,\n@@ -222,7 +222,7 @@\n \n \tmemcpy(&sessionid, dbuf.dptr, sizeof(sessionid));\n \n-\tif (!process_exists_by_pid(sessionid.pid) || !Ucrit_checkUid(sessionid.uid)) {\n+\tif (!process_exists(sessionid.pid) || !Ucrit_checkUid(sessionid.uid)) {\n \t\treturn 0;\n \t}\n \n@@ -231,8 +231,8 @@\n \tfstr_sprintf(uid_str, \"%d\", sessionid.uid);\n \tfstr_sprintf(gid_str, \"%d\", sessionid.gid);\n \n-\td_printf(\"%5d   %-12s  %-12s  %-12s (%s)\\n\",\n-\t\t (int)sessionid.pid,\n+\td_printf(\"%s   %-12s  %-12s  %-12s (%s)\\n\",\n+\t\t procid_str_static(&sessionid.pid),\n \t\t numeric_only ? uid_str : uidtoname(sessionid.uid),\n \t\t numeric_only ? gid_str : gidtoname(sessionid.gid), \n \t\t sessionid.remote_machine, sessionid.hostname);\n\n"}