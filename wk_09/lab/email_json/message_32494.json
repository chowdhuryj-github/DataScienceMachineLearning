{"category": "ham", "to_address": "samba-cvs@samba.org", "from_address": "sfrench@samba.org", "subject": "svn commit: samba r23008 - in branches/SAMBA_3_0_25/source/client: .", "body": "Author: sfrench\nDate: 2007-05-19 02:52:14 +0000 (Sat, 19 May 2007)\nNew Revision: 23008\n\nWebSVN: http://websvn.samba.org/cgi-bin/viewcvs.cgi?view=rev&root=samba&rev=23008\n\nLog:\nMissing frees found by valgrind for mount.cifs\n\nModified:\n   branches/SAMBA_3_0_25/source/client/mount.cifs.c\n\n\nChangeset:\nModified: branches/SAMBA_3_0_25/source/client/mount.cifs.c\n===================================================================\n--- branches/SAMBA_3_0_25/source/client/mount.cifs.c\t2007-05-19 01:27:34 UTC (rev 23007)\n+++ branches/SAMBA_3_0_25/source/client/mount.cifs.c\t2007-05-19 02:52:14 UTC (rev 23008)\n@@ -621,6 +621,7 @@\n nocopy:\n \t\tdata = next_keyword;\n \t}\n+\tfree(*optionsp);\n \t*optionsp = out;\n \treturn 0;\n }\n@@ -882,8 +883,8 @@\n \tchar * ipaddr = NULL;\n \tchar * uuid = NULL;\n \tchar * mountpoint = NULL;\n-\tchar * options;\n-\tchar * resolved_path;\n+\tchar * options = NULL;\n+\tchar * resolved_path = NULL;\n \tchar * temp;\n \tint rc;\n \tint rsize = 0;\n@@ -1079,12 +1080,15 @@\n \t\tget_password_from_file(0, getenv(\"PASSWD_FILE\"));\n \t}\n \n-        if (orgoptions && parse_options(&orgoptions, &flags))\n-                return -1;\n+        if (orgoptions && parse_options(&orgoptions, &flags)) {\n+                rc = -1;\n+\t\tgoto mount_exit;\n+\t}\n \tipaddr = parse_server(&share_name);\n \tif((ipaddr == NULL) && (got_ip == 0)) {\n \t\tprintf(\"No ip address specified and hostname not found\\n\");\n-\t\treturn -1;\n+\t\trc = -1;\n+\t\tgoto mount_exit;\n \t}\n \t\n \t/* BB save off path and pop after mount returns? */\n@@ -1098,17 +1102,20 @@\n \t}\n \tif(chdir(mountpoint)) {\n \t\tprintf(\"mount error: can not change directory into mount target %s\\n\",mountpoint);\n-\t\treturn -1;\n+\t\trc = -1;\n+\t\tgoto mount_exit;\n \t}\n \n \tif(stat (\".\", &statbuf)) {\n \t\tprintf(\"mount error: mount point %s does not exist\\n\",mountpoint);\n-\t\treturn -1;\n+\t\trc = -1;\n+\t\tgoto mount_exit;\n \t}\n \n \tif (S_ISDIR(statbuf.st_mode) == 0) {\n \t\tprintf(\"mount error: mount point %s is not a directory\\n\",mountpoint);\n-\t\treturn -1;\n+\t\trc = -1;\n+\t\tgoto mount_exit;\n \t}\n \n \tif((getuid() != 0) && (geteuid() == 0)) {\n@@ -1154,6 +1161,8 @@\n \t\toptlen += strlen(ipaddr) + 4;\n \tif(mountpassword)\n \t\toptlen += strlen(mountpassword) + 6;\n+\tif(options)\n+\t\tfree(options);\n \toptions = (char *)malloc(optlen + 10 + 64 /* space for commas in password */ + 8 /* space for domain=  , domain name itself was counted as part of the length username string above */);\n \n \tif(options == NULL) {\n@@ -1236,14 +1245,11 @@\n \t\t\t\t}\n \t\t\t}\n \t\tdefault:\n-\t\t\t\n \t\t\tprintf(\"mount error %d = %s\\n\",errno,strerror(errno));\n \t\t}\n \t\tprintf(\"Refer to the mount.cifs(8) manual page (e.g.man mount.cifs)\\n\");\n-\t\tif(mountpassword) {\n-\t\t\tmemset(mountpassword,0,64);\n-\t\t}\n-\t\treturn -1;\n+\t\trc = -1;\n+\t\tgoto mount_exit;\n \t} else {\n \t\tpmntfile = setmntent(MOUNTED, \"a+\");\n \t\tif(pmntfile) {\n@@ -1273,7 +1279,7 @@\n \t\t\t\t\t\tstrcat(mountent.mnt_opts,\",user=\");\n \t\t\t\t\t\tstrcat(mountent.mnt_opts,mount_user);\n \t\t\t\t\t}\n-\t\t\t\t\tfree(mount_user);\n+\t\t\t\t\t/* free(mount_user); do not free static mem */\n \t\t\t\t}\n \t\t\t}\n \t\t\tmountent.mnt_freq = 0;\n@@ -1286,6 +1292,8 @@\n \t\t    printf(\"could not update mount table\\n\");\n \t\t}\n \t}\n+\trc = 0;\n+mount_exit:\n \tif(mountpassword) {\n \t\tint len = strlen(mountpassword);\n \t\tmemset(mountpassword,0,len);\n@@ -1308,6 +1316,6 @@\n \tif(free_share_name) {\n \t\tfree(share_name);\n \t\t}\n-\treturn 0;\n+\treturn rc;\n }\n \n\n"}