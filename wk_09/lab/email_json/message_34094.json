{"category": "ham", "to_address": "samba-cvs@samba.org", "from_address": "abartlet@samba.org", "subject": "svn commit: samba r23063 - in\n\tbranches/SAMBA_4_0/source/auth/credentials: .", "body": "Author: abartlet\nDate: 2007-05-22 05:21:59 +0000 (Tue, 22 May 2007)\nNew Revision: 23063\n\nWebSVN: http://websvn.samba.org/cgi-bin/viewcvs.cgi?view=rev&root=samba&rev=23063\n\nLog:\nMake sure to invalidate the ccache when we set a\nusername/password/realm/etc from the command line.\n\nAlso make sure it can't 'come back' from a later call to\ncli_credentials_guess(), buy setting a threshold.\n\nThis should fix the issues with the build farm...\n\nAndrew Bartlett\n\nModified:\n   branches/SAMBA_4_0/source/auth/credentials/credentials.c\n   branches/SAMBA_4_0/source/auth/credentials/credentials.h\n   branches/SAMBA_4_0/source/auth/credentials/credentials_krb5.c\n\n\nChangeset:\nModified: branches/SAMBA_4_0/source/auth/credentials/credentials.c\n===================================================================\n--- branches/SAMBA_4_0/source/auth/credentials/credentials.c\t2007-05-22 05:16:16 UTC (rev 23062)\n+++ branches/SAMBA_4_0/source/auth/credentials/credentials.c\t2007-05-22 05:21:59 UTC (rev 23063)\n@@ -53,6 +53,9 @@\n \tcred->keytab_obtained = CRED_UNINITIALISED;\n \tcred->principal_obtained = CRED_UNINITIALISED;\n \n+\tcred->ccache_threshold = CRED_UNINITIALISED;\n+\tcred->client_gss_creds_threshold = CRED_UNINITIALISED;\n+\n \tcred->old_password = NULL;\n \tcred->smb_krb5_context = NULL;\n \tcred->salt_principal = NULL;\n@@ -125,6 +128,7 @@\n \t\tcred->username = cred->username_cb(cred);\n \t    \tcred->callback_running = False;\n \t\tcred->username_obtained = CRED_SPECIFIED;\n+\t\tcli_credentials_invalidate_ccache(cred, cred->username_obtained);\n \t}\n \n \treturn cred->username;\n@@ -136,6 +140,7 @@\n \tif (obtained >= cred->username_obtained) {\n \t\tcred->username = talloc_strdup(cred, val);\n \t\tcred->username_obtained = obtained;\n+\t\tcli_credentials_invalidate_ccache(cred, cred->username_obtained);\n \t\treturn True;\n \t}\n \n@@ -191,6 +196,7 @@\n \t\tcred->principal = cred->principal_cb(cred);\n \t    \tcred->callback_running = False;\n \t\tcred->principal_obtained = CRED_SPECIFIED;\n+\t\tcli_credentials_invalidate_ccache(cred, cred->principal_obtained);\n \t}\n \n \tif (cred->principal_obtained < cred->username_obtained) {\n@@ -214,6 +220,7 @@\n \tif (obtained >= cred->principal_obtained) {\n \t\tcred->principal = talloc_strdup(cred, val);\n \t\tcred->principal_obtained = obtained;\n+\t\tcli_credentials_invalidate_ccache(cred, cred->principal_obtained);\n \t\treturn True;\n \t}\n \n@@ -280,6 +287,7 @@\n \t\tcred->password = cred->password_cb(cred);\n \t    \tcred->callback_running = False;\n \t\tcred->password_obtained = CRED_CALLBACK_RESULT;\n+\t\tcli_credentials_invalidate_ccache(cred, cred->password_obtained);\n \t}\n \n \treturn cred->password;\n@@ -295,6 +303,7 @@\n \tif (obtained >= cred->password_obtained) {\n \t\tcred->password = talloc_strdup(cred, val);\n \t\tcred->password_obtained = obtained;\n+\t\tcli_credentials_invalidate_ccache(cred, cred->password_obtained);\n \n \t\tcred->nt_hash = NULL;\n \t\treturn True;\n@@ -309,6 +318,7 @@\n \tif (cred->password_obtained < CRED_CALLBACK) {\n \t\tcred->password_cb = password_cb;\n \t\tcred->password_obtained = CRED_CALLBACK;\n+\t\tcli_credentials_invalidate_ccache(cred, cred->password_obtained);\n \t\treturn True;\n \t}\n \n@@ -401,6 +411,7 @@\n \t\tcred->domain = cred->domain_cb(cred);\n \t    \tcred->callback_running = False;\n \t\tcred->domain_obtained = CRED_SPECIFIED;\n+\t\tcli_credentials_invalidate_ccache(cred, cred->domain_obtained);\n \t}\n \n \treturn cred->domain;\n@@ -417,6 +428,7 @@\n \t\t * calculations */\n \t\tcred->domain = strupper_talloc(cred, val);\n \t\tcred->domain_obtained = obtained;\n+\t\tcli_credentials_invalidate_ccache(cred, cred->domain_obtained);\n \t\treturn True;\n \t}\n \n@@ -453,6 +465,7 @@\n \t\tcred->realm = cred->realm_cb(cred);\n \t    \tcred->callback_running = False;\n \t\tcred->realm_obtained = CRED_SPECIFIED;\n+\t\tcli_credentials_invalidate_ccache(cred, cred->realm_obtained);\n \t}\n \n \treturn cred->realm;\n@@ -469,6 +482,7 @@\n \tif (obtained >= cred->realm_obtained) {\n \t\tcred->realm = strupper_talloc(cred, val);\n \t\tcred->realm_obtained = obtained;\n+\t\tcli_credentials_invalidate_ccache(cred, cred->realm_obtained);\n \t\treturn True;\n \t}\n \n\nModified: branches/SAMBA_4_0/source/auth/credentials/credentials.h\n===================================================================\n--- branches/SAMBA_4_0/source/auth/credentials/credentials.h\t2007-05-22 05:16:16 UTC (rev 23062)\n+++ branches/SAMBA_4_0/source/auth/credentials/credentials.h\t2007-05-22 05:21:59 UTC (rev 23063)\n@@ -61,6 +61,13 @@\n \tenum credentials_obtained keytab_obtained;\n \tenum credentials_obtained server_gss_creds_obtained;\n \n+\t/* Threshold values (essentially a MAX() over a number of the\n+\t * above) for the ccache and GSS credentials, to ensure we\n+\t * regenerate/pick correctly */\n+\n+\tenum credentials_obtained ccache_threshold;\n+\tenum credentials_obtained client_gss_creds_threshold;\n+\n \tconst char *workstation;\n \tconst char *username;\n \tconst char *password;\n\nModified: branches/SAMBA_4_0/source/auth/credentials/credentials_krb5.c\n===================================================================\n--- branches/SAMBA_4_0/source/auth/credentials/credentials_krb5.c\t2007-05-22 05:16:16 UTC (rev 23062)\n+++ branches/SAMBA_4_0/source/auth/credentials/credentials_krb5.c\t2007-05-22 05:21:59 UTC (rev 23063)\n@@ -101,7 +101,9 @@\n \n \tkrb5_free_principal(cred->ccache->smb_krb5_context->krb5_context, princ);\n \n+\t/* set the ccache_obtained here, as it just got set to UNINITIALISED by the calls above */\n \tcred->ccache_obtained = obtained;\n+\tcli_credentials_invalidate_client_gss_creds(cred, cred->ccache_obtained);\n \n \treturn 0;\n }\n@@ -262,9 +264,7 @@\n \t\tcli_credentials_set_machine_account(cred);\n \t}\n \n-\tif (cred->ccache_obtained >=(MAX(MAX(cred->principal_obtained, \n-\t\t\t\t\t     cred->username_obtained), \n-\t\t\t\t\t cred->password_obtained))) {\n+\tif (cred->ccache_obtained >= cred->ccache_threshold) {\n \t\t*ccc = cred->ccache;\n \t\treturn 0;\n \t}\n@@ -289,6 +289,49 @@\n \treturn ret;\n }\n \n+void cli_credentials_invalidate_client_gss_creds(struct cli_credentials *cred, \n+\t\t\t\t\t\t enum credentials_obtained obtained)\n+{\n+\t/* If the caller just changed the username/password etc, then\n+\t * any cached credentials are now invalid */\n+\tif (obtained >= cred->client_gss_creds_obtained) {\n+\t\tif (cred->client_gss_creds_obtained > CRED_UNINITIALISED) {\n+\t\t\ttalloc_free(cred->client_gss_creds);\n+\t\t}\n+\t\tcred->client_gss_creds_obtained = CRED_UNINITIALISED;\n+\t}\n+\t/* Now that we know that the data is 'this specified', then\n+\t * don't allow something less 'known' to be returned as a\n+\t * ccache.  Ie, if the username is on the commmand line, we\n+\t * don't want to later guess to use a file-based ccache */\n+\tif (obtained > cred->client_gss_creds_threshold) {\n+\t\tcred->client_gss_creds_threshold = obtained;\n+\t}\n+}\n+\n+void cli_credentials_invalidate_ccache(struct cli_credentials *cred, \n+\t\t\t\t       enum credentials_obtained obtained)\n+{\n+\t/* If the caller just changed the username/password etc, then\n+\t * any cached credentials are now invalid */\n+\tif (obtained >= cred->ccache_obtained) {\n+\t\tif (cred->ccache_obtained > CRED_UNINITIALISED) {\n+\t\t\ttalloc_free(cred->ccache);\n+\t\t}\n+\t\tcred->ccache_obtained = CRED_UNINITIALISED;\n+\t}\n+\t/* Now that we know that the data is 'this specified', then\n+\t * don't allow something less 'known' to be returned as a\n+\t * ccache.  Ie, if the username is on the commmand line, we\n+\t * don't want to later guess to use a file-based ccache */\n+\tif (obtained > cred->ccache_threshold) {\n+\t\tcred->ccache_threshold  = obtained;\n+\t}\n+\n+\tcli_credentials_invalidate_client_gss_creds(cred, \n+\t\t\t\t\t\t    obtained);\n+}\n+\n static int free_gssapi_creds(struct gssapi_creds_container *gcc)\n {\n \tOM_uint32 min_stat, maj_stat;\n@@ -303,9 +346,7 @@\n \tOM_uint32 maj_stat, min_stat;\n \tstruct gssapi_creds_container *gcc;\n \tstruct ccache_container *ccache;\n-\tif (cred->client_gss_creds_obtained >= (MAX(cred->ccache_obtained, \n-\t\t\t\t\t     MAX(cred->principal_obtained, \n-\t\t\t\t\t\t cred->username_obtained)))) {\n+\tif (cred->client_gss_creds_obtained >= cred->client_gss_creds_threshold) {\n \t\t*_gcc = cred->client_gss_creds;\n \t\treturn 0;\n \t}\n@@ -389,6 +430,8 @@\n \t\tgcc->creds = gssapi_cred;\n \t\ttalloc_set_destructor(gcc, free_gssapi_creds);\n \t\t\n+\t\t/* set the clinet_gss_creds_obtained here, as it just \n+\t\t   got set to UNINITIALISED by the calls above */\n \t\tcred->client_gss_creds_obtained = obtained;\n \t\tcred->client_gss_creds = gcc;\n \t}\n\n"}