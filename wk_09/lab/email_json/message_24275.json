{"category": "ham", "to_address": "samba-cvs@samba.org", "from_address": "jerry@samba.org", "subject": "svn commit: samba r22715 - in branches: SAMBA_3_0/source/nsswitch\n\tSAMBA_3_0_26/source/nsswitch", "body": "Author: jerry\nDate: 2007-05-06 21:10:30 +0000 (Sun, 06 May 2007)\nNew Revision: 22715\n\nWebSVN: http://websvn.samba.org/cgi-bin/viewcvs.cgi?view=rev&root=samba&rev=22715\n\nLog:\nWhen our primary domain does on or offline, make sure to send a msg\nto the idmap child.\n\nAlso remove the check for the global offline state in child_msg_offline()\nas this means we cannot mark domains offline due to network outages.\n\n\nModified:\n   branches/SAMBA_3_0/source/nsswitch/winbindd_cm.c\n   branches/SAMBA_3_0/source/nsswitch/winbindd_dual.c\n   branches/SAMBA_3_0_26/source/nsswitch/winbindd_cm.c\n   branches/SAMBA_3_0_26/source/nsswitch/winbindd_dual.c\n\n\nChangeset:\nModified: branches/SAMBA_3_0/source/nsswitch/winbindd_cm.c\n===================================================================\n--- branches/SAMBA_3_0/source/nsswitch/winbindd_cm.c\t2007-05-06 21:06:55 UTC (rev 22714)\n+++ branches/SAMBA_3_0/source/nsswitch/winbindd_cm.c\t2007-05-06 21:10:30 UTC (rev 22715)\n@@ -246,8 +246,9 @@\n         struct winbindd_domain *domain =\n                 (struct winbindd_domain *)private_data;\n \n-\tDEBUG(10,(\"check_domain_online_handler: called for domain %s\\n\",\n-\t\tdomain->name ));\n+\tDEBUG(10,(\"check_domain_online_handler: called for domain \"\n+\t\t  \"%s (online = %s)\\n\", domain->name, \n+\t\t  domain->online ? \"True\" : \"False\" ));\n \n \tif (domain->check_online_event) {\n \t\tTALLOC_FREE(domain->check_online_event);\n@@ -349,6 +350,23 @@\n \n \tDEBUG(10,(\"set_domain_offline: added event handler for domain %s\\n\",\n \t\tdomain->name ));\n+\n+\t/* Send an offline message to the idmap child when our\n+\t   primary domain goes offline */\n+\n+\tif ( domain->primary ) {\n+\t\tstruct winbindd_child *idmap = idmap_child();\n+\t\t\n+\t\tif ( idmap->pid != 0 ) {\n+\t\t\tmessage_send_pid(pid_to_procid(idmap->pid), \n+\t\t\t\t\t MSG_WINBIND_OFFLINE, \n+\t\t\t\t\t domain->name, \n+\t\t\t\t\t strlen(domain->name)+1, \n+\t\t\t\t\t False);\n+\t\t}\t\t\t\n+\t}\n+\n+\treturn;\t\n }\n \n /****************************************************************\n@@ -409,6 +427,23 @@\n \tmessage_deregister(MSG_WINBIND_FAILED_TO_GO_ONLINE);\n \n \tdomain->online = True;\n+\n+\t/* Send an online message to the idmap child when our\n+\t   primary domain comes online */\n+\n+\tif ( domain->primary ) {\n+\t\tstruct winbindd_child *idmap = idmap_child();\n+\t\t\n+\t\tif ( idmap->pid != 0 ) {\n+\t\t\tmessage_send_pid(pid_to_procid(idmap->pid), \n+\t\t\t\t\t MSG_WINBIND_ONLINE, \n+\t\t\t\t\t domain->name, \n+\t\t\t\t\t strlen(domain->name)+1, \n+\t\t\t\t\t False);\n+\t\t}\t\t\t\n+\t}\n+\n+\treturn;\t\n }\n \n /****************************************************************\n\nModified: branches/SAMBA_3_0/source/nsswitch/winbindd_dual.c\n===================================================================\n--- branches/SAMBA_3_0/source/nsswitch/winbindd_dual.c\t2007-05-06 21:06:55 UTC (rev 22714)\n+++ branches/SAMBA_3_0/source/nsswitch/winbindd_dual.c\t2007-05-06 21:10:30 UTC (rev 22715)\n@@ -504,21 +504,6 @@\n \t\t}\n \t\tDEBUG(5,(\"winbind_msg_offline: marking %s offline.\\n\", domain->name));\n \t\tset_domain_offline(domain);\n-\n-\t\t/* Send an offline message to the idmap child when our\n-\t\t   primary domain goes offline */\n-\n-\t\tif ( domain->primary ) {\n-\t\t\tstruct winbindd_child *idmap = idmap_child();\n-\n-\t\t\tif ( idmap->pid != 0 ) {\n-\t\t\t\tmessage_send_pid(pid_to_procid(idmap->pid), \n-\t\t\t\t\t\t MSG_WINBIND_OFFLINE, \n-\t\t\t\t\t\t domain->name, \n-\t\t\t\t\t\t strlen(domain->name)+1, \n-\t\t\t\t\t\t False);\n-\t\t\t}\t\t\t\n-\t\t}\n \t}\n \n \tfor (child = children; child != NULL; child = child->next) {\n@@ -703,12 +688,6 @@\n \t\treturn;\n \t}\n \n-\t/* Set our global state as offline. */\n-\tif (!set_global_winbindd_state_offline()) {\n-\t\tDEBUG(10,(\"child_msg_offline: offline request failed.\\n\"));\n-\t\treturn;\n-\t}\n-\n \t/* Mark the requested domain offline. */\n \n \tfor (domain = domain_list(); domain; domain = domain->next) {\n\nModified: branches/SAMBA_3_0_26/source/nsswitch/winbindd_cm.c\n===================================================================\n--- branches/SAMBA_3_0_26/source/nsswitch/winbindd_cm.c\t2007-05-06 21:06:55 UTC (rev 22714)\n+++ branches/SAMBA_3_0_26/source/nsswitch/winbindd_cm.c\t2007-05-06 21:10:30 UTC (rev 22715)\n@@ -246,8 +246,9 @@\n         struct winbindd_domain *domain =\n                 (struct winbindd_domain *)private_data;\n \n-\tDEBUG(10,(\"check_domain_online_handler: called for domain %s\\n\",\n-\t\tdomain->name ));\n+\tDEBUG(10,(\"check_domain_online_handler: called for domain \"\n+\t\t  \"%s (online = %s)\\n\", domain->name, \n+\t\t  domain->online ? \"True\" : \"False\" ));\n \n \tif (domain->check_online_event) {\n \t\tTALLOC_FREE(domain->check_online_event);\n@@ -349,6 +350,23 @@\n \n \tDEBUG(10,(\"set_domain_offline: added event handler for domain %s\\n\",\n \t\tdomain->name ));\n+\n+\t/* Send an offline message to the idmap child when our\n+\t   primary domain goes offline */\n+\n+\tif ( domain->primary ) {\n+\t\tstruct winbindd_child *idmap = idmap_child();\n+\t\t\n+\t\tif ( idmap->pid != 0 ) {\n+\t\t\tmessage_send_pid(pid_to_procid(idmap->pid), \n+\t\t\t\t\t MSG_WINBIND_OFFLINE, \n+\t\t\t\t\t domain->name, \n+\t\t\t\t\t strlen(domain->name)+1, \n+\t\t\t\t\t False);\n+\t\t}\t\t\t\n+\t}\n+\n+\treturn;\t\n }\n \n /****************************************************************\n@@ -409,6 +427,23 @@\n \tmessage_deregister(MSG_WINBIND_FAILED_TO_GO_ONLINE);\n \n \tdomain->online = True;\n+\n+\t/* Send an online message to the idmap child when our\n+\t   primary domain comes online */\n+\n+\tif ( domain->primary ) {\n+\t\tstruct winbindd_child *idmap = idmap_child();\n+\t\t\n+\t\tif ( idmap->pid != 0 ) {\n+\t\t\tmessage_send_pid(pid_to_procid(idmap->pid), \n+\t\t\t\t\t MSG_WINBIND_ONLINE, \n+\t\t\t\t\t domain->name, \n+\t\t\t\t\t strlen(domain->name)+1, \n+\t\t\t\t\t False);\n+\t\t}\t\t\t\n+\t}\n+\n+\treturn;\t\n }\n \n /****************************************************************\n\nModified: branches/SAMBA_3_0_26/source/nsswitch/winbindd_dual.c\n===================================================================\n--- branches/SAMBA_3_0_26/source/nsswitch/winbindd_dual.c\t2007-05-06 21:06:55 UTC (rev 22714)\n+++ branches/SAMBA_3_0_26/source/nsswitch/winbindd_dual.c\t2007-05-06 21:10:30 UTC (rev 22715)\n@@ -504,21 +504,6 @@\n \t\t}\n \t\tDEBUG(5,(\"winbind_msg_offline: marking %s offline.\\n\", domain->name));\n \t\tset_domain_offline(domain);\n-\n-\t\t/* Send an offline message to the idmap child when our\n-\t\t   primary domain goes offline */\n-\n-\t\tif ( domain->primary ) {\n-\t\t\tstruct winbindd_child *idmap = idmap_child();\n-\n-\t\t\tif ( idmap->pid != 0 ) {\n-\t\t\t\tmessage_send_pid(pid_to_procid(idmap->pid), \n-\t\t\t\t\t\t MSG_WINBIND_OFFLINE, \n-\t\t\t\t\t\t domain->name, \n-\t\t\t\t\t\t strlen(domain->name)+1, \n-\t\t\t\t\t\t False);\n-\t\t\t}\t\t\t\n-\t\t}\n \t}\n \n \tfor (child = children; child != NULL; child = child->next) {\n@@ -703,12 +688,6 @@\n \t\treturn;\n \t}\n \n-\t/* Set our global state as offline. */\n-\tif (!set_global_winbindd_state_offline()) {\n-\t\tDEBUG(10,(\"child_msg_offline: offline request failed.\\n\"));\n-\t\treturn;\n-\t}\n-\n \t/* Mark the requested domain offline. */\n \n \tfor (domain = domain_list(); domain; domain = domain->next) {\n\n"}