{"category": "ham", "to_address": "samba-cvs@samba.org", "from_address": "jra@samba.org", "subject": "svn commit: samba r22502 - in branches: SAMBA_3_0/source/smbd\n\tSAMBA_3_0_25/source/smbd", "body": "Author: jra\nDate: 2007-04-24 12:56:23 +0000 (Tue, 24 Apr 2007)\nNew Revision: 22502\n\nWebSVN: http://websvn.samba.org/cgi-bin/viewcvs.cgi?view=rev&root=samba&rev=22502\n\nLog:\nFix bug #4536 - delete symlinks to a directory correctly.\nJeremy.\n\nModified:\n   branches/SAMBA_3_0/source/smbd/reply.c\n   branches/SAMBA_3_0_25/source/smbd/reply.c\n\n\nChangeset:\nModified: branches/SAMBA_3_0/source/smbd/reply.c\n===================================================================\n--- branches/SAMBA_3_0/source/smbd/reply.c\t2007-04-24 09:35:55 UTC (rev 22501)\n+++ branches/SAMBA_3_0/source/smbd/reply.c\t2007-04-24 12:56:23 UTC (rev 22502)\n@@ -3867,7 +3867,23 @@\n \tint ret;\n \tSMB_STRUCT_STAT st;\n \n-\tret = SMB_VFS_RMDIR(conn,directory);\n+\t/* Might be a symlink. */\n+\tif(SMB_VFS_LSTAT(conn, directory, &st) != 0) {\n+\t\treturn map_nt_error_from_unix(errno);\n+\t}\n+\n+\tif (S_ISLNK(st.st_mode)) {\n+\t\t/* Is what it points to a directory ? */\n+\t\tif(SMB_VFS_STAT(conn, directory, &st) != 0) {\n+\t\t\treturn map_nt_error_from_unix(errno);\n+\t\t}\n+\t\tif (!(S_ISDIR(st.st_mode))) {\n+\t\t\treturn NT_STATUS_NOT_A_DIRECTORY;\n+\t\t}\n+\t\tret = SMB_VFS_UNLINK(conn,directory);\n+\t} else {\n+\t\tret = SMB_VFS_RMDIR(conn,directory);\n+\t}\n \tif (ret == 0) {\n \t\tnotify_fname(conn, NOTIFY_ACTION_REMOVED,\n \t\t\t     FILE_NOTIFY_CHANGE_DIR_NAME,\n\nModified: branches/SAMBA_3_0_25/source/smbd/reply.c\n===================================================================\n--- branches/SAMBA_3_0_25/source/smbd/reply.c\t2007-04-24 09:35:55 UTC (rev 22501)\n+++ branches/SAMBA_3_0_25/source/smbd/reply.c\t2007-04-24 12:56:23 UTC (rev 22502)\n@@ -3866,7 +3866,23 @@\n \tint ret;\n \tSMB_STRUCT_STAT st;\n \n-\tret = SMB_VFS_RMDIR(conn,directory);\n+\t/* Might be a symlink. */\n+\tif(SMB_VFS_LSTAT(conn, directory, &st) != 0) {\n+\t\treturn map_nt_error_from_unix(errno);\n+\t}\n+\n+\tif (S_ISLNK(st.st_mode)) {\n+\t\t/* Is what it points to a directory ? */\n+\t\tif(SMB_VFS_STAT(conn, directory, &st) != 0) {\n+\t\t\treturn map_nt_error_from_unix(errno);\n+\t\t}\n+\t\tif (!(S_ISDIR(st.st_mode))) {\n+\t\t\treturn NT_STATUS_NOT_A_DIRECTORY;\n+\t\t}\n+\t\tret = SMB_VFS_UNLINK(conn,directory);\n+\t} else {\n+\t\tret = SMB_VFS_RMDIR(conn,directory);\n+\t}\n \tif (ret == 0) {\n \t\tnotify_fname(conn, NOTIFY_ACTION_REMOVED,\n \t\t\t     FILE_NOTIFY_CHANGE_DIR_NAME,\n\n"}