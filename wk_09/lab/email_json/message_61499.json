{"category": "ham", "to_address": "samba-cvs@samba.org", "from_address": "jerry@samba.org", "subject": "svn commit: samba r23689 - in branches/SAMBA_3_0/source: . exports", "body": "Author: jerry\nDate: 2007-07-03 19:55:02 +0000 (Tue, 03 Jul 2007)\nNew Revision: 23689\n\nWebSVN: http://websvn.samba.org/cgi-bin/viewcvs.cgi?view=rev&root=samba&rev=23689\n\nLog:\nSquashed commit of the following:\n\ncommit 0d4bbd197198a94bf4e29e0ccd175a40a60097f3\nAuthor: Gerald (Jerry) Carter \nDate:   Mon Jul 2 20:08:19 2007 -0500\n\n    Introduce GNU ld linker export-script for hiding non-public symbols\n    in shared libraries.\n\n    Based on initial patch from Julien Cristau \n    and suggestions from James Peach .  Currently\n    the libsmbsharemodes libraries still exports *.  Signed off on\n    my Derrell as well.\n\nAdded:\n   branches/SAMBA_3_0/source/exports/\n   branches/SAMBA_3_0/source/exports/libsmbclient.syms\n   branches/SAMBA_3_0/source/exports/libsmbsharemodes.syms\n   branches/SAMBA_3_0/source/library-versions.in\nModified:\n   branches/SAMBA_3_0/source/Makefile.in\n   branches/SAMBA_3_0/source/configure.in\n\n\nChangeset:\nModified: branches/SAMBA_3_0/source/Makefile.in\n===================================================================\n--- branches/SAMBA_3_0/source/Makefile.in\t2007-07-03 18:00:54 UTC (rev 23688)\n+++ branches/SAMBA_3_0/source/Makefile.in\t2007-07-03 19:55:02 UTC (rev 23689)\n@@ -21,6 +21,12 @@\n CC=@CC@\n SHLD=@SHLD@\n \n+## Dynamic shared libraries build settings\n+DSO_EXPORTS_CMD=-Wl,--version-script,exports/`basename $@ | sed 's/@SHLIBEXT@$$/syms/'`\n+DSO_EXPORTS=@DSO_EXPORTS@\n+SONAME_VER=`grep ^$@ $(srcdir)/library-versions | cut -d: -f2`\n+SHLD_DSO = $(SHLD) $(LDSHFLAGS) $(DSO_EXPORTS) \n+\n # Add $(DEVELOPER_CFLAGS) to $(CFLAGS) to enable extra compiler\n # (GCC) warnings. This is done automtically for --enable-developer\n # and --enable-krb5developer.\n@@ -125,20 +131,9 @@\n PIDDIR = @piddir@\n \n LIBSMBCLIENT=bin/libsmbclient.a @LIBSMBCLIENT_SHARED@\n-LIBSMBCLIENT_MAJOR=0\n-LIBSMBCLIENT_MINOR=1\n-\n LIBMSRPC=bin/libmsrpc.a @LIBMSRPC_SHARED@\n-LIBMSRPC_MAJOR=0\n-LIBMSRPC_MINOR=1\n-\n LIBSMBSHAREMODES=bin/libsmbsharemodes.a @LIBSMBSHAREMODES_SHARED@\n-LIBSMBSHAREMODES_MAJOR=0\n-LIBSMBSHAREMODES_MINOR=2\n-\n LIBADDNS=bin/libaddns.a @LIBADDNS_SHARED@\n-LIBADDNS_MAJOR=0\n-LIBADDNS_MINOR=1\n \n FLAGS1 = $(CFLAGS) @FLAGS1@ @SAMBA_CPPFLAGS@ $(CPPFLAGS)\n FLAGS2 =\n@@ -1357,9 +1352,9 @@\n \n bin/libaddns.@SHLIBEXT@: $(BINARY_PREREQS) $(LIBADDNS_OBJ)\n \t@echo Linking libaddns shared library $@\n-\t@$(SHLD) $(LDSHFLAGS) -o $@ $(LIBADDNS_OBJ) $(LDFLAGS) $(LIBS) \\\n+\t@$(SHLD_DSO) -o $@ $(LIBADDNS_OBJ) $(LDFLAGS) $(LIBS) \\\n \t\t$(KRB5LIBS) $(UUID_LIBS)\\\n-\t\t@SONAMEFLAG@`basename $@`.$(LIBADDNS_MAJOR)\n+\t\t@SONAMEFLAG@`basename $@`.$(SONAME_VER)\n \n bin/libaddns.a: $(BINARY_PREREQS) $(LIBADDNS_OBJ)\n \t@echo Linking libaddns non-shared library $@\n@@ -1367,9 +1362,9 @@\n \n bin/libsmbclient.@SHLIBEXT@: $(BINARY_PREREQS) $(LIBSMBCLIENT_OBJ)\n \t@echo Linking libsmbclient shared library $@\n-\t@$(SHLD) $(LDSHFLAGS) -o $@ $(LIBSMBCLIENT_OBJ) $(LDFLAGS) $(LIBS) \\\n+\t@$(SHLD_DSO) -o $@ $(LIBSMBCLIENT_OBJ) $(LDFLAGS) $(LIBS) \\\n \t\t$(KRB5LIBS) $(LDAP_LIBS) $(NSCD_LIBS) \\\n-\t\t@SONAMEFLAG@`basename $@`.$(LIBSMBCLIENT_MAJOR)\n+\t\t@SONAMEFLAG@`basename $@`.$(SONAME_VER)\n \n bin/libsmbclient.a: $(BINARY_PREREQS) $(LIBSMBCLIENT_OBJ)\n \t@echo Linking libsmbclient non-shared library $@\n@@ -1377,9 +1372,9 @@\n \n bin/libsmbsharemodes.@SHLIBEXT@: $(BINARY_PREREQS) $(LIBSMBSHAREMODES_OBJ)\n \t@echo Linking libsmbsharemodes shared library $@\n-\t@$(SHLD) $(LDSHFLAGS) -o $@ $(LIBSMBSHAREMODES_OBJ) $(LDFLAGS) $(LIBS) \\\n+\t@$(SHLD_DSO) -o $@ $(LIBSMBSHAREMODES_OBJ) $(LDFLAGS) $(LIBS) \\\n \t\t$(KRB5LIBS) $(LDAP_LIBS) \\\n-\t\t@SONAMEFLAG@`basename $@`.$(LIBSMBSHAREMODES_MAJOR)\n+\t\t@SONAMEFLAG@`basename $@`.$(SONAME_VER)\n \n bin/libsmbsharemodes.a: $(BINARY_PREREQS) $(LIBSMBSHAREMODES_OBJ)\n \t@echo Linking libsmbsharemodes non-shared library $@\n@@ -1387,8 +1382,8 @@\n \n bin/libmsrpc.@SHLIBEXT@: $(BINARY_PREREQS) $(CAC_OBJ)\n \t@echo Linking libmsrpc shared library $@\n-\t@$(SHLD) $(LDSHFLAGS) -o $@ $(CAC_OBJ) $(LDFLAGS) $(LIBS) \\\n-\t@SONAMEFLAG@`basename $@`.$(LIBMSRPC_MAJOR)\n+\t@$(SHLD_DSO) -o $@ $(CAC_OBJ) $(LDFLAGS) $(LIBS) \\\n+\t\t@SONAMEFLAG@`basename $@`.$(SONAME_VER)\n \n bin/libmsrpc.a: $(BINARY_PREREQS) $(CAC_OBJ)\n \t@echo Linking libmsrpc non-shared library $@\n\nModified: branches/SAMBA_3_0/source/configure.in\n===================================================================\n--- branches/SAMBA_3_0/source/configure.in\t2007-07-03 18:00:54 UTC (rev 23688)\n+++ branches/SAMBA_3_0/source/configure.in\t2007-07-03 19:55:02 UTC (rev 23689)\n@@ -283,6 +283,7 @@\n AC_SUBST(MODULE_EXPORTS)\n AC_SUBST(SONAMEFLAG)\n AC_SUBST(SHLD)\n+AC_SUBST(DSO_EXPORTS)\n AC_SUBST(HOST_OS)\n AC_SUBST(PICFLAG)\n AC_SUBST(PIE_CFLAGS)\n@@ -545,6 +546,9 @@\n  \tif test \"$ac_cv_gnu_ld_date\" -lt 20030217; then\n  \t\tac_cv_gnu_ld_no_default_allow_shlib_undefined=yes\n  \tfi\n+\tif test \"$ac_cv_gnu_ld_date\" -gt 20030101; then\n+\t\tac_cv_gnu_ld_version_script=yes\n+\tfi\n         else\n            AC_MSG_CHECKING(GNU ld release version)\n            changequote(,)dnl\n@@ -560,6 +564,9 @@\n            if test \"$ac_cv_gnu_ld_vernr_major\" -lt 2 || test \"$ac_cv_gnu_ld_vernr_minor\" -lt 14; then\n              ac_cv_gnu_ld_no_default_allow_shlib_undefined=yes\n            fi\n+           if test \"$ac_cv_gnu_ld_vernr_major\" -gt 2 || test \"$ac_cv_gnu_l= d_vernr_major\"=2 && test \"$ac_cv_gnu_ld_vernr_minor\" -ge 12; then\n+             ac_cv_gnu_ld_version_script=yes\n+           fi\n         fi\n fi\n \n@@ -1839,8 +1846,8 @@\n SHLD=\"\\${CC} \\${CFLAGS}\"\n PICFLAG=\"${PIE_CFLAGS}\"\n SHLIBEXT=\"so\"\n+DSO_EXPORTS=\"\"\n \n-\n # this bit needs to be modified for each OS that supports share libs\n # You need to specify how to create a shared library and\n # how to compile C code to produce PIC object files\n@@ -2037,6 +2044,10 @@\n \tBLDSHARED=false\n fi\n \n+if test \"$enable_shared\" = yes -a \"${ac_cv_gnu_ld_version_script}\" = yes; then\n+\tDSO_EXPORTS=\\$\\(DSO_EXPORTS_CMD\\)\n+fi\n+\n AC_MSG_RESULT($BLDSHARED)\n \n AC_MSG_CHECKING([LDFLAGS])\n@@ -6469,7 +6480,7 @@\n SMBD_LIBS=\"$samba_dmapi_libs\"\n AC_SUBST(SMBD_LIBS)\n \n-AC_OUTPUT(Makefile script/findsmb smbadduser script/gen-8bit-gap.sh script/installbin.sh script/uninstallbin.sh)\n+AC_OUTPUT(Makefile library-versions script/findsmb smbadduser script/gen-8bit-gap.sh script/installbin.sh script/uninstallbin.sh)\n \n #################################################\n # Print very concise instructions on building/use\n\nAdded: branches/SAMBA_3_0/source/exports/libsmbclient.syms\n===================================================================\n--- branches/SAMBA_3_0/source/exports/libsmbclient.syms\t2007-07-03 18:00:54 UTC (rev 23688)\n+++ branches/SAMBA_3_0/source/exports/libsmbclient.syms\t2007-07-03 19:55:02 UTC (rev 23689)\n@@ -0,0 +1,4 @@\n+{\n+\tglobal: smbc_*;\n+\tlocal: *;\n+};\n\nAdded: branches/SAMBA_3_0/source/exports/libsmbsharemodes.syms\n===================================================================\n--- branches/SAMBA_3_0/source/exports/libsmbsharemodes.syms\t2007-07-03 18:00:54 UTC (rev 23688)\n+++ branches/SAMBA_3_0/source/exports/libsmbsharemodes.syms\t2007-07-03 19:55:02 UTC (rev 23689)\n@@ -0,0 +1,3 @@\n+{\n+\tglobal: *;\n+};\n\nAdded: branches/SAMBA_3_0/source/library-versions.in\n===================================================================\n--- branches/SAMBA_3_0/source/library-versions.in\t2007-07-03 18:00:54 UTC (rev 23688)\n+++ branches/SAMBA_3_0/source/library-versions.in\t2007-07-03 19:55:02 UTC (rev 23689)\n@@ -0,0 +1,9 @@\n+##\n+## Basic script for defining the major and minor librrary revision numbers\n+## Makefile_target:major:minor\n+##\n+bin/libsmbclient.@SHLIBEXT@:0:1\n+bin/libsmbsharemodes.@SHLIBEXT@:0:2\n+bin/libaddns.@SHLIBEXT@:0:1\n+bin/libmsrpc.@SHLIBEXT@:0:1\n+\n\n"}