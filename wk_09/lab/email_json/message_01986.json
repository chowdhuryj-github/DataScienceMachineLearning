{"category": "ham", "to_address": "samba-cvs@samba.org", "from_address": "Michael Adam <ma@sernet.de>", "subject": "Rev 5347: merge from upstream in\n\thttp://samba.sernet.de/ma/bzr/SAMBA_3_0-registry.bzr/", "body": "At http://samba.sernet.de/ma/bzr/SAMBA_3_0-registry.bzr/\n\n------------------------------------------------------------\nrevno: 5347\nrevision-id: ma@sernet.de-20070410212018-6a54e7de1e2cc21b\nparent: ma@sernet.de-20070410211754-0c10dea4fd75e2ed\nparent: metze@samba.org-20070410170757-9ky0kr0jt9elqesd\ncommitter: Michael Adam \nbranch nick: SAMBA_3_0-registry.bzr\ntimestamp: Tue 2007-04-10 23:20:18 +0200\nmessage:\n  merge from upstream\nmodified:\n  REVISION                       REVISION-20060530022625-68239662668b41c3\n  source/lib/replace/README      readme-20060919015053-50coyc2ouwpsm77j-17\n  source/lib/replace/libreplace.m4 libreplace.m4-20060919015053-50coyc2ouwpsm77j-4\n  source/lib/replace/replace.c   replace.c-20060919015053-50coyc2ouwpsm77j-15\n  source/lib/replace/test/testsuite.c testsuite.c-20060919015053-50coyc2ouwpsm77j-33\n  source/libads/sasl.c           sasl.c-20060530022627-de2e2050d01ecfd2\n  source/modules/vfs_gpfs.c      vfs_gpfs.c-20061109202948-faf4b3d9745o8b1q-1\n  source/modules/vfs_readahead.c vfs_readahead.c-20070406230344-ao2vumno0dhc4q95-1\n  source/smbd/quotas.c           quotas.c-20060530022627-f2ef4e7853114181\n    ------------------------------------------------------------\n    merged: metze@samba.org-20070410170757-9ky0kr0jt9elqesd\n    parent: metze@samba.org-20070410170627-m3486aijwj6n9ixx\n    committer: metze@samba.org\n    branch nick: SAMBA_3_0.bzr\n    timestamp: Tue 2007-04-10 12:07:57 -0500\n    message:\n      metze@samba.org (r22153)  2007-04-10 11:04:22 -0500 (Tue, 10 Apr 2007)\n          \n          fix LDAP SASL \"GSSAPI\" bind against w2k3, this isn't critical\n          because we try \"GSS-SPNEGO\" first and all windows version support\n          that.\n          \n          metze\n    ------------------------------------------------------------\n    merged: metze@samba.org-20070410170627-m3486aijwj6n9ixx\n    parent: jerry@samba.org-20070410170455-qhsx1booie3brdea\n    committer: metze@samba.org\n    branch nick: SAMBA_3_0.bzr\n    timestamp: Tue 2007-04-10 12:06:27 -0500\n    message:\n      metze@samba.org (r22151)  2007-04-10 10:59:39 -0500 (Tue, 10 Apr 2007)\n          \n          remove netgr functions from libreplace they're not used\n          in samba4 currently and samba3 has explicit configure checks for them.\n          \n          should fix bug #4496\n          \n          metze\n    ------------------------------------------------------------\n    merged: jerry@samba.org-20070410170455-qhsx1booie3brdea\n    parent: jmcd@samba.org-20070410170304-2c1125l8y5z3kdu1\n    committer: jerry@samba.org\n    branch nick: SAMBA_3_0.bzr\n    timestamp: Tue 2007-04-10 12:04:55 -0500\n    message:\n      jerry@samba.org (r22149)  2007-04-10 10:41:23 -0500 (Tue, 10 Apr 2007)\n          \n          BUG 4500: patch from Jorge Santos \n          to fix compile bug ni quotas.c (typo calling unbecome_root()).\n          \n          \n    ------------------------------------------------------------\n    merged: jmcd@samba.org-20070410170304-2c1125l8y5z3kdu1\n    parent: vlendec@samba.org-20070410110346-goj0dbrd1o0d47nu\n    committer: jmcd@samba.org\n    branch nick: SAMBA_3_0.bzr\n    timestamp: Tue 2007-04-10 12:03:04 -0500\n    message:\n      jmcd@samba.org (r22148)  2007-04-10 10:41:22 -0500 (Tue, 10 Apr 2007)\n          \n          Fix gpfs module on posix-acl test.  Adds gpfsacl_sys_set_fd (calls\n          _file).  Thanks to Gomati Mohanan.\n          \n    ------------------------------------------------------------\n    merged: vlendec@samba.org-20070410110346-goj0dbrd1o0d47nu\n    parent: vlendec@samba.org-20070410110204-ckd3gjrvaaikm9c0\n    committer: vlendec@samba.org\n    branch nick: SAMBA_3_0.bzr\n    timestamp: Tue 2007-04-10 06:03:46 -0500\n    message:\n      vlendec@samba.org (r22147)  2007-04-10 02:36:58 -0500 (Tue, 10 Apr 2007)\n          \n          Next try\n    ------------------------------------------------------------\n    merged: vlendec@samba.org-20070410110204-ckd3gjrvaaikm9c0\n    parent: jra@samba.org-20070409230201-buciygamf58wvp0j\n    committer: vlendec@samba.org\n    branch nick: SAMBA_3_0.bzr\n    timestamp: Tue 2007-04-10 06:02:04 -0500\n    message:\n      vlendec@samba.org (r22146)  2007-04-10 02:33:14 -0500 (Tue, 10 Apr 2007)\n          \n          Attempt to fix the build\n=== modified file 'REVISION'\n--- a/REVISION\t2007-04-09 23:02:01 +0000\n+++ b/REVISION\t2007-04-10 17:07:57 +0000\n@@ -2,9 +2,9 @@\n URL: svn+ssh://svn.samba.org/home/svn/samba/branches/SAMBA_3_0\n Repository Root: svn+ssh://svn.samba.org/home/svn/samba\n Repository UUID: 0c0555d6-39d7-0310-84fc-f1cc0bd64818\n-Revision: 22145\n+Revision: 22153\n Node Kind: directory\n-Last Changed Author: jra\n-Last Changed Rev: 22145\n-Last Changed Date: 2007-04-09 16:01:46 -0500 (Mon, 09 Apr 2007)\n+Last Changed Author: metze\n+Last Changed Rev: 22153\n+Last Changed Date: 2007-04-10 11:04:22 -0500 (Tue, 10 Apr 2007)\n \n\n=== modified file 'source/lib/replace/README'\n--- a/source/lib/replace/README\t2007-02-16 21:19:52 +0000\n+++ b/source/lib/replace/README\t2007-04-10 17:06:27 +0000\n@@ -12,7 +12,6 @@\n strlcat\n mktime\n rename\n-innetgr\n initgroups\n memmove\n strdup\n@@ -88,5 +87,4 @@\n Prerequisites:\n memset (for bzero)\n syslog (for vsyslog)\n-setnetgrent, getnetgrent, endnetgrent (for innetgr)\n mktemp (for mkstemp and mkdtemp)\n\n=== modified file 'source/lib/replace/libreplace.m4'\n--- a/source/lib/replace/libreplace.m4\t2007-02-16 21:19:52 +0000\n+++ b/source/lib/replace/libreplace.m4\t2007-04-10 17:06:27 +0000\n@@ -150,7 +150,7 @@\n \n AC_CHECK_FUNCS(seteuid setresuid setegid setresgid chroot bzero strerror)\n AC_CHECK_FUNCS(vsyslog setlinebuf mktime ftruncate chsize rename)\n-AC_CHECK_FUNCS(waitpid strlcpy strlcat innetgr initgroups memmove strdup)\n+AC_CHECK_FUNCS(waitpid strlcpy strlcat initgroups memmove strdup)\n AC_CHECK_FUNCS(pread pwrite strndup strcasestr strtok_r mkdtemp socketpair)\n AC_HAVE_DECL(setresuid, [#include ])\n AC_HAVE_DECL(setresgid, [#include ])\n@@ -330,8 +330,7 @@\n m4_include(timegm.m4)\n m4_include(repdir.m4)\n \n-AC_CHECK_FUNCS([syslog memset setnetgrent getnetgrent endnetgrent memcpy],,\n-\t\t\t   [AC_MSG_ERROR([Required function not found])])\n+AC_CHECK_FUNCS([syslog memset memcpy],,[AC_MSG_ERROR([Required function not found])])\n \n echo \"LIBREPLACE_BROKEN_CHECKS: END\"\n ]) dnl end AC_LIBREPLACE_BROKEN_CHECKS\n\n=== modified file 'source/lib/replace/replace.c'\n--- a/source/lib/replace/replace.c\t2007-01-16 14:03:41 +0000\n+++ b/source/lib/replace/replace.c\t2007-04-10 17:06:27 +0000\n@@ -154,33 +154,6 @@\n #endif /* !HAVE_MKTIME */\n \n \n-#ifndef HAVE_INNETGR\n-#if defined(HAVE_SETNETGRENT) && defined(HAVE_GETNETGRENT) && defined(HAVE_ENDNETGRENT)\n-/*\n- * Search for a match in a netgroup. This replaces it on broken systems.\n- */\n-int rep_innetgr(const char *group, const char *host, const char *user, \n-\t\t\t\tconst char *dom)\n-{\n-\tchar *hst, *usr, *dm;\n-  \n-\tsetnetgrent(group);\n-\twhile (getnetgrent(&hst, &usr, &dm)) {\n-\t\tif (((host == 0) || (hst == 0) || !strcmp(host, hst)) &&\n-\t\t    ((user == 0) || (usr == 0) || !strcmp(user, usr)) &&\n-\t\t    ((dom == 0) || (dm == 0) || !strcmp(dom, dm))) {\n-\t\t\tendnetgrent();\n-\t\t\treturn (1);\n-\t\t}\n-\t}\n-\tendnetgrent();\n-\treturn (0);\n-}\n-#endif /* HAVE_SETNETGRENT HAVE_GETNETGRENT HAVE_ENDNETGRENT */\n-#endif /* HAVE_INNETGR */\n-\n-\n-\n #ifndef HAVE_INITGROUPS\n /****************************************************************************\n  some systems don't have an initgroups call \n\n=== modified file 'source/lib/replace/test/testsuite.c'\n--- a/source/lib/replace/test/testsuite.c\t2007-01-16 14:05:09 +0000\n+++ b/source/lib/replace/test/testsuite.c\t2007-04-10 17:06:27 +0000\n@@ -125,12 +125,6 @@\n \treturn true;\n }\n \n-static int test_innetgr(void)\n-{\n-\t/* FIXME */\n-\treturn true;\n-}\n-\n static int test_initgroups(void)\n {\n \t/* FIXME */\n@@ -426,7 +420,6 @@\n \tret &= test_strlcpy();\n \tret &= test_strlcat();\n \tret &= test_mktime();\n-\tret &= test_innetgr();\n \tret &= test_initgroups();\n \tret &= test_memmove();\n \tret &= test_strdup();\n\n=== modified file 'source/libads/sasl.c'\n--- a/source/libads/sasl.c\t2007-04-05 17:01:51 +0000\n+++ b/source/libads/sasl.c\t2007-04-10 17:07:57 +0000\n@@ -441,7 +441,8 @@\n \n \tgss_release_buffer(&minor_status, &output_token);\n \n-\toutput_token.value = SMB_MALLOC(strlen(ads->config.bind_path) + 8);\n+\toutput_token.length = 4;\n+\toutput_token.value = SMB_MALLOC(output_token.length);\n \tp = (uint8 *)output_token.value;\n \n \t*p++ = 1; /* no sign & seal selection */\n@@ -449,10 +450,14 @@\n \t*p++ = max_msg_size>>16;\n \t*p++ = max_msg_size>>8;\n \t*p++ = max_msg_size;\n-\tsnprintf((char *)p, strlen(ads->config.bind_path)+4, \"dn:%s\", ads->config.bind_path);\n-\tp += strlen((const char *)p);\n-\n-\toutput_token.length = PTR_DIFF(p, output_token.value);\n+\t/*\n+\t * we used to add sprintf(\"dn:%s\", ads->config.bind_path) here.\n+\t * but using ads->config.bind_path is the wrong! It should be\n+\t * the DN of the user object!\n+\t *\n+\t * w2k3 gives an error when we send an incorrect DN, but sending nothing\n+\t * is ok and matches the information flow used in GSS-SPNEGO.\n+\t */\n \n \tgss_rc = gss_wrap(&minor_status, context_handle,0,GSS_C_QOP_DEFAULT,\n \t\t\t  &output_token, (int *)&conf_state,\n\n=== modified file 'source/modules/vfs_gpfs.c'\n--- a/source/modules/vfs_gpfs.c\t2007-02-14 12:58:00 +0000\n+++ b/source/modules/vfs_gpfs.c\t2007-04-10 17:03:04 +0000\n@@ -597,8 +597,7 @@\n \t\t\t    files_struct *fsp,\n \t\t\t    int fd, SMB_ACL_T theacl)\n {\n-\terrno = ENOTSUP;\n-\treturn -1;\n+\treturn gpfsacl_sys_acl_set_file(handle, fsp->fsp_name, SMB_ACL_TYPE_ACCESS, theacl);\n }\n \n int gpfsacl_sys_acl_delete_def_file(vfs_handle_struct *handle,\n\n=== modified file 'source/modules/vfs_readahead.c'\n--- a/source/modules/vfs_readahead.c\t2007-04-08 23:01:58 +0000\n+++ b/source/modules/vfs_readahead.c\t2007-04-10 11:03:46 +0000\n@@ -101,12 +101,12 @@\n \t\t\t(unsigned int)rhd->len,\n \t\t\terr ));\n #elif defined(HAVE_POSIX_FADVISE)\n-\t\tint err = posix_fadvise(fromfd, offset, (off_t)rhd->len, POSIX_FADV_WILLNEED);\n+\t\tint err = posix_fadvise(fd, offset, (off_t)rhd->len, POSIX_FADV_WILLNEED);\n \t\tDEBUG(10,(\"readahead_pread: posix_fadvise on fd %u, offset %llu, len %u returned %d\\n\",\n \t\t\t(unsigned int)fd,\n \t\t\t(unsigned long long)offset,\n \t\t\t(unsigned int)rhd->len,\n-\t\t\t(err ));\n+\t\t\terr ));\n #else\n \t\tif (!rhd->didmsg) {\n \t\t\tDEBUG(0,(\"readahead_pread: no readahead on this platform\\n\"));\n\n=== modified file 'source/smbd/quotas.c'\n--- a/source/smbd/quotas.c\t2007-04-06 05:01:25 +0000\n+++ b/source/smbd/quotas.c\t2007-04-10 17:04:55 +0000\n@@ -662,7 +662,7 @@\n \t\tBOOL retval;\n \t\tDEBUG(5,(\"disk_quotas: looking for mountpath (NFS) \\\"%s\\\"\\n\", mnt.mnt_special));\n \t\tretval = nfs_quotas(mnt.mnt_special, euser_id, bsize, dfree, dsize);\n-\t\tunbecome();\n+\t\tunbecome_root();\n \t\treturn retval;\n \t}\n \n\n"}