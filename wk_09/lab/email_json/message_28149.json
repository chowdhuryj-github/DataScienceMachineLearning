{"category": "ham", "to_address": "samba-cvs@samba.org", "from_address": "tridge@samba.org", "subject": "Rev 292: prioritise the dmaster in case of matching rsn in\n\thttp://samba.org/~tridge/ctdb", "body": "------------------------------------------------------------\nrevno: 292\nrevision-id: tridge@samba.org-20070512095712-rzuuw3raga2t2cyd\nparent: tridge@samba.org-20070512095631-mqryf40232ncs0k6\ncommitter: Andrew Tridgell \nbranch nick: tridge\ntimestamp: Sat 2007-05-12 19:57:12 +1000\nmessage:\n  prioritise the dmaster in case of matching rsn\nmodified:\n  common/ctdb_recover.c          ctdb_recover.c-20070503002147-admmfgt1oj6gexfo-1\n=== modified file 'common/ctdb_recover.c'\n--- a/common/ctdb_recover.c\t2007-05-12 08:08:50 +0000\n+++ b/common/ctdb_recover.c\t2007-05-12 09:57:12 +0000\n@@ -225,6 +225,7 @@\n \n \tparams.ctdb = ctdb;\n \tparams.lmaster = pull->lmaster;\n+\n \tparams.rec_count = 0;\n \tparams.recs = talloc_array(outdata, struct getkeys_rec, 0);\n \tCTDB_NO_MEMORY(ctdb, params.recs);\n@@ -318,9 +319,10 @@\n \t\t\tDEBUG(0, (__location__ \" Unable to fetch record\\n\"));\n \t\t\tgoto failed;\n \t\t}\n-\t\t/* the <= is to cope with just-created records, which\n-\t\t   have a rsn of zero */\n-\t\tif (header.rsn <= hdr->rsn) {\n+\t\t/* The check for dmaster gives priority to the dmaster\n+\t\t   if the rsn values are equal */\n+\t\tif (header.rsn < hdr->rsn ||\n+\t\t    (header.dmaster != ctdb->vnn && header.rsn == hdr->rsn)) {\n \t\t\tret = ctdb_ltdb_store(ctdb_db, key, hdr, data);\n \t\t\tif (ret != 0) {\n \t\t\t\tDEBUG(0, (__location__ \" Unable to store record\\n\"));\n\n"}