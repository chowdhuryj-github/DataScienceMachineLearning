{"category": "ham", "to_address": "samba-cvs@samba.org", "from_address": "tridge@samba.org", "subject": "Rev 288: simplify the generation checking on incoming call packets\n\tin http://samba.org/~tridge/ctdb", "body": "------------------------------------------------------------\nrevno: 288\nrevision-id: tridge@samba.org-20070512095440-atc4dhk3kbgv6cxu\nparent: tridge@samba.org-20070512080850-g6h43oqsh8ngm5np\ncommitter: Andrew Tridgell \nbranch nick: tridge\ntimestamp: Sat 2007-05-12 19:54:40 +1000\nmessage:\n  simplify the generation checking on incoming call packets\nmodified:\n  common/ctdb.c                  ctdb.c-20061127094323-t50f58d65iaao5of-2\n=== modified file 'common/ctdb.c'\n--- a/common/ctdb.c\t2007-05-09 22:13:19 +0000\n+++ b/common/ctdb.c\t2007-05-12 09:54:40 +0000\n@@ -261,8 +261,12 @@\n \n \tswitch (hdr->operation) {\n \tcase CTDB_REQ_CALL:\n-\t\t/* verify that the remote node that sent us the call\n-\t\t   is running in the same generation instance as this node\n+\tcase CTDB_REPLY_CALL:\n+\tcase CTDB_REQ_DMASTER:\n+\tcase CTDB_REPLY_DMASTER:\n+\t\t/* for ctdb_call inter-node operations verify that the\n+\t\t   remote node that sent us the call is running in the\n+\t\t   same generation instance as this node\n \t\t*/\n \t\tif (ctdb->vnn_map->generation != hdr->generation) {\n \t\t\tDEBUG(0,(__location__ \" ctdb request %d\"\n@@ -273,20 +277,12 @@\n \t\t\t\thdr->srcnode, hdr->destnode, \n \t\t\t\tctdb->vnn_map->generation, \n \t\t\t\thdr->generation));\n-\t\t\tbreak;\n-\t\t}\n-\t\t/* if we are in recovery mode we discard all traffic\n-\t\t   until the cluster has recovered.\n-\t\t*/\n-\t\tif (ctdb->recovery_mode != CTDB_RECOVERY_NORMAL) {\n-\t\t\tDEBUG(0,(__location__ \" ctdb request %d\"\n-\t\t\t\t\" length %d from node %d to %d\"\n-\t\t\t\t\" while we are in recovery mode\\n\", \n-\t\t\t\thdr->reqid, hdr->length, \n-\t\t\t\t hdr->srcnode, hdr->destnode));\n-\t\t\tbreak;\n-\t\t}\n+\t\t\tgoto done;\n+\t\t}\n+\t}\n \n+\tswitch (hdr->operation) {\n+\tcase CTDB_REQ_CALL:\n \t\tctdb->status.node.req_call++;\n \t\tctdb_request_call(ctdb, hdr);\n \t\tbreak;\n@@ -302,63 +298,11 @@\n \t\tbreak;\n \n \tcase CTDB_REQ_DMASTER:\n-\t\t/* verify that the remote node that sent us dmaster req\n-\t\t   is running in the same generation instance as this node\n-\t\t*/\n-\t\tif (ctdb->vnn_map->generation != hdr->generation) {\n-\t\t\tDEBUG(0,(__location__ \" ctdb dmaster request %d\"\n-\t\t\t\t\" length %d from node %d to %d had an\"\n-\t\t\t\t\" invalid generation id:%d while our\"\n-\t\t\t\t\" generation id is:%d\\n\", \n-\t\t\t\thdr->reqid, hdr->length, \n-\t\t\t\thdr->srcnode, hdr->destnode, \n-\t\t\t\tctdb->vnn_map->generation, \n-\t\t\t\thdr->generation));\n-\t\t\tbreak;\n-\t\t}\n-\t\t/* if we are in recovery mode we discard all traffic\n-\t\t   until the cluster has recovered.\n-\t\t*/\n-\t\tif (ctdb->recovery_mode != CTDB_RECOVERY_NORMAL) {\n-\t\t\tDEBUG(0,(__location__ \" ctdb dmaster request %d\"\n-\t\t\t\t\" length %d from node %d to %d\"\n-\t\t\t\t\" while we are in recovery mode\\n\", \n-\t\t\t\thdr->reqid, hdr->length, \n-\t\t\t\t hdr->srcnode, hdr->destnode));\n-\t\t\tbreak;\n-\t\t}\n-\n \t\tctdb->status.node.req_dmaster++;\n \t\tctdb_request_dmaster(ctdb, hdr);\n \t\tbreak;\n \n \tcase CTDB_REPLY_DMASTER:\n-\t\t/* verify that the remote node that sent us dmaster reply\n-\t\t   is running in the same generation instance as this node\n-\t\t*/\n-\t\tif (ctdb->vnn_map->generation != hdr->generation) {\n-\t\t\tDEBUG(0,(__location__ \" ctdb dmaster reply %d\"\n-\t\t\t\t\" length %d from node %d to %d had an\"\n-\t\t\t\t\" invalid generation id:%d while our\"\n-\t\t\t\t\" generation id is:%d\\n\", \n-\t\t\t\thdr->reqid, hdr->length, \n-\t\t\t\thdr->srcnode, hdr->destnode, \n-\t\t\t\tctdb->vnn_map->generation, \n-\t\t\t\thdr->generation));\n-\t\t\tbreak;\n-\t\t}\n-\t\t/* if we are in recovery mode we discard all traffic\n-\t\t   until the cluster has recovered.\n-\t\t*/\n-\t\tif (ctdb->recovery_mode != CTDB_RECOVERY_NORMAL) {\n-\t\t\tDEBUG(0,(__location__ \" ctdb dmaster reply %d \"\n-\t\t\t\t\" length %d from node %d to %d\"\n-\t\t\t\t\" while we are in recovery mode\\n\", \n-\t\t\t\thdr->reqid, hdr->length, \n-\t\t\t\t hdr->srcnode, hdr->destnode));\n-\t\t\tbreak;\n-\t\t}\n-\n \t\tctdb->status.node.reply_dmaster++;\n \t\tctdb_reply_dmaster(ctdb, hdr);\n \t\tbreak;\n\n"}