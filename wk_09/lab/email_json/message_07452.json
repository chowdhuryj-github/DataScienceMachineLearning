{"category": "ham", "to_address": "samba-cvs@samba.org", "from_address": "tridge@samba.org", "subject": "Rev 129: block SIGPIPE in the daemon to prevent a SIGPIPE on write\n\tto a dead socket in http://samba.org/~tridge/ctdb", "body": "------------------------------------------------------------\nrevno: 129\nrevision-id: tridge@samba.org-20070417053320-24de1716550f0cd1\nparent: tridge@samba.org-20070417053249-780b8b0319475cef\ncommitter: Andrew Tridgell \nbranch nick: tridge\ntimestamp: Tue 2007-04-17 15:33:20 +1000\nmessage:\n  block SIGPIPE in the daemon to prevent a SIGPIPE on write to a dead socket\nmodified:\n  common/ctdb_daemon.c           ctdb_daemon.c-20070409200331-3el1kqgdb9m4ib0g-1\n=== modified file 'common/ctdb_daemon.c'\n--- a/common/ctdb_daemon.c\t2007-04-17 04:52:51 +0000\n+++ b/common/ctdb_daemon.c\t2007-04-17 05:33:20 +0000\n@@ -25,6 +25,7 @@\n #include \"lib/util/dlinklist.h\"\n #include \"system/network.h\"\n #include \"system/filesys.h\"\n+#include \"system/wait.h\"\n #include \"../include/ctdb.h\"\n #include \"../include/ctdb_private.h\"\n \n@@ -47,6 +48,18 @@\n         fcntl(fd, F_SETFL, v | O_NONBLOCK);\n }\n \n+static void block_signal(int signum)\n+{\n+\tstruct sigaction act;\n+\n+\tmemset(&act, 0, sizeof(act));\n+\n+\tact.sa_handler = SIG_IGN;\n+\tsigemptyset(&act.sa_mask);\n+\tsigaddset(&act.sa_mask, signum);\n+\tsigaction(signum, &act, NULL);\n+}\n+\n \n /*\n   structure describing a connected client in the daemon\n@@ -558,6 +571,8 @@\n \t\treturn 0;\n \t}\n \n+\tblock_signal(SIGPIPE);\n+\n \t/* ensure the socket is deleted on exit of the daemon */\n \tdomain_socket_name = talloc_strdup(talloc_autofree_context(), ctdb->daemon.name);\n \ttalloc_set_destructor(domain_socket_name, unlink_destructor);\t\n\n"}