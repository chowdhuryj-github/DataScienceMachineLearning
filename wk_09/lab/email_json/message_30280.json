{"category": "ham", "to_address": "samba-cvs@samba.org", "from_address": "vlendec@samba.org", "subject": "svn commit: samba r22910 - in branches: SAMBA_3_0/source/lib\n\tSAMBA_3_0_26/source/lib", "body": "Author: vlendec\nDate: 2007-05-15 15:41:37 +0000 (Tue, 15 May 2007)\nNew Revision: 22910\n\nWebSVN: http://websvn.samba.org/cgi-bin/viewcvs.cgi?view=rev&root=samba&rev=22910\n\nLog:\nMake message_send_pid static to messages.c\n\nModified:\n   branches/SAMBA_3_0/source/lib/debug.c\n   branches/SAMBA_3_0/source/lib/messages.c\n   branches/SAMBA_3_0/source/lib/tallocmsg.c\n   branches/SAMBA_3_0_26/source/lib/debug.c\n   branches/SAMBA_3_0_26/source/lib/messages.c\n   branches/SAMBA_3_0_26/source/lib/tallocmsg.c\n\n\nChangeset:\nModified: branches/SAMBA_3_0/source/lib/debug.c\n===================================================================\n--- branches/SAMBA_3_0/source/lib/debug.c\t2007-05-15 15:15:52 UTC (rev 22909)\n+++ branches/SAMBA_3_0/source/lib/debug.c\t2007-05-15 15:41:37 UTC (rev 22910)\n@@ -471,13 +471,16 @@\n  Receive a \"set debug level\" message.\n ****************************************************************************/\n \n-static void debug_message(int msg_type, struct server_id src,\n-\t\t\t  void *buf, size_t len, void *private_data)\n+static void debug_message(struct messaging_context *msg_ctx,\n+\t\t\t  void *private_data, \n+\t\t\t  uint32_t msg_type, \n+\t\t\t  struct server_id src,\n+\t\t\t  DATA_BLOB *data)\n {\n-\tconst char *params_str = (const char *)buf;\n+\tconst char *params_str = (const char *)data->data;\n \n \t/* Check, it's a proper string! */\n-\tif (params_str[len-1] != '\\0') {\n+\tif (params_str[(data->length)-1] != '\\0') {\n \t\tDEBUG(1, (\"Invalid debug message from pid %u to pid %u\\n\",\n \t\t\t  (unsigned int)procid_to_pid(&src),\n \t\t\t  (unsigned int)getpid()));\n@@ -495,8 +498,11 @@\n  Return current debug level.\n ****************************************************************************/\n \n-static void debuglevel_message(int msg_type, struct server_id src,\n-\t\t\t       void *buf, size_t len, void *private_data)\n+static void debuglevel_message(struct messaging_context *msg_ctx,\n+\t\t\t       void *private_data, \n+\t\t\t       uint32_t msg_type, \n+\t\t\t       struct server_id src,\n+\t\t\t       DATA_BLOB *data)\n {\n \tchar *message = debug_list_class_names_and_levels();\n \n@@ -505,9 +511,10 @@\n \t\treturn;\n \t}\n \n-\tDEBUG(1,(\"INFO: Received REQ_DEBUGLEVEL message from PID %u\\n\",\n-\t\t (unsigned int)procid_to_pid(&src)));\n-\tmessage_send_pid(src, MSG_DEBUGLEVEL, message, strlen(message) + 1, True);\n+\tDEBUG(1,(\"INFO: Received REQ_DEBUGLEVEL message from PID %s\\n\",\n+\t\t procid_str_static(&src)));\n+\tmessaging_send_buf(msg_ctx, src, MSG_DEBUGLEVEL,\n+\t\t\t   (uint8 *)message, strlen(message) + 1);\n \n \tSAFE_FREE(message);\n }\n@@ -531,10 +538,11 @@\n \t}\n }\n \n-void debug_register_msgs(void)\n+void debug_register_msgs(struct messaging_context *msg_ctx)\n {\n-\tmessage_register(MSG_DEBUG, debug_message, NULL);\n-\tmessage_register(MSG_REQ_DEBUGLEVEL, debuglevel_message, NULL);\n+\tmessaging_register(msg_ctx, NULL, MSG_DEBUG, debug_message);\n+\tmessaging_register(msg_ctx, NULL, MSG_REQ_DEBUGLEVEL,\n+\t\t\t   debuglevel_message);\n }\n \n /***************************************************************************\n\nModified: branches/SAMBA_3_0/source/lib/messages.c\n===================================================================\n--- branches/SAMBA_3_0/source/lib/messages.c\t2007-05-15 15:15:52 UTC (rev 22909)\n+++ branches/SAMBA_3_0/source/lib/messages.c\t2007-05-15 15:41:37 UTC (rev 22910)\n@@ -99,6 +99,10 @@\n \tsys_select_signal(SIGUSR1);\n }\n \n+static NTSTATUS message_send_pid(struct server_id pid, int msg_type,\n+\t\t\t\t const void *buf, size_t len,\n+\t\t\t\t BOOL duplicates_allowed);\n+\n /****************************************************************************\n  A useful function for testing the message system.\n ****************************************************************************/\n@@ -142,9 +146,9 @@\n \n \t/* Register some debugging related messages */\n \n-\tregister_msg_pool_usage();\n+\tregister_msg_pool_usage(msg_ctx);\n \tregister_dmalloc_msgs();\n-\tdebug_register_msgs();\n+\tdebug_register_msgs(msg_ctx);\n \n \treturn True;\n }\n@@ -366,26 +370,15 @@\n  Send a message to a particular pid - no timeout.\n ****************************************************************************/\n \n-NTSTATUS message_send_pid(struct server_id pid, int msg_type, const void *buf,\n-\t\t\t  size_t len, BOOL duplicates_allowed)\n+static NTSTATUS message_send_pid(struct server_id pid, int msg_type,\n+\t\t\t\t const void *buf, size_t len,\n+\t\t\t\t BOOL duplicates_allowed)\n {\n \treturn message_send_pid_internal(pid, msg_type, buf, len,\n \t\t\t\t\t duplicates_allowed, 0);\n }\n \n /****************************************************************************\n- Send a message to a particular pid, with timeout in seconds.\n-****************************************************************************/\n-\n-NTSTATUS message_send_pid_with_timeout(struct server_id pid, int msg_type,\n-\t\t\t\t       const void *buf, size_t len,\n-\t\t\t\t       BOOL duplicates_allowed, unsigned int timeout)\n-{\n-\treturn message_send_pid_internal(pid, msg_type, buf, len, duplicates_allowed,\n-\t\t\t\t\t timeout);\n-}\n-\n-/****************************************************************************\n  Count the messages pending for a particular pid. Expensive....\n ****************************************************************************/\n \n\nModified: branches/SAMBA_3_0/source/lib/tallocmsg.c\n===================================================================\n--- branches/SAMBA_3_0/source/lib/tallocmsg.c\t2007-05-15 15:15:52 UTC (rev 22909)\n+++ branches/SAMBA_3_0/source/lib/tallocmsg.c\t2007-05-15 15:41:37 UTC (rev 22910)\n@@ -65,9 +65,11 @@\n  * Respond to a POOL_USAGE message by sending back string form of memory\n  * usage stats.\n  **/\n-void msg_pool_usage(int msg_type, struct server_id src_pid,\n-\t\t    void *UNUSED(buf), size_t UNUSED(len),\n-\t\t    void *private_data)\n+static void msg_pool_usage(struct messaging_context *msg_ctx,\n+\t\t\t   void *private_data, \n+\t\t\t   uint32_t msg_type, \n+\t\t\t   struct server_id src,\n+\t\t\t   DATA_BLOB *data)\n {\n \tstruct msg_pool_usage_state state;\n \n@@ -90,8 +92,8 @@\n \t\treturn;\n \t}\n \t\n-\tmessage_send_pid(src_pid, MSG_POOL_USAGE,\n-\t\t\t state.s, strlen(state.s)+1, True);\n+\tmessaging_send_buf(msg_ctx, src, MSG_POOL_USAGE,\n+\t\t\t   (uint8 *)state.s, strlen(state.s)+1);\n \n \ttalloc_destroy(state.mem_ctx);\n }\n@@ -99,8 +101,8 @@\n /**\n  * Register handler for MSG_REQ_POOL_USAGE\n  **/\n-void register_msg_pool_usage(void)\n+void register_msg_pool_usage(struct messaging_context *msg_ctx)\n {\n-\tmessage_register(MSG_REQ_POOL_USAGE, msg_pool_usage, NULL);\n+\tmessaging_register(msg_ctx, NULL, MSG_REQ_POOL_USAGE, msg_pool_usage);\n \tDEBUG(2, (\"Registered MSG_REQ_POOL_USAGE\\n\"));\n }\t\n\nModified: branches/SAMBA_3_0_26/source/lib/debug.c\n===================================================================\n--- branches/SAMBA_3_0_26/source/lib/debug.c\t2007-05-15 15:15:52 UTC (rev 22909)\n+++ branches/SAMBA_3_0_26/source/lib/debug.c\t2007-05-15 15:41:37 UTC (rev 22910)\n@@ -471,13 +471,16 @@\n  Receive a \"set debug level\" message.\n ****************************************************************************/\n \n-static void debug_message(int msg_type, struct server_id src,\n-\t\t\t  void *buf, size_t len, void *private_data)\n+static void debug_message(struct messaging_context *msg_ctx,\n+\t\t\t  void *private_data, \n+\t\t\t  uint32_t msg_type, \n+\t\t\t  struct server_id src,\n+\t\t\t  DATA_BLOB *data)\n {\n-\tconst char *params_str = (const char *)buf;\n+\tconst char *params_str = (const char *)data->data;\n \n \t/* Check, it's a proper string! */\n-\tif (params_str[len-1] != '\\0') {\n+\tif (params_str[(data->length)-1] != '\\0') {\n \t\tDEBUG(1, (\"Invalid debug message from pid %u to pid %u\\n\",\n \t\t\t  (unsigned int)procid_to_pid(&src),\n \t\t\t  (unsigned int)getpid()));\n@@ -495,8 +498,11 @@\n  Return current debug level.\n ****************************************************************************/\n \n-static void debuglevel_message(int msg_type, struct server_id src,\n-\t\t\t       void *buf, size_t len, void *private_data)\n+static void debuglevel_message(struct messaging_context *msg_ctx,\n+\t\t\t       void *private_data, \n+\t\t\t       uint32_t msg_type, \n+\t\t\t       struct server_id src,\n+\t\t\t       DATA_BLOB *data)\n {\n \tchar *message = debug_list_class_names_and_levels();\n \n@@ -505,9 +511,10 @@\n \t\treturn;\n \t}\n \n-\tDEBUG(1,(\"INFO: Received REQ_DEBUGLEVEL message from PID %u\\n\",\n-\t\t (unsigned int)procid_to_pid(&src)));\n-\tmessage_send_pid(src, MSG_DEBUGLEVEL, message, strlen(message) + 1, True);\n+\tDEBUG(1,(\"INFO: Received REQ_DEBUGLEVEL message from PID %s\\n\",\n+\t\t procid_str_static(&src)));\n+\tmessaging_send_buf(msg_ctx, src, MSG_DEBUGLEVEL,\n+\t\t\t   (uint8 *)message, strlen(message) + 1);\n \n \tSAFE_FREE(message);\n }\n@@ -531,10 +538,11 @@\n \t}\n }\n \n-void debug_register_msgs(void)\n+void debug_register_msgs(struct messaging_context *msg_ctx)\n {\n-\tmessage_register(MSG_DEBUG, debug_message, NULL);\n-\tmessage_register(MSG_REQ_DEBUGLEVEL, debuglevel_message, NULL);\n+\tmessaging_register(msg_ctx, NULL, MSG_DEBUG, debug_message);\n+\tmessaging_register(msg_ctx, NULL, MSG_REQ_DEBUGLEVEL,\n+\t\t\t   debuglevel_message);\n }\n \n /***************************************************************************\n\nModified: branches/SAMBA_3_0_26/source/lib/messages.c\n===================================================================\n--- branches/SAMBA_3_0_26/source/lib/messages.c\t2007-05-15 15:15:52 UTC (rev 22909)\n+++ branches/SAMBA_3_0_26/source/lib/messages.c\t2007-05-15 15:41:37 UTC (rev 22910)\n@@ -99,6 +99,10 @@\n \tsys_select_signal(SIGUSR1);\n }\n \n+static NTSTATUS message_send_pid(struct server_id pid, int msg_type,\n+\t\t\t\t const void *buf, size_t len,\n+\t\t\t\t BOOL duplicates_allowed);\n+\n /****************************************************************************\n  A useful function for testing the message system.\n ****************************************************************************/\n@@ -142,9 +146,9 @@\n \n \t/* Register some debugging related messages */\n \n-\tregister_msg_pool_usage();\n+\tregister_msg_pool_usage(msg_ctx);\n \tregister_dmalloc_msgs();\n-\tdebug_register_msgs();\n+\tdebug_register_msgs(msg_ctx);\n \n \treturn True;\n }\n@@ -366,26 +370,15 @@\n  Send a message to a particular pid - no timeout.\n ****************************************************************************/\n \n-NTSTATUS message_send_pid(struct server_id pid, int msg_type, const void *buf,\n-\t\t\t  size_t len, BOOL duplicates_allowed)\n+static NTSTATUS message_send_pid(struct server_id pid, int msg_type,\n+\t\t\t\t const void *buf, size_t len,\n+\t\t\t\t BOOL duplicates_allowed)\n {\n \treturn message_send_pid_internal(pid, msg_type, buf, len,\n \t\t\t\t\t duplicates_allowed, 0);\n }\n \n /****************************************************************************\n- Send a message to a particular pid, with timeout in seconds.\n-****************************************************************************/\n-\n-NTSTATUS message_send_pid_with_timeout(struct server_id pid, int msg_type,\n-\t\t\t\t       const void *buf, size_t len,\n-\t\t\t\t       BOOL duplicates_allowed, unsigned int timeout)\n-{\n-\treturn message_send_pid_internal(pid, msg_type, buf, len, duplicates_allowed,\n-\t\t\t\t\t timeout);\n-}\n-\n-/****************************************************************************\n  Count the messages pending for a particular pid. Expensive....\n ****************************************************************************/\n \n\nModified: branches/SAMBA_3_0_26/source/lib/tallocmsg.c\n===================================================================\n--- branches/SAMBA_3_0_26/source/lib/tallocmsg.c\t2007-05-15 15:15:52 UTC (rev 22909)\n+++ branches/SAMBA_3_0_26/source/lib/tallocmsg.c\t2007-05-15 15:41:37 UTC (rev 22910)\n@@ -65,9 +65,11 @@\n  * Respond to a POOL_USAGE message by sending back string form of memory\n  * usage stats.\n  **/\n-void msg_pool_usage(int msg_type, struct server_id src_pid,\n-\t\t    void *UNUSED(buf), size_t UNUSED(len),\n-\t\t    void *private_data)\n+static void msg_pool_usage(struct messaging_context *msg_ctx,\n+\t\t\t   void *private_data, \n+\t\t\t   uint32_t msg_type, \n+\t\t\t   struct server_id src,\n+\t\t\t   DATA_BLOB *data)\n {\n \tstruct msg_pool_usage_state state;\n \n@@ -90,8 +92,8 @@\n \t\treturn;\n \t}\n \t\n-\tmessage_send_pid(src_pid, MSG_POOL_USAGE,\n-\t\t\t state.s, strlen(state.s)+1, True);\n+\tmessaging_send_buf(msg_ctx, src, MSG_POOL_USAGE,\n+\t\t\t   (uint8 *)state.s, strlen(state.s)+1);\n \n \ttalloc_destroy(state.mem_ctx);\n }\n@@ -99,8 +101,8 @@\n /**\n  * Register handler for MSG_REQ_POOL_USAGE\n  **/\n-void register_msg_pool_usage(void)\n+void register_msg_pool_usage(struct messaging_context *msg_ctx)\n {\n-\tmessage_register(MSG_REQ_POOL_USAGE, msg_pool_usage, NULL);\n+\tmessaging_register(msg_ctx, NULL, MSG_REQ_POOL_USAGE, msg_pool_usage);\n \tDEBUG(2, (\"Registered MSG_REQ_POOL_USAGE\\n\"));\n }\t\n\n"}