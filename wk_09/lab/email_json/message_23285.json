{"category": "ham", "to_address": "samba-cvs@samba.org", "from_address": "jra@samba.org", "subject": "svn commit: samba r22676 - in branches: SAMBA_3_0/source/rpc_parse\n\tSAMBA_3_0_25/source/rpc_parse SAMBA_3_0_26/source/rpc_parse", "body": "Author: jra\nDate: 2007-05-04 22:15:33 +0000 (Fri, 04 May 2007)\nNew Revision: 22676\n\nWebSVN: http://websvn.samba.org/cgi-bin/viewcvs.cgi?view=rev&root=samba&rev=22676\n\nLog:\nFix zero alloc with create_rpc_blob().\nJeremy.\n\nModified:\n   branches/SAMBA_3_0/source/rpc_parse/parse_misc.c\n   branches/SAMBA_3_0_25/source/rpc_parse/parse_misc.c\n   branches/SAMBA_3_0_26/source/rpc_parse/parse_misc.c\n\n\nChangeset:\nModified: branches/SAMBA_3_0/source/rpc_parse/parse_misc.c\n===================================================================\n--- branches/SAMBA_3_0/source/rpc_parse/parse_misc.c\t2007-05-04 22:01:26 UTC (rev 22675)\n+++ branches/SAMBA_3_0/source/rpc_parse/parse_misc.c\t2007-05-04 22:15:33 UTC (rev 22676)\n@@ -483,12 +483,17 @@\n  Allocate the RPC_DATA_BLOB memory.\n ********************************************************************/\n \n-size_t create_rpc_blob(RPC_DATA_BLOB *str, size_t len)\n+static void create_rpc_blob(RPC_DATA_BLOB *str, size_t len)\n {\n-\tstr->buffer = (uint8 *)TALLOC_ZERO(get_talloc_ctx(), len);\n-\tif (str->buffer == NULL)\n-\t\tsmb_panic(\"create_rpc_blob: talloc fail\\n\");\n-\treturn len;\n+\tif (len) {\n+\t\tstr->buffer = (uint8 *)TALLOC_ZERO(get_talloc_ctx(), len);\n+\t\tif (str->buffer == NULL)\n+\t\t\tsmb_panic(\"create_rpc_blob: talloc fail\\n\");\n+\t\tstr->buf_len = len;\n+\t} else {\n+\t\tstr->buffer = NULL;\n+\t\tstr->buf_len = 0;\n+\t}\n }\n \n /*******************************************************************\n@@ -500,7 +505,7 @@\n \tZERO_STRUCTP(str);\n \n \t/* set up string lengths. */\n-\tstr->buf_len = create_rpc_blob(str, sizeof(uint32));\n+\tcreate_rpc_blob(str, sizeof(uint32));\n \tSIVAL(str->buffer, 0, val);\n }\n \n@@ -513,9 +518,10 @@\n \tZERO_STRUCTP(str);\n \n \t/* set up string lengths. */\n-\tstr->buf_len = create_rpc_blob(str, len*2);\n-\trpcstr_push(str->buffer, buf, (size_t)str->buf_len, STR_TERMINATE);\n-\t\n+\tif (len) {\n+\t\tcreate_rpc_blob(str, len*2);\n+\t\trpcstr_push(str->buffer, buf, (size_t)str->buf_len, STR_TERMINATE);\n+\t}\n }\n \n /*******************************************************************\n@@ -525,8 +531,10 @@\n void init_rpc_blob_hex(RPC_DATA_BLOB *str, const char *buf)\n {\n \tZERO_STRUCTP(str);\n-\tstr->buf_len = create_rpc_blob(str, strlen(buf));\n-\tstr->buf_len = strhex_to_str((char *)str->buffer, str->buf_len, buf);\n+\tif (buf && *buf) {\n+\t\tcreate_rpc_blob(str, strlen(buf));\n+\t\tstr->buf_len = strhex_to_str((char *)str->buffer, str->buf_len, buf);\n+\t}\n }\n \n /*******************************************************************\n@@ -538,8 +546,8 @@\n \tZERO_STRUCTP(str);\n \n \t/* max buffer size (allocated size) */\n-\tif (buf != NULL) {\n-\t\tlen = create_rpc_blob(str, len);\n+\tif (buf != NULL && len) {\n+\t\tcreate_rpc_blob(str, len);\n \t\tmemcpy(str->buffer, buf, len);\n \t}\n \tstr->buf_len = len;\n\nModified: branches/SAMBA_3_0_25/source/rpc_parse/parse_misc.c\n===================================================================\n--- branches/SAMBA_3_0_25/source/rpc_parse/parse_misc.c\t2007-05-04 22:01:26 UTC (rev 22675)\n+++ branches/SAMBA_3_0_25/source/rpc_parse/parse_misc.c\t2007-05-04 22:15:33 UTC (rev 22676)\n@@ -530,12 +530,17 @@\n  Allocate the RPC_DATA_BLOB memory.\n ********************************************************************/\n \n-size_t create_rpc_blob(RPC_DATA_BLOB *str, size_t len)\n+static void create_rpc_blob(RPC_DATA_BLOB *str, size_t len)\n {\n-\tstr->buffer = (uint8 *)TALLOC_ZERO(get_talloc_ctx(), len);\n-\tif (str->buffer == NULL)\n-\t\tsmb_panic(\"create_rpc_blob: talloc fail\\n\");\n-\treturn len;\n+\tif (len) {\n+\t\tstr->buffer = (uint8 *)TALLOC_ZERO(get_talloc_ctx(), len);\n+\t\tif (str->buffer == NULL)\n+\t\t\tsmb_panic(\"create_rpc_blob: talloc fail\\n\");\n+\t\tstr->buf_len = len;\n+\t} else {\n+\t\tstr->buffer = NULL;\n+\t\tstr->buf_len = 0;\n+\t}\n }\n \n /*******************************************************************\n@@ -547,7 +552,7 @@\n \tZERO_STRUCTP(str);\n \n \t/* set up string lengths. */\n-\tstr->buf_len = create_rpc_blob(str, sizeof(uint32));\n+\tcreate_rpc_blob(str, sizeof(uint32));\n \tSIVAL(str->buffer, 0, val);\n }\n \n@@ -560,9 +565,10 @@\n \tZERO_STRUCTP(str);\n \n \t/* set up string lengths. */\n-\tstr->buf_len = create_rpc_blob(str, len*2);\n-\trpcstr_push(str->buffer, buf, (size_t)str->buf_len, STR_TERMINATE);\n-\t\n+\tif (len) {\n+\t\tcreate_rpc_blob(str, len*2);\n+\t\trpcstr_push(str->buffer, buf, (size_t)str->buf_len, STR_TERMINATE);\n+\t}\n }\n \n /*******************************************************************\n@@ -572,8 +578,10 @@\n void init_rpc_blob_hex(RPC_DATA_BLOB *str, const char *buf)\n {\n \tZERO_STRUCTP(str);\n-\tstr->buf_len = create_rpc_blob(str, strlen(buf));\n-\tstr->buf_len = strhex_to_str((char *)str->buffer, str->buf_len, buf);\n+\tif (buf && *buf) {\n+\t\tcreate_rpc_blob(str, strlen(buf));\n+\t\tstr->buf_len = strhex_to_str((char *)str->buffer, str->buf_len, buf);\n+\t}\n }\n \n /*******************************************************************\n@@ -585,8 +593,8 @@\n \tZERO_STRUCTP(str);\n \n \t/* max buffer size (allocated size) */\n-\tif (buf != NULL) {\n-\t\tlen = create_rpc_blob(str, len);\n+\tif (buf != NULL && len) {\n+\t\tcreate_rpc_blob(str, len);\n \t\tmemcpy(str->buffer, buf, len);\n \t}\n \tstr->buf_len = len;\n\nModified: branches/SAMBA_3_0_26/source/rpc_parse/parse_misc.c\n===================================================================\n--- branches/SAMBA_3_0_26/source/rpc_parse/parse_misc.c\t2007-05-04 22:01:26 UTC (rev 22675)\n+++ branches/SAMBA_3_0_26/source/rpc_parse/parse_misc.c\t2007-05-04 22:15:33 UTC (rev 22676)\n@@ -530,12 +530,17 @@\n  Allocate the RPC_DATA_BLOB memory.\n ********************************************************************/\n \n-size_t create_rpc_blob(RPC_DATA_BLOB *str, size_t len)\n+static void create_rpc_blob(RPC_DATA_BLOB *str, size_t len)\n {\n-\tstr->buffer = (uint8 *)TALLOC_ZERO(get_talloc_ctx(), len);\n-\tif (str->buffer == NULL)\n-\t\tsmb_panic(\"create_rpc_blob: talloc fail\\n\");\n-\treturn len;\n+\tif (len) {\n+\t\tstr->buffer = (uint8 *)TALLOC_ZERO(get_talloc_ctx(), len);\n+\t\tif (str->buffer == NULL)\n+\t\t\tsmb_panic(\"create_rpc_blob: talloc fail\\n\");\n+\t\tstr->buf_len = len;\n+\t} else {\n+\t\tstr->buffer = NULL;\n+\t\tstr->buf_len = 0;\n+\t}\n }\n \n /*******************************************************************\n@@ -547,7 +552,7 @@\n \tZERO_STRUCTP(str);\n \n \t/* set up string lengths. */\n-\tstr->buf_len = create_rpc_blob(str, sizeof(uint32));\n+\tcreate_rpc_blob(str, sizeof(uint32));\n \tSIVAL(str->buffer, 0, val);\n }\n \n@@ -560,9 +565,10 @@\n \tZERO_STRUCTP(str);\n \n \t/* set up string lengths. */\n-\tstr->buf_len = create_rpc_blob(str, len*2);\n-\trpcstr_push(str->buffer, buf, (size_t)str->buf_len, STR_TERMINATE);\n-\t\n+\tif (len) {\n+\t\tcreate_rpc_blob(str, len*2);\n+\t\trpcstr_push(str->buffer, buf, (size_t)str->buf_len, STR_TERMINATE);\n+\t}\n }\n \n /*******************************************************************\n@@ -572,8 +578,10 @@\n void init_rpc_blob_hex(RPC_DATA_BLOB *str, const char *buf)\n {\n \tZERO_STRUCTP(str);\n-\tstr->buf_len = create_rpc_blob(str, strlen(buf));\n-\tstr->buf_len = strhex_to_str((char *)str->buffer, str->buf_len, buf);\n+\tif (buf && *buf) {\n+\t\tcreate_rpc_blob(str, strlen(buf));\n+\t\tstr->buf_len = strhex_to_str((char *)str->buffer, str->buf_len, buf);\n+\t}\n }\n \n /*******************************************************************\n@@ -585,8 +593,8 @@\n \tZERO_STRUCTP(str);\n \n \t/* max buffer size (allocated size) */\n-\tif (buf != NULL) {\n-\t\tlen = create_rpc_blob(str, len);\n+\tif (buf != NULL && len) {\n+\t\tcreate_rpc_blob(str, len);\n \t\tmemcpy(str->buffer, buf, len);\n \t}\n \tstr->buf_len = len;\n\n"}