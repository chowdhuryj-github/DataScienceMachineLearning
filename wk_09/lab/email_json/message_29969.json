{"category": "ham", "to_address": "samba-cvs@samba.org", "from_address": "tridge@samba.org", "subject": "Rev 305: fixed two more places where we don't correctly handle\n\twrite errors on sockets in http://samba.org/~tridge/ctdb", "body": "------------------------------------------------------------\nrevno: 305\nrevision-id: tridge@samba.org-20070515040858-9m93t7zpjwvvc9sq\nparent: tridge@samba.org-20070515003328-ogsyrb3gnoyicfud\ncommitter: Andrew Tridgell \nbranch nick: tridge\ntimestamp: Tue 2007-05-15 14:08:58 +1000\nmessage:\n  fixed two more places where we don't correctly handle write errors on sockets\nmodified:\n  common/ctdb_io.c               ctdb_io.c-20070409200335-dzfc7f3rra5rcf60-1\n  tcp/tcp_connect.c              tcp_connect.c-20061128004937-x70q1cu5xzg5g2tm-1\n=== modified file 'common/ctdb_io.c'\n--- a/common/ctdb_io.c\t2007-05-05 07:19:59 +0000\n+++ b/common/ctdb_io.c\t2007-05-15 04:08:58 +0000\n@@ -170,9 +170,11 @@\n \t\t}\n \n \t\tif (n == -1 && errno != EAGAIN && errno != EWOULDBLOCK) {\n+\t\t\ttalloc_free(queue->fde);\n+\t\t\tqueue->fde = NULL;\n+\t\t\tqueue->fd = -1;\n \t\t\tevent_add_timed(queue->ctdb->ev, queue, timeval_zero(), \n \t\t\t\t\tqueue_dead, queue);\n-\t\t\tEVENT_FD_NOT_WRITEABLE(queue->fde);\n \t\t\treturn;\n \t\t}\n \t\tif (n <= 0) return;\n@@ -232,6 +234,9 @@\n \t    !(queue->ctdb->flags & CTDB_FLAG_TORTURE)) {\n \t\tssize_t n = write(queue->fd, data, length2);\n \t\tif (n == -1 && errno != EAGAIN && errno != EWOULDBLOCK) {\n+\t\t\ttalloc_free(queue->fde);\n+\t\t\tqueue->fde = NULL;\n+\t\t\tqueue->fd = -1;\n \t\t\tevent_add_timed(queue->ctdb->ev, queue, timeval_zero(), \n \t\t\t\t\tqueue_dead, queue);\n \t\t\t/* yes, we report success, as the dead node is \n\n=== modified file 'tcp/tcp_connect.c'\n--- a/tcp/tcp_connect.c\t2007-05-15 00:33:28 +0000\n+++ b/tcp/tcp_connect.c\t2007-05-15 04:08:58 +0000\n@@ -49,9 +49,7 @@\n \n \t/* start a new connect cycle to try to re-establish the\n \t   link */\n-\tclose(tnode->fd);\n \tctdb_queue_set_fd(tnode->queue, -1);\n-\ttnode->fd = -1;\n \tevent_add_timed(node->ctdb->ev, node, timeval_zero(), \n \t\t\tctdb_tcp_node_connect, node);\n }\n@@ -157,6 +155,7 @@\n \t    errno != EINPROGRESS) {\n \t\t/* try again once a second */\n \t\tclose(tnode->fd);\n+\t\ttnode->fd = -1;\n \t\tevent_add_timed(ctdb->ev, node, timeval_current_ofs(1, 0), \n \t\t\t\tctdb_tcp_node_connect, node);\n \t\treturn;\n\n"}