{"category": "ham", "to_address": "samba-technical@samba.org", "from_address": "Tim Prouty <tim.prouty@isilon.com>", "subject": "When sending a HUP signal isn't enough?", "body": "Hi,\n\nOn certain smb.conf parameter changes, sending a HUP to samba is  \nunsafe.  For example, if smbd is running with \"security = user\", and  \na windows client sends a negotiate protocol request, smbd will reply  \nindicating that it is able to handle the security mode: USER.  The  \nwindows client will then send a Session Setup AndX Request that has a  \nword count of 12, which indicates that this sesssetup should be  \nhandled by the special case sesssetup_spnego code.  There is a race  \nthat can happen between sending the negprot reply and receiving the  \nsesssetup request.  If during this period of time smb.conf is changed  \nto \"security = share\", and smbd is sent a HUP signal, smbd will panic  \ndue to this check in register_vuid():\n\n\t/* Paranoia check. */\n\tif(lp_security() == SEC_SHARE) {\n\t\tsmb_panic(\"Tried to register uid in security=share\\n\");\n\t}\n\nAlso, when joining a new domain and changing the realm in smb.conf,  \nwinbindd does not appear to correctly pick up the changes with a HUP  \nsignal.  Ideally, sending a HUP signal would always be sufficient,  \nbut as a workaround, we send a TERM signal when changing the security  \nmode or realm.\n\nDoes anyone know of any other smb.conf parameters that a HUP signal  \nwon't safely pick up the changes for?\n\nThanks!\n\n-Tim\n\n"}