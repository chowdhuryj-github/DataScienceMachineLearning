{"category": "ham", "to_address": "samba-cvs@samba.org", "from_address": "abartlet@samba.org", "subject": "svn commit: samba r22292 - in\n\tbranches/SAMBA_4_0/source/script/tests: .", "body": "Author: abartlet\nDate: 2007-04-17 03:47:51 +0000 (Tue, 17 Apr 2007)\nNew Revision: 22292\n\nWebSVN: http://websvn.samba.org/cgi-bin/viewcvs.cgi?view=rev&root=samba&rev=22292\n\nLog:\nStart the LDAP server inside the same fifo as smbd, as OpenLDAP (like\nsmbd, but not Fedora DS yet) will then shut down when it looses stdin.\n\nThis avoids leaving stray slapd processes around, if we don't finish\nthe script to run the kill.\n\nAlso set KRB5_CONFIG in the smbd process again, as we do actually need\nthis...\n\nAndrew Bartlett\n\nModified:\n   branches/SAMBA_4_0/source/script/tests/Samba4.pm\n\n\nChangeset:\nModified: branches/SAMBA_4_0/source/script/tests/Samba4.pm\n===================================================================\n--- branches/SAMBA_4_0/source/script/tests/Samba4.pm\t2007-04-17 02:14:28 UTC (rev 22291)\n+++ branches/SAMBA_4_0/source/script/tests/Samba4.pm\t2007-04-17 03:47:51 UTC (rev 22292)\n@@ -67,32 +67,35 @@\n \tmy ($self, $env_vars, $max_time) = @_;\n \treturn 0 if ( -p $env_vars->{SMBD_TEST_FIFO});\n \n-\t# Start slapd before smbd\n-\tif (defined($self->{ldap})) {\n-\t\t$self->slapd_start($env_vars) or \n-\t\t\tdie(\"couldn't start slapd\");\n-\n-\t\tprint \"LDAP PROVISIONING...\";\n-\t\t$self->provision_ldap($env_vars);\n-\t}\n-\n-\tSocketWrapper::set_default_iface(1);\n-\n \tunlink($env_vars->{SMBD_TEST_FIFO});\n \tPOSIX::mkfifo($env_vars->{SMBD_TEST_FIFO}, 0700);\n \tunlink($env_vars->{SMBD_TEST_LOG});\n \t\n-\tmy $valgrind = \"\";\n-\tif (defined($ENV{SMBD_VALGRIND})) {\n-\t\t$valgrind = $ENV{SMBD_VALGRIND};\n-\t} \n-\n \tprint \"STARTING SMBD... \";\n \tmy $pid = fork();\n \tif ($pid == 0) {\n \t\topen STDIN, $env_vars->{SMBD_TEST_FIFO};\n \t\topen STDOUT, \">$env_vars->{SMBD_TEST_LOG}\";\n \t\topen STDERR, '>&STDOUT';\n+\t\t\n+\t\tSocketWrapper::set_default_iface(1);\n+\t\t\n+\t\t# Start slapd before smbd, but with the fifo on stdin\n+\t\tif (defined($self->{ldap})) {\n+\t\t    $self->slapd_start($env_vars) or \n+\t\t\tdie(\"couldn't start slapd\");\n+\t\t    \n+\t\t    print \"LDAP PROVISIONING...\";\n+\t\t    $self->provision_ldap($env_vars);\n+\t\t}\n+\t\t\n+\t\tmy $valgrind = \"\";\n+\t\tif (defined($ENV{SMBD_VALGRIND})) {\n+\t\t    $valgrind = $ENV{SMBD_VALGRIND};\n+\t\t} \n+\n+\t\t$ENV{KRB5_CONFIG} = $env_vars->{KRB5_CONFIG}; \n+\n \t\tmy $optarg = \"\";\n \t\tif (defined($max_time)) {\n \t\t\t$optarg = \"--maximum-runtime=$max_time \";\n\n"}