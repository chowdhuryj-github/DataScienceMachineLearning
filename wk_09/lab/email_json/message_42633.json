{"category": "ham", "to_address": "samba-cvs@samba.org", "from_address": "tridge@samba.org", "subject": "Rev 468: set close on exec on pipe in event scripts,\n\tso long running scripts don't hold the pipe in\n\thttp://samba.org/~tridge/ctdb", "body": "------------------------------------------------------------\nrevno: 468\nrevision-id: tridge@samba.org-20070605051837-j5h7se616o7a7zbz\nparent: tridge@samba.org-20070605051753-8zmbmalk19r44hqw\ncommitter: Andrew Tridgell \nbranch nick: tridge\ntimestamp: Tue 2007-06-05 15:18:37 +1000\nmessage:\n  set close on exec on pipe in event scripts, so long running scripts don't hold the pipe\nmodified:\n  config/ctdb.sysconfig          ctdb.sysconfig-20070527204758-biuh7znabuwan3zn-7\n  config/events.d/50.samba       samba-20070601105340-vlcvnp6euoj3zdwy-3\n  config/events.d/59.nfslock     nfslock-20070601105340-vlcvnp6euoj3zdwy-2\n  config/events.d/60.nfs         nfs-20070601141008-hy3h4qgbk1jd2jci-1\n  takeover/system.c              system.c-20070525071636-a5n1ihghjtppy08r-3\n=== modified file 'config/ctdb.sysconfig'\n--- a/config/ctdb.sysconfig\t2007-06-04 12:13:59 +0000\n+++ b/config/ctdb.sysconfig\t2007-06-05 05:18:37 +0000\n@@ -20,6 +20,11 @@\n # default is to not manage Samba\n # CTDB_MANAGES_SAMBA=yes\n \n+# you may wish to raise the file descriptor limit for ctdb\n+# use a ulimit command here. ctdb needs one file descriptor per\n+# connected client (ie. one per connected client in Samba)\n+#  ulimit -n 10000\n+\n # the NODES file must be specified or ctdb won't start\n # it should contain a list of IPs that ctdb will use\n # it must be exactly the same on all cluster nodes\n\n=== modified file 'config/events.d/50.samba'\n--- a/config/events.d/50.samba\t2007-06-04 05:09:03 +0000\n+++ b/config/events.d/50.samba\t2007-06-05 05:18:37 +0000\n@@ -17,6 +17,10 @@\n \tsmb_dirs=`testparm -st 2> /dev/null | egrep '^\\s*path = '  | cut -d= -f2`\n \tctdb_wait_directories \"Samba\" $smb_dirs\t\n \n+\t# make sure samba is not already started\n+\tservice smb stop > /dev/null 2>&1\n+\tservice winbind stop > /dev/null 2>&1\n+\n \t# start Samba service\n \tservice smb start\n \tservice winbind start\n\n=== modified file 'config/events.d/59.nfslock'\n--- a/config/events.d/59.nfslock\t2007-06-04 05:09:03 +0000\n+++ b/config/events.d/59.nfslock\t2007-06-05 05:18:37 +0000\n@@ -16,6 +16,8 @@\n \t/bin/mkdir -p /etc/ctdb/state/statd/ip\n \tctdb_wait_directories \"nfslock\" \"$STATD_SHARED_DIRECTORY\"\n \n+\t# make sure the service is stopped first\n+\tservice nfslock stop > /dev/null 2>&1\n \tservice nfslock start\n \t;;\n \n\n=== modified file 'config/events.d/60.nfs'\n--- a/config/events.d/60.nfs\t2007-06-04 13:54:22 +0000\n+++ b/config/events.d/60.nfs\t2007-06-05 05:18:37 +0000\n@@ -17,6 +17,8 @@\n \tnfs_dirs=`grep -v '^#' < /etc/exports | cut -d' ' -f1`\n \tctdb_wait_directories \"NFS\" $nfs_dirs\n \n+\t# make sure nfs is stopped before we start it, or it may get a bind error\n+\tservice nfs stop > /dev/null 2>&1\n \tservice nfs start\n \t;;\n \n\n=== modified file 'takeover/system.c'\n--- a/takeover/system.c\t2007-06-04 13:52:12 +0000\n+++ b/takeover/system.c\t2007-06-05 05:18:37 +0000\n@@ -386,6 +386,7 @@\n \tif (state->child == 0) {\n \t\tclose(state->fd[0]);\n \t\tctdb_set_realtime(false);\n+\t\tset_close_on_exec(state->fd[1]);\n \t\tva_start(ap, fmt);\n \t\tret = ctdb_event_script_v(ctdb, fmt, ap);\n \t\tva_end(ap);\n\n"}