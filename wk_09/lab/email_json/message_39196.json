{"category": "ham", "to_address": "Christian Perrier <bubulle@debian.org>", "from_address": "Steve Langasek <vorlon@debian.org>", "subject": "Re: [PATCH 4/10] Debian patch: add an option to not update mtab for\n\tsmbmount", "body": "On Wed, May 30, 2007 at 10:34:00PM +0200, Christian Perrier wrote:\n> The attached patch is currently used in Debian.\n\n> It adds a \"-n\" option to smbmount so that it does not update\n> /etc/mtab. I can't find a real evidence of why this was needed.\n\n> Please note that the patch adds the option but does not update the\n> manpage.\n\nsamba (2.2.3a-7) unstable; urgency=medium\n\n  [...]\n  * Applied patch from Urban Widmark \n    (smbfs upstream maintainer) to add a '-n' option to smbmount\n    that does the same as mount's '-n'. (Closes: #139590)\n  [...]\n\nThe original bug report was that smbfs could not be used when the root\nfilesystem was mounted read-only, which is a valid use and supported by\nmount when using other fs types that don't do their own writing to\n/etc/mtab.  I don't know why Urban never included this upstream though.\n\n-- \nSteve Langasek                   Give me a lever long enough and a Free OS\nDebian Developer                   to set it on, and I can move the world.\nvorlon@debian.org                                   http://www.debian.org/\n\n> Goal: Add an option to not update mtab\n> \n> Fixes: ?\n> \n> Status wrt upstream: Should be forwarded\n> \n> Note: Part of no-longer maintained smbfs stuff?\n>       The manpages are not modified\n> \n> Index: samba-3.0.25a/source/client/smbmnt.c\n> ===================================================================\n> --- samba-3.0.25a.orig/source/client/smbmnt.c\t2007-05-26 07:46:33.492644419 +0200\n> +++ samba-3.0.25a/source/client/smbmnt.c\t2007-05-26 07:46:33.848647257 +0200\n> @@ -44,6 +44,7 @@\n>  static uid_t mount_uid;\n>  static gid_t mount_gid;\n>  static int mount_ro;\n> +static int no_mtab;\n>  static unsigned mount_fmask;\n>  static unsigned mount_dmask;\n>  static int user_mount;\n> @@ -56,6 +57,7 @@\n>          printf(\"Usage: smbmnt mount-point [options]\\n\");\n>  \tprintf(\"Version %s\\n\\n\",SAMBA_VERSION_STRING);\n>          printf(\"-s share       share name on server\\n\"\n> +               \"-n             don't update /etc/mtab\\n\"\n>                 \"-r             mount read-only\\n\"\n>                 \"-u uid         mount as uid\\n\"\n>                 \"-g gid         mount as gid\\n\"\n> @@ -70,7 +72,7 @@\n>  {\n>          int opt;\n>  \n> -        while ((opt = getopt (argc, argv, \"s:u:g:rf:d:o:\")) != EOF)\n> +        while ((opt = getopt (argc, argv, \"s:u:g:nrf:d:o:\")) != EOF)\n>  \t{\n>                  switch (opt)\n>  \t\t{\n> @@ -87,6 +89,9 @@\n>  \t\t\t\tmount_gid = strtol(optarg, NULL, 0);\n>  \t\t\t}\n>                          break;\n> +\t\tcase 'n':\n> +\t\t\tno_mtab = 1;\n> +\t\t\tbreak;\n>                  case 'r':\n>                          mount_ro = 1;\n>                          break;\n> @@ -291,36 +296,38 @@\n>  \t\treturn -1;\n>  \t}\n>  \t\n> -        if ((fd = open(MOUNTED\"~\", O_RDWR|O_CREAT|O_EXCL, 0600)) == -1)\n> -        {\n> -                fprintf(stderr, \"Can't get \"MOUNTED\"~ lock file\");\n> -                return 1;\n> -        }\n> -        close(fd);\n> +\tif (!no_mtab) {\n> +\t\tif ((fd = open(MOUNTED\"~\", O_RDWR|O_CREAT|O_EXCL, 0600)) == -1)\n> +\t\t{\n> +\t\t\tfprintf(stderr, \"Can't get \"MOUNTED\"~ lock file\");\n> +\t\t\treturn 1;\n> +\t\t}\n> +\t\tclose(fd);\n>  \t\n> -        if ((mtab = setmntent(MOUNTED, \"a+\")) == NULL)\n> -        {\n> -                fprintf(stderr, \"Can't open \" MOUNTED);\n> -                return 1;\n> -        }\n> +\t\tif ((mtab = setmntent(MOUNTED, \"a+\")) == NULL)\n> +\t\t{\n> +\t\t\tfprintf(stderr, \"Can't open \" MOUNTED);\n> +\t\t\treturn 1;\n> +\t\t}\n>  \n> -        if (addmntent(mtab, &ment) == 1)\n> -        {\n> -                fprintf(stderr, \"Can't write mount entry\");\n> -                return 1;\n> -        }\n> -        if (fchmod(fileno(mtab), 0644) == -1)\n> -        {\n> -                fprintf(stderr, \"Can't set perms on \"MOUNTED);\n> -                return 1;\n> -        }\n> -        endmntent(mtab);\n> +\t\tif (addmntent(mtab, &ment) == 1)\n> +\t\t{\n> +\t\t\tfprintf(stderr, \"Can't write mount entry\");\n> +\t\t\treturn 1;\n> +\t\t}\n> +\t\tif (fchmod(fileno(mtab), 0644) == -1)\n> +\t\t{\n> +\t\t\tfprintf(stderr, \"Can't set perms on \"MOUNTED);\n> +\t\t\treturn 1;\n> +\t\t}\n> +\t\tendmntent(mtab);\n>  \n> -        if (unlink(MOUNTED\"~\") == -1)\n> -        {\n> -                fprintf(stderr, \"Can't remove \"MOUNTED\"~\");\n> -                return 1;\n> -        }\n> +\t\tif (unlink(MOUNTED\"~\") == -1)\n> +\t\t{\n> +\t\t\tfprintf(stderr, \"Can't remove \"MOUNTED\"~\");\n> +\t\t\treturn 1;\n> +\t\t}\n> +\t}\n>  \n>  \treturn 0;\n>  }\t\n> Index: samba-3.0.25a/source/client/smbmount.c\n> ===================================================================\n> --- samba-3.0.25a.orig/source/client/smbmount.c\t2007-05-26 07:46:32.692638041 +0200\n> +++ samba-3.0.25a/source/client/smbmount.c\t2007-05-26 07:46:33.884647544 +0200\n> @@ -48,6 +48,7 @@\n>  static int mount_ro;\n>  static unsigned mount_fmask;\n>  static unsigned mount_dmask;\n> +static BOOL no_mtab = False;\n>  static BOOL use_kerberos;\n>  /* TODO: Add code to detect smbfs version in kernel */\n>  static BOOL status32_smbfs = False;\n> @@ -273,6 +274,9 @@\n>                  return;\n>          }\n>  \n> +\tif (no_mtab)\n> +\t\treturn;\n> +\n>          if ((fd = open(MOUNTED\"~\", O_RDWR|O_CREAT|O_EXCL, 0600)) == -1) {\n>                  DEBUG(0,(\"%d: Can't get \"MOUNTED\"~ lock file\", sys_getpid()));\n>                  return;\n> @@ -470,6 +474,9 @@\n>  \targs[i++] = \"-s\";\n>  \targs[i++] = svc2;\n>  \n> +\tif (no_mtab) {\n> +\t\targs[i++] = \"-n\";\n> +\t}\n>  \tif (mount_ro) {\n>  \t\targs[i++] = \"-r\";\n>  \t}\n> @@ -665,7 +672,7 @@\n>  ****************************************************************************/\n>  static void usage(void)\n>  {\n> -\tprintf(\"Usage: mount.smbfs service mountpoint [-o options,...]\\n\");\n> +\tprintf(\"Usage: mount.smbfs service mountpoint [-n] [-o options,...]\\n\");\n>  \n>  \tprintf(\"Version %s\\n\\n\",SAMBA_VERSION_STRING);\n>  \n> @@ -742,8 +749,13 @@\n>  \targc -= 2;\n>  \targv += 2;\n>  \n> -\topt = getopt(argc, argv, \"o:\");\n> -\tif(opt != 'o') {\n> +\topt = getopt(argc, argv, \"no:\");\n> +\tif (opt == 'n') {\n> +\t\tDEBUG(3,(\"No mtab!\\n\"));\n> +\t\tno_mtab = True;\n> +\t\topt = getopt(argc, argv, \"o:\");\n> +\t}\n> +\tif (opt != 'o') {\n>  \t\treturn;\n>  \t}\n>  \n\n"}