{"category": "ham", "to_address": "samba-cvs@samba.org", "from_address": "tridge@samba.org", "subject": "svn commit: samba r23017 - in\n\tbranches/SAMBA_4_0/source/ntvfs/posix: .", "body": "Author: tridge\nDate: 2007-05-20 08:01:02 +0000 (Sun, 20 May 2007)\nNew Revision: 23017\n\nWebSVN: http://websvn.samba.org/cgi-bin/viewcvs.cgi?view=rev&root=samba&rev=23017\n\nLog:\n\nfixed the warning we have been getting for a long time:\n   pvfs_close: failed to delete XXX\nduring the BASE-DELETE test. It was a real bug, and could result in a \ndelete on close triggering for a handle that had never fully opened.\n\nModified:\n   branches/SAMBA_4_0/source/ntvfs/posix/pvfs_open.c\n   branches/SAMBA_4_0/source/ntvfs/posix/vfs_posix.h\n\n\nChangeset:\nModified: branches/SAMBA_4_0/source/ntvfs/posix/pvfs_open.c\n===================================================================\n--- branches/SAMBA_4_0/source/ntvfs/posix/pvfs_open.c\t2007-05-19 22:29:59 UTC (rev 23016)\n+++ branches/SAMBA_4_0/source/ntvfs/posix/pvfs_open.c\t2007-05-20 08:01:02 UTC (rev 23017)\n@@ -270,6 +270,7 @@\n \tf->handle->position          = 0;\n \tf->handle->mode              = 0;\n \tf->handle->sticky_write_time = False;\n+\tf->handle->open_completed    = False;\n \n \tif ((create_options & NTCREATEX_OPTIONS_DELETE_ON_CLOSE) &&\n \t    pvfs_directory_empty(pvfs, f->handle->name)) {\n@@ -379,6 +380,8 @@\n \t\tgoto cleanup_delete;\n \t}\n \n+\tf->handle->open_completed = True;\n+\n \tio->generic.out.oplock_level  = OPLOCK_NONE;\n \tio->generic.out.file.ntvfs    = h;\n \tio->generic.out.create_action = create_action;\n@@ -437,6 +440,7 @@\n \t}\n \n \tif (h->name->stream_name == NULL && \n+\t    h->open_completed &&\n \t    pvfs_delete_on_close_set(h->pvfs, h, &open_count, &path) &&\n \t    open_count == 1) {\n \t\tNTSTATUS status;\n@@ -701,6 +705,7 @@\n \tf->handle->mode              = 0;\n \tf->handle->have_opendb_entry = True;\n \tf->handle->sticky_write_time = False;\n+\tf->handle->open_completed    = False;\n \n \tDLIST_ADD(pvfs->files.list, f);\n \n@@ -729,6 +734,8 @@\n \t\tgoto cleanup_delete;\n \t}\n \n+\tf->handle->open_completed = True;\n+\n \tnotify_trigger(pvfs->notify_context, \n \t\t       NOTIFY_ACTION_ADDED, \n \t\t       FILE_NOTIFY_CHANGE_FILE_NAME,\n@@ -1129,6 +1136,7 @@\n \tf->handle->mode              = 0;\n \tf->handle->have_opendb_entry = False;\n \tf->handle->sticky_write_time = False;\n+\tf->handle->open_completed    = False;\n \n \t/* form the lock context used for byte range locking and\n \t   opendb locking */\n@@ -1264,6 +1272,10 @@\n \tstatus = ntvfs_handle_set_backend_data(h, ntvfs, f);\n \tNT_STATUS_NOT_OK_RETURN(status);\n \n+\t/* mark the open as having completed fully, so delete on close\n+\t   can now be used */\n+\tf->handle->open_completed     = True;\n+\n \tio->generic.out.oplock_level  = oplock_granted;\n \tio->generic.out.file.ntvfs    = h;\n \tio->generic.out.create_action = stream_existed?\n\nModified: branches/SAMBA_4_0/source/ntvfs/posix/vfs_posix.h\n===================================================================\n--- branches/SAMBA_4_0/source/ntvfs/posix/vfs_posix.h\t2007-05-19 22:29:59 UTC (rev 23016)\n+++ branches/SAMBA_4_0/source/ntvfs/posix/vfs_posix.h\t2007-05-20 08:01:02 UTC (rev 23017)\n@@ -150,6 +150,9 @@\n \n \t/* have we set a sticky write time that we should remove on close */\n \tBOOL sticky_write_time;\n+\n+\t/* the open went through to completion */\n+\tBOOL open_completed;\n };\n \n /* open file state */\n\n"}