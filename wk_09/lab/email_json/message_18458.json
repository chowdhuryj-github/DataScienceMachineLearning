{"category": "ham", "to_address": "samba-cvs@samba.org", "from_address": "metze@samba.org", "subject": "svn commit: samba r22546 - in branches/SAMBA_4_0/source: param\n\ttorture/local", "body": "Author: metze\nDate: 2007-04-28 08:37:36 +0000 (Sat, 28 Apr 2007)\nNew Revision: 22546\n\nWebSVN: http://websvn.samba.org/cgi-bin/viewcvs.cgi?view=rev&root=samba&rev=22546\n\nLog:\nuse the same error codes in both share backends\n\nmetze\nModified:\n   branches/SAMBA_4_0/source/param/share_ldb.c\n   branches/SAMBA_4_0/source/torture/local/share.c\n\n\nChangeset:\nModified: branches/SAMBA_4_0/source/param/share_ldb.c\n===================================================================\n--- branches/SAMBA_4_0/source/param/share_ldb.c\t2007-04-28 08:00:51 UTC (rev 22545)\n+++ branches/SAMBA_4_0/source/param/share_ldb.c\t2007-04-28 08:37:36 UTC (rev 22546)\n@@ -175,7 +175,7 @@\n \ttalloc_steal(tmp_ctx, res);\n \tif (ret != LDB_SUCCESS) {\n \t\ttalloc_free(tmp_ctx);\n-\t\treturn NT_STATUS_BAD_NETWORK_NAME;\n+\t\treturn NT_STATUS_INTERNAL_DB_CORRUPTION;\n \t}\n \n \tn = talloc_array(mem_ctx, const char *, res->count);\n@@ -223,9 +223,12 @@\n \tret = ldb_search_exp_fmt(ldb, tmp_ctx, &res,\n \t\t\t\t ldb_dn_new(tmp_ctx, ldb, \"CN=SHARES\"), LDB_SCOPE_SUBTREE, NULL,\n \t\t\t\t \"(name=%s)\", name);\n-\tif (ret != LDB_SUCCESS || res->count != 1) {\n+\tif (ret != LDB_SUCCESS || res->count > 1) {\n \t\ttalloc_free(tmp_ctx);\n-\t\treturn NT_STATUS_BAD_NETWORK_NAME;\n+\t\treturn NT_STATUS_INTERNAL_DB_CORRUPTION;\n+\t} else if (res->count != 1) {\n+\t\ttalloc_free(tmp_ctx);\n+\t\treturn NT_STATUS_OBJECT_NAME_NOT_FOUND;\n \t}\n \n \ts = talloc(tmp_ctx, struct share_config);\n@@ -363,7 +366,9 @@\n \t\tDEBUG(2,(\"ERROR: unable to add share %s to share.ldb\\n\"\n \t\t\t \"       err=%d [%s]\\n\", name, err, ldb_errstring(ldb)));\n \t\tif (err == LDB_ERR_NO_SUCH_OBJECT) {\n-\t\t\tret = NT_STATUS_BAD_NETWORK_NAME;\n+\t\t\tret = NT_STATUS_OBJECT_NAME_NOT_FOUND;\n+\t\t} else if (err == LDB_ERR_ENTRY_ALREADY_EXISTS) {\n+\t\t\tret = NT_STATUS_OBJECT_NAME_COLLISION;\n \t\t} else {\n \t\t\tret = NT_STATUS_UNSUCCESSFUL;\n \t\t}\n@@ -499,7 +504,7 @@\n \t\t\tDEBUG(2,(\"ERROR: unable to rename share %s (to %s)\\n\"\n \t\t\t\t \"       err=%d [%s]\\n\", name, newname, err, ldb_errstring(ldb)));\n \t\t\tif (err == LDB_ERR_NO_SUCH_OBJECT) {\n-\t\t\t\tret = NT_STATUS_BAD_NETWORK_NAME;\n+\t\t\t\tret = NT_STATUS_OBJECT_NAME_COLLISION;\n \t\t\t} else {\n \t\t\t\tret = NT_STATUS_UNSUCCESSFUL;\n \t\t\t}\n@@ -514,7 +519,7 @@\n \t\tDEBUG(2,(\"ERROR: unable to add share %s to share.ldb\\n\"\n \t\t\t \"       err=%d [%s]\\n\", name, err, ldb_errstring(ldb)));\n \t\tif (err == LDB_ERR_NO_SUCH_OBJECT) {\n-\t\t\tret = NT_STATUS_BAD_NETWORK_NAME;\n+\t\t\tret = NT_STATUS_OBJECT_NAME_COLLISION;\n \t\t} else {\n \t\t\tret = NT_STATUS_UNSUCCESSFUL;\n \t\t}\n\nModified: branches/SAMBA_4_0/source/torture/local/share.c\n===================================================================\n--- branches/SAMBA_4_0/source/torture/local/share.c\t2007-04-28 08:00:51 UTC (rev 22545)\n+++ branches/SAMBA_4_0/source/torture/local/share.c\t2007-04-28 08:37:36 UTC (rev 22546)\n@@ -159,7 +159,7 @@\n \n \ttorture_assert_ntstatus_ok(tctx, status, \"create_share failed\");\n \n-\ttorture_assert_ntstatus_equal(tctx, NT_STATUS_UNSUCCESSFUL, \n+\ttorture_assert_ntstatus_equal(tctx, NT_STATUS_OBJECT_NAME_COLLISION,\n \t\t\t\t      share_create(ctx, \"bla\", inf, 2),\n \t\t\t\t      \"create_share failed\");\n \n\n"}