{"category": "ham", "to_address": "samba-cvs@samba.org", "from_address": "jerry@samba.org", "subject": "svn commit: samba r22725 - in branches: SAMBA_3_0/source/nsswitch\n\tSAMBA_3_0_26/source/nsswitch", "body": "Author: jerry\nDate: 2007-05-06 21:34:24 +0000 (Sun, 06 May 2007)\nNew Revision: 22725\n\nWebSVN: http://websvn.samba.org/cgi-bin/viewcvs.cgi?view=rev&root=samba&rev=22725\n\nLog:\n* Don't try to update the sequence_number when offline\n* Log the NTSTATUS when saving name/sid cache entry\n* Allow the backend loolkup_usergroups() call in winbindd_{rpc,ads}.c\n  to inform the wcache manager that the group list should not be cached\n  (needed for one-way trusts).\n\n\nModified:\n   branches/SAMBA_3_0/source/nsswitch/winbindd_cache.c\n   branches/SAMBA_3_0_26/source/nsswitch/winbindd_cache.c\n\n\nChangeset:\nModified: branches/SAMBA_3_0/source/nsswitch/winbindd_cache.c\n===================================================================\n--- branches/SAMBA_3_0/source/nsswitch/winbindd_cache.c\t2007-05-06 21:31:19 UTC (rev 22724)\n+++ branches/SAMBA_3_0/source/nsswitch/winbindd_cache.c\t2007-05-06 21:34:24 UTC (rev 22725)\n@@ -458,6 +458,10 @@\n \ttime_t t = time(NULL);\n \tunsigned cache_time = lp_winbind_cache_time();\n \n+\tif ( IS_DOMAIN_OFFLINE(domain) ) {\n+\t\treturn;\n+\t}\n+\t\n \tget_cache( domain );\n \n #if 0\t/* JERRY -- disable as the default cache time is now 5 minutes */\n@@ -829,8 +833,8 @@\n \tfstrcpy(uname, name);\n \tstrupper_m(uname);\n \tcentry_end(centry, \"NS/%s/%s\", domain_name, uname);\n-\tDEBUG(10,(\"wcache_save_name_to_sid: %s\\\\%s -> %s\\n\", domain_name, uname,\n-\t\t  sid_string_static(sid)));\n+\tDEBUG(10,(\"wcache_save_name_to_sid: %s\\\\%s -> %s (%s)\\n\", domain_name, uname,\n+\t\t  sid_string_static(sid), nt_errstr(status)));\n \tcentry_free(centry);\n }\n \n@@ -853,7 +857,8 @@\n \t\tcentry_put_string(centry, name);\n \t}\n \tcentry_end(centry, \"SN/%s\", sid_to_string(sid_string, sid));\n-\tDEBUG(10,(\"wcache_save_sid_to_name: %s -> %s\\n\", sid_string, name));\n+\tDEBUG(10,(\"wcache_save_sid_to_name: %s -> %s (%s)\\n\", sid_string, \n+\t\t  name, nt_errstr(status)));\n \tcentry_free(centry);\n }\n \n@@ -1748,6 +1753,9 @@\n \n \tstatus = domain->backend->lookup_usergroups(domain, mem_ctx, user_sid, num_groups, user_gids);\n \n+\tif ( NT_STATUS_EQUAL(status, NT_STATUS_SYNCHRONIZATION_REQUIRED) )\n+\t\tgoto skip_save;\n+\t\n \t/* and save it */\n \trefresh_sequence_number(domain, False);\n \tcentry = centry_start(domain, status);\n\nModified: branches/SAMBA_3_0_26/source/nsswitch/winbindd_cache.c\n===================================================================\n--- branches/SAMBA_3_0_26/source/nsswitch/winbindd_cache.c\t2007-05-06 21:31:19 UTC (rev 22724)\n+++ branches/SAMBA_3_0_26/source/nsswitch/winbindd_cache.c\t2007-05-06 21:34:24 UTC (rev 22725)\n@@ -449,6 +449,10 @@\n \ttime_t t = time(NULL);\n \tunsigned cache_time = lp_winbind_cache_time();\n \n+\tif ( IS_DOMAIN_OFFLINE(domain) ) {\n+\t\treturn;\n+\t}\n+\t\n \tget_cache( domain );\n \n #if 0\t/* JERRY -- disable as the default cache time is now 5 minutes */\n@@ -823,8 +827,8 @@\n \tfstrcpy(uname, name);\n \tstrupper_m(uname);\n \tcentry_end(centry, \"NS/%s/%s\", domain_name, uname);\n-\tDEBUG(10,(\"wcache_save_name_to_sid: %s\\\\%s -> %s\\n\", domain_name, uname,\n-\t\t  sid_string_static(sid)));\n+\tDEBUG(10,(\"wcache_save_name_to_sid: %s\\\\%s -> %s (%s)\\n\", domain_name, uname,\n+\t\t  sid_string_static(sid), nt_errstr(status)));\n \tcentry_free(centry);\n }\n \n@@ -847,7 +851,8 @@\n \t\tcentry_put_string(centry, name);\n \t}\n \tcentry_end(centry, \"SN/%s\", sid_to_string(sid_string, sid));\n-\tDEBUG(10,(\"wcache_save_sid_to_name: %s -> %s\\n\", sid_string, name));\n+\tDEBUG(10,(\"wcache_save_sid_to_name: %s -> %s (%s)\\n\", sid_string, \n+\t\t  name, nt_errstr(status)));\n \tcentry_free(centry);\n }\n \n@@ -1730,6 +1735,9 @@\n \n \tstatus = domain->backend->lookup_usergroups(domain, mem_ctx, user_sid, num_groups, user_gids);\n \n+\tif ( NT_STATUS_EQUAL(status, NT_STATUS_SYNCHRONIZATION_REQUIRED) )\n+\t\tgoto skip_save;\n+\t\n \t/* and save it */\n \trefresh_sequence_number(domain, False);\n \tcentry = centry_start(domain, status);\n\n"}