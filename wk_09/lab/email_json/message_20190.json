{"category": "ham", "to_address": "samba-cvs@samba.org", "from_address": "Jelmer Vernooij <jelmer@samba.org>", "subject": "Rev 12058: Set up all required environments before starting tests.\n\tin file:///home/jelmer/bzr.samba/SAMBA_4_0/", "body": "At file:///home/jelmer/bzr.samba/SAMBA_4_0/\n\n------------------------------------------------------------\nrevno: 12058\nrevision-id: jelmer@samba.org-20070430134815-hu9us8v3vsm2jmtz\nparent: svn-v2:22602@0c0555d6-39d7-0310-84fc-f1cc0bd64818-branches%2fSAMBA_4_0\ncommitter: Jelmer Vernooij \nbranch nick: SAMBA_4_0\ntimestamp: Mon 2007-04-30 15:48:15 +0200\nmessage:\n  Set up all required environments before starting tests.\nmodified:\n  source/selftest/selftest.pl    svn-v2:22575@0c0555d6-39d7-0310-84fc-f1cc0bd64818-branches%2fSAMBA_4_0-source%2fselftest%2fselftest.pl\n=== modified file 'source/selftest/selftest.pl'\n--- a/source/selftest/selftest.pl\t2007-04-29 20:37:59 +0000\n+++ b/source/selftest/selftest.pl\t2007-04-30 13:48:15 +0000\n@@ -134,6 +134,7 @@\n my $opt_analyse_cmd = undef;\n my $opt_resetup_env = undef;\n my $opt_bindir = undef;\n+my $opt_no_lazy_setup = undef;\n \n my $srcdir = \".\";\n my $builddir = \".\";\n@@ -454,6 +455,7 @@\n \t\t'testenv' => \\$opt_testenv,\n \t\t'ldap:s' => \\$ldap,\n \t\t'analyse-cmd=s' => \\$opt_analyse_cmd,\n+\t\t'no-lazy-setup' => \\$opt_no_lazy_setup,\n \t\t'resetup-environment' => \\$opt_resetup_env,\n \t\t'bindir:s' => \\$opt_bindir,\n \t    );\n@@ -647,6 +649,7 @@\n my $testsdir = \"$srcdir/selftest\";\n $ENV{CONFIGURATION} = \"--configfile=$conffile\";\n \n+my %required_envs = ();\n \n if ($opt_quick) {\n \topen(IN, \"$testsdir/tests_quick.sh|\");\n@@ -661,8 +664,10 @@\n \t\t$env =~ s/\\n//g;\n \t\tmy $cmdline = ;\n \t\t$cmdline =~ s/\\n//g;\n-\t\tpush (@todo, [$name, $env, $cmdline]) \n-\t\t\tif (not defined($tests) or $name =~ /$tests/);\n+\t\tif (not defined($tests) or $name =~ /$tests/) {\n+\t\t\t$required_envs{$env} = 1;\n+\t\t\tpush (@todo, [$name, $env, $cmdline]);\n+\t\t}\n \t} else {\n \t\tprint;\n \t}\n@@ -777,6 +782,10 @@\n \t$msg_ops = $plain_msg_ops;\n }\n \n+if ($opt_no_lazy_setup) {\n+\tsetup_env($_) foreach (keys %required_envs);\n+}\n+\n if ($opt_testenv) {\n \tmy $testenv_name = $ENV{SELFTEST_TESTENV};\n \t$testenv_name = \"dc\" unless defined($testenv_name);\n\n"}