{"category": "ham", "to_address": "samba-cvs@samba.org", "from_address": "tridge@samba.org", "subject": "Rev 271: setup the random number generator a bit better in\n\thttp://samba.org/~tridge/ctdb", "body": "------------------------------------------------------------\nrevno: 271\nrevision-id: tridge@samba.org-20070510031023-yhipc23awqwfed3s\nparent: tridge@samba.org-20070509224957-9l3bc1ay2rluro28\ncommitter: Andrew Tridgell \nbranch nick: tridge\ntimestamp: Thu 2007-05-10 13:10:23 +1000\nmessage:\n  setup the random number generator a bit better\nmodified:\n  direct/ctdb_recoverd.c         recoverd.c-20070503213540-bvxuyd9jm1f7ig90-1\n=== modified file 'direct/ctdb_recoverd.c'\n--- a/direct/ctdb_recoverd.c\t2007-05-09 22:49:57 +0000\n+++ b/direct/ctdb_recoverd.c\t2007-05-10 03:10:23 +0000\n@@ -508,12 +508,11 @@\n \tstruct election_message *em = (struct election_message *)data.dptr;\n \tTALLOC_CTX *mem_ctx;\n \n-\tmem_ctx = talloc_new(ctdb);\n-\n \tif (em->vnn==ctdb_get_vnn(ctdb)) {\n-\t\ttalloc_free(mem_ctx);\n \t\treturn;\n \t}\n+\n+\tmem_ctx = talloc_new(ctdb);\n \t\t\n \t/* someone called an election. check their election data\n \t   and if we disagree and we would rather be the elected node, \n@@ -628,13 +627,12 @@\n \t\tgoto again;\n \t}\n \t\n-\n \t/* verify that the recmaster node is still active */\n \tfor (j=0; jnum; j++) {\n \t\tif (nodemap->nodes[j].vnn==recmaster) {\n \t\t\tbreak;\n \t\t}\n-\t}\t\n+\t}\n \tif (!(nodemap->nodes[j].flags&NODE_FLAGS_CONNECTED)) {\n \t\tDEBUG(0, (\"Recmaster node %u no longer available. Force reelection\\n\", nodemap->nodes[j].vnn));\n \t\tforce_election(ctdb, mem_ctx, vnn, nodemap);\n@@ -736,7 +734,7 @@\n \n \n \t/* there better be the same number of lmasters in the vnn map\n-\t   as there are active nodes or well have to do a recovery\n+\t   as there are active nodes or we will have to do a recovery\n \t */\n \tif (vnnmap->size != num_active) {\n \t\tDEBUG(0, (__location__ \"The vnnmap count is different from the number of active nodes. %d vs %d\\n\", vnnmap->size, num_active));\n@@ -856,6 +854,8 @@\n \t}\n #endif\n \n+\tsrandom(getpid() ^ time(NULL));\n+\n \tev = event_context_init(NULL);\n \n \t/* initialise ctdb */\n\n"}