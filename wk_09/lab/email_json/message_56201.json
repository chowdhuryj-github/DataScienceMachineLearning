{"category": "ham", "to_address": "samba-cvs@samba.org", "from_address": "gd@samba.org", "subject": "svn commit: samba r23623 - in branches: SAMBA_3_0/source/rpc_server\n\tSAMBA_3_0/source/rpcclient SAMBA_3_0_26/source/rpc_server\n\tSAMBA_3_0_26/source/rpcclient", "body": "Author: gd\nDate: 2007-06-27 09:23:50 +0000 (Wed, 27 Jun 2007)\nNew Revision: 23623\n\nWebSVN: http://websvn.samba.org/cgi-bin/viewcvs.cgi?view=rev&root=samba&rev=23623\n\nLog:\nFix rpcclient and rpc_server with new DFS idl.\n\nGuenther\n\nModified:\n   branches/SAMBA_3_0/source/rpc_server/srv_dfs_nt.c\n   branches/SAMBA_3_0/source/rpcclient/cmd_dfs.c\n   branches/SAMBA_3_0_26/source/rpc_server/srv_dfs_nt.c\n   branches/SAMBA_3_0_26/source/rpcclient/cmd_dfs.c\n\n\nChangeset:\nModified: branches/SAMBA_3_0/source/rpc_server/srv_dfs_nt.c\n===================================================================\n--- branches/SAMBA_3_0/source/rpc_server/srv_dfs_nt.c\t2007-06-27 09:17:52 UTC (rev 23622)\n+++ branches/SAMBA_3_0/source/rpc_server/srv_dfs_nt.c\t2007-06-27 09:23:50 UTC (rev 23623)\n@@ -32,10 +32,11 @@\n \n void _dfs_GetManagerVersion(pipes_struct *p, struct dfs_GetManagerVersion *r)\n {\n-\tif(lp_host_msdfs()) \n-\t\t*r->out.exist_flag = 1;\n-\telse\n-\t\t*r->out.exist_flag = 0;\n+\tif (lp_host_msdfs()) {\n+\t\t*r->out.version = DFS_MANAGER_VERSION_NT4;\n+\t} else {\n+\t\t*r->out.version = 0;\n+\t}\n }\n \n WERROR _dfs_Add(pipes_struct *p, struct dfs_Add *r)\n@@ -109,22 +110,22 @@\n \t\treturn WERR_ACCESS_DENIED;\n \t}\n \n-\tif (r->in.server && r->in.share) {\n-\t\tpstrcpy(altpath, r->in.server);\n+\tif (r->in.servername && r->in.sharename) {\n+\t\tpstrcpy(altpath, r->in.servername);\n \t\tpstrcat(altpath, \"\\\\\");\n-\t\tpstrcat(altpath, r->in.share);\n+\t\tpstrcat(altpath, r->in.sharename);\n \t\tstrlower_m(altpath);\n \t}\n \n \tDEBUG(5,(\"init_reply_dfs_remove: Request to remove %s -> %s\\\\%s.\\n\",\n-\t\tr->in.path, r->in.server, r->in.share));\n+\t\tr->in.dfs_entry_path, r->in.servername, r->in.sharename));\n \n-\tif(!NT_STATUS_IS_OK(get_referred_path(p->mem_ctx, r->in.path, &jn, &consumedcnt, &self_ref))) {\n+\tif(!NT_STATUS_IS_OK(get_referred_path(p->mem_ctx, r->in.dfs_entry_path, &jn, &consumedcnt, &self_ref))) {\n \t\treturn WERR_DFS_NO_SUCH_VOL;\n \t}\n \n \t/* if no server-share pair given, remove the msdfs link completely */\n-\tif(!r->in.server && !r->in.share) {\n+\tif(!r->in.servername && !r->in.sharename) {\n \t\tif(!remove_msdfs_link(&jn)) {\n \t\t\tvfs_ChDir(p->conn,p->conn->connectpath);\n \t\t\treturn WERR_DFS_NO_SUCH_VOL;\n@@ -324,11 +325,11 @@\n \tBOOL self_ref = False;\n \tBOOL ret;\n \n-\tif(!create_junction(r->in.path, &jn))\n+\tif(!create_junction(r->in.dfs_entry_path, &jn))\n \t\treturn WERR_DFS_NO_SUCH_SERVER;\n   \n \t/* The following call can change the cwd. */\n-\tif(!NT_STATUS_IS_OK(get_referred_path(p->mem_ctx, r->in.path, &jn, &consumedcnt, &self_ref)) || consumedcnt < strlen(r->in.path)) {\n+\tif(!NT_STATUS_IS_OK(get_referred_path(p->mem_ctx, r->in.dfs_entry_path, &jn, &consumedcnt, &self_ref)) || consumedcnt < strlen(r->in.dfs_entry_path)) {\n \t\tvfs_ChDir(p->conn,p->conn->connectpath);\n \t\treturn WERR_DFS_NO_SUCH_VOL;\n \t}\n\nModified: branches/SAMBA_3_0/source/rpcclient/cmd_dfs.c\n===================================================================\n--- branches/SAMBA_3_0/source/rpcclient/cmd_dfs.c\t2007-06-27 09:17:52 UTC (rev 23622)\n+++ branches/SAMBA_3_0/source/rpcclient/cmd_dfs.c\t2007-06-27 09:23:50 UTC (rev 23623)\n@@ -25,10 +25,10 @@\n \n /* Check DFS is supported by the remote server */\n \n-static NTSTATUS cmd_dfs_exist(struct rpc_pipe_client *cli, TALLOC_CTX *mem_ctx,\n-                              int argc, const char **argv)\n+static NTSTATUS cmd_dfs_version(struct rpc_pipe_client *cli, TALLOC_CTX *mem_ctx,\n+\t\t\t\tint argc, const char **argv)\n {\n-\tuint32 dfs_exists;\n+\tenum dfs_ManagerVersion version;\n \tNTSTATUS result;\n \n \tif (argc != 1) {\n@@ -36,12 +36,19 @@\n \t\treturn NT_STATUS_OK;\n \t}\n \n-\tresult = rpccli_dfs_GetManagerVersion(cli, mem_ctx, &dfs_exists);\n+\tresult = rpccli_dfs_GetManagerVersion(cli, mem_ctx, &version);\n \n-\tif (NT_STATUS_IS_OK(result))\n-\t\tprintf(\"dfs is %spresent\\n\", dfs_exists ? \"\" : \"not \");\n+\tif (!NT_STATUS_IS_OK(result)) {\n+\t\treturn result;\n+\t}\n \n-\treturn result;\n+\tif (version > 0) {\n+\t\tprintf(\"dfs is present (%d)\\n\", version);\n+\t} else {\n+\t\tprintf(\"dfs is not present\\n\");\n+\t}\n+\n+\treturn NT_STATUS_OK;\n }\n \n static NTSTATUS cmd_dfs_add(struct rpc_pipe_client *cli, TALLOC_CTX *mem_ctx,\n@@ -183,7 +190,6 @@\n \n \tNTSTATUS result;\n \tuint32 total = 0;\n-\tuint32 unknown = 0;\n \n \tif (argc > 2) {\n \t\tprintf(\"Usage: %s [info_level]\\n\", argv[0]);\n@@ -207,7 +213,7 @@\n \t}\n \n \tresult = rpccli_dfs_Enum(cli, mem_ctx, str.level, 0xFFFFFFFF, &str,\n-\t\t\t\t &unknown, &total);\n+\t\t\t\t &total);\n \n \tif (NT_STATUS_IS_OK(result))\n \t\tdisplay_dfs_enumstruct(&str);\n@@ -297,7 +303,7 @@\n \n \t{ \"DFS\" },\n \n-\t{ \"dfsexist\",  RPC_RTYPE_NTSTATUS, cmd_dfs_exist,   NULL, PI_NETDFS, NULL, \"Query DFS support\",    \"\" },\n+\t{ \"dfsversion\",  RPC_RTYPE_NTSTATUS, cmd_dfs_version,   NULL, PI_NETDFS, NULL, \"Query DFS support\",    \"\" },\n \t{ \"dfsadd\",    RPC_RTYPE_NTSTATUS, cmd_dfs_add,     NULL, PI_NETDFS, NULL, \"Add a DFS share\",      \"\" },\n \t{ \"dfsremove\", RPC_RTYPE_NTSTATUS, cmd_dfs_remove,  NULL, PI_NETDFS, NULL, \"Remove a DFS share\",   \"\" },\n \t{ \"dfsgetinfo\",RPC_RTYPE_NTSTATUS, cmd_dfs_getinfo, NULL, PI_NETDFS, NULL, \"Query DFS share info\", \"\" },\n\nModified: branches/SAMBA_3_0_26/source/rpc_server/srv_dfs_nt.c\n===================================================================\n--- branches/SAMBA_3_0_26/source/rpc_server/srv_dfs_nt.c\t2007-06-27 09:17:52 UTC (rev 23622)\n+++ branches/SAMBA_3_0_26/source/rpc_server/srv_dfs_nt.c\t2007-06-27 09:23:50 UTC (rev 23623)\n@@ -32,10 +32,11 @@\n \n void _dfs_GetManagerVersion(pipes_struct *p, struct dfs_GetManagerVersion *r)\n {\n-\tif(lp_host_msdfs()) \n-\t\t*r->out.exist_flag = 1;\n-\telse\n-\t\t*r->out.exist_flag = 0;\n+\tif (lp_host_msdfs()) {\n+\t\t*r->out.version = DFS_MANAGER_VERSION_NT4;\n+\t} else {\n+\t\t*r->out.version = 0;\n+\t}\n }\n \n WERROR _dfs_Add(pipes_struct *p, struct dfs_Add *r)\n@@ -109,22 +110,22 @@\n \t\treturn WERR_ACCESS_DENIED;\n \t}\n \n-\tif (r->in.server && r->in.share) {\n-\t\tpstrcpy(altpath, r->in.server);\n+\tif (r->in.servername && r->in.sharename) {\n+\t\tpstrcpy(altpath, r->in.servername);\n \t\tpstrcat(altpath, \"\\\\\");\n-\t\tpstrcat(altpath, r->in.share);\n+\t\tpstrcat(altpath, r->in.sharename);\n \t\tstrlower_m(altpath);\n \t}\n \n \tDEBUG(5,(\"init_reply_dfs_remove: Request to remove %s -> %s\\\\%s.\\n\",\n-\t\tr->in.path, r->in.server, r->in.share));\n+\t\tr->in.dfs_entry_path, r->in.servername, r->in.sharename));\n \n-\tif(!NT_STATUS_IS_OK(get_referred_path(p->mem_ctx, r->in.path, &jn, &consumedcnt, &self_ref))) {\n+\tif(!NT_STATUS_IS_OK(get_referred_path(p->mem_ctx, r->in.dfs_entry_path, &jn, &consumedcnt, &self_ref))) {\n \t\treturn WERR_DFS_NO_SUCH_VOL;\n \t}\n \n \t/* if no server-share pair given, remove the msdfs link completely */\n-\tif(!r->in.server && !r->in.share) {\n+\tif(!r->in.servername && !r->in.sharename) {\n \t\tif(!remove_msdfs_link(&jn)) {\n \t\t\tvfs_ChDir(p->conn,p->conn->connectpath);\n \t\t\treturn WERR_DFS_NO_SUCH_VOL;\n@@ -324,11 +325,11 @@\n \tBOOL self_ref = False;\n \tBOOL ret;\n \n-\tif(!create_junction(r->in.path, &jn))\n+\tif(!create_junction(r->in.dfs_entry_path, &jn))\n \t\treturn WERR_DFS_NO_SUCH_SERVER;\n   \n \t/* The following call can change the cwd. */\n-\tif(!NT_STATUS_IS_OK(get_referred_path(p->mem_ctx, r->in.path, &jn, &consumedcnt, &self_ref)) || consumedcnt < strlen(r->in.path)) {\n+\tif(!NT_STATUS_IS_OK(get_referred_path(p->mem_ctx, r->in.dfs_entry_path, &jn, &consumedcnt, &self_ref)) || consumedcnt < strlen(r->in.dfs_entry_path)) {\n \t\tvfs_ChDir(p->conn,p->conn->connectpath);\n \t\treturn WERR_DFS_NO_SUCH_VOL;\n \t}\n\nModified: branches/SAMBA_3_0_26/source/rpcclient/cmd_dfs.c\n===================================================================\n--- branches/SAMBA_3_0_26/source/rpcclient/cmd_dfs.c\t2007-06-27 09:17:52 UTC (rev 23622)\n+++ branches/SAMBA_3_0_26/source/rpcclient/cmd_dfs.c\t2007-06-27 09:23:50 UTC (rev 23623)\n@@ -25,10 +25,10 @@\n \n /* Check DFS is supported by the remote server */\n \n-static NTSTATUS cmd_dfs_exist(struct rpc_pipe_client *cli, TALLOC_CTX *mem_ctx,\n-                              int argc, const char **argv)\n+static NTSTATUS cmd_dfs_version(struct rpc_pipe_client *cli, TALLOC_CTX *mem_ctx,\n+\t\t\t\tint argc, const char **argv)\n {\n-\tuint32 dfs_exists;\n+\tenum dfs_ManagerVersion version;\n \tNTSTATUS result;\n \n \tif (argc != 1) {\n@@ -36,11 +36,19 @@\n \t\treturn NT_STATUS_OK;\n \t}\n \n-\tresult = rpccli_dfs_GetManagerVersion(cli, mem_ctx, &dfs_exists);\n+\tresult = rpccli_dfs_GetManagerVersion(cli, mem_ctx, &version);\n \n-\tprintf(\"dfs is %spresent\\n\", dfs_exists ? \"\" : \"not \");\n+\tif (!NT_STATUS_IS_OK(result)) {\n+\t\treturn result;\n+\t}\n \n-\treturn result;\n+\tif (version > 0) {\n+\t\tprintf(\"dfs is present (%d)\\n\", version);\n+\t} else {\n+\t\tprintf(\"dfs is not present\\n\");\n+\t}\n+\n+\treturn NT_STATUS_OK;\n }\n \n static NTSTATUS cmd_dfs_add(struct rpc_pipe_client *cli, TALLOC_CTX *mem_ctx,\n@@ -182,7 +190,6 @@\n \n \tNTSTATUS result;\n \tuint32 total = 0;\n-\tuint32 unknown = 0;\n \n \tif (argc > 2) {\n \t\tprintf(\"Usage: %s [info_level]\\n\", argv[0]);\n@@ -206,7 +213,7 @@\n \t}\n \n \tresult = rpccli_dfs_Enum(cli, mem_ctx, str.level, 0xFFFFFFFF, &str,\n-\t\t\t\t &unknown, &total);\n+\t\t\t\t &total);\n \n \tif (NT_STATUS_IS_OK(result))\n \t\tdisplay_dfs_enumstruct(&str);\n@@ -296,7 +303,7 @@\n \n \t{ \"DFS\" },\n \n-\t{ \"dfsexist\",  RPC_RTYPE_NTSTATUS, cmd_dfs_exist,   NULL, PI_NETDFS, NULL, \"Query DFS support\",    \"\" },\n+\t{ \"dfsversion\",  RPC_RTYPE_NTSTATUS, cmd_dfs_version,   NULL, PI_NETDFS, NULL, \"Query DFS support\",    \"\" },\n \t{ \"dfsadd\",    RPC_RTYPE_NTSTATUS, cmd_dfs_add,     NULL, PI_NETDFS, NULL, \"Add a DFS share\",      \"\" },\n \t{ \"dfsremove\", RPC_RTYPE_NTSTATUS, cmd_dfs_remove,  NULL, PI_NETDFS, NULL, \"Remove a DFS share\",   \"\" },\n \t{ \"dfsgetinfo\",RPC_RTYPE_NTSTATUS, cmd_dfs_getinfo, NULL, PI_NETDFS, NULL, \"Query DFS share info\", \"\" },\n\n"}