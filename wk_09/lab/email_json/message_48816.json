{"category": "ham", "to_address": "marc_schwartz@comcast.net", "from_address": "Dirk Eddelbuettel <edd@debian.org>", "subject": "Re: [R] model.frame: how does one use it?", "body": "\nHi Mark,\n\nThanks for the reply.\n\nOn 15 June 2007 at 14:33, Marc Schwartz wrote:\n| On Fri, 2007-06-15 at 10:47 -0500, Dirk Eddelbuettel wrote: \n| > Philipp Benner reported a Debian bug report against r-cran-rpart aka rpart.\n| > In short, the issue has to do with how rpart evaluates a formula and\n| > supporting arguments, in particular 'weights'.  \n| > \n| > A simple contrived example is\n| > \n| > -----------------------------------------------------------------------------\n| > library(rpart)\n| > \n| > ## using data from help(rpart), set up simple example\n| > myformula <- formula(Kyphosis ~ Age + Number + Start)\n| > mydata <- kyphosis\n| > myweight <- abs(rnorm(nrow(mydata)))\n| > \n| > goodFunction <- function(mydata, myformula, myweight) {\n| >   hyp <- rpart(myformula, data=mydata, weights=myweight, method=\"class\")\n| >   prev <- hyp\n| > }\n| > goodFunction(mydata, myformula, myweight)\n| > cat(\"Ok\\n\")\n| > \n| > ## now remove myweight and try to compute it inside a function\n| > rm(myweight)\n| > \n| > badFunction <- function(mydata, myformula) {\n| >   myweight <- abs(rnorm(nrow(mydata)))\n| >   mf <- model.frame(myformula, mydata, myweight)\n| >   print(head(df))\n| >   hyp <- rpart(myformula,\n| >                data=mf,\n| >                weights=myweight,\n| >                method=\"class\")\n| >   prev <- hyp\n| > }\n| > badFunction(mydata, myformula)\n| > cat(\"Done\\n\")\n| > -----------------------------------------------------------------------------\n| > \n| > Here goodFunction works, but only because myweight (with useless random\n| > weights, but that is not the point here) is found from the calling\n| > environment. \n| > \n| > badFunction fails after we remove myweight from there:\n| > \n| > :~> cat /tmp/philipp.R | R --slave\n| > Ok\n| > Error in eval(expr, envir, enclos) : object \"myweight\" not found\n| > Execution halted\n| > :~>    \n| > \n| > As I was able to replicate it, I reported this to the package maintainer.  It\n| > turns out that seemingly all is well as this is supposed to work this way,\n| > and I got a friendly pointer to study model.frame and its help page.  \n| > \n| > Now I am stuck as I can't make sense of model.frame -- see badFunction\n| > above. I would greatly appreciate any help in making rpart work with a local\n| > argument weights so that I can tell Philipp that there is no bug.  :)\n| > \n| > Regards, Dirk\n| \n| \n| Dirk,\n| \n| As you note, the issue is the non-standard evaluation of the arguments\n| in model.frame()  The key section of the Details in ?model.frame is:\n| \n| \n| All the variables in formula, subset and in ... are looked for first in\n| data and then in the environment of formula (see the help for formula()\n| for further details) and collected into a data frame. Then the subset\n| expression is evaluated, and it is is used as a row index to the data\n| frame. Then the na.action function is applied to the data frame (and may\n| well add attributes). The levels of any factors in the data frame are\n| adjusted according to the drop.unused.levels and xlev arguments.\n| \n| \n| Note that even with your goodFunction(), if 'myweight' is created within\n| the environment of the function and not in the global environment, it\n| still fails:\n| \n| library(rpart)\n| myformula <- formula(Kyphosis ~ Age + Number + Start)\n| mydata <- kyphosis\n| \n| goodFunction <- function(mydata, myformula) {\n|                          myweight <- abs(rnorm(nrow(mydata)))\n|                          hyp <- rpart(myformula, data=mydata,\n|                                       weights=myweight, method=\"class\")\n|                          prev <- hyp\n|                         }\n| \n| \n| > goodFunction(mydata, myformula)\n| Error in eval(expr, envir, enclos) : object \"myweight\" not found\n| \n| \n| However, now let's do this:\n| \n| \n| library(rpart)\n| myformula <- formula(Kyphosis ~ Age + Number + Start)\n| mydata <- kyphosis\n| myweight <- abs(rnorm(nrow(mydata)))\n| \n| goodFunction <- function(mydata, myformula) {\n|                          hyp <- rpart(myformula, data=mydata,\n|                                       weights=myweight, method=\"class\")\n|                          prev <- hyp\n|                         }\n| \n| > goodFunction(mydata, myformula)\n| > \n| \n| It works, because 'myweight' is found in the global environment, which\n| is where the formula is created.\n\nWell,yes, but doesn't this just recreate the working example I showed above?\nIt works 'because we get lucky' with the data in the outer global env.\n\n| Now, final example, try this:\n| \n| \n| library(rpart)\n| goodFunction <- function() {\n|                          myformula <- formula(Kyphosis ~ Age + Number +\n|                                               Start)\n|                          mydata <- kyphosis\n|                          myweight <- abs(rnorm(nrow(mydata)))\n| \n|                          hyp <- rpart(myformula, data=mydata,\n|                                       weights=myweight, method=\"class\")\n|                          prev <- hyp\n|                         }\n| \n| > goodFunction()\n| > \n| \n| It works because the formula is created within the environment of the\n| function and hence, 'myweight', which is created there as well, is\n| found.\n\nThat works because we force it to be local. BDR claims that my 'badFunction'\n(derived from Philipp's original bug report) above can be made to work\nprovide you use model.frame.  I asked about model.frame -- and you were kind\nenough do answer, but you dodged the question.\n\nSo let me try again:  How can rpart be called inside a function using a\nlocal weight variable as I do above ?   Either it can, and the BDR is right\nand there is no bug, or one cannot, and then mere mortals like myself must\nconsider rpart to be buggy as it does not support all its argument in at\nleast some conceivable calling situations. \n\nIs that a fair question?\n\nRegards,  Dirk\n\n\n| There was a (non) bug filed on a related matter dealing with the\n| evaluation of 'subset':\n| \n| http://bugs.r-project.org/cgi-bin/R/feature%26FAQ?id=3671\n| \n| and you might find this document on Non-Standard Evaluation helpful:\n| \n| http://developer.r-project.org/nonstandard-eval.pdf\n| \n| HTH,\n| \n| Marc\n| \n| \n\n-- \nHell, there are no rules here - we're trying to accomplish something. \n                                                  -- Thomas A. Edison\n\n______________________________________________\nR-help@stat.math.ethz.ch mailing list\nhttps://stat.ethz.ch/mailman/listinfo/r-help\nPLEASE do read the posting guide http://www.R-project.org/posting-guide.html\nand provide commented, minimal, self-contained, reproducible code.\n\n"}