{"category": "ham", "to_address": "samba-cvs@samba.org", "from_address": "tridge@samba.org", "subject": "Rev 333: - get rid of ctdb_ctrl_get_config in\n\thttp://samba.org/~tridge/ctdb", "body": "------------------------------------------------------------\nrevno: 333\nrevision-id: tridge@samba.org-20070523051830-vhegrb2m9buoisze\nparent: tridge@samba.org-20070523045041-a6v1tls6f3m01bqx\ncommitter: Andrew Tridgell \nbranch nick: tridge\ntimestamp: Wed 2007-05-23 15:18:30 +1000\nmessage:\n  - get rid of ctdb_ctrl_get_config\n  - cope with zero timeout in ctdb_control\nmodified:\n  common/cmdline.c               cmdline.c-20070416041216-w1zvz91bkdsgjckw-1\n  common/ctdb_client.c           ctdb_client.c-20070411010216-3kd8v37k61steeya-1\n  common/ctdb_daemon.c           ctdb_daemon.c-20070409200331-3el1kqgdb9m4ib0g-1\n=== modified file 'common/cmdline.c'\n--- a/common/cmdline.c\t2007-05-15 05:13:36 +0000\n+++ b/common/cmdline.c\t2007-05-23 05:18:30 +0000\n@@ -183,10 +183,10 @@\n \t\treturn NULL;\n \t}\n \n-\t/* get our config */\n-\tret = ctdb_ctrl_get_config(ctdb);\n-\tif (ret != 0) {\n-\t\tDEBUG(0,(__location__ \" Failed to get ctdb config\\n\"));\n+\t/* get our vnn */\n+\tctdb->vnn = ctdb_ctrl_getvnn(ctdb, timeval_zero(), CTDB_CURRENT_NODE);\n+\tif (ctdb->vnn == (uint32_t)-1) {\n+\t\tDEBUG(0,(__location__ \" Failed to get ctdb vnn\\n\"));\n \t\ttalloc_free(ctdb);\n \t\treturn NULL;\n \t}\n\n=== modified file 'common/ctdb_client.c'\n--- a/common/ctdb_client.c\t2007-05-23 04:50:41 +0000\n+++ b/common/ctdb_client.c\t2007-05-23 05:18:30 +0000\n@@ -469,9 +469,6 @@\n \t/* now we can go into the normal wait routine, as the reply packet\n \t   will update the ctdb->num_connected variable */\n \tctdb_daemon_connect_wait(ctdb);\n-\n-\t/* get other config variables */\n-\tctdb_ctrl_get_config(ctdb);\n }\n \n /*\n@@ -745,7 +742,7 @@\n \n \t/* semi-async operation */\n \ttimed_out = 0;\n-\tif (timeout) {\n+\tif (timeout && !timeval_is_zero(timeout)) {\n \t\tevent_add_timed(ctdb->ev, state, *timeout, timeout_func, &timed_out);\n \t}\n \twhile ((state->state == CTDB_CALL_WAIT)\n@@ -1236,38 +1233,6 @@\n }\n \n /*\n-  get ctdb config\n- */\n-int ctdb_ctrl_get_config(struct ctdb_context *ctdb)\n-{\n-\tint ret;\n-\tint32_t res;\n-\tTDB_DATA data;\n-\tstruct ctdb_context c;\n-\n-\tZERO_STRUCT(data);\n-\tret = ctdb_control(ctdb, CTDB_CURRENT_NODE, 0, CTDB_CONTROL_CONFIG, 0,\n-\t\t\t   data, ctdb, &data, &res, NULL, NULL);\n-\tif (ret != 0 || res != 0) {\n-\t\treturn -1;\n-\t}\n-\tif (data.dsize != sizeof(c)) {\n-\t\tDEBUG(0,(\"Bad config size %u - expected %u\\n\", data.dsize, sizeof(c)));\n-\t\treturn -1;\n-\t}\n-\n-\tc = *(struct ctdb_context *)data.dptr;\n-\ttalloc_free(data.dptr);\n-\n-\tctdb->num_nodes = c.num_nodes;\n-\tctdb->num_connected = c.num_connected;\n-\tctdb->vnn = c.vnn;\n-\tctdb->max_lacount = c.max_lacount;\n-\t\n-\treturn 0;\n-}\n-\n-/*\n   find the real path to a ltdb \n  */\n int ctdb_ctrl_getdbpath(struct ctdb_context *ctdb, struct timeval timeout, uint32_t destnode, uint32_t dbid, TALLOC_CTX *mem_ctx, \n\n=== modified file 'common/ctdb_daemon.c'\n--- a/common/ctdb_daemon.c\t2007-05-23 02:23:07 +0000\n+++ b/common/ctdb_daemon.c\t2007-05-23 05:18:30 +0000\n@@ -682,7 +682,11 @@\n \t\tclose(fd[0]);\n \t\tclose(ctdb->daemon.sd);\n \t\tctdb->daemon.sd = -1;\n-\t\tctdb_ctrl_get_config(ctdb);\n+\t\tctdb->vnn = ctdb_ctrl_getvnn(ctdb, timeval_zero(), CTDB_CURRENT_NODE);\n+\t\tif (ctdb->vnn == (uint32_t)-1) {\n+\t\t\tDEBUG(0,(__location__ \" Failed to get ctdb vnn\\n\"));\n+\t\t\treturn -1;\n+\t\t}\n \t\treturn 0;\n \t}\n \n\n"}