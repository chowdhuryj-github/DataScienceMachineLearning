{"category": "ham", "to_address": "samba-cvs@samba.org", "from_address": "Jelmer Vernooij <jelmer@samba.org>", "subject": "Rev 11874: Use single script for creating Samba 4 test\n\tenvironments. Add first test in\n\tfile:///home/jelmer/bzr.samba/SAMBA_4_0/", "body": "At file:///home/jelmer/bzr.samba/SAMBA_4_0/\n\n------------------------------------------------------------\nrevno: 11874\nrevision-id: jelmer@samba.org-20070416114214-76wce56xv0flln4c\nparent: svn-v2:22259@0c0555d6-39d7-0310-84fc-f1cc0bd64818-branches%2fSAMBA_4_0\ncommitter: Jelmer Vernooij \nbranch nick: SAMBA_4_0\ntimestamp: Mon 2007-04-16 13:42:14 +0200\nmessage:\n  Use single script for creating Samba 4 test environments. Add first test \n  that uses the member environment.\nremoved:\n  source/script/tests/mktestmember.sh svn-v2:22185@0c0555d6-39d7-0310-84fc-f1cc0bd64818-branches%2fSAMBA_4_0-source%2fscript%2ftests%2fmktestmember.sh\nrenamed:\n  source/script/tests/mktestdc.sh => source/script/tests/mksamba4server.sh svn-v2:21909@0c0555d6-39d7-0310-84fc-f1cc0bd64818-branches%2fSAMBA_4_0-source%2fscript%2ftests%2fmktestdc.sh\nmodified:\n  source/script/tests/Samba4.pm  svn-v2:21707@0c0555d6-39d7-0310-84fc-f1cc0bd64818-branches%2fSAMBA_4_0-source%2fscript%2ftests%2fSamba4.pm\n  source/script/tests/test_member.sh svn-v2:22185@0c0555d6-39d7-0310-84fc-f1cc0bd64818-branches%2fSAMBA_4_0-source%2fscript%2ftests%2ftest_member.sh\n  source/script/tests/tests_all.sh svn-v2:8525@0c0555d6-39d7-0310-84fc-f1cc0bd64818-branches%2fSAMBA_4_0-source%2fscript%2ftests%2ftests_all.sh\n  source/script/tests/mksamba4server.sh svn-v2:21909@0c0555d6-39d7-0310-84fc-f1cc0bd64818-branches%2fSAMBA_4_0-source%2fscript%2ftests%2fmktestdc.sh\n=== removed file 'source/script/tests/mktestmember.sh'\n--- a/source/script/tests/mktestmember.sh\t2007-04-12 08:33:35 +0000\n+++ b/source/script/tests/mktestmember.sh\t1970-01-01 00:00:00 +0000\n@@ -1,85 +0,0 @@\n-#!/bin/sh\n-\n-if [ $# -lt 4 ]\n-then\n-\techo \"$0 PREFIX DOMAIN USERNAME PASSWORD\"\n-\texit 1\n-fi\n-\n-PREFIX=$1\n-DOMAIN=$2\n-DC_USERNAME=$3\n-DC_PASSWORD=$4\n-shift 4\n-USERNAME=administrator\n-PASSWORD=humbolt\n-\n-SRCDIR=`pwd`\n-oldpwd=`dirname $0`/../..\n-mkdir -p $PREFIX \n-cd $PREFIX\n-PREFIX_ABS=`pwd`\n-ETCDIR=$PREFIX_ABS/etc\n-NCALRPCDIR=$PREFIX_ABS/ncalrpc\n-PIDDIR=$PREFIX_ABS/pid\n-PRIVATEDIR=$PREFIX_ABS/private\n-LOCKDIR=$PREFIX_ABS/lockdir\n-WINBINDD_SOCKET_DIR=$PREFIX_ABS/winbind_socket\n-CONFFILE=$ETCDIR/smb.conf\n-TMPDIR=$PREFIX_ABS/tmp\n-NETBIOSNAME=localmember\n-SMBD_LOGLEVEL=1\n-\n-mkdir -p $PRIVATEDIR $ETCDIR $PIDDIR $NCALRPCDIR $LOCKDIR $TMPDIR\n-\n-cat >$CONFFILE<&2\n-\n-$srcdir/bin/net join member $DOMAIN -U$DC_USERNAME%$DC_PASSWORD >&2 || {\n-\techo \"Join failed\"\n-\texit $?\n-}\n-\n-echo \"PREFIX_ABS=$PREFIX_ABS\"\n-echo \"PIDDIR=$PIDDIR\"\n-echo \"SERVER=$SERVER\"\n-echo \"NETBIOSNAME=$NETBIOSNAME\"\n-echo \"DOMAIN=$DOMAIN\"\n-echo \"USERNAME=$USERNAME\"\n-echo \"REALM=$REALM\"\n-echo \"PASSWORD=$PASSWORD\"\n-echo \"SRCDIR=$SRCDIR\"\n-echo \"PREFIX=$PREFIX\"\n-echo \"CONFFILE=$CONFFILE\"\n-echo \"WINBINDD_SOCKET_DIR=$WINBINDD_SOCKET_DIR\"\n-echo \"NCALRPCDIR=$NCALRPCDIR\"\n-echo \"CONFIGURATION=$CONFIGURATION\"\n\n=== renamed file 'source/script/tests/mktestdc.sh' => 'source/script/tests/mksamba4server.sh'\n--- a/source/script/tests/mktestdc.sh\t2007-04-12 10:25:01 +0000\n+++ b/source/script/tests/mksamba4server.sh\t2007-04-16 11:42:14 +0000\n@@ -17,7 +17,10 @@\n \tSMBD_LOGLEVEL=1\n fi\n \n-SERVER_ROLE=\"domain controller\"\n+if test -z \"$SERVER_ROLE\"; then\n+\tSERVER_ROLE=\"domain controller\"\n+fi\n+\n DOMAIN=SAMBADOMAIN\n USERNAME=administrator\n REALM=SAMBA.EXAMPLE.COM\n\n=== modified file 'source/script/tests/Samba4.pm'\n--- a/source/script/tests/Samba4.pm\t2007-04-12 12:45:41 +0000\n+++ b/source/script/tests/Samba4.pm\t2007-04-16 11:42:14 +0000\n@@ -140,15 +140,18 @@\n \tmy ($self, $prefix, $dcvars) = @_;\n \tmy %ret = ();\n \tprint \"PROVISIONING...\";\n-\topen(IN, \"$RealBin/mktestmember.sh $prefix $dcvars->{DOMAIN} $dcvars->{USERNAME} $dcvars->{PASSWORD}|\") or die(\"Unable to setup\");\n+\topen(IN, \"SERVER_ROLE=\\\"member server\\\" $RealBin/mksamba4server.sh $prefix|\") or die(\"Unable to setup\");\n \twhile () {\n \t\tdie (\"Error parsing `$_'\") unless (/^([A-Z0-9a-z_]+)=(.*)$/);\n \t\t$ret{$1} = $2;\n \t}\n \tclose(IN);\n \n+\tsystem(\"$self->{bindir}/net join $ret{CONFIGURATION} $dcvars->{DOMAIN} member -U$dcvars->{USERNAME}\\%$dcvars->{PASSWORD}\") or die(\"Join failed\");\n+\n \t$ret{SMBD_TEST_FIFO} = \"$prefix/smbd_test.fifo\";\n \t$ret{SMBD_TEST_LOG} = \"$prefix/smbd_test.log\";\n+\tprint \"$ret{DOMAIN}\\n\";\n \treturn \\%ret;\n }\n \n@@ -157,7 +160,7 @@\n \tmy ($self, $prefix) = @_;\n \tmy %ret = ();\n \tprint \"PROVISIONING...\";\n-\topen(IN, \"$RealBin/mktestdc.sh $prefix|\") or die(\"Unable to setup\");\n+\topen(IN, \"$RealBin/mksamba4server.sh $prefix|\") or die(\"Unable to setup\");\n \twhile () {\n \t\tdie (\"Error parsing `$_'\") unless (/^([A-Z0-9a-z_]+)=(.*)$/);\n \t\t$ret{$1} = $2;\n\n=== modified file 'source/script/tests/test_member.sh'\n--- a/source/script/tests/test_member.sh\t2007-04-12 08:33:35 +0000\n+++ b/source/script/tests/test_member.sh\t2007-04-16 11:42:14 +0000\n@@ -1,10 +1,6 @@\n #!/bin/sh\n \n-# add tests to this list as they start passing, so we test\n-# that they stay passing\n-ncacn_np_tests=\"RPC-ECHO\"\n-\n incdir=`dirname $0`\n . $incdir/test_functions.sh\n \n-plantest \"RPC-ECHO against member server\" member $VALGRIND bin/smbtorture $TORTURE_OPTIONS ncacn_np:\"\\$SERVER\" -U\"\\$USERNAME\"%\"\\$PASSWORD\" -W \\$DOMAIN $t \"$*\"\n+plantest \"RPC-ECHO against member server\" member $VALGRIND bin/smbtorture $TORTURE_OPTIONS ncacn_np:\"\\$SERVER\" -U\"\\$USERNAME\"%\"\\$PASSWORD\" -W \\$DOMAIN RPC-ECHO \"$*\"\n\n=== modified file 'source/script/tests/tests_all.sh'\n--- a/source/script/tests/tests_all.sh\t2007-04-16 04:55:52 +0000\n+++ b/source/script/tests/tests_all.sh\t2007-04-16 11:42:14 +0000\n@@ -14,3 +14,4 @@\n  $SRCDIR/script/tests/test_blackbox.sh $PREFIX\n  $SRCDIR/script/tests/test_simple.sh\n  $SRCDIR/script/tests/test_s3upgrade.sh $PREFIX/upgrade\n+ $SRCDIR/script/tests/test_member.sh\n\n"}