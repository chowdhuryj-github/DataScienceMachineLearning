{"category": "ham", "to_address": "samba-cvs@samba.org", "from_address": "vlendec@samba.org", "subject": "svn commit: samba r22766 - in branches/SAMBA_3_0/source: passdb\n\trpc_server utils", "body": "Author: vlendec\nDate: 2007-05-09 11:39:55 +0000 (Wed, 09 May 2007)\nNew Revision: 22766\n\nWebSVN: http://websvn.samba.org/cgi-bin/viewcvs.cgi?view=rev&root=samba&rev=22766\n\nLog:\nMerge from 3_0:\n\nr22412 | obnox | 2007-04-20 14:23:36 +0200 (Fr, 20 Apr 2007) | 5 lines\n\nAdd a \"deletelocalgroup\" subcommand to net sam.\n\nThanks to Karolin Seeger .\n\n\n\nModified:\n   branches/SAMBA_3_0/source/passdb/pdb_interface.c\n   branches/SAMBA_3_0/source/rpc_server/srv_samr_nt.c\n   branches/SAMBA_3_0/source/utils/net_sam.c\n\n\nChangeset:\nModified: branches/SAMBA_3_0/source/passdb/pdb_interface.c\n===================================================================\n--- branches/SAMBA_3_0/source/passdb/pdb_interface.c\t2007-05-09 00:52:46 UTC (rev 22765)\n+++ branches/SAMBA_3_0/source/passdb/pdb_interface.c\t2007-05-09 11:39:55 UTC (rev 22766)\n@@ -904,35 +904,28 @@\n \treturn pdb->del_groupmem(pdb, mem_ctx, group_rid, member_rid);\n }\n \n-BOOL pdb_find_alias(const char *name, DOM_SID *sid)\n-{\n-\tstruct pdb_methods *pdb = pdb_get_methods();\n-\treturn NT_STATUS_IS_OK(pdb->find_alias(pdb, name, sid));\n-}\n-\n NTSTATUS pdb_create_alias(const char *name, uint32 *rid)\n {\n \tstruct pdb_methods *pdb = pdb_get_methods();\n \treturn pdb->create_alias(pdb, name, rid);\n }\n \n-BOOL pdb_delete_alias(const DOM_SID *sid)\n+NTSTATUS pdb_delete_alias(const DOM_SID *sid)\n {\n \tstruct pdb_methods *pdb = pdb_get_methods();\n-\treturn NT_STATUS_IS_OK(pdb->delete_alias(pdb, sid));\n-\t\t\t\t\t\t\t    \n+\treturn pdb->delete_alias(pdb, sid);\n }\n \n-BOOL pdb_get_aliasinfo(const DOM_SID *sid, struct acct_info *info)\n+NTSTATUS pdb_get_aliasinfo(const DOM_SID *sid, struct acct_info *info)\n {\n \tstruct pdb_methods *pdb = pdb_get_methods();\n-\treturn NT_STATUS_IS_OK(pdb->get_aliasinfo(pdb, sid, info));\n+\treturn pdb->get_aliasinfo(pdb, sid, info);\n }\n \n-BOOL pdb_set_aliasinfo(const DOM_SID *sid, struct acct_info *info)\n+NTSTATUS pdb_set_aliasinfo(const DOM_SID *sid, struct acct_info *info)\n {\n \tstruct pdb_methods *pdb = pdb_get_methods();\n-\treturn NT_STATUS_IS_OK(pdb->set_aliasinfo(pdb, sid, info));\n+\treturn pdb->set_aliasinfo(pdb, sid, info);\n }\n \n NTSTATUS pdb_add_aliasmem(const DOM_SID *alias, const DOM_SID *member)\n\nModified: branches/SAMBA_3_0/source/rpc_server/srv_samr_nt.c\n===================================================================\n--- branches/SAMBA_3_0/source/rpc_server/srv_samr_nt.c\t2007-05-09 00:52:46 UTC (rev 22765)\n+++ branches/SAMBA_3_0/source/rpc_server/srv_samr_nt.c\t2007-05-09 11:39:55 UTC (rev 22766)\n@@ -1354,7 +1354,7 @@\n \tDOM_SID   sid;\n \tstruct acct_info info;\n \tuint32    acc_granted;\n-\tBOOL ret;\n+\tNTSTATUS status;\n \n \tr_u->status = NT_STATUS_OK;\n \n@@ -1368,11 +1368,11 @@\n \t}\n \n \tbecome_root();\n-\tret = pdb_get_aliasinfo(&sid, &info);\n+\tstatus = pdb_get_aliasinfo(&sid, &info);\n \tunbecome_root();\n \t\n-\tif ( !ret )\n-\t\treturn NT_STATUS_NO_SUCH_ALIAS;\n+\tif ( !NT_STATUS_IS_OK(status))\n+\t\treturn status;\n \n \tif ( !(r_u->ctr = TALLOC_ZERO_P( p->mem_ctx, ALIAS_INFO_CTR )) ) \n \t\treturn NT_STATUS_NO_MEMORY;\n@@ -4301,7 +4301,7 @@\n \tuint32 acc_granted;\n \tSE_PRIV se_rights;\n \tBOOL can_add_accounts;\n-\tBOOL ret;\n+\tNTSTATUS status;\n \tDISP_INFO *disp_info = NULL;\n \n \tDEBUG(5, (\"_samr_delete_dom_alias: %d\\n\", __LINE__));\n@@ -4340,15 +4340,15 @@\n \t\tbecome_root();\n \n \t/* Have passdb delete the alias */\n-\tret = pdb_delete_alias(&alias_sid);\n+\tstatus = pdb_delete_alias(&alias_sid);\n \t\n \tif ( can_add_accounts )\n \t\tunbecome_root();\n \t\t\n \t/******** END SeAddUsers BLOCK *********/\n \n-\tif ( !ret )\n-\t\treturn NT_STATUS_ACCESS_DENIED;\n+\tif ( !NT_STATUS_IS_OK(status))\n+\t\treturn status;\n \n \tif (!close_policy_hnd(p, &q_u->alias_pol))\n \t\treturn NT_STATUS_OBJECT_NAME_INVALID;\n@@ -4693,8 +4693,8 @@\n \tstruct acct_info info;\n \tALIAS_INFO_CTR *ctr;\n \tuint32 acc_granted;\n-\tBOOL ret;\n \tBOOL can_mod_accounts;\n+\tNTSTATUS status;\n \tDISP_INFO *disp_info = NULL;\n \n \tif (!get_lsa_policy_samr_sid(p, &q_u->alias_pol, &group_sid, &acc_granted, &disp_info))\n@@ -4709,18 +4709,16 @@\n \t/* get the current group information */\n \n \tbecome_root();\n-\tret = pdb_get_aliasinfo( &group_sid, &info );\n+\tstatus = pdb_get_aliasinfo( &group_sid, &info );\n \tunbecome_root();\n \n-\tif ( !ret ) {\n-\t\treturn NT_STATUS_NO_SUCH_ALIAS;\n-\t}\n+\tif ( !NT_STATUS_IS_OK(status))\n+\t\treturn status;\n \n \tswitch (ctr->level) {\n \t\tcase 2:\n \t\t{\n \t\t\tfstring group_name, acct_name;\n-\t\t\tNTSTATUS status;\n \n \t\t\t/* We currently do not support renaming groups in the\n \t\t\t   the BUILTIN domain.  Refer to util_builtin.c to understand \n@@ -4776,18 +4774,17 @@\n         if ( can_mod_accounts )\n                 become_root();\n \n-        ret = pdb_set_aliasinfo( &group_sid, &info );\n+        status = pdb_set_aliasinfo( &group_sid, &info );\n \n         if ( can_mod_accounts )\n                 unbecome_root();\n \n         /******** End SeAddUsers BLOCK *********/\n \n-\tif (ret) {\n+\tif (NT_STATUS_IS_OK(status))\n \t\tforce_flush_samr_cache(disp_info);\n-\t}\n \n-\treturn ret ? NT_STATUS_OK : NT_STATUS_ACCESS_DENIED;\n+\treturn status;\n }\n \n /*********************************************************************\n\nModified: branches/SAMBA_3_0/source/utils/net_sam.c\n===================================================================\n--- branches/SAMBA_3_0/source/utils/net_sam.c\t2007-05-09 00:52:46 UTC (rev 22765)\n+++ branches/SAMBA_3_0/source/utils/net_sam.c\t2007-05-09 11:39:55 UTC (rev 22766)\n@@ -580,7 +580,7 @@\n \tDOM_SID sid;\n         enum lsa_SidType type;\n         const char *dom, *name;\n-\tint ret;\n+\tNTSTATUS status;\n \n \tif (argc != 1) {\n \t\td_fprintf(stderr, \"usage: net sam deletelocalgroup \\n\");\n@@ -589,7 +589,7 @@\n \n \tif (!lookup_name(tmp_talloc_ctx(), argv[0], LOOKUP_NAME_ISOLATED,\n \t\t\t &dom, &name, &sid, &type)) {\n-\t\td_fprintf(stderr, \"Could not find name %s.\\n\", argv[0]);\n+\t\td_fprintf(stderr, \"Could not find %s.\\n\", argv[0]);\n \t\treturn -1;\n \t}\n \n@@ -599,12 +599,13 @@\n \t\treturn -1;\n \t}\n \n-\tret = pdb_delete_alias(&sid);\n+\tstatus = pdb_delete_alias(&sid);\n \n-\tif ( !ret ) {\n-\t\td_fprintf(stderr, \"Could not delete local group %s.\\n\", argv[0]);\n-\t\treturn -1;\n-\t}\n+\tif (!NT_STATUS_IS_OK(status)) {\n+                d_fprintf(stderr, \"Deleting local group %s failed with %s\\n\",\n+                          argv[0], nt_errstr(status));\n+                return -1;\n+        }\n \n \td_printf(\"Deleted local group %s.\\n\", argv[0]);\n \n\n"}