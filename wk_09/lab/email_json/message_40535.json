{"category": "ham", "to_address": "Volker.Lendecke@SerNet.DE", "from_address": "James Peach <jpeach@samba.org>", "subject": "Re: idle_timeout processing in the parent smbd?", "body": "On 30/05/2007, at 6:17 AM, Volker Lendecke wrote:\n\n> Hi, James!\n>\n> For the clustering I need to add event loop processing to\n> the parent smbd listener. This conflicts with your new\n> handling of the idle_timeout variable. If the select exits\n> without an active fd after the idle timeout, the parent\n> exits.\n\nIt only exits if there are no clients. If there are no clients, we  \nare idle and we have an idle timeout set, then exiting is the right  \nthing to do.\n\n> With timed events in, this is not right anymore.\n\nNot sure about this. I think this depends on how you define idleness,  \nsee below.\n\n> I'm going to deactivate the exit() for now, this needs to\n> become a timed event.\n\nI don't see how this can be a timed event.\n\nThe criteria for exiting is a period of idleness. You could define  \nidleness to be a period without any events, but a better definition  \nwould be a period without any clients. If running any old event was  \nenough to be \"not idle\", then your idle timeout would be completely  \nunreliable due to the installation of timed events by parts of the  \nserver that aren't at all related.\n\nSince only the launchd socket initialisation path sets the idle  \ntimeout, we could do something like this:\n\npony:~/samba/svn/branches/SAMBA_3_0/source jpeach$ svn diff smbd/ \nserver.c\nIndex: smbd/server.c\n===================================================================\n--- smbd/server.c       (revision 23294)\n+++ smbd/server.c       (working copy)\n@@ -434,23 +434,19 @@\n                         continue;\n                 }\n-               if (run_events(smbd_event_context(), num, &r_fds,  \n&w_fds)) {\n-                       continue;\n-               }\n-\n-#if 0\n-               Deactivated for now, this needs to become a timed event\n-               vl\n-\n                 /* If the idle timeout fired and we don't have any  \nconnected\n                  * users, exit gracefully. We should be running  \nunder a process\n                  * controller that will restart us if necessry.\n                  */\n-               if (num == 0 && count_all_current_connections() == 0) {\n+               if (!timeval_is_zero(&idle_timeout) && num == 0 &&\n+                   count_all_current_connections() == 0) {\n                         exit_server_cleanly(\"idle timeout\");\n                 }\n-#endif\n+               if (run_events(smbd_event_context(), num, &r_fds,  \n&w_fds)) {\n+                       continue;\n+               }\n+\n                 /* check if we need to reload services */\n                 check_reload(time(NULL));\n\n\n--\nJames Peach | jpeach@samba.org\n\n\n"}