{"category": "ham", "to_address": "samba-cvs@samba.org", "from_address": "tridge@samba.org", "subject": "Rev 592: add some more path based operations that need wrapping in\n\thttp://samba.org/~tridge/3_0-ctdb", "body": "------------------------------------------------------------\nrevno: 592\nrevision-id: tridge@samba.org-20070616153906-4nky8hi3amons61l\nparent: tridge@samba.org-20070616151413-wzak0e57nd23qfpd\ncommitter: Andrew Tridgell \nbranch nick: s3-ctdb-tridge\ntimestamp: Sun 2007-06-17 01:39:06 +1000\nmessage:\n  add some more path based operations that need wrapping\nmodified:\n  source/modules/vfs_shadow_copy2.c vfs_shadow_copy2.c-20070616115727-8jw10u301cshsoqz-1\n=== modified file 'source/modules/vfs_shadow_copy2.c'\n--- a/source/modules/vfs_shadow_copy2.c\t2007-06-16 15:14:13 +0000\n+++ b/source/modules/vfs_shadow_copy2.c\t2007-06-16 15:39:06 +0000\n@@ -402,6 +402,63 @@\n         SHADOW2_NEXT(SET_NT_ACL, (handle, fsp, name, security_info_sent, psd), BOOL, False);\n }\n \n+static BOOL shadow_copy2_mkdir(vfs_handle_struct *handle,  const char *fname, mode_t mode)\n+{\n+        SHADOW2_NEXT(MKDIR, (handle, name, mode), BOOL, False);\n+}\n+\n+static BOOL shadow_copy2_rmdir(vfs_handle_struct *handle,  const char *fname)\n+{\n+        SHADOW2_NEXT(RMDIR, (handle, name), BOOL, False);\n+}\n+\n+static int shadow_copy2_chflags(vfs_handle_struct *handle, const char *fname, int flags)\n+{\n+        SHADOW2_NEXT(CHFLAGS, (handle, name, flags), int, -1);\n+}\n+\n+static ssize_t shadow_copy2_getxattr(vfs_handle_struct *handle,\n+\t\t\t\t  const char *fname, const char *aname, void *value, size_t size)\n+{\n+        SHADOW2_NEXT(GETXATTR, (handle, name, aname, value, size), ssize_t, -1);\n+}\n+\n+static ssize_t shadow_copy2_lgetxattr(vfs_handle_struct *handle,\n+\t\t\t\t      const char *fname, const char *aname, void *value, size_t size)\n+{\n+        SHADOW2_NEXT(LGETXATTR, (handle, name, aname, value, size), ssize_t, -1);\n+}\n+\n+static ssize_t shadow_copy2_listxattr(struct vfs_handle_struct *handle, const char *fname, \n+\t\t\t\t      char *list, size_t size)\n+{\n+\tSHADOW2_NEXT(LISTXATTR, (handle, name, list, size), ssize_t, -1);\n+}\n+\n+static int shadow_copy2_removexattr(struct vfs_handle_struct *handle, const char *fname, \n+\t\t\t\t    const char *aname)\n+{\n+\tSHADOW2_NEXT(REMOVEXATTR, (handle, name, aname), int, -1);\n+}\n+\n+static int shadow_copy2_lremovexattr(struct vfs_handle_struct *handle, const char *fname, \n+\t\t\t\t     const char *aname)\n+{\n+\tSHADOW2_NEXT(LREMOVEXATTR, (handle, name, aname), int, -1);\n+}\n+\n+static int shadow_copy2_setxattr(struct vfs_handle_struct *handle, const char *fname, \n+\t\t\t\t const char *aname, const void *value, size_t size, int flags)\n+{\n+\tSHADOW2_NEXT(SETXATTR, (handle, name, aname, value, size, flags), int, -1);\n+}\n+\n+static int shadow_copy2_lsetxattr(struct vfs_handle_struct *handle, const char *fname, \n+\t\t\t\t  const char *aname, const void *value, size_t size, int flags)\n+{\n+\tSHADOW2_NEXT(LSETXATTR, (handle, name, aname, value, size, flags), int, -1);\n+}\n+\n static int shadow_copy2_chmod_acl(vfs_handle_struct *handle,\n \t\t\t   const char *fname, mode_t mode)\n {\n@@ -483,22 +540,36 @@\n static vfs_op_tuple shadow_copy2_ops[] = {\n         {SMB_VFS_OP(shadow_copy2_opendir),  SMB_VFS_OP_OPENDIR,  SMB_VFS_LAYER_TRANSPARENT},\n \n+\t/* directory operations */\n+        {SMB_VFS_OP(shadow_copy2_mkdir),       SMB_VFS_OP_MKDIR,       SMB_VFS_LAYER_TRANSPARENT},\n+        {SMB_VFS_OP(shadow_copy2_rmdir),       SMB_VFS_OP_RMDIR,       SMB_VFS_LAYER_TRANSPARENT},\n+\n+\t/* xattr and flags operations */\n+        {SMB_VFS_OP(shadow_copy2_chflags),     SMB_VFS_OP_CHFLAGS,     SMB_VFS_LAYER_TRANSPARENT},\n+        {SMB_VFS_OP(shadow_copy2_getxattr),    SMB_VFS_OP_GETXATTR,    SMB_VFS_LAYER_TRANSPARENT},\n+        {SMB_VFS_OP(shadow_copy2_lgetxattr),   SMB_VFS_OP_LGETXATTR,   SMB_VFS_LAYER_TRANSPARENT},\n+        {SMB_VFS_OP(shadow_copy2_listxattr),   SMB_VFS_OP_LISTXATTR,   SMB_VFS_LAYER_TRANSPARENT},\n+        {SMB_VFS_OP(shadow_copy2_removexattr), SMB_VFS_OP_REMOVEXATTR, SMB_VFS_LAYER_TRANSPARENT},\n+        {SMB_VFS_OP(shadow_copy2_lremovexattr),SMB_VFS_OP_LREMOVEXATTR,SMB_VFS_LAYER_TRANSPARENT},\n+        {SMB_VFS_OP(shadow_copy2_setxattr),    SMB_VFS_OP_SETXATTR,    SMB_VFS_LAYER_TRANSPARENT},\n+        {SMB_VFS_OP(shadow_copy2_lsetxattr),   SMB_VFS_OP_LSETXATTR,   SMB_VFS_LAYER_TRANSPARENT},\n+\n         /* File operations */\n-        {SMB_VFS_OP(shadow_copy2_open),     SMB_VFS_OP_OPEN,     SMB_VFS_LAYER_TRANSPARENT},\n-        {SMB_VFS_OP(shadow_copy2_rename),   SMB_VFS_OP_RENAME,   SMB_VFS_LAYER_TRANSPARENT},\n-        {SMB_VFS_OP(shadow_copy2_stat),     SMB_VFS_OP_STAT,     SMB_VFS_LAYER_TRANSPARENT},\n-        {SMB_VFS_OP(shadow_copy2_lstat),    SMB_VFS_OP_LSTAT,    SMB_VFS_LAYER_TRANSPARENT},\n-        {SMB_VFS_OP(shadow_copy2_fstat),    SMB_VFS_OP_FSTAT,    SMB_VFS_LAYER_TRANSPARENT},\n-        {SMB_VFS_OP(shadow_copy2_unlink),   SMB_VFS_OP_UNLINK,   SMB_VFS_LAYER_TRANSPARENT},\n-        {SMB_VFS_OP(shadow_copy2_chmod),    SMB_VFS_OP_CHMOD,    SMB_VFS_LAYER_TRANSPARENT},\n-        {SMB_VFS_OP(shadow_copy2_chown),    SMB_VFS_OP_CHOWN,    SMB_VFS_LAYER_TRANSPARENT},\n-        {SMB_VFS_OP(shadow_copy2_chdir),    SMB_VFS_OP_CHDIR,    SMB_VFS_LAYER_TRANSPARENT},\n-        {SMB_VFS_OP(shadow_copy2_ntimes),   SMB_VFS_OP_NTIMES,   SMB_VFS_LAYER_TRANSPARENT},\n-        {SMB_VFS_OP(shadow_copy2_symlink),  SMB_VFS_OP_SYMLINK,  SMB_VFS_LAYER_TRANSPARENT},\n-        {SMB_VFS_OP(shadow_copy2_readlink), SMB_VFS_OP_READLINK, SMB_VFS_LAYER_TRANSPARENT},\n-        {SMB_VFS_OP(shadow_copy2_link),     SMB_VFS_OP_LINK,     SMB_VFS_LAYER_TRANSPARENT},\n-        {SMB_VFS_OP(shadow_copy2_mknod),    SMB_VFS_OP_MKNOD,    SMB_VFS_LAYER_TRANSPARENT},\n-        {SMB_VFS_OP(shadow_copy2_realpath), SMB_VFS_OP_REALPATH, SMB_VFS_LAYER_TRANSPARENT},\n+        {SMB_VFS_OP(shadow_copy2_open),       SMB_VFS_OP_OPEN,     SMB_VFS_LAYER_TRANSPARENT},\n+        {SMB_VFS_OP(shadow_copy2_rename),     SMB_VFS_OP_RENAME,   SMB_VFS_LAYER_TRANSPARENT},\n+        {SMB_VFS_OP(shadow_copy2_stat),       SMB_VFS_OP_STAT,     SMB_VFS_LAYER_TRANSPARENT},\n+        {SMB_VFS_OP(shadow_copy2_lstat),      SMB_VFS_OP_LSTAT,    SMB_VFS_LAYER_TRANSPARENT},\n+        {SMB_VFS_OP(shadow_copy2_fstat),      SMB_VFS_OP_FSTAT,    SMB_VFS_LAYER_TRANSPARENT},\n+        {SMB_VFS_OP(shadow_copy2_unlink),     SMB_VFS_OP_UNLINK,   SMB_VFS_LAYER_TRANSPARENT},\n+        {SMB_VFS_OP(shadow_copy2_chmod),      SMB_VFS_OP_CHMOD,    SMB_VFS_LAYER_TRANSPARENT},\n+        {SMB_VFS_OP(shadow_copy2_chown),      SMB_VFS_OP_CHOWN,    SMB_VFS_LAYER_TRANSPARENT},\n+        {SMB_VFS_OP(shadow_copy2_chdir),      SMB_VFS_OP_CHDIR,    SMB_VFS_LAYER_TRANSPARENT},\n+        {SMB_VFS_OP(shadow_copy2_ntimes),     SMB_VFS_OP_NTIMES,   SMB_VFS_LAYER_TRANSPARENT},\n+        {SMB_VFS_OP(shadow_copy2_symlink),    SMB_VFS_OP_SYMLINK,  SMB_VFS_LAYER_TRANSPARENT},\n+        {SMB_VFS_OP(shadow_copy2_readlink),   SMB_VFS_OP_READLINK, SMB_VFS_LAYER_TRANSPARENT},\n+        {SMB_VFS_OP(shadow_copy2_link),       SMB_VFS_OP_LINK,     SMB_VFS_LAYER_TRANSPARENT},\n+        {SMB_VFS_OP(shadow_copy2_mknod),      SMB_VFS_OP_MKNOD,    SMB_VFS_LAYER_TRANSPARENT},\n+        {SMB_VFS_OP(shadow_copy2_realpath),   SMB_VFS_OP_REALPATH, SMB_VFS_LAYER_TRANSPARENT},\n \n         /* NT File ACL operations */\n         {SMB_VFS_OP(shadow_copy2_get_nt_acl), SMB_VFS_OP_GET_NT_ACL, SMB_VFS_LAYER_TRANSPARENT},\n\n"}