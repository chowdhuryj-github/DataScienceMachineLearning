{"category": "ham", "to_address": "samba-cvs@samba.org", "from_address": "jerry@samba.org", "subject": "svn commit: samba r23245 - in branches/SAMBA_3_0_26/source: .\n\tinclude rpc_server", "body": "Author: jerry\nDate: 2007-05-30 19:53:11 +0000 (Wed, 30 May 2007)\nNew Revision: 23245\n\nWebSVN: http://websvn.samba.org/cgi-bin/viewcvs.cgi?view=rev&root=samba&rev=23245\n\nLog:\nconvert the echo_AddOne() rpc call to use the generated stub\nModified:\n   branches/SAMBA_3_0_26/source/Makefile.in\n   branches/SAMBA_3_0_26/source/include/includes.h\n   branches/SAMBA_3_0_26/source/include/rpc_client.h\n   branches/SAMBA_3_0_26/source/include/smb.h\n   branches/SAMBA_3_0_26/source/rpc_server/srv_echo.c\n   branches/SAMBA_3_0_26/source/rpc_server/srv_echo_nt.c\n\n\nChangeset:\nModified: branches/SAMBA_3_0_26/source/Makefile.in\n===================================================================\n--- branches/SAMBA_3_0_26/source/Makefile.in\t2007-05-30 19:47:35 UTC (rev 23244)\n+++ branches/SAMBA_3_0_26/source/Makefile.in\t2007-05-30 19:53:11 UTC (rev 23245)\n@@ -230,7 +230,7 @@\n RPCCLIENT_NDR_OBJ = rpc_client/ndr.o\n \n LIBNDR_GEN_OBJ = librpc/gen_ndr/ndr_wkssvc.o librpc/gen_ndr/ndr_notify.o \\\n-\t\t librpc/gen_ndr/ndr_lsa.o\n+\t\t librpc/gen_ndr/ndr_lsa.o librpc/gen_ndr/ndr_echo.o\n \n RPC_PARSE_OBJ0 = rpc_parse/parse_prs.o rpc_parse/parse_misc.o\n \n@@ -334,6 +334,7 @@\n \t       rpc_client/cli_shutdown.o rpc_client/cli_dfs.o rpc_client/cli_echo.o\n \n LIBMSRPC_GEN_OBJ = librpc/gen_ndr/cli_wkssvc.o librpc/gen_ndr/cli_lsa.o \\\n+\t\t   librpc/gen_ndr/cli_echo.o \\\n \t\t   $(LIBNDR_GEN_OBJ) $(RPCCLIENT_NDR_OBJ)\n \n REGOBJS_OBJ = registry/reg_objects.o\n@@ -375,7 +376,7 @@\n RPC_PIPE_OBJ = rpc_server/srv_pipe_hnd.o \\\n                rpc_server/srv_pipe.o rpc_server/srv_lsa_hnd.o\n \n-RPC_ECHO_OBJ = rpc_server/srv_echo.o rpc_server/srv_echo_nt.o\n+RPC_ECHO_OBJ = rpc_server/srv_echo.o rpc_server/srv_echo_nt.o librpc/gen_ndr/srv_echo.o\n \n RPC_SERVER_OBJ = @RPC_STATIC@ $(RPC_PIPE_OBJ)\n \n\nModified: branches/SAMBA_3_0_26/source/include/includes.h\n===================================================================\n--- branches/SAMBA_3_0_26/source/include/includes.h\t2007-05-30 19:47:35 UTC (rev 23244)\n+++ branches/SAMBA_3_0_26/source/include/includes.h\t2007-05-30 19:53:11 UTC (rev 23245)\n@@ -692,6 +692,7 @@\n #include \"rpc_shutdown.h\"\n #include \"rpc_perfcount.h\"\n #include \"rpc_perfcount_defs.h\"\n+#include \"librpc/gen_ndr/echo.h\"\n #include \"librpc/gen_ndr/notify.h\"\n #include \"nt_printing.h\"\n #include \"idmap.h\"\n\nModified: branches/SAMBA_3_0_26/source/include/rpc_client.h\n===================================================================\n--- branches/SAMBA_3_0_26/source/include/rpc_client.h\t2007-05-30 19:47:35 UTC (rev 23244)\n+++ branches/SAMBA_3_0_26/source/include/rpc_client.h\t2007-05-30 19:53:11 UTC (rev 23245)\n@@ -23,6 +23,7 @@\n \n /* autogenerated client stubs */\n \n+#include \"librpc/gen_ndr/cli_echo.h\"\n #include \"librpc/gen_ndr/cli_lsa.h\"\n #include \"librpc/gen_ndr/cli_wkssvc.h\"\n \n\nModified: branches/SAMBA_3_0_26/source/include/smb.h\n===================================================================\n--- branches/SAMBA_3_0_26/source/include/smb.h\t2007-05-30 19:47:35 UTC (rev 23244)\n+++ branches/SAMBA_3_0_26/source/include/smb.h\t2007-05-30 19:53:11 UTC (rev 23245)\n@@ -201,6 +201,7 @@\n #define PI_WINREG\t\t6\n #define PI_SPOOLSS\t\t7\n #define PI_NETDFS\t\t8\n+#define PI_RPCECHO \t\t9\n #define PI_ECHO \t\t9\n #define PI_SHUTDOWN\t\t10\n #define PI_SVCCTL\t\t11\n\nModified: branches/SAMBA_3_0_26/source/rpc_server/srv_echo.c\n===================================================================\n--- branches/SAMBA_3_0_26/source/rpc_server/srv_echo.c\t2007-05-30 19:47:35 UTC (rev 23244)\n+++ branches/SAMBA_3_0_26/source/rpc_server/srv_echo.c\t2007-05-30 19:53:11 UTC (rev 23245)\n@@ -28,28 +28,28 @@\n #undef DBGC_CLASS\n #define DBGC_CLASS DBGC_RPC_SRV\n \n-static BOOL api_add_one(pipes_struct *p)\n+static BOOL proxy_echo_call(pipes_struct *p, uint8 opnum)\n {\n-\tECHO_Q_ADD_ONE q_u;\n-\tECHO_R_ADD_ONE r_u;\n+\tstruct api_struct *fns;\n+\tint n_fns;\n \n-\tprs_struct *data = &p->in_data.data;\n-\tprs_struct *rdata = &p->out_data.rdata;\n+\trpcecho_get_pipe_fns(&fns, &n_fns);\n \n-\tZERO_STRUCT(q_u);\n-\tZERO_STRUCT(r_u);\n-\t\n-\tif(!echo_io_q_add_one(\"\", &q_u, data, 0))\n+\tif (opnum >= n_fns)\n \t\treturn False;\n-\t\n-\t_echo_add_one(p, &q_u, &r_u);\n-\t\n-\tif(!echo_io_r_add_one(\"\", &r_u, rdata, 0))\n-\t\treturn False;\n \n-\treturn True;\n+\tif (fns[opnum].opnum != opnum) {\n+\t\tsmb_panic(\"ECHO function table not sorted\\n\");\n+\t}\n+\n+\treturn fns[opnum].fn(p);\n }\n \n+static BOOL api_add_one(pipes_struct *p)\n+{\n+\treturn proxy_echo_call( p, DCERPC_ECHO_ADDONE );\n+}\n+\n static BOOL api_echo_data(pipes_struct *p)\n {\n \tECHO_Q_ECHO_DATA q_u;\n\nModified: branches/SAMBA_3_0_26/source/rpc_server/srv_echo_nt.c\n===================================================================\n--- branches/SAMBA_3_0_26/source/rpc_server/srv_echo_nt.c\t2007-05-30 19:47:35 UTC (rev 23244)\n+++ branches/SAMBA_3_0_26/source/rpc_server/srv_echo_nt.c\t2007-05-30 19:53:11 UTC (rev 23245)\n@@ -30,11 +30,11 @@\n \n /* Add one to the input and return it */\n \n-void _echo_add_one(pipes_struct *p, ECHO_Q_ADD_ONE *q_u, ECHO_R_ADD_ONE *r_u)\n+void _echo_AddOne(pipes_struct *p, struct echo_AddOne *r )\n {\n \tDEBUG(10, (\"_echo_add_one\\n\"));\n \n-\tr_u->response = q_u->request + 1;\n+\t*r->out.out_data = r->in.in_data + 1;\t\n }\n \n /* Echo back an array of data */\n@@ -85,4 +85,58 @@\n \t\tr_u->data[i] = i & 0xff;\n }\n \n+void _echo_EchoData(pipes_struct *p, struct echo_EchoData *r)\n+{\n+\tp->rng_fault_state = True;\n+\treturn;\n+}\n+\n+void _echo_SinkData(pipes_struct *p, struct echo_SinkData *r)\n+{\n+\tp->rng_fault_state = True;\n+\treturn;\n+}\n+\n+void _echo_SourceData(pipes_struct *p, struct echo_SourceData *r)\n+{\n+\tp->rng_fault_state = True;\n+\treturn;\n+}\n+\n+void _echo_TestCall(pipes_struct *p, struct echo_TestCall *r)\n+{\n+\tp->rng_fault_state = True;\n+\treturn;\n+}\n+\n+NTSTATUS _echo_TestCall2(pipes_struct *p, struct echo_TestCall2 *r)\n+{\n+\tp->rng_fault_state = True;\n+\treturn NT_STATUS_OK;\n+}\n+\n+uint32 _echo_TestSleep(pipes_struct *p, struct echo_TestSleep *r)\n+{\n+\tp->rng_fault_state = True;\n+\treturn 0;\n+}\n+\n+void _echo_TestEnum(pipes_struct *p, struct echo_TestEnum *r)\n+{\n+\tp->rng_fault_state = True;\n+\treturn;\n+}\n+\n+void _echo_TestSurrounding(pipes_struct *p, struct echo_TestSurrounding *r)\n+{\n+\tp->rng_fault_state = True;\n+\treturn;\n+}\n+\n+uint16 _echo_TestDoublePointer(pipes_struct *p, struct echo_TestDoublePointer *r)\n+{\n+\tp->rng_fault_state = True;\n+\treturn 0;\n+}\n+\n #endif /* DEVELOPER */\n\n"}