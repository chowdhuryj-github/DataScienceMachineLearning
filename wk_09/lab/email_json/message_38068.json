{"category": "ham", "to_address": "samba-cvs@samba.org", "from_address": "tridge@samba.org", "subject": "svn commit: samba r23181 - in\n\tbranches/SAMBA_4_0/source/torture/raw: .", "body": "Author: tridge\nDate: 2007-05-29 08:22:45 +0000 (Tue, 29 May 2007)\nNew Revision: 23181\n\nWebSVN: http://websvn.samba.org/cgi-bin/viewcvs.cgi?view=rev&root=samba&rev=23181\n\nLog:\n\nprevent attempts to reopen the connection twice at the same time\n\nModified:\n   branches/SAMBA_4_0/source/torture/raw/lockbench.c\n   branches/SAMBA_4_0/source/torture/raw/openbench.c\n\n\nChangeset:\nModified: branches/SAMBA_4_0/source/torture/raw/lockbench.c\n===================================================================\n--- branches/SAMBA_4_0/source/torture/raw/lockbench.c\t2007-05-29 07:32:28 UTC (rev 23180)\n+++ branches/SAMBA_4_0/source/torture/raw/lockbench.c\t2007-05-29 08:22:45 UTC (rev 23181)\n@@ -54,6 +54,7 @@\n \tint lastcount;\n \tstruct smbcli_request *req;\n \tstruct smb_composite_connect reconnect;\n+\tstruct timed_event *te;\n \n \t/* these are used for reconnections */\n \tint dest_port;\n@@ -148,9 +149,10 @@\n \n \tstatus = smb_composite_connect_recv(ctx, state->mem_ctx);\n \tif (!NT_STATUS_IS_OK(status)) {\n-\t\tevent_add_timed(state->ev, state->mem_ctx, \n-\t\t\t\ttimeval_current_ofs(1,0), \n-\t\t\t\treopen_connection, state);\n+\t\ttalloc_free(state->te);\n+\t\tstate->te = event_add_timed(state->ev, state->mem_ctx, \n+\t\t\t\t\t    timeval_current_ofs(1,0), \n+\t\t\t\t\t    reopen_connection, state);\n \t\treturn;\n \t}\n \n@@ -218,9 +220,10 @@\n \t\t\tstate->tree = NULL;\n \t\t\tnum_connected--;\t\n \t\t\tDEBUG(0,(\"reopening connection to %s\\n\", state->dest_host));\n-\t\t\tevent_add_timed(state->ev, state->mem_ctx, \n-\t\t\t\t\ttimeval_current_ofs(1,0), \n-\t\t\t\t\treopen_connection, state);\n+\t\t\ttalloc_free(state->te);\n+\t\t\tstate->te = event_add_timed(state->ev, state->mem_ctx, \n+\t\t\t\t\t\t    timeval_current_ofs(1,0), \n+\t\t\t\t\t\t    reopen_connection, state);\n \t\t} else {\n \t\t\tDEBUG(0,(\"Lock failed - %s\\n\", nt_errstr(status)));\n \t\t\tlock_failed++;\n@@ -256,9 +259,10 @@\n \t\tstate->tree = NULL;\n \t\tnum_connected--;\t\n \t\tDEBUG(0,(\"reopening connection to %s\\n\", state->dest_host));\n-\t\tevent_add_timed(state->ev, state->mem_ctx, \n-\t\t\t\ttimeval_current_ofs(1,0), \n-\t\t\t\treopen_connection, state);\n+\t\ttalloc_free(state->te);\n+\t\tstate->te = event_add_timed(state->ev, state->mem_ctx, \n+\t\t\t\t\t    timeval_current_ofs(1,0), \n+\t\t\t\t\t    reopen_connection, state);\n \t}\n }\n \n\nModified: branches/SAMBA_4_0/source/torture/raw/openbench.c\n===================================================================\n--- branches/SAMBA_4_0/source/torture/raw/openbench.c\t2007-05-29 07:32:28 UTC (rev 23180)\n+++ branches/SAMBA_4_0/source/torture/raw/openbench.c\t2007-05-29 08:22:45 UTC (rev 23181)\n@@ -57,6 +57,7 @@\n \tstruct smbcli_request *req_open;\n \tstruct smbcli_request *req_close;\n \tstruct smb_composite_connect reconnect;\n+\tstruct timed_event *te;\n \n \t/* these are used for reconnections */\n \tint dest_port;\n@@ -81,9 +82,10 @@\n \n \tstatus = smb_composite_connect_recv(ctx, state->mem_ctx);\n \tif (!NT_STATUS_IS_OK(status)) {\n-\t\tevent_add_timed(state->ev, state->mem_ctx, \n-\t\t\t\ttimeval_current_ofs(1,0), \n-\t\t\t\treopen_connection, state);\n+\t\ttalloc_free(state->te);\n+\t\tstate->te = event_add_timed(state->ev, state->mem_ctx, \n+\t\t\t\t\t    timeval_current_ofs(1,0), \n+\t\t\t\t\t    reopen_connection, state);\n \t\treturn;\n \t}\n \n@@ -210,9 +212,10 @@\n \t\tstate->cli = NULL;\n \t\tnum_connected--;\t\n \t\tDEBUG(0,(\"reopening connection to %s\\n\", state->dest_host));\n-\t\tevent_add_timed(state->ev, state->mem_ctx, \n-\t\t\t\ttimeval_current_ofs(1,0), \n-\t\t\t\treopen_connection, state);\n+\t\ttalloc_free(state->te);\n+\t\tstate->te = event_add_timed(state->ev, state->mem_ctx, \n+\t\t\t\t\t    timeval_current_ofs(1,0), \n+\t\t\t\t\t    reopen_connection, state);\n \t\treturn;\n \t}\n \n@@ -262,9 +265,10 @@\n \t\tstate->cli = NULL;\n \t\tnum_connected--;\t\n \t\tDEBUG(0,(\"reopening connection to %s\\n\", state->dest_host));\n-\t\tevent_add_timed(state->ev, state->mem_ctx, \n-\t\t\t\ttimeval_current_ofs(1,0), \n-\t\t\t\treopen_connection, state);\n+\t\ttalloc_free(state->te);\n+\t\tstate->te = event_add_timed(state->ev, state->mem_ctx, \n+\t\t\t\t\t    timeval_current_ofs(1,0), \n+\t\t\t\t\t    reopen_connection, state);\n \t\treturn;\n \t}\n \n@@ -289,9 +293,10 @@\n \t\tstate->tree = NULL;\n \t\tnum_connected--;\t\n \t\tDEBUG(0,(\"reopening connection to %s\\n\", state->dest_host));\n-\t\tevent_add_timed(state->ev, state->mem_ctx, \n-\t\t\t\ttimeval_current_ofs(1,0), \n-\t\t\t\treopen_connection, state);\n+\t\ttalloc_free(state->te);\n+\t\tstate->te = event_add_timed(state->ev, state->mem_ctx, \n+\t\t\t\t\t    timeval_current_ofs(1,0), \n+\t\t\t\t\t    reopen_connection, state);\n \t}\n }\n \n\n"}