{"category": "ham", "to_address": "samba-cvs@samba.org", "from_address": "tridge@samba.org", "subject": "svn commit: samba r23020 - in branches/SAMBA_4_0/source/smb_server:\n\t. smb smb2", "body": "Author: tridge\nDate: 2007-05-20 09:44:03 +0000 (Sun, 20 May 2007)\nNew Revision: 23020\n\nWebSVN: http://websvn.samba.org/cgi-bin/viewcvs.cgi?view=rev&root=samba&rev=23020\n\nLog:\n\na better fix for the memory leak - this one doesn't stuff up spnego :)\n\nModified:\n   branches/SAMBA_4_0/source/smb_server/session.c\n   branches/SAMBA_4_0/source/smb_server/smb/sesssetup.c\n   branches/SAMBA_4_0/source/smb_server/smb2/sesssetup.c\n\n\nChangeset:\nModified: branches/SAMBA_4_0/source/smb_server/session.c\n===================================================================\n--- branches/SAMBA_4_0/source/smb_server/session.c\t2007-05-20 08:57:01 UTC (rev 23019)\n+++ branches/SAMBA_4_0/source/smb_server/session.c\t2007-05-20 09:44:03 UTC (rev 23020)\n@@ -136,6 +136,7 @@\n  * gensec_ctx is optional, but talloc_steal'ed when present\n  */\n struct smbsrv_session *smbsrv_session_new(struct smbsrv_connection *smb_conn,\n+\t\t\t\t\t  TALLOC_CTX *mem_ctx,\n \t\t\t\t\t  struct gensec_security *gensec_ctx)\n {\n \tstruct smbsrv_session *sess = NULL;\n@@ -144,7 +145,7 @@\n \t/* Ensure no vuid gets registered in share level security. */\n \tif (smb_conn->config.security == SEC_SHARE) return NULL;\n \n-\tsess = talloc_zero(smb_conn, struct smbsrv_session);\n+\tsess = talloc_zero(mem_ctx, struct smbsrv_session);\n \tif (!sess) return NULL;\n \tsess->smb_conn = smb_conn;\n \n\nModified: branches/SAMBA_4_0/source/smb_server/smb/sesssetup.c\n===================================================================\n--- branches/SAMBA_4_0/source/smb_server/smb/sesssetup.c\t2007-05-20 08:57:01 UTC (rev 23019)\n+++ branches/SAMBA_4_0/source/smb_server/smb/sesssetup.c\t2007-05-20 09:44:03 UTC (rev 23020)\n@@ -49,6 +49,8 @@\n {\n \tif (NT_STATUS_IS_OK(status)) {\n \t\treq->smb_conn->negotiate.done_sesssetup = True;\n+\t\t/* we need to keep the session long term */\n+\t\treq->session = talloc_steal(req->smb_conn, req->session);\n \t}\n \tsmbsrv_reply_sesssetup_send(req, sess, status);\n }\n@@ -71,7 +73,7 @@\n \tif (!NT_STATUS_IS_OK(status)) goto failed;\n \n \t/* allocate a new session */\n-\tsmb_sess = smbsrv_session_new(req->smb_conn, NULL);\n+\tsmb_sess = smbsrv_session_new(req->smb_conn, req, NULL);\n \tif (!smb_sess) {\n \t\tstatus = NT_STATUS_INSUFFICIENT_RESOURCES;\n \t\tgoto failed;\n@@ -166,7 +168,7 @@\n \tif (!NT_STATUS_IS_OK(status)) goto failed;\n \n \t/* allocate a new session */\n-\tsmb_sess = smbsrv_session_new(req->smb_conn, NULL);\n+\tsmb_sess = smbsrv_session_new(req->smb_conn, req, NULL);\n \tif (!smb_sess) {\n \t\tstatus = NT_STATUS_INSUFFICIENT_RESOURCES;\n \t\tgoto failed;\n@@ -339,6 +341,10 @@\n failed:\n \tstatus = auth_nt_status_squash(status);\n \tsmbsrv_sesssetup_backend_send(req, sess, status);\n+\tif (!NT_STATUS_IS_OK(status) && \n+\t    !NT_STATUS_EQUAL(status, NT_STATUS_MORE_PROCESSING_REQUIRED)) {\n+\t\ttalloc_free(smb_sess);\n+\t}\n }\n \n /*\n@@ -394,7 +400,7 @@\n \t\t}\n \n \t\t/* allocate a new session */\n-\t\tsmb_sess = smbsrv_session_new(req->smb_conn, gensec_ctx);\n+\t\tsmb_sess = smbsrv_session_new(req->smb_conn, req->smb_conn, gensec_ctx);\n \t\tif (!smb_sess) {\n \t\t\tstatus = NT_STATUS_INSUFFICIENT_RESOURCES;\n \t\t\tgoto failed;\n\nModified: branches/SAMBA_4_0/source/smb_server/smb2/sesssetup.c\n===================================================================\n--- branches/SAMBA_4_0/source/smb_server/smb2/sesssetup.c\t2007-05-20 08:57:01 UTC (rev 23019)\n+++ branches/SAMBA_4_0/source/smb_server/smb2/sesssetup.c\t2007-05-20 09:44:03 UTC (rev 23020)\n@@ -95,6 +95,10 @@\n failed:\n \treq->status = auth_nt_status_squash(status);\n \tsmb2srv_sesssetup_send(req, io);\n+\tif (!NT_STATUS_IS_OK(status) && !\n+\t    NT_STATUS_EQUAL(status, NT_STATUS_MORE_PROCESSING_REQUIRED)) {\n+\t\ttalloc_free(smb_sess);\n+\t}\n }\n \n static void smb2srv_sesssetup_backend(struct smb2srv_request *req, union smb_sesssetup *io)\n@@ -138,7 +142,7 @@\n \t\t}\n \n \t\t/* allocate a new session */\n-\t\tsmb_sess = smbsrv_session_new(req->smb_conn, gensec_ctx);\n+\t\tsmb_sess = smbsrv_session_new(req->smb_conn, req->smb_conn, gensec_ctx);\n \t\tif (!smb_sess) {\n \t\t\tstatus = NT_STATUS_INSUFFICIENT_RESOURCES;\n \t\t\tgoto failed;\n\n"}