{"category": "ham", "to_address": "samba-cvs@samba.org", "from_address": "tridge@samba.org", "subject": "Rev 227: added a hopcount in ctdb_call in\n\thttp://samba.org/~tridge/ctdb", "body": "------------------------------------------------------------\nrevno: 227\nrevision-id: tridge@samba.org-20070501032502-6fk64ptyeqjybf45\nparent: tridge@samba.org-20070430203455-hz83ozsdn4cp1krv\ncommitter: Andrew Tridgell \nbranch nick: tridge\ntimestamp: Tue 2007-05-01 13:25:02 +1000\nmessage:\n  added a hopcount in ctdb_call\nmodified:\n  common/ctdb_call.c             ctdb_call.c-20061128065342-to93h6eejj5kon81-1\n  common/ctdb_client.c           ctdb_client.c-20070411010216-3kd8v37k61steeya-1\n  common/ctdb_ltdb.c             ctdb_ltdb.c-20061128065342-to93h6eejj5kon81-2\n  include/ctdb_private.h         ctdb_private.h-20061117234101-o3qt14umlg9en8z0-13\n  tcp/tcp_connect.c              tcp_connect.c-20061128004937-x70q1cu5xzg5g2tm-1\n  tools/ctdb_control.c           ctdb_control.c-20070426122705-9ehj1l5lu2gn9kuj-1\n=== modified file 'common/ctdb_call.c'\n--- a/common/ctdb_call.c\t2007-04-29 14:19:40 +0000\n+++ b/common/ctdb_call.c\t2007-05-01 03:25:02 +0000\n@@ -170,9 +170,12 @@\n \tuint32_t lmaster = ctdb_lmaster(ctdb, &key);\n \tif (ctdb->vnn == lmaster) {\n \t\tc->hdr.destnode = header->dmaster;\n-\t} else {\n+\t} else if ((c->hopcount % CTDB_MAX_REDIRECT_COUNT) == 0) {\n \t\tc->hdr.destnode = lmaster;\n+\t} else {\n+\t\tc->hdr.destnode = header->dmaster;\n \t}\n+\tc->hopcount++;\n \tctdb_queue_packet(ctdb, &c->hdr);\n }\n \n@@ -449,6 +452,10 @@\n \t\treturn;\n \t}\n \n+\tif (c->hopcount > ctdb->status.max_hop_count) {\n+\t\tctdb->status.max_hop_count = c->hopcount;\n+\t}\n+\n \t/* if this nodes has done enough consecutive calls on the same record\n \t   then give them the record\n \t   or if the node requested an immediate migration\n@@ -704,6 +711,7 @@\n \tstate->c->flags         = call->flags;\n \tstate->c->db_id         = ctdb_db->db_id;\n \tstate->c->callid        = call->call_id;\n+\tstate->c->hopcount      = 0;\n \tstate->c->keylen        = call->key.dsize;\n \tstate->c->calldatalen   = call->call_data.dsize;\n \tmemcpy(&state->c->data[0], call->key.dptr, call->key.dsize);\n\n=== modified file 'common/ctdb_client.c'\n--- a/common/ctdb_client.c\t2007-04-30 13:31:40 +0000\n+++ b/common/ctdb_client.c\t2007-05-01 03:25:02 +0000\n@@ -333,6 +333,7 @@\n \tc->flags         = call->flags;\n \tc->db_id         = ctdb_db->db_id;\n \tc->callid        = call->call_id;\n+\tc->hopcount      = 0;\n \tc->keylen        = call->key.dsize;\n \tc->calldatalen   = call->call_data.dsize;\n \tmemcpy(&c->data[0], call->key.dptr, call->key.dsize);\n\n=== modified file 'common/ctdb_ltdb.c'\n--- a/common/ctdb_ltdb.c\t2007-04-30 20:34:55 +0000\n+++ b/common/ctdb_ltdb.c\t2007-05-01 03:25:02 +0000\n@@ -372,7 +372,7 @@\n \t\t\t\t CTDB_CONTROL_DB_ATTACH, CTDB_CTRL_FLAG_NOREPLY,\n \t\t\t\t indata, NULL, NULL);\n \n-\tDEBUG(0,(\"Attached to database '%s'\\n\", ctdb_db->db_path));\n+\tDEBUG(1,(\"Attached to database '%s'\\n\", ctdb_db->db_path));\n \n \t/* success */\n \treturn 0;\n\n=== modified file 'include/ctdb_private.h'\n--- a/include/ctdb_private.h\t2007-04-30 13:31:40 +0000\n+++ b/include/ctdb_private.h\t2007-05-01 03:25:02 +0000\n@@ -35,6 +35,7 @@\n #define CTDB_CURRENT_NODE  0xF0000001\n #define CTDB_BROADCAST_VNN 0xF0000002\n \n+#define CTDB_MAX_REDIRECT_COUNT 3\n \n /*\n   an installed ctdb remote call\n@@ -157,6 +158,7 @@\n \tuint32_t lockwait_calls;\n \tuint32_t pending_lockwait_calls;\n \tuint32_t __last_counter; /* hack for control_status_all */\n+\tuint32_t max_hop_count;\n \tdouble max_call_latency;\n \tdouble max_lockwait_latency;\n };\n@@ -338,6 +340,7 @@\n \tuint32_t flags;\n \tuint32_t db_id;\n \tuint32_t callid;\n+\tuint32_t hopcount;\n \tuint32_t keylen;\n \tuint32_t calldatalen;\n \tuint8_t data[1]; /* key[] followed by calldata[] */\n\n=== modified file 'tcp/tcp_connect.c'\n--- a/tcp/tcp_connect.c\t2007-04-30 20:34:55 +0000\n+++ b/tcp/tcp_connect.c\t2007-05-01 03:25:02 +0000\n@@ -262,7 +262,7 @@\n \t\t\t\t     ctdb->address.port);\n \tctdb->vnn = ctdb->nodes[i]->vnn;\n \tctdb->nodes[i]->flags |= NODE_FLAGS_CONNECTED;\n-\tDEBUG(0,(\"ctdb chose network address %s:%u vnn %u\\n\", \n+\tDEBUG(1,(\"ctdb chose network address %s:%u vnn %u\\n\", \n \t\t ctdb->address.address, \n \t\t ctdb->address.port, \n \t\t ctdb->vnn));\n\n=== modified file 'tools/ctdb_control.c'\n--- a/tools/ctdb_control.c\t2007-04-30 13:54:06 +0000\n+++ b/tools/ctdb_control.c\t2007-05-01 03:25:02 +0000\n@@ -99,6 +99,7 @@\n \tprintf(\" pending_calls           %u\\n\", s->pending_calls);\n \tprintf(\" lockwait_calls          %u\\n\", s->lockwait_calls);\n \tprintf(\" pending_lockwait_calls  %u\\n\", s->pending_lockwait_calls);\n+\tprintf(\" max_hop_count           %u\\n\", s->max_hop_count);\n \tprintf(\" max_call_latency        %.6f sec\\n\", s->max_call_latency);\n \tprintf(\" max_lockwait_latency    %.6f sec\\n\", s->max_lockwait_latency);\n }\n@@ -133,6 +134,8 @@\n \t\tfor (j=0;j<num_ints;j++) {\n \t\t\tv2[j] += v1[j];\n \t\t}\n+\t\tstatus.max_hop_count = \n+\t\t\tMAX(status.max_hop_count, s1.max_hop_count);\n \t\tstatus.max_call_latency = \n \t\t\tMAX(status.max_call_latency, s1.max_call_latency);\n \t\tstatus.max_lockwait_latency = \n\n"}