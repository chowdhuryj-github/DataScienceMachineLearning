{"category": "ham", "to_address": "samba-cvs@samba.org", "from_address": "tridge@samba.org", "subject": "Rev 274: added nonblocking varients of the two lockall functions to\n\ttdb in http://samba.org/~tridge/ctdb", "body": "------------------------------------------------------------\nrevno: 274\nrevision-id: tridge@samba.org-20070510074308-pfgaxsep5jj1v3w4\nparent: tridge@samba.org-20070510040648-0lwu9l2b8vl3zq86\ncommitter: Andrew Tridgell \nbranch nick: tridge\ntimestamp: Thu 2007-05-10 17:43:08 +1000\nmessage:\n  added nonblocking varients of the two lockall functions to tdb\nmodified:\n  lib/tdb/common/lock.c          lock.c-20070220022425-m1wibgjq7n5hahs6-7\n  lib/tdb/include/tdb.h          tdb.h-20070125040949-7t3f5zdl1q4z9hyv-101\n=== modified file 'lib/tdb/common/lock.c'\n--- a/lib/tdb/common/lock.c\t2007-05-05 07:14:33 +0000\n+++ b/lib/tdb/common/lock.c\t2007-05-10 07:43:08 +0000\n@@ -288,7 +288,7 @@\n \n \n /* lock/unlock entire database */\n-static int _tdb_lockall(struct tdb_context *tdb, int ltype)\n+static int _tdb_lockall(struct tdb_context *tdb, int ltype, int op)\n {\n \t/* There are no locks on read-only dbs */\n \tif (tdb->read_only || tdb->traverse_read)\n@@ -309,9 +309,11 @@\n \t\treturn TDB_ERRCODE(TDB_ERR_LOCK, -1);\n \t}\n \n-\tif (tdb->methods->tdb_brlock(tdb, FREELIST_TOP, ltype, F_SETLKW, \n+\tif (tdb->methods->tdb_brlock(tdb, FREELIST_TOP, ltype, op,\n \t\t\t\t     0, 4*tdb->header.hash_size)) {\n-\t\tTDB_LOG((tdb, TDB_DEBUG_ERROR, \"tdb_lockall failed (%s)\\n\", strerror(errno)));\n+\t\tif (op == F_SETLKW) {\n+\t\t\tTDB_LOG((tdb, TDB_DEBUG_ERROR, \"tdb_lockall failed (%s)\\n\", strerror(errno)));\n+\t\t}\n \t\treturn -1;\n \t}\n \n@@ -321,6 +323,8 @@\n \treturn 0;\n }\n \n+\n+\n /* unlock entire db */\n static int _tdb_unlockall(struct tdb_context *tdb, int ltype)\n {\n@@ -353,7 +357,13 @@\n /* lock entire database with write lock */\n int tdb_lockall(struct tdb_context *tdb)\n {\n-\treturn _tdb_lockall(tdb, F_WRLCK);\n+\treturn _tdb_lockall(tdb, F_WRLCK, F_SETLKW);\n+}\n+\n+/* lock entire database with write lock - nonblocking varient */\n+int tdb_lockall_nonblock(struct tdb_context *tdb)\n+{\n+\treturn _tdb_lockall(tdb, F_WRLCK, F_SETLK);\n }\n \n /* unlock entire database with write lock */\n@@ -365,7 +375,13 @@\n /* lock entire database with read lock */\n int tdb_lockall_read(struct tdb_context *tdb)\n {\n-\treturn _tdb_lockall(tdb, F_RDLCK);\n+\treturn _tdb_lockall(tdb, F_RDLCK, F_SETLKW);\n+}\n+\n+/* lock entire database with read lock - nonblock varient */\n+int tdb_lockall_read_nonblock(struct tdb_context *tdb)\n+{\n+\treturn _tdb_lockall(tdb, F_RDLCK, F_SETLK);\n }\n \n /* unlock entire database with read lock */\n\n=== modified file 'lib/tdb/include/tdb.h'\n--- a/lib/tdb/include/tdb.h\t2007-05-05 07:14:33 +0000\n+++ b/lib/tdb/include/tdb.h\t2007-05-10 07:43:08 +0000\n@@ -116,8 +116,10 @@\n int tdb_traverse_read(struct tdb_context *tdb, tdb_traverse_func fn, void *);\n int tdb_exists(struct tdb_context *tdb, TDB_DATA key);\n int tdb_lockall(struct tdb_context *tdb);\n+int tdb_lockall_nonblock(struct tdb_context *tdb);\n int tdb_unlockall(struct tdb_context *tdb);\n int tdb_lockall_read(struct tdb_context *tdb);\n+int tdb_lockall_read_nonblock(struct tdb_context *tdb);\n int tdb_unlockall_read(struct tdb_context *tdb);\n const char *tdb_name(struct tdb_context *tdb);\n int tdb_fd(struct tdb_context *tdb);\n\n"}