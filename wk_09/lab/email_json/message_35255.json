{"category": "ham", "to_address": "samba-cvs@samba.org", "from_address": "tridge@samba.org", "subject": "Rev 339: make ctdbd realtime if possible in\n\thttp://samba.org/~tridge/ctdb", "body": "------------------------------------------------------------\nrevno: 339\nrevision-id: tridge@samba.org-20070524045210-x9rjizzstayky7qu\nparent: tridge@samba.org-20070524034927-mdvxyva7cv1crrcy\ncommitter: Andrew Tridgell \nbranch nick: tridge\ntimestamp: Thu 2007-05-24 14:52:10 +1000\nmessage:\n  make ctdbd realtime if possible\nmodified:\n  common/ctdb_daemon.c           ctdb_daemon.c-20070409200331-3el1kqgdb9m4ib0g-1\n  common/ctdb_util.c             ctdb_util.c-20061128065342-to93h6eejj5kon81-3\n  configure.ac                   configure.ac-20061117234101-o3qt14umlg9en8z0-10\n  include/ctdb_private.h         ctdb_private.h-20061117234101-o3qt14umlg9en8z0-13\n=== modified file 'common/ctdb_daemon.c'\n--- a/common/ctdb_daemon.c\t2007-05-23 10:15:09 +0000\n+++ b/common/ctdb_daemon.c\t2007-05-24 04:52:10 +0000\n@@ -738,6 +738,9 @@\n \tblock_signal(SIGPIPE);\n \tblock_signal(SIGCHLD);\n \n+\t/* try to set us up as realtime */\n+\tctdb_set_realtime();\n+\n \t/* start the recovery daemon process */\n \tif (ctdb_start_recoverd(ctdb) != 0) {\n \t\tDEBUG(0,(\"Failed to start recovery daemon\\n\"));\n\n=== modified file 'common/ctdb_util.c'\n--- a/common/ctdb_util.c\t2007-05-23 10:15:09 +0000\n+++ b/common/ctdb_util.c\t2007-05-24 04:52:10 +0000\n@@ -194,3 +194,23 @@\n \treturn d;\n }\n \n+#if HAVE_SCHED_H\n+#include \n+#endif\n+\n+/*\n+  if possible, make this task real time\n+ */\n+void ctdb_set_realtime(void)\n+{\n+#if HAVE_SCHED_SETSCHEDULER\n+\tstruct sched_param p;\n+\tp.__sched_priority = 1;\n+\n+\tif (sched_setscheduler(getpid(), SCHED_FIFO, &p) == -1) {\n+\t\tDEBUG(0,(\"Unable to set scheduler to SCHED_FIFO (%s)\\n\", strerror(errno)));\n+\t} else {\n+\t\tDEBUG(0,(\"Set scheduler to SCHED_FIFO\\n\"));\n+\t}\n+#endif\n+}\n\n=== modified file 'configure.ac'\n--- a/configure.ac\t2007-05-14 23:42:52 +0000\n+++ b/configure.ac\t2007-05-24 04:52:10 +0000\n@@ -30,6 +30,9 @@\n m4_include(libevents.m4)\n m4_include(ib/config.m4)\n \n+AC_CHECK_HEADERS(sched.h)\n+AC_CHECK_FUNCS(sched_setscheduler)\n+\n AC_CACHE_CHECK([for sin_len in sock],ctdb_cv_HAVE_SOCK_SIN_LEN,[\n AC_TRY_COMPILE([#include \n #include \n\n=== modified file 'include/ctdb_private.h'\n--- a/include/ctdb_private.h\t2007-05-23 07:21:14 +0000\n+++ b/include/ctdb_private.h\t2007-05-24 04:52:10 +0000\n@@ -864,5 +864,6 @@\n \t\t\t       uint32_t destnode, uint32_t db_id, uint64_t rsn);\n int ctdb_ctrl_delete_low_rsn(struct ctdb_context *ctdb, struct timeval timeout, \n \t\t\t     uint32_t destnode, uint32_t db_id, uint64_t rsn);\n+void ctdb_set_realtime(void);\n \n #endif\n\n"}