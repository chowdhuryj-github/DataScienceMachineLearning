{"category": "ham", "to_address": "Jeremy Allison <jra@samba.org>", "from_address": "James Peach <jpeach@samba.org>", "subject": "Re: [PATCH 1/4] Make sure groups[0] is the effective gid on FreeBSD.", "body": "On Jun 7, 2007, at 9:49 PM, Jeremy Allison wrote:\n\n> On Thu, Jun 07, 2007 at 09:39:39PM -0700, Jeremy Allison wrote:\n>>\n>> What I'd like to see is a parallel implementation\n>> of the functions you want to change in the security\n>> context code, that only work for *BSD.\n>\n> One more thing (sorry for going on about this but\n> I'm really paranoid about this :-).\n\nNo worries. This is exactly why I posted the patches for review :)\n\n> I dislike the way you've added the new\n> apply_unix_token() call - I feel this is\n> the wrong way to do things.\n\nThere's 2 related issues in this patch set. The first is the BSD-style  \nchanges for setgroups, the second is the Darwin-specific changes to  \nthe order of credential operations.\n\nThere's really 2 parts to the security context switching. The first  \npart is managing the stack data structure, the second part is actually  \nswitching to the desired credential.\n\nThe current code intertwines these two parts in two places,  \nset_sec_ctx() and pop_sec_ctx(). I felt that splitting the credential  \nswitch into a separate function made this a lot clearer. There is  \nexactly one place where the credential is switched and the credential  \nswitching code is not mixed with the security context stack management  \ncode. The result is credential switching code that is easier to read,  \naudit and log.\n\n> What I'd like to see is a *BSD specific\n> version of sys_setgroups() that re-arranges\n> the groups as *BSD requires. I'm not\n> averse to changing the function interface\n> from it's current :\n>\n>\n> int sys_setgroups(int setlen, gid_t *gidset);\n>\n> to be :\n>\n> int sys_setgroups(gid_t primary_gid, int setlen, gid_t *gidset);\n>\n> as I think on *BSD you need to know the primary gid\n> for setgroups to work correctly.\n\nYep, I have a tree with a similar patch, but the Darwin initgroups  \nwrapper needs to be passed the UID you are switching to. Additionally,  \nfor Darwin the order of operations in the credential switch is  \nimportant. This means that I can't hide all of this behind  \nsys_setgroups().\n\nI would be very happy to split apply_unix_token into a separate Darwin  \nimplementation, if you would prefer that better. Perhaps it is poorly  \nnamed, maybe it should be:\n\n\tBOOL switch_to_credential(const UNIX_USER_TOKEN *ut)\n\n--\nJames Peach | jpeach@samba.org\n\n"}