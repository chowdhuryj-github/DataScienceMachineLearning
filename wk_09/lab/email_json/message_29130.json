{"category": "ham", "to_address": "samba-cvs@samba.org", "from_address": "tridge@samba.org", "subject": "Rev 298: we must not free the fde until after we no longer need the\n\tlock child in http://samba.org/~tridge/ctdb", "body": "------------------------------------------------------------\nrevno: 298\nrevision-id: tridge@samba.org-20070514040133-2ktprtc6t6161yy5\nparent: tridge@samba.org-20070514034901-vpwg24spu188ab97\ncommitter: Andrew Tridgell \nbranch nick: tridge\ntimestamp: Mon 2007-05-14 14:01:33 +1000\nmessage:\n  we must not free the fde until after we no longer need the lock child\nmodified:\n  common/ctdb_lockwait.c         ctdb_lockwait.c-20070416214118-n1aeonljj3vpdd9q-1\n=== modified file 'common/ctdb_lockwait.c'\n--- a/common/ctdb_lockwait.c\t2007-05-14 03:49:01 +0000\n+++ b/common/ctdb_lockwait.c\t2007-05-14 04:01:33 +0000\n@@ -51,14 +51,17 @@\n \tstruct tdb_context *tdb = h->ctdb_db->ltdb->tdb;\n \tTALLOC_CTX *tmp_ctx = talloc_new(ev);\n \n-\ttalloc_free(fde);\n-\n \tkey.dptr = talloc_memdup(tmp_ctx, key.dptr, key.dsize);\n \n \ttalloc_set_destructor(h, NULL);\n \tctdb_latency(&h->ctdb->status.max_lockwait_latency, h->start_time);\n \th->ctdb->status.pending_lockwait_calls--;\n \n+\t/* the fde needs to go away when the context is gone - when\n+\t   the fde goes away this implicitly closes the pipe, which\n+\t   kills the child holding the lock */\n+\ttalloc_steal(tmp_ctx, fde);\n+\n \ttdb_chainlock_mark(tdb, key);\n \tcallback(p);\n \ttdb_chainlock_unmark(tdb, key);\n\n"}