{"category": "ham", "to_address": "samba-cvs@samba.org", "from_address": "abartlet@samba.org", "subject": "svn commit: samba r23715 - in branches/SAMBA_4_0/source:\n\tscripting/libjs setup", "body": "Author: abartlet\nDate: 2007-07-05 00:34:11 +0000 (Thu, 05 Jul 2007)\nNew Revision: 23715\n\nWebSVN: http://websvn.samba.org/cgi-bin/viewcvs.cgi?view=rev&root=samba&rev=23715\n\nLog:\nMake the provision-backend script print out the exact commands to run,\nto set up the LDAP backend.\n\nAndrew Bartlett\n\nModified:\n   branches/SAMBA_4_0/source/scripting/libjs/provision.js\n   branches/SAMBA_4_0/source/setup/provision\n   branches/SAMBA_4_0/source/setup/provision-backend\n\n\nChangeset:\nModified: branches/SAMBA_4_0/source/scripting/libjs/provision.js\n===================================================================\n--- branches/SAMBA_4_0/source/scripting/libjs/provision.js\t2007-07-05 00:12:24 UTC (rev 23714)\n+++ branches/SAMBA_4_0/source/scripting/libjs/provision.js\t2007-07-05 00:34:11 UTC (rev 23715)\n@@ -448,7 +448,7 @@\n \tsubobj.DNSNAME      = sprintf(\"%s.%s\", \n \t\t\t\t      strlower(subobj.HOSTNAME), \n \t\t\t\t      subobj.DNSDOMAIN);\n-\trdn_list = split(\".\", subobj.DNSDOMAIN);\n+\tvar rdn_list = split(\".\", subobj.DNSDOMAIN);\n \tsubobj.DOMAINDN     = \"DC=\" + join(\",DC=\", rdn_list);\n \tsubobj.ROOTDN       = subobj.DOMAINDN;\n \tsubobj.CONFIGDN     = \"CN=Configuration,\" + subobj.ROOTDN;\n@@ -461,6 +461,8 @@\n \tsubobj.SECRETS_KEYTAB\t= paths.keytab;\n \n \tsubobj.LDAPDIR = paths.ldapdir;\n+\tvar ldap_path_list = split(\"/\", paths.ldapdir);\n+\tsubobj.LDAPI_URI = \"ldapi://\" + join(\"%2F\", ldap_path_list) + \"%2Fldapi\";\n \n \treturn true;\n }\n@@ -583,7 +585,7 @@\n \tvar modify_ok = setup_ldb_modify(\"provision_basedn_modify.ldif\", info, samdb);\n \tif (!modify_ok) {\n \t\tif (!add_ok) {\n-\t\t\tmessage(\"Failed to both add and modify \" + subobj.DOMAINDN + \" in target \" + subobj.DOMAINDN_LDB + \": \" + samdb.errstring() + \"\\n\");\n+\t\t\tmessage(\"%s\", \"Failed to both add and modify \" + subobj.DOMAINDN + \" in target \" + subobj.DOMAINDN_LDB + \": \" + samdb.errstring() + \"\\n\");\n \t\t\tmessage(\"Perhaps you need to run the provision script with the --ldap-base-dn option, and add this record to the backend manually\\n\"); \n \t\t};\n \t\tassert(modify_ok);\n@@ -595,7 +597,7 @@\n \tvar modify_ok = setup_ldb_modify(\"provision_configuration_basedn_modify.ldif\", info, samdb);\n \tif (!modify_ok) {\n \t\tif (!add_ok) {\n-\t\t\tmessage(\"Failed to both add and modify configuration dn: \" + samdb.errstring() + \"\\n\");\n+\t\t\tmessage(\"%s\", \"Failed to both add and modify \" + subobj.CONFIGDN + \" in target \" + subobj.CONFIGDN_LDB + \": \" + samdb.errstring() + \"\\n\");\n \t\t\tmessage(\"Perhaps you need to run the provision script with the --ldap-base-dn option, and add this record to the backend manually\\n\"); \n \t\t\tassert(modify_ok);\n \t\t}\n@@ -608,7 +610,7 @@\n \tvar modify_ok = setup_ldb_modify(\"provision_schema_basedn_modify.ldif\", info, samdb);\n \tif (!modify_ok) {\n \t\tif (!add_ok) {\n-\t\t\tmessage(\"Failed to both add and modify schema dn:\" + samdb.errstring() + \"\\n\");\n+\t\t\tmessage(\"%s\", \"Failed to both add and modify \" + subobj.SCHEMADN + \" in target \" + subobj.SCHEMADN_LDB + \": \" + samdb.errstring() + \"\\n\");\n \t\t\tmessage(\"Perhaps you need to run the provision script with the --ldap-base-dn option, and add this record to the backend manually\\n\"); \n \t\t\tassert(modify_ok);\n \t\t}\n\nModified: branches/SAMBA_4_0/source/setup/provision\n===================================================================\n--- branches/SAMBA_4_0/source/setup/provision\t2007-07-05 00:12:24 UTC (rev 23714)\n+++ branches/SAMBA_4_0/source/setup/provision\t2007-07-05 00:34:11 UTC (rev 23715)\n@@ -121,13 +121,19 @@\n var ldapbackend = (options[\"ldap-backend\"] != undefined);\n var ldapmodule = (options[\"ldap-module\"] != undefined);\n var partitions_only = (options[\"partitions-only\"] != undefined);\n+var paths = provision_default_paths(subobj);\n if (options[\"aci\"] != undefined) {\n \tmessage(\"set ACI: %s\\n\", subobj[\"ACI\"]);\n }\n \n message(\"set DOMAIN SID: %s\\n\", subobj[\"DOMAINSID\"]);\n \n+provision_fix_subobj(subobj, paths);\n+\n if (ldapbackend) {\n+\tif (options[\"ldap-backend\"] == \"ldapi\") {\n+\t\tsubobj.LDAPBACKEND = subobj.LDAPI_URI;\n+\t}\n \tif (!ldapmodule) {\n \t\tsubobj.LDAPMODULE = \"entryUUID\";\n \t}\n@@ -137,7 +143,7 @@\n \tsubobj.CONFIGDN_MOD2 = \",\" + subobj.LDAPMODULE + \",paged_searches\";\n \tsubobj.SCHEMADN_LDB = subobj.LDAPBACKEND;\n \tsubobj.SCHEMADN_MOD2 = \",\" + subobj.LDAPMODULE + \",paged_searches\";\n-\tmessage(\"LDAP module: %s backend: %s\\n\", subobj.LDAPMODULE, subobj.LDAPBACKEND);\n+\tmessage(\"LDAP module: %s on backend: %s\\n\", subobj.LDAPMODULE, subobj.LDAPBACKEND);\n }\n \n if (!provision_validate(subobj, message)) {\n@@ -146,7 +152,6 @@\n \n var system_session = system_session();\n var creds = options.get_credentials();\n-var paths = provision_default_paths(subobj);\n message(\"Provisioning for %s in realm %s\\n\", subobj.DOMAIN, subobj.REALM);\n message(\"Using administrator password: %s\\n\", subobj.ADMINPASS);\n if (ldapbase) {\n\nModified: branches/SAMBA_4_0/source/setup/provision-backend\n===================================================================\n--- branches/SAMBA_4_0/source/setup/provision-backend\t2007-07-05 00:12:24 UTC (rev 23714)\n+++ branches/SAMBA_4_0/source/setup/provision-backend\t2007-07-05 00:34:11 UTC (rev 23715)\n@@ -98,6 +98,7 @@\n \n var mapping;\n var ext;\n+var slapd_command;\n if (options[\"ldap-backend-type\"] == \"fedora-ds\") {\n \tmapping = \"schema-map-fedora-ds-1.0\";\n \text = \"ldif\";\n@@ -110,6 +111,8 @@\n \t}\n \tsetup_file(\"fedorads.inf\", message, subobj.LDAPDIR + \"/fedorads.inf\", subobj);\n \tsetup_file(\"fedorads-partitions.ldif\", message, subobj.LDAPDIR + \"/fedorads-partitions.ldif\", subobj);\n+\n+\tslapd_command = \"(see documentation)\";\n } else if (options[\"ldap-backend-type\"] == \"openldap\") {\n \tprovision_ldapbase(subobj, message, paths);\n \tmapping = \"schema-map-openldap-2.3\";\n@@ -133,10 +136,16 @@\n \tsys.mkdir(subobj.LDAPDBDIR + \"/bdb-logs\", 0700);\n \tsetup_file(\"DB_CONFIG\", message, subobj.LDAPDBDIR + \"/DB_CONFIG\", subobj);\n \tif (options[\"ldap-backend-port\"] != undefined) {\n-\t\tmessage(\"NOTE: OpenLDAP TCP ports are controlled on the command line, not in the generated config file\\n\");\n+\t\tmessage(\"\\nStart slapd with: \\n\");\n+\t\tslapd_command = \"slapd -f \" + subobj.LDAPDIR + \"/slapd.conf -h ldap://0.0.0.0:\" + options[\"ldap-backend-port\"] + \" -h \" + subobj.LDAPI_URI;\n+\t} else {\n+\t\tslapd_command = \"slapd -f \" + subobj.LDAPDIR + \"/slapd.conf -h \" + subobj.LDAPI_URI;\n \t}\n }\n-message(\"ad2oLschema --option=convert:target=\" + options[\"ldap-backend-type\"] + \" -I \" + lp.get(\"setup directory\") + \"/\" + mapping + \" -H tdb://\" + tmp_schema_ldb + \" -O \" + subobj.LDAPDIR + \"/backend-schema.\" + ext + \"\\n\");\n+var schema_command = \"ad2oLschema --option=convert:target=\" + options[\"ldap-backend-type\"] + \" -I \" + lp.get(\"setup directory\") + \"/\" + mapping + \" -H tdb://\" + tmp_schema_ldb + \" -O \" + subobj.LDAPDIR + \"/backend-schema.\" + ext;\n \n+message(\"\\nCreate a suitable schema file with:\\n%s\\n\", schema_command);\n+message(\"\\nStart slapd with: \\n%s\\n\", slapd_command);\n+\n message(\"All OK\\n\");\n return 0;\n\n"}