{"category": "ham", "to_address": "samba-cvs@samba.org", "from_address": "vlendec@samba.org", "subject": "svn commit: samba r23220 - in branches: SAMBA_3_0/source/include\n\tSAMBA_3_0/source/lib SAMBA_3_0/source/smbd\n\tSAMBA_3_0_26/source/include SAMBA_3_0_26/source/lib\n\tSAMBA_3_0_26/source/smbd", "body": "Author: vlendec\nDate: 2007-05-29 18:04:38 +0000 (Tue, 29 May 2007)\nNew Revision: 23220\n\nWebSVN: http://websvn.samba.org/cgi-bin/viewcvs.cgi?view=rev&root=samba&rev=23220\n\nLog:\nAdd traverse_read to dbwrap\n\nModified:\n   branches/SAMBA_3_0/source/include/dbwrap.h\n   branches/SAMBA_3_0/source/lib/dbwrap_file.c\n   branches/SAMBA_3_0/source/lib/dbwrap_tdb.c\n   branches/SAMBA_3_0/source/smbd/session.c\n   branches/SAMBA_3_0_26/source/include/dbwrap.h\n   branches/SAMBA_3_0_26/source/lib/dbwrap_file.c\n   branches/SAMBA_3_0_26/source/lib/dbwrap_tdb.c\n   branches/SAMBA_3_0_26/source/smbd/session.c\n\n\nChangeset:\nModified: branches/SAMBA_3_0/source/include/dbwrap.h\n===================================================================\n--- branches/SAMBA_3_0/source/include/dbwrap.h\t2007-05-29 17:57:52 UTC (rev 23219)\n+++ branches/SAMBA_3_0/source/include/dbwrap.h\t2007-05-29 18:04:38 UTC (rev 23220)\n@@ -38,6 +38,10 @@\n \t\t\tint (*f)(struct db_record *db,\n \t\t\t\t void *private_data),\n \t\t\tvoid *private_data);\n+\tint (*traverse_read)(struct db_context *db,\n+\t\t\t     int (*f)(struct db_record *db,\n+\t\t\t\t      void *private_data),\n+\t\t\t     void *private_data);\n \tint (*get_seqnum)(struct db_context *db);\n \tvoid *private_data;\n };\n\nModified: branches/SAMBA_3_0/source/lib/dbwrap_file.c\n===================================================================\n--- branches/SAMBA_3_0/source/lib/dbwrap_file.c\t2007-05-29 17:57:52 UTC (rev 23219)\n+++ branches/SAMBA_3_0/source/lib/dbwrap_file.c\t2007-05-29 18:04:38 UTC (rev 23220)\n@@ -367,6 +367,7 @@\n \tresult->private_data = ctx;\n \tresult->fetch_locked = db_file_fetch_locked;\n \tresult->traverse = db_file_traverse;\n+\tresult->traverse_read = db_file_traverse;\n \n \tctx->locked_record = NULL;\n \tif (!(ctx->dirname = talloc_strdup(ctx, name))) {\n\nModified: branches/SAMBA_3_0/source/lib/dbwrap_tdb.c\n===================================================================\n--- branches/SAMBA_3_0/source/lib/dbwrap_tdb.c\t2007-05-29 17:57:52 UTC (rev 23219)\n+++ branches/SAMBA_3_0/source/lib/dbwrap_tdb.c\t2007-05-29 18:04:38 UTC (rev 23220)\n@@ -174,6 +174,46 @@\n \treturn tdb_traverse(db_ctx->tdb, db_tdb_traverse_func, &ctx);\n }\n \n+static NTSTATUS db_tdb_store_deny(struct db_record *rec, TDB_DATA data, int flag)\n+{\n+\treturn NT_STATUS_MEDIA_WRITE_PROTECTED;\n+}\n+\n+static NTSTATUS db_tdb_delete_deny(struct db_record *rec)\n+{\n+\treturn NT_STATUS_MEDIA_WRITE_PROTECTED;\n+}\n+\n+static int db_tdb_traverse_read_func(TDB_CONTEXT *tdb, TDB_DATA kbuf, TDB_DATA dbuf,\n+\t\t\t\tvoid *private_data)\n+{\n+\tstruct db_tdb_traverse_ctx *ctx =\n+\t\t(struct db_tdb_traverse_ctx *)private_data;\n+\tstruct db_record rec;\n+\n+\trec.key = kbuf;\n+\trec.value = dbuf;\n+\trec.store = db_tdb_store_deny;\n+\trec.delete_rec = db_tdb_delete_deny;\n+\trec.private_data = ctx->db->private_data;\n+\n+\treturn ctx->f(&rec, ctx->private_data);\n+}\n+\n+static int db_tdb_traverse_read(struct db_context *db,\n+\t\t\t   int (*f)(struct db_record *rec, void *private_data),\n+\t\t\t   void *private_data)\n+{\n+\tstruct db_tdb_ctx *db_ctx =\n+\t\ttalloc_get_type_abort(db->private_data, struct db_tdb_ctx);\n+\tstruct db_tdb_traverse_ctx ctx;\n+\n+\tctx.db = db;\n+\tctx.f = f;\n+\tctx.private_data = private_data;\n+\treturn tdb_traverse_read(db_ctx->tdb, db_tdb_traverse_read_func, &ctx);\n+}\n+\n static int db_tdb_get_seqnum(struct db_context *db)\n \n {\n@@ -222,6 +262,7 @@\n \ttalloc_set_destructor(db_tdb, db_tdb_ctx_destr);\n \tresult->fetch_locked = db_tdb_fetch_locked;\n \tresult->traverse = db_tdb_traverse;\n+\tresult->traverse_read = db_tdb_traverse_read;\n \tresult->get_seqnum = db_tdb_get_seqnum;\n \treturn result;\n \n\nModified: branches/SAMBA_3_0/source/smbd/session.c\n===================================================================\n--- branches/SAMBA_3_0/source/smbd/session.c\t2007-05-29 17:57:52 UTC (rev 23219)\n+++ branches/SAMBA_3_0/source/smbd/session.c\t2007-05-29 18:04:38 UTC (rev 23220)\n@@ -275,7 +275,7 @@\n \t\treturn False;\n \t}\n \n-\tctx->traverse(ctx, fn, private_data);\n+\tctx->traverse_read(ctx, fn, private_data);\n \treturn True;\n }\n \n\nModified: branches/SAMBA_3_0_26/source/include/dbwrap.h\n===================================================================\n--- branches/SAMBA_3_0_26/source/include/dbwrap.h\t2007-05-29 17:57:52 UTC (rev 23219)\n+++ branches/SAMBA_3_0_26/source/include/dbwrap.h\t2007-05-29 18:04:38 UTC (rev 23220)\n@@ -38,6 +38,10 @@\n \t\t\tint (*f)(struct db_record *db,\n \t\t\t\t void *private_data),\n \t\t\tvoid *private_data);\n+\tint (*traverse_read)(struct db_context *db,\n+\t\t\t     int (*f)(struct db_record *db,\n+\t\t\t\t      void *private_data),\n+\t\t\t     void *private_data);\n \tint (*get_seqnum)(struct db_context *db);\n \tvoid *private_data;\n };\n\nModified: branches/SAMBA_3_0_26/source/lib/dbwrap_file.c\n===================================================================\n--- branches/SAMBA_3_0_26/source/lib/dbwrap_file.c\t2007-05-29 17:57:52 UTC (rev 23219)\n+++ branches/SAMBA_3_0_26/source/lib/dbwrap_file.c\t2007-05-29 18:04:38 UTC (rev 23220)\n@@ -367,6 +367,7 @@\n \tresult->private_data = ctx;\n \tresult->fetch_locked = db_file_fetch_locked;\n \tresult->traverse = db_file_traverse;\n+\tresult->traverse_read = db_file_traverse;\n \n \tctx->locked_record = NULL;\n \tif (!(ctx->dirname = talloc_strdup(ctx, name))) {\n\nModified: branches/SAMBA_3_0_26/source/lib/dbwrap_tdb.c\n===================================================================\n--- branches/SAMBA_3_0_26/source/lib/dbwrap_tdb.c\t2007-05-29 17:57:52 UTC (rev 23219)\n+++ branches/SAMBA_3_0_26/source/lib/dbwrap_tdb.c\t2007-05-29 18:04:38 UTC (rev 23220)\n@@ -172,6 +172,46 @@\n \treturn tdb_traverse(db_ctx->tdb, db_tdb_traverse_func, &ctx);\n }\n \n+static NTSTATUS db_tdb_store_deny(struct db_record *rec, TDB_DATA data, int flag)\n+{\n+\treturn NT_STATUS_MEDIA_WRITE_PROTECTED;\n+}\n+\n+static NTSTATUS db_tdb_delete_deny(struct db_record *rec)\n+{\n+\treturn NT_STATUS_MEDIA_WRITE_PROTECTED;\n+}\n+\n+static int db_tdb_traverse_read_func(TDB_CONTEXT *tdb, TDB_DATA kbuf, TDB_DATA dbuf,\n+\t\t\t\tvoid *private_data)\n+{\n+\tstruct db_tdb_traverse_ctx *ctx =\n+\t\t(struct db_tdb_traverse_ctx *)private_data;\n+\tstruct db_record rec;\n+\n+\trec.key = kbuf;\n+\trec.value = dbuf;\n+\trec.store = db_tdb_store_deny;\n+\trec.delete_rec = db_tdb_delete_deny;\n+\trec.private_data = ctx->db->private_data;\n+\n+\treturn ctx->f(&rec, ctx->private_data);\n+}\n+\n+static int db_tdb_traverse_read(struct db_context *db,\n+\t\t\t   int (*f)(struct db_record *rec, void *private_data),\n+\t\t\t   void *private_data)\n+{\n+\tstruct db_tdb_ctx *db_ctx =\n+\t\ttalloc_get_type_abort(db->private_data, struct db_tdb_ctx);\n+\tstruct db_tdb_traverse_ctx ctx;\n+\n+\tctx.db = db;\n+\tctx.f = f;\n+\tctx.private_data = private_data;\n+\treturn tdb_traverse_read(db_ctx->tdb, db_tdb_traverse_read_func, &ctx);\n+}\n+\n static int db_tdb_get_seqnum(struct db_context *db)\n \n {\n@@ -220,6 +260,7 @@\n \ttalloc_set_destructor(db_tdb, db_tdb_ctx_destr);\n \tresult->fetch_locked = db_tdb_fetch_locked;\n \tresult->traverse = db_tdb_traverse;\n+\tresult->traverse_read = db_tdb_traverse_read;\n \tresult->get_seqnum = db_tdb_get_seqnum;\n \treturn result;\n \n\nModified: branches/SAMBA_3_0_26/source/smbd/session.c\n===================================================================\n--- branches/SAMBA_3_0_26/source/smbd/session.c\t2007-05-29 17:57:52 UTC (rev 23219)\n+++ branches/SAMBA_3_0_26/source/smbd/session.c\t2007-05-29 18:04:38 UTC (rev 23220)\n@@ -272,7 +272,7 @@\n \t\treturn False;\n \t}\n \n-\tctx->traverse(ctx, fn, private_data);\n+\tctx->traverse_read(ctx, fn, private_data);\n \treturn True;\n }\n \n\n"}