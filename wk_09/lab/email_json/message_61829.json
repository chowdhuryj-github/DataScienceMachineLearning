{"category": "ham", "to_address": "samba-cvs@samba.org", "from_address": "tridge@samba.org", "subject": "svn commit: samba r23700 - in branches/SAMBA_4_0/source/smb_server:\n\t.", "body": "Author: tridge\nDate: 2007-07-04 05:16:19 +0000 (Wed, 04 Jul 2007)\nNew Revision: 23700\n\nWebSVN: http://websvn.samba.org/cgi-bin/viewcvs.cgi?view=rev&root=samba&rev=23700\n\nLog:\n\npre-open the sam in the parent smbd. This has the effect of loading\nthe schema. That stops us loading the schema for each new connection.\n\nIn future I would prefer to share a lot more of our ldb contexts with\nchildren. That will require a larger piece of surgery.\n\nModified:\n   branches/SAMBA_4_0/source/smb_server/smb_server.c\n\n\nChangeset:\nModified: branches/SAMBA_4_0/source/smb_server/smb_server.c\n===================================================================\n--- branches/SAMBA_4_0/source/smb_server/smb_server.c\t2007-07-04 05:15:06 UTC (rev 23699)\n+++ branches/SAMBA_4_0/source/smb_server/smb_server.c\t2007-07-04 05:16:19 UTC (rev 23700)\n@@ -32,6 +32,7 @@\n #include \"system/network.h\"\n #include \"lib/socket/netif.h\"\n #include \"param/share.h\"\n+#include \"dsdb/samdb/samdb.h\"\n \n static NTSTATUS smbsrv_recv_generic_request(void *private, DATA_BLOB blob)\n {\n@@ -192,7 +193,20 @@\n \treturn NT_STATUS_OK;\n }\n \n+\n /*\n+  pre-open some of our ldb databases, to prevent an explosion of memory usage\n+  when we fork\n+ */\n+static void smbsrv_preopen_ldb(struct task_server *task)\n+{\n+\t/* yes, this looks strange. It is a hack to preload the\n+\t   schema. I'd like to share most of the ldb context with the\n+\t   child too. That will come later */\n+\ttalloc_free(samdb_connect(task, NULL));\n+}\n+\n+/*\n   open the smb server sockets\n */\n static void smbsrv_task_init(struct task_server *task)\n@@ -220,6 +234,8 @@\n \t\tif (!NT_STATUS_IS_OK(status)) goto failed;\n \t}\n \n+\tsmbsrv_preopen_ldb(task);\n+\n \treturn;\n failed:\n \ttask_server_terminate(task, \"Failed to startup smb server task\");\t\n\n"}