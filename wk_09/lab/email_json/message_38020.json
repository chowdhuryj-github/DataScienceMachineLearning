{"category": "ham", "to_address": "samba-cvs@samba.org", "from_address": "tridge@samba.org", "subject": "Rev 379: merge from jim in http://samba.org/~tridge/ctdb", "body": "------------------------------------------------------------\nrevno: 379\nrevision-id: tridge@samba.org-20070529044629-f0jyw51efi8ypu9a\nparent: tridge@samba.org-20070529035841-sdafwb84qcxmqt79\nparent: jmcd@samba.org-20070528153804-zoljm3ceqi97vcmj\ncommitter: Andrew Tridgell \nbranch nick: tridge\ntimestamp: Tue 2007-05-29 14:46:29 +1000\nmessage:\n  merge from jim\nmodified:\n  packaging/RHEL/makerpms.sh     makerpms.sh-20070527204758-biuh7znabuwan3zn-4\n  packaging/RHEL/setup/ctdb.init ctdb.init-20070527204758-biuh7znabuwan3zn-6\n  packaging/RHEL/setup/ctdb.sysconfig ctdb.sysconfig-20070527204758-biuh7znabuwan3zn-7\n    ------------------------------------------------------------\n    revno: 364.1.3\n    merged: jmcd@samba.org-20070528153804-zoljm3ceqi97vcmj\n    parent: jmcd@samba.org-20070528124547-t59kx019nnlfq3wn\n    committer: jmcd@samba.org\n    branch nick: ctdb-jmcd\n    timestamp: Mon 2007-05-28 11:38:04 -0400\n    message:\n      Next round of packaging updates:\n      \n      - Create/delete source symlink as needed during rpm build\n      - init script updates:\n      \t- optional port, debuglevel, logfile\n      \t- autodetect logfile location if smbd exists\n      \t- build cluster_addresses file\n      \t- create tmp dbdir (Tridge, do you want this to be a fixed location instead?)\n    ------------------------------------------------------------\n    revno: 364.1.2\n    merged: jmcd@samba.org-20070528124547-t59kx019nnlfq3wn\n    parent: jmcd@samba.org-20070527204818-p00c8jct78tgaxvt\n    parent: jmcd@samba.org-20070528124519-1l1a23g76csuf8xq\n    committer: jmcd@samba.org\n    branch nick: ctdb-jmcd\n    timestamp: Mon 2007-05-28 08:45:47 -0400\n    message:\n      updates from tridge\n    ------------------------------------------------------------\n    revno: 364.2.1\n    merged: jmcd@samba.org-20070528124519-1l1a23g76csuf8xq\n    parent: tridge@samba.org-20070527145110-4dwpd6btx287elvc\n    parent: tridge@samba.org-20070528101145-v3hxch4bnxdhp7g7\n    committer: jmcd@samba.org\n    branch nick: ctdb\n    timestamp: Mon 2007-05-28 08:45:19 -0400\n    message:\n      updates from tridge\n=== modified file 'packaging/RHEL/makerpms.sh'\n--- a/packaging/RHEL/makerpms.sh\t2007-05-27 20:48:18 +0000\n+++ b/packaging/RHEL/makerpms.sh\t2007-05-28 15:38:04 +0000\n@@ -48,16 +48,20 @@\n popd\n \n pushd .\n-cd ../../../\n-chown -R ${USERID}.${GRPID} ctdb\n+cd ../../\n+BASEDIR=`basename $PWD`\n+cd ..\n+chown -R ${USERID}.${GRPID} $BASEDIR\n if [ ! -d ctdb-${VERSION} ]; then\n-\tln -s ctdb ctdb-${VERSION} || exit 1\n+\tln -s $BASEDIR ctdb-${VERSION} || exit 1\n+\tREMOVE_LN=$PWD/ctdb-$VERSION\n fi\n echo -n \"Creating ctdb-${VERSION}.tar.bz2 ... \"\n tar --exclude=.bzr --exclude .bzrignore --exclude packaging -cf - ctdb-${VERSION}/. | bzip2 > ${SRCDIR}/ctdb-${VERSION}.tar.bz2\n echo \"Done.\"\n if [ $? -ne 0 ]; then\n         echo \"Build failed!\"\n+\t[ ${REMOVE_LN} ] && rm $REMOVE_LN\n         exit 1\n fi\n \n@@ -78,4 +82,5 @@\n ${RPM} -ba --clean --rmsource $EXTRA_OPTIONS $SPECFILE\n \n echo \"$(basename $0): Done.\"\n+[ ${REMOVE_LN} ] && rm $REMOVE_LN\n \n\n=== modified file 'packaging/RHEL/setup/ctdb.init'\n--- a/packaging/RHEL/setup/ctdb.init\t2007-05-27 20:48:18 +0000\n+++ b/packaging/RHEL/setup/ctdb.init\t2007-05-28 15:38:04 +0000\n@@ -1,13 +1,9 @@\n #!/bin/sh\n #\n-# chkconfig: - 91 35\n-# description: Starts and stops the Samba smbd and nmbd daemons \\\n-#\t       used to provide SMB network services.\n+# chkconfig: - 90 36\n+# description: Starts and stops the clustered tdb daemon\n #\n-# pidfile: /var/run/samba/smbd.pid\n-# pidfile: /var/run/samba/nmbd.pid\n-# config:  /etc/samba/smb.conf\n-\n+# pidfile: /var/run/ctdbd/ctdbd.pid\n \n # Source function library.\n if [ -f /etc/init.d/functions ] ; then\n@@ -24,18 +20,48 @@\n # Source networking configuration.\n . /etc/sysconfig/network\n \n+# There is no \"default\" config so we must have this file with \n+# CLUSTER_NODES and PUBLIC_ADDRESSES\n if [ -f /etc/sysconfig/ctdb ]; then\n    . /etc/sysconfig/ctdb \n+   if [ -z $CLUSTER_NODES ] || [ -z $PUBLIC_ADDRESSES ]; then\n+       exit 0\n+   fi\n+else\n+    exit 0\n fi\n \n # Check that networking is up.\n [ ${NETWORKING} = \"no\" ] && exit 0\n \n-# Check that smb.conf exists.\n-[ -f /etc/samba/smb.conf ] || exit 0\n-\n-RETVAL=0\n-\n+\n+CLUSTER_BASEDIR=`dirname $CLUSTER_NODES`\n+CLUSTER_ADDRESSES=$CLUSTER_BASEDIR/cluster_addresses.txt\n+[ -z $CTDB_PORT ] && CTDB_PORT=9001\n+[ -z $DEBUGLEVEL ] && DEBUGLEVEL=0\n+if [ -z $LOGFILE ]; then\n+    LOGFILEBASE=`smbd -b | grep LOGFILEBASE | awk '{print $2}'`\n+    if [ -z $LOGFILEBASE ]; then\n+\techo \"must have LOGFILE specified or smbd installed\"\n+\treturn 0\n+    fi\n+    LOGFILE=$LOGFILEBASE/log.ctdb\n+fi\n+\n+# build the cluster addresses file\n+TMP_ADDRESSES=`mktemp -t cluster_addresses.XXXXXXXX`\n+rm -f $TMP_ADDRESSES\n+for a in `egrep '^[[:alnum:]]' $CLUSTER_NODES`; do\n+    echo \"$a:$CTDB_PORT\" >> $TMP_ADDRESSES\n+done\n+mv -f $TMP_ADDRESSES $CLUSTER_ADDRESSES\n+\n+# create the temporary local dbdir\n+DBDIR=`mktemp -td ctdb.XXXXXXXX`\n+CTDBOPTIONS=\"--nlist=$CLUSTER_ADDRESSES --public-addresses=$PUBLIC_ADDRESSES --public-interface=$PUBLIC_INTERFACE --dbdir=$DBDIR --logfile=$LOGFILE -d $DEBUGLEVEL\"\n+\n+echo ctdbd $CTDBOPTIONS\n+exit 0\n \n start() {\n \techo -n $\"Starting ctdbd services: \"\n\n=== modified file 'packaging/RHEL/setup/ctdb.sysconfig'\n--- a/packaging/RHEL/setup/ctdb.sysconfig\t2007-05-27 20:48:18 +0000\n+++ b/packaging/RHEL/setup/ctdb.sysconfig\t2007-05-28 15:38:04 +0000\n@@ -1,2 +1,8 @@\n # Options to ctdbd\n-CTDBDOPTIONS=\"--nlist=/etc/samba/cluster_addresses.txt --dbdir=/var/lock/samba/ctdb --logfile=/var/log/samba/log.ctdb --public-addresses=/etc/samba/public_addresses.txt --public-interface=eth0\"\n+CLUSTER_NODES=/etc/samba/cluster_nodes.txt\n+PUBLIC_ADDRESSES=/etc/samba/public_addresses.txt\n+PUBLIC_INTERFACE=eth0\n+#CTDB_PORT=9001\n+#LOGFILE=/var/log/samba/log.ctdb\n+#DEBUGLEVEL=0\n+\n\n"}