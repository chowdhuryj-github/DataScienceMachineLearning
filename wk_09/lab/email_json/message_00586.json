{"category": "ham", "to_address": "samba-cvs@samba.org", "from_address": "Jelmer Vernooij <jelmer@samba.org>", "subject": "Rev 11811: Actually use client.conf,\n\tdefer more code as far as possible. in\n\tfile:///home/jelmer/bzr.samba/SAMBA_4_0/", "body": "At file:///home/jelmer/bzr.samba/SAMBA_4_0/\n\n------------------------------------------------------------\nrevno: 11811\nrevision-id: jelmer@samba.org-20070409131517-82iejvs1yb3ja3er\nparent: svn-v2:22136@0c0555d6-39d7-0310-84fc-f1cc0bd64818-branches%2fSAMBA_4_0\ncommitter: Jelmer Vernooij \nbranch nick: SAMBA_4_0\ntimestamp: Mon 2007-04-09 15:15:17 +0200\nmessage:\n  Actually use client.conf, defer more code as far as possible.\nmodified:\n  source/script/tests/mktestdc.sh svn-v2:21909@0c0555d6-39d7-0310-84fc-f1cc0bd64818-branches%2fSAMBA_4_0-source%2fscript%2ftests%2fmktestdc.sh\n  source/script/tests/selftest.pl svn-v2:20693@0c0555d6-39d7-0310-84fc-f1cc0bd64818-branches%2fSAMBA_4_0-source%2fscript%2ftests%2fselftest.pl\n=== modified file 'source/script/tests/mktestdc.sh'\n--- a/source/script/tests/mktestdc.sh\t2007-04-09 00:53:05 +0000\n+++ b/source/script/tests/mktestdc.sh\t2007-04-09 13:15:17 +0000\n@@ -83,7 +83,6 @@\n \tserver max protocol = SMB2\n \tnotify:inotify = false\n \tldb:nosync = true\n-\n \tsystem:anonymous = true\n #We don't want to pass our self-tests if the PAC code is wrong\n \tgensec:require_pac = true\n@@ -273,8 +272,6 @@\n \n echo \"KRB5_CONFIG=$KRB5_CONFIG\"\n echo \"PREFIX_ABS=$PREFIX_ABS\"\n-echo \"CONFIGURATION=$CONFIGURATION\"\n-echo \"CONFFILE=$CONFFILE\"\n echo \"SLAPD_CONF=$SLAPD_CONF\"\n echo \"PIDDIR=$PIDDIR\"\n echo \"AUTH=$AUTH\"\n@@ -290,7 +287,9 @@\n echo \"SRCDIR=$SRCDIR\"\n echo \"PREFIX=$PREFIX\"\n echo \"LDAPDIR=$LDAPDIR\"\n+echo \"CONFFILE=$CONFFILE\"\n echo \"PROVISION_OPTIONS=$PROVISION_OPTIONS\"\n echo \"PROVISION_ACI=$PROVISION_ACI\"\n echo \"WINBINDD_SOCKET_DIR=$WINBINDD_SOCKET_DIR\"\n echo \"NCALRPCDIR=$NCALRPCDIR\"\n+echo \"CONFIGURATION=$CONFIGURATION\"\n\n=== modified file 'source/script/tests/selftest.pl'\n--- a/source/script/tests/selftest.pl\t2007-04-09 00:53:05 +0000\n+++ b/source/script/tests/selftest.pl\t2007-04-09 13:15:17 +0000\n@@ -427,15 +427,6 @@\n \tclose(SKIP);\n }\n \n-my $testenv_vars = $target->setup_env(\"dc\", \"$prefix/dc\", $socket_wrapper_dir);\n-\n-SocketWrapper::set_default_iface(6);\n-\n-foreach (\"PASSWORD\", \"DOMAIN\", \"SERVER\", \"CONFIGURATION\", \n-\t      \"USERNAME\", \"NETBIOSNAME\") {\n-\t$ENV{$_} = $testenv_vars->{$_};\n-}\n-\n my $interfaces = join(',', (\"127.0.0.6/8\", \n \t\t                 \"127.0.0.7/8\",\n \t\t\t\t\t\t \"127.0.0.8/8\",\n@@ -443,33 +434,36 @@\n \t\t\t\t\t\t \"127.0.0.10/8\",\n \t\t\t\t\t\t \"127.0.0.11/8\"));\n \n-\n+my $testenv_vars = $target->setup_env(\"dc\", \"$prefix/dc\", $socket_wrapper_dir);\n \n my $conffile = \"$prefix/client.conf\";\n+my $abs_srcdir = cwd();\n open(CF, \">$conffile\");\n print CF \"[global]\\n\";\n if (defined($ENV{VALGRIND})) {\n-\tprint CF \"iconv:native = true\\n\";\n+\tprint CF \"\\ticonv:native = true\\n\";\n } else {\n-\tprint CF \"iconv:native = false\\n\";\n+\tprint CF \"\\ticonv:native = false\\n\";\n }\n-print CF \"\n+print CF \n+\"\tnetbios name = localtest\n+\tnetbios aliases = localhost\n \tworkgroup = $testenv_vars->{DOMAIN}\n \trealm = $testenv_vars->{REALM}\n+\tpid directory = $testenv_vars->{PIDDIR}\n \tncalrpc dir = $testenv_vars->{NCALRPCDIR}\n-\tjs include = $srcdir/scripting/libjs\n+\tjs include = $abs_srcdir/scripting/libjs\n \twinbindd socket directory = $testenv_vars->{WINBINDD_SOCKET_DIR}\n \tname resolve order = bcast\n \tinterfaces = 127.0.0.1/8\n-\tpanic action = $srcdir/script/gdb_backtrace \\%PID\\% \\%PROG\\%\n+\tpanic action = $abs_srcdir/script/gdb_backtrace \\%PID\\% \\%PROG\\%\n \tmax xmit = 32K\n \tnotify:inotify = false\n \tldb:nosync = true\n \tsystem:anonymous = true\n #We don't want to pass our self-tests if the PAC code is wrong\n-\ttorture:basedir = st\n+\ttorture:basedir = ./st\n \tgensec:require_pac = true\n-\tpid directory = $testenv_vars->{PIDDIR}\n \";\n close(CF);\n \n@@ -486,9 +480,14 @@\n $ENV{TORTURE_OPTIONS} = join(' ', @torture_options);\n print \"OPTIONS $ENV{TORTURE_OPTIONS}\\n\";\n \n+foreach (\"PASSWORD\", \"DOMAIN\", \"SERVER\", \"USERNAME\", \"NETBIOSNAME\") {\n+\t$ENV{$_} = $testenv_vars->{$_};\n+}\n+\n my @todo = ();\n \n my $testsdir = \"$srcdir/script/tests\";\n+$ENV{CONFIGURATION} = \"--configfile=$conffile\";\n \n if ($opt_quick) {\n \topen(IN, \"$testsdir/tests_quick.sh|\");\n@@ -520,6 +519,8 @@\n \n $ENV{KRB5_CONFIG} = $testenv_vars->{KRB5_CONFIG};\n \n+SocketWrapper::set_default_iface(6);\n+\n if ($opt_testenv) {\n \t$ENV{PIDDIR} = $testenv_vars->{PIDDIR};\n \tmy $term = ($ENV{TERM} or \"xterm\");\n\n"}