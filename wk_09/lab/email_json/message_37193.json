{"category": "ham", "to_address": "samba-cvs@samba.org", "from_address": "vlendec@samba.org", "subject": "svn commit: samba r23169 - in branches: SAMBA_3_0/source/locking\n\tSAMBA_3_0_26/source/locking", "body": "Author: vlendec\nDate: 2007-05-27 17:12:08 +0000 (Sun, 27 May 2007)\nNew Revision: 23169\n\nWebSVN: http://websvn.samba.org/cgi-bin/viewcvs.cgi?view=rev&root=samba&rev=23169\n\nLog:\nMerge 535 of Tridge's bzr tree:\n\n  store the right data after cleaning lock records. This fixes\n  RAW-BENCH-LOCK after a recovery on a cluster\n\n\nModified:\n   branches/SAMBA_3_0/source/locking/brlock.c\n   branches/SAMBA_3_0_26/source/locking/brlock.c\n\n\nChangeset:\nModified: branches/SAMBA_3_0/source/locking/brlock.c\n===================================================================\n--- branches/SAMBA_3_0/source/locking/brlock.c\t2007-05-27 16:34:49 UTC (rev 23168)\n+++ branches/SAMBA_3_0/source/locking/brlock.c\t2007-05-27 17:12:08 UTC (rev 23169)\n@@ -1482,8 +1482,11 @@\n \t}\n \n \tif (orig_num_locks != num_locks) {\n-\t\tif (rec->value.dsize) {\n-\t\t\trec->store(rec, rec->value, TDB_REPLACE);\n+\t\tif (num_locks) {\n+\t\t\tTDB_DATA data;\n+\t\t\tdata.dptr = (uint8_t *)locks;\n+\t\t\tdata.dsize = num_locks*sizeof(struct lock_struct);\n+\t\t\trec->store(rec, data, TDB_REPLACE);\n \t\t} else {\n \t\t\trec->delete_rec(rec);\n \t\t}\n\nModified: branches/SAMBA_3_0_26/source/locking/brlock.c\n===================================================================\n--- branches/SAMBA_3_0_26/source/locking/brlock.c\t2007-05-27 16:34:49 UTC (rev 23168)\n+++ branches/SAMBA_3_0_26/source/locking/brlock.c\t2007-05-27 17:12:08 UTC (rev 23169)\n@@ -1482,8 +1482,11 @@\n \t}\n \n \tif (orig_num_locks != num_locks) {\n-\t\tif (rec->value.dsize) {\n-\t\t\trec->store(rec, rec->value, TDB_REPLACE);\n+\t\tif (num_locks) {\n+\t\t\tTDB_DATA data;\n+\t\t\tdata.dptr = (uint8_t *)locks;\n+\t\t\tdata.dsize = num_locks*sizeof(struct lock_struct);\n+\t\t\trec->store(rec, data, TDB_REPLACE);\n \t\t} else {\n \t\t\trec->delete_rec(rec);\n \t\t}\n\n"}