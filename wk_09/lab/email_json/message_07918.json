{"category": "ham", "to_address": "samba-cvs@samba.org", "from_address": "metze@samba.org", "subject": "svn commit: samba r22313 - in branches/SAMBA_3_0/source/nsswitch: .", "body": "Author: metze\nDate: 2007-04-17 16:06:20 +0000 (Tue, 17 Apr 2007)\nNew Revision: 22313\n\nWebSVN: http://websvn.samba.org/cgi-bin/viewcvs.cgi?view=rev&root=samba&rev=22313\n\nLog:\nas discussed with simo:\n\nremove the only usage of backup_tdb() in samba3.\nAs backup_tdb() will go completely soon.\n\nmetze\nModified:\n   branches/SAMBA_3_0/source/nsswitch/idmap_tdb.c\n\n\nChangeset:\nModified: branches/SAMBA_3_0/source/nsswitch/idmap_tdb.c\n===================================================================\n--- branches/SAMBA_3_0/source/nsswitch/idmap_tdb.c\t2007-04-17 15:55:08 UTC (rev 22312)\n+++ branches/SAMBA_3_0/source/nsswitch/idmap_tdb.c\t2007-04-17 16:06:20 UTC (rev 22313)\n@@ -115,13 +115,15 @@\n  Convert the idmap database from an older version.\n *****************************************************************************/\n \n-static BOOL idmap_tdb_convert(const char *idmap_name)\n+static BOOL idmap_tdb_upgrade(const char *idmap_name)\n {\n \tint32 vers;\n \tBOOL bigendianheader;\n \tBOOL failed = False;\n \tTDB_CONTEXT *idmap_tdb;\n \n+\tDEBUG(0, (\"Upgrading winbindd_idmap.tdb from an old version\\n\"));\n+\n \tif (!(idmap_tdb = tdb_open_log(idmap_name, 0,\n \t\t\t\t\tTDB_DEFAULT, O_RDWR,\n \t\t\t\t\t0600))) {\n@@ -189,32 +191,6 @@\n \treturn True;\n }\n \n-/*****************************************************************************\n- Convert the idmap database from an older version if necessary\n-*****************************************************************************/\n-\n-BOOL idmap_tdb_upgrade(TALLOC_CTX *ctx, const char *tdbfile)\n-{\n-\tchar *backup_name;\n-\n-\tDEBUG(0, (\"Upgrading winbindd_idmap.tdb from an old version\\n\"));\n-\n-\tbackup_name = talloc_asprintf(ctx, \"%s.bak\", tdbfile);\n-\tif ( ! backup_name) {\n-\t\tDEBUG(0, (\"Out of memory!\\n\"));\n-\t\treturn False;\n-\t}\n-\n-\tif (backup_tdb(tdbfile, backup_name, 0) != 0) {\n-\t\tDEBUG(0, (\"Could not backup idmap database\\n\"));\n-\t\ttalloc_free(backup_name);\n-\t\treturn False;\n-\t}\n-\n-\ttalloc_free(backup_name);\n-\treturn idmap_tdb_convert(tdbfile);\n-}\n-\n /* WARNING: We can't open a tdb twice inthe same process, for that reason\n  * I'm going to use a hack with open ref counts to open the winbindd_idmap.tdb\n  * only once. We will later decide whether to split the db in multiple files\n@@ -282,7 +258,7 @@\n \t\t/* backup_tdb expects the tdb not to be open */\n \t\ttdb_close(idmap_tdb_common_ctx);\n \n-\t\tif ( ! idmap_tdb_upgrade(ctx, tdbfile)) {\n+\t\tif ( ! idmap_tdb_upgrade(tdbfile)) {\n \t\t\n \t\t\tDEBUG(0, (\"Unable to open idmap database, it's in an old formati, and upgrade failed!\\n\"));\n \t\t\tret = NT_STATUS_INTERNAL_DB_ERROR;\n\n"}