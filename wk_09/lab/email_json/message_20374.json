{"category": "ham", "to_address": "samba-cvs@samba.org", "from_address": "abartlet@samba.org", "subject": "svn commit: samba r22612 - in branches/SAMBA_4_0/source/winbind: .", "body": "Author: abartlet\nDate: 2007-04-30 16:52:30 +0000 (Mon, 30 Apr 2007)\nNew Revision: 22612\n\nWebSVN: http://websvn.samba.org/cgi-bin/viewcvs.cgi?view=rev&root=samba&rev=22612\n\nLog:\nFix more cases where we have uninitialised values in the\ncomposite_context, because we don't use the creation function.\n\nAndrew Bartlett\n\nModified:\n   branches/SAMBA_4_0/source/winbind/wb_async_helpers.c\n   branches/SAMBA_4_0/source/winbind/wb_cmd_getdcname.c\n   branches/SAMBA_4_0/source/winbind/wb_cmd_list_trustdom.c\n   branches/SAMBA_4_0/source/winbind/wb_cmd_lookupname.c\n   branches/SAMBA_4_0/source/winbind/wb_cmd_lookupsid.c\n   branches/SAMBA_4_0/source/winbind/wb_cmd_userdomgroups.c\n   branches/SAMBA_4_0/source/winbind/wb_cmd_usersids.c\n   branches/SAMBA_4_0/source/winbind/wb_dom_info_trusted.c\n   branches/SAMBA_4_0/source/winbind/wb_pam_auth.c\n   branches/SAMBA_4_0/source/winbind/wb_sam_logon.c\n   branches/SAMBA_4_0/source/winbind/wb_sid2domain.c\n\n\nChangeset:\nModified: branches/SAMBA_4_0/source/winbind/wb_async_helpers.c\n===================================================================\n--- branches/SAMBA_4_0/source/winbind/wb_async_helpers.c\t2007-04-30 16:32:17 UTC (rev 22611)\n+++ branches/SAMBA_4_0/source/winbind/wb_async_helpers.c\t2007-04-30 16:52:30 UTC (rev 22612)\n@@ -60,8 +60,8 @@\n \tstruct composite_context *c, *creq;\n \tstruct get_schannel_creds_state *state;\n \n-\tc = talloc_zero(mem_ctx, struct composite_context);\n-\tif (c == NULL) return NULL;\n+\tc = composite_create(mem_ctx, ev);\n+\tif (c == NULL) goto failed;\n \n \tstate = talloc(c, struct get_schannel_creds_state);\n \tif (state == NULL) {\n@@ -69,9 +69,7 @@\n \t\tgoto failed;\n \t}\n \n-\tc->state = COMPOSITE_STATE_IN_PROGRESS;\n \tc->private_data = state;\n-\tc->event_ctx = ev;\n \n \tstate->wks_creds = wks_creds;\n \n@@ -268,11 +266,8 @@\n \tstruct lsa_lookupsids_state *state;\n \tint i;\n \n-\tresult = talloc(mem_ctx, struct composite_context);\n+\tresult = composite_create(mem_ctx, lsa_pipe->conn->event_ctx);\n \tif (result == NULL) goto failed;\n-\tresult->state = COMPOSITE_STATE_IN_PROGRESS;\n-\tresult->async.fn = NULL;\n-\tresult->event_ctx = lsa_pipe->conn->event_ctx;\n \n \tstate = talloc(result, struct lsa_lookupsids_state);\n \tif (state == NULL) goto failed;\n@@ -428,11 +423,8 @@\n \tstruct lsa_String *lsa_names;\n \tint i;\n \n-\tresult = talloc(mem_ctx, struct composite_context);\n+\tresult = composite_create(mem_ctx, lsa_pipe->conn->event_ctx);\n \tif (result == NULL) goto failed;\n-\tresult->state = COMPOSITE_STATE_IN_PROGRESS;\n-\tresult->async.fn = NULL;\n-\tresult->event_ctx = lsa_pipe->conn->event_ctx;\n \n \tstate = talloc(result, struct lsa_lookupnames_state);\n \tif (state == NULL) goto failed;\n@@ -563,11 +555,8 @@\n \tstruct cmd_checkmachacc_state *state;\n \tstruct wbsrv_service *service = call->wbconn->listen_socket->service;\n \n-\tresult = talloc(call, struct composite_context);\n+\tresult = composite_create(mem_ctx, call->event_ctx;\n \tif (result == NULL) goto failed;\n-\tresult->state = COMPOSITE_STATE_IN_PROGRESS;\n-\tresult->async.fn = NULL;\n-\tresult->event_ctx = call->event_ctx;\n \n \tstate = talloc(result, struct cmd_checkmachacc_state);\n \tif (state == NULL) goto failed;\n@@ -641,11 +630,8 @@\n \tstruct rpc_request *req;\n \tstruct samr_getuserdomgroups_state *state;\n \n-\tresult = talloc(mem_ctx, struct composite_context);\n+\tresult = composite_create(mem_ctx, samr_pipe->conn->event_ctx);\n \tif (result == NULL) goto failed;\n-\tresult->state = COMPOSITE_STATE_IN_PROGRESS;\n-\tresult->async.fn = NULL;\n-\tresult->event_ctx = samr_pipe->conn->event_ctx;\n \n \tstate = talloc(result, struct samr_getuserdomgroups_state);\n \tif (state == NULL) goto failed;\n\nModified: branches/SAMBA_4_0/source/winbind/wb_cmd_getdcname.c\n===================================================================\n--- branches/SAMBA_4_0/source/winbind/wb_cmd_getdcname.c\t2007-04-30 16:32:17 UTC (rev 22611)\n+++ branches/SAMBA_4_0/source/winbind/wb_cmd_getdcname.c\t2007-04-30 16:52:30 UTC (rev 22612)\n@@ -44,11 +44,8 @@\n \tstruct composite_context *result, *ctx;\n \tstruct cmd_getdcname_state *state;\n \n-\tresult = talloc(mem_ctx, struct composite_context);\n+\tresult = composite_create(mem_ctx, service->task->event_ctx);\n \tif (result == NULL) goto failed;\n-\tresult->state = COMPOSITE_STATE_IN_PROGRESS;\n-\tresult->async.fn = NULL;\n-\tresult->event_ctx = service->task->event_ctx;\n \n \tstate = talloc(result, struct cmd_getdcname_state);\n \tif (state == NULL) goto failed;\n\nModified: branches/SAMBA_4_0/source/winbind/wb_cmd_list_trustdom.c\n===================================================================\n--- branches/SAMBA_4_0/source/winbind/wb_cmd_list_trustdom.c\t2007-04-30 16:32:17 UTC (rev 22611)\n+++ branches/SAMBA_4_0/source/winbind/wb_cmd_list_trustdom.c\t2007-04-30 16:52:30 UTC (rev 22612)\n@@ -52,11 +52,8 @@\n \tstruct composite_context *result, *ctx;\n \tstruct cmd_list_trustdom_state *state;\n \n-\tresult = talloc_zero(mem_ctx, struct composite_context);\n+\tresult = composite_create(mem_ctx, service->task->event_ctx);\n \tif (result == NULL) goto failed;\n-\tresult->state = COMPOSITE_STATE_IN_PROGRESS;\n-\tresult->async.fn = NULL;\n-\tresult->event_ctx = service->task->event_ctx;\n \n \tstate = talloc(result, struct cmd_list_trustdom_state);\n \tif (state == NULL) goto failed;\n\nModified: branches/SAMBA_4_0/source/winbind/wb_cmd_lookupname.c\n===================================================================\n--- branches/SAMBA_4_0/source/winbind/wb_cmd_lookupname.c\t2007-04-30 16:32:17 UTC (rev 22611)\n+++ branches/SAMBA_4_0/source/winbind/wb_cmd_lookupname.c\t2007-04-30 16:52:30 UTC (rev 22612)\n@@ -44,11 +44,8 @@\n \tstruct composite_context *result, *ctx;\n \tstruct cmd_lookupname_state *state;\n \n-\tresult = talloc(mem_ctx, struct composite_context);\n+\tresult = composite_create(mem_ctx, service->task->event_ctx);\n \tif (result == NULL) goto failed;\n-\tresult->state = COMPOSITE_STATE_IN_PROGRESS;\n-\tresult->async.fn = NULL;\n-\tresult->event_ctx = service->task->event_ctx;\n \n \tstate = talloc(result, struct cmd_lookupname_state);\n \tif (state == NULL) goto failed;\n\nModified: branches/SAMBA_4_0/source/winbind/wb_cmd_lookupsid.c\n===================================================================\n--- branches/SAMBA_4_0/source/winbind/wb_cmd_lookupsid.c\t2007-04-30 16:32:17 UTC (rev 22611)\n+++ branches/SAMBA_4_0/source/winbind/wb_cmd_lookupsid.c\t2007-04-30 16:52:30 UTC (rev 22612)\n@@ -43,11 +43,9 @@\n \tstruct composite_context *result, *ctx;\n \tstruct cmd_lookupsid_state *state;\n \n-\tresult = talloc(mem_ctx, struct composite_context);\n+\n+\tresult = composite_create(mem_ctx, service->task->event_ctx);\n \tif (result == NULL) goto failed;\n-\tresult->state = COMPOSITE_STATE_IN_PROGRESS;\n-\tresult->async.fn = NULL;\n-\tresult->event_ctx = service->task->event_ctx;\n \n \tstate = talloc(result, struct cmd_lookupsid_state);\n \tif (state == NULL) goto failed;\n\nModified: branches/SAMBA_4_0/source/winbind/wb_cmd_userdomgroups.c\n===================================================================\n--- branches/SAMBA_4_0/source/winbind/wb_cmd_userdomgroups.c\t2007-04-30 16:32:17 UTC (rev 22611)\n+++ branches/SAMBA_4_0/source/winbind/wb_cmd_userdomgroups.c\t2007-04-30 16:52:30 UTC (rev 22612)\n@@ -45,11 +45,8 @@\n \tstruct composite_context *result, *ctx;\n \tstruct cmd_userdomgroups_state *state;\n \n-\tresult = talloc(mem_ctx, struct composite_context);\n+\tresult = composite_create(mem_ctx, service->task->event_ctx);\n \tif (result == NULL) goto failed;\n-\tresult->state = COMPOSITE_STATE_IN_PROGRESS;\n-\tresult->async.fn = NULL;\n-\tresult->event_ctx = service->task->event_ctx;\n \n \tstate = talloc(result, struct cmd_userdomgroups_state);\n \tif (state == NULL) goto failed;\n\nModified: branches/SAMBA_4_0/source/winbind/wb_cmd_usersids.c\n===================================================================\n--- branches/SAMBA_4_0/source/winbind/wb_cmd_usersids.c\t2007-04-30 16:32:17 UTC (rev 22611)\n+++ branches/SAMBA_4_0/source/winbind/wb_cmd_usersids.c\t2007-04-30 16:52:30 UTC (rev 22612)\n@@ -57,11 +57,9 @@\n \tstruct composite_context *result, *ctx;\n \tstruct cmd_usersids_state *state;\n \n-\tresult = talloc(mem_ctx, struct composite_context);\n+\n+\tresult = composite_create(mem_ctx, service->task->event_ctx);\n \tif (result == NULL) goto failed;\n-\tresult->state = COMPOSITE_STATE_IN_PROGRESS;\n-\tresult->async.fn = NULL;\n-\tresult->event_ctx = service->task->event_ctx;\n \n \tstate = talloc(result, struct cmd_usersids_state);\n \tif (state == NULL) goto failed;\n\nModified: branches/SAMBA_4_0/source/winbind/wb_dom_info_trusted.c\n===================================================================\n--- branches/SAMBA_4_0/source/winbind/wb_dom_info_trusted.c\t2007-04-30 16:32:17 UTC (rev 22611)\n+++ branches/SAMBA_4_0/source/winbind/wb_dom_info_trusted.c\t2007-04-30 16:52:30 UTC (rev 22612)\n@@ -52,11 +52,8 @@\n \tstruct composite_context *result, *ctx;\n \tstruct trusted_dom_info_state *state;\n \n-\tresult = talloc(mem_ctx, struct composite_context);\n+\tresult = composite_create(mem_ctx, service->task->event_ctx);\n \tif (result == NULL) goto failed;\n-\tresult->state = COMPOSITE_STATE_IN_PROGRESS;\n-\tresult->async.fn = NULL;\n-\tresult->event_ctx = service->task->event_ctx;\n \n \tstate = talloc(result, struct trusted_dom_info_state);\n \tif (state == NULL) goto failed;\n\nModified: branches/SAMBA_4_0/source/winbind/wb_pam_auth.c\n===================================================================\n--- branches/SAMBA_4_0/source/winbind/wb_pam_auth.c\t2007-04-30 16:32:17 UTC (rev 22611)\n+++ branches/SAMBA_4_0/source/winbind/wb_pam_auth.c\t2007-04-30 16:52:30 UTC (rev 22612)\n@@ -71,11 +71,8 @@\n \tstruct composite_context *result, *ctx;\n \tstruct pam_auth_crap_state *state;\n \n-\tresult = talloc(mem_ctx, struct composite_context);\n+\tresult = composite_create(mem_ctx, service->task->event_ctx);\n \tif (result == NULL) goto failed;\n-\tresult->state = COMPOSITE_STATE_IN_PROGRESS;\n-\tresult->async.fn = NULL;\n-\tresult->event_ctx = service->task->event_ctx;\n \n \tstate = talloc(result, struct pam_auth_crap_state);\n \tif (state == NULL) goto failed;\n\nModified: branches/SAMBA_4_0/source/winbind/wb_sam_logon.c\n===================================================================\n--- branches/SAMBA_4_0/source/winbind/wb_sam_logon.c\t2007-04-30 16:32:17 UTC (rev 22611)\n+++ branches/SAMBA_4_0/source/winbind/wb_sam_logon.c\t2007-04-30 16:52:30 UTC (rev 22612)\n@@ -73,7 +73,7 @@\n }\n \n /*\n-    Finish the connection to the DC\n+    Having finished making the connection to the DC\n     Send of a SamLogon request to authenticate a user.\n */\n static void wb_sam_logon_recv_domain(struct composite_context *creq)\n\nModified: branches/SAMBA_4_0/source/winbind/wb_sid2domain.c\n===================================================================\n--- branches/SAMBA_4_0/source/winbind/wb_sid2domain.c\t2007-04-30 16:32:17 UTC (rev 22611)\n+++ branches/SAMBA_4_0/source/winbind/wb_sid2domain.c\t2007-04-30 16:52:30 UTC (rev 22612)\n@@ -64,11 +64,8 @@\n \tstruct composite_context *result, *ctx;\n \tstruct sid2domain_state *state;\n \n-\tresult = talloc_zero(mem_ctx, struct composite_context);\n+\tresult = composite_create(mem_ctx, service->task->event_ctx);\n \tif (result == NULL) goto failed;\n-\tresult->state = COMPOSITE_STATE_IN_PROGRESS;\n-\tresult->async.fn = NULL;\n-\tresult->event_ctx = service->task->event_ctx;\n \n \tstate = talloc(result, struct sid2domain_state);\n \tif (state == NULL) goto failed;\n\n"}