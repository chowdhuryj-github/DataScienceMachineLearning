{"category": "ham", "to_address": "samba-cvs@samba.org", "from_address": "Jelmer Vernooij <jelmer@samba.org>", "subject": "Rev 11880: Keep a clearer track of what ldap implementation to use.\n\tin file:///home/jelmer/bzr.samba/SAMBA_4_0/", "body": "At file:///home/jelmer/bzr.samba/SAMBA_4_0/\n\n------------------------------------------------------------\nrevno: 11880\nrevision-id: jelmer@samba.org-20070416233038-0aom9b19fkyfq6j7\nparent: jelmer@samba.org-20070416231308-z66suic84m4moolu\ncommitter: Jelmer Vernooij \nbranch nick: SAMBA_4_0\ntimestamp: Tue 2007-04-17 01:30:38 +0200\nmessage:\n  Keep a clearer track of what ldap implementation to use.\nmodified:\n  source/script/tests/Samba4.pm  svn-v2:21707@0c0555d6-39d7-0310-84fc-f1cc0bd64818-branches%2fSAMBA_4_0-source%2fscript%2ftests%2fSamba4.pm\n  source/script/tests/selftest.pl svn-v2:20693@0c0555d6-39d7-0310-84fc-f1cc0bd64818-branches%2fSAMBA_4_0-source%2fscript%2ftests%2fselftest.pl\n=== modified file 'source/script/tests/Samba4.pm'\n--- a/source/script/tests/Samba4.pm\t2007-04-16 23:13:08 +0000\n+++ b/source/script/tests/Samba4.pm\t2007-04-16 23:30:38 +0000\n@@ -11,7 +11,12 @@\n \n sub new($$$$) {\n \tmy ($classname, $bindir, $ldap, $setupdir) = @_;\n-\tmy $self = { vars => {}, ldap => $ldap, bindir => $bindir, setupdir => $setupdir };\n+\tmy $self = { \n+\t\tvars => {}, \n+\t\tldap => $ldap, \n+\t\tbindir => $bindir, \n+\t\tsetupdir => $setupdir \n+\t};\n \tbless $self;\n \treturn $self;\n }\n@@ -26,9 +31,9 @@\n \n \t# running slapd in the background means it stays in the same process group, so it can be\n \t# killed by timelimit\n-\tif (defined($ENV{FEDORA_DS_PREFIX})) {\n+\tif ($self->{ldap} eq \"fedora\") {\n \t        system(\"$ENV{FEDORA_DS_PREFIX}/sbin/ns-slapd -D $env_vars->{FEDORA_DS_DIR} -d$env_vars->{FEDORA_DS_LOGLEVEL} -i $env_vars->{FEDORA_DS_PIDFILE}> $env_vars->{LDAPDIR}/logs 2>&1 &\");\n-\t} else {\n+\t} elsif ($self->{ldap} eq \"openldap\") {\n \t\tmy $oldpath = $ENV{PATH};\n \t\t$ENV{PATH} = \"/usr/local/sbin:/usr/sbin:/sbin:$ENV{PATH}\";\n \t\tsystem(\"slapd -d$env_vars->{OPENLDAP_LOGLEVEL} -f $conf -h $uri > $env_vars->{LDAPDIR}/logs 2>&1 &\");\n@@ -48,9 +53,9 @@\n sub slapd_stop($$)\n {\n \tmy ($self, $envvars) = @_;\n-\tif (defined($ENV{FEDORA_DS_PREFIX})) {\n+\tif ($self->{ldap} eq \"fedora\") {\n \t\tsystem(\"$envvars->{LDAPDIR}/slapd-samba4/stop-slapd\");\n-\t} else {\n+\t} elsif ($self->{ldap} eq \"openldap\") {\n \t\topen(IN, \"<$envvars->{OPENLDAP_PIDFILE}\") or \n \t\t\tdie(\"unable to open slapd pid file: $envvars->{OPENLDAP_PIDFILE}\");\n \t\tkill 9, ;\n@@ -64,7 +69,7 @@\n \treturn 0 if ( -p $env_vars->{SMBD_TEST_FIFO});\n \n \t# Start slapd before smbd\n-\tif ($self->{ldap}) {\n+\tif (defined($self->{ldap})) {\n \t\t$self->slapd_start($env_vars) or \n \t\t\tdie(\"couldn't start slapd\");\n \n@@ -159,9 +164,9 @@\n \");\n }\n \n-sub provision($$$$$$)\n+sub provision($$$$$)\n {\n-\tmy ($self, $prefix, $server_role, $domain, $netbiosname, $ldap) = @_;\n+\tmy ($self, $prefix, $server_role, $domain, $netbiosname) = @_;\n \n \tmy $smbd_loglevel = 1;\n \tmy $username = \"administrator\";\n@@ -321,12 +326,12 @@\n \t$ldap_uri = \"ldapi://$ldap_uri\";\n \tmy $provision_aci = \"\"; # FIXME\n \n-\tif (not defined($ldap)) {\n-\t} elsif ($ldap eq \"openldap\") {\n+\tif (not defined($self->{ldap})) {\n+\t} elsif ($self->{ldap} eq \"openldap\") {\n \t\tmkdir($_) foreach ($ldapdir, \"$ldapdir/db\", \"$ldapdir/db/bdb-logs\", \n \t\t\"$ldapdir/db/tmp\");\n \t\tsystem(\"$RealBin/mk-openldap.sh\") == 0 or die(\"Unable to create openldap directories\");\n-\t} elsif ($ldap eq \"fedora\") {\n+\t} elsif ($self->{ldap} eq \"fedora\") {\n \t\tsystem(\"$RealBin/mk-fedora-ds.sh\") == 0 or die(\"Unable to create fedora ds directories\");\n \t\tpush (@provision_options, \"--ldap-module=nsuniqueid\");\n \t}\n@@ -355,9 +360,7 @@\n \tprint \"PROVISIONING MEMBER...\";\n \n \tmy $ret = $self->provision($prefix, \"member server\", \"SAMBADOMAIN\", \n-\t\t\"localmember\", \n-\t\tundef  # LDAP\n-\t);\n+\t\t\"localmember\");\n \n \t$ret or die(\"Unable to provision\");\n \n@@ -374,9 +377,7 @@\n \n \tprint \"PROVISIONING DC...\";\n \tmy $ret = $self->provision($prefix, \"domain controller\", \"SAMBADOMAIN\", \n-\t\t\"localtest\", \n-\t\tundef  # LDAP\n-\t);\n+\t\t\"localtest\");\n \n \t$self->add_wins_config(\"$prefix/private\") or \n \t\tdie(\"Unable to add wins configuration\");\n\n=== modified file 'source/script/tests/selftest.pl'\n--- a/source/script/tests/selftest.pl\t2007-04-16 22:35:13 +0000\n+++ b/source/script/tests/selftest.pl\t2007-04-16 23:30:38 +0000\n@@ -130,7 +130,7 @@\n my $opt_skip = undef;\n my $opt_verbose = 0;\n my $opt_testenv = 0;\n-my $opt_ldap = undef;\n+my $ldap = undef;\n my $opt_analyse_cmd = undef;\n my $opt_resetup_env = undef;\n \n@@ -308,7 +308,7 @@\n  --socket-wrapper-pcap=FILE save traffic to pcap file\n  --socket-wrapper           enable socket wrapper\n  --expected-failures=FILE   specify list of tests that is guaranteed to fail\n- --ldap                     run against ldap\n+ --ldap=openldap|fedora     back smbd onto specified ldap server\n \n Behaviour:\n  --quick                    run quick overall test\n@@ -335,7 +335,7 @@\n \t\t'builddir=s' => \\$builddir,\n \t\t'verbose' => \\$opt_verbose,\n \t\t'testenv' => \\$opt_testenv,\n-\t\t'ldap' => \\$opt_ldap,\n+\t\t'ldap:s' => \\$ldap,\n \t\t'analyse-cmd=s' => \\$opt_analyse_cmd,\n \t\t'resetup-environment' => \\$opt_resetup_env,\n \t    );\n@@ -353,12 +353,14 @@\n }\n \n my $old_pwd = \"$RealBin/../..\";\n-my $ldap = 0;\n-if (defined($ENV{TEST_LDAP})) {\n-\t$ldap = ($ENV{TEST_LDAP} eq \"yes\");\n-}\n-if (defined($opt_ldap)) {\n-\t$ldap = $opt_ldap;\n+\n+# Backwards compatibility:\n+if (defined($ENV{TEST_LDAP}) and $ENV{TEST_LDAP} eq \"yes\") {\n+\tif (defined($ENV{FEDORA_DS_PREFIX})) {\n+\t\t$ldap = \"fedora\";\n+\t} else {\n+\t\t$ldap = \"openldap\";\n+\t}\n }\n \n my $torture_maxtime = ($ENV{TORTURE_MAXTIME} or 1200);\n\n"}