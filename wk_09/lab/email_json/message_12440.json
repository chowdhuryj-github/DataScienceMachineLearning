{"category": "ham", "to_address": "samba-cvs@samba.org", "from_address": "metze@samba.org", "subject": "svn commit: samba r22455 - in\n\tbranches/SAMBA_4_0/source/build/smb_build: .", "body": "Author: metze\nDate: 2007-04-22 11:40:11 +0000 (Sun, 22 Apr 2007)\nNew Revision: 22455\n\nWebSVN: http://websvn.samba.org/cgi-bin/viewcvs.cgi?view=rev&root=samba&rev=22455\n\nLog:\nsplit dependecies array for compiling and linking and use better names:-)\n\ncalculate the CFLAGS only based on the public dependencies when recursing\n\nmetze \nModified:\n   branches/SAMBA_4_0/source/build/smb_build/input.pm\n   branches/SAMBA_4_0/source/build/smb_build/output.pm\n\n\nChangeset:\nModified: branches/SAMBA_4_0/source/build/smb_build/input.pm\n===================================================================\n--- branches/SAMBA_4_0/source/build/smb_build/input.pm\t2007-04-22 11:28:12 UTC (rev 22454)\n+++ branches/SAMBA_4_0/source/build/smb_build/input.pm\t2007-04-22 11:40:11 UTC (rev 22455)\n@@ -162,10 +162,10 @@\n \t}\n }\n \n-sub calc_unique_deps($$$$$$)\n+sub calc_unique_deps($$$$$$$$)\n {\n-\tsub calc_unique_deps($$$$$$);\n-\tmy ($name, $INPUT, $deps, $udeps, $withlibs, $busy) = @_;\n+\tsub calc_unique_deps($$$$$$$$);\n+\tmy ($name, $INPUT, $deps, $udeps, $withlibs, $forward, $pubonly, $busy) = @_;\n \n \tforeach my $n (@$deps) {\n \t\tdie(\"Dependency unknown: $n\") unless (defined($INPUT->{$n}));\n@@ -173,17 +173,19 @@\n \t\tnext if (grep /^$n$/, @$udeps);\n \t\tmy $dep = $INPUT->{$n};\n \n+\t\tpush (@{$udeps}, $dep->{NAME}) if $forward;\n+\n  \t\tif (defined ($dep->{OUTPUT_TYPE}) && \n \t\t\t($withlibs or \n \t\t\t(@{$dep->{OUTPUT_TYPE}}[0] eq \"INTEGRATED\") or \n \t\t\t(@{$dep->{OUTPUT_TYPE}}[0] eq \"STATIC_LIBRARY\"))) {\n \t\t\t\tpush (@$busy, $dep->{NAME});\n-\t\t\t        calc_unique_deps($dep->{NAME}, $INPUT, $dep->{PUBLIC_DEPENDENCIES}, $udeps, $withlibs, $busy);\n-\t\t\t        calc_unique_deps($dep->{NAME}, $INPUT, $dep->{PRIVATE_DEPENDENCIES}, $udeps, $withlibs, $busy);\n+\t\t\t        calc_unique_deps($dep->{NAME}, $INPUT, $dep->{PUBLIC_DEPENDENCIES}, $udeps, $withlibs, $forward, $pubonly, $busy);\n+\t\t\t        calc_unique_deps($dep->{NAME}, $INPUT, $dep->{PRIVATE_DEPENDENCIES}, $udeps, $withlibs, $forward, $pubonly, $busy) unless $pubonly;\n \t\t\t\tpop (@$busy);\n \t        }\n \n-\t\tunshift (@{$udeps}, $dep->{NAME});\n+\t\tunshift (@{$udeps}, $dep->{NAME}) unless $forward;\n \t}\n }\n \n@@ -242,15 +244,21 @@\n \t}\n \n \tforeach my $part (values %$INPUT) {\n-\t\t$part->{UNIQUE_DEPENDENCIES} = [];\n-\t\tcalc_unique_deps($part->{NAME}, $INPUT, $part->{PUBLIC_DEPENDENCIES}, $part->{UNIQUE_DEPENDENCIES}, 0, []);\n-\t\tcalc_unique_deps($part->{NAME}, $INPUT, $part->{PRIVATE_DEPENDENCIES}, $part->{UNIQUE_DEPENDENCIES}, 0, []);\n+\t\t$part->{UNIQUE_DEPENDENCIES_LINK} = [];\n+\t\tcalc_unique_deps($part->{NAME}, $INPUT, $part->{PUBLIC_DEPENDENCIES}, $part->{UNIQUE_DEPENDENCIES_LINK}, 0, 0, 0, []);\n+\t\tcalc_unique_deps($part->{NAME}, $INPUT, $part->{PRIVATE_DEPENDENCIES}, $part->{UNIQUE_DEPENDENCIES_LINK}, 0, 0, 0, []);\n \t}\n \n \tforeach my $part (values %$INPUT) {\n+\t\t$part->{UNIQUE_DEPENDENCIES_COMPILE} = [];\n+\t\tcalc_unique_deps($part->{NAME}, $INPUT, $part->{PUBLIC_DEPENDENCIES}, $part->{UNIQUE_DEPENDENCIES_COMPILE}, 1, 1, 1, []);\n+\t\tcalc_unique_deps($part->{NAME}, $INPUT, $part->{PRIVATE_DEPENDENCIES}, $part->{UNIQUE_DEPENDENCIES_COMPILE}, 1, 1, 1, []);\n+\t}\n+\n+\tforeach my $part (values %$INPUT) {\n \t\t$part->{UNIQUE_DEPENDENCIES_ALL} = [];\n-\t\tcalc_unique_deps($part->{NAME}, $INPUT, $part->{PUBLIC_DEPENDENCIES}, $part->{UNIQUE_DEPENDENCIES_ALL}, 1, []);\n-\t\tcalc_unique_deps($part->{NAME}, $INPUT, $part->{PRIVATE_DEPENDENCIES}, $part->{UNIQUE_DEPENDENCIES_ALL}, 1, []);\n+\t\tcalc_unique_deps($part->{NAME}, $INPUT, $part->{PUBLIC_DEPENDENCIES}, $part->{UNIQUE_DEPENDENCIES_ALL}, 1, 0, 0, []);\n+\t\tcalc_unique_deps($part->{NAME}, $INPUT, $part->{PRIVATE_DEPENDENCIES}, $part->{UNIQUE_DEPENDENCIES_ALL}, 1, 0, 0, []);\n \t}\n \n \treturn $INPUT;\n\nModified: branches/SAMBA_4_0/source/build/smb_build/output.pm\n===================================================================\n--- branches/SAMBA_4_0/source/build/smb_build/output.pm\t2007-04-22 11:28:12 UTC (rev 22454)\n+++ branches/SAMBA_4_0/source/build/smb_build/output.pm\t2007-04-22 11:40:11 UTC (rev 22455)\n@@ -148,7 +148,7 @@\n \t\tmerge_array(\\$part->{FINAL_CFLAGS}, $part->{CPPFLAGS});\n \t\tmerge_array(\\$part->{FINAL_CFLAGS}, $part->{CFLAGS});\n \n-\t\tforeach (reverse @{$part->{UNIQUE_DEPENDENCIES_ALL}}) {\n+\t\tforeach (@{$part->{UNIQUE_DEPENDENCIES_COMPILE}}) {\n \t\t\tmy $elem = $depend->{$_};\n \t\t\tnext if $elem == $part;\n \n@@ -157,7 +157,7 @@\n \t\t}\n \n \t\t# Always import the link options of the unique dependencies\n-\t\tforeach (@{$part->{UNIQUE_DEPENDENCIES}}) {\n+\t\tforeach (@{$part->{UNIQUE_DEPENDENCIES_LINK}}) {\n \t\t\tmy $elem = $depend->{$_};\n \t\t\tnext if $elem == $part;\n \n\n"}