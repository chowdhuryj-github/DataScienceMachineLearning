{"category": "ham", "to_address": "samba-cvs@samba.org", "from_address": "jra@samba.org", "subject": "svn commit: samba r23450 - in branches: SAMBA_3_0/source/smbd\n\tSAMBA_3_0_25/source/smbd SAMBA_3_0_26/source/smbd", "body": "Author: jra\nDate: 2007-06-12 19:59:38 +0000 (Tue, 12 Jun 2007)\nNew Revision: 23450\n\nWebSVN: http://websvn.samba.org/cgi-bin/viewcvs.cgi?view=rev&root=samba&rev=23450\n\nLog:\nmax_params_return is complete fiction when getting a changenotify\nrequest. Ignore it. Should fix bug #4689 but more tests and\nvalgrinding will follow.\nJeremy.\n\nModified:\n   branches/SAMBA_3_0/source/smbd/notify.c\n   branches/SAMBA_3_0/source/smbd/nttrans.c\n   branches/SAMBA_3_0_25/source/smbd/notify.c\n   branches/SAMBA_3_0_25/source/smbd/nttrans.c\n   branches/SAMBA_3_0_26/source/smbd/notify.c\n   branches/SAMBA_3_0_26/source/smbd/nttrans.c\n\n\nChangeset:\nModified: branches/SAMBA_3_0/source/smbd/notify.c\n===================================================================\n--- branches/SAMBA_3_0/source/smbd/notify.c\t2007-06-12 19:55:07 UTC (rev 23449)\n+++ branches/SAMBA_3_0/source/smbd/notify.c\t2007-06-12 19:59:38 UTC (rev 23450)\n@@ -27,7 +27,6 @@\n \tstruct files_struct *fsp;\t/* backpointer for cancel by mid */\n \tchar request_buf[smb_size];\n \tuint32 filter;\n-\tuint32 max_param_count;\n \tuint32 current_bufsize;\n \tstruct notify_mid_map *mid_map;\n \tvoid *backend_data;\n@@ -127,12 +126,12 @@\n \t\t\t\t    \"failed.\");\n }\n \n-void change_notify_reply(const char *request_buf, uint32 max_param_count,\n+void change_notify_reply(const char *request_buf,\n \t\t\t struct notify_change_buf *notify_buf)\n {\n \tchar *outbuf = NULL;\n \tprs_struct ps;\n-\tsize_t buflen = smb_size+38+max_param_count;\n+\tsize_t buflen;\n \n \tif (notify_buf->num_changes == -1) {\n \t\tchange_notify_reply_packet(request_buf, NT_STATUS_OK);\n@@ -146,14 +145,7 @@\n \t\tgoto done;\n \t}\n \n-\tif (prs_offset(&ps) > max_param_count) {\n-\t\t/*\n-\t\t * We exceed what the client is willing to accept. Send\n-\t\t * nothing.\n-\t\t */\n-\t\tchange_notify_reply_packet(request_buf, NT_STATUS_OK);\n-\t\tgoto done;\n-\t}\n+\tbuflen = smb_size+38+prs_offset(&ps) + 4 /* padding */;\n \n \tif (!(outbuf = SMB_MALLOC_ARRAY(char, buflen))) {\n \t\tchange_notify_reply_packet(request_buf, NT_STATUS_NO_MEMORY);\n@@ -215,7 +207,7 @@\n \treturn status;\n }\n \n-NTSTATUS change_notify_add_request(const char *inbuf, uint32 max_param_count,\n+NTSTATUS change_notify_add_request(const char *inbuf, \n \t\t\t\t   uint32 filter, BOOL recursive,\n \t\t\t\t   struct files_struct *fsp)\n {\n@@ -232,7 +224,6 @@\n \tmap->req = request;\n \n \tmemcpy(request->request_buf, inbuf, sizeof(request->request_buf));\n-\trequest->max_param_count = max_param_count;\n \trequest->current_bufsize = 0;\n \trequest->filter = filter;\n \trequest->fsp = fsp;\n@@ -409,7 +400,6 @@\n \t */\n \n \tchange_notify_reply(fsp->notify->requests->request_buf,\n-\t\t\t    fsp->notify->requests->max_param_count,\n \t\t\t    fsp->notify);\n \n \tchange_notify_remove_request(fsp->notify->requests);\n\nModified: branches/SAMBA_3_0/source/smbd/nttrans.c\n===================================================================\n--- branches/SAMBA_3_0/source/smbd/nttrans.c\t2007-06-12 19:55:07 UTC (rev 23449)\n+++ branches/SAMBA_3_0/source/smbd/nttrans.c\t2007-06-12 19:59:38 UTC (rev 23450)\n@@ -1985,8 +1985,7 @@\n \t\t * here.\n \t\t */\n \n-\t\tchange_notify_reply(inbuf, max_param_count,\n-\t\t\t\t    fsp->notify);\n+\t\tchange_notify_reply(inbuf, fsp->notify);\n \n \t\t/*\n \t\t * change_notify_reply() above has independently sent its\n@@ -1999,8 +1998,7 @@\n \t * No changes pending, queue the request\n \t */\n \n-\tstatus = change_notify_add_request(inbuf, max_param_count, filter,\n-\t\t\t\t\t   recursive, fsp);\n+\tstatus = change_notify_add_request(inbuf, filter, recursive, fsp);\n \tif (!NT_STATUS_IS_OK(status)) {\n \t\treturn ERROR_NT(status);\n \t}\n\nModified: branches/SAMBA_3_0_25/source/smbd/notify.c\n===================================================================\n--- branches/SAMBA_3_0_25/source/smbd/notify.c\t2007-06-12 19:55:07 UTC (rev 23449)\n+++ branches/SAMBA_3_0_25/source/smbd/notify.c\t2007-06-12 19:59:38 UTC (rev 23450)\n@@ -27,7 +27,6 @@\n \tstruct files_struct *fsp;\t/* backpointer for cancel by mid */\n \tchar request_buf[smb_size];\n \tuint32 filter;\n-\tuint32 max_param_count;\n \tuint32 current_bufsize;\n \tstruct notify_mid_map *mid_map;\n \tvoid *backend_data;\n@@ -126,12 +125,12 @@\n \t\t\t\t    \"failed.\");\n }\n \n-void change_notify_reply(const char *request_buf, uint32 max_param_count,\n+void change_notify_reply(const char *request_buf,\n \t\t\t struct notify_change_buf *notify_buf)\n {\n \tchar *outbuf = NULL;\n \tprs_struct ps;\n-\tsize_t buflen = smb_size+38+max_param_count;\n+\tsize_t buflen;\n \n \tif (notify_buf->num_changes == -1) {\n \t\tchange_notify_reply_packet(request_buf, NT_STATUS_OK);\n@@ -145,14 +144,7 @@\n \t\tgoto done;\n \t}\n \n-\tif (prs_offset(&ps) > max_param_count) {\n-\t\t/*\n-\t\t * We exceed what the client is willing to accept. Send\n-\t\t * nothing.\n-\t\t */\n-\t\tchange_notify_reply_packet(request_buf, NT_STATUS_OK);\n-\t\tgoto done;\n-\t}\n+\tbuflen = smb_size+38+prs_offset(&ps) + 4 /* padding */;\n \n \tif (!(outbuf = SMB_MALLOC_ARRAY(char, buflen))) {\n \t\tchange_notify_reply_packet(request_buf, NT_STATUS_NO_MEMORY);\n@@ -214,7 +206,7 @@\n \treturn status;\n }\n \n-NTSTATUS change_notify_add_request(const char *inbuf, uint32 max_param_count,\n+NTSTATUS change_notify_add_request(const char *inbuf, \n \t\t\t\t   uint32 filter, BOOL recursive,\n \t\t\t\t   struct files_struct *fsp)\n {\n@@ -231,7 +223,6 @@\n \tmap->req = request;\n \n \tmemcpy(request->request_buf, inbuf, sizeof(request->request_buf));\n-\trequest->max_param_count = max_param_count;\n \trequest->current_bufsize = 0;\n \trequest->filter = filter;\n \trequest->fsp = fsp;\n@@ -408,7 +399,6 @@\n \t */\n \n \tchange_notify_reply(fsp->notify->requests->request_buf,\n-\t\t\t    fsp->notify->requests->max_param_count,\n \t\t\t    fsp->notify);\n \n \tchange_notify_remove_request(fsp->notify->requests);\n\nModified: branches/SAMBA_3_0_25/source/smbd/nttrans.c\n===================================================================\n--- branches/SAMBA_3_0_25/source/smbd/nttrans.c\t2007-06-12 19:55:07 UTC (rev 23449)\n+++ branches/SAMBA_3_0_25/source/smbd/nttrans.c\t2007-06-12 19:59:38 UTC (rev 23450)\n@@ -1979,8 +1979,7 @@\n \t\t * here.\n \t\t */\n \n-\t\tchange_notify_reply(inbuf, max_param_count,\n-\t\t\t\t    fsp->notify);\n+\t\tchange_notify_reply(inbuf, fsp->notify);\n \n \t\t/*\n \t\t * change_notify_reply() above has independently sent its\n@@ -1993,8 +1992,7 @@\n \t * No changes pending, queue the request\n \t */\n \n-\tstatus = change_notify_add_request(inbuf, max_param_count, filter,\n-\t\t\t\t\t   recursive, fsp);\n+\tstatus = change_notify_add_request(inbuf, filter, recursive, fsp);\n \tif (!NT_STATUS_IS_OK(status)) {\n \t\treturn ERROR_NT(status);\n \t}\n\nModified: branches/SAMBA_3_0_26/source/smbd/notify.c\n===================================================================\n--- branches/SAMBA_3_0_26/source/smbd/notify.c\t2007-06-12 19:55:07 UTC (rev 23449)\n+++ branches/SAMBA_3_0_26/source/smbd/notify.c\t2007-06-12 19:59:38 UTC (rev 23450)\n@@ -27,7 +27,6 @@\n \tstruct files_struct *fsp;\t/* backpointer for cancel by mid */\n \tchar request_buf[smb_size];\n \tuint32 filter;\n-\tuint32 max_param_count;\n \tuint32 current_bufsize;\n \tstruct notify_mid_map *mid_map;\n \tvoid *backend_data;\n@@ -126,12 +125,12 @@\n \t\t\t\t    \"failed.\");\n }\n \n-void change_notify_reply(const char *request_buf, uint32 max_param_count,\n+void change_notify_reply(const char *request_buf,\n \t\t\t struct notify_change_buf *notify_buf)\n {\n \tchar *outbuf = NULL;\n \tprs_struct ps;\n-\tsize_t buflen = smb_size+38+max_param_count;\n+\tsize_t buflen;\n \n \tif (notify_buf->num_changes == -1) {\n \t\tchange_notify_reply_packet(request_buf, NT_STATUS_OK);\n@@ -145,14 +144,7 @@\n \t\tgoto done;\n \t}\n \n-\tif (prs_offset(&ps) > max_param_count) {\n-\t\t/*\n-\t\t * We exceed what the client is willing to accept. Send\n-\t\t * nothing.\n-\t\t */\n-\t\tchange_notify_reply_packet(request_buf, NT_STATUS_OK);\n-\t\tgoto done;\n-\t}\n+\tbuflen = smb_size+38+prs_offset(&ps) + 4 /* padding */;\n \n \tif (!(outbuf = SMB_MALLOC_ARRAY(char, buflen))) {\n \t\tchange_notify_reply_packet(request_buf, NT_STATUS_NO_MEMORY);\n@@ -214,7 +206,7 @@\n \treturn status;\n }\n \n-NTSTATUS change_notify_add_request(const char *inbuf, uint32 max_param_count,\n+NTSTATUS change_notify_add_request(const char *inbuf, \n \t\t\t\t   uint32 filter, BOOL recursive,\n \t\t\t\t   struct files_struct *fsp)\n {\n@@ -231,7 +223,6 @@\n \tmap->req = request;\n \n \tmemcpy(request->request_buf, inbuf, sizeof(request->request_buf));\n-\trequest->max_param_count = max_param_count;\n \trequest->current_bufsize = 0;\n \trequest->filter = filter;\n \trequest->fsp = fsp;\n@@ -408,7 +399,6 @@\n \t */\n \n \tchange_notify_reply(fsp->notify->requests->request_buf,\n-\t\t\t    fsp->notify->requests->max_param_count,\n \t\t\t    fsp->notify);\n \n \tchange_notify_remove_request(fsp->notify->requests);\n\nModified: branches/SAMBA_3_0_26/source/smbd/nttrans.c\n===================================================================\n--- branches/SAMBA_3_0_26/source/smbd/nttrans.c\t2007-06-12 19:55:07 UTC (rev 23449)\n+++ branches/SAMBA_3_0_26/source/smbd/nttrans.c\t2007-06-12 19:59:38 UTC (rev 23450)\n@@ -1979,8 +1979,7 @@\n \t\t * here.\n \t\t */\n \n-\t\tchange_notify_reply(inbuf, max_param_count,\n-\t\t\t\t    fsp->notify);\n+\t\tchange_notify_reply(inbuf, fsp->notify);\n \n \t\t/*\n \t\t * change_notify_reply() above has independently sent its\n@@ -1993,8 +1992,7 @@\n \t * No changes pending, queue the request\n \t */\n \n-\tstatus = change_notify_add_request(inbuf, max_param_count, filter,\n-\t\t\t\t\t   recursive, fsp);\n+\tstatus = change_notify_add_request(inbuf, filter, recursive, fsp);\n \tif (!NT_STATUS_IS_OK(status)) {\n \t\treturn ERROR_NT(status);\n \t}\n\n"}