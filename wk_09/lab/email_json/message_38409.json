{"category": "ham", "to_address": "samba-cvs@samba.org", "from_address": "vlendec@samba.org", "subject": "svn commit: samba r23223 - in branches: SAMBA_3_0/source/utils\n\tSAMBA_3_0_26/source/utils", "body": "Author: vlendec\nDate: 2007-05-29 18:41:16 +0000 (Tue, 29 May 2007)\nNew Revision: 23223\n\nWebSVN: http://websvn.samba.org/cgi-bin/viewcvs.cgi?view=rev&root=samba&rev=23223\n\nLog:\nConvert a leftover direct tdb access to sessionid.tdb\n\nModified:\n   branches/SAMBA_3_0/source/utils/status.c\n   branches/SAMBA_3_0_26/source/utils/status.c\n\n\nChangeset:\nModified: branches/SAMBA_3_0/source/utils/status.c\n===================================================================\n--- branches/SAMBA_3_0/source/utils/status.c\t2007-05-29 18:32:49 UTC (rev 23222)\n+++ branches/SAMBA_3_0/source/utils/status.c\t2007-05-29 18:41:16 UTC (rev 23223)\n@@ -219,22 +219,22 @@\n \t}\n \n \td_printf(\"%-10s   %s   %-12s  %s\",\n-\t       crec->servicename,procid_str_static(&crec->pid),\n-\t       crec->machine,\n-\t       time_to_asc(crec->start));\n+\t\t crec->servicename,procid_str_static(&crec->pid),\n+\t\t crec->machine,\n+\t\t time_to_asc(crec->start));\n \n \treturn 0;\n }\n \n-static int traverse_sessionid(TDB_CONTEXT *tdb, TDB_DATA kbuf, TDB_DATA dbuf, void *state)\n+static int traverse_sessionid(struct db_record *db, void *state)\n {\n \tstruct sessionid sessionid;\n \tfstring uid_str, gid_str;\n \n-\tif (dbuf.dsize != sizeof(sessionid))\n+\tif (db->value.dsize != sizeof(sessionid))\n \t\treturn 0;\n \n-\tmemcpy(&sessionid, dbuf.dptr, sizeof(sessionid));\n+\tmemcpy(&sessionid, db->value.dptr, sizeof(sessionid));\n \n \tif (!process_exists(sessionid.pid) || !Ucrit_checkUid(sessionid.uid)) {\n \t\treturn 0;\n@@ -245,7 +245,7 @@\n \tfstr_sprintf(uid_str, \"%d\", sessionid.uid);\n \tfstr_sprintf(gid_str, \"%d\", sessionid.gid);\n \n-\td_printf(\"%s   %-12s  %-12s  %-12s (%s)\\n\",\n+\td_printf(\"%-7s   %-12s  %-12s  %-12s (%s)\\n\",\n \t\t procid_str_static(&sessionid.pid),\n \t\t numeric_only ? uid_str : uidtoname(sessionid.uid),\n \t\t numeric_only ? gid_str : gidtoname(sessionid.gid), \n@@ -261,7 +261,6 @@\n {\n \tint c;\n \tint profile_only = 0;\n-\tTDB_CONTEXT *tdb;\n \tBOOL show_processes, show_locks, show_shares;\n \tpoptContext pc;\n \tstruct poptOption long_options[] = {\n@@ -336,16 +335,18 @@\n \t}\n \n \tif ( show_processes ) {\n-\t\ttdb = tdb_open_log(lock_path(\"sessionid.tdb\"), 0, TDB_DEFAULT, O_RDONLY, 0);\n-\t\tif (!tdb) {\n+\t\tstruct db_context *db;\n+\t\tdb = db_open(NULL, lock_path(\"sessionid.tdb\"), 0,\n+\t\t\t     TDB_DEFAULT, O_RDWR, 0644);\n+\t\tif (!db) {\n \t\t\td_printf(\"sessionid.tdb not initialised\\n\");\n \t\t} else {\n \t\t\td_printf(\"\\nSamba version %s\\n\",SAMBA_VERSION_STRING);\n \t\t\td_printf(\"PID     Username      Group         Machine                        \\n\");\n \t\t\td_printf(\"-------------------------------------------------------------------\\n\");\n \n-\t\t\ttdb_traverse(tdb, traverse_sessionid, NULL);\n-\t\t\ttdb_close(tdb);\n+\t\t\tdb->traverse_read(db, traverse_sessionid, NULL);\n+\t\t\ttalloc_free(db);\n \t\t}\n \n \t\tif (processes_only) \n\nModified: branches/SAMBA_3_0_26/source/utils/status.c\n===================================================================\n--- branches/SAMBA_3_0_26/source/utils/status.c\t2007-05-29 18:32:49 UTC (rev 23222)\n+++ branches/SAMBA_3_0_26/source/utils/status.c\t2007-05-29 18:41:16 UTC (rev 23223)\n@@ -219,22 +219,22 @@\n \t}\n \n \td_printf(\"%-10s   %s   %-12s  %s\",\n-\t       crec->servicename,procid_str_static(&crec->pid),\n-\t       crec->machine,\n-\t       time_to_asc(crec->start));\n+\t\t crec->servicename,procid_str_static(&crec->pid),\n+\t\t crec->machine,\n+\t\t time_to_asc(crec->start));\n \n \treturn 0;\n }\n \n-static int traverse_sessionid(TDB_CONTEXT *tdb, TDB_DATA kbuf, TDB_DATA dbuf, void *state)\n+static int traverse_sessionid(struct db_record *db, void *state)\n {\n \tstruct sessionid sessionid;\n \tfstring uid_str, gid_str;\n \n-\tif (dbuf.dsize != sizeof(sessionid))\n+\tif (db->value.dsize != sizeof(sessionid))\n \t\treturn 0;\n \n-\tmemcpy(&sessionid, dbuf.dptr, sizeof(sessionid));\n+\tmemcpy(&sessionid, db->value.dptr, sizeof(sessionid));\n \n \tif (!process_exists(sessionid.pid) || !Ucrit_checkUid(sessionid.uid)) {\n \t\treturn 0;\n@@ -245,7 +245,7 @@\n \tfstr_sprintf(uid_str, \"%d\", sessionid.uid);\n \tfstr_sprintf(gid_str, \"%d\", sessionid.gid);\n \n-\td_printf(\"%s   %-12s  %-12s  %-12s (%s)\\n\",\n+\td_printf(\"%-7s   %-12s  %-12s  %-12s (%s)\\n\",\n \t\t procid_str_static(&sessionid.pid),\n \t\t numeric_only ? uid_str : uidtoname(sessionid.uid),\n \t\t numeric_only ? gid_str : gidtoname(sessionid.gid), \n@@ -261,7 +261,6 @@\n {\n \tint c;\n \tint profile_only = 0;\n-\tTDB_CONTEXT *tdb;\n \tBOOL show_processes, show_locks, show_shares;\n \tpoptContext pc;\n \tstruct poptOption long_options[] = {\n@@ -336,16 +335,18 @@\n \t}\n \n \tif ( show_processes ) {\n-\t\ttdb = tdb_open_log(lock_path(\"sessionid.tdb\"), 0, TDB_DEFAULT, O_RDONLY, 0);\n-\t\tif (!tdb) {\n+\t\tstruct db_context *db;\n+\t\tdb = db_open(NULL, lock_path(\"sessionid.tdb\"), 0,\n+\t\t\t     TDB_DEFAULT, O_RDWR, 0644);\n+\t\tif (!db) {\n \t\t\td_printf(\"sessionid.tdb not initialised\\n\");\n \t\t} else {\n \t\t\td_printf(\"\\nSamba version %s\\n\",SAMBA_VERSION_STRING);\n \t\t\td_printf(\"PID     Username      Group         Machine                        \\n\");\n \t\t\td_printf(\"-------------------------------------------------------------------\\n\");\n \n-\t\t\ttdb_traverse(tdb, traverse_sessionid, NULL);\n-\t\t\ttdb_close(tdb);\n+\t\t\tdb->traverse_read(db, traverse_sessionid, NULL);\n+\t\t\ttalloc_free(db);\n \t\t}\n \n \t\tif (processes_only) \n\n"}