{"category": "ham", "to_address": "samba-cvs@samba.org", "from_address": "jelmer@samba.org", "subject": "svn commit: samba r22185 - in branches/SAMBA_4_0: .\n\tsource/script/tests", "body": "Author: jelmer\nDate: 2007-04-12 08:33:35 +0000 (Thu, 12 Apr 2007)\nNew Revision: 22185\n\nWebSVN: http://websvn.samba.org/cgi-bin/viewcvs.cgi?view=rev&root=samba&rev=22185\n\nLog:\nInitial work on a 'member' test environment'.\nAdded:\n   branches/SAMBA_4_0/source/script/tests/mktestmember.sh\n   branches/SAMBA_4_0/source/script/tests/test_member.sh\nModified:\n   branches/SAMBA_4_0/\n   branches/SAMBA_4_0/source/script/tests/README\n   branches/SAMBA_4_0/source/script/tests/Samba4.pm\n   branches/SAMBA_4_0/source/script/tests/TODO\n\n\nChangeset:\n\nProperty changes on: branches/SAMBA_4_0\n___________________________________________________________________\nName: bzr:merge\n...skipped...\n\nModified: branches/SAMBA_4_0/source/script/tests/README\n===================================================================\n--- branches/SAMBA_4_0/source/script/tests/README\t2007-04-12 04:01:42 UTC (rev 22184)\n+++ branches/SAMBA_4_0/source/script/tests/README\t2007-04-12 08:33:35 UTC (rev 22185)\n@@ -1,4 +1,13 @@\n This directory contains test scripts that are useful for running a\n-bunch of tests all at once. I expect it will eventually be hooked into\n-a \"make test\" framework.\n+bunch of tests all at once. \n \n+The following environments are currently available:\n+\n+ - none: No server set up\n+ - dc: Domain controller set up. The following environment variables will \n+   be set:\n+     * USERNAME\n+\t * PASSWORD\n+\t * DOMAIN\n+\t * REALM\n+\t * SERVER\n\nModified: branches/SAMBA_4_0/source/script/tests/Samba4.pm\n===================================================================\n--- branches/SAMBA_4_0/source/script/tests/Samba4.pm\t2007-04-12 04:01:42 UTC (rev 22184)\n+++ branches/SAMBA_4_0/source/script/tests/Samba4.pm\t2007-04-12 08:33:35 UTC (rev 22185)\n@@ -11,7 +11,7 @@\n \n sub new($$$$) {\n \tmy ($classname, $bindir, $ldap, $setupdir) = @_;\n-\tmy $self = { ldap => $ldap, bindir => $bindir, setupdir => $setupdir };\n+\tmy $self = { vars => {}, ldap => $ldap, bindir => $bindir, setupdir => $setupdir };\n \tbless $self;\n \treturn $self;\n }\n@@ -135,8 +135,25 @@\n \tsystem(\"bin/nmblookup $testenv_vars->{CONFIGURATION} -U $testenv_vars->{SERVER} $testenv_vars->{NETBIOSNAME}\");\n }\n \n-sub provision($$)\n+sub provision_member($$$)\n {\n+\tmy ($self, $prefix, $dcvars) = @_;\n+\tmy %ret = ();\n+\tprint \"PROVISIONING...\";\n+\topen(IN, \"$RealBin/mktestmember.sh $prefix $dcvars->{DOMAIN} $dcvars->{USERNAME} $dcvars->{PASSWORD}|\") or die(\"Unable to setup\");\n+\twhile () {\n+\t\tdie (\"Error parsing `$_'\") unless (/^([A-Z0-9a-z_]+)=(.*)$/);\n+\t\t$ret{$1} = $2;\n+\t}\n+\tclose(IN);\n+\n+\t$ret{SMBD_TEST_FIFO} = \"$prefix/smbd_test.fifo\";\n+\t$ret{SMBD_TEST_LOG} = \"$prefix/smbd_test.log\";\n+\treturn \\%ret;\n+}\n+\n+sub provision_dc($$)\n+{\n \tmy ($self, $prefix) = @_;\n \tmy %ret = ();\n \tprint \"PROVISIONING...\";\n@@ -186,22 +203,42 @@\n \t\n \tif ($envname eq \"dc\") {\n \t\treturn $self->setup_dc(\"$path/dc\");\n+\t} elsif ($envname eq \"member\") {\n+\t\tif (not defined($self->{vars}->{dc})) {\n+\t\t\t$self->setup_dc(\"$path/dc\");\n+\t\t}\n+\t\treturn $self->setup_member(\"$path/member\", $self->{vars}->{dc});\n \t} else {\n-\t\tdie(\"Samba4 can't provide environment $envname\");\n+\t\tdie(\"Samba4 can't provide environment '$envname'\");\n \t}\n }\n \n+sub setup_member($$$$)\n+{\n+\tmy ($self, $path, $dc_vars) = @_;\n+\n+\tmy $env = $self->provision_member($path, $dc_vars);\n+\n+\t$self->check_or_start($env, ($ENV{SMBD_MAX_TIME} or 5400));\n+\n+\t$self->wait_for_start($env);\n+\n+\treturn $env;\n+}\n+\n sub setup_dc($$)\n {\n \tmy ($self, $path) = @_;\n \n-\tmy $env = $self->provision($path);\n+\tmy $env = $self->provision_dc($path);\n \n \t$self->check_or_start($env, \n \t\t($ENV{SMBD_MAX_TIME} or 5400));\n \n \t$self->wait_for_start($env);\n \n+\t$self->{vars}->{dc} = $env;\n+\n \treturn $env;\n }\n \n\nModified: branches/SAMBA_4_0/source/script/tests/TODO\n===================================================================\n--- branches/SAMBA_4_0/source/script/tests/TODO\t2007-04-12 04:01:42 UTC (rev 22184)\n+++ branches/SAMBA_4_0/source/script/tests/TODO\t2007-04-12 08:33:35 UTC (rev 22185)\n@@ -1,5 +1,3 @@\n - warn about unexpected successes\n-- support for environments\n - better way to detect that smbd has finished initialization\n-- allow tests to specify what parameters they need\n- - UNC / DCERPC binding strings\n+- move ldap-specific code into mktestdc.sh\n\nAdded: branches/SAMBA_4_0/source/script/tests/mktestmember.sh\n===================================================================\n--- branches/SAMBA_4_0/source/script/tests/mktestmember.sh\t2007-04-12 04:01:42 UTC (rev 22184)\n+++ branches/SAMBA_4_0/source/script/tests/mktestmember.sh\t2007-04-12 08:33:35 UTC (rev 22185)\n@@ -0,0 +1,85 @@\n+#!/bin/sh\n+\n+if [ $# -lt 4 ]\n+then\n+\techo \"$0 PREFIX DOMAIN USERNAME PASSWORD\"\n+\texit 1\n+fi\n+\n+PREFIX=$1\n+DOMAIN=$2\n+DC_USERNAME=$3\n+DC_PASSWORD=$4\n+shift 4\n+USERNAME=administrator\n+PASSWORD=humbolt\n+\n+SRCDIR=`pwd`\n+oldpwd=`dirname $0`/../..\n+mkdir -p $PREFIX \n+cd $PREFIX\n+PREFIX_ABS=`pwd`\n+ETCDIR=$PREFIX_ABS/etc\n+NCALRPCDIR=$PREFIX_ABS/ncalrpc\n+PIDDIR=$PREFIX_ABS/pid\n+PRIVATEDIR=$PREFIX_ABS/private\n+LOCKDIR=$PREFIX_ABS/lockdir\n+WINBINDD_SOCKET_DIR=$PREFIX_ABS/winbind_socket\n+CONFFILE=$ETCDIR/smb.conf\n+TMPDIR=$PREFIX_ABS/tmp\n+NETBIOSNAME=localmember\n+SMBD_LOGLEVEL=1\n+\n+mkdir -p $PRIVATEDIR $ETCDIR $PIDDIR $NCALRPCDIR $LOCKDIR $TMPDIR\n+\n+cat >$CONFFILE<&2\n+\n+$srcdir/bin/net join member $DOMAIN -U$DC_USERNAME%$DC_PASSWORD >&2 || {\n+\techo \"Join failed\"\n+\texit $?\n+}\n+\n+echo \"PREFIX_ABS=$PREFIX_ABS\"\n+echo \"PIDDIR=$PIDDIR\"\n+echo \"SERVER=$SERVER\"\n+echo \"NETBIOSNAME=$NETBIOSNAME\"\n+echo \"DOMAIN=$DOMAIN\"\n+echo \"USERNAME=$USERNAME\"\n+echo \"REALM=$REALM\"\n+echo \"PASSWORD=$PASSWORD\"\n+echo \"SRCDIR=$SRCDIR\"\n+echo \"PREFIX=$PREFIX\"\n+echo \"CONFFILE=$CONFFILE\"\n+echo \"WINBINDD_SOCKET_DIR=$WINBINDD_SOCKET_DIR\"\n+echo \"NCALRPCDIR=$NCALRPCDIR\"\n+echo \"CONFIGURATION=$CONFIGURATION\"\n\nAdded: branches/SAMBA_4_0/source/script/tests/test_member.sh\n===================================================================\n--- branches/SAMBA_4_0/source/script/tests/test_member.sh\t2007-04-12 04:01:42 UTC (rev 22184)\n+++ branches/SAMBA_4_0/source/script/tests/test_member.sh\t2007-04-12 08:33:35 UTC (rev 22185)\n@@ -0,0 +1,10 @@\n+#!/bin/sh\n+\n+# add tests to this list as they start passing, so we test\n+# that they stay passing\n+ncacn_np_tests=\"RPC-ECHO\"\n+\n+incdir=`dirname $0`\n+. $incdir/test_functions.sh\n+\n+plantest \"RPC-ECHO against member server\" member $VALGRIND bin/smbtorture $TORTURE_OPTIONS ncacn_np:\"\\$SERVER\" -U\"\\$USERNAME\"%\"\\$PASSWORD\" -W \\$DOMAIN $t \"$*\"\n\n\nProperty changes on: branches/SAMBA_4_0/source/script/tests/test_member.sh\n___________________________________________________________________\nName: svn:executable\n   + *\n\n"}