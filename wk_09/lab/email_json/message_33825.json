{"category": "ham", "to_address": "samba-cvs@samba.org", "from_address": "mimir@samba.org", "subject": "svn commit: samba r23047 - in\n\tbranches/SAMBA_4_0/source/scripting/ejs: .", "body": "Author: mimir\nDate: 2007-05-21 19:53:57 +0000 (Mon, 21 May 2007)\nNew Revision: 23047\n\nWebSVN: http://websvn.samba.org/cgi-bin/viewcvs.cgi?view=rev&root=samba&rev=23047\n\nLog:\nAllow local inclusion of js files as well as from predefined\npath(s).\n\n\nrafal\n\n\nModified:\n   branches/SAMBA_4_0/source/scripting/ejs/smbcalls.c\n\n\nChangeset:\nModified: branches/SAMBA_4_0/source/scripting/ejs/smbcalls.c\n===================================================================\n--- branches/SAMBA_4_0/source/scripting/ejs/smbcalls.c\t2007-05-21 19:12:14 UTC (rev 23046)\n+++ branches/SAMBA_4_0/source/scripting/ejs/smbcalls.c\t2007-05-21 19:53:57 UTC (rev 23047)\n@@ -120,17 +120,34 @@\n \n \tfor (i = 0; i < argc; i++) {\n \t\tconst char *script = argv[i];\n+\t\tstruct MprVar result;\n+\t\tchar *path, *emsg;\n+\t\tint ret;\n \n+\t\t/* First, try to include file from current working directory.\n+\t\t   This allows local includes which is handy sometimes. */\n+\t\tpath = talloc_asprintf(mprMemCtx(), \"%s\", script);\n+\t\tif (path == NULL) {\n+\t\t\treturn -1;\n+\t\t}\n+\t\t\n+\t\tif (file_exist(path)) {\n+\t\t\tret = ejsEvalFile(eid, path, &result, &emsg);\n+\t\t\ttalloc_free(path);\n+\t\t\tif (ret < 0) {\n+\t\t\t\tejsSetErrorMsg(eid, \"%s: %s\", script, emsg);\n+\t\t\t\treturn -1;\n+\t\t\t}\n+\t\t\tcontinue;\n+\t\t}\n+\n+\t\t/* use specfied path to search for requested file */\n \t\tfor (j=0;js_include[j];j++) {\n-\t\t\tchar *path;\n \t\t\tpath = talloc_asprintf(mprMemCtx(), \"%s/%s\", js_include[j], script);\n \t\t\tif (path == NULL) {\n \t\t\t\treturn -1;\n \t\t\t}\n \t\t\tif (file_exist(path)) {\n-\t\t\t\tint ret;\n-\t\t\t\tstruct MprVar result;\n-\t\t\t\tchar *emsg;\n \n \t\t\t\tret = ejsEvalFile(eid, path, &result, &emsg);\n \t\t\t\ttalloc_free(path);\n@@ -142,6 +159,7 @@\n \t\t\t}\n \t\t\ttalloc_free(path);\n \t\t}\n+\n \t\tif (js_include[j] == NULL) {\n \t\t\tejsSetErrorMsg(eid, \"unable to include '%s'\", script);\n \t\t\treturn -1;\n\n"}