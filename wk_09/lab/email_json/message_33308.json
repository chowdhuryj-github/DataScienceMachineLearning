{"category": "ham", "to_address": "samba-cvs@samba.org", "from_address": "vlendec@samba.org", "subject": "svn commit: samba r23023 - in branches: SAMBA_3_0/source/lib\n\tSAMBA_3_0/source/printing SAMBA_3_0_26/source/lib\n\tSAMBA_3_0_26/source/printing", "body": "Author: vlendec\nDate: 2007-05-20 19:43:49 +0000 (Sun, 20 May 2007)\nNew Revision: 23023\n\nWebSVN: http://websvn.samba.org/cgi-bin/viewcvs.cgi?view=rev&root=samba&rev=23023\n\nLog:\nGet rid of the only caller of message_send_pid_with_timeout(). This replaces\nthe timeouts on the individual message send calls with an overall timeout on\nall the calls.\n\nThe timeout in message_send_pid_with_timeout() did not make much sense IMO\nanyway, because the tdb_fetch() for the messages_pending_for_pid was blocking\nin a readlock anyway, we \"just\" did the timeout for the write lock.\n\nThis new code goes through the full wait for the write lock once and then\nbreaks out of sending the notifies instead of running into the timeout per\ntarget.\n\nJerry, please check this!\n\nThanks,\n\nVolker\n\n\nModified:\n   branches/SAMBA_3_0/source/lib/messages.c\n   branches/SAMBA_3_0/source/printing/notify.c\n   branches/SAMBA_3_0_26/source/lib/messages.c\n   branches/SAMBA_3_0_26/source/printing/notify.c\n\n\nChangeset:\nModified: branches/SAMBA_3_0/source/lib/messages.c\n===================================================================\n--- branches/SAMBA_3_0/source/lib/messages.c\t2007-05-20 17:00:18 UTC (rev 23022)\n+++ branches/SAMBA_3_0/source/lib/messages.c\t2007-05-20 19:43:49 UTC (rev 23023)\n@@ -872,14 +872,4 @@\n \treturn messaging_send(msg_ctx, server, msg_type, &blob);\n }\n \n-NTSTATUS messaging_send_buf_with_timeout(struct messaging_context *msg_ctx,\n-\t\t\t\t\t struct server_id server,\n-\t\t\t\t\t uint32_t msg_type,\n-\t\t\t\t\t const uint8 *buf, size_t len,\n-\t\t\t\t\t int timeout)\n-{\n-\treturn message_send_pid_internal(server, msg_type, buf, len,\n-\t\t\t\t\t True, timeout);\n-}\n-\n /** @} **/\n\nModified: branches/SAMBA_3_0/source/printing/notify.c\n===================================================================\n--- branches/SAMBA_3_0/source/printing/notify.c\t2007-05-20 17:00:18 UTC (rev 23022)\n+++ branches/SAMBA_3_0/source/printing/notify.c\t2007-05-20 19:43:49 UTC (rev 23023)\n@@ -126,6 +126,7 @@\n \tsize_t num_pids = 0;\n \tsize_t i;\n \tpid_t *pid_list = NULL;\n+\tstruct timeval end_time = timeval_zero();\n \n \t/* Count the space needed to send the messages. */\n \tfor (pq = notify_queue_head; pq; pq = pq->next) {\n@@ -177,6 +178,10 @@\n \tif (!print_notify_pid_list(printer, send_ctx, &num_pids, &pid_list))\n \t\treturn;\n \n+\tif (timeout != 0) {\n+\t\tend_time = timeval_current_ofs(timeout, 0);\n+\t}\n+\n \tfor (i = 0; i < num_pids; i++) {\n \t\tunsigned int q_len = messages_pending_for_pid(pid_to_procid(pid_list[i]));\n \t\tif (q_len > 1000) {\n@@ -184,11 +189,14 @@\n \t\t\t\tprinter, q_len ));\n \t\t\tcontinue;\n \t\t}\n-\t\tmessaging_send_buf_with_timeout(msg_ctx,\n-\t\t\t\t\t\tpid_to_procid(pid_list[i]),\n-\t\t\t\t\t\tMSG_PRINTER_NOTIFY2,\n-\t\t\t\t\t\t(uint8 *)buf, offset,\n-\t\t\t\t\t\ttimeout);\n+\t\tmessaging_send_buf(msg_ctx,\n+\t\t\t\t   pid_to_procid(pid_list[i]),\n+\t\t\t\t   MSG_PRINTER_NOTIFY2,\n+\t\t\t\t   (uint8 *)buf, offset);\n+\n+\t\tif ((timeout != 0) && timeval_expired(&end_time)) {\n+\t\t\tbreak;\n+\t\t}\n \t}\n }\n \n\nModified: branches/SAMBA_3_0_26/source/lib/messages.c\n===================================================================\n--- branches/SAMBA_3_0_26/source/lib/messages.c\t2007-05-20 17:00:18 UTC (rev 23022)\n+++ branches/SAMBA_3_0_26/source/lib/messages.c\t2007-05-20 19:43:49 UTC (rev 23023)\n@@ -872,14 +872,4 @@\n \treturn messaging_send(msg_ctx, server, msg_type, &blob);\n }\n \n-NTSTATUS messaging_send_buf_with_timeout(struct messaging_context *msg_ctx,\n-\t\t\t\t\t struct server_id server,\n-\t\t\t\t\t uint32_t msg_type,\n-\t\t\t\t\t const uint8 *buf, size_t len,\n-\t\t\t\t\t int timeout)\n-{\n-\treturn message_send_pid_internal(server, msg_type, buf, len,\n-\t\t\t\t\t True, timeout);\n-}\n-\n /** @} **/\n\nModified: branches/SAMBA_3_0_26/source/printing/notify.c\n===================================================================\n--- branches/SAMBA_3_0_26/source/printing/notify.c\t2007-05-20 17:00:18 UTC (rev 23022)\n+++ branches/SAMBA_3_0_26/source/printing/notify.c\t2007-05-20 19:43:49 UTC (rev 23023)\n@@ -126,6 +126,7 @@\n \tsize_t num_pids = 0;\n \tsize_t i;\n \tpid_t *pid_list = NULL;\n+\tstruct timeval end_time = timeval_zero();\n \n \t/* Count the space needed to send the messages. */\n \tfor (pq = notify_queue_head; pq; pq = pq->next) {\n@@ -177,6 +178,10 @@\n \tif (!print_notify_pid_list(printer, send_ctx, &num_pids, &pid_list))\n \t\treturn;\n \n+\tif (timeout != 0) {\n+\t\tend_time = timeval_current_ofs(timeout, 0);\n+\t}\n+\n \tfor (i = 0; i < num_pids; i++) {\n \t\tunsigned int q_len = messages_pending_for_pid(pid_to_procid(pid_list[i]));\n \t\tif (q_len > 1000) {\n@@ -184,11 +189,14 @@\n \t\t\t\tprinter, q_len ));\n \t\t\tcontinue;\n \t\t}\n-\t\tmessaging_send_buf_with_timeout(msg_ctx,\n-\t\t\t\t\t\tpid_to_procid(pid_list[i]),\n-\t\t\t\t\t\tMSG_PRINTER_NOTIFY2,\n-\t\t\t\t\t\t(uint8 *)buf, offset,\n-\t\t\t\t\t\ttimeout);\n+\t\tmessaging_send_buf(msg_ctx,\n+\t\t\t\t   pid_to_procid(pid_list[i]),\n+\t\t\t\t   MSG_PRINTER_NOTIFY2,\n+\t\t\t\t   (uint8 *)buf, offset);\n+\n+\t\tif ((timeout != 0) && timeval_expired(&end_time)) {\n+\t\t\tbreak;\n+\t\t}\n \t}\n }\n \n\n"}