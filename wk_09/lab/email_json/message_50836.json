{"category": "ham", "to_address": "samba-technical <samba-technical@samba.org>,\n   \"'Jeremy Allison'\" <jra@samba.org>", "from_address": "Todd Stecher <todd.stecher@isilon.com>", "subject": "Problem with DELETE_ON_CLOSE open_file_ntcreate()?", "body": "We're running 3.0.24.\n\nHere's the scenario:\n\n*\tA file exists on our share\n* \tAn XP client opens the file:\n\tCreateFile(file, DELETE, 0, NULL, OPEN_EXISTING, DELETE_ON_CLOSE)  \napi) with DELETE_ON_CLOSE (only 1 opener of file)\n\n* \tThe file handle is closed, the file is NOT deleted.\n\nThis same series of steps succeeds on Windows (e.g. file is deleted  \nwhen handle is closed).  It also used to work on our old 3.0.11  \ndistribution.  I debugged it, and it appears as if the  \nFILE_DELETE_ON_CLOSE flag is not setting the fsp- \n >initial_delete_on_close, or lock->delete_on_close appropriately for  \nexisting files:\n\n\nreply_ntcreateX: flags = 0x10, access_mask = 0x110080 file_attributes  \n= 0x0, share_access = 0x0, create_disposition = 0x1 create_options =  \n0x1000 root_dir_fid = 0x0\n\nparse_share_modes: delete_on_close: 0, initial_delete_on_close: 0,  \nnum_share_modes: 1\nparse_share_modes: share_mode_entry[0]:  pid = 28233, share_access =  \n0x0, private_options = 0x1000, access_mask = 0x110080, mid = 0x0,  \ntype= 0x10, file_id = 1, uid = 10000, dev = 0x22c1fb52, inode =  \n4295229443, snapid = -1\n\n\nI'm hesitant to \"fix\" this (e.g. set the lock->delete_on_close bit  \nwhen we see the FILE_DELETE_ON_CLOSE option), because there might be  \nsome subtlety I'm missing here.  It also appears that Jeremy's been  \ndoing a lot of work in this area (so maybe its a TODO?).  Upgrading  \nto a newer version of Samba is not an option, but if there's a one  \nline fix I'm missing, that'd be great.  If its just an oversite, I'll  \nsubmit a patch.\n\nThanks!\n\nTodd\n\n\n\n\nTodd Stecher | Windows Interop Dev\nIsilon Systems    P +1-206-315-7500     F  +1-206-315-7501\nwww.isilon.com    D +1-206-315-7638    M +1-425-205-1180\n\n\n\n"}