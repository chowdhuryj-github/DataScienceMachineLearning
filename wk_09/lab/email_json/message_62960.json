{"category": "ham", "to_address": "samba-cvs@samba.org", "from_address": "vlendec@samba.org", "subject": "svn commit: samba r23727 - in branches/SAMBA_3_0/source/smbd: .", "body": "Author: vlendec\nDate: 2007-07-05 16:36:15 +0000 (Thu, 05 Jul 2007)\nNew Revision: 23727\n\nWebSVN: http://websvn.samba.org/cgi-bin/viewcvs.cgi?view=rev&root=samba&rev=23727\n\nLog:\nExplicitly pass down FLAGS2 to srvstr_get_path.\n\nNext step is to remove the bug that in the trans2 code we use the inbuf\nas the base pointer to decide whether we need ucs2 alignment where we\nneed to use the beginning of the params buffer\n\nJeremy, last one for today to reviw :-)\n\n\nModified:\n   branches/SAMBA_3_0/source/smbd/nttrans.c\n   branches/SAMBA_3_0/source/smbd/reply.c\n   branches/SAMBA_3_0/source/smbd/trans2.c\n\n\nChangeset:\nModified: branches/SAMBA_3_0/source/smbd/nttrans.c\n===================================================================\n--- branches/SAMBA_3_0/source/smbd/nttrans.c\t2007-07-05 16:33:37 UTC (rev 23726)\n+++ branches/SAMBA_3_0/source/smbd/nttrans.c\t2007-07-05 16:36:15 UTC (rev 23727)\n@@ -562,7 +562,9 @@\n \n \t\tif(!dir_fsp->is_directory) {\n \n-\t\t\tsrvstr_get_path(inbuf, fname, smb_buf(inbuf), sizeof(fname), 0, STR_TERMINATE, &status);\n+\t\t\tsrvstr_get_path(inbuf, SVAL(inbuf,smb_flg2), fname,\n+\t\t\t\t\tsmb_buf(inbuf), sizeof(fname), 0,\n+\t\t\t\t\tSTR_TERMINATE, &status);\n \t\t\tif (!NT_STATUS_IS_OK(status)) {\n \t\t\t\tEND_PROFILE(SMBntcreateX);\n \t\t\t\treturn ERROR_NT(status);\n@@ -604,14 +606,18 @@\n \t\t\tdir_name_len++;\n \t\t}\n \n-\t\tsrvstr_get_path(inbuf, rel_fname, smb_buf(inbuf), sizeof(rel_fname), 0, STR_TERMINATE, &status);\n+\t\tsrvstr_get_path(inbuf, SVAL(inbuf,smb_flg2), rel_fname,\n+\t\t\t\tsmb_buf(inbuf), sizeof(rel_fname), 0,\n+\t\t\t\tSTR_TERMINATE, &status);\n \t\tif (!NT_STATUS_IS_OK(status)) {\n \t\t\tEND_PROFILE(SMBntcreateX);\n \t\t\treturn ERROR_NT(status);\n \t\t}\n \t\tpstrcat(fname, rel_fname);\n \t} else {\n-\t\tsrvstr_get_path(inbuf, fname, smb_buf(inbuf), sizeof(fname), 0, STR_TERMINATE, &status);\n+\t\tsrvstr_get_path(inbuf, SVAL(inbuf,smb_flg2), fname,\n+\t\t\t\tsmb_buf(inbuf), sizeof(fname), 0,\n+\t\t\t\tSTR_TERMINATE, &status);\n \t\tif (!NT_STATUS_IS_OK(status)) {\n \t\t\tEND_PROFILE(SMBntcreateX);\n \t\t\treturn ERROR_NT(status);\n@@ -1011,7 +1017,9 @@\n \n \tflags = IVAL(params,0);\n \n-\tsrvstr_get_path(inbuf, fname, params+53, sizeof(fname), parameter_count-53, STR_TERMINATE, &status);\n+\tsrvstr_get_path(inbuf, SVAL(inbuf,smb_flg2), fname, params+53,\n+\t\t\tsizeof(fname), parameter_count-53, STR_TERMINATE,\n+\t\t\t&status);\n \tif (!NT_STATUS_IS_OK(status)) {\n \t\treturn ERROR_NT(status);\n \t}\n@@ -1288,7 +1296,10 @@\n \t\t}\n \n \t\tif(!dir_fsp->is_directory) {\n-\t\t\tsrvstr_get_path(inbuf, fname, params+53, sizeof(fname), parameter_count-53, STR_TERMINATE, &status);\n+\t\t\tsrvstr_get_path(inbuf, SVAL(inbuf,smb_flg2), fname,\n+\t\t\t\t\tparams+53, sizeof(fname),\n+\t\t\t\t\tparameter_count-53, STR_TERMINATE,\n+\t\t\t\t\t&status);\n \t\t\tif (!NT_STATUS_IS_OK(status)) {\n \t\t\t\treturn ERROR_NT(status);\n \t\t\t}\n@@ -1322,14 +1333,19 @@\n \n \t\t{\n \t\t\tpstring tmpname;\n-\t\t\tsrvstr_get_path(inbuf, tmpname, params+53, sizeof(tmpname), parameter_count-53, STR_TERMINATE, &status);\n+\t\t\tsrvstr_get_path(inbuf, SVAL(inbuf,smb_flg2), tmpname,\n+\t\t\t\t\tparams+53, sizeof(tmpname),\n+\t\t\t\t\tparameter_count-53, STR_TERMINATE,\n+\t\t\t\t\t&status);\n \t\t\tif (!NT_STATUS_IS_OK(status)) {\n \t\t\t\treturn ERROR_NT(status);\n \t\t\t}\n \t\t\tpstrcat(fname, tmpname);\n \t\t}\n \t} else {\n-\t\tsrvstr_get_path(inbuf, fname, params+53, sizeof(fname), parameter_count-53, STR_TERMINATE, &status);\n+\t\tsrvstr_get_path(inbuf, SVAL(inbuf,smb_flg2), fname, params+53,\n+\t\t\t\tsizeof(fname), parameter_count-53,\n+\t\t\t\tSTR_TERMINATE, &status);\n \t\tif (!NT_STATUS_IS_OK(status)) {\n \t\t\treturn ERROR_NT(status);\n \t\t}\n@@ -1842,7 +1858,9 @@\n \tinit_smb_request(&req, (uint8 *)inbuf);\n \n \tp = smb_buf(inbuf) + 1;\n-\tp += srvstr_get_path_wcard(inbuf, oldname, p, sizeof(oldname), 0, STR_TERMINATE, &status, &src_has_wcard);\n+\tp += srvstr_get_path_wcard(inbuf, SVAL(inbuf,smb_flg2), oldname, p,\n+\t\t\t\t   sizeof(oldname), 0, STR_TERMINATE, &status,\n+\t\t\t\t   &src_has_wcard);\n \tif (!NT_STATUS_IS_OK(status)) {\n \t\tEND_PROFILE(SMBntrename);\n \t\treturn ERROR_NT(status);\n@@ -1860,7 +1878,9 @@\n \t}\n \n \tp++;\n-\tp += srvstr_get_path_wcard(inbuf, newname, p, sizeof(newname), 0, STR_TERMINATE, &status, &dest_has_wcard);\n+\tp += srvstr_get_path_wcard(inbuf, SVAL(inbuf,smb_flg2), newname, p,\n+\t\t\t\t   sizeof(newname), 0, STR_TERMINATE, &status,\n+\t\t\t\t   &dest_has_wcard);\n \tif (!NT_STATUS_IS_OK(status)) {\n \t\tEND_PROFILE(SMBntrename);\n \t\treturn ERROR_NT(status);\n@@ -2054,8 +2074,9 @@\n \tfsp = file_fsp(params, 0);\n \treplace_if_exists = (SVAL(params,2) & RENAME_REPLACE_IF_EXISTS) ? True : False;\n \tCHECK_FSP(fsp, conn);\n-\tsrvstr_get_path_wcard(inbuf, new_name, params+4, sizeof(new_name), parameter_count - 4,\n-\t\t\tSTR_TERMINATE, &status, &dest_has_wcard);\n+\tsrvstr_get_path_wcard(inbuf, SVAL(inbuf,smb_flg2), new_name, params+4,\n+\t\t\t      sizeof(new_name), parameter_count - 4,\n+\t\t\t      STR_TERMINATE, &status, &dest_has_wcard);\n \tif (!NT_STATUS_IS_OK(status)) {\n \t\treturn ERROR_NT(status);\n \t}\n\nModified: branches/SAMBA_3_0/source/smbd/reply.c\n===================================================================\n--- branches/SAMBA_3_0/source/smbd/reply.c\t2007-07-05 16:33:37 UTC (rev 23726)\n+++ branches/SAMBA_3_0/source/smbd/reply.c\t2007-07-05 16:36:15 UTC (rev 23727)\n@@ -209,8 +209,9 @@\n  Pull a string and check the path allowing a wilcard - provide for error return.\n ****************************************************************************/\n \n-size_t srvstr_get_path_wcard(char *inbuf, char *dest, const char *src, size_t dest_len, size_t src_len, int flags,\n-\t\t\t\tNTSTATUS *err, BOOL *contains_wcard)\n+size_t srvstr_get_path_wcard(char *inbuf, uint16 smb_flags2, char *dest,\n+\t\t\t     const char *src, size_t dest_len, size_t src_len,\n+\t\t\t     int flags, NTSTATUS *err, BOOL *contains_wcard)\n {\n \tsize_t ret;\n #ifdef DEVELOPER\n@@ -218,10 +219,10 @@\n #endif\n \n \tif (src_len == 0) {\n-\t\tret = srvstr_pull_buf(inbuf, SVAL(inbuf, smb_flg2), dest, src,\n+\t\tret = srvstr_pull_buf(inbuf, smb_flags2, dest, src,\n \t\t\t\t      dest_len, flags);\n \t} else {\n-\t\tret = srvstr_pull(inbuf, SVAL(inbuf, smb_flg2), dest, src,\n+\t\tret = srvstr_pull(inbuf, smb_flags2, dest, src,\n \t\t\t\t  dest_len, src_len, flags);\n \t}\n \n@@ -249,7 +250,9 @@\n  Pull a string and check the path - provide for error return.\n ****************************************************************************/\n \n-size_t srvstr_get_path(char *inbuf, char *dest, const char *src, size_t dest_len, size_t src_len, int flags, NTSTATUS *err)\n+size_t srvstr_get_path(char *inbuf, uint16 smb_flags2, char *dest,\n+\t\t       const char *src, size_t dest_len, size_t src_len,\n+\t\t       int flags, NTSTATUS *err)\n {\n \tsize_t ret;\n #ifdef DEVELOPER\n@@ -257,14 +260,14 @@\n #endif\n \n \tif (src_len == 0) {\n-\t\tret = srvstr_pull_buf(inbuf, SVAL(inbuf, smb_flg2), dest, src,\n+\t\tret = srvstr_pull_buf(inbuf, smb_flags2, dest, src,\n \t\t\t\t      dest_len, flags);\n \t} else {\n-\t\tret = srvstr_pull(inbuf, SVAL(inbuf, smb_flg2), dest, src,\n+\t\tret = srvstr_pull(inbuf, smb_flags2, dest, src,\n \t\t\t\t  dest_len, src_len, flags);\n \t}\n \n-\tif (SVAL(inbuf,smb_flg2) & FLAGS2_DFS_PATHNAMES) {\n+\tif (smb_flags2 & FLAGS2_DFS_PATHNAMES) {\n \t\t/* \n \t\t * For a DFS path the function parse_dfs_path()\n \t\t * will do the path processing, just make a copy.\n@@ -681,7 +684,8 @@\n \n \tSTART_PROFILE(SMBcheckpath);\n \n-\tsrvstr_get_path(inbuf, name, smb_buf(inbuf) + 1, sizeof(name), 0, STR_TERMINATE, &status);\n+\tsrvstr_get_path(inbuf, SVAL(inbuf,smb_flg2), name, smb_buf(inbuf) + 1,\n+\t\t\tsizeof(name), 0, STR_TERMINATE, &status);\n \tif (!NT_STATUS_IS_OK(status)) {\n \t\tEND_PROFILE(SMBcheckpath);\n \t\tstatus = map_checkpath_error(inbuf, status);\n@@ -768,7 +772,8 @@\n \tSTART_PROFILE(SMBgetatr);\n \n \tp = smb_buf(inbuf) + 1;\n-\tp += srvstr_get_path(inbuf, fname, p, sizeof(fname), 0, STR_TERMINATE, &status);\n+\tp += srvstr_get_path(inbuf, SVAL(inbuf,smb_flg2), fname, p,\n+\t\t\t     sizeof(fname), 0, STR_TERMINATE, &status);\n \tif (!NT_STATUS_IS_OK(status)) {\n \t\tEND_PROFILE(SMBgetatr);\n \t\treturn ERROR_NT(status);\n@@ -854,7 +859,8 @@\n \tSTART_PROFILE(SMBsetatr);\n \n \tp = smb_buf(inbuf) + 1;\n-\tp += srvstr_get_path(inbuf, fname, p, sizeof(fname), 0, STR_TERMINATE, &status);\n+\tp += srvstr_get_path(inbuf, SVAL(inbuf,smb_flg2), fname, p,\n+\t\t\t     sizeof(fname), 0, STR_TERMINATE, &status);\n \tif (!NT_STATUS_IS_OK(status)) {\n \t\tEND_PROFILE(SMBsetatr);\n \t\treturn ERROR_NT(status);\n@@ -1016,7 +1022,9 @@\n \tmaxentries = SVAL(inbuf,smb_vwv0); \n \tdirtype = SVAL(inbuf,smb_vwv1);\n \tp = smb_buf(inbuf) + 1;\n-\tp += srvstr_get_path_wcard(inbuf, path, p, sizeof(path), 0, STR_TERMINATE, &nt_status, &mask_contains_wcard);\n+\tp += srvstr_get_path_wcard(inbuf, SVAL(inbuf,smb_flg2), path, p,\n+\t\t\t\t   sizeof(path), 0, STR_TERMINATE, &nt_status,\n+\t\t\t\t   &mask_contains_wcard);\n \tif (!NT_STATUS_IS_OK(nt_status)) {\n \t\tEND_PROFILE(SMBsearch);\n \t\treturn ERROR_NT(nt_status);\n@@ -1221,7 +1229,9 @@\n \n \toutsize = set_message(inbuf,outbuf,1,0,True);\n \tp = smb_buf(inbuf) + 1;\n-\tp += srvstr_get_path_wcard(inbuf, path, p, sizeof(path), 0, STR_TERMINATE, &err, &path_contains_wcard);\n+\tp += srvstr_get_path_wcard(inbuf, SVAL(inbuf,smb_flg2), path, p,\n+\t\t\t\t   sizeof(path), 0, STR_TERMINATE, &err,\n+\t\t\t\t   &path_contains_wcard);\n \tif (!NT_STATUS_IS_OK(err)) {\n \t\tEND_PROFILE(SMBfclose);\n \t\treturn ERROR_NT(err);\n@@ -1280,7 +1290,8 @@\n  \n \tdeny_mode = SVAL(inbuf,smb_vwv0);\n \n-\tsrvstr_get_path(inbuf, fname, smb_buf(inbuf)+1, sizeof(fname), 0, STR_TERMINATE, &status);\n+\tsrvstr_get_path(inbuf, SVAL(inbuf,smb_flg2), fname, smb_buf(inbuf)+1,\n+\t\t\tsizeof(fname), 0, STR_TERMINATE, &status);\n \tif (!NT_STATUS_IS_OK(status)) {\n \t\tEND_PROFILE(SMBopen);\n \t\treturn ERROR_NT(status);\n@@ -1414,7 +1425,8 @@\n \t}\n \n \t/* XXXX we need to handle passed times, sattr and flags */\n-\tsrvstr_get_path(inbuf, fname, smb_buf(inbuf), sizeof(fname), 0, STR_TERMINATE, &status);\n+\tsrvstr_get_path(inbuf, SVAL(inbuf,smb_flg2), fname, smb_buf(inbuf),\n+\t\t\tsizeof(fname), 0, STR_TERMINATE, &status);\n \tif (!NT_STATUS_IS_OK(status)) {\n \t\tEND_PROFILE(SMBopenX);\n \t\treturn ERROR_NT(status);\n@@ -1602,7 +1614,8 @@\n \n \tts[1] = convert_time_t_to_timespec(srv_make_unix_date3(inbuf + smb_vwv1)); /* mtime. */\n \n-\tsrvstr_get_path(inbuf, fname, smb_buf(inbuf) + 1, sizeof(fname), 0, STR_TERMINATE, &status);\n+\tsrvstr_get_path(inbuf, SVAL(inbuf,smb_flg2), fname, smb_buf(inbuf) + 1,\n+\t\t\tsizeof(fname), 0, STR_TERMINATE, &status);\n \tif (!NT_STATUS_IS_OK(status)) {\n \t\tEND_PROFILE(SMBcreate);\n \t\treturn ERROR_NT(status);\n@@ -1703,7 +1716,8 @@\n \n \tinit_smb_request(&req, (uint8 *)inbuf);\n \n-\tsrvstr_get_path(inbuf, fname, smb_buf(inbuf)+1, sizeof(fname), 0, STR_TERMINATE, &status);\n+\tsrvstr_get_path(inbuf, SVAL(inbuf,smb_flg2), fname, smb_buf(inbuf)+1,\n+\t\t\tsizeof(fname), 0, STR_TERMINATE, &status);\n \tif (!NT_STATUS_IS_OK(status)) {\n \t\tEND_PROFILE(SMBctemp);\n \t\treturn ERROR_NT(status);\n@@ -2111,7 +2125,9 @@\n \n \tdirtype = SVAL(inbuf,smb_vwv0);\n \t\n-\tsrvstr_get_path_wcard(inbuf, name, smb_buf(inbuf) + 1, sizeof(name), 0, STR_TERMINATE, &status, &path_contains_wcard);\n+\tsrvstr_get_path_wcard(inbuf, SVAL(inbuf,smb_flg2), name,\n+\t\t\t      smb_buf(inbuf) + 1, sizeof(name), 0,\n+\t\t\t      STR_TERMINATE, &status, &path_contains_wcard);\n \tif (!NT_STATUS_IS_OK(status)) {\n \t\tEND_PROFILE(SMBunlink);\n \t\treturn ERROR_NT(status);\n@@ -3834,7 +3850,9 @@\n \n \tSTART_PROFILE(SMBmkdir);\n  \n-\tsrvstr_get_path(inbuf, directory, smb_buf(inbuf) + 1, sizeof(directory), 0, STR_TERMINATE, &status);\n+\tsrvstr_get_path(inbuf, SVAL(inbuf,smb_flg2), directory,\n+\t\t\tsmb_buf(inbuf) + 1, sizeof(directory), 0,\n+\t\t\tSTR_TERMINATE, &status);\n \tif (!NT_STATUS_IS_OK(status)) {\n \t\tEND_PROFILE(SMBmkdir);\n \t\treturn ERROR_NT(status);\n@@ -4075,7 +4093,9 @@\n \tNTSTATUS status;\n \tSTART_PROFILE(SMBrmdir);\n \n-\tsrvstr_get_path(inbuf, directory, smb_buf(inbuf) + 1, sizeof(directory), 0, STR_TERMINATE, &status);\n+\tsrvstr_get_path(inbuf, SVAL(inbuf,smb_flg2), directory,\n+\t\t\tsmb_buf(inbuf) + 1, sizeof(directory), 0,\n+\t\t\tSTR_TERMINATE, &status);\n \tif (!NT_STATUS_IS_OK(status)) {\n \t\tEND_PROFILE(SMBrmdir);\n \t\treturn ERROR_NT(status);\n@@ -4765,13 +4785,17 @@\n \tinit_smb_request(&req, (uint8 *)inbuf);\n \n \tp = smb_buf(inbuf) + 1;\n-\tp += srvstr_get_path_wcard(inbuf, name, p, sizeof(name), 0, STR_TERMINATE, &status, &src_has_wcard);\n+\tp += srvstr_get_path_wcard(inbuf, SVAL(inbuf,smb_flg2), name, p,\n+\t\t\t\t   sizeof(name), 0, STR_TERMINATE, &status,\n+\t\t\t\t   &src_has_wcard);\n \tif (!NT_STATUS_IS_OK(status)) {\n \t\tEND_PROFILE(SMBmv);\n \t\treturn ERROR_NT(status);\n \t}\n \tp++;\n-\tp += srvstr_get_path_wcard(inbuf, newname, p, sizeof(newname), 0, STR_TERMINATE, &status, &dest_has_wcard);\n+\tp += srvstr_get_path_wcard(inbuf, SVAL(inbuf,smb_flg2), newname, p,\n+\t\t\t\t   sizeof(newname), 0, STR_TERMINATE, &status,\n+\t\t\t\t   &dest_has_wcard);\n \tif (!NT_STATUS_IS_OK(status)) {\n \t\tEND_PROFILE(SMBmv);\n \t\treturn ERROR_NT(status);\n@@ -4960,12 +4984,16 @@\n \t*directory = *mask = 0;\n \n \tp = smb_buf(inbuf);\n-\tp += srvstr_get_path_wcard(inbuf, name, p, sizeof(name), 0, STR_TERMINATE, &status, &source_has_wild);\n+\tp += srvstr_get_path_wcard(inbuf, SVAL(inbuf,smb_flg2), name, p,\n+\t\t\t\t   sizeof(name), 0, STR_TERMINATE, &status,\n+\t\t\t\t   &source_has_wild);\n \tif (!NT_STATUS_IS_OK(status)) {\n \t\tEND_PROFILE(SMBcopy);\n \t\treturn ERROR_NT(status);\n \t}\n-\tp += srvstr_get_path_wcard(inbuf, newname, p, sizeof(newname), 0, STR_TERMINATE, &status, &dest_has_wild);\n+\tp += srvstr_get_path_wcard(inbuf, SVAL(inbuf,smb_flg2), newname, p,\n+\t\t\t\t   sizeof(newname), 0, STR_TERMINATE, &status,\n+\t\t\t\t   &dest_has_wild);\n \tif (!NT_STATUS_IS_OK(status)) {\n \t\tEND_PROFILE(SMBcopy);\n \t\treturn ERROR_NT(status);\n@@ -5181,7 +5209,9 @@\n \t\treturn ERROR_DOS(ERRDOS,ERRnoaccess);\n \t}\n \n-\tsrvstr_get_path(inbuf, newdir, smb_buf(inbuf) + 1, sizeof(newdir), 0, STR_TERMINATE, &status);\n+\tsrvstr_get_path(inbuf, SVAL(inbuf,smb_flg2), newdir,\n+\t\t\tsmb_buf(inbuf) + 1, sizeof(newdir), 0, STR_TERMINATE,\n+\t\t\t&status);\n \tif (!NT_STATUS_IS_OK(status)) {\n \t\tEND_PROFILE(pathworks_setdir);\n \t\treturn ERROR_NT(status);\n\nModified: branches/SAMBA_3_0/source/smbd/trans2.c\n===================================================================\n--- branches/SAMBA_3_0/source/smbd/trans2.c\t2007-07-05 16:33:37 UTC (rev 23726)\n+++ branches/SAMBA_3_0/source/smbd/trans2.c\t2007-07-05 16:36:15 UTC (rev 23727)\n@@ -804,7 +804,9 @@\n \t\treturn(ERROR_DOS(ERRSRV,ERRaccess));\n \t}\n \n-\tsrvstr_get_path(inbuf, fname, pname, sizeof(fname), total_params - 28, STR_TERMINATE, &status);\n+\tsrvstr_get_path(inbuf, SVAL(inbuf,smb_flg2), fname, pname,\n+\t\t\tsizeof(fname), total_params - 28, STR_TERMINATE,\n+\t\t\t&status);\n \tif (!NT_STATUS_IS_OK(status)) {\n \t\treturn ERROR_NT(status);\n \t}\n@@ -1747,7 +1749,9 @@\n \t\t\treturn ERROR_NT(NT_STATUS_INVALID_LEVEL);\n \t}\n \n-\tsrvstr_get_path_wcard(inbuf, directory, params+12, sizeof(directory), total_params - 12, STR_TERMINATE, &ntstatus, &mask_contains_wcard);\n+\tsrvstr_get_path_wcard(inbuf, SVAL(inbuf,smb_flg2), directory,\n+\t\t\t      params+12, sizeof(directory), total_params - 12,\n+\t\t\t      STR_TERMINATE, &ntstatus, &mask_contains_wcard);\n \tif (!NT_STATUS_IS_OK(ntstatus)) {\n \t\treturn ERROR_NT(ntstatus);\n \t}\n@@ -2012,7 +2016,10 @@\n \n \t*mask = *directory = *resume_name = 0;\n \n-\tsrvstr_get_path_wcard(inbuf, resume_name, params+12, sizeof(resume_name), total_params - 12, STR_TERMINATE, &ntstatus, &mask_contains_wcard);\n+\tsrvstr_get_path_wcard(inbuf, SVAL(inbuf,smb_flg2), resume_name,\n+\t\t\t      params+12, sizeof(resume_name),\n+\t\t\t      total_params - 12, STR_TERMINATE, &ntstatus,\n+\t\t\t      &mask_contains_wcard);\n \tif (!NT_STATUS_IS_OK(ntstatus)) {\n \t\t/* Win9x or OS/2 can send a resume name of \"..\" or \".\". This will cause the parser to\n \t\t   complain (it thinks we're asking for the directory above the shared\n@@ -3401,7 +3408,9 @@\n \t\t\treturn ERROR_NT(NT_STATUS_INVALID_LEVEL);\n \t\t}\n \n-\t\tsrvstr_get_path(inbuf, fname, &params[6], sizeof(fname), total_params - 6, STR_TERMINATE, &status);\n+\t\tsrvstr_get_path(inbuf, SVAL(inbuf,smb_flg2), fname, &params[6],\n+\t\t\t\tsizeof(fname), total_params - 6,\n+\t\t\t\tSTR_TERMINATE, &status);\n \t\tif (!NT_STATUS_IS_OK(status)) {\n \t\t\treturn ERROR_NT(status);\n \t\t}\n@@ -4587,7 +4596,8 @@\n \t\treturn NT_STATUS_INVALID_PARAMETER;\n \t}\n \n-\tsrvstr_get_path(inbuf, oldname, pdata, sizeof(oldname), total_data, STR_TERMINATE, &status);\n+\tsrvstr_get_path(inbuf, SVAL(inbuf,smb_flg2), oldname, pdata,\n+\t\t\tsizeof(oldname), total_data, STR_TERMINATE, &status);\n \tif (!NT_STATUS_IS_OK(status)) {\n \t\treturn status;\n \t}\n@@ -4637,7 +4647,9 @@\n \t\treturn NT_STATUS_INVALID_PARAMETER;\n \t}\n \n-\tsrvstr_get_path_wcard(inbuf, newname, &pdata[12], sizeof(newname), len, 0, &status, &dest_has_wcard);\n+\tsrvstr_get_path_wcard(inbuf, SVAL(inbuf,smb_flg2), newname, &pdata[12],\n+\t\t\t      sizeof(newname), len, 0, &status,\n+\t\t\t      &dest_has_wcard);\n \tif (!NT_STATUS_IS_OK(status)) {\n \t\treturn status;\n \t}\n@@ -5850,7 +5862,9 @@\n \t\t}\n \n \t\tinfo_level = SVAL(params,0);    \n-\t\tsrvstr_get_path(inbuf, fname, &params[6], sizeof(fname), total_params - 6, STR_TERMINATE, &status);\n+\t\tsrvstr_get_path(inbuf, SVAL(inbuf,smb_flg2), fname, &params[6],\n+\t\t\t\tsizeof(fname), total_params - 6, STR_TERMINATE,\n+\t\t\t\t&status);\n \t\tif (!NT_STATUS_IS_OK(status)) {\n \t\t\treturn ERROR_NT(status);\n \t\t}\n@@ -6188,7 +6202,9 @@\n \t\treturn ERROR_NT(NT_STATUS_INVALID_PARAMETER);\n \t}\n \n-\tsrvstr_get_path(inbuf, directory, &params[4], sizeof(directory), total_params - 4, STR_TERMINATE, &status);\n+\tsrvstr_get_path(inbuf, SVAL(inbuf,smb_flg2), directory, &params[4],\n+\t\t\tsizeof(directory), total_params - 4, STR_TERMINATE,\n+\t\t\t&status);\n \tif (!NT_STATUS_IS_OK(status)) {\n \t\treturn ERROR_NT(status);\n \t}\n\n"}