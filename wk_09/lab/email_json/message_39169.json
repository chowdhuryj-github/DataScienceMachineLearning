{"category": "ham", "to_address": "samba-technical@lists.samba.org", "from_address": "Jeremy Allison <jra@samba.org>", "subject": "Re: svn commit: samba r23241 - in branches: SAMBA_3_0/source/smbd\n\tSAMBA_3_0_26/source/smbd", "body": "On Wed, May 30, 2007 at 01:41:39PM +0000, vlendec@samba.org wrote:\n> \n> Log:\n> In preparation for the cluster messaging import the parent smbd needs to\n> respond to events.c style events.\n> \n> Modified:\n>    branches/SAMBA_3_0/source/smbd/server.c\n>    branches/SAMBA_3_0_26/source/smbd/server.c\n>  \n> -\t\tnum = sys_select(maxfd+1,&lfds,NULL,NULL,\n> +\t\tevent_add_to_select_args(smbd_event_context(), &now,\n> +\t\t\t\t\t &r_fds, &w_fds, &idle_timeout,\n> +\t\t\t\t\t &maxfd);\n> +\n> +\t\tnum = sys_select(maxfd+1,&r_fds,&w_fds,NULL,\n>  \t\t\t\t timeval_is_zero(&idle_timeout) ?\n>  \t\t\t\t NULL : &idle_timeout);\n>  \t\t\n> +\t\trun_events(smbd_event_context(), num, &r_fds, &w_fds);\n> +\n>  \t\tif (num == -1 && errno == EINTR) {\n>  \t\t\tif (got_sig_term) {\n>  \t\t\t\texit_server_cleanly(NULL);\n> @@ -427,6 +436,10 @@\n>  \t\t\tcontinue;\n>  \t\t}\n\nVolker, I think this patch is incorrect.\n\nYou are calling run_events() before doing the num ==-1 && errno == EINTR\ncheck. Run events can make system calls that will change errno and\nmean this check is no longer valid.\n\nAlso run_events has a return that needs to be checked.\n\nCan you check this really carefully please, I think this\nneeds to be :\n\n                num = sys_select(maxfd+1,&r_fds,&w_fds,NULL,\n                                 timeval_is_zero(&idle_timeout) ?\n                                 NULL : &idle_timeout);\n\n                if (num == -1 && errno == EINTR) {\n\t\t\t....\n\t\t\tcontinue;\n\t\t}\n\n\t\tif (run_events(smbd_event_context(), num, &r_fds, &w_fds)) {\n\t\t\tcontinue;\n\t\t}\n\nJeremy.\n\n"}