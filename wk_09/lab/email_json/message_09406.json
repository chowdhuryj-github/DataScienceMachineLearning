{"category": "ham", "to_address": "samba-cvs@samba.org", "from_address": "tridge@samba.org", "subject": "Rev 156:  in http://samba.org/~tridge/ctdb", "body": "------------------------------------------------------------\nrevno: 156\nrevision-id: tridge@samba.org-20070418235823-f4d1ef1f0f3ac9d6\nparent: tridge@samba.org-20070418231425-4902f5acfc663227\ncommitter: Andrew Tridgell \nbranch nick: tridge\ntimestamp: Thu 2007-04-19 09:58:23 +1000\nmessage:\n  \n  - use separate directories for the tdb files by default\n  - use TDB_CLEAR_IF_FIRST to ensure we don't use an old tdb\nmodified:\n  common/cmdline.c               cmdline.c-20070416041216-w1zvz91bkdsgjckw-1\n  common/ctdb_ltdb.c             ctdb_ltdb.c-20061128065342-to93h6eejj5kon81-2\n=== modified file 'common/cmdline.c'\n--- a/common/cmdline.c\t2007-04-18 23:14:25 +0000\n+++ b/common/cmdline.c\t2007-04-18 23:58:23 +0000\n@@ -37,7 +37,7 @@\n \t.transport = \"tcp\",\n \t.myaddress = NULL,\n \t.self_connect = 0,\n-\t.db_dir = \".\"\n+\t.db_dir = NULL\n };\n \n \n\n=== modified file 'common/ctdb_ltdb.c'\n--- a/common/ctdb_ltdb.c\t2007-04-18 14:36:22 +0000\n+++ b/common/ctdb_ltdb.c\t2007-04-18 23:58:23 +0000\n@@ -82,6 +82,13 @@\n \t\t}\n \t}\n \n+\tif (mkdir(ctdb->db_directory, 0700) == -1 && errno != EEXIST) {\n+\t\tDEBUG(0,(__location__ \" Unable to create ctdb directory '%s'\\n\", \n+\t\t\t ctdb->db_directory));\n+\t\ttalloc_free(ctdb_db);\n+\t\treturn NULL;\n+\t}\n+\n \t/* add the node id to the database name, so when we run on loopback\n \t   we don't conflict in the local filesystem */\n \tname = talloc_asprintf(ctdb_db, \"%s/%s\", ctdb->db_directory, name);\n@@ -89,7 +96,7 @@\n \t/* when we have a separate daemon this will need to be a real\n \t   file, not a TDB_INTERNAL, so the parent can access it to\n \t   for ltdb bypass */\n-\tctdb_db->ltdb = tdb_wrap_open(ctdb, name, 0, TDB_DEFAULT, open_flags, mode);\n+\tctdb_db->ltdb = tdb_wrap_open(ctdb, name, 0, TDB_CLEAR_IF_FIRST, open_flags, mode);\n \tif (ctdb_db->ltdb == NULL) {\n \t\tctdb_set_error(ctdb, \"Failed to open tdb %s\\n\", name);\n \t\ttalloc_free(ctdb_db);\n\n"}