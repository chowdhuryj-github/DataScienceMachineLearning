{"category": "ham", "to_address": "samba-technical@lists.samba.org", "from_address": "Dmitry Shatrov <dhsatrov@linux.vnet.ibm.com>", "subject": "Samba3 memory usage, iconv", "body": "Profiling smbd memory usage with valgrind --tool=massif gives \ninteresting results.\nIt turns out that quite a lot of memory (~300 Kbytes) is allocated right \nat the start of each smbd process by init_iconv() (lib/charcnv.c).\n\nI think that this must be something like conversion tables, which could \nbe shared between smbds giving ~300KB per smbd.\n\nHere's the output from massif for current samba3 from svn (here, I ran \nsmbd and performed mount.cifs //localhost/... after a while):\nhttp://img30.picoodle.com/img/img30/8/7/2/f_massifm_95d3e94.png\n\nmassif output for a clean smbd start:\nhttp://img37.picoodle.com/img/img37/8/7/2/f_smbdm_c99cc1c.png\n...and the most relevant backtraces:\n\nContext accounted for 43.2% of measured spacetime\n  0x81AD8B: __gconv_open (in /lib/tls/libc-2.3.4.so)\n  0x81A8C4: iconv_open (in /lib/tls/libc-2.3.4.so)\n  0x2A0C8E: smb_iconv_open (iconv.c:245)\n  0x2763D7: init_iconv (charcnv.c:156)\n  0x774C9: lp_load (loadparm.c:5410)\n  0x49723C: reload_services (server.c:644)\n  0x497ED0: main (server.c:964)\n  0x819DE2: (below main) (in /lib/tls/libc-2.3.4.so)\n\nContext accounted for 43.1% of measured spacetime\n  0x81AD8B: __gconv_open (in /lib/tls/libc-2.3.4.so)\n  0x81A8C4: iconv_open (in /lib/tls/libc-2.3.4.so)\n  0x2A0C31: smb_iconv_open (iconv.c:237)\n  0x2763D7: init_iconv (charcnv.c:156)\n  0x774C9: lp_load (loadparm.c:5410)\n  0x49723C: reload_services (server.c:644)\n  0x497ED0: main (server.c:964)\n  0x819DE2: (below main) (in /lib/tls/libc-2.3.4.so)\n\nFor comparison, here are massif profiling results for a simple program \nwhich calls iconv_open (\"CP866\", \"UTF8\"), sleeps for a second and then \nexits:\nhttp://img29.picoodle.com/img/img29/8/7/2/f_hellom_46acf01.png\naccording to massif, iconv_open() costs about 30 Kbytes of memory in \nthis case.\n\nPutting fprintf before smb_iconv_open() at charcnv.c:156 shows that \niconv gets initialized for the following conversion pairs (looks like \nquite a lot):\nUTF-16LE, UTF-16LE\nUTF-8, UTF-16LE\nUTF-8, UTF-16LE\nCP850, UTF-16LE\nUTF8, UTF-16LE\nUTF-16BE, UTF-16LE\nUTF-16LE, UTF-8\nUTF-8, UTF-8\nUTF-8, UTF-8\nCP850, UTF-8\nUTF8, UTF-8\nUTF-16BE, UTF-8\nUTF-16LE, UTF-8\nUTF-8, UTF-8\nUTF-8, UTF-8\nCP850, UTF-8\nUTF8, UTF-8\nUTF-16BE, UTF-8\nUTF-16LE, CP850\nUTF-8, CP850\nUTF-8, CP850\nCP850, CP850\nUTF8, CP850\nUTF-16BE, CP850\nUTF-16LE, UTF8\nUTF-8, UTF8\nUTF-8, UTF8\nCP850, UTF8\nUTF8, UTF8\nUTF-16BE, UTF8\nUTF-16LE, UTF-16BE\nUTF-8, UTF-16BE\nUTF-8, UTF-16BE\nCP850, UTF-16BE\nUTF8, UTF-16BE\nUTF-16BE, UTF-16BE\n\nI would deal with this by trying to share as much of common data between \nsmbds as possible by shared memory or file mmap'ing.\nYour suggestions?\n\nBtw, some useful information on memory usage reduction can be found at \nlive.gnome.org:\nhttp://live.gnome.org/MemoryReduction\nThere's a link to a compact overview of using massif, too:\nhttp://developer.gnome.org/doc/guides/optimisation/Massif.html\n\nBest regards,\nDmitry Shatrov\n\n"}