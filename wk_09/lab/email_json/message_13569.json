{"category": "ham", "to_address": "samba-cvs@samba.org", "from_address": "jra@samba.org", "subject": "svn commit: samba r22490 - in branches: SAMBA_3_0/source/smbd\n\tSAMBA_3_0_25/source/smbd", "body": "Author: jra\nDate: 2007-04-23 16:32:24 +0000 (Mon, 23 Apr 2007)\nNew Revision: 22490\n\nWebSVN: http://websvn.samba.org/cgi-bin/viewcvs.cgi?view=rev&root=samba&rev=22490\n\nLog:\nFix a couple of bugs found whist investigating CSC Vista issues.\nEnsure we correctly NULL out allocation size fields. Allow\nQFILEINFO on pipes (Vista bug ?). Jerry - don't automatically\nmerge for 3.0.25.\nJeremy.\n\nModified:\n   branches/SAMBA_3_0/source/smbd/trans2.c\n   branches/SAMBA_3_0_25/source/smbd/trans2.c\n\n\nChangeset:\nModified: branches/SAMBA_3_0/source/smbd/trans2.c\n===================================================================\n--- branches/SAMBA_3_0/source/smbd/trans2.c\t2007-04-23 16:31:31 UTC (rev 22489)\n+++ branches/SAMBA_3_0/source/smbd/trans2.c\t2007-04-23 16:32:24 UTC (rev 22490)\n@@ -2235,6 +2235,12 @@\n \treturn(-1);\n }\n \n+unsigned char *create_volume_objectid(connection_struct *conn, unsigned char objid[16])\n+{\n+\tE_md4hash(lp_servicename(SNUM(conn)),objid);\n+\treturn objid;\n+}\n+\n /****************************************************************************\n  Reply to a TRANS2_QFSINFO (query filesystem info).\n ****************************************************************************/\n@@ -2342,6 +2348,8 @@\n \n \t\t\tSIVAL(pdata,0,FILE_CASE_PRESERVED_NAMES|FILE_CASE_SENSITIVE_SEARCH|\n \t\t\t\t(lp_nt_acl_support(SNUM(conn)) ? FILE_PERSISTENT_ACLS : 0)|\n+\t\t\t\tFILE_SUPPORTS_OBJECT_IDS|\n+\t\t\t\tFILE_UNICODE_ON_DISK|\n \t\t\t\tquota_flag); /* FS ATTRIBUTES */\n \n \t\t\tSIVAL(pdata,4,255); /* Max filename component length */\n@@ -2523,8 +2531,12 @@\n \t\t}\n #endif /* HAVE_SYS_QUOTAS */\n \t\tcase SMB_FS_OBJECTID_INFORMATION:\n+\t\t{\n+\t\t\tunsigned char objid[16];\n+\t\t\tmemcpy(pdata,create_volume_objectid(conn, objid),16);\n \t\t\tdata_len = 64;\n \t\t\tbreak;\n+\t\t}\n \n \t\t/*\n \t\t * Query the version and capabilities of the CIFS UNIX extensions\n@@ -3194,6 +3206,68 @@\n }\n \n /****************************************************************************\n+ Reply to a TRANSACT2_QFILEINFO on a PIPE !\n+****************************************************************************/\n+\n+static int call_trans2qpipeinfo(connection_struct *conn, char *inbuf, char *outbuf, int length, int bufsize,\n+\t\t\t\t\tunsigned int tran_call,\n+\t\t\t\t\tchar **pparams, int total_params, char **ppdata, int total_data,\n+\t\t\t\t\tunsigned int max_data_bytes)\n+{\n+\tchar *params = *pparams;\n+\tchar *pdata = *ppdata;\n+\tunsigned int data_size = 0;\n+\tunsigned int param_size = 2;\n+\tuint16 info_level;\n+\tsmb_np_struct *p_pipe = NULL;\n+\n+\tif (!params) {\n+\t\treturn ERROR_NT(NT_STATUS_INVALID_PARAMETER);\n+\t}\n+\n+\tif (total_params < 4) {\n+\t\treturn ERROR_NT(NT_STATUS_INVALID_PARAMETER);\n+\t}\n+\n+\tp_pipe = get_rpc_pipe_p(params,0);\n+\tif (p_pipe == NULL) {\n+\t\treturn ERROR_NT(NT_STATUS_INVALID_HANDLE);\n+\t}\n+\n+\tinfo_level = SVAL(params,2);\n+\n+\t*pparams = (char *)SMB_REALLOC(*pparams,2);\n+\tif (*pparams == NULL) {\n+\t\treturn ERROR_NT(NT_STATUS_NO_MEMORY);\n+\t}\n+\tparams = *pparams;\n+\tSSVAL(params,0,0);\n+\tdata_size = max_data_bytes + DIR_ENTRY_SAFETY_MARGIN;\n+\t*ppdata = (char *)SMB_REALLOC(*ppdata, data_size); \n+\tif (*ppdata == NULL ) {\n+\t\treturn ERROR_NT(NT_STATUS_NO_MEMORY);\n+\t}\n+\tpdata = *ppdata;\n+\n+\tswitch (info_level) {\n+\t\tcase SMB_FILE_STANDARD_INFORMATION:\n+\t\t\tmemset(pdata,24,0);\n+\t\t\tSOFF_T(pdata,0,4096LL);\n+\t\t\tSIVAL(pdata,16,1);\n+\t\t\tSIVAL(pdata,20,1);\n+\t\t\tdata_size = 24;\n+\t\t\tbreak;\n+\n+\t\tdefault:\n+\t\t\treturn ERROR_NT(NT_STATUS_INVALID_LEVEL);\n+\t}\n+\n+\tsend_trans2_replies(outbuf, bufsize, params, param_size, *ppdata, data_size, max_data_bytes);\n+\n+\treturn(-1);\n+}\n+\n+/****************************************************************************\n  Reply to a TRANS2_QFILEPATHINFO or TRANSACT2_QFILEINFO (query file info by\n  file name or file id).\n ****************************************************************************/\n@@ -3238,6 +3312,20 @@\n \t\t\treturn ERROR_NT(NT_STATUS_INVALID_PARAMETER);\n \t\t}\n \n+\t\tif (IS_IPC(conn)) {\n+\t\t\treturn call_trans2qpipeinfo(conn,\n+\t\t\t\t\t\t\tinbuf,\n+\t\t\t\t\t\t\toutbuf,\n+\t\t\t\t\t\t\tlength,\n+\t\t\t\t\t\t\tbufsize,\n+\t\t\t\t\t\t\ttran_call,\n+\t\t\t\t\t\t\tpparams,\n+\t\t\t\t\t\t\ttotal_params,\n+\t\t\t\t\t\t\tppdata,\n+\t\t\t\t\t\t\ttotal_data,\n+\t\t\t\t\t\t\tmax_data_bytes);\n+\t\t}\n+\n \t\tfsp = file_fsp(params,0);\n \t\tinfo_level = SVAL(params,2);\n \n@@ -3769,8 +3857,7 @@\n \t\t\t\tSIVAL(pdata,0,0); /* ??? */\n \t\t\t\tSIVAL(pdata,4,byte_len); /* Byte length of unicode string ::$DATA */\n \t\t\t\tSOFF_T(pdata,8,file_size);\n-\t\t\t\tSIVAL(pdata,16,allocation_size);\n-\t\t\t\tSIVAL(pdata,20,0); /* ??? */\n+\t\t\t\tSOFF_T(pdata,16,allocation_size);\n \t\t\t\tdata_size = 24 + byte_len;\n \t\t\t}\n \t\t\tbreak;\n@@ -3790,7 +3877,7 @@\n \t\t\tput_long_date_timespec(pdata+8,atime_ts);\n \t\t\tput_long_date_timespec(pdata+16,mtime_ts); /* write time */\n \t\t\tput_long_date_timespec(pdata+24,mtime_ts); /* change time */\n-\t\t\tSIVAL(pdata,32,allocation_size);\n+\t\t\tSOFF_T(pdata,32,allocation_size);\n \t\t\tSOFF_T(pdata,40,file_size);\n \t\t\tSIVAL(pdata,48,mode);\n \t\t\tSIVAL(pdata,52,0); /* ??? */\n@@ -6525,7 +6612,8 @@\n \t}\n \n \tif (IS_IPC(conn) && (tran_call != TRANSACT2_OPEN)\n-            && (tran_call != TRANSACT2_GET_DFS_REFERRAL)) {\n+            && (tran_call != TRANSACT2_GET_DFS_REFERRAL)\n+            && (tran_call != TRANSACT2_QFILEINFO)) {\n \t\tEND_PROFILE(SMBtrans2);\n \t\treturn ERROR_DOS(ERRSRV,ERRaccess);\n \t}\n\nModified: branches/SAMBA_3_0_25/source/smbd/trans2.c\n===================================================================\n--- branches/SAMBA_3_0_25/source/smbd/trans2.c\t2007-04-23 16:31:31 UTC (rev 22489)\n+++ branches/SAMBA_3_0_25/source/smbd/trans2.c\t2007-04-23 16:32:24 UTC (rev 22490)\n@@ -2219,6 +2219,12 @@\n \treturn(-1);\n }\n \n+unsigned char *create_volume_objectid(connection_struct *conn, unsigned char objid[16])\n+{\n+\tE_md4hash(lp_servicename(SNUM(conn)),objid);\n+\treturn objid;\n+}\n+\n /****************************************************************************\n  Reply to a TRANS2_QFSINFO (query filesystem info).\n ****************************************************************************/\n@@ -2326,6 +2332,8 @@\n \n \t\t\tSIVAL(pdata,0,FILE_CASE_PRESERVED_NAMES|FILE_CASE_SENSITIVE_SEARCH|\n \t\t\t\t(lp_nt_acl_support(SNUM(conn)) ? FILE_PERSISTENT_ACLS : 0)|\n+\t\t\t\tFILE_SUPPORTS_OBJECT_IDS|\n+\t\t\t\tFILE_UNICODE_ON_DISK|\n \t\t\t\tquota_flag); /* FS ATTRIBUTES */\n \n \t\t\tSIVAL(pdata,4,255); /* Max filename component length */\n@@ -2507,8 +2515,12 @@\n \t\t}\n #endif /* HAVE_SYS_QUOTAS */\n \t\tcase SMB_FS_OBJECTID_INFORMATION:\n+\t\t{\n+\t\t\tunsigned char objid[16];\n+\t\t\tmemcpy(pdata,create_volume_objectid(conn, objid),16);\n \t\t\tdata_len = 64;\n \t\t\tbreak;\n+\t\t}\n \n \t\t/*\n \t\t * Query the version and capabilities of the CIFS UNIX extensions\n@@ -3142,6 +3154,68 @@\n }\n \n /****************************************************************************\n+ Reply to a TRANSACT2_QFILEINFO on a PIPE !\n+****************************************************************************/\n+\n+static int call_trans2qpipeinfo(connection_struct *conn, char *inbuf, char *outbuf, int length, int bufsize,\n+\t\t\t\t\tunsigned int tran_call,\n+\t\t\t\t\tchar **pparams, int total_params, char **ppdata, int total_data,\n+\t\t\t\t\tunsigned int max_data_bytes)\n+{\n+\tchar *params = *pparams;\n+\tchar *pdata = *ppdata;\n+\tunsigned int data_size = 0;\n+\tunsigned int param_size = 2;\n+\tuint16 info_level;\n+\tsmb_np_struct *p_pipe = NULL;\n+\n+\tif (!params) {\n+\t\treturn ERROR_NT(NT_STATUS_INVALID_PARAMETER);\n+\t}\n+\n+\tif (total_params < 4) {\n+\t\treturn ERROR_NT(NT_STATUS_INVALID_PARAMETER);\n+\t}\n+\n+\tp_pipe = get_rpc_pipe_p(params,0);\n+\tif (p_pipe == NULL) {\n+\t\treturn ERROR_NT(NT_STATUS_INVALID_HANDLE);\n+\t}\n+\n+\tinfo_level = SVAL(params,2);\n+\n+\t*pparams = (char *)SMB_REALLOC(*pparams,2);\n+\tif (*pparams == NULL) {\n+\t\treturn ERROR_NT(NT_STATUS_NO_MEMORY);\n+\t}\n+\tparams = *pparams;\n+\tSSVAL(params,0,0);\n+\tdata_size = max_data_bytes + DIR_ENTRY_SAFETY_MARGIN;\n+\t*ppdata = (char *)SMB_REALLOC(*ppdata, data_size); \n+\tif (*ppdata == NULL ) {\n+\t\treturn ERROR_NT(NT_STATUS_NO_MEMORY);\n+\t}\n+\tpdata = *ppdata;\n+\n+\tswitch (info_level) {\n+\t\tcase SMB_FILE_STANDARD_INFORMATION:\n+\t\t\tmemset(pdata,24,0);\n+\t\t\tSOFF_T(pdata,0,4096LL);\n+\t\t\tSIVAL(pdata,16,1);\n+\t\t\tSIVAL(pdata,20,1);\n+\t\t\tdata_size = 24;\n+\t\t\tbreak;\n+\n+\t\tdefault:\n+\t\t\treturn ERROR_NT(NT_STATUS_INVALID_LEVEL);\n+\t}\n+\n+\tsend_trans2_replies(outbuf, bufsize, params, param_size, *ppdata, data_size, max_data_bytes);\n+\n+\treturn(-1);\n+}\n+\n+/****************************************************************************\n  Reply to a TRANS2_QFILEPATHINFO or TRANSACT2_QFILEINFO (query file info by\n  file name or file id).\n ****************************************************************************/\n@@ -3186,6 +3260,20 @@\n \t\t\treturn ERROR_NT(NT_STATUS_INVALID_PARAMETER);\n \t\t}\n \n+\t\tif (IS_IPC(conn)) {\n+\t\t\treturn call_trans2qpipeinfo(conn,\n+\t\t\t\t\t\t\tinbuf,\n+\t\t\t\t\t\t\toutbuf,\n+\t\t\t\t\t\t\tlength,\n+\t\t\t\t\t\t\tbufsize,\n+\t\t\t\t\t\t\ttran_call,\n+\t\t\t\t\t\t\tpparams,\n+\t\t\t\t\t\t\ttotal_params,\n+\t\t\t\t\t\t\tppdata,\n+\t\t\t\t\t\t\ttotal_data,\n+\t\t\t\t\t\t\tmax_data_bytes);\n+\t\t}\n+\n \t\tfsp = file_fsp(params,0);\n \t\tinfo_level = SVAL(params,2);\n \n@@ -3717,8 +3805,7 @@\n \t\t\t\tSIVAL(pdata,0,0); /* ??? */\n \t\t\t\tSIVAL(pdata,4,byte_len); /* Byte length of unicode string ::$DATA */\n \t\t\t\tSOFF_T(pdata,8,file_size);\n-\t\t\t\tSIVAL(pdata,16,allocation_size);\n-\t\t\t\tSIVAL(pdata,20,0); /* ??? */\n+\t\t\t\tSOFF_T(pdata,16,allocation_size);\n \t\t\t\tdata_size = 24 + byte_len;\n \t\t\t}\n \t\t\tbreak;\n@@ -3738,7 +3825,7 @@\n \t\t\tput_long_date_timespec(pdata+8,atime_ts);\n \t\t\tput_long_date_timespec(pdata+16,mtime_ts); /* write time */\n \t\t\tput_long_date_timespec(pdata+24,mtime_ts); /* change time */\n-\t\t\tSIVAL(pdata,32,allocation_size);\n+\t\t\tSOFF_T(pdata,32,allocation_size);\n \t\t\tSOFF_T(pdata,40,file_size);\n \t\t\tSIVAL(pdata,48,mode);\n \t\t\tSIVAL(pdata,52,0); /* ??? */\n@@ -6473,7 +6560,8 @@\n \t}\n \n \tif (IS_IPC(conn) && (tran_call != TRANSACT2_OPEN)\n-            && (tran_call != TRANSACT2_GET_DFS_REFERRAL)) {\n+            && (tran_call != TRANSACT2_GET_DFS_REFERRAL)\n+            && (tran_call != TRANSACT2_QFILEINFO)) {\n \t\tEND_PROFILE(SMBtrans2);\n \t\treturn ERROR_DOS(ERRSRV,ERRaccess);\n \t}\n\n"}