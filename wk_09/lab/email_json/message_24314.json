{"category": "ham", "to_address": "samba-cvs@samba.org", "from_address": "tridge@samba.org", "subject": "Rev 263: merged from ronnie in http://samba.org/~tridge/ctdb", "body": "------------------------------------------------------------\nrevno: 263\nrevision-id: tridge@samba.org-20070506215638-67wvsh0zwt7bbllo\nparent: tridge@samba.org-20070505074654-1cs2rodrtlo3dkjk\nparent: sahlberg@ronnie-20070506215417-d96e79c116240aad\ncommitter: Andrew Tridgell \nbranch nick: tridge\ntimestamp: Mon 2007-05-07 07:56:38 +1000\nmessage:\n  merged from ronnie\nmodified:\n  common/ctdb.c                  ctdb.c-20061127094323-t50f58d65iaao5of-2\n  common/ctdb_client.c           ctdb_client.c-20070411010216-3kd8v37k61steeya-1\n  common/ctdb_control.c          ctdb_control.c-20070426122724-j6gkpiofhbwdin63-1\n  direct/recoverd.c              recoverd.c-20070503213540-bvxuyd9jm1f7ig90-1\n  include/ctdb.h                 ctdb.h-20061117234101-o3qt14umlg9en8z0-11\n  include/ctdb_private.h         ctdb_private.h-20061117234101-o3qt14umlg9en8z0-13\n  tests/recover.sh               recover.sh-20070502031230-tpuiet6m6tjdotta-1\n  tools/ctdb_control.c           ctdb_control.c-20070426122705-9ehj1l5lu2gn9kuj-1\n    ------------------------------------------------------------\n    revno: 197.1.82\n    merged: sahlberg@ronnie-20070506215417-d96e79c116240aad\n    parent: sahlberg@ronnie-20070506214716-d88b489c9db3b15c\n    committer: Ronnie Sahlberg \n    branch nick: ctdb\n    timestamp: Mon 2007-05-07 07:54:17 +1000\n    message:\n      hang the timeout event off state   and thus we dont need to explicitely \n      free it   and also we wont accidentally return from the function without \n      killing the event first\n    ------------------------------------------------------------\n    revno: 197.1.81\n    merged: sahlberg@ronnie-20070506214716-d88b489c9db3b15c\n    parent: sahlberg@ronnie-20070506205158-a1110272a8a362ad\n    committer: Ronnie Sahlberg \n    branch nick: ctdb\n    timestamp: Mon 2007-05-07 07:47:16 +1000\n    message:\n      it now works to talloc_free() the timed event if we no longer want it to \n      trigger\n      \n      this must have been a sideeffect of a different bug in the recoverd.c \n      code that has now been fixed\n    ------------------------------------------------------------\n    revno: 197.1.80\n    merged: sahlberg@ronnie-20070506205158-a1110272a8a362ad\n    parent: sahlberg@ronnie-20070506190248-95317ce2ee808aa3\n    committer: Ronnie Sahlberg \n    branch nick: ctdb\n    timestamp: Mon 2007-05-07 06:51:58 +1000\n    message:\n      recovery daemon with recovery master election\n      \n      election is primitive, it elects the lowest vnn as the recovery master\n      \n      two new controls, to get/set recovery master for a node\n      \n      \n      \n      to use recovery daemon,   start one  \n      ./bin/recoverd --socket=ctdb.socket*\n      for each ctdb daemon\n      \n      \n      it has been briefly tested by deleting and adding nodes to a 4 node \n      cluster but needs more testing\n    ------------------------------------------------------------\n    revno: 197.1.79\n    merged: sahlberg@ronnie-20070506190248-95317ce2ee808aa3\n    parent: sahlberg@ronnie-20070506184112-5da5d1b472919956\n    committer: Ronnie Sahlberg \n    branch nick: ctdb\n    timestamp: Mon 2007-05-07 05:02:48 +1000\n    message:\n      add new controls to get and set the recovery master node of a daemon\n      i.e. which node is \"elected\" to check for and drive recovery\n    ------------------------------------------------------------\n    revno: 197.1.78\n    merged: sahlberg@ronnie-20070506184112-5da5d1b472919956\n    parent: sahlberg@ronnie-20070506024656-54065db42fc80030\n    committer: Ronnie Sahlberg \n    branch nick: ctdb\n    timestamp: Mon 2007-05-07 04:41:12 +1000\n    message:\n      add a test in the function that checks whether the cluster needs \n      recovery or not  that all active nodes are in normal mode.\n      If we discover that some node is still in recoverymode it may indicate \n      that a previous recovery ended prematurely and thus we should start a \n      new recovery \n    ------------------------------------------------------------\n    revno: 197.1.77\n    merged: sahlberg@ronnie-20070506024656-54065db42fc80030\n    parent: sahlberg@ronnie-20070506005125-24f5190be388d944\n    committer: Ronnie Sahlberg \n    branch nick: ctdb\n    timestamp: Sun 2007-05-06 12:46:56 +1000\n    message:\n      update a comment to be more desciptive\n    ------------------------------------------------------------\n    revno: 197.1.76\n    merged: sahlberg@ronnie-20070506005125-24f5190be388d944\n    parent: sahlberg@ronnie-20070506004218-e5dc99fda5598e6e\n    committer: Ronnie Sahlberg \n    branch nick: ctdb\n    timestamp: Sun 2007-05-06 10:51:25 +1000\n    message:\n      change a lot of printf into debug statements\n    ------------------------------------------------------------\n    revno: 197.1.75\n    merged: sahlberg@ronnie-20070506004218-e5dc99fda5598e6e\n    parent: sahlberg@ronnie-20070506003844-cfa2e54767c22f74\n    committer: Ronnie Sahlberg \n    branch nick: ctdb\n    timestamp: Sun 2007-05-06 10:42:18 +1000\n    message:\n      break out the code to update all nodes to the new vnnmap into a helper \n      function\n    ------------------------------------------------------------\n    revno: 197.1.74\n    merged: sahlberg@ronnie-20070506003844-cfa2e54767c22f74\n    parent: sahlberg@ronnie-20070506003018-5b7bebe70235b0fb\n    committer: Ronnie Sahlberg \n    branch nick: ctdb\n    timestamp: Sun 2007-05-06 10:38:44 +1000\n    message:\n      create a helper function for recovery to push all local databases out \n      onto the remote nodes\n    ------------------------------------------------------------\n    revno: 197.1.73\n    merged: sahlberg@ronnie-20070506003018-5b7bebe70235b0fb\n    parent: sahlberg@ronnie-20070506002213-9ad049359f13100b\n    committer: Ronnie Sahlberg \n    branch nick: ctdb\n    timestamp: Sun 2007-05-06 10:30:18 +1000\n    message:\n      add an extra blank line\n    ------------------------------------------------------------\n    revno: 197.1.72\n    merged: sahlberg@ronnie-20070506002213-9ad049359f13100b\n    parent: sahlberg@ronnie-20070506001648-69c865e04dda39ce\n    committer: Ronnie Sahlberg \n    branch nick: ctdb\n    timestamp: Sun 2007-05-06 10:22:13 +1000\n    message:\n      break the code that repoints dmaster for all local and remote records \n      into a separate helper function\n    ------------------------------------------------------------\n    revno: 197.1.71\n    merged: sahlberg@ronnie-20070506001648-69c865e04dda39ce\n    parent: sahlberg@ronnie-20070506001242-2ad8fec87f6dea8b\n    committer: Ronnie Sahlberg \n    branch nick: ctdb\n    timestamp: Sun 2007-05-06 10:16:48 +1000\n    message:\n      create a helper function for recovery that pulls and merges all remote \n      databases onto the local node\n    ------------------------------------------------------------\n    revno: 197.1.70\n    merged: sahlberg@ronnie-20070506001242-2ad8fec87f6dea8b\n    parent: sahlberg@ronnie-20070506000437-f1ba6eb009903e0e\n    committer: Ronnie Sahlberg \n    branch nick: ctdb\n    timestamp: Sun 2007-05-06 10:12:42 +1000\n    message:\n      create a helper function to make sure the local node that does recovery \n      has all the databases that exist on any other remote node\n    ------------------------------------------------------------\n    revno: 197.1.69\n    merged: sahlberg@ronnie-20070506000437-f1ba6eb009903e0e\n    parent: sahlberg@ronnie-20070505235312-47eb2e7327632b8f\n    committer: Ronnie Sahlberg \n    branch nick: ctdb\n    timestamp: Sun 2007-05-06 10:04:37 +1000\n    message:\n      add a helper function to create all missing remote databases detected \n      during recovery\n    ------------------------------------------------------------\n    revno: 197.1.68\n    merged: sahlberg@ronnie-20070505235312-47eb2e7327632b8f\n    parent: sahlberg@ronnie-20070505220522-a85200c3738602cb\n    committer: Ronnie Sahlberg \n    branch nick: ctdb\n    timestamp: Sun 2007-05-06 09:53:12 +1000\n    message:\n      break out the setting/clearing of recovery mode into a dedicated helper \n      function\n    ------------------------------------------------------------\n    revno: 197.1.67\n    merged: sahlberg@ronnie-20070505220522-a85200c3738602cb\n    parent: sahlberg@ronnie-20070505215220-9645a5e6c1f75971\n    committer: Ronnie Sahlberg \n    branch nick: ctdb\n    timestamp: Sun 2007-05-06 08:05:22 +1000\n    message:\n      dont allocate arrays where we can just return a single integer\n    ------------------------------------------------------------\n    revno: 197.1.66\n    merged: sahlberg@ronnie-20070505215220-9645a5e6c1f75971\n    parent: sahlberg@ronnie-20070505213216-a6ffc7923cad6b0c\n    committer: Ronnie Sahlberg \n    branch nick: ctdb\n    timestamp: Sun 2007-05-06 07:52:20 +1000\n    message:\n      dont use arrays where a uint32_t works just as well\n    ------------------------------------------------------------\n    revno: 197.1.65\n    merged: sahlberg@ronnie-20070505213216-a6ffc7923cad6b0c\n    parent: sahlberg@ronnie-20070505210747-ae90637e16bf5cb7\n    committer: Ronnie Sahlberg \n    branch nick: ctdb\n    timestamp: Sun 2007-05-06 07:32:16 +1000\n    message:\n      add a ifdeffed out block to the call.\n      \n      we really should kill the event in case the call completed before the \n      timeout   so that we can also make timed_out non-static\n    ------------------------------------------------------------\n    revno: 197.1.64\n    merged: sahlberg@ronnie-20070505210747-ae90637e16bf5cb7\n    parent: sahlberg@ronnie-20070505205801-e674f5fc04467b37\n    committer: Ronnie Sahlberg \n    branch nick: ctdb\n    timestamp: Sun 2007-05-06 07:07:47 +1000\n    message:\n      hte timed_out variable needs to be static and can not be on the stack   \n      since if the command times out and we return from ctdb_control   we may \n      have events that can trigger later which will overwrite data that is no \n      longer in our stackframe\n    ------------------------------------------------------------\n    revno: 197.1.63\n    merged: sahlberg@ronnie-20070505205801-e674f5fc04467b37\n    parent: sahlberg@ronnie-20070505200639-0d19e58cc0e77781\n    committer: Ronnie Sahlberg \n    branch nick: ctdb\n    timestamp: Sun 2007-05-06 06:58:01 +1000\n    message:\n      update to rhe recovery daemon\n      ctdb_ctrl_ calls are timedout due to nodes arriving or leaving the \n      cluster it crashes the recovery daemon afterwards with a SEGV but no \n      useful stack backtrace\n    ------------------------------------------------------------\n    revno: 197.1.62\n    merged: sahlberg@ronnie-20070505200639-0d19e58cc0e77781\n    parent: sahlberg@ronnie-20070505195315-2f67bc95926668e5\n    committer: Ronnie Sahlberg \n    branch nick: ctdb\n    timestamp: Sun 2007-05-06 06:06:39 +1000\n    message:\n      in the recover test\n      start the daemons with explicit socketnames and explicit ip address/port\n      \n      remove all --socket=  from all ctdb_control calls since they are not \n      needed anymore\n    ------------------------------------------------------------\n    revno: 197.1.61\n    merged: sahlberg@ronnie-20070505195315-2f67bc95926668e5\n    parent: sahlberg@ronnie-20070505183841-3ee39c2e0abe51ca\n    committer: Ronnie Sahlberg \n    branch nick: ctdb\n    timestamp: Sun 2007-05-06 05:53:15 +1000\n    message:\n      add support in catdb to dump the content of a specific nodes tdb instead \n      of traversing the full cluster.\n      this makes it easier to debug recovery\n      \n      update the test script for recovery to reflect the newish signatures to\n      ctdb_control\n      \n      \n      \n      the catdb control does still segfault however when there are missing \n      nodes in the cluster   as there are toward the end of the recovery test\n    ------------------------------------------------------------\n    revno: 197.1.60\n    merged: sahlberg@ronnie-20070505183841-3ee39c2e0abe51ca\n    parent: sahlberg@ronnie-20070505183122-09dfca19dab5ec41\n    parent: tridge@samba.org-20070505074654-1cs2rodrtlo3dkjk\n    committer: Ronnie Sahlberg \n    branch nick: ctdb\n    timestamp: Sun 2007-05-06 04:38:41 +1000\n    message:\n      merge from tridge\n    ------------------------------------------------------------\n    revno: 197.1.59\n    merged: sahlberg@ronnie-20070505183122-09dfca19dab5ec41\n    parent: sahlberg@ronnie-20070505065134-e92a7a2ea17d523b\n    committer: Ronnie Sahlberg \n    branch nick: ctdb\n    timestamp: Sun 2007-05-06 04:31:22 +1000\n    message:\n      add a control to get the pid of a daemon.\n      this makes it possible to kill a specific daemon in the recover test \n      script\n    ------------------------------------------------------------\n    revno: 197.1.58\n    merged: sahlberg@ronnie-20070505065134-e92a7a2ea17d523b\n    parent: sahlberg@ronnie-20070505031726-667ed50c2053a8aa\n    parent: tridge@samba.org-20070505040946-iji1cxsyb8ail7bk\n    committer: Ronnie Sahlberg \n    branch nick: ctdb\n    timestamp: Sat 2007-05-05 16:51:34 +1000\n    message:\n      merge from tridge\n\nDiff too large for email (1498, the limit is 200).\n\n"}