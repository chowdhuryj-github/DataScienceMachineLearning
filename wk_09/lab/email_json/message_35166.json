{"category": "ham", "to_address": "samba-cvs@samba.org", "from_address": "tridge@samba.org", "subject": "Rev 337: merge from ronnie in http://samba.org/~tridge/ctdb", "body": "------------------------------------------------------------\nrevno: 337\nrevision-id: tridge@samba.org-20070524001002-l15u156fi8sdv574\nparent: tridge@samba.org-20070523101509-vbrbhal0ufirofal\nparent: sahlberg@ronnie-20070523220845-u9ji91tnmc92k9gq\ncommitter: Andrew Tridgell \nbranch nick: tridge\ntimestamp: Thu 2007-05-24 10:10:02 +1000\nmessage:\n  merge from ronnie\nmodified:\n  tools/ctdb_control.c           ctdb_control.c-20070426122705-9ehj1l5lu2gn9kuj-1\n    ------------------------------------------------------------\n    revno: 326.1.5\n    merged: sahlberg@ronnie-20070523220845-u9ji91tnmc92k9gq\n    parent: sahlberg@ronnie-20070523213304-u3vgumzloo0w1gpn\n    parent: tridge@samba.org-20070523100637-sr7fh7uhl7s143rk\n    committer: Ronnie Sahlberg \n    branch nick: ctdb\n    timestamp: Thu 2007-05-24 08:08:45 +1000\n    message:\n      add a new command for ctdb_control to trigger a recovery\n    ------------------------------------------------------------\n    revno: 326.1.4\n    merged: sahlberg@ronnie-20070523213304-u3vgumzloo0w1gpn\n    parent: sahlberg@ronnie-20070520232434-xxhlg6zdpx5kkvjp\n    parent: tridge@samba.org-20070523045041-a6v1tls6f3m01bqx\n    committer: Ronnie Sahlberg \n    branch nick: ctdb\n    timestamp: Thu 2007-05-24 07:33:04 +1000\n    message:\n      merge from tridge\n=== modified file 'tools/ctdb_control.c'\n--- a/tools/ctdb_control.c\t2007-05-23 10:06:37 +0000\n+++ b/tools/ctdb_control.c\t2007-05-23 22:08:45 +0000\n@@ -61,6 +61,7 @@\n \t\t\"  getpid                        get the pid of a ctdb daemon\\n\"\n \t\t\"  dumpmemory                dump memory map to log\\n\"\n \t\t\"  shutdown                      shutdown a remote ctdb\\n\"\n+\t\t\"  recovery                      trigger a recovery\\n\"\n \t\t\"  freeze                    freeze a node\\n\"\n \t\t\"  thaw                      thaw a node\\n\"\n \t);\n@@ -374,6 +375,28 @@\n }\n \n /*\n+  trigger a recovery\n+ */\n+static int control_recovery(struct ctdb_context *ctdb, int argc, const char **argv)\n+{\n+\tint ret;\n+\n+\n+\tret = ctdb_ctrl_freeze(ctdb, timeval_current_ofs(timelimit, 0), CTDB_CURRENT_NODE);\n+\tif (ret != 0) {\n+\t\tprintf(\"Unable to freeze node\\n\");\n+\t\treturn ret;\n+\t}\n+\tret = ctdb_ctrl_setrecmode(ctdb, timeval_current_ofs(timelimit, 0), CTDB_CURRENT_NODE, CTDB_RECOVERY_ACTIVE);\n+\tif (ret != 0) {\n+\t\tprintf(\"Unable to set recovery mode\\n\");\n+\t\treturn ret;\n+\t}\n+\n+\treturn 0;\n+}\n+\n+/*\n   display recovery mode of a remote node\n  */\n static int control_getrecmode(struct ctdb_context *ctdb, int argc, const char **argv)\n@@ -1056,6 +1079,7 @@\n \t\t{ \"dumpmemory\", control_dumpmemory },\n \t\t{ \"getpid\", control_getpid },\n \t\t{ \"shutdown\", control_shutdown },\n+\t\t{ \"recovery\", control_recovery },\n \t\t{ \"freeze\", control_freeze },\n \t\t{ \"thaw\", control_thaw },\n \t};\n\n"}