{"category": "ham", "to_address": "samba-cvs@samba.org", "from_address": "tridge@samba.org", "subject": "Rev 483: ensure all nodes display disabled nodes correctly in\n\thttp://samba.org/~tridge/ctdb", "body": "------------------------------------------------------------\nrevno: 483\nrevision-id: tridge@samba.org-20070606112709-klp56ghkr55r3m4d\nparent: tridge@samba.org-20070606094625-rr6b22zkbeskchvj\ncommitter: Andrew Tridgell \nbranch nick: tridge\ntimestamp: Wed 2007-06-06 21:27:09 +1000\nmessage:\n  ensure all nodes display disabled nodes correctly\nmodified:\n  common/ctdb_monitor.c          ctdb_monitor.c-20070518100625-8jf4ft1mjzmb22ck-1\n  common/ctdb_recoverd.c         recoverd.c-20070503213540-bvxuyd9jm1f7ig90-1\n=== modified file 'common/ctdb_monitor.c'\n--- a/common/ctdb_monitor.c\t2007-06-06 03:45:12 +0000\n+++ b/common/ctdb_monitor.c\t2007-06-06 11:27:09 +0000\n@@ -121,8 +121,9 @@\n \tdata.dptr = (uint8_t *)&c\n \tdata.dsize = sizeof(c);\n \n-\t/* tell the recmaster that something has changed */\n-\tctdb_daemon_send_message(ctdb, ctdb->recovery_master, CTDB_SRVID_NODE_FLAGS_CHANGED, data);\n+\t/* tell the other nodes that something has changed */\n+\tctdb_daemon_send_message(ctdb, CTDB_BROADCAST_VNNMAP,\n+\t\t\t\t CTDB_SRVID_NODE_FLAGS_CHANGED, data);\n }\n \n \n\n=== modified file 'common/ctdb_recoverd.c'\n--- a/common/ctdb_recoverd.c\t2007-06-06 01:13:24 +0000\n+++ b/common/ctdb_recoverd.c\t2007-06-06 11:27:09 +0000\n@@ -991,11 +991,15 @@\n \t\treturn;\n \t}\n \n-\tDEBUG(0,(\"Node %u has changed flags - now 0x%x\\n\", c->vnn, c->flags));\n+\tif (c->vnn != ctdb->vnn) {\n+\t\tDEBUG(0,(\"Node %u has changed flags - now 0x%x\\n\", c->vnn, c->flags));\n+\t}\n \n \tnodemap->nodes[i].flags = c->flags;\n \t\n-\tif (ctdb->takeover.enabled) {\n+\tif (ctdb->recovery_master == ctdb->vnn &&\n+\t    ctdb->recovery_mode == CTDB_RECOVERY_NORMAL &&\n+\t    ctdb->takeover.enabled) {\n \t\tret = ctdb_takeover_run(ctdb, nodemap);\n \t\tif (ret != 0) {\n \t\t\tDEBUG(0, (__location__ \" Unable to setup public takeover addresses\\n\"));\n\n"}