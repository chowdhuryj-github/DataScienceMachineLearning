{"category": "ham", "to_address": "samba-cvs@samba.org", "from_address": "jerry@samba.org", "subject": "svn commit: samba r22159 - in branches: SAMBA_3_0/source/nsswitch\n\tSAMBA_3_0_25/source/nsswitch", "body": "Author: jerry\nDate: 2007-04-10 22:59:42 +0000 (Tue, 10 Apr 2007)\nNew Revision: 22159\n\nWebSVN: http://websvn.samba.org/cgi-bin/viewcvs.cgi?view=rev&root=samba&rev=22159\n\nLog:\nBUG 4501 (second half of fix): Just disable the\nuid/gid allocation if no idmap alloca backend has been \ndefined and we are not using a 3.0.24 idmap backend \ncompatible configuration.\n\n\nModified:\n   branches/SAMBA_3_0/source/nsswitch/idmap.c\n   branches/SAMBA_3_0_25/source/nsswitch/idmap.c\n\n\nChangeset:\nModified: branches/SAMBA_3_0/source/nsswitch/idmap.c\n===================================================================\n--- branches/SAMBA_3_0/source/nsswitch/idmap.c\t2007-04-10 21:14:44 UTC (rev 22158)\n+++ branches/SAMBA_3_0/source/nsswitch/idmap.c\t2007-04-10 22:59:42 UTC (rev 22159)\n@@ -259,7 +259,7 @@\n \tchar *compat_backend = NULL;\n \tchar *compat_params = NULL;\n \tconst char **dom_list = NULL;\n-\tchar *alloc_backend;\n+\tchar *alloc_backend = NULL;\n \tBOOL default_already_defined = False;\n \tBOOL pri_dom_is_in_list = False;\n \tint compat = 0;\n@@ -561,11 +561,11 @@\n \t}\n \n \n-\t/***************************\n-\t * initialize alloc module\n-\t */\n-\tDEBUG(1, (\"Initializing idmap alloc module\\n\"));\n+\t/* Initialize alloc module */\n \n+\tDEBUG(3, (\"Initializing idmap alloc module\\n\"));\n+\n+\talloc_backend = NULL;\n \tif (compat) {\n \t\talloc_backend = talloc_strdup(idmap_ctx, compat_backend);\n \t} else {\n@@ -573,12 +573,11 @@\n \t\t\n \t\tif (ab && (ab[0] != '\\0')) {\n \t\t\talloc_backend = talloc_strdup(idmap_ctx, lp_idmap_alloc_backend());\n-\t\t} else {\n-\t\t\talloc_backend = talloc_strdup(idmap_ctx, \"tdb\");\n \t\t}\n \t}\n-\tIDMAP_CHECK_ALLOC(alloc_backend);\n \n+\tif ( alloc_backend ) {\n+\n \talloc_methods = get_alloc_methods(alloc_backends, alloc_backend);\n \tif ( ! alloc_methods) {\n \t\tret = smb_probe_module(\"idmap\", alloc_backend);\n@@ -603,6 +602,7 @@\n \t\telse\n \t\t\tret = NT_STATUS_UNSUCCESSFUL;\n \t}\n+\t}\n \n \t/* cleanpu temporary strings */\n \tTALLOC_FREE( compat_backend );\n\nModified: branches/SAMBA_3_0_25/source/nsswitch/idmap.c\n===================================================================\n--- branches/SAMBA_3_0_25/source/nsswitch/idmap.c\t2007-04-10 21:14:44 UTC (rev 22158)\n+++ branches/SAMBA_3_0_25/source/nsswitch/idmap.c\t2007-04-10 22:59:42 UTC (rev 22159)\n@@ -259,7 +259,7 @@\n \tchar *compat_backend = NULL;\n \tchar *compat_params = NULL;\n \tconst char **dom_list = NULL;\n-\tchar *alloc_backend;\n+\tchar *alloc_backend = NULL;\n \tBOOL default_already_defined = False;\n \tBOOL pri_dom_is_in_list = False;\n \tint compat = 0;\n@@ -561,11 +561,11 @@\n \t}\n \n \n-\t/***************************\n-\t * initialize alloc module\n-\t */\n-\tDEBUG(1, (\"Initializing idmap alloc module\\n\"));\n+\t/* Initialize alloc module */\n \n+\tDEBUG(3, (\"Initializing idmap alloc module\\n\"));\n+\n+\talloc_backend = NULL;\n \tif (compat) {\n \t\talloc_backend = talloc_strdup(idmap_ctx, compat_backend);\n \t} else {\n@@ -573,12 +573,11 @@\n \t\t\n \t\tif (ab && (ab[0] != '\\0')) {\n \t\t\talloc_backend = talloc_strdup(idmap_ctx, lp_idmap_alloc_backend());\n-\t\t} else {\n-\t\t\talloc_backend = talloc_strdup(idmap_ctx, \"tdb\");\n \t\t}\n \t}\n-\tIDMAP_CHECK_ALLOC(alloc_backend);\n \n+\tif ( alloc_backend ) {\n+\n \talloc_methods = get_alloc_methods(alloc_backends, alloc_backend);\n \tif ( ! alloc_methods) {\n \t\tret = smb_probe_module(\"idmap\", alloc_backend);\n@@ -603,6 +602,7 @@\n \t\telse\n \t\t\tret = NT_STATUS_UNSUCCESSFUL;\n \t}\n+\t}\n \n \t/* cleanpu temporary strings */\n \tTALLOC_FREE( compat_backend );\n\n"}