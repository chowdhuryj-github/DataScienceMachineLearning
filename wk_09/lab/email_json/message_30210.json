{"category": "ham", "to_address": "samba-cvs@samba.org", "from_address": "gd@samba.org", "subject": "svn commit: samba r22901 - in branches: SAMBA_3_0/source/nsswitch\n\tSAMBA_3_0_25/source/nsswitch SAMBA_3_0_26/source/nsswitch", "body": "Author: gd\nDate: 2007-05-15 13:42:53 +0000 (Tue, 15 May 2007)\nNew Revision: 22901\n\nWebSVN: http://websvn.samba.org/cgi-bin/viewcvs.cgi?view=rev&root=samba&rev=22901\n\nLog:\nWhen an AD account has UF_DONT_REQUIRE_PREAUTH set we need to fallback to ntlm\nin the kerberized PAM_AUTH.\n\nGuenther\n\nModified:\n   branches/SAMBA_3_0/source/nsswitch/winbindd_pam.c\n   branches/SAMBA_3_0_25/source/nsswitch/winbindd_pam.c\n   branches/SAMBA_3_0_26/source/nsswitch/winbindd_pam.c\n\n\nChangeset:\nModified: branches/SAMBA_3_0/source/nsswitch/winbindd_pam.c\n===================================================================\n--- branches/SAMBA_3_0/source/nsswitch/winbindd_pam.c\t2007-05-15 12:18:17 UTC (rev 22900)\n+++ branches/SAMBA_3_0/source/nsswitch/winbindd_pam.c\t2007-05-15 13:42:53 UTC (rev 22901)\n@@ -566,6 +566,14 @@\n \t\thttp_timestring(ticket_lifetime), (int)ticket_lifetime, \n \t\thttp_timestring(renewal_until), (int)renewal_until));\n \n+\t/* we cannot continue with krb5 when UF_DONT_REQUIRE_PREAUTH is set,\n+\t * in that case fallback to NTLM - gd */ \n+\n+\tif ((ticket_lifetime == 0) && (renewal_until == 0)) {\n+\t\tresult = NT_STATUS_INVALID_LOGON_TYPE;\n+\t\tgoto failed;\n+\t}\n+\n \tclient_princ = talloc_strdup(state->mem_ctx, global_myname());\n \tif (client_princ == NULL) {\n \t\tresult = NT_STATUS_NO_MEMORY;\n\nModified: branches/SAMBA_3_0_25/source/nsswitch/winbindd_pam.c\n===================================================================\n--- branches/SAMBA_3_0_25/source/nsswitch/winbindd_pam.c\t2007-05-15 12:18:17 UTC (rev 22900)\n+++ branches/SAMBA_3_0_25/source/nsswitch/winbindd_pam.c\t2007-05-15 13:42:53 UTC (rev 22901)\n@@ -579,6 +579,14 @@\n \t\thttp_timestring(ticket_lifetime), (int)ticket_lifetime, \n \t\thttp_timestring(renewal_until), (int)renewal_until));\n \n+\t/* we cannot continue with krb5 when UF_DONT_REQUIRE_PREAUTH is set,\n+\t * in that case fallback to NTLM - gd */ \n+\n+\tif ((ticket_lifetime == 0) && (renewal_until == 0)) {\n+\t\tresult = NT_STATUS_INVALID_LOGON_TYPE;\n+\t\tgoto failed;\n+\t}\n+\n \tclient_princ = talloc_strdup(state->mem_ctx, global_myname());\n \tif (client_princ == NULL) {\n \t\tresult = NT_STATUS_NO_MEMORY;\n\nModified: branches/SAMBA_3_0_26/source/nsswitch/winbindd_pam.c\n===================================================================\n--- branches/SAMBA_3_0_26/source/nsswitch/winbindd_pam.c\t2007-05-15 12:18:17 UTC (rev 22900)\n+++ branches/SAMBA_3_0_26/source/nsswitch/winbindd_pam.c\t2007-05-15 13:42:53 UTC (rev 22901)\n@@ -594,6 +594,14 @@\n \t\thttp_timestring(ticket_lifetime), (int)ticket_lifetime, \n \t\thttp_timestring(renewal_until), (int)renewal_until));\n \n+\t/* we cannot continue with krb5 when UF_DONT_REQUIRE_PREAUTH is set,\n+\t * in that case fallback to NTLM - gd */ \n+\n+\tif ((ticket_lifetime == 0) && (renewal_until == 0)) {\n+\t\tresult = NT_STATUS_INVALID_LOGON_TYPE;\n+\t\tgoto failed;\n+\t}\n+\n \tclient_princ = talloc_strdup(state->mem_ctx, global_myname());\n \tif (client_princ == NULL) {\n \t\tresult = NT_STATUS_NO_MEMORY;\n\n"}