{"category": "ham", "to_address": "samba-cvs@samba.org", "from_address": "jerry@samba.org", "subject": "svn commit: samba r23054 - in branches: SAMBA_3_0/source/nsswitch\n\tSAMBA_3_0_26/source/nsswitch", "body": "Author: jerry\nDate: 2007-05-21 21:33:51 +0000 (Mon, 21 May 2007)\nNew Revision: 23054\n\nWebSVN: http://websvn.samba.org/cgi-bin/viewcvs.cgi?view=rev&root=samba&rev=23054\n\nLog:\nMove the check for the lookup_domain of S-1-22-{1,2} before the \ncheck for IS_DC.  Otherwise we will for example fail to lookup a\nsid of S-1-22-1-780 because it has no valid struct winbindd_domain*\nin the list.   Thanks to Simo for the catch.\n\n\n\nModified:\n   branches/SAMBA_3_0/source/nsswitch/winbindd_util.c\n   branches/SAMBA_3_0_26/source/nsswitch/winbindd_util.c\n\n\nChangeset:\nModified: branches/SAMBA_3_0/source/nsswitch/winbindd_util.c\n===================================================================\n--- branches/SAMBA_3_0/source/nsswitch/winbindd_util.c\t2007-05-21 21:18:23 UTC (rev 23053)\n+++ branches/SAMBA_3_0/source/nsswitch/winbindd_util.c\t2007-05-21 21:33:51 UTC (rev 23054)\n@@ -902,6 +902,16 @@\n \n struct winbindd_domain *find_lookup_domain_from_sid(const DOM_SID *sid)\n {\n+\t/* SIDs in the S-1-22-{1,2} domain should be handled by our passdb */\n+\n+\tif ( sid_check_is_in_unix_groups(sid) || \n+\t     sid_check_is_unix_groups(sid) ||\n+\t     sid_check_is_in_unix_users(sid) ||\n+\t     sid_check_is_unix_users(sid) )\n+\t{\n+\t\treturn find_domain_from_sid(get_global_sam_sid());\n+\t}\n+\n \t/* A DC can't ask the local smbd for remote SIDs, here winbindd is the\n \t * one to contact the external DC's. On member servers the internal\n \t * domains are different: These are part of the local SAM. */\n@@ -912,19 +922,8 @@\n \tif (IS_DC || is_internal_domain(sid) || is_in_internal_domain(sid)) {\n \t\tDEBUG(10, (\"calling find_domain_from_sid\\n\"));\n \t\treturn find_domain_from_sid(sid);\n-\t}\n+\t}\t\n \n-\t/* SIDs in the S-1-22-{1,2} domain should be handled by our passdb */\n-\n-\tif ( sid_check_is_in_unix_groups(sid) || \n-\t     sid_check_is_unix_groups(sid) ||\n-\t     sid_check_is_in_unix_users(sid) ||\n-\t     sid_check_is_unix_users(sid) )\n-\t{\n-\t\treturn find_domain_from_sid(get_global_sam_sid());\n-\t}\n-\t\n-\n \t/* On a member server a query for SID or name can always go to our\n \t * primary DC. */\n \n@@ -934,18 +933,18 @@\n \n struct winbindd_domain *find_lookup_domain_from_name(const char *domain_name)\n {\n-\tif (IS_DC || strequal(domain_name, \"BUILTIN\") ||\n-\t    strequal(domain_name, get_global_sam_name()))\n-\t\treturn find_domain_from_name_noinit(domain_name);\n-\n-\t/* The \"Unix User\" and \"Unix Group\" domain our handled by passdb */\n-\n \tif ( strequal(domain_name, unix_users_domain_name() ) ||\n \t     strequal(domain_name, unix_groups_domain_name() ) )\n \t{\n \t\treturn find_domain_from_name_noinit( get_global_sam_name() );\n \t}\n \n+\tif (IS_DC || strequal(domain_name, \"BUILTIN\") ||\n+\t    strequal(domain_name, get_global_sam_name()))\n+\t\treturn find_domain_from_name_noinit(domain_name);\n+\n+\t/* The \"Unix User\" and \"Unix Group\" domain our handled by passdb */\n+\n \treturn find_our_domain();\n }\n \n\nModified: branches/SAMBA_3_0_26/source/nsswitch/winbindd_util.c\n===================================================================\n--- branches/SAMBA_3_0_26/source/nsswitch/winbindd_util.c\t2007-05-21 21:18:23 UTC (rev 23053)\n+++ branches/SAMBA_3_0_26/source/nsswitch/winbindd_util.c\t2007-05-21 21:33:51 UTC (rev 23054)\n@@ -911,6 +911,16 @@\n \n struct winbindd_domain *find_lookup_domain_from_sid(const DOM_SID *sid)\n {\n+\t/* SIDs in the S-1-22-{1,2} domain should be handled by our passdb */\n+\n+\tif ( sid_check_is_in_unix_groups(sid) || \n+\t     sid_check_is_unix_groups(sid) ||\n+\t     sid_check_is_in_unix_users(sid) ||\n+\t     sid_check_is_unix_users(sid) )\n+\t{\n+\t\treturn find_domain_from_sid(get_global_sam_sid());\n+\t}\n+\n \t/* A DC can't ask the local smbd for remote SIDs, here winbindd is the\n \t * one to contact the external DC's. On member servers the internal\n \t * domains are different: These are part of the local SAM. */\n@@ -921,19 +931,8 @@\n \tif (IS_DC || is_internal_domain(sid) || is_in_internal_domain(sid)) {\n \t\tDEBUG(10, (\"calling find_domain_from_sid\\n\"));\n \t\treturn find_domain_from_sid(sid);\n-\t}\n+\t}\t\n \n-\t/* SIDs in the S-1-22-{1,2} domain should be handled by our passdb */\n-\n-\tif ( sid_check_is_in_unix_groups(sid) || \n-\t     sid_check_is_unix_groups(sid) ||\n-\t     sid_check_is_in_unix_users(sid) ||\n-\t     sid_check_is_unix_users(sid) )\n-\t{\n-\t\treturn find_domain_from_sid(get_global_sam_sid());\n-\t}\n-\t\n-\n \t/* On a member server a query for SID or name can always go to our\n \t * primary DC. */\n \n@@ -943,18 +942,18 @@\n \n struct winbindd_domain *find_lookup_domain_from_name(const char *domain_name)\n {\n-\tif (IS_DC || strequal(domain_name, \"BUILTIN\") ||\n-\t    strequal(domain_name, get_global_sam_name()))\n-\t\treturn find_domain_from_name_noinit(domain_name);\n-\n-\t/* The \"Unix User\" and \"Unix Group\" domain our handled by passdb */\n-\n \tif ( strequal(domain_name, unix_users_domain_name() ) ||\n \t     strequal(domain_name, unix_groups_domain_name() ) )\n \t{\n \t\treturn find_domain_from_name_noinit( get_global_sam_name() );\n \t}\n \n+\tif (IS_DC || strequal(domain_name, \"BUILTIN\") ||\n+\t    strequal(domain_name, get_global_sam_name()))\n+\t\treturn find_domain_from_name_noinit(domain_name);\n+\n+\t/* The \"Unix User\" and \"Unix Group\" domain our handled by passdb */\n+\n \treturn find_our_domain();\n }\n \n\n"}