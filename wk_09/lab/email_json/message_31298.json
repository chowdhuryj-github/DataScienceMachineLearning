{"category": "ham", "to_address": "samba-cvs@samba.org", "from_address": "tridge@samba.org", "subject": "Rev 309: merge shutdown control from ronnie in\n\thttp://samba.org/~tridge/ctdb", "body": "------------------------------------------------------------\nrevno: 309\nrevision-id: tridge@samba.org-20070517004843-ti0e0t7536ss7639\nparent: tridge@samba.org-20070516081026-l0m82yuabzu91dlr\nparent: sahlberg@ronnie-20070517004531-ttyt43eorz178m4p\ncommitter: Andrew Tridgell \nbranch nick: tridge\ntimestamp: Thu 2007-05-17 10:48:43 +1000\nmessage:\n  merge shutdown control from ronnie\nmodified:\n  common/ctdb_client.c           ctdb_client.c-20070411010216-3kd8v37k61steeya-1\n  common/ctdb_control.c          ctdb_control.c-20070426122724-j6gkpiofhbwdin63-1\n  include/ctdb.h                 ctdb.h-20061117234101-o3qt14umlg9en8z0-11\n  include/ctdb_private.h         ctdb_private.h-20061117234101-o3qt14umlg9en8z0-13\n  tools/ctdb_control.c           ctdb_control.c-20070426122705-9ehj1l5lu2gn9kuj-1\n    ------------------------------------------------------------\n    revno: 197.1.115\n    merged: sahlberg@ronnie-20070517004531-ttyt43eorz178m4p\n    parent: sahlberg@ronnie-20070516084451-3p2fffgok3kqbt12\n    committer: Ronnie Sahlberg \n    branch nick: ctdb\n    timestamp: Thu 2007-05-17 10:45:31 +1000\n    message:\n      add a control to shutdown/kill a node\n    ------------------------------------------------------------\n    revno: 197.1.114\n    merged: sahlberg@ronnie-20070516084451-3p2fffgok3kqbt12\n    parent: sahlberg@ronnie-20070516044543-ognbrw9p5bez3q4a\n    parent: tridge@samba.org-20070516081026-l0m82yuabzu91dlr\n    committer: Ronnie Sahlberg \n    branch nick: ctdb\n    timestamp: Wed 2007-05-16 18:44:51 +1000\n    message:\n      merge from tridge\n    ------------------------------------------------------------\n    revno: 197.1.113\n    merged: sahlberg@ronnie-20070516044543-ognbrw9p5bez3q4a\n    parent: sahlberg@ronnie-20070516023430-nle4lyaap7006te6\n    committer: Ronnie Sahlberg \n    branch nick: ctdb\n    timestamp: Wed 2007-05-16 14:45:43 +1000\n    message:\n      remove a prototype we no longer need\n=== modified file 'common/ctdb_client.c'\n--- a/common/ctdb_client.c\t2007-05-16 08:10:26 +0000\n+++ b/common/ctdb_client.c\t2007-05-17 00:45:31 +0000\n@@ -840,6 +840,27 @@\n }\n \n /*\n+  shutdown a remote ctdb node\n+ */\n+int ctdb_ctrl_shutdown(struct ctdb_context *ctdb, struct timeval timeout, uint32_t destnode)\n+{\n+\tint ret;\n+\tTDB_DATA data;\n+\tint32_t res;\n+\n+\tZERO_STRUCT(data);\n+\tret = ctdb_control(ctdb, destnode, 0, \n+\t\t\t   CTDB_CONTROL_SHUTDOWN, CTDB_CTRL_FLAG_NOREPLY, data, \n+\t\t\t   ctdb, &data, &res, &timeout, NULL);\n+\tif (ret != 0) {\n+\t\tDEBUG(0,(__location__ \" ctdb_control for shutdown failed\\n\"));\n+\t\treturn -1;\n+\t}\n+\n+\treturn 0;\n+}\n+\n+/*\n   get vnn map from a remote node\n  */\n int ctdb_ctrl_getvnnmap(struct ctdb_context *ctdb, struct timeval timeout, uint32_t destnode, TALLOC_CTX *mem_ctx, struct ctdb_vnn_map **vnnmap)\n\n=== modified file 'common/ctdb_control.c'\n--- a/common/ctdb_control.c\t2007-05-16 02:34:30 +0000\n+++ b/common/ctdb_control.c\t2007-05-17 00:45:31 +0000\n@@ -240,6 +240,9 @@\n \t\tCHECK_CONTROL_DATA_SIZE(sizeof(uint32_t));\t\t\n \t\treturn ctdb_control_set_recmode(ctdb, indata, errormsg);\n \n+\tcase CTDB_CONTROL_SHUTDOWN:\n+\t\texit(10);\n+\n \tdefault:\n \t\tDEBUG(0,(__location__ \" Unknown CTDB control opcode %u\\n\", opcode));\n \t\treturn -1;\n\n=== modified file 'include/ctdb.h'\n--- a/include/ctdb.h\t2007-05-16 01:12:28 +0000\n+++ b/include/ctdb.h\t2007-05-17 00:45:31 +0000\n@@ -203,6 +203,8 @@\n struct ctdb_status;\n int ctdb_ctrl_status(struct ctdb_context *ctdb, uint32_t destnode, struct ctdb_status *status);\n \n+int ctdb_ctrl_shutdown(struct ctdb_context *ctdb, struct timeval timeout, uint32_t destnode);\n+\n struct ctdb_vnn_map;\n int ctdb_ctrl_getvnnmap(struct ctdb_context *ctdb, \n \t\tstruct timeval timeout, uint32_t destnode, \n@@ -277,11 +279,6 @@\n int ctdb_ctrl_cleardb(struct ctdb_context *ctdb, uint32_t destnode, TALLOC_CTX *mem_ctx, uint32_t dbid);\n \n /*\n-  bump the rsn number for al records\n- */\n-int ctdb_ctrl_bumprsn(struct ctdb_context *ctdb, struct timeval timeout, uint32_t destnode, TALLOC_CTX *mem_ctx, uint32_t dbid);\n-\n-/*\n   write a record on a specific db (this implicitely updates dmaster of the record to locally be the vnn of the node where the control is executed on)\n  */\n int ctdb_ctrl_write_record(struct ctdb_context *ctdb, uint32_t destnode, TALLOC_CTX *mem_ctx, uint32_t dbid, TDB_DATA key, TDB_DATA data);\n\n=== modified file 'include/ctdb_private.h'\n--- a/include/ctdb_private.h\t2007-05-16 08:10:26 +0000\n+++ b/include/ctdb_private.h\t2007-05-17 00:45:31 +0000\n@@ -353,6 +353,7 @@\n \t\t    CTDB_CONTROL_FREEZE,\n \t\t    CTDB_CONTROL_THAW,\n \t\t    CTDB_CONTROL_GET_VNN,\n+\t\t    CTDB_CONTROL_SHUTDOWN,\n };\n \n \n\n=== modified file 'tools/ctdb_control.c'\n--- a/tools/ctdb_control.c\t2007-05-12 11:25:26 +0000\n+++ b/tools/ctdb_control.c\t2007-05-17 00:45:31 +0000\n@@ -57,6 +57,7 @@\n \t\t\"  setrecmaster      set recovery master\\n\"\n \t\t\"  attach                     attach a database\\n\"\n \t\t\"  getpid                        get the pid of a ctdb daemon\\n\"\n+\t\t\"  shutdown                      shutdown a remote ctdb\\n\"\n \t\t\"  freeze                    freeze a node\\n\"\n \t\t\"  thaw                      thaw a node\\n\"\n \t);\n@@ -344,6 +345,30 @@\n }\n \n /*\n+  shutdown a daemon\n+ */\n+static int control_shutdown(struct ctdb_context *ctdb, int argc, const char **argv)\n+{\n+\tuint32_t vnn;\n+\tint ret;\n+\n+\n+\tif (argc < 1) {\n+\t\tusage();\n+\t}\n+\n+\tvnn     = strtoul(argv[0], NULL, 0);\n+\n+\tret = ctdb_ctrl_shutdown(ctdb, timeval_current_ofs(1, 0), vnn);\n+\tif (ret != 0) {\n+\t\tprintf(\"Unable to shutdown node %u\\n\", vnn);\n+\t\treturn ret;\n+\t}\n+\n+\treturn 0;\n+}\n+\n+/*\n   display recovery mode of a remote node\n  */\n static int control_getrecmode(struct ctdb_context *ctdb, int argc, const char **argv)\n@@ -973,6 +998,7 @@\n \t\t{ \"attach\", control_attach },\n \t\t{ \"dumpmemory\", control_dumpmemory },\n \t\t{ \"getpid\", control_getpid },\n+\t\t{ \"shutdown\", control_shutdown },\n \t\t{ \"freeze\", control_freeze },\n \t\t{ \"thaw\", control_thaw },\n \t};\n\n"}