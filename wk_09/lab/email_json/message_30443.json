{"category": "ham", "to_address": "samba-cvs@samba.org", "from_address": "derrell@samba.org", "subject": "svn commit: samba r22917 - in branches/SAMBA_3_0_26:\n\texamples/libsmbclient source/libsmb", "body": "Author: derrell\nDate: 2007-05-15 19:17:29 +0000 (Tue, 15 May 2007)\nNew Revision: 22917\n\nWebSVN: http://websvn.samba.org/cgi-bin/viewcvs.cgi?view=rev&root=samba&rev=22917\n\nLog:\n\n- Fixes bug 4599.  A missing if statement forced subseqeuent\n  attempts to set attributes to fail.\n\n- I also noticed that missing attributes were setting an invalid return string\n  by getxattr(), e.g. if there was not group, the return string had \"GROUP:;\"\n  instead of excluding the GROUP attribute entirely as it should.  The big\n  problem with the way it was, is that the string could not then be passed to\n  setxattr() and parsed.\n\nAdded:\n   branches/SAMBA_3_0_26/examples/libsmbclient/testacl2.c\nModified:\n   branches/SAMBA_3_0_26/examples/libsmbclient/Makefile\n   branches/SAMBA_3_0_26/source/libsmb/libsmbclient.c\n\n\nChangeset:\nModified: branches/SAMBA_3_0_26/examples/libsmbclient/Makefile\n===================================================================\n--- branches/SAMBA_3_0_26/examples/libsmbclient/Makefile\t2007-05-15 19:17:16 UTC (rev 22916)\n+++ branches/SAMBA_3_0_26/examples/libsmbclient/Makefile\t2007-05-15 19:17:29 UTC (rev 22917)\n@@ -17,6 +17,7 @@\n TESTS=\ttestsmbc \\\n \ttree \\\n \ttestacl \\\n+\ttestacl2 \\\n \ttestbrowse \\\n \ttestbrowse2 \\\n \tteststat \\\n@@ -39,6 +40,10 @@\n \t@echo Linking testacl\n \t$(CC) `gtk-config --cflags` $(CFLAGS) $(LDFLAGS) -o $@ $< `gtk-config --libs` $(LIBSMBCLIENT) -lpopt\n \n+testacl2: testacl2.o\n+\t@echo Linking testacl2\n+\t$(CC) `gtk-config --cflags` $(CFLAGS) $(LDFLAGS) -o $@ $< `gtk-config --libs` $(LIBSMBCLIENT) -lpopt\n+\n testbrowse: testbrowse.o\n \t@echo Linking testbrowse\n \t$(CC) $(CFLAGS) $(LDFLAGS) -o $@ $< $(LIBSMBCLIENT) -lpopt\n\nAdded: branches/SAMBA_3_0_26/examples/libsmbclient/testacl2.c\n===================================================================\n--- branches/SAMBA_3_0_26/examples/libsmbclient/testacl2.c\t2007-05-15 19:17:16 UTC (rev 22916)\n+++ branches/SAMBA_3_0_26/examples/libsmbclient/testacl2.c\t2007-05-15 19:17:29 UTC (rev 22917)\n@@ -0,0 +1,78 @@\n+#include \n+#include \n+#include \n+#include \n+#include \"libsmbclient.h\"\n+#include \"get_auth_data_fn.h\"\n+\n+enum acl_mode\n+{\n+    SMB_ACL_GET,\n+    SMB_ACL_SET,\n+    SMB_ACL_DELETE,\n+    SMB_ACL_MODIFY,\n+    SMB_ACL_ADD,\n+    SMB_ACL_CHOWN,\n+    SMB_ACL_CHGRP\n+};\n+\n+\n+int main(int argc, const char *argv[])\n+{\n+    int i;\n+    int opt;\n+    int flags;\n+    int debug = 0;\n+    int numeric = 0;\n+    int full_time_names = 0;\n+    enum acl_mode mode = SMB_ACL_GET;\n+    static char *the_acl = NULL;\n+    int ret;\n+    char *p;\n+    char *debugstr;\n+    char value[1024];\n+\n+    if (smbc_init(get_auth_data_fn, debug) != 0)\n+    {\n+        printf(\"Could not initialize smbc_ library\\n\");\n+        return 1;\n+    }\n+\n+    SMBCCTX *context = smbc_set_context(NULL);\n+    smbc_option_set(context, \"full_time_names\", 1);\n+    \n+    the_acl = strdup(\"system.nt_sec_desc.*\");\n+    ret = smbc_getxattr(argv[1], the_acl, value, sizeof(value));\n+    if (ret < 0)\n+    {\n+        printf(\"Could not get attributes for [%s] %d: %s\\n\",\n+               argv[1], errno, strerror(errno));\n+        return 1;\n+    }\n+    \n+    printf(\"Attributes for [%s] are:\\n%s\\n\", argv[1], value);\n+\n+    flags = 0;\n+    debugstr = \"set attributes (1st time)\";\n+        \n+    ret = smbc_setxattr(argv[1], the_acl, value, strlen(value), flags);\n+    if (ret < 0)\n+    {\n+        printf(\"Could not %s for [%s] %d: %s\\n\",\n+               debugstr, argv[1], errno, strerror(errno));\n+        return 1;\n+    }\n+    \n+    flags = 0;\n+    debugstr = \"set attributes (2nd time)\";\n+        \n+    ret = smbc_setxattr(argv[1], the_acl, value, strlen(value), flags);\n+    if (ret < 0)\n+    {\n+        printf(\"Could not %s for [%s] %d: %s\\n\",\n+               debugstr, argv[1], errno, strerror(errno));\n+        return 1;\n+    }\n+    \n+    return 0;\n+}\n\nModified: branches/SAMBA_3_0_26/source/libsmb/libsmbclient.c\n===================================================================\n--- branches/SAMBA_3_0_26/source/libsmb/libsmbclient.c\t2007-05-15 19:17:16 UTC (rev 22916)\n+++ branches/SAMBA_3_0_26/source/libsmb/libsmbclient.c\t2007-05-15 19:17:29 UTC (rev 22917)\n@@ -4556,7 +4556,7 @@\n                                                 return -1;\n                                         }\n                                         n = strlen(p);\n-                                } else {\n+                                } else if (sidstr[0] != '\\0') {\n                                         n = snprintf(buf, bufsize,\n                                                      \",OWNER:%s\", sidstr);\n                                 }\n@@ -4601,7 +4601,7 @@\n                                                 return -1;\n                                         }\n                                         n = strlen(p);\n-                                } else {\n+                                } else if (sidstr[0] != '\\0') {\n                                         n = snprintf(buf, bufsize,\n                                                      \",GROUP:%s\", sidstr);\n                                 }\n@@ -5327,7 +5327,9 @@\n                 ipc_srv = smbc_attr_server(context, server, share,\n                                            workgroup, user, password,\n                                            &pol);\n-                srv->no_nt_session = True;\n+                if (! ipc_srv) {\n+                        srv->no_nt_session = True;\n+                }\n         } else {\n                 ipc_srv = NULL;\n         }\n@@ -5752,7 +5754,9 @@\n                 ipc_srv = smbc_attr_server(context, server, share,\n                                            workgroup, user, password,\n                                            &pol);\n-                srv->no_nt_session = True;\n+                if (! ipc_srv) {\n+                        srv->no_nt_session = True;\n+                }\n         } else {\n                 ipc_srv = NULL;\n         }\n\n"}