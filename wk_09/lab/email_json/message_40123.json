{"category": "ham", "to_address": "samba-cvs@samba.org", "from_address": "tridge@samba.org", "subject": "Rev 410: merged from ronnie in http://samba.org/~tridge/ctdb", "body": "------------------------------------------------------------\nrevno: 410\nrevision-id: tridge@samba.org-20070601032911-4o9qwds8gfregd3p\nparent: tridge@samba.org-20070531035053-dgk3sbz0t10c7v18\nparent: sahlberg@ronnie-20070601032614-3ngwkhvkku56xk27\ncommitter: Andrew Tridgell \nbranch nick: tridge\ntimestamp: Fri 2007-06-01 13:29:11 +1000\nmessage:\n  merged from ronnie\nmodified:\n  tools/events                   events-20070529030121-04fjh63cxfh8v1pj-1\n  tools/statd-callout            statdcallout-20070531010857-6sdlz455vusye5y5-1\n    ------------------------------------------------------------\n    revno: 393.1.3\n    merged: sahlberg@ronnie-20070601032614-3ngwkhvkku56xk27\n    parent: sahlberg@ronnie-20070601031405-yd5dk72l9rtxciz2\n    committer: Ronnie Sahlberg \n    branch nick: ctdb\n    timestamp: Fri 2007-06-01 13:26:14 +1000\n    message:\n      it is -f   not -x to check if a file exists\n    ------------------------------------------------------------\n    revno: 393.1.2\n    merged: sahlberg@ronnie-20070601031405-yd5dk72l9rtxciz2\n    parent: sahlberg@ronnie-20070601030353-6vwmyp86x7rajbh3\n    committer: Ronnie Sahlberg \n    branch nick: ctdb\n    timestamp: Fri 2007-06-01 13:14:05 +1000\n    message:\n      - create /etc/ctdb/taken_ips and /etc/ctdb/changed_ips analog to the \n      existing /etc/ctdb/released_ips\n      \n      - only call the statd-callout script if the ips have changed  and call \n      it with a \"notify\" argument.    we need to restart nfslock service in \n      both cases\n      \n      - change statd-callout to explicitely restart the lock manager and statd \n      when \"notify\" is called.   copy the state directory for each held ip \n      from shared storage to /tmp then use sm-notify to send notifications to \n      all monitored clients\n    ------------------------------------------------------------\n    revno: 393.1.1\n    merged: sahlberg@ronnie-20070601030353-6vwmyp86x7rajbh3\n    parent: tridge@samba.org-20070530002116-kz22u8npsxt6hhom\n    parent: tridge@samba.org-20070531035053-dgk3sbz0t10c7v18\n    committer: Ronnie Sahlberg \n    branch nick: ctdb\n    timestamp: Fri 2007-06-01 13:03:53 +1000\n    message:\n      new branch from tridges tree\n=== modified file 'tools/events'\n--- a/tools/events\t2007-05-31 01:09:45 +0000\n+++ b/tools/events\t2007-06-01 03:26:14 +0000\n@@ -41,6 +41,9 @@\n \t\t echo \"Failed to add $ip/$maskbits on dev $iface\"\n \t\t exit 1\n \t}\n+\techo $ip >> /etc/ctdb/taken_ips\n+\techo $ip >> /etc/ctdb/changed_ips\n+\n \t# if we have a local arp entry for this IP then remove it\n \t/sbin/arp -d $ip 2> /dev/null\n \n@@ -65,19 +68,27 @@\n \t# if we have a local arp entry for this IP then remove it\n \t/sbin/arp -d $ip 2> /dev/null\n \techo $ip >> /etc/ctdb/released_ips\n+\techo $ip >> /etc/ctdb/changed_ips\n \t/bin/rm -f /etc/ctdb/ip.$ip\n \texit 0\n \t;;\n \n      recovered)\n-        # restart any services as necessary, like NFS\n-\t# \n-\t[ -x /etc/ctdb/statd-callout ] && /etc/ctdb/statd-callout copy\n+\t# if we have taken or released any ips we must send out\n+\t# statd notifications to recover lost nfs locks\n+\t[ -x /etc/ctdb/statd-callout ] && [ -f /etc/ctdb/changed_ips ] && {\n+\t\t/etc/ctdb/statd-callout notify &\n+\t} >/dev/null 2>&1\n+\n+        # restart NFS to ensure that all TCP connections to the released ip\n+\t# are closed\n \t[ -f /etc/ctdb/released_ips ] && {\n \t\t( /sbin/service nfs status > /dev/null 2>&1 && \n                       /sbin/service nfs restart > /dev/null 2>&1 ) &\n \t} > /dev/null 2>&1\n+\t/bin/rm -f /etc/ctdb/changed_ips\n \t/bin/rm -f /etc/ctdb/released_ips\n+\t/bin/rm -f /etc/ctdb/taken_ips\n \texit 0\n \t;;\n \n\n=== modified file 'tools/statd-callout'\n--- a/tools/statd-callout\t2007-05-31 01:14:07 +0000\n+++ b/tools/statd-callout\t2007-06-01 03:14:05 +0000\n@@ -22,23 +22,23 @@\n \t    /bin/rm -f $STATD_SHARED_DIRECTORY/$ip/$2\n \tdone\n \t;;\n-  copy)\n-\trestart_needed=0\n+  notify)\n+\t# restart the local lock manager and statd\n+\t/sbin/service nfslock stop > /dev/null 2>&1 \n+\t/sbin/service nfslock start > /dev/null 2>&1 \n+\t# send out notifications to any additional ips we now serve\n         for f in `/bin/ls /etc/ctdb/ip.*`; do\n \t    fname=`/bin/basename $f`\n \t    ip=`echo $fname | cut -d. -f2-`\n \t    [ -d $STATD_SHARED_DIRECTORY/$ip ] && {\n-\t\t/bin/mv $STATD_SHARED_DIRECTORY/$ip $STATD_SHARED_DIRECTORY/$ip.$$\n-\t\t/bin/cp -a $STATD_SHARED_DIRECTORY/$ip.$$/. /var/lib/nfs/statd/sm/\n-\t\t/bin/rm -rf $STATD_SHARED_DIRECTORY/$ip.$$\n-\t\trestart_needed=1\n+\t\t# we must copy to a different directory since rpc.statd gets\n+\t\t# \"upset\" if sm-notify touches the files.\n+\t\t/bin/rm -rf /tmp/statd/$ip\n+\t\t/bin/mkdir -p /tmp/statd/$ip\n+\t\t/bin/cp -apr $STATD_SHARED_DIRECTORY/$ip/* /tmp/statd/$ip\n+\t\t/usr/sbin/sm-notify -P /tmp/statd/$ip -v $ip -n\n \t    }\n \tdone\n-\t# restart lockd if necessary\n-\t[ $restart_needed -eq 1 ] && {\n-\t\t( /sbin/service nfslock status > /dev/null 2>&1 && \n-                      /sbin/service nfslock restart > /dev/null 2>&1 ) &\n-\t} > /dev/null 2>&1\n \t;;\n esac\n \n\n"}