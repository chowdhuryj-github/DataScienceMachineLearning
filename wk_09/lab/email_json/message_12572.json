{"category": "ham", "to_address": "samba-cvs@samba.org", "from_address": "tridge@samba.org", "subject": "Rev 180: mark authoritative records in http://samba.org/~tridge/ctdb", "body": "------------------------------------------------------------\nrevno: 180\nrevision-id: tridge@samba.org-20070422145309-2hanalfdwko2p6gn\nparent: tridge@samba.org-20070422143955-dxs2la9avaiz2ue6\ncommitter: Andrew Tridgell \nbranch nick: tridge\ntimestamp: Sun 2007-04-22 16:53:09 +0200\nmessage:\n  mark authoritative records\nmodified:\n  tools/ctdb_dump.c              ctdb_dump.c-20070422072106-vavpof4y9zz8z2lh-1\n=== modified file 'tools/ctdb_dump.c'\n--- a/tools/ctdb_dump.c\t2007-04-22 14:39:55 +0000\n+++ b/tools/ctdb_dump.c\t2007-04-22 14:53:09 +0000\n@@ -36,15 +36,25 @@\n \texit(1);\n }\n \n+struct node_info {\n+\tuint32_t num_nodes;\n+\tuint32_t vnn;\n+};\n+\n static int traverse_fn(struct tdb_context *tdb, TDB_DATA key, TDB_DATA data, void *p)\n {\n-\tint *num_nodes = (int *)p;\n+\tstruct node_info *info = (struct node_info *)p;\n \tstruct id {\n \t\tdev_t dev;\n \t\tino_t inode;\n \t} *id;\n \tstruct ctdb_ltdb_header *h = (struct ctdb_ltdb_header *)data.dptr;\n \tchar *keystr;\n+\tuint32_t lmaster;\n+\tint authoritative=0;\n+\n+\tlmaster = ctdb_hash(&key) % info->num_nodes;\n+\n \tid = (struct id *)key.dptr;\n \tif (key.dsize == sizeof(*id)) {\n \t\tkeystr = talloc_asprintf(NULL, \"%llu:%llu\", \n@@ -52,11 +62,12 @@\n \t} else {\n \t\tkeystr = hex_encode(NULL, key.dptr, key.dsize);\n \t}\n+\tauthoritative = (info->vnn == lmaster || info->vnn == h->dmaster);\n \tprintf(\"  rec %s lmaster=%u dmaster=%u %c\\n\", \n \t       keystr, \n-\t       ctdb_hash(&key) % (*num_nodes),\n+\t       lmaster,\n \t       h->dmaster,\n-\t\t);\n+\t       authoritative?'A':' ');\n \ttalloc_free(keystr);\n \treturn 0;\n }\n@@ -76,6 +87,7 @@\n \tint i, extra_argc = 0;\n \tpoptContext pc;\n \tstruct tdb_wrap *db;\n+\tstruct node_info info;\t\n \n \tpc = poptGetContext(argv[0], argc, argv, popt_options, POPT_CONTEXT_KEEP_FIRST);\n \n@@ -108,7 +120,9 @@\n \t\t}\n \n \t\tprintf(\"db %s\\n\", extra_argv[i]);\n-\t\ttdb_traverse(db->tdb, traverse_fn, &extra_argc);\n+\t\tinfo.vnn = i;\n+\t\tinfo.num_nodes = extra_argc;\n+\t\ttdb_traverse(db->tdb, traverse_fn, &info);\n \t\t\n \t\ttalloc_free(db);\n \t}\n\n"}