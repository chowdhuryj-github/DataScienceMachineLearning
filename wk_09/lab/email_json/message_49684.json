{"category": "ham", "to_address": "samba-cvs@samba.org", "from_address": "tridge@samba.org", "subject": "svn commit: samba r23531 - in\n\tbranches/SAMBA_4_0/source/torture/nbench: .", "body": "Author: tridge\nDate: 2007-06-17 19:35:00 +0000 (Sun, 17 Jun 2007)\nNew Revision: 23531\n\nWebSVN: http://websvn.samba.org/cgi-bin/viewcvs.cgi?view=rev&root=samba&rev=23531\n\nLog:\n\nadded optional latency reporting in BENCH-NBENCH. To use it, you need\nto have a load file that puts a timestamp in the first column. That\ntells NBENCH to target the same throughput as the capture, and to\nreport the maximum amount of latency miss in the test\n\nThis allows you to quickly see how many clients you can run with while\nstill meeting a given target\n\nModified:\n   branches/SAMBA_4_0/source/torture/nbench/nbench.c\n   branches/SAMBA_4_0/source/torture/nbench/nbio.c\n\n\nChangeset:\nModified: branches/SAMBA_4_0/source/torture/nbench/nbench.c\n===================================================================\n--- branches/SAMBA_4_0/source/torture/nbench/nbench.c\t2007-06-17 19:23:32 UTC (rev 23530)\n+++ branches/SAMBA_4_0/source/torture/nbench/nbench.c\t2007-06-17 19:35:00 UTC (rev 23531)\n@@ -24,6 +24,7 @@\n #include \"torture/util.h\"\n #include \"torture/torture.h\"\n #include \"system/filesys.h\"\n+#include \"system/locale.h\"\n #include \"pstring.h\"\n \n #include \"torture/nbench/proto.h\"\n@@ -44,7 +45,6 @@\n \tpstring line;\n \tchar *cname;\n \tFILE *f;\n-\tconst char **params;\n \tBOOL correct = True;\n \n \tif (torture_nprocs == 1) {\n@@ -64,9 +64,13 @@\n \t\treturn False;\n \t}\n \n+\n again:\n+\tnbio_time_reset();\n+\n \twhile (fgets(line, sizeof(line)-1, f)) {\n \t\tNTSTATUS status;\n+\t\tconst char **params0, **params;\n \n \t\tnbench_line_count++;\n \n@@ -74,9 +78,16 @@\n \n \t\tall_string_sub(line,\"client1\", cname, sizeof(line));\n \t\t\n-\t\tparams = str_list_make_shell(NULL, line, \" \");\n+\t\tparams = params0 = str_list_make_shell(NULL, line, \" \");\n \t\ti = str_list_length(params);\n \n+\t\tif (i > 0 && isdigit(params[0][0])) {\n+\t\t\tdouble targett = strtod(params[0], NULL);\n+\t\t\tnbio_time_delay(targett);\n+\t\t\tparams++;\n+\t\t\ti--;\n+\t\t}\n+\n \t\tif (i < 2 || params[0][0] == '#') continue;\n \n \t\tif (!strncmp(params[0],\"SMB\", 3)) {\n@@ -146,7 +157,7 @@\n \t\t\tprintf(\"[%d] Unknown operation %s\\n\", nbench_line_count, params[0]);\n \t\t}\n \n-\t\ttalloc_free(params);\n+\t\ttalloc_free(params0);\n \t\t\n \t\tif (nb_tick()) goto done;\n \t}\n\nModified: branches/SAMBA_4_0/source/torture/nbench/nbio.c\n===================================================================\n--- branches/SAMBA_4_0/source/torture/nbench/nbio.c\t2007-06-17 19:23:32 UTC (rev 23530)\n+++ branches/SAMBA_4_0/source/torture/nbench/nbio.c\t2007-06-17 19:35:00 UTC (rev 23531)\n@@ -53,8 +53,25 @@\n \tdouble bytes, warmup_bytes;\n \tint line;\n \tint done;\n+\tdouble max_latency;\n+\tstruct timeval starttime;\n } *children;\n \n+void nbio_time_reset(void)\n+{\n+\tchildren[nbio_id].starttime = timeval_current();\t\n+}\n+\n+void nbio_time_delay(double targett)\n+{\n+\tdouble elapsed = timeval_elapsed(&children[nbio_id].starttime);\n+\tif (targett > elapsed) {\n+\t\tmsleep(1000*(targett - elapsed));\n+\t} else if (elapsed - targett > children[nbio_id].max_latency) {\n+\t\tchildren[nbio_id].max_latency = elapsed - targett;\n+\t}\n+}\n+\n double nbio_result(void)\n {\n \tint i;\n@@ -65,6 +82,19 @@\n \treturn 1.0e-6 * total / timeval_elapsed2(&tv_start, &tv_end);\n }\n \n+double nbio_latency(void)\n+{\n+\tint i;\n+\tdouble max_latency = 0;\n+\tfor (i=0;i max_latency) {\n+\t\t\tmax_latency = children[i].max_latency;\n+\t\t\tchildren[i].max_latency = 0;\n+\t\t}\n+\t}\n+\treturn max_latency;\n+}\n+\n BOOL nb_tick(void)\n {\n \treturn children[nbio_id].done;\n@@ -122,9 +152,9 @@\n \t\t       nprocs, lines/nprocs, \n \t\t       nbio_result(), t);\n \t} else {\n-\t\tprintf(\"%4d  %8d  %.2f MB/sec  execute %.0f sec   \\n\", \n+\t\tprintf(\"%4d  %8d  %.2f MB/sec  execute %.0f sec  latency %.2f msec \\n\", \n \t\t       nprocs, lines/nprocs, \n-\t\t       nbio_result(), t);\n+\t\t       nbio_result(), t, nbio_latency() * 1.0e3);\n \t}\n \n \tfflush(stdout);\n@@ -443,7 +473,7 @@\n \tio.readx.in.remaining = 0;\n \tio.readx.in.read_for_execute = False;\n \tio.readx.out.data     = buf;\n-\t\t\n+\t\n \tret = smb_raw_read(c->tree, &io);\n \n \tfree(buf);\n\n"}