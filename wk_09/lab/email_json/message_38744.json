{"category": "ham", "to_address": "samba-cvs@samba.org", "from_address": "tridge@samba.org", "subject": "Rev 403: use our own netmask when deciding if we should takeover a\n\tIP, not the other nodes in http://samba.org/~tridge/ctdb", "body": "------------------------------------------------------------\nrevno: 403\nrevision-id: tridge@samba.org-20070530061139-3n42c8eoi2nk007e\nparent: tridge@samba.org-20070530054325-s8i707ydww0omcor\ncommitter: Andrew Tridgell \nbranch nick: tridge\ntimestamp: Wed 2007-05-30 16:11:39 +1000\nmessage:\n  use our own netmask when deciding if we should takeover a IP, not the other nodes\n  - check if ctdb dies while waiting for the startup event\nmodified:\n  takeover/ctdb_takeover.c       ctdb_takeover.c-20070525071636-a5n1ihghjtppy08r-2\n  tools/events                   events-20070529030121-04fjh63cxfh8v1pj-1\n=== modified file 'takeover/ctdb_takeover.c'\n--- a/takeover/ctdb_takeover.c\t2007-05-29 06:23:47 +0000\n+++ b/takeover/ctdb_takeover.c\t2007-05-30 06:11:39 +0000\n@@ -318,8 +318,9 @@\n \t\t\t     j != i;\n \t\t\t     j=(j+1)%nodemap->num) {\n \t\t\t\tif ((nodemap->nodes[j].flags & NODE_FLAGS_CONNECTED) &&\n-\t\t\t\t    ctdb_same_subnet(ctdb->nodes[j]->public_address, ctdb->nodes[i]->public_address, \n-\t\t\t\t\t\t     ctdb->nodes[i]->public_netmask_bits)) {\n+\t\t\t\t    ctdb_same_subnet(ctdb->nodes[j]->public_address, \n+\t\t\t\t\t\t     ctdb->nodes[i]->public_address, \n+\t\t\t\t\t\t     ctdb->nodes[j]->public_netmask_bits)) {\n \t\t\t\t\tctdb->nodes[i]->takeover_vnn = nodemap->nodes[j].vnn;\n \t\t\t\t\tbreak;\n \t\t\t\t}\n\n=== modified file 'tools/events'\n--- a/tools/events\t2007-05-30 02:37:03 +0000\n+++ b/tools/events\t2007-05-30 06:11:39 +0000\n@@ -18,6 +18,10 @@\n \t  \t      /usr/bin/nc -z 127.0.0.1 $p || all_ok=0\n \t\t  done\n \t\t  [ $all_ok -eq 1 ] || sleep 1\n+\t\t  /usr/bin/ctdb status > /dev/null 2>&1 || {\n+\t  \t\techo \"ctdb daemon has died. Exiting event startup\"\n+\t\t\texit 1\n+\t\t  }\n           done\n \t  echo \"Local tcp services on $CTDB_WAIT_TCP_PORTS are up\"\n \t}\n\n"}