{"category": "ham", "to_address": "samba-cvs@samba.org", "from_address": "tridge@samba.org", "subject": "Rev 448: merged from ronnie in http://samba.org/~tridge/ctdb", "body": "------------------------------------------------------------\nrevno: 448\nrevision-id: tridge@samba.org-20070603105424-u3l4oixhczc2triy\nparent: tridge@samba.org-20070603075326-xqewuvbtien3b5dq\nparent: sahlberg@ronnie-20070603095051-58zzq6mxi86c40zq\ncommitter: Andrew Tridgell \nbranch nick: tridge\ntimestamp: Sun 2007-06-03 20:54:24 +1000\nmessage:\n  merged from ronnie\nmodified:\n  common/ctdb.c                  ctdb.c-20061127094323-t50f58d65iaao5of-2\n  config/ctdb.init               ctdb.init-20070527204758-biuh7znabuwan3zn-6\n  tools/ctdb_control.c           ctdb_control.c-20070426122705-9ehj1l5lu2gn9kuj-1\n    ------------------------------------------------------------\n    revno: 432.1.12\n    merged: sahlberg@ronnie-20070603095051-58zzq6mxi86c40zq\n    parent: sahlberg@ronnie-20070603092452-h1qlnejo2a0fklpc\n    committer: Ronnie Sahlberg \n    branch nick: ctdb\n    timestamp: Sun 2007-06-03 19:50:51 +1000\n    message:\n      add a -Y option to generate machine readable output.\n      \n      print 'ctdb status' in machinereadable form as\n      :VNN:0|1:\n    ------------------------------------------------------------\n    revno: 432.1.11\n    merged: sahlberg@ronnie-20070603092452-h1qlnejo2a0fklpc\n    parent: sahlberg@ronnie-20070603085927-c9cj57iwxq0wia0g\n    committer: Ronnie Sahlberg \n    branch nick: ctdb\n    timestamp: Sun 2007-06-03 19:24:52 +1000\n    message:\n      ubuntu uses a different style of init scripts than redhat and suse\n    ------------------------------------------------------------\n    revno: 432.1.10\n    merged: sahlberg@ronnie-20070603085927-c9cj57iwxq0wia0g\n    parent: sahlberg@ronnie-20070603084129-kmk47z6rmnbt0i58\n    committer: Ronnie Sahlberg \n    branch nick: ctdb\n    timestamp: Sun 2007-06-03 18:59:27 +1000\n    message:\n      print an error message to stdout if we failed to open the logfile for \n      the daemon\n    ------------------------------------------------------------\n    revno: 432.1.9\n    merged: sahlberg@ronnie-20070603084129-kmk47z6rmnbt0i58\n    parent: sahlberg@ronnie-20070603070723-s990kt8m5mlmhs11\n    parent: tridge@samba.org-20070603075326-xqewuvbtien3b5dq\n    committer: Ronnie Sahlberg \n    branch nick: ctdb\n    timestamp: Sun 2007-06-03 18:41:29 +1000\n    message:\n      merge from tridge\n    ------------------------------------------------------------\n    revno: 432.1.8\n    merged: sahlberg@ronnie-20070603070723-s990kt8m5mlmhs11\n    parent: sahlberg@ronnie-20070603014813-ynuw05wtnyb8fbjz\n    parent: tridge@samba.org-20070603063308-jk7nmnql4y4smcp6\n    committer: Ronnie Sahlberg \n    branch nick: ctdb\n    timestamp: Sun 2007-06-03 17:07:23 +1000\n    message:\n      merge from tridge\n=== modified file 'common/ctdb.c'\n--- a/common/ctdb.c\t2007-06-02 03:16:11 +0000\n+++ b/common/ctdb.c\t2007-06-03 08:59:27 +0000\n@@ -52,12 +52,13 @@\n \tctdb->logfile = talloc_strdup(ctdb, logfile);\n \tif (ctdb->logfile != NULL && strcmp(logfile, \"-\") != 0) {\n \t\tint fd;\n-\t\tclose(1);\n-\t\tclose(2);\n \t\tfd = open(ctdb->logfile, O_WRONLY|O_APPEND|O_CREAT, 0666);\n \t\tif (fd == -1) {\n+\t\t\tprintf(\"Failed to open logfile %s\\n\", ctdb->logfile);\n \t\t\tabort();\n \t\t}\n+\t\tclose(1);\n+\t\tclose(2);\n \t\tif (fd != 1) {\n \t\t\tdup2(fd, 1);\n \t\t\tclose(fd);\n\n=== modified file 'config/ctdb.init'\n--- a/config/ctdb.init\t2007-06-03 07:53:26 +0000\n+++ b/config/ctdb.init\t2007-06-03 09:24:52 +0000\n@@ -66,8 +66,11 @@\n \n if [ -x /sbin/startproc ]; then\n     init_style=\"suse\"\n-else \n-    init_style=\"redhat\"\n+else if [ -x /sbin/start-stop-daemon ]; then\n+\tinit_style=\"ubuntu\"\n+    else\n+\tinit_style=\"redhat\"\n+    fi\n fi\n \n start() {\n@@ -85,6 +88,10 @@\n \t\t[ $RETVAL -eq 0 ] && touch /var/lock/subsys/ctdb || RETVAL=1\n \t\treturn $RETVAL\n \t\t;;\n+\t    ubuntu)\n+\t\tstart-stop-daemon --start --quiet --background --exec /usr/sbin/ctdbd -- $CTDB_OPTIONS\n+\t\treturn $?\n+\t\t;;\n \tesac\n }\t\n \n\n=== modified file 'tools/ctdb_control.c'\n--- a/tools/ctdb_control.c\t2007-05-31 03:50:53 +0000\n+++ b/tools/ctdb_control.c\t2007-06-03 09:50:51 +0000\n@@ -32,6 +32,7 @@\n static struct {\n \tint timelimit;\n \tuint32_t vnn;\n+\tint machinereadable;\n } options;\n \n #define TIMELIMIT() timeval_current_ofs(options.timelimit, 0)\n@@ -288,6 +289,15 @@\n \t\treturn ret;\n \t}\n \n+\tif(options.machinereadable){\n+\t\tprintf(\":Node:Status:\\n\");\n+\t\tfor(i=0;inum;i++){\n+\t\t\tprintf(\":%d:%d:\\n\", nodemap->nodes[i].vnn,\n+\t\t\t\t!!nodemap->nodes[i].flags&NODE_FLAGS_CONNECTED);\n+\t\t}\n+\t\treturn 0;\n+\t}\n+\n \tprintf(\"Number of nodes:%d\\n\", nodemap->num);\n \tfor(i=0;inum;i++){\n \t\tprintf(\"vnn:%d %s%s\\n\", nodemap->nodes[i].vnn,\n@@ -723,6 +733,7 @@\n \"Usage: ctdb [options] \\n\" \\\n \"Options:\\n\" \\\n \"   -n           choose node number, or 'all' (defaults to local node)\\n\"\n+\"   -Y                 generate machinereadable output\\n\"\n \"   -t      set timelimit for control in seconds (default %u)\\n\", options.timelimit);\n \tprintf(\"Controls:\\n\");\n \tfor (i=0;i<ARRAY_SIZE(ctdb_commands);i++) {\n@@ -747,6 +758,7 @@\n \t\tPOPT_CTDB_CMDLINE\n \t\t{ \"timelimit\", 't', POPT_ARG_INT, &options.timelimit, 0, \"timelimit\", \"integer\" },\n \t\t{ \"node\",      'n', POPT_ARG_STRING, &nodestring, 0, \"node\", \"integer|all\" },\n+\t\t{ \"machinereadable\", 'Y', POPT_ARG_NONE, &options.machinereadable, 0, \"enable machinereadable output\", NULL },\n \t\tPOPT_TABLEEND\n \t};\n \tint opt;\n\n"}