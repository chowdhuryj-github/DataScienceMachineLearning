{"category": "ham", "to_address": "samba-cvs@samba.org", "from_address": "tridge@samba.org", "subject": "Rev 492: get all the tunables at once in recovery daemon in\n\thttp://samba.org/~tridge/ctdb", "body": "------------------------------------------------------------\nrevno: 492\nrevision-id: tridge@samba.org-20070607080525-14g625qx3h5rvs40\nparent: tridge@samba.org-20070607064831-cs6ed30jggx07qp9\ncommitter: Andrew Tridgell \nbranch nick: tridge\ntimestamp: Thu 2007-06-07 18:05:25 +1000\nmessage:\n  get all the tunables at once in recovery daemon\nmodified:\n  common/ctdb_client.c           ctdb_client.c-20070411010216-3kd8v37k61steeya-1\n  common/ctdb_control.c          ctdb_control.c-20070426122724-j6gkpiofhbwdin63-1\n  common/ctdb_recoverd.c         recoverd.c-20070503213540-bvxuyd9jm1f7ig90-1\n  include/ctdb_private.h         ctdb_private.h-20061117234101-o3qt14umlg9en8z0-13\n=== modified file 'common/ctdb_client.c'\n--- a/common/ctdb_client.c\t2007-06-07 05:18:55 +0000\n+++ b/common/ctdb_client.c\t2007-06-07 08:05:25 +0000\n@@ -1946,3 +1946,33 @@\n \treturn 0;\n }\n \n+\n+/*\n+  get all tunables\n+ */\n+int ctdb_ctrl_get_all_tunables(struct ctdb_context *ctdb, \n+\t\t\t       struct timeval timeout, \n+\t\t\t       uint32_t destnode,\n+\t\t\t       struct ctdb_tunable *tunables)\n+{\n+\tTDB_DATA outdata;\n+\tint ret;\n+\tint32_t res;\n+\n+\tret = ctdb_control(ctdb, destnode, 0, CTDB_CONTROL_GET_ALL_TUNABLES, 0, tdb_null, ctdb,\n+\t\t\t   &outdata, &res, &timeout, NULL);\n+\tif (ret != 0 || res != 0) {\n+\t\tDEBUG(0,(__location__ \" ctdb_control for get all tunables failed\\n\"));\n+\t\treturn -1;\n+\t}\n+\n+\tif (outdata.dsize != sizeof(*tunables)) {\n+\t\tDEBUG(0,(__location__ \" bad data size %u in ctdb_ctrl_get_all_tunables should be %u\\n\",\n+\t\t\t outdata.dsize, sizeof(*tunables)));\n+\t\treturn -1;\t\t\n+\t}\n+\n+\t*tunables = *(struct ctdb_tunable *)outdata.dptr;\n+\ttalloc_free(outdata.dptr);\n+\treturn 0;\n+}\n\n=== modified file 'common/ctdb_control.c'\n--- a/common/ctdb_control.c\t2007-06-07 05:18:55 +0000\n+++ b/common/ctdb_control.c\t2007-06-07 08:05:25 +0000\n@@ -80,6 +80,13 @@\n \t\treturn 0;\n \t}\n \n+\tcase CTDB_CONTROL_GET_ALL_TUNABLES: {\n+\t\tCHECK_CONTROL_DATA_SIZE(0);\n+\t\toutdata->dptr = (uint8_t *)&ctdb->tunable;\n+\t\toutdata->dsize = sizeof(ctdb->tunable);\n+\t\treturn 0;\n+\t}\n+\n \tcase CTDB_CONTROL_DUMP_MEMORY: {\n \t\tCHECK_CONTROL_DATA_SIZE(0);\n \t\ttalloc_report_full(ctdb, stdout);\n\n=== modified file 'common/ctdb_recoverd.c'\n--- a/common/ctdb_recoverd.c\t2007-06-07 06:48:31 +0000\n+++ b/common/ctdb_recoverd.c\t2007-06-07 08:05:25 +0000\n@@ -1031,18 +1031,11 @@\n \tctdb_wait_timeout(ctdb, ctdb->tunable.recover_interval);\n \n \t/* get relevant tunables */\n-\tctdb_ctrl_get_tunable(ctdb, CONTROL_TIMEOUT(), CTDB_CURRENT_NODE, \n-\t\t\t      \"RecoverTimeout\", &ctdb->tunable.recover_timeout);\n-\tctdb_ctrl_get_tunable(ctdb, CONTROL_TIMEOUT(), CTDB_CURRENT_NODE, \n-\t\t\t      \"RecoverInterval\", &ctdb->tunable.recover_interval);\n-\tctdb_ctrl_get_tunable(ctdb, CONTROL_TIMEOUT(), CTDB_CURRENT_NODE, \n-\t\t\t      \"ElectionTimeout\", &ctdb->tunable.election_timeout);\n-\tctdb_ctrl_get_tunable(ctdb, CONTROL_TIMEOUT(), CTDB_CURRENT_NODE, \n-\t\t\t      \"TakeoverTimeout\", &ctdb->tunable.takeover_timeout);\n-\tctdb_ctrl_get_tunable(ctdb, CONTROL_TIMEOUT(), CTDB_CURRENT_NODE, \n-\t\t\t      \"RecoveryGracePeriod\", &ctdb->tunable.recovery_grace_period);\n-\tctdb_ctrl_get_tunable(ctdb, CONTROL_TIMEOUT(), CTDB_CURRENT_NODE, \n-\t\t\t      \"RecoveryBanPeriod\", &ctdb->tunable.recovery_ban_period);\n+\tret = ctdb_ctrl_get_all_tunables(ctdb, CONTROL_TIMEOUT(), CTDB_CURRENT_NODE, &ctdb->tunable);\n+\tif (ret != 0) {\n+\t\tDEBUG(0,(\"Failed to get tunables - retrying\\n\"));\n+\t\tgoto again;\n+\t}\n \n \tvnn = ctdb_ctrl_getvnn(ctdb, CONTROL_TIMEOUT(), CTDB_CURRENT_NODE);\n \tif (vnn == (uint32_t)-1) {\n\n=== modified file 'include/ctdb_private.h'\n--- a/include/ctdb_private.h\t2007-06-07 06:34:33 +0000\n+++ b/include/ctdb_private.h\t2007-06-07 08:05:25 +0000\n@@ -419,6 +419,7 @@\n \t\t    CTDB_CONTROL_LIST_TUNABLES           = 50,\n \t\t    CTDB_CONTROL_GET_PUBLIC_IPS          = 51,\n \t\t    CTDB_CONTROL_MODIFY_FLAGS            = 52,\n+\t\t    CTDB_CONTROL_GET_ALL_TUNABLES        = 53,\n };\n \n /*\n@@ -1032,4 +1033,9 @@\n \n int32_t ctdb_control_modflags(struct ctdb_context *ctdb, TDB_DATA indata);\n \n+int ctdb_ctrl_get_all_tunables(struct ctdb_context *ctdb, \n+\t\t\t       struct timeval timeout, \n+\t\t\t       uint32_t destnode,\n+\t\t\t       struct ctdb_tunable *tunables);\n+\n #endif\n\n"}