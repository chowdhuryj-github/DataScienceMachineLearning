{"category": "ham", "to_address": "samba-cvs@samba.org", "from_address": "vlendec@samba.org", "subject": "svn commit: samba r23172 - in branches: SAMBA_3_0/source/smbd\n\tSAMBA_3_0_26/source/smbd", "body": "Author: vlendec\nDate: 2007-05-28 12:39:39 +0000 (Mon, 28 May 2007)\nNew Revision: 23172\n\nWebSVN: http://websvn.samba.org/cgi-bin/viewcvs.cgi?view=rev&root=samba&rev=23172\n\nLog:\nChange shutdown_other_smbds to use connections_traverse instead of\nsession_traverse.\n\nModified:\n   branches/SAMBA_3_0/source/smbd/session.c\n   branches/SAMBA_3_0/source/smbd/sesssetup.c\n   branches/SAMBA_3_0_26/source/smbd/session.c\n   branches/SAMBA_3_0_26/source/smbd/sesssetup.c\n\n\nChangeset:\nModified: branches/SAMBA_3_0/source/smbd/session.c\n===================================================================\n--- branches/SAMBA_3_0/source/smbd/session.c\t2007-05-28 11:38:42 UTC (rev 23171)\n+++ branches/SAMBA_3_0/source/smbd/session.c\t2007-05-28 12:39:39 UTC (rev 23172)\n@@ -202,8 +202,9 @@\n /********************************************************************\n ********************************************************************/\n \n-BOOL session_traverse(int (*fn)(TDB_CONTEXT *, TDB_DATA, TDB_DATA, void *),\n-\t\t      void *state)\n+static BOOL session_traverse(int (*fn)(TDB_CONTEXT *, TDB_DATA, TDB_DATA,\n+\t\t\t\t       void *),\n+\t\t\t     void *state)\n {\n \tif (!session_init()) {\n \t\tDEBUG(3, (\"No tdb opened\\n\"));\n\nModified: branches/SAMBA_3_0/source/smbd/sesssetup.c\n===================================================================\n--- branches/SAMBA_3_0/source/smbd/sesssetup.c\t2007-05-28 11:38:42 UTC (rev 23171)\n+++ branches/SAMBA_3_0/source/smbd/sesssetup.c\t2007-05-28 12:39:39 UTC (rev 23172)\n@@ -1174,25 +1174,26 @@\n  a new session setup with VC==0 is ignored.\n ****************************************************************************/\n \n-static int shutdown_other_smbds(TDB_CONTEXT *tdb, TDB_DATA kbuf, TDB_DATA dbuf,\n-\t\t\t\tvoid *p)\n+static int shutdown_other_smbds(struct db_record *rec,\n+\t\t\t\tconst struct connections_key *key,\n+\t\t\t\tconst struct connections_data *crec,\n+\t\t\t\tvoid *private_data)\n {\n-\tstruct sessionid *sessionid = (struct sessionid *)dbuf.dptr;\n-\tconst char *ip = (const char *)p;\n+\tconst char *ip = (const char *)private_data;\n \n-\tif (!process_exists(sessionid->pid)) {\n+\tif (!process_exists(crec->pid)) {\n \t\treturn 0;\n \t}\n \n-\tif (procid_is_me(&sessionid->pid)) {\n+\tif (procid_is_me(&crec->pid)) {\n \t\treturn 0;\n \t}\n \n-\tif (strcmp(ip, sessionid->ip_addr) != 0) {\n+\tif (strcmp(ip, crec->addr) != 0) {\n \t\treturn 0;\n \t}\n \n-\tmessaging_send(smbd_messaging_context(), sessionid->pid, MSG_SHUTDOWN,\n+\tmessaging_send(smbd_messaging_context(), crec->pid, MSG_SHUTDOWN,\n \t\t       &data_blob_null);\n \treturn 0;\n }\n@@ -1205,7 +1206,7 @@\n \tinvalidate_all_vuids();\n #endif\n \tif (lp_reset_on_zero_vc()) {\n-\t\tsession_traverse(shutdown_other_smbds, client_addr());\n+\t\tconnections_forall(shutdown_other_smbds, client_addr());\n \t}\n }\n \n\nModified: branches/SAMBA_3_0_26/source/smbd/session.c\n===================================================================\n--- branches/SAMBA_3_0_26/source/smbd/session.c\t2007-05-28 11:38:42 UTC (rev 23171)\n+++ branches/SAMBA_3_0_26/source/smbd/session.c\t2007-05-28 12:39:39 UTC (rev 23172)\n@@ -202,8 +202,9 @@\n /********************************************************************\n ********************************************************************/\n \n-BOOL session_traverse(int (*fn)(TDB_CONTEXT *, TDB_DATA, TDB_DATA, void *),\n-\t\t      void *state)\n+static BOOL session_traverse(int (*fn)(TDB_CONTEXT *, TDB_DATA, TDB_DATA,\n+\t\t\t\t       void *),\n+\t\t\t     void *state)\n {\n \tif (!session_init()) {\n \t\tDEBUG(3, (\"No tdb opened\\n\"));\n\nModified: branches/SAMBA_3_0_26/source/smbd/sesssetup.c\n===================================================================\n--- branches/SAMBA_3_0_26/source/smbd/sesssetup.c\t2007-05-28 11:38:42 UTC (rev 23171)\n+++ branches/SAMBA_3_0_26/source/smbd/sesssetup.c\t2007-05-28 12:39:39 UTC (rev 23172)\n@@ -1172,25 +1172,26 @@\n  a new session setup with VC==0 is ignored.\n ****************************************************************************/\n \n-static int shutdown_other_smbds(TDB_CONTEXT *tdb, TDB_DATA kbuf, TDB_DATA dbuf,\n-\t\t\t\tvoid *p)\n+static int shutdown_other_smbds(struct db_record *rec,\n+\t\t\t\tconst struct connections_key *key,\n+\t\t\t\tconst struct connections_data *crec,\n+\t\t\t\tvoid *private_data)\n {\n-\tstruct sessionid *sessionid = (struct sessionid *)dbuf.dptr;\n-\tconst char *ip = (const char *)p;\n+\tconst char *ip = (const char *)private_data;\n \n-\tif (!process_exists(sessionid->pid)) {\n+\tif (!process_exists(crec->pid)) {\n \t\treturn 0;\n \t}\n \n-\tif (procid_is_me(&sessionid->pid)) {\n+\tif (procid_is_me(&crec->pid)) {\n \t\treturn 0;\n \t}\n \n-\tif (strcmp(ip, sessionid->ip_addr) != 0) {\n+\tif (strcmp(ip, crec->addr) != 0) {\n \t\treturn 0;\n \t}\n \n-\tmessaging_send(smbd_messaging_context(), sessionid->pid, MSG_SHUTDOWN,\n+\tmessaging_send(smbd_messaging_context(), crec->pid, MSG_SHUTDOWN,\n \t\t       &data_blob_null);\n \treturn 0;\n }\n@@ -1203,7 +1204,7 @@\n \tinvalidate_all_vuids();\n #endif\n \tif (lp_reset_on_zero_vc()) {\n-\t\tsession_traverse(shutdown_other_smbds, client_addr());\n+\t\tconnections_forall(shutdown_other_smbds, client_addr());\n \t}\n }\n \n\n"}