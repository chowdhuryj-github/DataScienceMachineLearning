{"category": "ham", "to_address": "samba-cvs@samba.org", "from_address": "gd@samba.org", "subject": "svn commit: samba r23582 - in branches: SAMBA_3_0/source/include\n\tSAMBA_3_0/source/libsmb SAMBA_3_0_25/source/include\n\tSAMBA_3_0_25/source/libsmb SAMBA_3_0_26/source/include\n\tSAMBA_3_0_26/source/libsmb", "body": "Author: gd\nDate: 2007-06-22 11:20:37 +0000 (Fri, 22 Jun 2007)\nNew Revision: 23582\n\nWebSVN: http://websvn.samba.org/cgi-bin/viewcvs.cgi?view=rev&root=samba&rev=23582\n\nLog:\nFix event based krb5 ticket refreshing in winbindd.\n\nWe were incorrectly using the renew_till timestamp instead of the renewed\nticket's endtime to calculate the next refreshing date.\n\nGuenther\n\nModified:\n   branches/SAMBA_3_0/source/include/includes.h\n   branches/SAMBA_3_0/source/libsmb/clikrb5.c\n   branches/SAMBA_3_0_25/source/include/includes.h\n   branches/SAMBA_3_0_25/source/libsmb/clikrb5.c\n   branches/SAMBA_3_0_26/source/include/includes.h\n   branches/SAMBA_3_0_26/source/libsmb/clikrb5.c\n\n\nChangeset:\nModified: branches/SAMBA_3_0/source/include/includes.h\n===================================================================\n--- branches/SAMBA_3_0/source/include/includes.h\t2007-06-22 11:03:48 UTC (rev 23581)\n+++ branches/SAMBA_3_0/source/include/includes.h\t2007-06-22 11:20:37 UTC (rev 23582)\n@@ -1184,7 +1184,7 @@\n int cli_krb5_get_ticket(const char *principal, time_t time_offset, \n \t\t\tDATA_BLOB *ticket, DATA_BLOB *session_key_krb5, uint32 extra_ap_opts, const char *ccname, time_t *tgs_expire);\n PAC_LOGON_INFO *get_logon_info_from_pac(PAC_DATA *pac_data);\n-krb5_error_code smb_krb5_renew_ticket(const char *ccache_string, const char *client_string, const char *service_string, time_t *new_start_time);\n+krb5_error_code smb_krb5_renew_ticket(const char *ccache_string, const char *client_string, const char *service_string, time_t *expire_time);\n krb5_error_code kpasswd_err_to_krb5_err(krb5_error_code res_code);\n krb5_error_code smb_krb5_gen_netbios_krb5_address(smb_krb5_addresses **kerb_addr);\n krb5_error_code smb_krb5_free_addresses(krb5_context context, smb_krb5_addresses *addr);\n\nModified: branches/SAMBA_3_0/source/libsmb/clikrb5.c\n===================================================================\n--- branches/SAMBA_3_0/source/libsmb/clikrb5.c\t2007-06-22 11:03:48 UTC (rev 23581)\n+++ branches/SAMBA_3_0/source/libsmb/clikrb5.c\t2007-06-22 11:20:37 UTC (rev 23582)\n@@ -1134,7 +1134,7 @@\n  krb5_error_code smb_krb5_renew_ticket(const char *ccache_string,\t/* FILE:/tmp/krb5cc_0 */\n \t\t\t\t       const char *client_string,\t/* gd@BER.SUSE.DE */\n \t\t\t\t       const char *service_string,\t/* krbtgt/BER.SUSE.DE@BER.SUSE.DE */\n-\t\t\t\t       time_t *new_start_time)\n+\t\t\t\t       time_t *expire_time)\n {\n \tkrb5_error_code ret;\n \tkrb5_context context = NULL;\n@@ -1189,8 +1189,8 @@\n \t\n \t\tret = krb5_cc_store_cred(context, ccache, &creds);\n \n-\t\tif (new_start_time) {\n-\t\t\t*new_start_time = (time_t) creds.times.renew_till;\n+\t\tif (expire_time) {\n+\t\t\t*expire_time = (time_t) creds.times.endtime;\n \t\t}\n \n \t\tkrb5_free_cred_contents(context, &creds);\n@@ -1247,8 +1247,8 @@\n \t\n \t\tret = krb5_cc_store_cred(context, ccache, creds);\n \n-\t\tif (new_start_time) {\n-\t\t\t*new_start_time = (time_t) creds->times.renew_till;\n+\t\tif (expire_time) {\n+\t\t\t*expire_time = (time_t) creds->times.endtime;\n \t\t}\n \t\t\t\t\t\t\n \t\tkrb5_free_cred_contents(context, &creds_in);\n\nModified: branches/SAMBA_3_0_25/source/include/includes.h\n===================================================================\n--- branches/SAMBA_3_0_25/source/include/includes.h\t2007-06-22 11:03:48 UTC (rev 23581)\n+++ branches/SAMBA_3_0_25/source/include/includes.h\t2007-06-22 11:20:37 UTC (rev 23582)\n@@ -1182,7 +1182,7 @@\n int cli_krb5_get_ticket(const char *principal, time_t time_offset, \n \t\t\tDATA_BLOB *ticket, DATA_BLOB *session_key_krb5, uint32 extra_ap_opts, const char *ccname, time_t *tgs_expire);\n PAC_LOGON_INFO *get_logon_info_from_pac(PAC_DATA *pac_data);\n-krb5_error_code smb_krb5_renew_ticket(const char *ccache_string, const char *client_string, const char *service_string, time_t *new_start_time);\n+krb5_error_code smb_krb5_renew_ticket(const char *ccache_string, const char *client_string, const char *service_string, time_t *expire_time);\n krb5_error_code kpasswd_err_to_krb5_err(krb5_error_code res_code);\n krb5_error_code smb_krb5_gen_netbios_krb5_address(smb_krb5_addresses **kerb_addr);\n krb5_error_code smb_krb5_free_addresses(krb5_context context, smb_krb5_addresses *addr);\n\nModified: branches/SAMBA_3_0_25/source/libsmb/clikrb5.c\n===================================================================\n--- branches/SAMBA_3_0_25/source/libsmb/clikrb5.c\t2007-06-22 11:03:48 UTC (rev 23581)\n+++ branches/SAMBA_3_0_25/source/libsmb/clikrb5.c\t2007-06-22 11:20:37 UTC (rev 23582)\n@@ -1095,7 +1095,7 @@\n  krb5_error_code smb_krb5_renew_ticket(const char *ccache_string,\t/* FILE:/tmp/krb5cc_0 */\n \t\t\t\t       const char *client_string,\t/* gd@BER.SUSE.DE */\n \t\t\t\t       const char *service_string,\t/* krbtgt/BER.SUSE.DE@BER.SUSE.DE */\n-\t\t\t\t       time_t *new_start_time)\n+\t\t\t\t       time_t *expire_time)\n {\n \tkrb5_error_code ret;\n \tkrb5_context context = NULL;\n@@ -1150,8 +1150,8 @@\n \t\n \t\tret = krb5_cc_store_cred(context, ccache, &creds);\n \n-\t\tif (new_start_time) {\n-\t\t\t*new_start_time = (time_t) creds.times.renew_till;\n+\t\tif (expire_time) {\n+\t\t\t*expire_time = (time_t) creds.times.endtime;\n \t\t}\n \n \t\tkrb5_free_cred_contents(context, &creds);\n@@ -1208,8 +1208,8 @@\n \t\n \t\tret = krb5_cc_store_cred(context, ccache, creds);\n \n-\t\tif (new_start_time) {\n-\t\t\t*new_start_time = (time_t) creds->times.renew_till;\n+\t\tif (expire_time) {\n+\t\t\t*expire_time = (time_t) creds->times.endtime;\n \t\t}\n \t\t\t\t\t\t\n \t\tkrb5_free_cred_contents(context, &creds_in);\n\nModified: branches/SAMBA_3_0_26/source/include/includes.h\n===================================================================\n--- branches/SAMBA_3_0_26/source/include/includes.h\t2007-06-22 11:03:48 UTC (rev 23581)\n+++ branches/SAMBA_3_0_26/source/include/includes.h\t2007-06-22 11:20:37 UTC (rev 23582)\n@@ -1188,7 +1188,7 @@\n int cli_krb5_get_ticket(const char *principal, time_t time_offset, \n \t\t\tDATA_BLOB *ticket, DATA_BLOB *session_key_krb5, uint32 extra_ap_opts, const char *ccname, time_t *tgs_expire);\n PAC_LOGON_INFO *get_logon_info_from_pac(PAC_DATA *pac_data);\n-krb5_error_code smb_krb5_renew_ticket(const char *ccache_string, const char *client_string, const char *service_string, time_t *new_start_time);\n+krb5_error_code smb_krb5_renew_ticket(const char *ccache_string, const char *client_string, const char *service_string, time_t *expire_time);\n krb5_error_code kpasswd_err_to_krb5_err(krb5_error_code res_code);\n krb5_error_code smb_krb5_gen_netbios_krb5_address(smb_krb5_addresses **kerb_addr);\n krb5_error_code smb_krb5_free_addresses(krb5_context context, smb_krb5_addresses *addr);\n\nModified: branches/SAMBA_3_0_26/source/libsmb/clikrb5.c\n===================================================================\n--- branches/SAMBA_3_0_26/source/libsmb/clikrb5.c\t2007-06-22 11:03:48 UTC (rev 23581)\n+++ branches/SAMBA_3_0_26/source/libsmb/clikrb5.c\t2007-06-22 11:20:37 UTC (rev 23582)\n@@ -1134,7 +1134,7 @@\n  krb5_error_code smb_krb5_renew_ticket(const char *ccache_string,\t/* FILE:/tmp/krb5cc_0 */\n \t\t\t\t       const char *client_string,\t/* gd@BER.SUSE.DE */\n \t\t\t\t       const char *service_string,\t/* krbtgt/BER.SUSE.DE@BER.SUSE.DE */\n-\t\t\t\t       time_t *new_start_time)\n+\t\t\t\t       time_t *expire_time)\n {\n \tkrb5_error_code ret;\n \tkrb5_context context = NULL;\n@@ -1189,8 +1189,8 @@\n \t\n \t\tret = krb5_cc_store_cred(context, ccache, &creds);\n \n-\t\tif (new_start_time) {\n-\t\t\t*new_start_time = (time_t) creds.times.renew_till;\n+\t\tif (expire_time) {\n+\t\t\t*expire_time = (time_t) creds.times.endtime;\n \t\t}\n \n \t\tkrb5_free_cred_contents(context, &creds);\n@@ -1247,8 +1247,8 @@\n \t\n \t\tret = krb5_cc_store_cred(context, ccache, creds);\n \n-\t\tif (new_start_time) {\n-\t\t\t*new_start_time = (time_t) creds->times.renew_till;\n+\t\tif (expire_time) {\n+\t\t\t*expire_time = (time_t) creds->times.endtime;\n \t\t}\n \t\t\t\t\t\t\n \t\tkrb5_free_cred_contents(context, &creds_in);\n\n"}