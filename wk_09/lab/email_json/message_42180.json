{"category": "ham", "to_address": "samba-cvs@samba.org", "from_address": "metze@samba.org", "subject": "svn commit: samba r23338 - in\n\tbranches/SAMBA_3_0_26/source/lib/ldb/ldb_tdb: .", "body": "Author: metze\nDate: 2007-06-04 14:26:07 +0000 (Mon, 04 Jun 2007)\nNew Revision: 23338\n\nWebSVN: http://websvn.samba.org/cgi-bin/viewcvs.cgi?view=rev&root=samba&rev=23338\n\nLog:\nmerge from SAMBA_3_0:\n\nfix a crash bug...I wonder why only HP-UX 11.00 ans 11.11 noticed\nit via a SIGBUS...\n\nI missed to remove the samba3 specifc code path to tdb_open_ex()\nwhen I synced lib/tdb/ with samba4. The explicit cast in on tdb_open_ex()\ndropped the compiler warning :-(\n\nmetze\nModified:\n   branches/SAMBA_3_0_26/source/lib/ldb/ldb_tdb/ldb_tdb_wrap.c\n\n\nChangeset:\nModified: branches/SAMBA_3_0_26/source/lib/ldb/ldb_tdb/ldb_tdb_wrap.c\n===================================================================\n--- branches/SAMBA_3_0_26/source/lib/ldb/ldb_tdb/ldb_tdb_wrap.c\t2007-06-04 14:25:52 UTC (rev 23337)\n+++ branches/SAMBA_3_0_26/source/lib/ldb/ldb_tdb/ldb_tdb_wrap.c\t2007-06-04 14:26:07 UTC (rev 23338)\n@@ -58,27 +58,11 @@\n \treturn 0;\n }\t\t\t\t \n \n-#if defined(_SAMBA_BUILD_) && (_SAMBA_BUILD_ <= 3)\n static void ltdb_log_fn(struct tdb_context *tdb, enum tdb_debug_level level, const char *fmt, ...) PRINTF_ATTRIBUTE(3, 4);\n static void ltdb_log_fn(struct tdb_context *tdb, enum tdb_debug_level level, const char *fmt, ...)\n {\n-\t/* until we merge the tdb debug changes into samba3, we don't know \n-\t   how serious the error is, and we can't go via the ldb loggin code */\n \tva_list ap;\n \tconst char *name = tdb_name(tdb);\n-\tchar *message; \n-\tva_start(ap, fmt);\n-\tmessage = talloc_vasprintf(NULL, fmt, ap);\n-\tva_end(ap);\n-\tDEBUG(3, (\"ltdb: tdb(%s): %s\", name, message));\n-\ttalloc_free(message);\n-}\n-#else\n-static void ltdb_log_fn(struct tdb_context *tdb, enum tdb_debug_level level, const char *fmt, ...) PRINTF_ATTRIBUTE(3, 4);\n-static void ltdb_log_fn(struct tdb_context *tdb, enum tdb_debug_level level, const char *fmt, ...)\n-{\n-\tva_list ap;\n-\tconst char *name = tdb_name(tdb);\n \tstruct ldb_context *ldb = talloc_get_type(tdb_get_logging_private(tdb), struct ldb_context);\n \tenum ldb_debug_level ldb_level;\n \tchar *message; \n@@ -106,7 +90,6 @@\n \tldb_debug(ldb, ldb_level, \"ltdb: tdb(%s): %s\", name, message);\n \ttalloc_free(message);\n }\n-#endif\n \n /*\n   wrapped connection to a tdb database. The caller should _not_ free\n@@ -122,14 +105,10 @@\n {\n \tstruct ltdb_wrap *w;\n \tstruct stat st;\n-#if defined(_SAMBA_BUILD_) && (_SAMBA_BUILD_ <= 3)\n-\ttdb_log_func log_ctx_p = ltdb_log_fn;\n-#else\n \tstruct tdb_logging_context log_ctx;\n-\tconst struct tdb_logging_context *log_ctx_p = &log_ctx;\n+\n \tlog_ctx.log_fn = ltdb_log_fn;\n \tlog_ctx.log_private = ldb;\n-#endif\n \n \tif (stat(path, &st) == 0) {\n \t\tfor (w=tdb_list;w;w=w->next) {\n@@ -147,9 +126,7 @@\n \t\treturn NULL;\n \t}\n \n-\tw->tdb = tdb_open_ex(path, hash_size, tdb_flags, open_flags, mode,\n-\t\t\t     (const struct tdb_logging_context *)log_ctx_p,\n-\t\t\t     NULL);\n+\tw->tdb = tdb_open_ex(path, hash_size, tdb_flags, open_flags, mode, &log_ctx, NULL);\n \tif (w->tdb == NULL) {\n \t\ttalloc_free(w);\n \t\treturn NULL;\n\n"}