{"category": "ham", "to_address": "samba-cvs@samba.org", "from_address": "metze@samba.org", "subject": "svn commit: samba r22486 - in branches/SAMBA_4_0/source: librpc/rpc\n\ttorture/rpc", "body": "Author: metze\nDate: 2007-04-23 12:31:12 +0000 (Mon, 23 Apr 2007)\nNew Revision: 22486\n\nWebSVN: http://websvn.samba.org/cgi-bin/viewcvs.cgi?view=rev&root=samba&rev=22486\n\nLog:\nadd a flag to ignore timeouts of a request and don't close\nthe connection on timeout\n\nmetze\nModified:\n   branches/SAMBA_4_0/source/librpc/rpc/dcerpc.c\n   branches/SAMBA_4_0/source/librpc/rpc/dcerpc.h\n   branches/SAMBA_4_0/source/torture/rpc/echo.c\n\n\nChangeset:\nModified: branches/SAMBA_4_0/source/librpc/rpc/dcerpc.c\n===================================================================\n--- branches/SAMBA_4_0/source/librpc/rpc/dcerpc.c\t2007-04-23 10:39:20 UTC (rev 22485)\n+++ branches/SAMBA_4_0/source/librpc/rpc/dcerpc.c\t2007-04-23 12:31:12 UTC (rev 22486)\n@@ -673,6 +673,17 @@\n \t\t\t\t   struct timeval t, void *private)\n {\n \tstruct rpc_request *req = talloc_get_type(private, struct rpc_request);\n+\n+\tif (req->ignore_timeout) {\n+\t\tdcerpc_req_dequeue(req);\n+\t\treq->state = RPC_REQUEST_DONE;\n+\t\treq->status = NT_STATUS_IO_TIMEOUT;\n+\t\tif (req->async.callback) {\n+\t\t\treq->async.callback(req);\n+\t\t}\n+\t\treturn;\n+\t}\n+\n \tdcerpc_connection_dead(req->p->conn, NT_STATUS_IO_TIMEOUT);\n }\n \n@@ -945,6 +956,7 @@\n \treq->flags = 0;\n \treq->fault_code = 0;\n \treq->async_call = async;\n+\treq->ignore_timeout = False;\n \treq->async.callback = NULL;\n \treq->async.private = NULL;\n \treq->recv_handler = NULL;\n\nModified: branches/SAMBA_4_0/source/librpc/rpc/dcerpc.h\n===================================================================\n--- branches/SAMBA_4_0/source/librpc/rpc/dcerpc.h\t2007-04-23 10:39:20 UTC (rev 22485)\n+++ branches/SAMBA_4_0/source/librpc/rpc/dcerpc.h\t2007-04-23 12:31:12 UTC (rev 22486)\n@@ -246,6 +246,7 @@\n \tuint16_t opnum;\n \tDATA_BLOB request_data;\n \tBOOL async_call;\n+\tBOOL ignore_timeout;\n \n \t/* use by the ndr level async recv call */\n \tstruct {\n\nModified: branches/SAMBA_4_0/source/torture/rpc/echo.c\n===================================================================\n--- branches/SAMBA_4_0/source/torture/rpc/echo.c\t2007-04-23 10:39:20 UTC (rev 22485)\n+++ branches/SAMBA_4_0/source/torture/rpc/echo.c\t2007-04-23 12:31:12 UTC (rev 22486)\n@@ -388,8 +388,12 @@\n \tr.in.seconds = 2;\n \tp->request_timeout = 1;\n \n-\ttorture_assert(tctx, req = dcerpc_echo_TestSleep_send(p, tctx, &r), \n-\t\t\"Failed to send async sleep request\");\n+\treq = dcerpc_echo_TestSleep_send(p, tctx, &r);\n+\tif (!req) {\n+\t\ttorture_comment(tctx, \"Failed to send async sleep request\\n\");\n+\t\tgoto failed;\n+\t}\n+\treq->ignore_timeout = True;\n \n \tstatus\t= dcerpc_ndr_request_recv(req);\n \ttorture_assert_ntstatus_equal(tctx, status, NT_STATUS_IO_TIMEOUT, \n@@ -408,6 +412,7 @@\n \t\ttorture_comment(tctx, \"Failed to send async sleep request\\n\");\n \t\tgoto failed;\n \t}\n+\treq->ignore_timeout = True;\n \tstatus\t= dcerpc_ndr_request_recv(req);\n \ttorture_assert_ntstatus_equal(tctx, status, NT_STATUS_IO_TIMEOUT, \n \t\t\"request should have timed out\");\n\n"}