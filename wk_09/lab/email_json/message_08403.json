{"category": "ham", "to_address": "samba-cvs@samba.org", "from_address": "tridge@samba.org", "subject": "Rev 146: started adding a cleaner daemon finish method in\n\thttp://samba.org/~tridge/ctdb", "body": "------------------------------------------------------------\nrevno: 146\nrevision-id: tridge@samba.org-20070418015554-f1b0faceed62a64b\nparent: tridge@samba.org-20070418013316-60979fe73163efe3\ncommitter: Andrew Tridgell \nbranch nick: tridge\ntimestamp: Wed 2007-04-18 11:55:54 +1000\nmessage:\n  started adding a cleaner daemon finish method\nmodified:\n  common/ctdb.c                  ctdb.c-20061127094323-t50f58d65iaao5of-2\n  common/ctdb_client.c           ctdb_client.c-20070411010216-3kd8v37k61steeya-1\n  common/ctdb_daemon.c           ctdb_daemon.c-20070409200331-3el1kqgdb9m4ib0g-1\n  include/ctdb_private.h         ctdb_private.h-20061117234101-o3qt14umlg9en8z0-13\n  tests/ctdb_test.c              ctdb_test.c-20061117234101-o3qt14umlg9en8z0-16\n  tests/test.sh                  test.sh-20061128065333-cla80zaxd9eb4o4a-2\n=== modified file 'common/ctdb.c'\n--- a/common/ctdb.c\t2007-04-18 01:20:24 +0000\n+++ b/common/ctdb.c\t2007-04-18 01:55:54 +0000\n@@ -255,6 +255,10 @@\n \t\tctdb_request_message(ctdb, hdr);\n \t\tbreak;\n \n+\tcase CTDB_REQ_FINISHED:\n+\t\tctdb_request_finished(ctdb, hdr);\n+\t\tbreak;\n+\n \tdefault:\n \t\tDEBUG(0,(\"%s: Packet with unknown operation %d\\n\", \n \t\t\t __location__, hdr->operation));\n\n=== modified file 'common/ctdb_client.c'\n--- a/common/ctdb_client.c\t2007-04-18 01:20:24 +0000\n+++ b/common/ctdb_client.c\t2007-04-18 01:55:54 +0000\n@@ -434,6 +434,11 @@\n \tr.hdr.operation = CTDB_REQ_CONNECT_WAIT;\n \n \tDEBUG(3,(\"ctdb_connect_wait: sending to ctdbd\\n\"));\n+\n+\t/* if the domain socket is not yet open, open it */\n+\tif (ctdb->daemon.sd==-1) {\n+\t\tux_socket_connect(ctdb);\n+\t}\n \t\n \tres = ctdb_queue_send(ctdb->daemon.queue, (uint8_t *)&r.hdr, r.hdr.length);\n \tif (res != 0) {\n\n=== modified file 'common/ctdb_daemon.c'\n--- a/common/ctdb_daemon.c\t2007-04-18 01:33:16 +0000\n+++ b/common/ctdb_daemon.c\t2007-04-18 01:55:54 +0000\n@@ -611,3 +611,15 @@\n \treturn talloc_size(ctdb, size);\n }\n \n+/*\n+  called when a CTDB_REQ_FINISHED packet comes in\n+*/\n+void ctdb_request_finished(struct ctdb_context *ctdb, struct ctdb_req_header *hdr)\n+{\n+\tctdb->num_finished++;\n+\tif (ctdb->num_finished == ctdb->num_nodes) {\n+\t\t/* all daemons have requested to finish - we now exit */\n+\t\tDEBUG(1,(\"All daemons finished - exiting\\n\"));\n+\t\t_exit(0);\n+\t}\n+}\n\n=== modified file 'include/ctdb_private.h'\n--- a/include/ctdb_private.h\t2007-04-18 01:20:24 +0000\n+++ b/include/ctdb_private.h\t2007-04-18 01:55:54 +0000\n@@ -117,6 +117,7 @@\n \tuint32_t vnn; /* our own vnn */\n \tuint32_t num_nodes;\n \tuint32_t num_connected;\n+\tuint32_t num_finished;\n \tunsigned flags;\n \tstruct idr_context *idr;\n \tstruct ctdb_node **nodes; /* array of nodes in the cluster - indexed by vnn */\n@@ -213,6 +214,7 @@\n \tCTDB_REPLY_DMASTER      = 4,\n \tCTDB_REPLY_ERROR        = 5,\n \tCTDB_REQ_MESSAGE        = 6,\n+\tCTDB_REQ_FINISHED       = 7,\n \t\n \t/* only used on the domain socket */\n \tCTDB_REQ_REGISTER       = 1000,     \n@@ -294,6 +296,10 @@\n \tuint8_t data[1];\n };\n \n+struct ctdb_req_finished {\n+\tstruct ctdb_req_header hdr;\n+};\n+\n struct ctdb_req_connect_wait {\n \tstruct ctdb_req_header hdr;\n };\n\n=== modified file 'tests/ctdb_test.c'\n--- a/tests/ctdb_test.c\t2007-04-17 12:16:50 +0000\n+++ b/tests/ctdb_test.c\t2007-04-18 01:55:54 +0000\n@@ -133,6 +133,8 @@\n \t/* start the protocol running */\n \tret = ctdb_start(ctdb);\n \n+\tctdb_connect_wait(ctdb);\n+\n \tZERO_STRUCT(call);\n \tcall.key.dptr = discard_const(\"test\");\n \tcall.key.dsize = strlen(\"test\")+1;\n@@ -171,11 +173,6 @@\n \t/* go into a wait loop to allow other nodes to complete */\n \tctdb_wait_loop(ctdb);\n \n-\t/*talloc_report_full(ctdb, stdout);*/\n-\n-/* sleep for a while so that our daemon will remaining alive for the other nodes in the cluster */\n-sleep(10);\n-\n \t/* shut it down */\n \ttalloc_free(ctdb);\n \treturn 0;\n\n=== modified file 'tests/test.sh'\n--- a/tests/test.sh\t2007-04-17 05:01:42 +0000\n+++ b/tests/test.sh\t2007-04-18 01:55:54 +0000\n@@ -4,17 +4,17 @@\n \n \n echo \"Trying 2 nodes\"\n-bin/ctdb_test --nlist tests/nodes.txt --listen 127.0.0.1:9001 &\n-bin/ctdb_test --nlist tests/nodes.txt --listen 127.0.0.2:9001\n+$VALGRIND bin/ctdb_test --nlist tests/nodes.txt --listen 127.0.0.1:9001 &\n+$VALGRIND bin/ctdb_test --nlist tests/nodes.txt --listen 127.0.0.2:9001\n \n sleep 3\n killall ctdb_test\n \n echo \"Trying 4 nodes\"\n-bin/ctdb_test --nlist tests/4nodes.txt --listen 127.0.0.1:9001 &\n-bin/ctdb_test --nlist tests/4nodes.txt --listen 127.0.0.2:9001 &\n-bin/ctdb_test --nlist tests/4nodes.txt --listen 127.0.0.3:9001 &\n-bin/ctdb_test --nlist tests/4nodes.txt --listen 127.0.0.4:9001\n+$VALGRIND bin/ctdb_test --nlist tests/4nodes.txt --listen 127.0.0.1:9001 &\n+$VALGRIND bin/ctdb_test --nlist tests/4nodes.txt --listen 127.0.0.2:9001 &\n+$VALGRIND bin/ctdb_test --nlist tests/4nodes.txt --listen 127.0.0.3:9001 &\n+$VALGRIND bin/ctdb_test --nlist tests/4nodes.txt --listen 127.0.0.4:9001\n sleep 3\n \n killall ctdb_test\n\n"}