{"category": "ham", "to_address": "samba-cvs@samba.org", "from_address": "tridge@samba.org", "subject": "svn commit: samba r22988 - in\n\tbranches/SAMBA_4_0/source/lib/replace: .", "body": "Author: tridge\nDate: 2007-05-18 06:53:57 +0000 (Fri, 18 May 2007)\nNew Revision: 22988\n\nWebSVN: http://websvn.samba.org/cgi-bin/viewcvs.cgi?view=rev&root=samba&rev=22988\n\nLog:\n\nfixed 2 bugs in our unsetenv() replacement code\n\n 1) you must not free the memory, as it is possible the memory did not\n come from malloc (try it under valgrind to test)\n\n 2) the old code didn't cope with duplicate environment variables\n\nI hope this will fix some of the build farm errors on irix, and maybe solaris\n\nModified:\n   branches/SAMBA_4_0/source/lib/replace/replace.c\n\n\nChangeset:\nModified: branches/SAMBA_4_0/source/lib/replace/replace.c\n===================================================================\n--- branches/SAMBA_4_0/source/lib/replace/replace.c\t2007-05-18 05:47:33 UTC (rev 22987)\n+++ branches/SAMBA_4_0/source/lib/replace/replace.c\t2007-05-18 06:53:57 UTC (rev 22988)\n@@ -568,20 +568,24 @@\n {\n \textern char **environ;\n \tsize_t len = strlen(name);\n-\tsize_t i; \n-\tint found = 0;\n+\tsize_t i, count;\n \n-\tfor (i=0; (environ && environ[i]); i++) {\n-\t\tif (found) {\n-\t\t\tenviron[i-1] = environ[i];\n-\t\t\tcontinue;\n-\t\t}\n+\tif (environ == NULL || getenv(name) == NULL) {\n+\t\treturn 0;\n+\t}\n \n+\tfor (i=0;environ[i];i++) /* noop */ ;\n+\n+\tcount=i;\n+\t\n+\tfor (i=0;i<count;) {\n \t\tif (strncmp(environ[i], name, len) == 0 && environ[i][len] == '=') {\n-\t\t\tfree(environ[i]);\n-\t\t\tenviron[i] = NULL;\n-\t\t\tfound = 1;\n-\t\t\tcontinue;\n+\t\t\t/* note: we do _not_ free the old variable here. It is unsafe to \n+\t\t\t   do so, as the pointer may not have come from malloc */\n+\t\t\tmemmove(&environ[i], &environ[i+1], (count-i)*sizeof(char *));\n+\t\t\tcount--;\n+\t\t} else {\n+\t\t\ti++;\n \t\t}\n \t}\n \n\n"}