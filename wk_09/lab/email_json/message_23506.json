{"category": "ham", "to_address": "perl6-internals@perl.org", "from_address": "chromatic <chromatic@wgz.org>", "subject": "Re: [svn:parrot] r18414 - in trunk: lib/Parrot src", "body": "On Thursday 03 May 2007 18:04:48 chromatic wrote:\n\n> I'll debug the segfault and see if that reveals anything interesting.\n>\n> The shootout tests are dodgy anyway sometimes.\n\nIn this case, sorting the vtable functions put the init vtable method pointer \nin the middle of the _vtable struct, not at the start.  The i386 and sun4 JIT \noperations looked for init as the first vtable method to use it as an offset \ninto the struct.  You can guess what happens when you not only get the wrong \noffset for the vtable method pointer you want but also dereference way past \nthe end of the struct where you probably don't have a function pointer at \nall... KAPOW!\n\nHere's the fix (r18423), for fun:\n\n--- src/jit/sun4/jit_emit.h     (revision 3381)\n+++ src/jit/sun4/jit_emit.h     (local)\n@@ -849,7 +849,7 @@\n     int    idx, pi, i;\n     size_t offset;\n \n-    offset  = offsetof(VTABLE, init);\n+    offset  = offsetof(VTABLE, absolute);\n     offset += nvtable * sizeof (void *);\n \n     for (idx = 1; idx <= n; idx++) {\n\nI added some cleanup to the x86 file while I was tracing through it.\n\n-- c\n\n"}