{"category": "ham", "to_address": "samba-cvs@samba.org", "from_address": "tridge@samba.org", "subject": "Rev 264: fixed a problem with the number of timed events growing\n\twithout bound with the new seqnum code in\n\thttp://samba.org/~tridge/ctdb", "body": "------------------------------------------------------------\nrevno: 264\nrevision-id: tridge@samba.org-20070508111629-cgamk1fazmat0dog\nparent: tridge@samba.org-20070506215638-67wvsh0zwt7bbllo\ncommitter: Andrew Tridgell \nbranch nick: tridge\ntimestamp: Tue 2007-05-08 21:16:29 +1000\nmessage:\n  fixed a problem with the number of timed events growing without bound with the new seqnum code\nmodified:\n  common/ctdb_ltdb.c             ctdb_ltdb.c-20061128065342-to93h6eejj5kon81-2\n  include/ctdb_private.h         ctdb_private.h-20061117234101-o3qt14umlg9en8z0-13\n=== modified file 'common/ctdb_ltdb.c'\n--- a/common/ctdb_ltdb.c\t2007-05-05 07:35:28 +0000\n+++ b/common/ctdb_ltdb.c\t2007-05-08 11:16:29 +0000\n@@ -440,8 +440,9 @@\n \tctdb_db->seqnum = new_seqnum;\n \n \t/* setup a new timer */\n-\tevent_add_timed(ctdb->ev, ctdb_db, timeval_current_ofs(ctdb->seqnum_frequency, 0),\n-\t\t\tctdb_ltdb_seqnum_check, ctdb_db);\n+\tctdb_db->te = event_add_timed(ctdb->ev, ctdb_db, \n+\t\t\t\t      timeval_current_ofs(ctdb->seqnum_frequency, 0),\n+\t\t\t\t      ctdb_ltdb_seqnum_check, ctdb_db);\n }\n \n /*\n@@ -456,8 +457,11 @@\n \t\treturn -1;\n \t}\n \n-\tevent_add_timed(ctdb->ev, ctdb_db, timeval_current_ofs(ctdb->seqnum_frequency, 0),\n-\t\t\tctdb_ltdb_seqnum_check, ctdb_db);\n+\tif (ctdb_db->te == NULL) {\n+\t\tctdb_db->te = event_add_timed(ctdb->ev, ctdb_db, \n+\t\t\t\t\t      timeval_current_ofs(ctdb->seqnum_frequency, 0),\n+\t\t\t\t\t      ctdb_ltdb_seqnum_check, ctdb_db);\n+\t}\n \n \ttdb_enable_seqnum(ctdb_db->ltdb->tdb);\n \tctdb_db->seqnum = tdb_get_seqnum(ctdb_db->ltdb->tdb);\n\n=== modified file 'include/ctdb_private.h'\n--- a/include/ctdb_private.h\t2007-05-06 19:02:48 +0000\n+++ b/include/ctdb_private.h\t2007-05-08 11:16:29 +0000\n@@ -246,6 +246,7 @@\n \tstruct tdb_wrap *ltdb;\n \tstruct ctdb_registered_call *calls; /* list of registered calls */\n \tuint32_t seqnum;\n+\tstruct timed_event *te;\n };\n \n \n\n"}