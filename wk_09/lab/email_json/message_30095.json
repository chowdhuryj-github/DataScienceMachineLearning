{"category": "ham", "to_address": "samba-cvs@samba.org", "from_address": "tridge@samba.org", "subject": "Rev 307: enable TCP keepalives in http://samba.org/~tridge/ctdb", "body": "------------------------------------------------------------\nrevno: 307\nrevision-id: tridge@samba.org-20070515084056-6333fevxsd6cnlzz\nparent: tridge@samba.org-20070515051336-gkm61o3ruygf0u9n\ncommitter: Andrew Tridgell \nbranch nick: tridge\ntimestamp: Tue 2007-05-15 18:40:56 +1000\nmessage:\n  enable TCP keepalives\nmodified:\n  tcp/tcp_connect.c              tcp_connect.c-20061128004937-x70q1cu5xzg5g2tm-1\n=== modified file 'tcp/tcp_connect.c'\n--- a/tcp/tcp_connect.c\t2007-05-15 04:08:58 +0000\n+++ b/tcp/tcp_connect.c\t2007-05-15 08:40:56 +0000\n@@ -82,6 +82,7 @@\n \ttalloc_free(fde);\n \t\n         setsockopt(tnode->fd,IPPROTO_TCP,TCP_NODELAY,(char *)&one,sizeof(one));\n+        setsockopt(tnode->fd,SOL_SOCKET,SO_KEEPALIVE,(char *)&one,sizeof(one));\n \n \tctdb_queue_set_fd(tnode->queue, tnode->fd);\n \n@@ -180,6 +181,7 @@\n \tsocklen_t len;\n \tint fd;\n \tstruct ctdb_incoming *in;\n+\tint one = 1;\n \n \tctdb = talloc_get_type(private_data, struct ctdb_context);\n \tctcp = talloc_get_type(ctdb->private_data, struct ctdb_tcp);\n@@ -194,6 +196,8 @@\n \n \tset_nonblocking(in->fd);\n \n+        setsockopt(in->fd,SOL_SOCKET,SO_KEEPALIVE,(char *)&one,sizeof(one));\n+\n \tin->queue = ctdb_queue_setup(ctdb, in, in->fd, CTDB_TCP_ALIGNMENT, \n \t\t\t\t     ctdb_tcp_read_cb, in);\n }\n\n"}