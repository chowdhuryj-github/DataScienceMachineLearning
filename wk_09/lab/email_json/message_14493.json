{"category": "ham", "to_address": "samba-cvs@samba.org", "from_address": "jmcd@samba.org", "subject": "svn commit: samba r22504 - in branches: SAMBA_3_0/source/rpc_server\n\tSAMBA_3_0_25/source/rpc_server", "body": "Author: jmcd\nDate: 2007-04-24 15:56:02 +0000 (Tue, 24 Apr 2007)\nNew Revision: 22504\n\nWebSVN: http://websvn.samba.org/cgi-bin/viewcvs.cgi?view=rev&root=samba&rev=22504\n\nLog:\nFix bug Jerry found during his tutorial.  Sorry :-(\n\nAllows authorized users (e.g. BUILTIN\\Administrators members) to\nset attributes on an account, particularly \"user cannot change \npassword\".\n\nadd become_root() around updating attributes, after checking that\naccess has been granted.  \n\nModified:\n   branches/SAMBA_3_0/source/rpc_server/srv_samr_nt.c\n   branches/SAMBA_3_0_25/source/rpc_server/srv_samr_nt.c\n\n\nChangeset:\nModified: branches/SAMBA_3_0/source/rpc_server/srv_samr_nt.c\n===================================================================\n--- branches/SAMBA_3_0/source/rpc_server/srv_samr_nt.c\t2007-04-24 13:55:04 UTC (rev 22503)\n+++ branches/SAMBA_3_0/source/rpc_server/srv_samr_nt.c\t2007-04-24 15:56:02 UTC (rev 22504)\n@@ -724,7 +724,12 @@\n \t\treturn NT_STATUS_ACCESS_DENIED;\n \t}\n \n-\tstatus = pdb_update_sam_account(sampass);\n+\tstatus = access_check_samr_function(acc_granted, SA_RIGHT_USER_SET_ATTRIBUTES, \"_samr_set_sec_obj\");\n+\tif NT_STATUS_IS_OK(status) {\n+\t\tbecome_root();\n+\t\tstatus = pdb_update_sam_account(sampass);\n+\t\tunbecome_root();\n+\t}\n \n \tTALLOC_FREE(sampass);\n \n\nModified: branches/SAMBA_3_0_25/source/rpc_server/srv_samr_nt.c\n===================================================================\n--- branches/SAMBA_3_0_25/source/rpc_server/srv_samr_nt.c\t2007-04-24 13:55:04 UTC (rev 22503)\n+++ branches/SAMBA_3_0_25/source/rpc_server/srv_samr_nt.c\t2007-04-24 15:56:02 UTC (rev 22504)\n@@ -739,7 +739,12 @@\n \t\treturn NT_STATUS_ACCESS_DENIED;\n \t}\n \n-\tstatus = pdb_update_sam_account(sampass);\n+\tstatus = access_check_samr_function(acc_granted, SA_RIGHT_USER_SET_ATTRIBUTES, \"_samr_set_sec_obj\");\n+\tif NT_STATUS_IS_OK(status) {\n+\t\tbecome_root();\n+\t\tstatus = pdb_update_sam_account(sampass);\n+\t\tunbecome_root();\n+\t}\n \n \tTALLOC_FREE(sampass);\n \n\n"}