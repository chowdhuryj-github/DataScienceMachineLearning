{"category": "ham", "to_address": "samba-cvs@samba.org", "from_address": "kai@samba.org", "subject": "svn commit: samba r23403 - in branches/SAMBA_4_0/source: . torture", "body": "Author: kai\nDate: 2007-06-09 07:17:24 +0000 (Sat, 09 Jun 2007)\nNew Revision: 23403\n\nWebSVN: http://websvn.samba.org/cgi-bin/viewcvs.cgi?view=rev&root=samba&rev=23403\n\nLog:\nMake nsstest build on Samba4.\n\nFor now, only build on Linux systems. If the build farm is happy with this,\nI will gradually turn on this feature for other platforms, too.\n\n\nAdded:\n   branches/SAMBA_4_0/source/torture/nsstest.h\n   branches/SAMBA_4_0/source/torture/nsstest.m4\nModified:\n   branches/SAMBA_4_0/source/configure.ac\n   branches/SAMBA_4_0/source/torture/config.mk\n   branches/SAMBA_4_0/source/torture/nsstest.c\n\n\nChangeset:\nModified: branches/SAMBA_4_0/source/configure.ac\n===================================================================\n--- branches/SAMBA_4_0/source/configure.ac\t2007-06-09 00:27:28 UTC (rev 23402)\n+++ branches/SAMBA_4_0/source/configure.ac\t2007-06-09 07:17:24 UTC (rev 23403)\n@@ -25,6 +25,7 @@\n m4_include(lib/popt/samba.m4)\n m4_include(lib/charset/config.m4)\n m4_include(lib/socket/config.m4)\n+m4_include(torture/nsstest.m4)\n \n #SMB_EXT_LIB_FROM_PKGCONFIG(LIBTALLOC, talloc >= 1.0,\n #\t\t\t   [samba_cv_internal_talloc=no],\n\nModified: branches/SAMBA_4_0/source/torture/config.mk\n===================================================================\n--- branches/SAMBA_4_0/source/torture/config.mk\t2007-06-09 00:27:28 UTC (rev 23402)\n+++ branches/SAMBA_4_0/source/torture/config.mk\t2007-06-09 07:17:24 UTC (rev 23403)\n@@ -358,6 +358,18 @@\n # End BINARY locktest\n #################################\n \n+#################################\n+# Start BINARY nsstest\n+[BINARY::nsstest]\n+INSTALLDIR = BINDIR\n+OBJ_FILES = \\\n+\t\tnsstest.o\n+PRIVATE_DEPENDENCIES = \\\n+\t\tLIBSAMBA-UTIL \\\n+\t\tLIBREPLACE_EXT\n+# End BINARY nsstest\n+#################################\n+\n GCOV_FLAGS = -ftest-coverage -fprofile-arcs\n GCOV_LIBS = -lgcov\n \n\nModified: branches/SAMBA_4_0/source/torture/nsstest.c\n===================================================================\n--- branches/SAMBA_4_0/source/torture/nsstest.c\t2007-06-09 00:27:28 UTC (rev 23402)\n+++ branches/SAMBA_4_0/source/torture/nsstest.c\t2007-06-09 07:17:24 UTC (rev 23403)\n@@ -20,6 +20,8 @@\n \n #include \"includes.h\"\n \n+#include \"torture/nsstest.h\"\n+\n static const char *so_path = \"/lib/libnss_winbind.so\";\n static const char *nss_name = \"winbind\";\n static int nss_errno;\n@@ -35,13 +37,13 @@\n \tsnprintf(s,sizeof(s), \"_nss_%s_%s\", nss_name, name);\n \n \tif (!h) {\n-\t\th = sys_dlopen(so_path, RTLD_LAZY);\n+\t\th = dlopen(so_path, RTLD_LAZY);\n \t}\n \tif (!h) {\n \t\tprintf(\"Can't open shared library %s\\n\", so_path);\n \t\texit(1);\n \t}\n-\tres = sys_dlsym(h, s);\n+\tres = dlsym(h, s);\n \tif (!res) {\n \t\tprintf(\"Can't find function %s\\n\", s);\n \t\treturn NULL;\n\nAdded: branches/SAMBA_4_0/source/torture/nsstest.h\n===================================================================\n--- branches/SAMBA_4_0/source/torture/nsstest.h\t2007-06-09 00:27:28 UTC (rev 23402)\n+++ branches/SAMBA_4_0/source/torture/nsstest.h\t2007-06-09 07:17:24 UTC (rev 23403)\n@@ -0,0 +1,116 @@\n+/* \n+   Unix SMB/CIFS implementation.\n+   nss includes for the nss tester\n+   Copyright (C) Kai Blin 2007\n+   \n+   This program is free software; you can redistribute it and/or modify\n+   it under the terms of the GNU General Public License as published by\n+   the Free Software Foundation; either version 2 of the License, or\n+   (at your option) any later version.\n+   \n+   This program is distributed in the hope that it will be useful,\n+   but WITHOUT ANY WARRANTY; without even the implied warranty of\n+   MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the\n+   GNU General Public License for more details.\n+   \n+   You should have received a copy of the GNU General Public License\n+   along with this program; if not, write to the Free Software\n+   Foundation, Inc., 675 Mass Ave, Cambridge, MA 02139, USA.\n+*/\n+\n+#ifndef _NSSTEST_H\n+#define _NSSTEST_H\n+\n+#include \n+#include \n+\n+#ifdef HAVE_NSS_COMMON_H\n+\n+/* \n+ * Sun Solaris\n+ */\n+\n+#include \n+#include \n+#include \n+\n+typedef nss_status_t NSS_STATUS;\n+\n+#define NSS_STATUS_SUCCESS     NSS_SUCCESS\n+#define NSS_STATUS_NOTFOUND    NSS_NOTFOUND\n+#define NSS_STATUS_UNAVAIL     NSS_UNAVAIL\n+#define NSS_STATUS_TRYAGAIN    NSS_TRYAGAIN\n+\n+#elif HAVE_NSS_H\n+\n+/*\n+ * Linux (glibc)\n+ */\n+\n+#include \n+typedef enum nss_status NSS_STATUS;\n+\n+#elif HAVE_NS_API_H\n+\n+/*\n+ * SGI IRIX\n+ */\n+\n+#ifdef DATUM\n+#define _DATUM_DEFINED\n+#endif\n+\n+#include \n+\n+typedef enum\n+{\n+\tNSS_STATUS_SUCCESS=NS_SUCCESS,\n+\t\tNSS_STATUS_NOTFOUND=NS_NOTFOUND,\n+\t\tNSS_STATUS_UNAVAIL=NS_UNAVAIL,\n+\t\tNSS_STATUS_TRYAGAIN=NS_TRYAGAIN\n+} NSS_STATUS;\n+\n+#define NSD_MEM_STATIC 0\n+#define NSD_MEM_VOLATILE 1\n+#define NSD_MEM_DYNAMIC 2\n+\n+#elif defined(HPUX) && defined(HAVE_NSSWITCH_H)\n+\n+/* HP-UX 11 */\n+\n+#include \n+\n+#define NSS_STATUS_SUCCESS     NSS_SUCCESS\n+#define NSS_STATUS_NOTFOUND    NSS_NOTFOUND\n+#define NSS_STATUS_UNAVAIL     NSS_UNAVAIL\n+#define NSS_STATUS_TRYAGAIN    NSS_TRYAGAIN\n+\n+#ifdef HAVE_SYNCH_H\n+#include \n+#endif\n+#ifdef HAVE_PTHREAD_H\n+#include \n+#endif\n+\n+typedef enum {\n+\tNSS_SUCCESS,\n+\tNSS_NOTFOUND,\n+\tNSS_UNAVAIL,\n+\tNSS_TRYAGAIN\n+} nss_status_t;\n+\n+typedef nss_status_t NSS_STATUS;\n+\n+#else /* Nothing's defined. Neither solaris nor gnu nor sun nor hp */\n+\n+typedef enum\n+{\n+\tNSS_STATUS_SUCCESS=0,\n+\tNSS_STATUS_NOTFOUND=1,\n+\tNSS_STATUS_UNAVAIL=2,\n+\tNSS_STATUS_TRYAGAIN=3\n+} NSS_STATUS;\n+\n+#endif\n+\n+#endif /* _NSSTEST_H */\n\nAdded: branches/SAMBA_4_0/source/torture/nsstest.m4\n===================================================================\n--- branches/SAMBA_4_0/source/torture/nsstest.m4\t2007-06-09 00:27:28 UTC (rev 23402)\n+++ branches/SAMBA_4_0/source/torture/nsstest.m4\t2007-06-09 07:17:24 UTC (rev 23403)\n@@ -0,0 +1,9 @@\n+case \"$host_os\" in\n+\t*linux*) \n+\t\tSMB_ENABLE(nsstest,YES)\n+\t;;\n+\t*)\n+\t\tSMB_ENABLE(nsstest,NO)\n+\t;;\n+esac\n+\n\n"}