{"category": "ham", "to_address": "samba-cvs@samba.org", "from_address": "jra@samba.org", "subject": "svn commit: samba r23447 - in branches: SAMBA_3_0/source/nsswitch\n\tSAMBA_3_0_25/source/nsswitch SAMBA_3_0_26/source/nsswitch", "body": "Author: jra\nDate: 2007-06-12 19:47:33 +0000 (Tue, 12 Jun 2007)\nNew Revision: 23447\n\nWebSVN: http://websvn.samba.org/cgi-bin/viewcvs.cgi?view=rev&root=samba&rev=23447\n\nLog:\nAdd kill signal to child dead path. After talking\nto Jerry add to 3.0.25b.\nJeremy.\n\nModified:\n   branches/SAMBA_3_0/source/nsswitch/winbindd_dual.c\n   branches/SAMBA_3_0_25/source/nsswitch/winbindd_dual.c\n   branches/SAMBA_3_0_26/source/nsswitch/winbindd_dual.c\n\n\nChangeset:\nModified: branches/SAMBA_3_0/source/nsswitch/winbindd_dual.c\n===================================================================\n--- branches/SAMBA_3_0/source/nsswitch/winbindd_dual.c\t2007-06-12 19:19:35 UTC (rev 23446)\n+++ branches/SAMBA_3_0/source/nsswitch/winbindd_dual.c\t2007-06-12 19:47:33 UTC (rev 23447)\n@@ -188,6 +188,9 @@\n \t\tstate->child->pid ));\n \n \twinbind_child_died(state->child->pid);\n+\n+\t/* Send kill signal to child. */\n+\tkill(state->child->pid, SIGTERM);\n }\n \n static void async_request_sent(void *private_data_data, BOOL success)\n\nModified: branches/SAMBA_3_0_25/source/nsswitch/winbindd_dual.c\n===================================================================\n--- branches/SAMBA_3_0_25/source/nsswitch/winbindd_dual.c\t2007-06-12 19:19:35 UTC (rev 23446)\n+++ branches/SAMBA_3_0_25/source/nsswitch/winbindd_dual.c\t2007-06-12 19:47:33 UTC (rev 23447)\n@@ -96,6 +96,7 @@\n \tstruct winbindd_request *request;\n \tstruct winbindd_response *response;\n \tvoid (*continuation)(void *private_data, BOOL success);\n+\tstruct timed_event *reply_timeout_event;\n \tvoid *private_data;\n };\n \n@@ -160,8 +161,41 @@\n \t\t\t  async_request_sent, state);\n }\n \n+/****************************************************************\n+ Handler triggered if the child winbindd doesn't respond within\n+ a given timeout.\n+****************************************************************/\n+\n+static void async_request_timeout_handler(struct event_context *ctx,\n+\t\t\t\t\tstruct timed_event *te,\n+\t\t\t\t\tconst struct timeval *now,\n+\t\t\t\t\tvoid *private_data)\n+{\n+\tstruct winbindd_async_request *state =\n+\t\ttalloc_get_type_abort(private_data, struct winbindd_async_request);\n+\n+\t/* Deal with the reply - set to error. */\n+\n+\tasync_reply_recv(private_data, False);\n+\n+\t/* \n+\t * Close the socket to the child. Should cause the\n+\t * child to exit.\n+\t */\n+\n+\tDEBUG(0,(\"async_request_timeout_handler: child pid %u is not responding. \"\n+\t\t\"Closing connection to it.\\n\",\n+\t\tstate->child->pid ));\n+\n+\twinbind_child_died(state->child->pid);\n+\n+\t/* Send kill signal to child. */\n+\tkill(state->child->pid, SIGTERM);\n+}\n+\n static void async_request_sent(void *private_data_data, BOOL success)\n {\n+\tuint32_t timeout = 30;\n \tstruct winbindd_async_request *state =\n \t\ttalloc_get_type_abort(private_data_data, struct winbindd_async_request);\n \n@@ -180,6 +214,33 @@\n \t\t\t &state->response->result,\n \t\t\t sizeof(state->response->result),\n \t\t\t async_reply_recv, state);\n+\n+\t/* \n+\t * Normal timeouts are 30s, but auth requests may take a long\n+\t * time to timeout.\n+\t */\n+\n+\tif (state->request->cmd == WINBINDD_PAM_AUTH ||\n+\t\t\tstate->request->cmd == WINBINDD_PAM_AUTH_CRAP ) {\n+\n+\t\ttimeout = 300;\n+\t}\n+\n+\t/* \n+\t * Set up a timeout of 30 seconds for the response.\n+\t * If we don't get it close the child socket and\n+\t * report failure.\n+\t */\n+\n+\tstate->reply_timeout_event = event_add_timed(winbind_event_context(),\n+\t\t\t\t\t\t\tNULL,\n+\t\t\t\t\t\t\ttimeval_current_ofs(timeout,0),\n+\t\t\t\t\t\t\t\"async_request_timeout\",\n+\t\t\t\t\t\t\tasync_request_timeout_handler,\n+\t\t\t\t\t\t\tstate);\n+\tif (!state->reply_timeout_event) {\n+\t\tsmb_panic(\"async_request_sent: failed to add timeout handler.\\n\");\n+\t}\n }\n \n static void async_reply_recv(void *private_data, BOOL success)\n@@ -188,6 +249,10 @@\n \t\ttalloc_get_type_abort(private_data, struct winbindd_async_request);\n \tstruct winbindd_child *child = state->child;\n \n+\tif (state->reply_timeout_event) {\n+\t\tTALLOC_FREE(state->reply_timeout_event);\n+\t}\n+\n \tstate->response->length = sizeof(struct winbindd_response);\n \n \tif (!success) {\n\nModified: branches/SAMBA_3_0_26/source/nsswitch/winbindd_dual.c\n===================================================================\n--- branches/SAMBA_3_0_26/source/nsswitch/winbindd_dual.c\t2007-06-12 19:19:35 UTC (rev 23446)\n+++ branches/SAMBA_3_0_26/source/nsswitch/winbindd_dual.c\t2007-06-12 19:47:33 UTC (rev 23447)\n@@ -188,6 +188,9 @@\n \t\tstate->child->pid ));\n \n \twinbind_child_died(state->child->pid);\n+\n+\t/* Send kill signal to child. */\n+\tkill(state->child->pid, SIGTERM);\n }\n \n static void async_request_sent(void *private_data_data, BOOL success)\n\n"}