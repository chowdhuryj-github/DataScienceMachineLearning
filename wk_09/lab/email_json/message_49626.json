{"category": "ham", "to_address": "Gavin Simpson <gavin.simpson@ucl.ac.uk>", "from_address": "\"Charles C. Berry\" <cberry@tajo.ucsd.edu>", "subject": "Re: [R] Efficiently calculate sd on an array?", "body": "On Sun, 17 Jun 2007, Gavin Simpson wrote:\n\n> Dear list,\n>\n> Consider the following problem:\n>\n> n.obs <- 167\n> n.boot <- 100\n> arr <- array(runif(n.obs*n.obs*n.boot), dim = c(n.obs, n.obs, n.boot))\n> arr[sample(n.obs, 3), sample(n.obs, 3), ] <- NA\n>\n> Given the array arr, with dims = 167*167*100, I would like to calculate\n> the sd of the values in the 3rd dimension of arr, and an obvious way to\n> do this is via apply():\n>\n> system.time(res <- apply(arr, c(2,1), sd, na.rm = TRUE))\n>\n> This takes over 4 seconds on my desktop.\n>\n> I have found an efficient way to calculate the means of the 3rd\n> dimension using\n>\n> temp <- t(rowMeans(arr, na.rm = TRUE, dims = 2))\n>\n> instead of\n>\n> temp <- apply(arr, c(2,1), mean, na.rm = TRUE)\n>\n> but I am having difficulty seeing how to calculate the standard\n> deviations efficiently.\n>\n> Any idea how I might go about this?\n\nHere are timings on my system:\n\n> system.time(res <- apply(arr, c(2,1), sd, na.rm = TRUE))\n    user  system elapsed\n    3.49    0.00    3.52\n> system.time(res2 <- {\n+   ns <- rowSums(!is.na(arr),dim=2)\n+   mns <- as.vector(rowMeans(arr, na.rm = TRUE, dims = 2))\n+   sds <- t(sqrt(rowSums( (arr- mns )^2,na.rm=T,dims=2)/as.vector(ns-1)))\n+   sds[t(ns)==0] <- NA\n+   sds})\n    user  system elapsed\n    0.36    0.02    0.37\n> all.equal(res,res2)\n[1] TRUE\n>\n\nHTH,\n\nChuck\n\n>\n> All the best,\n>\n> G\n> -- \n> %~%~%~%~%~%~%~%~%~%~%~%~%~%~%~%~%~%~%~%~%~%~%~%~%~%~%~%~%~%~%~%~%~%~%~%\n> Gavin Simpson                     [t] +44 (0)20 7679 0522\n> ECRC                              [f] +44 (0)20 7679 0565\n> UCL Department of Geography\n> Pearson Building                  [e] gavin.simpsonATNOSPAMucl.ac.uk\n> Gower Street\n> London, UK                        [w] http://www.ucl.ac.uk/~ucfagls/\n> WC1E 6BT                          [w] http://www.freshwaters.org.uk/\n> %~%~%~%~%~%~%~%~%~%~%~%~%~%~%~%~%~%~%~%~%~%~%~%~%~%~%~%~%~%~%~%~%~%~%~%\n>\n> ______________________________________________\n> R-help@stat.math.ethz.ch mailing list\n> https://stat.ethz.ch/mailman/listinfo/r-help\n> PLEASE do read the posting guide http://www.R-project.org/posting-guide.html\n> and provide commented, minimal, self-contained, reproducible code.\n>\n\nCharles C. Berry                            (858) 534-2098\n                                             Dept of Family/Preventive Medicine\nE mailto:cberry@tajo.ucsd.edu\t            UC San Diego\nhttp://famprevmed.ucsd.edu/faculty/cberry/  La Jolla, San Diego 92093-0901\n\n______________________________________________\nR-help@stat.math.ethz.ch mailing list\nhttps://stat.ethz.ch/mailman/listinfo/r-help\nPLEASE do read the posting guide http://www.R-project.org/posting-guide.html\nand provide commented, minimal, self-contained, reproducible code.\n\n"}