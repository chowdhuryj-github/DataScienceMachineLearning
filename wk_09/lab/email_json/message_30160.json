{"category": "ham", "to_address": "samba-cvs@samba.org", "from_address": "vlendec@samba.org", "subject": "svn commit: samba r22900 - in branches: SAMBA_3_0/source/profile\n\tSAMBA_3_0/source/smbd SAMBA_3_0/source/utils\n\tSAMBA_3_0_26/source/profile SAMBA_3_0_26/source/smbd\n\tSAMBA_3_0_26/source/utils", "body": "Author: vlendec\nDate: 2007-05-15 12:18:17 +0000 (Tue, 15 May 2007)\nNew Revision: 22900\n\nWebSVN: http://websvn.samba.org/cgi-bin/viewcvs.cgi?view=rev&root=samba&rev=22900\n\nLog:\nConvert profile/ to messaging_send_pid/messaging_register\n\nModified:\n   branches/SAMBA_3_0/source/profile/profile.c\n   branches/SAMBA_3_0/source/smbd/server.c\n   branches/SAMBA_3_0/source/utils/status_profile.c\n   branches/SAMBA_3_0_26/source/profile/profile.c\n   branches/SAMBA_3_0_26/source/smbd/server.c\n   branches/SAMBA_3_0_26/source/utils/status_profile.c\n\n\nChangeset:\nModified: branches/SAMBA_3_0/source/profile/profile.c\n===================================================================\n--- branches/SAMBA_3_0/source/profile/profile.c\t2007-05-15 11:26:03 UTC (rev 22899)\n+++ branches/SAMBA_3_0/source/profile/profile.c\t2007-05-15 12:18:17 UTC (rev 22900)\n@@ -93,20 +93,31 @@\n /****************************************************************************\n receive a set profile level message\n ****************************************************************************/\n-void profile_message(int msg_type, struct server_id src, void *buf, size_t len,\n-\t\t     void *private_data)\n+static void profile_message(struct messaging_context *msg_ctx,\n+\t\t\t    void *private_data,\n+\t\t\t    uint32_t msg_type,\n+\t\t\t    struct server_id src,\n+\t\t\t    DATA_BLOB *data)\n {\n         int level;\n \n-\tmemcpy(&level, buf, sizeof(int));\n+\tif (data->length != sizeof(level)) {\n+\t\tDEBUG(0, (\"got invalid profile message\\n\"));\n+\t\treturn;\n+\t}\n+\n+\tmemcpy(&level, data->data, sizeof(level));\n \tset_profile_level(level, src);\n }\n \n /****************************************************************************\n receive a request profile level message\n ****************************************************************************/\n-void reqprofile_message(int msg_type, struct server_id src,\n-\t\t\tvoid *buf, size_t len, void *private_data)\n+static void reqprofile_message(struct messaging_context *msg_ctx,\n+\t\t\t       void *private_data, \n+\t\t\t       uint32_t msg_type, \n+\t\t\t       struct server_id src,\n+\t\t\t       DATA_BLOB *data)\n {\n         int level;\n \n@@ -117,7 +128,8 @@\n #endif\n \tDEBUG(1,(\"INFO: Received REQ_PROFILELEVEL message from PID %u\\n\",\n \t\t (unsigned int)procid_to_pid(&src)));\n-\tmessage_send_pid(src, MSG_PROFILELEVEL, &level, sizeof(int), True);\n+\tmessaging_send_buf(msg_ctx, src, MSG_PROFILELEVEL,\n+\t\t\t   (uint8 *)&level, sizeof(level));\n }\n \n /*******************************************************************\n@@ -184,7 +196,7 @@\n }\n #endif\n \n-BOOL profile_setup(BOOL rdonly)\n+BOOL profile_setup(struct messaging_context *msg_ctx, BOOL rdonly)\n {\n \tstruct shmid_ds shm_ds;\n \n@@ -238,7 +250,7 @@\n \t}\n \n \tif (shm_ds.shm_segsz != sizeof(*profile_h)) {\n-\t\tDEBUG(0,(\"WARNING: profile size is %d (expected %lu). Deleting\\n\",\n+\t\tDEBUG(0,(\"WARNING: profile size is %d (expected %d). Deleting\\n\",\n \t\t\t (int)shm_ds.shm_segsz, sizeof(*profile_h)));\n \t\tif (shmctl(shm_id, IPC_RMID, &shm_ds) == 0) {\n \t\t\tgoto again;\n@@ -255,8 +267,12 @@\n \t}\n \n \tprofile_p = &profile_h->stats;\n-\tmessage_register(MSG_PROFILE, profile_message, NULL);\n-\tmessage_register(MSG_REQ_PROFILELEVEL, reqprofile_message, NULL);\n+\tif (msg_ctx != NULL) {\n+\t\tmessaging_register(msg_ctx, NULL, MSG_PROFILE,\n+\t\t\t\t   profile_message);\n+\t\tmessaging_register(msg_ctx, NULL, MSG_REQ_PROFILELEVEL,\n+\t\t\t\t   reqprofile_message);\n+\t}\n \treturn True;\n }\n \n\nModified: branches/SAMBA_3_0/source/smbd/server.c\n===================================================================\n--- branches/SAMBA_3_0/source/smbd/server.c\t2007-05-15 11:26:03 UTC (rev 22899)\n+++ branches/SAMBA_3_0/source/smbd/server.c\t2007-05-15 12:18:17 UTC (rev 22900)\n@@ -917,7 +917,7 @@\n \tinit_structs();\n \n #ifdef WITH_PROFILE\n-\tif (!profile_setup(False)) {\n+\tif (!profile_setup(smbd_messaging_context(), False)) {\n \t\tDEBUG(0,(\"ERROR: failed to setup profiling\\n\"));\n \t\treturn -1;\n \t}\n\nModified: branches/SAMBA_3_0/source/utils/status_profile.c\n===================================================================\n--- branches/SAMBA_3_0/source/utils/status_profile.c\t2007-05-15 11:26:03 UTC (rev 22899)\n+++ branches/SAMBA_3_0/source/utils/status_profile.c\t2007-05-15 12:18:17 UTC (rev 22900)\n@@ -47,7 +47,7 @@\n BOOL status_profile_dump(BOOL verbose)\n {\n #ifdef WITH_PROFILE\n-\tif (!profile_setup(True)) {\n+\tif (!profile_setup(NULL, True)) {\n \t\tfprintf(stderr,\"Failed to initialise profile memory\\n\");\n \t\treturn False;\n \t}\n@@ -487,7 +487,7 @@\n \t\t    usec_to_sec(sample_interval_usec));\n \t}\n \n-\tif (!profile_setup(True)) {\n+\tif (!profile_setup(NULL, True)) {\n \t\tfprintf(stderr,\"Failed to initialise profile memory\\n\");\n \t\treturn False;\n \t}\n\nModified: branches/SAMBA_3_0_26/source/profile/profile.c\n===================================================================\n--- branches/SAMBA_3_0_26/source/profile/profile.c\t2007-05-15 11:26:03 UTC (rev 22899)\n+++ branches/SAMBA_3_0_26/source/profile/profile.c\t2007-05-15 12:18:17 UTC (rev 22900)\n@@ -93,20 +93,31 @@\n /****************************************************************************\n receive a set profile level message\n ****************************************************************************/\n-void profile_message(int msg_type, struct server_id src, void *buf, size_t len,\n-\t\t     void *private_data)\n+static void profile_message(struct messaging_context *msg_ctx,\n+\t\t\t    void *private_data,\n+\t\t\t    uint32_t msg_type,\n+\t\t\t    struct server_id src,\n+\t\t\t    DATA_BLOB *data)\n {\n         int level;\n \n-\tmemcpy(&level, buf, sizeof(int));\n+\tif (data->length != sizeof(level)) {\n+\t\tDEBUG(0, (\"got invalid profile message\\n\"));\n+\t\treturn;\n+\t}\n+\n+\tmemcpy(&level, data->data, sizeof(level));\n \tset_profile_level(level, src);\n }\n \n /****************************************************************************\n receive a request profile level message\n ****************************************************************************/\n-void reqprofile_message(int msg_type, struct server_id src,\n-\t\t\tvoid *buf, size_t len, void *private_data)\n+static void reqprofile_message(struct messaging_context *msg_ctx,\n+\t\t\t       void *private_data, \n+\t\t\t       uint32_t msg_type, \n+\t\t\t       struct server_id src,\n+\t\t\t       DATA_BLOB *data)\n {\n         int level;\n \n@@ -117,7 +128,8 @@\n #endif\n \tDEBUG(1,(\"INFO: Received REQ_PROFILELEVEL message from PID %u\\n\",\n \t\t (unsigned int)procid_to_pid(&src)));\n-\tmessage_send_pid(src, MSG_PROFILELEVEL, &level, sizeof(int), True);\n+\tmessaging_send_buf(msg_ctx, src, MSG_PROFILELEVEL,\n+\t\t\t   (uint8 *)&level, sizeof(level));\n }\n \n /*******************************************************************\n@@ -184,7 +196,7 @@\n }\n #endif\n \n-BOOL profile_setup(BOOL rdonly)\n+BOOL profile_setup(struct messaging_context *msg_ctx, BOOL rdonly)\n {\n \tstruct shmid_ds shm_ds;\n \n@@ -238,7 +250,7 @@\n \t}\n \n \tif (shm_ds.shm_segsz != sizeof(*profile_h)) {\n-\t\tDEBUG(0,(\"WARNING: profile size is %d (expected %lu). Deleting\\n\",\n+\t\tDEBUG(0,(\"WARNING: profile size is %d (expected %d). Deleting\\n\",\n \t\t\t (int)shm_ds.shm_segsz, sizeof(*profile_h)));\n \t\tif (shmctl(shm_id, IPC_RMID, &shm_ds) == 0) {\n \t\t\tgoto again;\n@@ -255,8 +267,12 @@\n \t}\n \n \tprofile_p = &profile_h->stats;\n-\tmessage_register(MSG_PROFILE, profile_message, NULL);\n-\tmessage_register(MSG_REQ_PROFILELEVEL, reqprofile_message, NULL);\n+\tif (msg_ctx != NULL) {\n+\t\tmessaging_register(msg_ctx, NULL, MSG_PROFILE,\n+\t\t\t\t   profile_message);\n+\t\tmessaging_register(msg_ctx, NULL, MSG_REQ_PROFILELEVEL,\n+\t\t\t\t   reqprofile_message);\n+\t}\n \treturn True;\n }\n \n\nModified: branches/SAMBA_3_0_26/source/smbd/server.c\n===================================================================\n--- branches/SAMBA_3_0_26/source/smbd/server.c\t2007-05-15 11:26:03 UTC (rev 22899)\n+++ branches/SAMBA_3_0_26/source/smbd/server.c\t2007-05-15 12:18:17 UTC (rev 22900)\n@@ -966,7 +966,7 @@\n \tinit_structs();\n \n #ifdef WITH_PROFILE\n-\tif (!profile_setup(False)) {\n+\tif (!profile_setup(smbd_messaging_context(), False)) {\n \t\tDEBUG(0,(\"ERROR: failed to setup profiling\\n\"));\n \t\treturn -1;\n \t}\n\nModified: branches/SAMBA_3_0_26/source/utils/status_profile.c\n===================================================================\n--- branches/SAMBA_3_0_26/source/utils/status_profile.c\t2007-05-15 11:26:03 UTC (rev 22899)\n+++ branches/SAMBA_3_0_26/source/utils/status_profile.c\t2007-05-15 12:18:17 UTC (rev 22900)\n@@ -47,7 +47,7 @@\n BOOL status_profile_dump(BOOL verbose)\n {\n #ifdef WITH_PROFILE\n-\tif (!profile_setup(True)) {\n+\tif (!profile_setup(NULL, True)) {\n \t\tfprintf(stderr,\"Failed to initialise profile memory\\n\");\n \t\treturn False;\n \t}\n@@ -487,7 +487,7 @@\n \t\t    usec_to_sec(sample_interval_usec));\n \t}\n \n-\tif (!profile_setup(True)) {\n+\tif (!profile_setup(NULL, True)) {\n \t\tfprintf(stderr,\"Failed to initialise profile memory\\n\");\n \t\treturn False;\n \t}\n\n"}