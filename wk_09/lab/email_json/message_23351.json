{"category": "ham", "to_address": "samba-cvs@samba.org", "from_address": "Jelmer Vernooij <jelmer@samba.org>", "subject": "Rev 12009: Merge upstream. in file:///home/jelmer/bzr.samba/python/", "body": "At file:///home/jelmer/bzr.samba/python/\n\n------------------------------------------------------------\nrevno: 12009\nrevision-id: jelmer@samba.org-20070505000247-o4e3y4k8a3gbdx59\nparent: jelmer@samba.org-20070501232403-io0ugx8i9wmgcmo3\nparent: svn-v2:22672@0c0555d6-39d7-0310-84fc-f1cc0bd64818-branches%2fSAMBA_4_0\ncommitter: Jelmer Vernooij \nbranch nick: python\ntimestamp: Sat 2007-05-05 02:02:47 +0200\nmessage:\n  Merge upstream.\nadded:\n  source/lib/ldb/external/       svn-v2:22642@0c0555d6-39d7-0310-84fc-f1cc0bd64818-branches%2fSAMBA_4_0-source%2flib%2fldb%2fexternal\n  source/lib/ldb/external/libpopt.m4 svn-v2:22642@0c0555d6-39d7-0310-84fc-f1cc0bd64818-branches%2fSAMBA_4_0-source%2flib%2fldb%2fexternal%2flibpopt.m4\n  source/lib/ldb/external/libtalloc.m4 svn-v2:22642@0c0555d6-39d7-0310-84fc-f1cc0bd64818-branches%2fSAMBA_4_0-source%2flib%2fldb%2fexternal%2flibtalloc.m4\n  source/lib/ldb/external/libtdb.m4 svn-v2:22642@0c0555d6-39d7-0310-84fc-f1cc0bd64818-branches%2fSAMBA_4_0-source%2flib%2fldb%2fexternal%2flibtdb.m4\n  source/lib/ldb/external/pkg.m4 svn-v2:22642@0c0555d6-39d7-0310-84fc-f1cc0bd64818-branches%2fSAMBA_4_0-source%2flib%2fldb%2fexternal%2fpkg.m4\nmodified:\n  .bzrignore                     svn-v2:17811@0c0555d6-39d7-0310-84fc-f1cc0bd64818-branches%2fSAMBA_4_0-.bzrignore\n  source/auth/gensec/gensec_gssapi.c svn-v2:6113@0c0555d6-39d7-0310-84fc-f1cc0bd64818-branches%2fSAMBA_4_0-source%2fauth%2fgensec%2fgensec_gssapi.c\n  source/auth/kerberos/krb5_init_context.c svn-v2:10286@0c0555d6-39d7-0310-84fc-f1cc0bd64818-branches%2fSAMBA_4_0-source%2fauth%2fkerberos%2fkrb5_init_context.c\n  source/build/m4/check_ld.m4    svn-v2:7274@0c0555d6-39d7-0310-84fc-f1cc0bd64818-branches%2fSAMBA_4_0-source%2fbuild%2fm4%2fcheck_ld.m4\n  source/lib/events/events_aio.c svn-v2:20104@0c0555d6-39d7-0310-84fc-f1cc0bd64818-branches%2fSAMBA_4_0-source%2flib%2fevents%2fevents_aio.c\n  source/lib/events/events_epoll.c svn-v2:20539@0c0555d6-39d7-0310-84fc-f1cc0bd64818-branches%2fSAMBA_4_0-source%2flib%2fevents%2fevents_epoll.c\n  source/lib/events/events_internal.h svn-v2:5407@0c0555d6-39d7-0310-84fc-f1cc0bd64818-branches%2fSAMBA_4_0-source%2flib%2fevents%2fevents_internal.h\n  source/lib/events/events_select.c svn-v2:20539@0c0555d6-39d7-0310-84fc-f1cc0bd64818-branches%2fSAMBA_4_0-source%2flib%2fevents%2fevents_select.c\n  source/lib/events/events_standard.c svn-v2:5373@0c0555d6-39d7-0310-84fc-f1cc0bd64818-branches%2fSAMBA_4_0-source%2flib%2fevents%2fevents_standard.c\n  source/lib/events/events_timed.c svn-v2:20539@0c0555d6-39d7-0310-84fc-f1cc0bd64818-branches%2fSAMBA_4_0-source%2flib%2fevents%2fevents_timed.c\n  source/lib/ldb/autogen.sh      svn-v2:6479@0c0555d6-39d7-0310-84fc-f1cc0bd64818-branches%2fSAMBA_4_0-source%2flib%2fldb%2fautogen.sh\n  source/lib/ldb/configure.ac    svn-v2:18036@0c0555d6-39d7-0310-84fc-f1cc0bd64818-branches%2fSAMBA_4_0-source%2flib%2fldb%2fconfigure.ac\n  source/lib/ldb/include/includes.h svn-v2:6@0c0555d6-39d7-0310-84fc-f1cc0bd64818-branches%2fSAMBA_4_0-source%2flib%2fldb%2finclude%2fincludes.h\n  source/lib/replace/autoconf-2.60.m4 svn-v2:18292@0c0555d6-39d7-0310-84fc-f1cc0bd64818-branches%2fSAMBA_4_0-source%2flib%2freplace%2fautoconf%2d2.60.m4\n  source/lib/replace/test/testsuite.c svn-v2:18031@0c0555d6-39d7-0310-84fc-f1cc0bd64818-branches%2fSAMBA_4_0-source%2flib%2freplace%2ftest%2ftestsuite.c\n  source/lib/tdb/Makefile.in     svn-v2:6546@0c0555d6-39d7-0310-84fc-f1cc0bd64818-branches%2fSAMBA_4_0-source%2flib%2ftdb%2fMakefile.in\n  source/lib/tdb/configure.ac    svn-v2:18031@0c0555d6-39d7-0310-84fc-f1cc0bd64818-branches%2fSAMBA_4_0-source%2flib%2ftdb%2fconfigure.ac\n  source/libnet/libnet_passwd.c  svn-v2:1816@0c0555d6-39d7-0310-84fc-f1cc0bd64818-branches%2fSAMBA_4_0-source%2flibnet%2flibnet_passwd.c\n  source/libnet/libnet_rpc.c     svn-v2:1836@0c0555d6-39d7-0310-84fc-f1cc0bd64818-branches%2fSAMBA_4_0-source%2flibnet%2flibnet_rpc.c\n  source/torture/raw/notify.c    svn-v2:6@0c0555d6-39d7-0310-84fc-f1cc0bd64818-branches%2fSAMBA_4_0-source%2ftorture%2fraw%2fnotify.c\n    ------------------------------------------------------------\n    revno: 11989.1.104\n    merged: svn-v2:22672@0c0555d6-39d7-0310-84fc-f1cc0bd64818-branches%2fSAMBA_4_0\n    parent: svn-v2:22670@0c0555d6-39d7-0310-84fc-f1cc0bd64818-branches%2fSAMBA_4_0\n    committer: mimir\n    timestamp: Fri 2007-05-04 18:59:51 +0000\n    message:\n      use composite_create calls instead of talloc_zero.\n      \n      \n      rafal\n    ------------------------------------------------------------\n    revno: 11989.1.103\n    merged: svn-v2:22670@0c0555d6-39d7-0310-84fc-f1cc0bd64818-branches%2fSAMBA_4_0\n    parent: svn-v2:22669@0c0555d6-39d7-0310-84fc-f1cc0bd64818-branches%2fSAMBA_4_0\n    committer: tridge\n    timestamp: Fri 2007-05-04 12:41:28 +0000\n    message:\n      \n      changed the RAW-NOTIFY test to support clustered testing (two nodes)\n    ------------------------------------------------------------\n    revno: 11989.1.102\n    merged: svn-v2:22669@0c0555d6-39d7-0310-84fc-f1cc0bd64818-branches%2fSAMBA_4_0\n    parent: svn-v2:22668@0c0555d6-39d7-0310-84fc-f1cc0bd64818-branches%2fSAMBA_4_0\n    committer: metze\n    timestamp: Fri 2007-05-04 11:26:25 +0000\n    message:\n      fix uninitialized element which was causing a crash with 'net password set'\n      \n      metze\n    ------------------------------------------------------------\n    revno: 11989.1.101\n    merged: svn-v2:22668@0c0555d6-39d7-0310-84fc-f1cc0bd64818-branches%2fSAMBA_4_0\n    parent: svn-v2:22667@0c0555d6-39d7-0310-84fc-f1cc0bd64818-branches%2fSAMBA_4_0\n    parent: jelmer@samba.org-20070504110832-4pyga5axfuts2rc8\n    committer: jelmer\n    timestamp: Fri 2007-05-04 11:08:53 +0000\n    message:\n      Fix ldb build\n        ------------------------------------------------------------\n        revno: 11989.1.100.1.1\n        merged: jelmer@samba.org-20070504110832-4pyga5axfuts2rc8\n        parent: svn-v2:22667@0c0555d6-39d7-0310-84fc-f1cc0bd64818-branches%2fSAMBA_4_0\n        committer: Jelmer Vernooij \n        branch nick: SAMBA_4_0\n        timestamp: Fri 2007-05-04 13:08:32 +0200\n        message:\n          Fix ldb build\n    ------------------------------------------------------------\n    revno: 11989.1.100\n    merged: svn-v2:22667@0c0555d6-39d7-0310-84fc-f1cc0bd64818-branches%2fSAMBA_4_0\n    parent: svn-v2:22665@0c0555d6-39d7-0310-84fc-f1cc0bd64818-branches%2fSAMBA_4_0\n    committer: metze\n    timestamp: Fri 2007-05-04 10:44:41 +0000\n    message:\n      revert revision 22640 as it breaks nested structs in idl\n      \n      metze\n    ------------------------------------------------------------\n    revno: 11989.1.99\n    merged: svn-v2:22665@0c0555d6-39d7-0310-84fc-f1cc0bd64818-branches%2fSAMBA_4_0\n    parent: svn-v2:22662@0c0555d6-39d7-0310-84fc-f1cc0bd64818-branches%2fSAMBA_4_0\n    parent: jelmer@samba.org-20070504110219-twqhdkx6mck6asyd\n    committer: jelmer\n    timestamp: Fri 2007-05-04 10:02:47 +0000\n    message:\n      Change version back to 0.9.\n        ------------------------------------------------------------\n        revno: 11989.1.98.1.1\n        merged: jelmer@samba.org-20070504110219-twqhdkx6mck6asyd\n        parent: svn-v2:22662@0c0555d6-39d7-0310-84fc-f1cc0bd64818-branches%2fSAMBA_4_0\n        committer: Jelmer Vernooij \n        branch nick: SAMBA_4_0\n        timestamp: Fri 2007-05-04 13:02:19 +0200\n        message:\n          Change version back to 0.9.\n    ------------------------------------------------------------\n    revno: 11989.1.98\n    merged: svn-v2:22662@0c0555d6-39d7-0310-84fc-f1cc0bd64818-branches%2fSAMBA_4_0\n    parent: svn-v2:22661@0c0555d6-39d7-0310-84fc-f1cc0bd64818-branches%2fSAMBA_4_0\n    committer: metze\n    timestamp: Fri 2007-05-04 09:35:01 +0000\n    message:\n      disable shared library support on Tru64\n      \n      metze \n    ------------------------------------------------------------\n    revno: 11989.1.97\n    merged: svn-v2:22661@0c0555d6-39d7-0310-84fc-f1cc0bd64818-branches%2fSAMBA_4_0\n    parent: svn-v2:22658@0c0555d6-39d7-0310-84fc-f1cc0bd64818-branches%2fSAMBA_4_0\n    committer: metze\n    timestamp: Fri 2007-05-04 09:22:52 +0000\n    message:\n      optimize the handling of directly triggered timed events:\n      \n      - if someone adds a timed_event with a zero timeval\n        we now avoid serval gettimeofday() calls and the\n        event handler doesn't get the current time when it's\n        called, instead we also pass a zero timeval\n      \n      - this also makes sure multiple timed events with a zero timeval\n        are processed in the order there're added.\n      \n      the little benchmark shows that processing 2000000 directly timed events\n      is now much faster, while avoiding syscalls at all!\n      \n      > time ./evtest (with the old code)\n      \n      real    0m6.388s\n      user    0m1.740s\n      sys     0m4.632s\n      > time ./evtest (with the new code)\n      \n      real    0m1.498s\n      user    0m1.496s\n      sys     0m0.004s\n      metze@SERNOX:~/devel/samba/4.0/samba4-ci/source> cat evtest.c\n      #include \n      #include \n      #include \n      #include \n      #include \n      \n      static void dummy_fde_handler(struct event_context *ev_ctx, struct fd_event *fde,\n                                    uint16_t flags, void *private_data)\n      {\n      }\n      \n      static void timeout_handler(struct event_context *ev, struct timed_event *te,\n                                  struct timeval tval, void *private_data)\n      {\n              uint32_t *countp = (uint32_t *)private_data;\n              (*countp)++;\n              if (*countp > 2000000) exit(0);\n              event_add_timed(ev, ev, tval, timeout_handler, countp);\n      }\n      \n      int main(void)\n      {\n              struct event_context *ev;\n              struct timeval tval =  { 0, 0 };\n              uint32_t count = 0;\n              ev = event_context_init(NULL);\n              event_add_fd(ev, ev, 0, 0, dummy_fde_handler, NULL);\n              event_add_timed(ev, ev, tval, timeout_handler, &count);\n              return event_loop_wait(ev);\n      }\n    ------------------------------------------------------------\n    revno: 11989.1.96\n    merged: svn-v2:22658@0c0555d6-39d7-0310-84fc-f1cc0bd64818-branches%2fSAMBA_4_0\n    parent: svn-v2:22642@0c0555d6-39d7-0310-84fc-f1cc0bd64818-branches%2fSAMBA_4_0\n    committer: metze\n    timestamp: Fri 2007-05-04 06:59:02 +0000\n    message:\n      - add AC_GNU_SOURCE macro for systems which don't have it\n        (sles8)\n      - fix compiler warning on some systems\n      \n      metze\n    ------------------------------------------------------------\n    revno: 11989.1.95\n    merged: svn-v2:22642@0c0555d6-39d7-0310-84fc-f1cc0bd64818-branches%2fSAMBA_4_0\n    parent: svn-v2:22640@0c0555d6-39d7-0310-84fc-f1cc0bd64818-branches%2fSAMBA_4_0\n    committer: jelmer\n    timestamp: Wed 2007-05-02 22:05:48 +0000\n    message:\n      Allow standalone build to work without tdb or talloc checked out, but \n      provided by the system.\n    ------------------------------------------------------------\n    revno: 11989.1.94\n    merged: svn-v2:22640@0c0555d6-39d7-0310-84fc-f1cc0bd64818-branches%2fSAMBA_4_0\n    parent: svn-v2:22637@0c0555d6-39d7-0310-84fc-f1cc0bd64818-branches%2fSAMBA_4_0\n    committer: metze\n    timestamp: Wed 2007-05-02 18:00:02 +0000\n    message:\n      - generate nicer output\n      - fix compiler warning about unused ';'\n      \n      metze\n    ------------------------------------------------------------\n    revno: 11989.1.93\n    merged: svn-v2:22637@0c0555d6-39d7-0310-84fc-f1cc0bd64818-branches%2fSAMBA_4_0\n    parent: svn-v2:22635@0c0555d6-39d7-0310-84fc-f1cc0bd64818-branches%2fSAMBA_4_0\n    parent: jelmer@samba.org-20070502170822-sp9950452zu87uyx\n    committer: jelmer\n    timestamp: Wed 2007-05-02 16:09:33 +0000\n    message:\n      Install tdbbackup and tdbdump again.\n        ------------------------------------------------------------\n        revno: 11989.1.92.1.1\n        merged: jelmer@samba.org-20070502170822-sp9950452zu87uyx\n        parent: svn-v2:22635@0c0555d6-39d7-0310-84fc-f1cc0bd64818-branches%2fSAMBA_4_0\n        committer: Jelmer Vernooij \n        branch nick: SAMBA_4_0\n        timestamp: Wed 2007-05-02 19:08:22 +0200\n        message:\n          Install tdbbackup and tdbdump again.\n    ------------------------------------------------------------\n    revno: 11989.1.92\n    merged: svn-v2:22635@0c0555d6-39d7-0310-84fc-f1cc0bd64818-branches%2fSAMBA_4_0\n    parent: svn-v2:22634@0c0555d6-39d7-0310-84fc-f1cc0bd64818-branches%2fSAMBA_4_0\n    committer: metze\n    timestamp: Wed 2007-05-02 09:54:06 +0000\n    message:\n      make it possible to not turn off dns canonicalization of hostnames\n      with krb5:set_dns_canonicalize=yes\n      \n      needed for the drsuapi replication, but we should fix this with\n      a kdc locator plugin ...\n      \n      metze\n=== added directory 'source/lib/ldb/external'\n=== added file 'source/lib/ldb/external/libpopt.m4'\n--- a/source/lib/ldb/external/libpopt.m4\t1970-01-01 00:00:00 +0000\n+++ b/source/lib/ldb/external/libpopt.m4\t2007-05-02 22:05:48 +0000\n@@ -0,0 +1,7 @@\n+POPT_OBJ=\"\"\n+AC_SUBST(POPT_OBJ)\n+AC_SUBST(POPT_LIBS)\n+AC_SUBST(POPT_CFLAGS)\n+\n+AC_CHECK_HEADERS(popt.h)\n+AC_CHECK_LIB(popt, poptGetContext, [ POPT_LIBS=\"-lpopt\" ])\n\n=== added file 'source/lib/ldb/external/libtalloc.m4'\n--- a/source/lib/ldb/external/libtalloc.m4\t1970-01-01 00:00:00 +0000\n+++ b/source/lib/ldb/external/libtalloc.m4\t2007-05-02 22:05:48 +0000\n@@ -0,0 +1,4 @@\n+m4_include(pkg.m4)\n+TALLOC_OBJ=\"\"\n+AC_SUBST(TALLOC_OBJ)\n+PKG_CHECK_MODULES(TALLOC, talloc)\n\n=== added file 'source/lib/ldb/external/libtdb.m4'\n--- a/source/lib/ldb/external/libtdb.m4\t1970-01-01 00:00:00 +0000\n+++ b/source/lib/ldb/external/libtdb.m4\t2007-05-02 22:05:48 +0000\n@@ -0,0 +1,4 @@\n+m4_include(pkg.m4)\n+TDB_OBJ=\"\"\n+AC_SUBST(TDB_OBJ)\n+PKG_CHECK_MODULES(TDB, tdb >= 1.1.0)\n\n=== added file 'source/lib/ldb/external/pkg.m4'\n--- a/source/lib/ldb/external/pkg.m4\t1970-01-01 00:00:00 +0000\n+++ b/source/lib/ldb/external/pkg.m4\t2007-05-02 22:05:48 +0000\n@@ -0,0 +1,157 @@\n+# pkg.m4 - Macros to locate and utilise pkg-config.            -*- Autoconf -*-\n+# \n+# Copyright \u00a9 2004 Scott James Remnant .\n+#\n+# This program is free software; you can redistribute it and/or modify\n+# it under the terms of the GNU General Public License as published by\n+# the Free Software Foundation; either version 2 of the License, or\n+# (at your option) any later version.\n+#\n+# This program is distributed in the hope that it will be useful, but\n+# WITHOUT ANY WARRANTY; without even the implied warranty of\n+# MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the GNU\n+# General Public License for more details.\n+#\n+# You should have received a copy of the GNU General Public License\n+# along with this program; if not, write to the Free Software\n+# Foundation, Inc., 59 Temple Place - Suite 330, Boston, MA 02111-1307, USA.\n+#\n+# As a special exception to the GNU General Public License, if you\n+# distribute this file as part of a program that contains a\n+# configuration script generated by Autoconf, you may include it under\n+# the same distribution terms that you use for the rest of that program.\n+\n+# PKG_PROG_PKG_CONFIG([MIN-VERSION])\n+# ----------------------------------\n+AC_DEFUN([PKG_PROG_PKG_CONFIG],\n+[m4_pattern_forbid([^_?PKG_[A-Z_]+$])\n+m4_pattern_allow([^PKG_CONFIG(_PATH)?$])\n+AC_ARG_VAR([PKG_CONFIG], [path to pkg-config utility])dnl\n+if test \"x$ac_cv_env_PKG_CONFIG_set\" != \"xset\"; then\n+\tAC_PATH_TOOL([PKG_CONFIG], [pkg-config])\n+fi\n+if test -n \"$PKG_CONFIG\"; then\n+\t_pkg_min_version=m4_default([$1], [0.9.0])\n+\tAC_MSG_CHECKING([pkg-config is at least version $_pkg_min_version])\n+\tif $PKG_CONFIG --atleast-pkgconfig-version $_pkg_min_version; then\n+\t\tAC_MSG_RESULT([yes])\n+\telse\n+\t\tAC_MSG_RESULT([no])\n+\t\tPKG_CONFIG=\"\"\n+\tfi\n+\t\t\n+fi[]dnl\n+])# PKG_PROG_PKG_CONFIG\n+\n+# PKG_CHECK_EXISTS(MODULES, [ACTION-IF-FOUND], [ACTION-IF-NOT-FOUND])\n+#\n+# Check to see whether a particular set of modules exists.  Similar\n+# to PKG_CHECK_MODULES(), but does not set variables or print errors.\n+#\n+#\n+# Similar to PKG_CHECK_MODULES, make sure that the first instance of\n+# this or PKG_CHECK_MODULES is called, or make sure to call\n+# PKG_CHECK_EXISTS manually\n+# --------------------------------------------------------------\n+AC_DEFUN([PKG_CHECK_EXISTS],\n+[AC_REQUIRE([PKG_PROG_PKG_CONFIG])dnl\n+if test -n \"$PKG_CONFIG\" && \\\n+    AC_RUN_LOG([$PKG_CONFIG --exists --print-errors \"$1\"]); then\n+  m4_ifval([$2], [$2], [:])\n+m4_ifvaln([$3], [else\n+  $3])dnl\n+fi])\n+\n+\n+# _PKG_CONFIG([VARIABLE], [COMMAND], [MODULES])\n+# ---------------------------------------------\n+m4_define([_PKG_CONFIG],\n+[if test -n \"$PKG_CONFIG\"; then\n+    if test -n \"$$1\"; then\n+        pkg_cv_[]$1=\"$$1\"\n+    else\n+        PKG_CHECK_EXISTS([$3],\n+                         [pkg_cv_[]$1=`$PKG_CONFIG --[]$2 \"$3\" 2>/dev/null`],\n+\t\t\t [pkg_failed=yes])\n+    fi\n+else\n+\tpkg_failed=untried\n+fi[]dnl\n+])# _PKG_CONFIG\n+\n+# _PKG_SHORT_ERRORS_SUPPORTED\n+# -----------------------------\n+AC_DEFUN([_PKG_SHORT_ERRORS_SUPPORTED],\n+[AC_REQUIRE([PKG_PROG_PKG_CONFIG])\n+if $PKG_CONFIG --atleast-pkgconfig-version 0.20; then\n+        _pkg_short_errors_supported=yes\n+else\n+        _pkg_short_errors_supported=no\n+fi[]dnl\n+])# _PKG_SHORT_ERRORS_SUPPORTED\n+\n+\n+# PKG_CHECK_MODULES(VARIABLE-PREFIX, MODULES, [ACTION-IF-FOUND],\n+# [ACTION-IF-NOT-FOUND])\n+#\n+#\n+# Note that if there is a possibility the first call to\n+# PKG_CHECK_MODULES might not happen, you should be sure to include an\n+# explicit call to PKG_PROG_PKG_CONFIG in your configure.ac\n+#\n+#\n+# --------------------------------------------------------------\n+AC_DEFUN([PKG_CHECK_MODULES],\n+[AC_REQUIRE([PKG_PROG_PKG_CONFIG])dnl\n+AC_ARG_VAR([$1][_CFLAGS], [C compiler flags for $1, overriding pkg-config])dnl\n+AC_ARG_VAR([$1][_LIBS], [linker flags for $1, overriding pkg-config])dnl\n+\n+pkg_failed=no\n+AC_MSG_CHECKING([for $1])\n+\n+_PKG_CONFIG([$1][_CFLAGS], [cflags], [$2])\n+_PKG_CONFIG([$1][_LIBS], [libs], [$2])\n+\n+m4_define([_PKG_TEXT], [Alternatively, you may set the environment variables $1[]_CFLAGS\n+and $1[]_LIBS to avoid the need to call pkg-config.\n+See the pkg-config man page for more details.])\n+\n+if test $pkg_failed = yes; then\n+        _PKG_SHORT_ERRORS_SUPPORTED\n+        if test $_pkg_short_errors_supported = yes; then\n+\t        $1[]_PKG_ERRORS=`$PKG_CONFIG --short-errors --errors-to-stdout --print-errors \"$2\"`\n+        else \n+\t        $1[]_PKG_ERRORS=`$PKG_CONFIG --errors-to-stdout --print-errors \"$2\"`\n+        fi\n+\t# Put the nasty error message in config.log where it belongs\n+\techo \"$$1[]_PKG_ERRORS\" >&AS_MESSAGE_LOG_FD\n+\n+\tifelse([$4], , [AC_MSG_ERROR(dnl\n+[Package requirements ($2) were not met:\n+\n+$$1_PKG_ERRORS\n+\n+Consider adjusting the PKG_CONFIG_PATH environment variable if you\n+installed software in a non-standard prefix.\n+\n+_PKG_TEXT\n+])],\n+\t\t[AC_MSG_RESULT([no])\n+                $4])\n+elif test $pkg_failed = untried; then\n+\tifelse([$4], , [AC_MSG_FAILURE(dnl\n+[The pkg-config script could not be found or is too old.  Make sure it\n+is in your PATH or set the PKG_CONFIG environment variable to the full\n+path to pkg-config.\n+\n+_PKG_TEXT\n+\n+To get pkg-config, see .])],\n+\t\t[$4])\n+else\n+\t$1[]_CFLAGS=$pkg_cv_[]$1[]_CFLAGS\n+\t$1[]_LIBS=$pkg_cv_[]$1[]_LIBS\n+        AC_MSG_RESULT([yes])\n+\tifelse([$3], , :, [$3])\n+fi[]dnl\n+])# PKG_CHECK_MODULES\n\n=== modified file '.bzrignore'\n--- a/.bzrignore\t2007-05-01 23:24:03 +0000\n+++ b/.bzrignore\t2007-05-05 00:02:47 +0000\n@@ -189,3 +189,5 @@\n source/lib/ldb/lib\n source/lib/ldb/examples/ldbreader\n source/lib/ldb/examples/ldifreader\n+source/lib/tdb/bin/tdbbackup\n+source/lib/tdb/bin/tdbdump\n\n=== modified file 'source/auth/gensec/gensec_gssapi.c'\n--- a/source/auth/gensec/gensec_gssapi.c\t2007-04-17 03:49:46 +0000\n+++ b/source/auth/gensec/gensec_gssapi.c\t2007-05-02 09:54:06 +0000\n@@ -218,7 +218,7 @@\n \t}\n \n \t/* don't do DNS lookups of any kind, it might/will fail for a netbios name */\n-\tret = gsskrb5_set_dns_canonicalize(FALSE);\n+\tret = gsskrb5_set_dns_canonicalize(lp_parm_bool(-1, \"krb5\", \"set_dns_canonicalize\", false));\n \tif (ret) {\n \t\tDEBUG(1,(\"gensec_krb5_start: gsskrb5_set_dns_canonicalize failed\\n\"));\n \t\ttalloc_free(gensec_gssapi_state);\n\n=== modified file 'source/auth/kerberos/krb5_init_context.c'\n--- a/source/auth/kerberos/krb5_init_context.c\t2007-04-30 11:27:41 +0000\n+++ b/source/auth/kerberos/krb5_init_context.c\t2007-05-02 09:54:06 +0000\n@@ -473,7 +473,8 @@\n \n \t/* Set options in kerberos */\n \n-\tkrb5_set_dns_canonicalize_hostname((*smb_krb5_context)->krb5_context, FALSE);\n+\tkrb5_set_dns_canonicalize_hostname((*smb_krb5_context)->krb5_context,\n+\t\t\t\t\t   lp_parm_bool(-1, \"krb5\", \"set_dns_canonicalize\", false));\n \n \treturn 0;\n }\n\n=== modified file 'source/build/m4/check_ld.m4'\n--- a/source/build/m4/check_ld.m4\t2007-04-17 13:58:57 +0000\n+++ b/source/build/m4/check_ld.m4\t2007-05-04 09:35:01 +0000\n@@ -135,7 +135,8 @@\n \t\tfi\n \t\t;;\n \t*osf*)\n-\t\tBLDSHARED=\"true\"\n+\t\t# disabled because tru64 fails to link libtorture.so\n+\t\tBLDSHARED=\"false\"\n \t\tSONAMEFLAG=\"-Wl,-soname,\"\n \t\tPICFLAG=\"-fPIC\"\n \t\t;;\n\n=== modified file 'source/lib/events/events_aio.c'\n--- a/source/lib/events/events_aio.c\t2007-05-01 21:29:42 +0000\n+++ b/source/lib/events/events_aio.c\t2007-05-04 09:22:52 +0000\n@@ -250,7 +250,8 @@\n \t}\n \n \tif (ret == 0 && tvalp) {\n-\t\tcommon_event_loop_timer(aio_ev->ev);\n+\t\t/* we don't care about a possible delay here */\n+\t\tcommon_event_loop_timer_delay(aio_ev->ev);\n \t\treturn 0;\n \t}\n \n@@ -431,10 +432,8 @@\n \t\t \t\t\t\t\t   struct aio_event_context);\n \tstruct timeval tval;\n \n-\ttval = common_event_loop_delay(ev);\n-\n+\ttval = common_event_loop_timer_delay(ev);\n \tif (timeval_is_zero(&tval)) {\n-\t\tcommon_event_loop_timer(ev);\n \t\treturn 0;\n \t}\n \n\n=== modified file 'source/lib/events/events_epoll.c'\n--- a/source/lib/events/events_epoll.c\t2007-05-01 21:29:42 +0000\n+++ b/source/lib/events/events_epoll.c\t2007-05-04 09:22:52 +0000\n@@ -233,7 +233,8 @@\n \t}\n \n \tif (ret == 0 && tvalp) {\n-\t\tcommon_event_loop_timer(epoll_ev->ev);\n+\t\t/* we don't care about a possible delay here */\n+\t\tcommon_event_loop_timer_delay(epoll_ev->ev);\n \t\treturn 0;\n \t}\n \n@@ -376,10 +377,8 @@\n \t\t \t\t\t\t\t   struct epoll_event_context);\n \tstruct timeval tval;\n \n-\ttval = common_event_loop_delay(ev);\n-\n+\ttval = common_event_loop_timer_delay(ev);\n \tif (timeval_is_zero(&tval)) {\n-\t\tcommon_event_loop_timer(ev);\n \t\treturn 0;\n \t}\n \n\n=== modified file 'source/lib/events/events_internal.h'\n--- a/source/lib/events/events_internal.h\t2007-05-01 21:29:42 +0000\n+++ b/source/lib/events/events_internal.h\t2007-05-04 09:22:52 +0000\n@@ -117,8 +117,7 @@\n \n struct timed_event *common_event_add_timed(struct event_context *, TALLOC_CTX *,\n \t\t\t\t\t   struct timeval, event_timed_handler_t, void *);\n-void common_event_loop_timer(struct event_context *);\n-struct timeval common_event_loop_delay(struct event_context *);\n+struct timeval common_event_loop_timer_delay(struct event_context *);\n \n struct signal_event *common_event_add_signal(struct event_context *ev, \n \t\t\t\t\t     TALLOC_CTX *mem_ctx,\n\n=== modified file 'source/lib/events/events_select.c'\n--- a/source/lib/events/events_select.c\t2007-05-01 21:29:42 +0000\n+++ b/source/lib/events/events_select.c\t2007-05-04 09:22:52 +0000\n@@ -218,7 +218,8 @@\n \t}\n \n \tif (selrtn == 0 && tvalp) {\n-\t\tcommon_event_loop_timer(select_ev->ev);\n+\t\t/* we don't care about a possible delay here */\n+\t\tcommon_event_loop_timer_delay(select_ev->ev);\n \t\treturn 0;\n \t}\n \n@@ -252,10 +253,8 @@\n \t\t \t\t\t\t\t   struct select_event_context);\n \tstruct timeval tval;\n \n-\ttval = common_event_loop_delay(ev);\n-\n+\ttval = common_event_loop_timer_delay(ev);\n \tif (timeval_is_zero(&tval)) {\n-\t\tcommon_event_loop_timer(ev);\n \t\treturn 0;\n \t}\n \n\n=== modified file 'source/lib/events/events_standard.c'\n--- a/source/lib/events/events_standard.c\t2007-05-01 21:29:42 +0000\n+++ b/source/lib/events/events_standard.c\t2007-05-04 09:22:52 +0000\n@@ -248,7 +248,8 @@\n \t}\n \n \tif (ret == 0 && tvalp) {\n-\t\tcommon_event_loop_timer(std_ev->ev);\n+\t\t/* we don't care about a possible delay here */\n+\t\tcommon_event_loop_timer_delay(std_ev->ev);\n \t\treturn 0;\n \t}\n \n@@ -471,7 +472,8 @@\n \t}\n \n \tif (selrtn == 0 && tvalp) {\n-\t\tcommon_event_loop_timer(std_ev->ev);\n+\t\t/* we don't care about a possible delay here */\n+\t\tcommon_event_loop_timer_delay(std_ev->ev);\n \t\treturn 0;\n \t}\n \n@@ -505,10 +507,8 @@\n \t\t \t\t\t\t\t   struct std_event_context);\n \tstruct timeval tval;\n \n-\ttval = common_event_loop_delay(ev);\n-\n+\ttval = common_event_loop_timer_delay(ev);\n \tif (timeval_is_zero(&tval)) {\n-\t\tcommon_event_loop_timer(ev);\n \t\treturn 0;\n \t}\n \n\n=== modified file 'source/lib/events/events_timed.c'\n--- a/source/lib/events/events_timed.c\t2007-01-05 10:31:54 +0000\n+++ b/source/lib/events/events_timed.c\t2007-05-04 09:22:52 +0000\n@@ -68,9 +68,7 @@\n \tlast_te = NULL;\n \tfor (cur_te = ev->timed_events; cur_te; cur_te = cur_te->next) {\n \t\t/* if the new event comes before the current one break */\n-\t\tif (!timeval_is_zero(&cur_te->next_event) &&\n-\t\t    timeval_compare(&te->next_event,\n-\t\t\t\t    &cur_te->next_event) < 0) {\n+\t\tif (timeval_compare(&te->next_event, &cur_te->next_event) < 0) {\n \t\t\tbreak;\n \t\t}\n \n@@ -85,16 +83,46 @@\n }\n \n /*\n-  a timer has gone off - call it\n+  do a single event loop using the events defined in ev\n+\n+  return the delay untill the next timed event,\n+  or zero if a timed event was triggered\n */\n-void common_event_loop_timer(struct event_context *ev)\n+struct timeval common_event_loop_timer_delay(struct event_context *ev)\n {\n-\tstruct timeval t = timeval_current();\n+\tstruct timeval current_time = timeval_zero();\n \tstruct timed_event *te = ev->timed_events;\n \n-\tif (te == NULL) {\n-\t\treturn;\n-\t}\n+\tif (!te) {\n+\t\t/* have a default tick time of 30 seconds. This guarantees\n+\t\t   that code that uses its own timeout checking will be\n+\t\t   able to proceeed eventually */\n+\t\treturn timeval_set(30, 0);\n+\t}\n+\n+\t/*\n+\t * work out the right timeout for the next timed event\n+\t *\n+\t * avoid the syscall to gettimeofday() if the timed event should\n+\t * be triggered directly\n+\t *\n+\t * if there's a delay till the next timed event, we're done\n+\t * with just returning the delay\n+\t */\n+\tif (!timeval_is_zero(&te->next_event)) {\n+\t\tstruct timeval delay;\n+\n+\t\tcurrent_time = timeval_current();\n+\n+\t\tdelay = timeval_until(&current_time, &te->next_event);\n+\t\tif (!timeval_is_zero(&delay)) {\n+\t\t\treturn delay;\n+\t\t}\n+\t}\n+\n+\t/*\n+\t * ok, we have a timed event that we'll process ...\n+\t */\n \n \t/* deny the handler to free the event */\n \ttalloc_set_destructor(te, common_event_timed_deny_destructor);\n@@ -104,33 +132,21 @@\n \t * handler we don't want to come across this event again -- vl */\n \tDLIST_REMOVE(ev->timed_events, te);\n \n-\tte->handler(ev, te, t, te->private_data);\n+\t/*\n+\t * If the timed event was registered for a zero current_time,\n+\t * then we pass a zero timeval here too! To avoid the\n+\t * overhead of gettimeofday() calls.\n+\t *\n+\t * otherwise we pass the current time\n+\t */\n+\tte->handler(ev, te, current_time, te->private_data);\n \n \t/* The destructor isn't necessary anymore, we've already removed the\n \t * event from the list. */\n \ttalloc_set_destructor(te, NULL);\n \n \ttalloc_free(te);\n-}\n-\n-/*\n-  do a single event loop using the events defined in ev \n-*/\n-struct timeval common_event_loop_delay(struct event_context *ev)\n-{\n-\tstruct timeval tval;\n-\n-\t/* work out the right timeout for all timed events */\n-\tif (ev->timed_events) {\n-\t\tstruct timeval t = timeval_current();\n-\t\ttval = timeval_until(&t, &ev->timed_events->next_event);\n-\t} else {\n-\t\t/* have a default tick time of 30 seconds. This guarantees\n-\t\t   that code that uses its own timeout checking will be\n-\t\t   able to proceeed eventually */\n-\t\ttval = timeval_set(30, 0);\n-\t}\n-\t\n-\treturn tval;\n+\n+\treturn timeval_zero();\n }\n \n\n=== modified file 'source/lib/ldb/autogen.sh'\n--- a/source/lib/ldb/autogen.sh\t2006-09-05 23:32:35 +0000\n+++ b/source/lib/ldb/autogen.sh\t2007-05-02 22:05:48 +0000\n@@ -7,6 +7,11 @@\n IPATHS=\"$IPATHS -I lib/talloc -I talloc -I ../talloc\"\n IPATHS=\"$IPATHS -I lib/tdb -I tdb -I ../tdb\"\n IPATHS=\"$IPATHS -I lib/popt -I popt -I ../popt\"\n+\n+# Always keep this listed last, so the built-in versions of tdb and talloc\n+# get used if available.\n+IPATHS=\"$IPATHS -I ./external\"\n+\n autoheader $IPATHS || exit 1\n autoconf $IPATHS || exit 1\n \n\n=== modified file 'source/lib/ldb/configure.ac'\n--- a/source/lib/ldb/configure.ac\t2007-04-30 08:08:36 +0000\n+++ b/source/lib/ldb/configure.ac\t2007-05-04 11:08:53 +0000\n@@ -11,7 +11,7 @@\n AC_DEFUN([SMB_LIBRARY_ENABLE], [echo -n \"\"])\n AC_DEFUN([SMB_EXT_LIB], [echo -n \"\"])\n AC_DEFUN([SMB_ENABLE], [echo -n \"\"])\n-AC_INIT(ldb, 1.0)\n+AC_INIT(ldb, 0.9.0)\n AC_CONFIG_SRCDIR([common/ldb.c])\n \n AC_LIBREPLACE_ALL_CHECKS\n\n=== modified file 'source/lib/ldb/include/includes.h'\n--- a/source/lib/ldb/include/includes.h\t2007-04-15 21:13:13 +0000\n+++ b/source/lib/ldb/include/includes.h\t2007-05-02 22:05:48 +0000\n@@ -20,7 +20,7 @@\n #include \"system/filesys.h\"\n #include \"system/network.h\"\n #include \"system/time.h\"\n-#include \"talloc/talloc.h\"\n+#include \"talloc.h\"\n #include \"ldb.h\"\n #include \"ldb_errors.h\"\n #include \"ldb_private.h\"\n\n=== modified file 'source/lib/replace/autoconf-2.60.m4'\n--- a/source/lib/replace/autoconf-2.60.m4\t2007-04-23 11:41:38 +0000\n+++ b/source/lib/replace/autoconf-2.60.m4\t2007-05-05 00:02:47 +0000\n@@ -1,3 +1,16 @@\n+# AC_GNU_SOURCE\n+# --------------\n+AC_DEFUN([AC_GNU_SOURCE],\n+[AH_VERBATIM([_GNU_SOURCE],\n+[/* Enable GNU extensions on systems that have them.  */\n+#ifndef _GNU_SOURCE\n+# undef _GNU_SOURCE\n+#endif])dnl\n+AC_BEFORE([$0], [AC_COMPILE_IFELSE])dnl\n+AC_BEFORE([$0], [AC_RUN_IFELSE])dnl\n+AC_DEFINE([_GNU_SOURCE])\n+])\n+\n # _AC_C_STD_TRY(STANDARD, TEST-PROLOGUE, TEST-BODY, OPTION-LIST,\n #\t\tACTION-IF-AVAILABLE, ACTION-IF-UNAVAILABLE)\n # --------------------------------------------------------------\n\n=== modified file 'source/lib/replace/test/testsuite.c'\n--- a/source/lib/replace/test/testsuite.c\t2007-04-16 19:55:51 +0000\n+++ b/source/lib/replace/test/testsuite.c\t2007-05-04 06:59:02 +0000\n@@ -511,7 +511,7 @@\n \t\t       \"\\tptr: %p - %p = %d != %d\\n\" \\\n \t\t       \"]\\n\", \\\n \t\t       __STRING(func), __location__, __STRING(func), \\\n-\t\t       str, diff, base, res, _v, _ep, _p, diff - (_ep - _p), diff); \\\n+\t\t       str, diff, base, res, _v, _ep, _p, (int)(diff - (_ep - _p)), diff); \\\n \t\treturn false; \\\n \t} \\\n } while (0)\n\n=== modified file 'source/lib/tdb/Makefile.in'\n--- a/source/lib/tdb/Makefile.in\t2007-04-30 10:49:42 +0000\n+++ b/source/lib/tdb/Makefile.in\t2007-05-02 16:09:33 +0000\n@@ -19,8 +19,8 @@\n \n .PHONY: test\n \n-PROGS = bin/tdbtool$(EXEEXT) bin/tdbtorture$(EXEEXT)\n-PROGS_NOINSTALL = bin/tdbtest$(EXEEXT) bin/tdbdump$(EXEEXT) bin/tdbbackup$(EXEEXT)\n+PROGS = bin/tdbtool$(EXEEXT) bin/tdbdump$(EXEEXT) bin/tdbbackup$(EXEEXT)\n+PROGS_NOINSTALL = bin/tdbtest$(EXEEXT) bin/tdbtorture$(EXEEXT)\n ALL_PROGS = $(PROGS) $(PROGS_NOINSTALL)\n \n TDB_OBJ = @TDB_OBJ@ @LIBREPLACEOBJ@\n\n=== modified file 'source/lib/tdb/configure.ac'\n--- a/source/lib/tdb/configure.ac\t2007-04-30 08:08:36 +0000\n+++ b/source/lib/tdb/configure.ac\t2007-05-02 16:09:33 +0000\n@@ -2,7 +2,7 @@\n AC_DEFUN([SMB_MODULE_DEFAULT], [echo -n \"\"])\n AC_DEFUN([SMB_LIBRARY_ENABLE], [echo -n \"\"])\n AC_DEFUN([SMB_ENABLE], [echo -n \"\"])\n-AC_INIT(tdb, 1.1)\n+AC_INIT(tdb, 1.1.0)\n AC_CONFIG_SRCDIR([common/tdb.c])\n AC_CONFIG_HEADER(include/config.h)\n AC_LIBREPLACE_ALL_CHECKS\n\n=== modified file 'source/libnet/libnet_passwd.c'\n--- a/source/libnet/libnet_passwd.c\t2006-11-28 17:30:43 +0000\n+++ b/source/libnet/libnet_passwd.c\t2007-05-04 11:26:25 +0000\n@@ -644,6 +644,7 @@\n \tr2.samr_handle.in.newpassword\t= r->samr.in.newpassword;\n \tr2.samr_handle.in.user_handle   = &u_handle;\n \tr2.samr_handle.in.dcerpc_pipe   = c.out.dcerpc_pipe;\n+\tr2.samr_handle.in.info21\t= NULL;\n \n \tstatus = libnet_SetPassword(ctx, mem_ctx, &r2);\n \n\n=== modified file 'source/libnet/libnet_rpc.c'\n--- a/source/libnet/libnet_rpc.c\t2006-11-28 21:01:10 +0000\n+++ b/source/libnet/libnet_rpc.c\t2007-05-04 18:59:51 +0000\n@@ -57,15 +57,13 @@\n \tstruct composite_context *pipe_connect_req;\n \n \t/* composite context allocation and setup */\n-\tc = talloc_zero(mem_ctx, struct composite_context);\n-\tif (c == NULL) return NULL;\n+\tc = composite_create(ctx, ctx->event_ctx);\n+\tif (c == NULL) return c;\n \n \ts = talloc_zero(c, struct rpc_connect_srv_state);\n \tif (composite_nomem(s, c)) return c;\n \n-\tc->state = COMPOSITE_STATE_IN_PROGRESS;\n \tc->private_data = s;\n-\tc->event_ctx = ctx->event_ctx;\n \n \ts->ctx = ctx;\n \ts->r = *r;\n@@ -218,15 +216,13 @@\n \tstruct composite_context *lookup_dc_req;\n \n \t/* composite context allocation and setup */\n-\tc = talloc_zero(mem_ctx, struct composite_context);\n-\tif (c == NULL) return NULL;\n+\tc = composite_create(ctx, ctx->event_ctx);\n+\tif (c == NULL) return c;\n \n \ts = talloc_zero(c, struct rpc_connect_dc_state);\n \tif (composite_nomem(s, c)) return c;\n \n-\tc->state = COMPOSITE_STATE_IN_PROGRESS;\n \tc->private_data = s;\n-\tc->event_ctx = ctx->event_ctx;\n \n \ts->ctx = ctx;\n \ts->r   = *r;\n@@ -433,15 +429,13 @@\n \tstruct rpc_connect_dci_state *s;\n \n \t/* composite context allocation and setup */\n-\tc = talloc_zero(mem_ctx, struct composite_context);\n-\tif (c == NULL) return NULL;\n+\tc = composite_create(ctx, ctx->event_ctx);\n+\tif (c == NULL) return c;\n \n \ts = talloc_zero(c, struct rpc_connect_dci_state);\n \tif (composite_nomem(s, c)) return c;\n \n-\tc->state = COMPOSITE_STATE_IN_PROGRESS;\n \tc->private_data = s;\n-\tc->event_ctx = ctx->event_ctx;\n \n \ts->ctx = ctx;\n \ts->r   = *r;\n\n=== modified file 'source/torture/raw/notify.c'\n--- a/source/torture/raw/notify.c\t2007-02-02 17:30:10 +0000\n+++ b/source/torture/raw/notify.c\t2007-05-04 12:41:28 +0000\n@@ -55,7 +55,8 @@\n /* \n    basic testing of change notify on directories\n */\n-static BOOL test_notify_dir(struct smbcli_state *cli, TALLOC_CTX *mem_ctx)\n+static BOOL test_notify_dir(struct smbcli_state *cli, struct smbcli_state *cli2, \n+\t\t\t    TALLOC_CTX *mem_ctx)\n {\n \tBOOL ret = True;\n \tNTSTATUS status;\n@@ -110,7 +111,7 @@\n \tprintf(\"testing notify mkdir\\n\");\n \n \treq = smb_raw_changenotify_send(cli->tree, &notify);\n-\tsmbcli_mkdir(cli->tree, BASEDIR \"\\\\subdir-name\");\n+\tsmbcli_mkdir(cli2->tree, BASEDIR \"\\\\subdir-name\");\n \n \tstatus = smb_raw_changenotify_recv(req, mem_ctx, &notify);\n \tCHECK_STATUS(status, NT_STATUS_OK);\n@@ -122,7 +123,7 @@\n \tprintf(\"testing notify rmdir\\n\");\n \n \treq = smb_raw_changenotify_send(cli->tree, &notify);\n-\tsmbcli_rmdir(cli->tree, BASEDIR \"\\\\subdir-name\");\n+\tsmbcli_rmdir(cli2->tree, BASEDIR \"\\\\subdir-name\");\n \n \tstatus = smb_raw_changenotify_recv(req, mem_ctx, &notify);\n \tCHECK_STATUS(status, NT_STATUS_OK);\n@@ -132,10 +133,10 @@\n \n \tprintf(\"testing notify mkdir - rmdir - mkdir - rmdir\\n\");\n \n-\tsmbcli_mkdir(cli->tree, BASEDIR \"\\\\subdir-name\");\n-\tsmbcli_rmdir(cli->tree, BASEDIR \"\\\\subdir-name\");\n-\tsmbcli_mkdir(cli->tree, BASEDIR \"\\\\subdir-name\");\n-\tsmbcli_rmdir(cli->tree, BASEDIR \"\\\\subdir-name\");\n+\tsmbcli_mkdir(cli2->tree, BASEDIR \"\\\\subdir-name\");\n+\tsmbcli_rmdir(cli2->tree, BASEDIR \"\\\\subdir-name\");\n+\tsmbcli_mkdir(cli2->tree, BASEDIR \"\\\\subdir-name\");\n+\tsmbcli_rmdir(cli2->tree, BASEDIR \"\\\\subdir-name\");\n \treq = smb_raw_changenotify_send(cli->tree, &notify);\n \tstatus = smb_raw_changenotify_recv(req, mem_ctx, &notify);\n \tCHECK_STATUS(status, NT_STATUS_OK);\n@@ -174,11 +175,14 @@\n \tnotify.nttrans.in.file.fnum = fnum;\n \treq = smb_raw_changenotify_send(cli->tree, &notify);\n \n+\tstatus = smbcli_unlink(cli->tree, BASEDIR \"\\\\nonexistant.txt\");\n+\tCHECK_STATUS(status, NT_STATUS_OBJECT_NAME_NOT_FOUND);\n+\n \t/* (1st unlink) as the 2nd notify directly returns,\n \t   this unlink is only seen by the 1st notify and \n \t   the 3rd notify (later) */\n \tprintf(\"testing notify on unlink for the first file\\n\");\n-\tstatus = smbcli_unlink(cli->tree, BASEDIR \"\\\\test0.txt\");\n+\tstatus = smbcli_unlink(cli2->tree, BASEDIR \"\\\\test0.txt\");\n \tCHECK_STATUS(status, NT_STATUS_OK);\n \n \t/* receive the reply from the 2nd notify */\n@@ -186,24 +190,27 @@\n \tCHECK_STATUS(status, NT_STATUS_OK);\n \n \tCHECK_VAL(notify.nttrans.out.num_changes, count);\n-\tfor (i=1;itree, &notify);\n \n+\tstatus = smbcli_unlink(cli->tree, BASEDIR \"\\\\nonexistant.txt\");\n+\tCHECK_STATUS(status, NT_STATUS_OBJECT_NAME_NOT_FOUND);\n+\n \tprintf(\"testing notify on wildcard unlink for %d files\\n\", count-1);\n \t/* (2nd unlink) do a wildcard unlink */\n-\tstatus = smbcli_unlink(cli->tree, BASEDIR \"\\\\test*.txt\");\n+\tstatus = smbcli_unlink(cli2->tree, BASEDIR \"\\\\test*.txt\");\n \tCHECK_STATUS(status, NT_STATUS_OK);\n \n \t/* receive the 3rd notify */\n@@ -1149,13 +1156,16 @@\n */\n BOOL torture_raw_notify(struct torture_context *torture)\n {\n-\tstruct smbcli_state *cli;\n+\tstruct smbcli_state *cli, *cli2;\n \tBOOL ret = True;\n \tTALLOC_CTX *mem_ctx;\n \t\t\n \tif (!torture_open_connection(&cli, 0)) {\n \t\treturn False;\n \t}\n+\tif (!torture_open_connection(&cli2, 0)) {\n+\t\treturn False;\n+\t}\n \n \tmem_ctx = talloc_init(\"torture_raw_notify\");\n \n@@ -1163,7 +1173,7 @@\n \t\treturn False;\n \t}\n \n-\tret &= test_notify_dir(cli, mem_ctx);\n+\tret &= test_notify_dir(cli, cli2, mem_ctx);\n \tret &= test_notify_mask(cli, mem_ctx);\n \tret &= test_notify_recursive(cli, mem_ctx);\n \tret &= test_notify_file(cli, mem_ctx);\n@@ -1177,6 +1187,7 @@\n \tsmb_raw_exit(cli->session);\n \tsmbcli_deltree(cli->tree, BASEDIR);\n \ttorture_close_connection(cli);\n+\ttorture_close_connection(cli2);\n \ttalloc_free(mem_ctx);\n \treturn ret;\n }\n\n"}