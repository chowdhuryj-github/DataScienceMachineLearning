{"category": "ham", "to_address": "Julien Cristau <jcristau@debian.org>", "from_address": "James Peach <jpeach@samba.org>", "subject": "Re: [patch] hide libsmbclient's private symbols", "body": "On Jun 18, 2007, at 3:52 AM, Julien Cristau wrote:\n\n> Hi,\n>\n> the following patch (against samba 3.0.25a) makes the build system  \n> use a\n> version script if it detects a recent enough gnu ld.  This makes\n> libsmbclient export about 50 symbols instead of about 4000, which\n> reduces the risk of symbols clashes due to private symbols which  \n> aren't\n> part of the API and have no business being exported.  The detection is\n> probably not optimal, but I think it's safe (support for version  \n> scripts\n> seems to have been added in 2002, before gnu ld 2.12).  Feedback\n> welcome.\n\nThis seems like a generally useful idea. I'd be pretty keen to see  \nthis make a bit more generic, so that we can have a single build rule  \nthat will build all the shared libraries.\n\nThe rules might look like this for a gcc-based toolchain. The only  \nproblem remaining is how to express the DSO version number in a  \ngeneric way.\n\nDSO_EXPORTS = -Wl,--version-script,exports/`basename $@ | sed -e/ \n@SHLIBEXT@/syms/`\nSHLD_DSO = $(SHLD) $(LDSHFLAGS) $(DSO_EXPORTS) \\\n\t@SONAMEFLAG@`basename $@`.$(XXXXXX_MAJOR)\n\nbin/libsmbclient.@SHLIBEXT@: $(BINARY_PREREQS) $(LIBSMBCLIENT_OBJ)\n\t@echo Linking libsmbclient shared library $@\n\t@$(SHLD_DSO) $(LIBSMBCLIENT_OBJ) $(LIBS) $(KRB5LIBS) $(LDAP_LIBS) $ \n(NSCD_LIBS)\n\nActually, thinking about this a bit more, it might be better for the  \nexports files to be a simple list of symbols (though I think most  \ntoolchains support wildcard matching). It's easier to generate the GNU/ \nSun syntax from a simple list, than it is to go the other way round.\n\n>\n>\n> Cheers,\n> Julien\n>\n> Index: samba-3.0.25a/source/Makefile.in\n> ===================================================================\n> --- samba-3.0.25a.orig/source/Makefile.in\t2007-06-08  \n> 23:36:12.000000000 +0200\n> +++ samba-3.0.25a/source/Makefile.in\t2007-06-08 23:36:12.000000000  \n> +0200\n> @@ -1163,6 +1163,7 @@\n> \t@echo Linking libsmbclient shared library $@\n> \t@$(SHLD) $(LDSHFLAGS) -Wl,-z,defs -o $@ $(LIBSMBCLIENT_OBJ) $(LIBS) \\\n> \t\t$(KRB5LIBS) $(LDAP_LIBS) $(NSCD_LIBS) \\\n> +\t\t@VERSIONLDFLAGS@ \\\n> \t\t@SONAMEFLAG@`basename $@`.$(LIBSMBCLIENT_MAJOR)\n>\n> bin/libsmbclient.a: proto_exists $(LIBSMBCLIENT_OBJ)\n> Index: samba-3.0.25a/source/configure.in\n> ===================================================================\n> --- samba-3.0.25a.orig/source/configure.in\t2007-06-08  \n> 23:36:12.000000000 +0200\n> +++ samba-3.0.25a/source/configure.in\t2007-06-08 23:36:36.000000000  \n> +0200\n> @@ -267,6 +267,7 @@\n> AC_SUBST(SHELL)\n> AC_SUBST(LDSHFLAGS)\n> AC_SUBST(SONAMEFLAG)\n> +AC_SUBST(VERSIONLDFLAGS)\n> AC_SUBST(SHLD)\n> AC_SUBST(HOST_OS)\n> AC_SUBST(PICFLAG)\n> @@ -456,6 +457,9 @@\n>  \tif test \"$ac_cv_gnu_ld_date\" -lt 20030217; then\n>  \t\tac_cv_gnu_ld_no_default_allow_shlib_undefined=yes\n>  \tfi\n> +\tif test \"$ac_cv_gnu_ld_date\" -gt 20030101; then\n> +\t\tac_cv_gnu_ld_version_script=yes\n> +\tfi\n>         else\n>            AC_MSG_CHECKING(GNU ld release version)\n>            changequote(,)dnl\n> @@ -471,6 +475,9 @@\n>            if test \"$ac_cv_gnu_ld_vernr_major\" -lt 2 || test  \n> \"$ac_cv_gnu_ld_vernr_minor\" -lt 14; then\n>              ac_cv_gnu_ld_no_default_allow_shlib_undefined=yes\n>            fi\n> +           if test \"$ac_cv_gnu_ld_vernr_major\" -gt 2 || test  \n> \"$ac_cv_gnu_ld_vernr_major\" = 2 && test \"$ac_cv_gnu_ld_vernr_minor\" - \n> ge 12; then\n> +             ac_cv_gnu_ld_version_script=yes\n> +           fi\n>         fi\n> fi\n>\n> @@ -1703,6 +1710,9 @@\n> \t\t\tDYNEXP=\"-Wl,--export-dynamic\"\n> \t\t\tPICFLAG=\"-fPIC\"\n> \t\t\tSONAMEFLAG=\"-Wl,-soname=\"\n> +\t\t\tif test \"${ac_cv_gnu_ld_version_script}\" = yes; then\n> +\t\t\t\tVERSIONLDFLAGS=\"-Wl,--version-script,libsmb/libsmbclient.syms\"\n> +\t\t\tfi\n> \t\t\tAC_DEFINE(STAT_ST_BLOCKSIZE,512)\n> \t\t\t;;\n> \t\t*solaris*) AC_DEFINE(SUNOS5,1,[Whether the host os is solaris])\n> Index: samba-3.0.25a/source/libsmb/libsmbclient.syms\n> ===================================================================\n> --- /dev/null\t1970-01-01 00:00:00.000000000 +0000\n> +++ samba-3.0.25a/source/libsmb/libsmbclient.syms\t2007-06-08  \n> 23:36:12.000000000 +0200\n> @@ -0,0 +1,4 @@\n> +{\n> +\tglobal: smbc_*;\n> +\tlocal: *;\n> +};\n\n--\nJames Peach | jpeach@samba.org\n\n"}