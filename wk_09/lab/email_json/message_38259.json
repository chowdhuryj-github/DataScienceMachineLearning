{"category": "ham", "to_address": "samba-cvs@samba.org", "from_address": "jerry@samba.org", "subject": "svn commit: samba r23200 - in branches/SAMBA_3_0_26/source: libads\n\tnmbd", "body": "Author: jerry\nDate: 2007-05-29 14:26:27 +0000 (Tue, 29 May 2007)\nNew Revision: 23200\n\nWebSVN: http://websvn.samba.org/cgi-bin/viewcvs.cgi?view=rev&root=samba&rev=23200\n\nLog:\nMore merge's:\n\n* A little const\n* Metze's fix for GSS-SPNEGO against Win2k3\n\n\nModified:\n   branches/SAMBA_3_0_26/source/libads/sasl.c\n   branches/SAMBA_3_0_26/source/nmbd/nmbd_lmhosts.c\n\n\nChangeset:\nModified: branches/SAMBA_3_0_26/source/libads/sasl.c\n===================================================================\n--- branches/SAMBA_3_0_26/source/libads/sasl.c\t2007-05-29 14:19:53 UTC (rev 23199)\n+++ branches/SAMBA_3_0_26/source/libads/sasl.c\t2007-05-29 14:26:27 UTC (rev 23200)\n@@ -441,7 +441,8 @@\n \n \tgss_release_buffer(&minor_status, &output_token);\n \n-\toutput_token.value = SMB_MALLOC(strlen(ads->config.bind_path) + 8);\n+\toutput_token.length = 4;\n+\toutput_token.value = SMB_MALLOC(output_token.length);\n \tp = (uint8 *)output_token.value;\n \n \t*p++ = 1; /* no sign & seal selection */\n@@ -449,11 +450,15 @@\n \t*p++ = max_msg_size>>16;\n \t*p++ = max_msg_size>>8;\n \t*p++ = max_msg_size;\n-\tsnprintf((char *)p, strlen(ads->config.bind_path)+4, \"dn:%s\", ads->config.bind_path);\n-\tp += strlen((const char *)p);\n+\t/*\n+\t * we used to add sprintf(\"dn:%s\", ads->config.bind_path) here.\n+\t * but using ads->config.bind_path is the wrong! It should be\n+\t * the DN of the user object!\n+\t *\n+\t * w2k3 gives an error when we send an incorrect DN, but sending nothing\n+\t * is ok and matches the information flow used in GSS-SPNEGO.\n+\t */\n \n-\toutput_token.length = PTR_DIFF(p, output_token.value);\n-\n \tgss_rc = gss_wrap(&minor_status, context_handle,0,GSS_C_QOP_DEFAULT,\n \t\t\t  &output_token, (int *)&conf_state,\n \t\t\t  &input_token);\n\nModified: branches/SAMBA_3_0_26/source/nmbd/nmbd_lmhosts.c\n===================================================================\n--- branches/SAMBA_3_0_26/source/nmbd/nmbd_lmhosts.c\t2007-05-29 14:19:53 UTC (rev 23199)\n+++ branches/SAMBA_3_0_26/source/nmbd/nmbd_lmhosts.c\t2007-05-29 14:26:27 UTC (rev 23200)\n@@ -29,7 +29,7 @@\n Load a lmhosts file.\n ****************************************************************************/\n \n-void load_lmhosts_file(char *fname)\n+void load_lmhosts_file(const char *fname)\n {  \n \tpstring name;\n \tint name_type;\n\n"}