{"category": "ham", "to_address": "samba-cvs@samba.org", "from_address": "Michael Adam <ma@sernet.de>", "subject": "Rev 5349: open registry tdb with sequence number. preparation to\n\tloadparm integration of registry global smb.conf optins: this\n\tallows to detect changes in order to trigger reload. in\n\thttp://samba.sernet.de/ma/bzr/SAMBA_3_0-registry.bzr/", "body": "At http://samba.sernet.de/ma/bzr/SAMBA_3_0-registry.bzr/\n\n------------------------------------------------------------\nrevno: 5349\nrevision-id: ma@sernet.de-20070411144102-b41fdc630c352740\nparent: ma@sernet.de-20070411143428-49f14e3085db5e99\ncommitter: Michael Adam \nbranch nick: SAMBA_3_0-registry.bzr\ntimestamp: Wed 2007-04-11 16:41:02 +0200\nmessage:\n  open registry tdb with sequence number. preparation to loadparm integration of registry global smb.conf optins: this allows to detect changes in order to trigger reload.\nmodified:\n  source/registry/reg_db.c       reg_db.c-20060530022627-e9a827257fb89131\n=== modified file 'source/registry/reg_db.c'\n--- a/source/registry/reg_db.c\t2007-03-30 15:43:31 +0000\n+++ b/source/registry/reg_db.c\t2007-04-11 14:41:02 +0000\n@@ -31,6 +31,8 @@\n #define VALUE_PREFIX\t\"SAMBA_REGVAL\"\n #define SECDESC_PREFIX  \"SAMBA_SECDESC\"\n \n+#define REG_TDB_FLAGS TDB_SEQNUM\n+\n /* List the deepest path into the registry.  All part components will be created.*/\n \n /* If you want to have a part of the path controlled by the tdb and part by\n@@ -236,9 +238,9 @@\n \tif ( tdb_reg )\n \t\treturn True;\n \n-\tif ( !(tdb_reg = tdb_open_log(lock_path(\"registry.tdb\"), 0, TDB_DEFAULT, O_RDWR, 0600)) )\n+\tif ( !(tdb_reg = tdb_open_log(lock_path(\"registry.tdb\"), 0, REG_TDB_FLAGS, O_RDWR, 0600)) )\n \t{\n-\t\ttdb_reg = tdb_open_log(lock_path(\"registry.tdb\"), 0, TDB_DEFAULT, O_RDWR|O_CREAT, 0600);\n+\t\ttdb_reg = tdb_open_log(lock_path(\"registry.tdb\"), 0, REG_TDB_FLAGS, O_RDWR|O_CREAT, 0600);\n \t\tif ( !tdb_reg ) {\n \t\t\tDEBUG(0,(\"regdb_init: Failed to open registry %s (%s)\\n\",\n \t\t\t\tlock_path(\"registry.tdb\"), strerror(errno) ));\n@@ -283,7 +285,7 @@\n \t\n \tbecome_root();\n \n-\ttdb_reg = tdb_open_log(lock_path(\"registry.tdb\"), 0, TDB_DEFAULT, O_RDWR, 0600);\n+\ttdb_reg = tdb_open_log(lock_path(\"registry.tdb\"), 0, REG_TDB_FLAGS, O_RDWR, 0600);\n \tif ( !tdb_reg ) {\n \t\tresult = ntstatus_to_werror( map_nt_error_from_unix( errno ) );\n \t\tDEBUG(0,(\"regdb_open: Failed to open %s! (%s)\\n\", \n\n"}