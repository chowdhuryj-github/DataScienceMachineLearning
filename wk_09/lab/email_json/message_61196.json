{"category": "ham", "to_address": "samba-cvs@samba.org", "from_address": "idra@samba.org", "subject": "svn commit: samba r23682 - in branches: SAMBA_3_0/source/smbd\n\tSAMBA_3_0_26/source/smbd", "body": "Author: idra\nDate: 2007-07-03 13:07:56 +0000 (Tue, 03 Jul 2007)\nNew Revision: 23682\n\nWebSVN: http://websvn.samba.org/cgi-bin/viewcvs.cgi?view=rev&root=samba&rev=23682\n\nLog:\n\nOld patch I forgot in one of my 3.0.25 trees.\nMake sure we honour the directive not to allow machine password changes.\n\n\nModified:\n   branches/SAMBA_3_0/source/smbd/chgpasswd.c\n   branches/SAMBA_3_0_26/source/smbd/chgpasswd.c\n\n\nChangeset:\nModified: branches/SAMBA_3_0/source/smbd/chgpasswd.c\n===================================================================\n--- branches/SAMBA_3_0/source/smbd/chgpasswd.c\t2007-07-03 08:22:24 UTC (rev 23681)\n+++ branches/SAMBA_3_0/source/smbd/chgpasswd.c\t2007-07-03 13:07:56 UTC (rev 23682)\n@@ -1019,6 +1019,7 @@\n NTSTATUS change_oem_password(struct samu *hnd, char *old_passwd, char *new_passwd, BOOL as_root, uint32 *samr_reject_reason)\n {\n \tuint32 min_len;\n+\tuint32 refuse;\n \tstruct passwd *pass = NULL;\n \tconst char *username = pdb_get_username(hnd);\n \ttime_t can_change_time = pdb_get_pass_can_change_time(hnd);\n@@ -1036,6 +1037,21 @@\n \t\treturn NT_STATUS_ACCOUNT_RESTRICTION;\n \t}\n \n+\t/* check to see if it is a Machine account and if the policy\n+\t * denies machines to change the password. *\n+\t * Should we deny also SRVTRUST and/or DOMSTRUST ? .SSS. */\n+\tif (pdb_get_acct_ctrl(hnd) & ACB_WSTRUST) {\n+\t\tif (pdb_get_account_policy(AP_REFUSE_MACHINE_PW_CHANGE, &refuse) && refuse) {\n+\t\t\tDEBUG(1, (\"Machine %s cannot change password now, \"\n+\t\t\t\t  \"denied by Refuse Machine Password Change policy\\n\",\n+\t\t\t\t  username));\n+\t\t\tif (samr_reject_reason) {\n+\t\t\t\t*samr_reject_reason = REJECT_REASON_OTHER;\n+\t\t\t}\n+\t\t\treturn NT_STATUS_ACCOUNT_RESTRICTION;\n+\t\t}\n+\t}\n+\n \t/* removed calculation here, becuase passdb now calculates\n \t   based on policy.  jmcd */\n \tif ((can_change_time != 0) && (time(NULL) < can_change_time)) {\n\nModified: branches/SAMBA_3_0_26/source/smbd/chgpasswd.c\n===================================================================\n--- branches/SAMBA_3_0_26/source/smbd/chgpasswd.c\t2007-07-03 08:22:24 UTC (rev 23681)\n+++ branches/SAMBA_3_0_26/source/smbd/chgpasswd.c\t2007-07-03 13:07:56 UTC (rev 23682)\n@@ -1019,6 +1019,7 @@\n NTSTATUS change_oem_password(struct samu *hnd, char *old_passwd, char *new_passwd, BOOL as_root, uint32 *samr_reject_reason)\n {\n \tuint32 min_len;\n+\tuint32 refuse;\n \tstruct passwd *pass = NULL;\n \tconst char *username = pdb_get_username(hnd);\n \ttime_t can_change_time = pdb_get_pass_can_change_time(hnd);\n@@ -1036,6 +1037,21 @@\n \t\treturn NT_STATUS_ACCOUNT_RESTRICTION;\n \t}\n \n+\t/* check to see if it is a Machine account and if the policy\n+\t * denies machines to change the password. *\n+\t * Should we deny also SRVTRUST and/or DOMSTRUST ? .SSS. */\n+\tif (pdb_get_acct_ctrl(hnd) & ACB_WSTRUST) {\n+\t\tif (pdb_get_account_policy(AP_REFUSE_MACHINE_PW_CHANGE, &refuse) && refuse) {\n+\t\t\tDEBUG(1, (\"Machine %s cannot change password now, \"\n+\t\t\t\t  \"denied by Refuse Machine Password Change policy\\n\",\n+\t\t\t\t  username));\n+\t\t\tif (samr_reject_reason) {\n+\t\t\t\t*samr_reject_reason = REJECT_REASON_OTHER;\n+\t\t\t}\n+\t\t\treturn NT_STATUS_ACCOUNT_RESTRICTION;\n+\t\t}\n+\t}\n+\n \t/* removed calculation here, becuase passdb now calculates\n \t   based on policy.  jmcd */\n \tif ((can_change_time != 0) && (time(NULL) < can_change_time)) {\n\n"}