{"category": "ham", "to_address": "samba-cvs@samba.org", "from_address": "metze@samba.org", "subject": "svn commit: samba r22454 - in\n\tbranches/SAMBA_4_0/source/heimdal_build: .", "body": "Author: metze\nDate: 2007-04-22 11:28:12 +0000 (Sun, 22 Apr 2007)\nNew Revision: 22454\n\nWebSVN: http://websvn.samba.org/cgi-bin/viewcvs.cgi?view=rev&root=samba&rev=22454\n\nLog:\n- let asn1_deps.pl calculate the dependencies depending on the IMPORT line in the asn1 file\n- fix some heimdal dependencies\n\nmetze\nModified:\n   branches/SAMBA_4_0/source/heimdal_build/asn1_deps.pl\n   branches/SAMBA_4_0/source/heimdal_build/config.mk\n\n\nChangeset:\nModified: branches/SAMBA_4_0/source/heimdal_build/asn1_deps.pl\n===================================================================\n--- branches/SAMBA_4_0/source/heimdal_build/asn1_deps.pl\t2007-04-22 10:42:33 UTC (rev 22453)\n+++ branches/SAMBA_4_0/source/heimdal_build/asn1_deps.pl\t2007-04-22 11:28:12 UTC (rev 22454)\n@@ -1,6 +1,7 @@\n #!/usr/bin/perl\n # Generate make dependency rules for asn1 files\n # Jelmer Vernooij  2005\n+# Stefan Metzmacher  2007\n # GPL\n \n use File::Basename;\n@@ -15,6 +16,10 @@\n my @c_files = ();\n my $o_file;\n my @o_files = ();\n+my $import;\n+my @imports = ();\n+my $dep;\n+my @deps = ();\n \n $basename = basename($file);\n if (not defined $options) {\n@@ -28,8 +33,10 @@\n print \"\\t\\@\\$(builddir)/heimdal_build/asn1_compile_wrapper.sh \\$(srcdir) \\$(builddir) $dirname bin/asn1_compile $file $prefix $options\\n\\n\";\n \n open(IN,$file) or die(\"Can't open $file: $!\");\n-foreach() {\n-\tif (/^([\\w]+[\\w\\-]+)(\\s+OBJECT IDENTIFIER)?\\s*::=/) {\n+my @lines = ;\n+close(IN);\n+foreach my $line (@lines) {\n+\tif ($line =~ /^([\\w]+[\\w\\-]+)(\\s+OBJECT IDENTIFIER)?\\s*::=/) {\n \t\tmy $output = $1;\n \t\t$output =~ s/-/_/g;\n \t\t$c_file = \"$dirname/asn1_$output.c\";\n@@ -41,17 +48,49 @@\n \t\tpush @x_files, $x_file;\n \t\tpush @c_files, $c_file;\n \t\tpush @o_files, $o_file;\n+\t} elsif ($line =~ /^(\\s*IMPORT)([\\w\\,\\s])*(\\s+FROM\\s+)([\\w]+[\\w\\-]+);/) {\n+\t\t$import = $line;\n+\t\tchomp $import;\n+\t\tpush @imports, $import;\n+\t\t$import = undef;\n+\t} elsif ($line =~ /^(\\s*IMPORT).*/) {\n+\t\t$import = $line;\n+\t\tchomp $import;\n+\t} elsif (defined($import) and ($line =~ /;/)) {\n+\t\t$import .= $line;\n+\t\tchomp $import;\n+\t\tpush @imports, $import;\n+\t\t$import = undef;\n+\t} elsif (defined($import)) {\n+\t\t$import .= $line;\n+\t\tchomp $import;\n \t}\n }\n-close(IN);\n \n+foreach $import (@imports) {\n+\tnext unless ($import =~ /^(\\s*IMPORT)([\\w\\,\\s])*(\\s+FROM\\s+)([\\w]+[\\w\\-]+);/);\n+\n+\tmy @froms = split (/\\s+FROM\\s+/, $import);\n+\tforeach my $from (@froms) {\n+\t\tnext if ($from =~ /^(\\s*IMPORT).*/);\n+\t\tif ($from =~ /^(\\w+)/) {\n+\t\t\tmy $f = $1;\n+\t\t\t$dep = 'HEIMDAL_'.uc($f).'_ASN1';\n+\t\t\tpush @deps, $dep;\n+\t\t}\n+\t}\n+}\n+\n+unshift @deps, \"HEIMDAL_HEIM_ASN1\" unless grep /HEIMDAL_HEIM_ASN1/, @deps;\n+my $depstr = join(' ', @deps);\n+\n print '[SUBSYSTEM::HEIMDAL_'.uc($prefix).']'.\"\\n\";\n print \"CFLAGS = -Iheimdal_build -Iheimdal/lib/roken -I$dirname\\n\";\n print \"OBJ_FILES = \";\n foreach $o_file (@o_files) {\n     print \"\\\\\\n\\t$o_file\";\n }\n-print \"\\nPRIVATE_DEPENDENCIES = HEIMDAL_ASN1\\n\\n\";\n+print \"\\nPUBLIC_DEPENDENCIES = $depstr\\n\\n\";\n \n print \"clean:: \\n\";\n print \"\\t\\@echo \\\"Deleting ASN1 output files generated from $file\\\"\\n\";\n\nModified: branches/SAMBA_4_0/source/heimdal_build/config.mk\n===================================================================\n--- branches/SAMBA_4_0/source/heimdal_build/config.mk\t2007-04-22 10:42:33 UTC (rev 22453)\n+++ branches/SAMBA_4_0/source/heimdal_build/config.mk\t2007-04-22 11:28:12 UTC (rev 22454)\n@@ -17,7 +17,8 @@\n \t../heimdal/kdc/windc.o \\\n \t../heimdal/kdc/kx509.o \\\n \t../heimdal/lib/asn1/asn1_KRB5SignedPath.o\n-PRIVATE_DEPENDENCIES = HEIMDAL_ROKEN HEIMDAL_KRB5 HEIMDAL_HDB HEIMDAL_ASN1 HEIMDAL_DES HEIMDAL_DIGEST_ASN1 HEIMDAL_KX509_ASN1 HEIMDAL_NTLM\n+PRIVATE_DEPENDENCIES = HEIMDAL_ROKEN HEIMDAL_KRB5 HEIMDAL_HDB HEIMDAL_HEIM_ASN1 HEIMDAL_DIGEST_ASN1 HEIMDAL_KX509_ASN1\n+PUBLIC_DEPENDENCIES = HEIMDAL_NTLM HEIMDAL_DES\n # End SUBSYSTEM HEIMDAL_KDC\n #######################\n \n@@ -47,14 +48,14 @@\n \t../heimdal/lib/hdb/mkey.o \\\n \t../heimdal/lib/hdb/ndbm.o \\\n \t../heimdal/lib/hdb/hdb_err.o\n-PRIVATE_DEPENDENCIES = HDB_LDB HEIMDAL_HDB_KEYS HEIMDAL_ROKEN HEIMDAL_HDB_ASN1\n+PRIVATE_DEPENDENCIES = HDB_LDB HEIMDAL_KRB5 HEIMDAL_HDB_KEYS HEIMDAL_ROKEN HEIMDAL_DES HEIMDAL_COM_ERR HEIMDAL_HDB_ASN1\n # End SUBSYSTEM HEIMDAL_HDB\n #######################\n \n #######################\n # Start SUBSYSTEM HEIMDAL_GSSAPI\n [SUBSYSTEM::HEIMDAL_GSSAPI]\n-CFLAGS = -Iheimdal_build -Iheimdal/lib/gssapi/gssapi -Iheimdal/lib/gssapi/spnego -Iheimdal/lib/gssapi/krb5 -Iheimdal/lib/gssapi/mech\n+CFLAGS = -Iheimdal_build -Iheimdal/lib/gssapi -Iheimdal/lib/gssapi/gssapi -Iheimdal/lib/gssapi/spnego -Iheimdal/lib/gssapi/krb5 -Iheimdal/lib/gssapi/mech\n OBJ_FILES = \\\n \t../heimdal/lib/gssapi/mech/gss_krb5.o \\\n \t../heimdal/lib/gssapi/mech/gss_mech_switch.o \\\n@@ -163,7 +164,7 @@\n \t../heimdal/lib/gssapi/krb5/accept_sec_context.o \\\n \t../heimdal/lib/gssapi/krb5/set_sec_context_option.o \\\n \t../heimdal/lib/gssapi/krb5/process_context_token.o\n-PRIVATE_DEPENDENCIES = HEIMDAL_DES HEIMDAL_ASN1 HEIMDAL_SPNEGO_ASN1\n+PRIVATE_DEPENDENCIES = HEIMDAL_DES HEIMDAL_HEIM_ASN1 HEIMDAL_SPNEGO_ASN1\n PUBLIC_DEPENDENCIES = HEIMDAL_ROKEN HEIMDAL_KRB5\n # End SUBSYSTEM HEIMDAL_GSSAPI\n #######################\n@@ -172,8 +173,8 @@\n # Start SUBSYSTEM HEIMDAL_KRB5\n [SUBSYSTEM::HEIMDAL_KRB5]\n CFLAGS = -Iheimdal_build -Iheimdal/lib/krb5 \n-PRIVATE_DEPENDENCIES = HEIMDAL_ROKEN HEIMDAL_DES HEIMDAL_PKINIT_ASN1\n-PUBLIC_DEPENDENCIES = HEIMDAL_KRB5_ASN1 HEIMDAL_GLUE HEIMDAL_HX509\n+PRIVATE_DEPENDENCIES = HEIMDAL_ROKEN HEIMDAL_PKINIT_ASN1\n+PUBLIC_DEPENDENCIES = HEIMDAL_KRB5_ASN1 HEIMDAL_GLUE HEIMDAL_HX509 HEIMDAL_DES\n OBJ_FILES = \\\n \t../heimdal/lib/krb5/acache.o \\\n \t../heimdal/lib/krb5/add_et_list.o \\\n@@ -264,8 +265,8 @@\n #######################\n \n #######################\n-# Start SUBSYSTEM HEIMDAL_ASN1\n-[SUBSYSTEM::HEIMDAL_ASN1]\n+# Start SUBSYSTEM HEIMDAL_HEIM_ASN1\n+[SUBSYSTEM::HEIMDAL_HEIM_ASN1]\n CFLAGS = -Iheimdal_build -Iheimdal/lib/asn1\n OBJ_FILES = \\\n \t../heimdal/lib/asn1/der_get.o \\\n@@ -297,7 +298,7 @@\n \n [SUBSYSTEM::HEIMDAL_DES]\n CFLAGS = -Iheimdal_build -Iheimdal/lib/des \n-PRIVATE_DEPENDENCIES = HEIMDAL_ROKEN HEIMDAL_ASN1 HEIMDAL_DES_IMATH HEIMDAL_RFC2459_ASN1\n+PRIVATE_DEPENDENCIES = HEIMDAL_ROKEN HEIMDAL_HEIM_ASN1 HEIMDAL_DES_IMATH HEIMDAL_RFC2459_ASN1\n OBJ_FILES = \\\n \t../heimdal/lib/des/aes.o \\\n \t../heimdal/lib/des/bn.o \\\n@@ -333,7 +334,7 @@\n CFLAGS = -Iheimdal_build -Iheimdal/lib/hx509 \n PRIVATE_DEPENDENCIES = \\\n \tHEIMDAL_ROKEN HEIMDAL_COM_ERR \\\n-\tHEIMDAL_ASN1 HEIMDAL_DES \\\n+\tHEIMDAL_HEIM_ASN1 HEIMDAL_DES \\\n \tHEIMDAL_CMS_ASN1 HEIMDAL_RFC2459_ASN1 \\\n \tHEIMDAL_OCSP_ASN1 HEIMDAL_PKCS8_ASN1 \\\n \tHEIMDAL_PKCS9_ASN1 HEIMDAL_PKCS12_ASN1\n\n"}