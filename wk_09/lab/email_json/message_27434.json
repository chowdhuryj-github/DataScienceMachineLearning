{"category": "ham", "to_address": "samba-cvs@samba.org", "from_address": "vlendec@samba.org", "subject": "svn commit: samba r22787 - in branches: SAMBA_3_0/source/groupdb\n\tSAMBA_3_0/source/utils SAMBA_3_0_26/source/groupdb\n\tSAMBA_3_0_26/source/utils", "body": "Author: vlendec\nDate: 2007-05-11 08:59:01 +0000 (Fri, 11 May 2007)\nNew Revision: 22787\n\nWebSVN: http://websvn.samba.org/cgi-bin/viewcvs.cgi?view=rev&root=samba&rev=22787\n\nLog:\nMore from Karolin: Make map_unix_group() static to net_sam.c, add \"net\nsam unmapunixgroup\"\n\nModified:\n   branches/SAMBA_3_0/source/groupdb/mapping.c\n   branches/SAMBA_3_0/source/utils/net_sam.c\n   branches/SAMBA_3_0_26/source/groupdb/mapping.c\n   branches/SAMBA_3_0_26/source/utils/net_sam.c\n\n\nChangeset:\nModified: branches/SAMBA_3_0/source/groupdb/mapping.c\n===================================================================\n--- branches/SAMBA_3_0/source/groupdb/mapping.c\t2007-05-11 08:46:54 UTC (rev 22786)\n+++ branches/SAMBA_3_0/source/groupdb/mapping.c\t2007-05-11 08:59:01 UTC (rev 22787)\n@@ -49,70 +49,6 @@\n \treturn pdb_add_group_mapping_entry(&map);\n }\n \n-/****************************************************************************\n- Map a unix group to a newly created mapping\n-****************************************************************************/\n-NTSTATUS map_unix_group(const struct group *grp, GROUP_MAP *pmap)\n-{\n-\tNTSTATUS status;\n-\tGROUP_MAP map;\n-\tconst char *grpname, *dom, *name;\n-\tuint32 rid;\n-\n-\tif (pdb_getgrgid(&map, grp->gr_gid)) {\n-\t\treturn NT_STATUS_GROUP_EXISTS;\n-\t}\n-\n-\tmap.gid = grp->gr_gid;\n-\tgrpname = grp->gr_name;\n-\n-\tif (lookup_name(tmp_talloc_ctx(), grpname, LOOKUP_NAME_ISOLATED,\n-\t\t\t&dom, &name, NULL, NULL)) {\n-\n-\t\tconst char *tmp = talloc_asprintf(\n-\t\t\ttmp_talloc_ctx(), \"Unix Group %s\", grp->gr_name);\n-\n-\t\tDEBUG(5, (\"%s exists as %s\\\\%s, retrying as \\\"%s\\\"\\n\",\n-\t\t\t  grpname, dom, name, tmp));\n-\t\tgrpname = tmp;\n-\t}\n-\n-\tif (lookup_name(tmp_talloc_ctx(), grpname, LOOKUP_NAME_ISOLATED,\n-\t\t\tNULL, NULL, NULL, NULL)) {\n-\t\tDEBUG(3, (\"\\\"%s\\\" exists, can't map it\\n\", grp->gr_name));\n-\t\treturn NT_STATUS_GROUP_EXISTS;\n-\t}\n-\n-\tfstrcpy(map.nt_name, grpname);\n-\n-\tif (pdb_rid_algorithm()) {\n-\t\trid = algorithmic_pdb_gid_to_group_rid( grp->gr_gid );\n-\t} else {\n-\t\tif (!pdb_new_rid(&rid)) {\n-\t\t\tDEBUG(3, (\"Could not get a new RID for %s\\n\",\n-\t\t\t\t  grp->gr_name));\n-\t\t\treturn NT_STATUS_ACCESS_DENIED;\n-\t\t}\n-\t}\n-\n-\tsid_compose(&map.sid, get_global_sam_sid(), rid);\n-\tmap.sid_name_use = SID_NAME_DOM_GRP;\n-\tfstrcpy(map.comment, talloc_asprintf(tmp_talloc_ctx(), \"Unix Group %s\",\n-\t\t\t\t\t     grp->gr_name));\n-\n-\tstatus = pdb_add_group_mapping_entry(&map);\n-\tif (NT_STATUS_IS_OK(status)) {\n-\t\t*pmap = map;\n-\t}\n-\treturn status;\n-}\n-\n-\n-\n-\n-\n-\n-\n static NTSTATUS alias_memberships(const DOM_SID *members, size_t num_members,\n \t\t\t\t  DOM_SID **sids, size_t *num)\n {\n\nModified: branches/SAMBA_3_0/source/utils/net_sam.c\n===================================================================\n--- branches/SAMBA_3_0/source/utils/net_sam.c\t2007-05-11 08:46:54 UTC (rev 22786)\n+++ branches/SAMBA_3_0/source/utils/net_sam.c\t2007-05-11 08:59:01 UTC (rev 22787)\n@@ -507,6 +507,61 @@\n  * Map a unix group to a domain group\n  */\n \n+static NTSTATUS map_unix_group(const struct group *grp, GROUP_MAP *pmap)\n+{\n+\tNTSTATUS status;\n+\tGROUP_MAP map;\n+\tconst char *grpname, *dom, *name;\n+\tuint32 rid;\n+\n+\tif (pdb_getgrgid(&map, grp->gr_gid)) {\n+\t\treturn NT_STATUS_GROUP_EXISTS;\n+\t}\n+\n+\tmap.gid = grp->gr_gid;\n+\tgrpname = grp->gr_name;\n+\n+\tif (lookup_name(tmp_talloc_ctx(), grpname, LOOKUP_NAME_ISOLATED,\n+\t\t\t&dom, &name, NULL, NULL)) {\n+\n+\t\tconst char *tmp = talloc_asprintf(\n+\t\t\ttmp_talloc_ctx(), \"Unix Group %s\", grp->gr_name);\n+\n+\t\tDEBUG(5, (\"%s exists as %s\\\\%s, retrying as \\\"%s\\\"\\n\",\n+\t\t\t  grpname, dom, name, tmp));\n+\t\tgrpname = tmp;\n+\t}\n+\n+\tif (lookup_name(tmp_talloc_ctx(), grpname, LOOKUP_NAME_ISOLATED,\n+\t\t\tNULL, NULL, NULL, NULL)) {\n+\t\tDEBUG(3, (\"\\\"%s\\\" exists, can't map it\\n\", grp->gr_name));\n+\t\treturn NT_STATUS_GROUP_EXISTS;\n+\t}\n+\n+\tfstrcpy(map.nt_name, grpname);\n+\n+\tif (pdb_rid_algorithm()) {\n+\t\trid = algorithmic_pdb_gid_to_group_rid( grp->gr_gid );\n+\t} else {\n+\t\tif (!pdb_new_rid(&rid)) {\n+\t\t\tDEBUG(3, (\"Could not get a new RID for %s\\n\",\n+\t\t\t\t  grp->gr_name));\n+\t\t\treturn NT_STATUS_ACCESS_DENIED;\n+\t\t}\n+\t}\n+\n+\tsid_compose(&map.sid, get_global_sam_sid(), rid);\n+\tmap.sid_name_use = SID_NAME_DOM_GRP;\n+\tfstrcpy(map.comment, talloc_asprintf(tmp_talloc_ctx(), \"Unix Group %s\",\n+\t\t\t\t\t     grp->gr_name));\n+\n+\tstatus = pdb_add_group_mapping_entry(&map);\n+\tif (NT_STATUS_IS_OK(status)) {\n+\t\t*pmap = map;\n+\t}\n+\treturn status;\n+}\n+\n static int net_sam_mapunixgroup(int argc, const char **argv)\n {\n \tNTSTATUS status;\n@@ -539,6 +594,67 @@\n }\n \n /*\n+ * Remove a group mapping\n+ */\n+\n+static NTSTATUS unmap_unix_group(const struct group *grp, GROUP_MAP *pmap)\n+{\n+        NTSTATUS status;\n+        GROUP_MAP map;\n+        const char *grpname;\n+        DOM_SID dom_sid;\n+\n+        map.gid = grp->gr_gid;\n+        grpname = grp->gr_name;\n+\n+        if (!lookup_name(tmp_talloc_ctx(), grpname, LOOKUP_NAME_ISOLATED,\n+                        NULL, NULL, NULL, NULL)) {\n+                DEBUG(3, (\"\\\"%s\\\" does not exist, can't unmap it\\n\", grp->gr_name));\n+                return NT_STATUS_NO_SUCH_GROUP;\n+        }\n+\n+        fstrcpy(map.nt_name, grpname);\n+\n+        if (!pdb_gid_to_sid(map.gid, &dom_sid)) {\n+                return NT_STATUS_UNSUCCESSFUL;\n+        }\n+\n+        status = pdb_delete_group_mapping_entry(dom_sid);\n+\n+        return status;\n+}\n+\n+static int net_sam_unmapunixgroup(int argc, const char **argv)\n+{\n+\tNTSTATUS status;\n+\tGROUP_MAP map;\n+\tstruct group *grp;\n+\n+\tif (argc != 1) {\n+\t\td_fprintf(stderr, \"usage: net sam unmapunixgroup \\n\");\n+\t\treturn -1;\n+\t}\n+\n+\tgrp = getgrnam(argv[0]);\n+\tif (grp == NULL) {\n+\t\td_fprintf(stderr, \"Could not find mapping for group %s.\\n\", argv[0]);\n+\t\treturn -1;\n+\t}\n+\n+\tstatus = unmap_unix_group(grp, &map);\n+\n+\tif (!NT_STATUS_IS_OK(status)) {\n+\t\td_fprintf(stderr, \"Unmapping group %s failed with %s.\\n\",\n+\t\t\t  argv[0], nt_errstr(status));\n+\t\treturn -1;\n+\t}\n+\n+\td_printf(\"Unmapped unix group %s.\\n\", argv[0]);\n+\n+\treturn 0;\n+}\n+\n+/*\n  * Create a local group\n  */\n \n@@ -1386,6 +1502,8 @@\n \t\t  \"Delete an existing local group\" },\n \t\t{ \"mapunixgroup\", net_sam_mapunixgroup,\n \t\t  \"Map a unix group to a domain group\" },\n+\t\t{ \"unmapunixgroup\", net_sam_unmapunixgroup,\n+\t\t  \"Remove a group mapping of an unix group to a domain group\" },\n \t\t{ \"addmem\", net_sam_addmem,\n \t\t  \"Add a member to a group\" },\n \t\t{ \"delmem\", net_sam_delmem,\n\nModified: branches/SAMBA_3_0_26/source/groupdb/mapping.c\n===================================================================\n--- branches/SAMBA_3_0_26/source/groupdb/mapping.c\t2007-05-11 08:46:54 UTC (rev 22786)\n+++ branches/SAMBA_3_0_26/source/groupdb/mapping.c\t2007-05-11 08:59:01 UTC (rev 22787)\n@@ -49,70 +49,6 @@\n \treturn pdb_add_group_mapping_entry(&map);\n }\n \n-/****************************************************************************\n- Map a unix group to a newly created mapping\n-****************************************************************************/\n-NTSTATUS map_unix_group(const struct group *grp, GROUP_MAP *pmap)\n-{\n-\tNTSTATUS status;\n-\tGROUP_MAP map;\n-\tconst char *grpname, *dom, *name;\n-\tuint32 rid;\n-\n-\tif (pdb_getgrgid(&map, grp->gr_gid)) {\n-\t\treturn NT_STATUS_GROUP_EXISTS;\n-\t}\n-\n-\tmap.gid = grp->gr_gid;\n-\tgrpname = grp->gr_name;\n-\n-\tif (lookup_name(tmp_talloc_ctx(), grpname, LOOKUP_NAME_ISOLATED,\n-\t\t\t&dom, &name, NULL, NULL)) {\n-\n-\t\tconst char *tmp = talloc_asprintf(\n-\t\t\ttmp_talloc_ctx(), \"Unix Group %s\", grp->gr_name);\n-\n-\t\tDEBUG(5, (\"%s exists as %s\\\\%s, retrying as \\\"%s\\\"\\n\",\n-\t\t\t  grpname, dom, name, tmp));\n-\t\tgrpname = tmp;\n-\t}\n-\n-\tif (lookup_name(tmp_talloc_ctx(), grpname, LOOKUP_NAME_ISOLATED,\n-\t\t\tNULL, NULL, NULL, NULL)) {\n-\t\tDEBUG(3, (\"\\\"%s\\\" exists, can't map it\\n\", grp->gr_name));\n-\t\treturn NT_STATUS_GROUP_EXISTS;\n-\t}\n-\n-\tfstrcpy(map.nt_name, grpname);\n-\n-\tif (pdb_rid_algorithm()) {\n-\t\trid = algorithmic_pdb_gid_to_group_rid( grp->gr_gid );\n-\t} else {\n-\t\tif (!pdb_new_rid(&rid)) {\n-\t\t\tDEBUG(3, (\"Could not get a new RID for %s\\n\",\n-\t\t\t\t  grp->gr_name));\n-\t\t\treturn NT_STATUS_ACCESS_DENIED;\n-\t\t}\n-\t}\n-\n-\tsid_compose(&map.sid, get_global_sam_sid(), rid);\n-\tmap.sid_name_use = SID_NAME_DOM_GRP;\n-\tfstrcpy(map.comment, talloc_asprintf(tmp_talloc_ctx(), \"Unix Group %s\",\n-\t\t\t\t\t     grp->gr_name));\n-\n-\tstatus = pdb_add_group_mapping_entry(&map);\n-\tif (NT_STATUS_IS_OK(status)) {\n-\t\t*pmap = map;\n-\t}\n-\treturn status;\n-}\n-\n-\n-\n-\n-\n-\n-\n static NTSTATUS alias_memberships(const DOM_SID *members, size_t num_members,\n \t\t\t\t  DOM_SID **sids, size_t *num)\n {\n\nModified: branches/SAMBA_3_0_26/source/utils/net_sam.c\n===================================================================\n--- branches/SAMBA_3_0_26/source/utils/net_sam.c\t2007-05-11 08:46:54 UTC (rev 22786)\n+++ branches/SAMBA_3_0_26/source/utils/net_sam.c\t2007-05-11 08:59:01 UTC (rev 22787)\n@@ -507,6 +507,61 @@\n  * Map a unix group to a domain group\n  */\n \n+static NTSTATUS map_unix_group(const struct group *grp, GROUP_MAP *pmap)\n+{\n+\tNTSTATUS status;\n+\tGROUP_MAP map;\n+\tconst char *grpname, *dom, *name;\n+\tuint32 rid;\n+\n+\tif (pdb_getgrgid(&map, grp->gr_gid)) {\n+\t\treturn NT_STATUS_GROUP_EXISTS;\n+\t}\n+\n+\tmap.gid = grp->gr_gid;\n+\tgrpname = grp->gr_name;\n+\n+\tif (lookup_name(tmp_talloc_ctx(), grpname, LOOKUP_NAME_ISOLATED,\n+\t\t\t&dom, &name, NULL, NULL)) {\n+\n+\t\tconst char *tmp = talloc_asprintf(\n+\t\t\ttmp_talloc_ctx(), \"Unix Group %s\", grp->gr_name);\n+\n+\t\tDEBUG(5, (\"%s exists as %s\\\\%s, retrying as \\\"%s\\\"\\n\",\n+\t\t\t  grpname, dom, name, tmp));\n+\t\tgrpname = tmp;\n+\t}\n+\n+\tif (lookup_name(tmp_talloc_ctx(), grpname, LOOKUP_NAME_ISOLATED,\n+\t\t\tNULL, NULL, NULL, NULL)) {\n+\t\tDEBUG(3, (\"\\\"%s\\\" exists, can't map it\\n\", grp->gr_name));\n+\t\treturn NT_STATUS_GROUP_EXISTS;\n+\t}\n+\n+\tfstrcpy(map.nt_name, grpname);\n+\n+\tif (pdb_rid_algorithm()) {\n+\t\trid = algorithmic_pdb_gid_to_group_rid( grp->gr_gid );\n+\t} else {\n+\t\tif (!pdb_new_rid(&rid)) {\n+\t\t\tDEBUG(3, (\"Could not get a new RID for %s\\n\",\n+\t\t\t\t  grp->gr_name));\n+\t\t\treturn NT_STATUS_ACCESS_DENIED;\n+\t\t}\n+\t}\n+\n+\tsid_compose(&map.sid, get_global_sam_sid(), rid);\n+\tmap.sid_name_use = SID_NAME_DOM_GRP;\n+\tfstrcpy(map.comment, talloc_asprintf(tmp_talloc_ctx(), \"Unix Group %s\",\n+\t\t\t\t\t     grp->gr_name));\n+\n+\tstatus = pdb_add_group_mapping_entry(&map);\n+\tif (NT_STATUS_IS_OK(status)) {\n+\t\t*pmap = map;\n+\t}\n+\treturn status;\n+}\n+\n static int net_sam_mapunixgroup(int argc, const char **argv)\n {\n \tNTSTATUS status;\n@@ -539,6 +594,67 @@\n }\n \n /*\n+ * Remove a group mapping\n+ */\n+\n+static NTSTATUS unmap_unix_group(const struct group *grp, GROUP_MAP *pmap)\n+{\n+        NTSTATUS status;\n+        GROUP_MAP map;\n+        const char *grpname;\n+        DOM_SID dom_sid;\n+\n+        map.gid = grp->gr_gid;\n+        grpname = grp->gr_name;\n+\n+        if (!lookup_name(tmp_talloc_ctx(), grpname, LOOKUP_NAME_ISOLATED,\n+                        NULL, NULL, NULL, NULL)) {\n+                DEBUG(3, (\"\\\"%s\\\" does not exist, can't unmap it\\n\", grp->gr_name));\n+                return NT_STATUS_NO_SUCH_GROUP;\n+        }\n+\n+        fstrcpy(map.nt_name, grpname);\n+\n+        if (!pdb_gid_to_sid(map.gid, &dom_sid)) {\n+                return NT_STATUS_UNSUCCESSFUL;\n+        }\n+\n+        status = pdb_delete_group_mapping_entry(dom_sid);\n+\n+        return status;\n+}\n+\n+static int net_sam_unmapunixgroup(int argc, const char **argv)\n+{\n+\tNTSTATUS status;\n+\tGROUP_MAP map;\n+\tstruct group *grp;\n+\n+\tif (argc != 1) {\n+\t\td_fprintf(stderr, \"usage: net sam unmapunixgroup \\n\");\n+\t\treturn -1;\n+\t}\n+\n+\tgrp = getgrnam(argv[0]);\n+\tif (grp == NULL) {\n+\t\td_fprintf(stderr, \"Could not find mapping for group %s.\\n\", argv[0]);\n+\t\treturn -1;\n+\t}\n+\n+\tstatus = unmap_unix_group(grp, &map);\n+\n+\tif (!NT_STATUS_IS_OK(status)) {\n+\t\td_fprintf(stderr, \"Unmapping group %s failed with %s.\\n\",\n+\t\t\t  argv[0], nt_errstr(status));\n+\t\treturn -1;\n+\t}\n+\n+\td_printf(\"Unmapped unix group %s.\\n\", argv[0]);\n+\n+\treturn 0;\n+}\n+\n+/*\n  * Create a local group\n  */\n \n@@ -1386,6 +1502,8 @@\n \t\t  \"Delete an existing local group\" },\n \t\t{ \"mapunixgroup\", net_sam_mapunixgroup,\n \t\t  \"Map a unix group to a domain group\" },\n+\t\t{ \"unmapunixgroup\", net_sam_unmapunixgroup,\n+\t\t  \"Remove a group mapping of an unix group to a domain group\" },\n \t\t{ \"addmem\", net_sam_addmem,\n \t\t  \"Add a member to a group\" },\n \t\t{ \"delmem\", net_sam_delmem,\n\n"}