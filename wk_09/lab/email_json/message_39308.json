{"category": "ham", "to_address": "samba-cvs@samba.org", "from_address": "tridge@samba.org", "subject": "Rev 406: added hooks to make nfs statd behave correctly on failover\n\tin http://samba.org/~tridge/ctdb", "body": "------------------------------------------------------------\nrevno: 406\nrevision-id: tridge@samba.org-20070531010945-9ep7p4ayvrdgartq\nparent: tridge@samba.org-20070530080657-cltwez2ku257i2tr\ncommitter: Andrew Tridgell \nbranch nick: tridge\ntimestamp: Thu 2007-05-31 11:09:45 +1000\nmessage:\n  added hooks to make nfs statd behave correctly on failover\nremoved:\n  README                         readme-20061117235635-y14mgeg2d0t13ms5-1\nadded:\n  packaging/RHEL/setup/statd-callout statdcallout-20070531010857-6sdlz455vusye5y5-1\nmodified:\n  .bzrignore                     bzrignore-20061117235536-slq8jlz2b5161dfm-1\n  packaging/RHEL/ctdb.spec       ctdb.spec-20070527204758-biuh7znabuwan3zn-3\n  packaging/RHEL/setup/ctdb.sysconfig ctdb.sysconfig-20070527204758-biuh7znabuwan3zn-7\n  tools/events                   events-20070529030121-04fjh63cxfh8v1pj-1\n=== removed file 'README'\n--- a/README\t2006-11-17 23:57:01 +0000\n+++ b/README\t1970-01-01 00:00:00 +0000\n@@ -1,3 +0,0 @@\n-To build this you need a recent copy of talloc, libreplace and tdb in\n-the directory above this directory.\n-\n\n=== added file 'packaging/RHEL/setup/statd-callout'\n--- a/packaging/RHEL/setup/statd-callout\t1970-01-01 00:00:00 +0000\n+++ b/packaging/RHEL/setup/statd-callout\t2007-05-31 01:09:45 +0000\n@@ -0,0 +1,44 @@\n+#!/bin/sh\n+\n+. /etc/sysconfig/ctdb\n+\n+[ -z \"$STATD_SHARED_DIRECTORY\" ] && exit 0\n+\n+[ -d $STATD_SHARED_DIRECTORY ] || exit 0\n+\n+case \"$1\" in\n+  add-client)\n+        for f in `/bin/ls /etc/ctdb/ip.*`; do\n+\t    fname=`/bin/basename $f`\n+\t    ip=`echo $fname | cut -d. -f2-`\n+\t    [ -d $STATD_SHARED_DIRECTORY/$ip ] || /bin/mkdir $STATD_SHARED_DIRECTORY/$ip\n+\t    /bin/touch $STATD_SHARED_DIRECTORY/$ip/$2\n+\tdone\n+\t;;\n+  del-client)\n+        for f in `/bin/ls /etc/ctdb/ip.*`; do\n+\t    fname=`/bin/basename $f`\n+\t    ip=`echo $fname | cut -d. -f2-`\n+\t    /bin/rm -f $STATD_SHARED_DIRECTORY/$ip/$2\n+\tdone\n+\t;;\n+  copy)\n+\trestart_needed=0\n+        for f in `/bin/ls /etc/ctdb/ip.*`; do\n+\t    fname=`/bin/basename $f`\n+\t    ip=`echo $fname | cut -d. -f2-`\n+\t    [ -d $STATD_SHARED_DIRECTORY/$ip ] && {\n+\t\t/bin/mv $STATD_SHARED_DIRECTORY/$ip $STATD_SHARED_DIRECTORY/$ip.$$\n+\t\t/bin/cp -a $STATD_SHARED_DIRECTORY/$ip.$$/. /var/lib/nfs/statd/sm/\n+\t\t/bin/rm -rf $STATD_SHARED_DIRECTORY/$ip.$$\n+\t\trestart_needed=1\n+\t    }\n+\tdone\n+\t# restart lockd if necessary\n+\t[ $restart_needed -eq 1 ] && {\n+\t\t( /sbin/service nfslock status > /dev/null 2>&1 && \n+                      /sbin/service nfslock restart > /dev/null 2>&1 ) &\n+\t} > /dev/null 2>&1\n+\t;;\n+esac\n+\n\n=== modified file '.bzrignore'\n--- a/.bzrignore\t2007-04-26 13:40:14 +0000\n+++ b/.bzrignore\t2007-05-31 01:09:45 +0000\n@@ -15,3 +15,4 @@\n ctdb-2\n ctdb-3\n nodes.txt\n+TAGS\n\n=== modified file 'packaging/RHEL/ctdb.spec'\n--- a/packaging/RHEL/ctdb.spec\t2007-05-30 01:17:52 +0000\n+++ b/packaging/RHEL/ctdb.spec\t2007-05-31 01:09:45 +0000\n@@ -66,6 +66,7 @@\n install -m644 setup/ctdb.sysconfig $RPM_BUILD_ROOT%{_sysconfdir}/sysconfig/ctdb\n install -m755 setup/ctdb.init $RPM_BUILD_ROOT%{initdir}/ctdb\n install -m755 tools/events $RPM_BUILD_ROOT%{_sysconfdir}/ctdb/events\n+install -m755 tools/statd-callout $RPM_BUILD_ROOT%{_sysconfdir}/ctdb/statd-callout\n install -m755 tools/onnode.ssh $RPM_BUILD_ROOT%{_bindir}\n install -m755 tools/onnode.rsh $RPM_BUILD_ROOT%{_bindir}\n ln -sf %{_bindir}/onnode.ssh $RPM_BUILD_ROOT%{_bindir}/onnode\n@@ -107,6 +108,7 @@\n %attr(755,root,root) %config %{initdir}/ctdb\n \n %{_sysconfdir}/ctdb/events\n+%{_sysconfdir}/ctdb/statd-callout\n %{_sbindir}/ctdbd\n %{_bindir}/ctdb\n %{_bindir}/onnode.ssh\n@@ -114,4 +116,3 @@\n %{_bindir}/onnode\n %{_includedir}/ctdb.h\n %{_includedir}/ctdb_private.h\n-\n\n=== modified file 'packaging/RHEL/setup/ctdb.sysconfig'\n--- a/packaging/RHEL/setup/ctdb.sysconfig\t2007-05-30 02:37:03 +0000\n+++ b/packaging/RHEL/setup/ctdb.sysconfig\t2007-05-31 01:09:45 +0000\n@@ -47,6 +47,11 @@\n # the default is not to wait for any local services\n # CTDB_WAIT_TCP_PORTS=\"445 139\"\n \n+# the shared directory where you want to put statd information on\n+# which clients to notify on a NFS restart\n+# there is no default\n+# STATD_SHARED_DIRECTORY=\"/some/shared/directory\"\n+\n # any other options you might want. Run ctdbd --help for a list\n # CTDB_OPTIONS=\n \n\n=== modified file 'tools/events'\n--- a/tools/events\t2007-05-30 06:11:39 +0000\n+++ b/tools/events\t2007-05-31 01:09:45 +0000\n@@ -43,6 +43,10 @@\n \t}\n \t# if we have a local arp entry for this IP then remove it\n \t/sbin/arp -d $ip 2> /dev/null\n+\n+\t# having a list of what IPs we have allows statd to do the right \n+\t# thing via /etc/ctdb/statd-callout\n+\t/bin/touch /etc/ctdb/ip.$ip\n \texit 0\n \t;;\n \n@@ -61,12 +65,14 @@\n \t# if we have a local arp entry for this IP then remove it\n \t/sbin/arp -d $ip 2> /dev/null\n \techo $ip >> /etc/ctdb/released_ips\n+\t/bin/rm -f /etc/ctdb/ip.$ip\n \texit 0\n \t;;\n \n      recovered)\n         # restart any services as necessary, like NFS\n \t# \n+\t[ -x /etc/ctdb/statd-callout ] && /etc/ctdb/statd-callout copy\n \t[ -f /etc/ctdb/released_ips ] && {\n \t\t( /sbin/service nfs status > /dev/null 2>&1 && \n                       /sbin/service nfs restart > /dev/null 2>&1 ) &\n\n"}