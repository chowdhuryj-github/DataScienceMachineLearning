{"category": "ham", "to_address": "samba-cvs@samba.org", "from_address": "jerry@samba.org", "subject": "svn commit: samba r22709 - in branches: SAMBA_3_0/source/nsswitch\n\tSAMBA_3_0_26/source/nsswitch", "body": "Author: jerry\nDate: 2007-05-06 19:48:13 +0000 (Sun, 06 May 2007)\nNew Revision: 22709\n\nWebSVN: http://websvn.samba.org/cgi-bin/viewcvs.cgi?view=rev&root=samba&rev=22709\n\nLog:\nwe can only use tschannel when commectcing to our primary (might need some fixing here for a Samba DC)\nModified:\n   branches/SAMBA_3_0/source/nsswitch/winbindd_cm.c\n   branches/SAMBA_3_0_26/source/nsswitch/winbindd_cm.c\n\n\nChangeset:\nModified: branches/SAMBA_3_0/source/nsswitch/winbindd_cm.c\n===================================================================\n--- branches/SAMBA_3_0/source/nsswitch/winbindd_cm.c\t2007-05-06 19:46:03 UTC (rev 22708)\n+++ branches/SAMBA_3_0/source/nsswitch/winbindd_cm.c\t2007-05-06 19:48:13 UTC (rev 22709)\n@@ -2092,7 +2092,7 @@\n \t\treturn NT_STATUS_OK;\n \t}\n \n-\tif (!get_trust_pw(domain->name, mach_pwd, &sec_chan_type)) {\n+\tif (domain->primary && !get_trust_pw(domain->name, mach_pwd, &sec_chan_type)) {\n \t\treturn NT_STATUS_CANT_ACCESS_DOMAIN_INFO;\n \t}\n \n@@ -2102,6 +2102,12 @@\n \t\treturn result;\n \t}\n \n+\tif ( !domain->primary ) {\n+\t\t/* Clear the schannel request bit and drop down */\n+\t\tneg_flags &= ~NETLOGON_NEG_SCHANNEL;\t\t\n+\t\tgoto no_schannel;\n+\t}\n+\t\n \tif (lp_client_schannel() != False) {\n \t\tneg_flags |= NETLOGON_NEG_SCHANNEL;\n \t}\n@@ -2146,6 +2152,7 @@\n \t\treturn NT_STATUS_ACCESS_DENIED;\n \t}\n \n+ no_schannel:\n \tif ((lp_client_schannel() == False) ||\n \t\t\t((neg_flags & NETLOGON_NEG_SCHANNEL) == 0)) {\n \t\t/* We're done - just keep the existing connection to NETLOGON\n\nModified: branches/SAMBA_3_0_26/source/nsswitch/winbindd_cm.c\n===================================================================\n--- branches/SAMBA_3_0_26/source/nsswitch/winbindd_cm.c\t2007-05-06 19:46:03 UTC (rev 22708)\n+++ branches/SAMBA_3_0_26/source/nsswitch/winbindd_cm.c\t2007-05-06 19:48:13 UTC (rev 22709)\n@@ -2092,7 +2092,7 @@\n \t\treturn NT_STATUS_OK;\n \t}\n \n-\tif (!get_trust_pw(domain->name, mach_pwd, &sec_chan_type)) {\n+\tif (domain->primary && !get_trust_pw(domain->name, mach_pwd, &sec_chan_type)) {\n \t\treturn NT_STATUS_CANT_ACCESS_DOMAIN_INFO;\n \t}\n \n@@ -2102,6 +2102,12 @@\n \t\treturn result;\n \t}\n \n+\tif ( !domain->primary ) {\n+\t\t/* Clear the schannel request bit and drop down */\n+\t\tneg_flags &= ~NETLOGON_NEG_SCHANNEL;\t\t\n+\t\tgoto no_schannel;\n+\t}\n+\t\n \tif (lp_client_schannel() != False) {\n \t\tneg_flags |= NETLOGON_NEG_SCHANNEL;\n \t}\n@@ -2146,6 +2152,7 @@\n \t\treturn NT_STATUS_ACCESS_DENIED;\n \t}\n \n+ no_schannel:\n \tif ((lp_client_schannel() == False) ||\n \t\t\t((neg_flags & NETLOGON_NEG_SCHANNEL) == 0)) {\n \t\t/* We're done - just keep the existing connection to NETLOGON\n\n"}