{"category": "ham", "to_address": "samba-cvs@samba.org", "from_address": "jerry@samba.org", "subject": "svn commit: samba r23046 - in branches: SAMBA_3_0/source/nsswitch\n\tSAMBA_3_0/source/passdb SAMBA_3_0_26/source/nsswitch\n\tSAMBA_3_0_26/source/passdb", "body": "Author: jerry\nDate: 2007-05-21 19:12:14 +0000 (Mon, 21 May 2007)\nNew Revision: 23046\n\nWebSVN: http://websvn.samba.org/cgi-bin/viewcvs.cgi?view=rev&root=samba&rev=23046\n\nLog:\nFew missing merges from cleaning out the Centeris winbindd tree.\nNothing of major interest.  Will fix a few problems with one way trusts.\n\n\nModified:\n   branches/SAMBA_3_0/source/nsswitch/winbindd.c\n   branches/SAMBA_3_0/source/nsswitch/winbindd_rpc.c\n   branches/SAMBA_3_0/source/nsswitch/winbindd_util.c\n   branches/SAMBA_3_0/source/passdb/pdb_interface.c\n   branches/SAMBA_3_0_26/source/nsswitch/winbindd.c\n   branches/SAMBA_3_0_26/source/nsswitch/winbindd_rpc.c\n   branches/SAMBA_3_0_26/source/nsswitch/winbindd_util.c\n   branches/SAMBA_3_0_26/source/passdb/pdb_interface.c\n\n\nChangeset:\nModified: branches/SAMBA_3_0/source/nsswitch/winbindd.c\n===================================================================\n--- branches/SAMBA_3_0/source/nsswitch/winbindd.c\t2007-05-21 17:39:05 UTC (rev 23045)\n+++ branches/SAMBA_3_0/source/nsswitch/winbindd.c\t2007-05-21 19:12:14 UTC (rev 23046)\n@@ -1164,6 +1164,10 @@\n \n \twcache_tdc_clear();\t\n \t\n+\t/* clear the cached list of trusted domains */\n+\n+\twcache_tdc_clear();\t\n+\t\n \tif (!init_domain_list()) {\n \t\tDEBUG(0,(\"unable to initalize domain list\\n\"));\n \t\texit(1);\n\nModified: branches/SAMBA_3_0/source/nsswitch/winbindd_rpc.c\n===================================================================\n--- branches/SAMBA_3_0/source/nsswitch/winbindd_rpc.c\t2007-05-21 17:39:05 UTC (rev 23045)\n+++ branches/SAMBA_3_0/source/nsswitch/winbindd_rpc.c\t2007-05-21 19:12:14 UTC (rev 23046)\n@@ -458,6 +458,12 @@\n \t\treturn NT_STATUS_OK;\n \t}\n \t\n+\tif ( !winbindd_can_contact_domain( domain ) ) {\n+\t\tDEBUG(10,(\"query_user: No incoming trust for domain %s\\n\",\n+\t\t\t  domain->name));\n+\t\treturn NT_STATUS_OK;\n+\t}\n+\t\n \t/* no cache; hit the wire */\n \t\t\n \tresult = cm_connect_sam(domain, mem_ctx, &cli, &dom_pol);\n\nModified: branches/SAMBA_3_0/source/nsswitch/winbindd_util.c\n===================================================================\n--- branches/SAMBA_3_0/source/nsswitch/winbindd_util.c\t2007-05-21 17:39:05 UTC (rev 23045)\n+++ branches/SAMBA_3_0/source/nsswitch/winbindd_util.c\t2007-05-21 19:12:14 UTC (rev 23046)\n@@ -148,6 +148,16 @@\n \t\treturn domain;\t\t\n \t}\t\n         \n+\t/* See if we found a match.  Check if we need to update the\n+\t   SID. */\n+\n+\tif ( domain ) {\n+\t\tif ( sid_equal( &domain->sid, &global_sid_NULL ) )\n+\t\t\tsid_copy( &domain->sid, sid );\n+\n+\t\treturn domain;\t\t\n+\t}\t\n+        \n \t/* Create new domain entry */\n \n \tif ((domain = SMB_MALLOC_P(struct winbindd_domain)) == NULL)\n\nModified: branches/SAMBA_3_0/source/passdb/pdb_interface.c\n===================================================================\n--- branches/SAMBA_3_0/source/passdb/pdb_interface.c\t2007-05-21 17:39:05 UTC (rev 23045)\n+++ branches/SAMBA_3_0/source/passdb/pdb_interface.c\t2007-05-21 19:12:14 UTC (rev 23046)\n@@ -1307,7 +1307,7 @@\n \t\tgoto done;\t\t\n \t}\n \t\n-\t/* check for \"Unix User\" */\n+\t/* check for \"Unix Group\" */\n \n \tif ( sid_peek_check_rid(&global_sid_Unix_Groups, sid, &rid) ) {\n \t\tid->gid = rid;\n\nModified: branches/SAMBA_3_0_26/source/nsswitch/winbindd.c\n===================================================================\n--- branches/SAMBA_3_0_26/source/nsswitch/winbindd.c\t2007-05-21 17:39:05 UTC (rev 23045)\n+++ branches/SAMBA_3_0_26/source/nsswitch/winbindd.c\t2007-05-21 19:12:14 UTC (rev 23046)\n@@ -1111,6 +1111,10 @@\n \n \twcache_tdc_clear();\t\n \t\n+\t/* clear the cached list of trusted domains */\n+\n+\twcache_tdc_clear();\t\n+\t\n \tif (!init_domain_list()) {\n \t\tDEBUG(0,(\"unable to initalize domain list\\n\"));\n \t\texit(1);\n\nModified: branches/SAMBA_3_0_26/source/nsswitch/winbindd_rpc.c\n===================================================================\n--- branches/SAMBA_3_0_26/source/nsswitch/winbindd_rpc.c\t2007-05-21 17:39:05 UTC (rev 23045)\n+++ branches/SAMBA_3_0_26/source/nsswitch/winbindd_rpc.c\t2007-05-21 19:12:14 UTC (rev 23046)\n@@ -458,6 +458,12 @@\n \t\treturn NT_STATUS_OK;\n \t}\n \t\n+\tif ( !winbindd_can_contact_domain( domain ) ) {\n+\t\tDEBUG(10,(\"query_user: No incoming trust for domain %s\\n\",\n+\t\t\t  domain->name));\n+\t\treturn NT_STATUS_OK;\n+\t}\n+\t\n \t/* no cache; hit the wire */\n \t\t\n \tresult = cm_connect_sam(domain, mem_ctx, &cli, &dom_pol);\n\nModified: branches/SAMBA_3_0_26/source/nsswitch/winbindd_util.c\n===================================================================\n--- branches/SAMBA_3_0_26/source/nsswitch/winbindd_util.c\t2007-05-21 17:39:05 UTC (rev 23045)\n+++ branches/SAMBA_3_0_26/source/nsswitch/winbindd_util.c\t2007-05-21 19:12:14 UTC (rev 23046)\n@@ -157,6 +157,16 @@\n \t\treturn domain;\t\t\n \t}\t\n         \n+\t/* See if we found a match.  Check if we need to update the\n+\t   SID. */\n+\n+\tif ( domain ) {\n+\t\tif ( sid_equal( &domain->sid, &global_sid_NULL ) )\n+\t\t\tsid_copy( &domain->sid, sid );\n+\n+\t\treturn domain;\t\t\n+\t}\t\n+        \n \t/* Create new domain entry */\n \n \tif ((domain = SMB_MALLOC_P(struct winbindd_domain)) == NULL)\n\nModified: branches/SAMBA_3_0_26/source/passdb/pdb_interface.c\n===================================================================\n--- branches/SAMBA_3_0_26/source/passdb/pdb_interface.c\t2007-05-21 17:39:05 UTC (rev 23045)\n+++ branches/SAMBA_3_0_26/source/passdb/pdb_interface.c\t2007-05-21 19:12:14 UTC (rev 23046)\n@@ -1289,7 +1289,7 @@\n \t\tgoto done;\t\t\n \t}\n \t\n-\t/* check for \"Unix User\" */\n+\t/* check for \"Unix Group\" */\n \n \tif ( sid_peek_check_rid(&global_sid_Unix_Groups, sid, &rid) ) {\n \t\tid->gid = rid;\n\n"}