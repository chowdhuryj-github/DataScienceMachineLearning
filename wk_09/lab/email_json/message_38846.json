{"category": "ham", "to_address": "samba-cvs@samba.org", "from_address": "gd@samba.org", "subject": "svn commit: samba r23239 - in branches/SAMBA_4_0/source: librpc/idl\n\trpc_server/drsuapi torture/rpc", "body": "Author: gd\nDate: 2007-05-30 09:54:19 +0000 (Wed, 30 May 2007)\nNew Revision: 23239\n\nWebSVN: http://websvn.samba.org/cgi-bin/viewcvs.cgi?view=rev&root=samba&rev=23239\n\nLog:\nFill in drsuapi_QuerySitesByCost.\n\nGuenther\n\nModified:\n   branches/SAMBA_4_0/source/librpc/idl/drsuapi.idl\n   branches/SAMBA_4_0/source/rpc_server/drsuapi/dcesrv_drsuapi.c\n   branches/SAMBA_4_0/source/torture/rpc/drsuapi.c\n\n\nChangeset:\nModified: branches/SAMBA_4_0/source/librpc/idl/drsuapi.idl\n===================================================================\n--- branches/SAMBA_4_0/source/librpc/idl/drsuapi.idl\t2007-05-30 08:15:49 UTC (rev 23238)\n+++ branches/SAMBA_4_0/source/librpc/idl/drsuapi.idl\t2007-05-30 09:54:19 UTC (rev 23239)\n@@ -1457,5 +1457,37 @@\n \n \t/*****************/\n         /* Function 0x18 */\n-\tWERROR DRSUAPI_QUERY_SITES_BY_COST();\n+\ttypedef struct {\n+\t\tWERROR error_code;\n+\t\tuint32 site_cost;\n+\t} drsuapi_DsSiteCostInfo;\n+\n+\ttypedef struct {\n+\t\t[range(0,10000)] uint32 num_info;\n+\t\t[size_is(num_info)] drsuapi_DsSiteCostInfo *info;\n+\t\tuint32 unknown;\n+\t} drsuapi_QuerySitesByCostCtr1;\n+\n+\ttypedef [switch_type(int32)] union {\n+\t\t[case(1)] drsuapi_QuerySitesByCostCtr1 ctr1;\n+\t} drsuapi_QuerySitesByCostCtr;\n+\n+\ttypedef struct {\n+\t\t[charset(UTF16),string] uint16 *site_from;\n+\t\t[range(1,10000)] uint32 num_req;\n+\t\t[size_is(num_req)] [charset(UTF16),string] uint16 **site_to;\n+\t\tuint32 flags;\n+\t} drsuapi_QuerySitesByCostRequest1;\n+\n+\ttypedef [switch_type(int32)] union {\n+\t\t[case(1)] drsuapi_QuerySitesByCostRequest1 req1;\n+\t} drsuapi_QuerySitesByCostRequest;\n+\n+\tWERROR drsuapi_QuerySitesByCost(\n+\t\t[in] policy_handle *bind_handle,\n+\t\t[in] int32 level,\n+\t\t[in] [switch_is(level)] drsuapi_QuerySitesByCostRequest req,\n+\t\t[out] int32 level_out,\n+\t\t[out] [switch_is(level_out)] drsuapi_QuerySitesByCostCtr ctr\n+\t);\n }\n\nModified: branches/SAMBA_4_0/source/rpc_server/drsuapi/dcesrv_drsuapi.c\n===================================================================\n--- branches/SAMBA_4_0/source/rpc_server/drsuapi/dcesrv_drsuapi.c\t2007-05-30 08:15:49 UTC (rev 23238)\n+++ branches/SAMBA_4_0/source/rpc_server/drsuapi/dcesrv_drsuapi.c\t2007-05-30 09:54:19 UTC (rev 23239)\n@@ -798,10 +798,10 @@\n \n \n /* \n-  DRSUAPI_QUERY_SITES_BY_COST \n+  drsuapi_QuerySitesByCost \n */\n-static WERROR dcesrv_DRSUAPI_QUERY_SITES_BY_COST(struct dcesrv_call_state *dce_call, TALLOC_CTX *mem_ctx,\n-\t\t       struct DRSUAPI_QUERY_SITES_BY_COST *r)\n+static WERROR dcesrv_drsuapi_QuerySitesByCost(struct dcesrv_call_state *dce_call, TALLOC_CTX *mem_ctx,\n+\t\t       struct drsuapi_QuerySitesByCost *r)\n {\n \tDCESRV_FAULT(DCERPC_FAULT_OP_RNG_ERROR);\n }\n\nModified: branches/SAMBA_4_0/source/torture/rpc/drsuapi.c\n===================================================================\n--- branches/SAMBA_4_0/source/torture/rpc/drsuapi.c\t2007-05-30 08:15:49 UTC (rev 23238)\n+++ branches/SAMBA_4_0/source/torture/rpc/drsuapi.c\t2007-05-30 09:54:19 UTC (rev 23239)\n@@ -646,6 +646,61 @@\n \treturn ret;\n }\n \n+BOOL test_QuerySitesByCost(struct dcerpc_pipe *p, TALLOC_CTX *mem_ctx,\n+\t\t\t   struct DsPrivate *priv)\n+{\n+\tNTSTATUS status;\n+\tstruct drsuapi_QuerySitesByCost r;\n+\tBOOL ret = True;\n+\n+\tconst char *my_site = \"Default-First-Site-Name\";\n+\tconst char *remote_site1 = \"smbtorture-nonexisting-site1\";\n+\tconst char *remote_site2 = \"smbtorture-nonexisting-site2\";\n+\n+\tr.in.bind_handle = &priv->bind_handle;\n+\tr.in.level = 1;\n+\tr.in.req.req1.site_from = talloc_strdup(mem_ctx, my_site);\n+\tr.in.req.req1.num_req = 2;\n+\tr.in.req.req1.site_to = talloc_zero_array(mem_ctx, const char *, r.in.req.req1.num_req);\n+\tr.in.req.req1.site_to[0] = talloc_strdup(mem_ctx, remote_site1);\n+\tr.in.req.req1.site_to[1] = talloc_strdup(mem_ctx, remote_site2);\n+\tr.in.req.req1.flags = 0;\n+\n+\tstatus = dcerpc_drsuapi_QuerySitesByCost(p, mem_ctx, &r);\n+\tif (!NT_STATUS_IS_OK(status)) {\n+\t\tconst char *errstr = nt_errstr(status);\n+\t\tif (NT_STATUS_EQUAL(status, NT_STATUS_NET_WRITE_FAULT)) {\n+\t\t\terrstr = dcerpc_errstr(mem_ctx, p->last_fault_code);\n+\t\t}\n+\t\tprintf(\"drsuapi_QuerySitesByCost - %s\\n\", errstr);\n+\t\tret = False;\n+\t} else if (!W_ERROR_IS_OK(r.out.result)) {\n+\t\tprintf(\"QuerySitesByCost failed - %s\\n\", win_errstr(r.out.result));\n+\t\tret = False;\n+\t}\n+\n+\tif (W_ERROR_IS_OK(r.out.result)) {\n+\n+\t\tif (!W_ERROR_EQUAL(r.out.ctr.ctr1.info[0].error_code, WERR_DS_OBJ_NOT_FOUND) ||\n+\t\t    !W_ERROR_EQUAL(r.out.ctr.ctr1.info[1].error_code, WERR_DS_OBJ_NOT_FOUND)) {\t\n+\t\t\tprintf(\"expected error_code WERR_DS_OBJ_NOT_FOUND, got %s\\n\", \n+\t\t\t\twin_errstr(r.out.ctr.ctr1.info[0].error_code));\n+\t\t\tret = False;\n+\t\t}\n+\n+\t\tif ((r.out.ctr.ctr1.info[0].site_cost != (uint32_t) -1) ||\n+\t\t    (r.out.ctr.ctr1.info[1].site_cost != (uint32_t) -1)) {\n+\t\t\tprintf(\"expected site_cost %d, got %d\\n\", \n+\t\t\t\t(uint32_t) -1, r.out.ctr.ctr1.info[0].site_cost);\n+\t\t\tret = False;\n+\t\t}\n+\t}\n+\n+\treturn ret;\n+\n+\n+}\n+\n BOOL test_DsUnbind(struct dcerpc_pipe *p, TALLOC_CTX *mem_ctx, \n \t\t   struct DsPrivate *priv)\n {\n@@ -705,7 +760,9 @@\n \t}\n \n \tret &= test_DsBind(p, mem_ctx, &priv);\n-\n+#if 0\n+\tret &= test_QuerySitesByCost(p, mem_ctx, &priv);\n+#endif\n \tret &= test_DsGetDomainControllerInfo(p, mem_ctx, &priv);\n \n \tret &= test_DsCrackNames(p, mem_ctx, &priv);\n\n"}