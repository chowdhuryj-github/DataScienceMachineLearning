{"category": "ham", "to_address": "samba-cvs@samba.org", "from_address": "tridge@samba.org", "subject": "Rev 481: handle the case of all nodes being sick for one service in\n\thttp://samba.org/~tridge/ctdb", "body": "------------------------------------------------------------\nrevno: 481\nrevision-id: tridge@samba.org-20070606064959-prbxq97dwqthth82\nparent: tridge@samba.org-20070606034512-rg9avvcsos0j29oc\ncommitter: Andrew Tridgell \nbranch nick: tridge\ntimestamp: Wed 2007-06-06 16:49:59 +1000\nmessage:\n  handle the case of all nodes being sick for one service\nmodified:\n  takeover/ctdb_takeover.c       ctdb_takeover.c-20070525071636-a5n1ihghjtppy08r-2\n=== modified file 'takeover/ctdb_takeover.c'\n--- a/takeover/ctdb_takeover.c\t2007-06-06 03:45:12 +0000\n+++ b/takeover/ctdb_takeover.c\t2007-06-06 06:49:59 +0000\n@@ -432,6 +432,28 @@\n \t\t\t\t\tbreak;\n \t\t\t\t}\n \t\t\t}\n+\t\t\t\n+\t\t\t/* if no enabled node can take it, then we\n+\t\t\t   might as well use any connected node. It\n+\t\t\t   probably means that some subsystem (such as\n+\t\t\t   NFS) is sick on all nodes. Best we can do\n+\t\t\t   is to keep the other services up. */\n+\t\t\tif (j == i) {\n+\t\t\t\tfor (j=(i+1)%nodemap->num;\n+\t\t\t\t     j != i;\n+\t\t\t\t     j=(j+1)%nodemap->num) {\n+\t\t\t\t\tif ((nodemap->nodes[j].flags & NODE_FLAGS_CONNECTED) &&\n+\t\t\t\t\t    ctdb_same_subnet(ctdb->nodes[j]->public_address, \n+\t\t\t\t\t\t\t     ctdb->nodes[i]->public_address, \n+\t\t\t\t\t\t\t     ctdb->nodes[j]->public_netmask_bits)) {\n+\t\t\t\t\t\tctdb->nodes[i]->takeover_vnn = nodemap->nodes[j].vnn;\n+\t\t\t\t\t\tDEBUG(0,(\"All available nodes disabled for %s - using a connected node\\n\",\n+\t\t\t\t\t\t\t ctdb->nodes[i]->public_address));\n+\t\t\t\t\t\tbreak;\n+\t\t\t\t\t}\n+\t\t\t\t}\n+\t\t\t}\n+\t\t\t\n \t\t\tif (j == i) {\n \t\t\t\tDEBUG(0,(__location__ \" No node available on same network to take %s\\n\",\n \t\t\t\t\t ctdb->nodes[i]->public_address));\n\n"}