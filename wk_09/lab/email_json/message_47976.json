{"category": "ham", "to_address": "samba-cvs@samba.org", "from_address": "vlendec@samba.org", "subject": "svn commit: samba r23500 - in branches:\n\tSAMBA_3_0/source/script/tests SAMBA_3_0/source/smbd\n\tSAMBA_3_0_26/source/script/tests SAMBA_3_0_26/source/smbd", "body": "Author: vlendec\nDate: 2007-06-14 14:45:37 +0000 (Thu, 14 Jun 2007)\nNew Revision: 23500\n\nWebSVN: http://websvn.samba.org/cgi-bin/viewcvs.cgi?view=rev&root=samba&rev=23500\n\nLog:\nTwo changes to survive the now activated test for rename_internals_fsp:\nWith the target being open we have to return NT_STATUS_ACCESS_DENIED and\nroot_fid != 0 leads to NT_STATUS_INVALID_PARAMETER\n\nModified:\n   branches/SAMBA_3_0/source/script/tests/test_posix_s3.sh\n   branches/SAMBA_3_0/source/smbd/reply.c\n   branches/SAMBA_3_0/source/smbd/trans2.c\n   branches/SAMBA_3_0_26/source/script/tests/test_posix_s3.sh\n   branches/SAMBA_3_0_26/source/smbd/reply.c\n   branches/SAMBA_3_0_26/source/smbd/trans2.c\n\n\nChangeset:\nModified: branches/SAMBA_3_0/source/script/tests/test_posix_s3.sh\n===================================================================\n--- branches/SAMBA_3_0/source/script/tests/test_posix_s3.sh\t2007-06-14 14:45:33 UTC (rev 23499)\n+++ branches/SAMBA_3_0/source/script/tests/test_posix_s3.sh\t2007-06-14 14:45:37 UTC (rev 23500)\n@@ -31,7 +31,7 @@\n raw=\"$raw RAW-IOCTL RAW-LOCK RAW-MKDIR RAW-MUX RAW-NOTIFY RAW-OPEN RAW-OPLOCK\"\n raw=\"$raw RAW-QFILEINFO RAW-QFSINFO RAW-READ RAW-RENAME RAW-SEARCH RAW-SEEK\"\n raw=\"$raw RAW-SFILEINFO RAW-SFILEINFO-BUG RAW-STREAMS RAW-UNLINK RAW-WRITE\"\n-raw=\"$raw RAW-SAMBA3HIDE RAW-SAMBA3BADPATH\"\n+raw=\"$raw RAW-SAMBA3HIDE RAW-SAMBA3BADPATH RAW-SFILEINFO-RENAME\"\n \n rpc=\"RPC-AUTHCONTEXT RPC-BINDSAMBA3 RPC-SAMBA3-SRVSVC RPC-SAMBA3-SHARESEC\"\n rpc=\"$rpc RPC-UNIXINFO RPC-SAMBA3-SPOOLSS RPC-SAMBA3-WKSSVC\"\n\nModified: branches/SAMBA_3_0/source/smbd/reply.c\n===================================================================\n--- branches/SAMBA_3_0/source/smbd/reply.c\t2007-06-14 14:45:33 UTC (rev 23499)\n+++ branches/SAMBA_3_0/source/smbd/reply.c\t2007-06-14 14:45:37 UTC (rev 23500)\n@@ -4236,10 +4236,11 @@\n \n NTSTATUS rename_internals_fsp(connection_struct *conn, files_struct *fsp, pstring newname, uint32 attrs, BOOL replace_if_exists)\n {\n-\tSMB_STRUCT_STAT sbuf;\n+\tSMB_STRUCT_STAT sbuf, sbuf1;\n \tpstring newname_last_component;\n \tNTSTATUS status = NT_STATUS_OK;\n \tstruct share_mode_lock *lck = NULL;\n+\tBOOL dst_exists;\n \n \tZERO_STRUCT(sbuf);\n \n@@ -4307,12 +4308,22 @@\n \t\treturn NT_STATUS_OK;\n \t}\n \n-\tif(!replace_if_exists && vfs_object_exist(conn, newname, NULL)) {\n+\t/*\n+\t * Have vfs_object_exist also fill sbuf1\n+\t */\n+\tdst_exists = vfs_object_exist(conn, newname, &sbuf1);\n+\n+\tif(!replace_if_exists && dst_exists) {\n \t\tDEBUG(3,(\"rename_internals_fsp: dest exists doing rename %s -> %s\\n\",\n \t\t\tfsp->fsp_name,newname));\n \t\treturn NT_STATUS_OBJECT_NAME_COLLISION;\n \t}\n \n+\tif (file_find_di_first(file_id_sbuf(&sbuf1)) != NULL) {\n+\t\tDEBUG(3, (\"rename_internals_fsp: Target file open\\n\"));\n+\t\treturn NT_STATUS_ACCESS_DENIED;\n+\t}\n+\n \t/* Ensure we have a valid stat struct for the source. */\n \tif (fsp->fh->fd != -1) {\n \t\tif (SMB_VFS_FSTAT(fsp,fsp->fh->fd,&sbuf) == -1) {\n\nModified: branches/SAMBA_3_0/source/smbd/trans2.c\n===================================================================\n--- branches/SAMBA_3_0/source/smbd/trans2.c\t2007-06-14 14:45:33 UTC (rev 23499)\n+++ branches/SAMBA_3_0/source/smbd/trans2.c\t2007-06-14 14:45:37 UTC (rev 23500)\n@@ -4611,7 +4611,7 @@\n \t\t\t\tpstring fname)\n {\n \tBOOL overwrite;\n-\t/* uint32 root_fid; */  /* Not used */\n+\tuint32 root_fid;\n \tuint32 len;\n \tpstring newname;\n \tpstring base_name;\n@@ -4624,10 +4624,10 @@\n \t}\n \n \toverwrite = (CVAL(pdata,0) ? True : False);\n-\t/* root_fid = IVAL(pdata,4); */\n+\troot_fid = IVAL(pdata,4);\n \tlen = IVAL(pdata,8);\n \n-\tif (len > (total_data - 12) || (len == 0)) {\n+\tif (len > (total_data - 12) || (len == 0) || (root_fid != 0)) {\n \t\treturn NT_STATUS_INVALID_PARAMETER;\n \t}\n \n\nModified: branches/SAMBA_3_0_26/source/script/tests/test_posix_s3.sh\n===================================================================\n--- branches/SAMBA_3_0_26/source/script/tests/test_posix_s3.sh\t2007-06-14 14:45:33 UTC (rev 23499)\n+++ branches/SAMBA_3_0_26/source/script/tests/test_posix_s3.sh\t2007-06-14 14:45:37 UTC (rev 23500)\n@@ -31,7 +31,7 @@\n raw=\"$raw RAW-IOCTL RAW-LOCK RAW-MKDIR RAW-MUX RAW-NOTIFY RAW-OPEN RAW-OPLOCK\"\n raw=\"$raw RAW-QFILEINFO RAW-QFSINFO RAW-READ RAW-RENAME RAW-SEARCH RAW-SEEK\"\n raw=\"$raw RAW-SFILEINFO RAW-SFILEINFO-BUG RAW-STREAMS RAW-UNLINK RAW-WRITE\"\n-raw=\"$raw RAW-SAMBA3HIDE RAW-SAMBA3BADPATH\"\n+raw=\"$raw RAW-SAMBA3HIDE RAW-SAMBA3BADPATH RAW-SFILEINFO-RENAME\"\n \n rpc=\"RPC-AUTHCONTEXT RPC-BINDSAMBA3 RPC-SAMBA3-SRVSVC RPC-SAMBA3-SHARESEC\"\n rpc=\"$rpc RPC-UNIXINFO RPC-SAMBA3-SPOOLSS RPC-SAMBA3-WKSSVC\"\n\nModified: branches/SAMBA_3_0_26/source/smbd/reply.c\n===================================================================\n--- branches/SAMBA_3_0_26/source/smbd/reply.c\t2007-06-14 14:45:33 UTC (rev 23499)\n+++ branches/SAMBA_3_0_26/source/smbd/reply.c\t2007-06-14 14:45:37 UTC (rev 23500)\n@@ -4234,10 +4234,11 @@\n \n NTSTATUS rename_internals_fsp(connection_struct *conn, files_struct *fsp, pstring newname, uint32 attrs, BOOL replace_if_exists)\n {\n-\tSMB_STRUCT_STAT sbuf;\n+\tSMB_STRUCT_STAT sbuf, sbuf1;\n \tpstring newname_last_component;\n \tNTSTATUS status = NT_STATUS_OK;\n \tstruct share_mode_lock *lck = NULL;\n+\tBOOL dst_exists;\n \n \tZERO_STRUCT(sbuf);\n \n@@ -4305,12 +4306,22 @@\n \t\treturn NT_STATUS_OK;\n \t}\n \n-\tif(!replace_if_exists && vfs_object_exist(conn, newname, NULL)) {\n+\t/*\n+\t * Have vfs_object_exist also fill sbuf1\n+\t */\n+\tdst_exists = vfs_object_exist(conn, newname, &sbuf1);\n+\n+\tif(!replace_if_exists && dst_exists) {\n \t\tDEBUG(3,(\"rename_internals_fsp: dest exists doing rename %s -> %s\\n\",\n \t\t\tfsp->fsp_name,newname));\n \t\treturn NT_STATUS_OBJECT_NAME_COLLISION;\n \t}\n \n+\tif (file_find_di_first(file_id_sbuf(&sbuf1)) != NULL) {\n+\t\tDEBUG(3, (\"rename_internals_fsp: Target file open\\n\"));\n+\t\treturn NT_STATUS_ACCESS_DENIED;\n+\t}\n+\n \t/* Ensure we have a valid stat struct for the source. */\n \tif (fsp->fh->fd != -1) {\n \t\tif (SMB_VFS_FSTAT(fsp,fsp->fh->fd,&sbuf) == -1) {\n\nModified: branches/SAMBA_3_0_26/source/smbd/trans2.c\n===================================================================\n--- branches/SAMBA_3_0_26/source/smbd/trans2.c\t2007-06-14 14:45:33 UTC (rev 23499)\n+++ branches/SAMBA_3_0_26/source/smbd/trans2.c\t2007-06-14 14:45:37 UTC (rev 23500)\n@@ -4557,7 +4557,7 @@\n \t\t\t\tpstring fname)\n {\n \tBOOL overwrite;\n-\t/* uint32 root_fid; */  /* Not used */\n+\tuint32 root_fid;\n \tuint32 len;\n \tpstring newname;\n \tpstring base_name;\n@@ -4570,10 +4570,10 @@\n \t}\n \n \toverwrite = (CVAL(pdata,0) ? True : False);\n-\t/* root_fid = IVAL(pdata,4); */\n+\troot_fid = IVAL(pdata,4);\n \tlen = IVAL(pdata,8);\n \n-\tif (len > (total_data - 12) || (len == 0)) {\n+\tif (len > (total_data - 12) || (len == 0) || (root_fid != 0)) {\n \t\treturn NT_STATUS_INVALID_PARAMETER;\n \t}\n \n\n"}