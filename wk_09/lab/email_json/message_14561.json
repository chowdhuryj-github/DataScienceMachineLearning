{"category": "ham", "to_address": "samba-cvs@samba.org", "from_address": "Jelmer Vernooij <jelmer@samba.org>", "subject": "Rev 11993: Hopefully fix ipv6. in\n\tfile:///home/jelmer/bzr.samba/SAMBA_4_0/", "body": "At file:///home/jelmer/bzr.samba/SAMBA_4_0/\n\n------------------------------------------------------------\nrevno: 11993\nrevision-id: jelmer@samba.org-20070423162214-1nc7n31wy0o0hjmu\nparent: svn-v2:22487@0c0555d6-39d7-0310-84fc-f1cc0bd64818-branches%2fSAMBA_4_0\ncommitter: Jelmer Vernooij \nbranch nick: SAMBA_4_0\ntimestamp: Mon 2007-04-23 18:22:14 +0200\nmessage:\n  Hopefully fix ipv6.\nmodified:\n  source/lib/socket/socket_ipv6.c svn-v2:3329@0c0555d6-39d7-0310-84fc-f1cc0bd64818-branches%2fSAMBA_4_0-source%2flib%2fsocket%2fsocket_ipv6.c\n=== modified file 'source/lib/socket/socket_ipv6.c'\n--- a/source/lib/socket/socket_ipv6.c\t2006-09-10 10:00:42 +0000\n+++ b/source/lib/socket/socket_ipv6.c\t2007-04-23 16:22:14 +0000\n@@ -166,9 +166,11 @@\n \t\treturn map_nt_error_from_unix(errno);\n \t}\n \n-\tret = listen(sock->fd, queue_size);\n-\tif (ret == -1) {\n-\t\treturn map_nt_error_from_unix(errno);\n+\tif (sock->type == SOCKET_TYPE_STREAM) {\n+\t\tret = listen(sock->fd, queue_size);\n+\t\tif (ret == -1) {\n+\t\t\treturn map_nt_error_from_unix(errno);\n+\t\t}\n \t}\n \n \tif (!(flags & SOCKET_FLAG_BLOCK)) {\n@@ -390,6 +392,16 @@\n \treturn sock->fd;\n }\n \n+static NTSTATUS ipv6_pending(struct socket_context *sock, size_t *npending)\n+{\n+\tint value = 0;\n+\tif (ioctl(sock->fd, FIONREAD, &value) == 0) {\n+\t\t*npending = value;\n+\t\treturn NT_STATUS_OK;\n+\t}\n+\treturn map_nt_error_from_unix(errno);\n+}\n+\n static const struct socket_ops ipv6_tcp_ops = {\n \t.name\t\t\t= \"ipv6\",\n \t.fn_init\t\t= ipv6_tcp_init,\n@@ -400,6 +412,7 @@\n \t.fn_recv\t\t= ipv6_tcp_recv,\n \t.fn_send\t\t= ipv6_tcp_send,\n \t.fn_close\t\t= ipv6_tcp_close,\n+\t.fn_pending\t\t= ipv6_pending,\n \n \t.fn_set_option\t\t= ipv6_tcp_set_option,\n \n\n"}